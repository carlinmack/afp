<div id="Missing_List">
<div class="head">
<h1>Theory Missing_List</h1>
</div>
<pre class="source"><span class="comment1">(*  
    Author:      René Thiemann 
                 Akihisa Yamada
    License:     BSD
*)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Missing List›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The provides some standard algorithms and lemmas on lists.›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Missing_List
<span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="../Matrix/Utility.html">Matrix.Utility</a>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Monad_Syntax.html">HOL-Library.Monad_Syntax</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">concat_lists</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list list <span class="main">⇒</span> <span class="tfree">'a</span> list list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">concat_lists</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[</span><span class="main">[]</span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">concat_lists</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">vec</span><span class="main">.</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">#</span> <span class="bound">vec</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">concat_lists</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> concat_lists_listset<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>concat_lists <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> listset <span class="main">(</span>map set <span class="free">xs</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_Cons_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_list_concat<span class="main">:</span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>concat <span class="free">ls</span><span class="main">)</span> <span class="main">=</span> sum_list <span class="main">(</span>map sum_list <span class="free">ls</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ls</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="comment1">(* TODO: move to src/HOL/List *)</span>
<span class="keyword1"><span class="command">lemma</span></span> listset<span class="main">:</span> <span class="quoted"><span class="quoted">"listset <span class="free">xs</span> <span class="main">=</span> <span class="main">{</span> <span class="bound">ys</span><span class="main">.</span> length <span class="bound">ys</span> <span class="main">=</span> length <span class="free">xs</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">xs</span><span class="main">.</span> <span class="bound">ys</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> Cons 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?case</span> <span class="main">=</span> <span class="main">(</span>set_Cons <span class="skolem">x</span> <span class="main">{</span><span class="bound">ys</span><span class="main">.</span> length <span class="bound">ys</span> <span class="main">=</span> <span class="var">?n</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="var">?n</span><span class="main">.</span> <span class="bound">ys</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∈</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span>
    <span class="main">{</span><span class="bound">ys</span><span class="main">.</span> length <span class="bound">ys</span> <span class="main">=</span> Suc <span class="var">?n</span> <span class="main">∧</span> <span class="bound">ys</span> <span class="main">!</span> <span class="main">0</span> <span class="main">∈</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="var">?n</span><span class="main">.</span> <span class="bound">ys</span> <span class="main">!</span> Suc <span class="bound">i</span> <span class="main">∈</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span> 
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">(</span><span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> all_Suc_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_Cons_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">xa</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> set_concat_lists<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>concat_lists <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">as</span><span class="main">.</span> length <span class="bound">as</span> <span class="main">=</span> length <span class="free">xs</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="free">xs</span><span class="main">.</span> <span class="bound">as</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> concat_lists_listset listset <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">declare</span></span> concat_lists.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword">del</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">find_map_filter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'b</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">find_map_filter</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">[]</span> <span class="main">=</span> None"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find_map_filter</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">b</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">b</span> <span class="keyword1">then</span> Some <span class="bound">b</span> <span class="keyword1">else</span> <span class="free">find_map_filter</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> find_map_filter_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"find_map_filter <span class="free">f</span> <span class="free">p</span> <span class="free">as</span> <span class="main">=</span> Some <span class="free">b</span> <span class="main">⟹</span> <span class="free">p</span> <span class="free">b</span> <span class="main">∧</span> <span class="free">b</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">`</span> set <span class="free">as</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> find_map_filter.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> find_map_filter_None<span class="main">:</span> <span class="quoted"><span class="quoted">"find_map_filter <span class="free">f</span> <span class="free">p</span> <span class="free">as</span> <span class="main">=</span> None <span class="main">⟹</span> <span class="main">∀</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">`</span> set <span class="free">as</span><span class="main">.</span> <span class="main">¬</span> <span class="free">p</span> <span class="bound">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> find_map_filter.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> remdups_adj_sorted_distinct<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="free">xs</span> <span class="main">⟹</span> distinct <span class="main">(</span>remdups_adj <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> remdups_adj.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> subseqs_length_simple<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> set <span class="main">(</span>subseqs <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="free">b</span> <span class="main">≤</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">b</span></span><span class="main"><span class="keyword3">;</span></span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>Let_def Suc_leD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> subseqs_length_simple_False<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> set <span class="main">(</span>subseqs <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">" length <span class="free">xs</span> <span class="main">&lt;</span> length <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted">False</span>
  <span class="keyword1"><span class="command">using</span></span> assms subseqs_length_simple <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> empty_subseqs<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> set <span class="main">(</span>subseqs <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> full_list_subseqs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">ys</span><span class="main">.</span> <span class="bound">ys</span> <span class="main">∈</span> set <span class="main">(</span>subseqs <span class="free">xs</span><span class="main">)</span> <span class="main">∧</span> length <span class="bound">ys</span> <span class="main">=</span> length <span class="free">xs</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">xs</span><span class="main">}</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?case</span> <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="bound"><span class="bound">ys</span></span> <span class="main">∈</span> <span class="main">(#)</span> <span class="skolem">x</span> <span class="main">`</span> set <span class="main">(</span>subseqs <span class="skolem">xs</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>subseqs <span class="skolem">xs</span><span class="main">)</span><span class="main">.</span> 
    length <span class="bound">ys</span> <span class="main">=</span> Suc <span class="main">(</span>length <span class="skolem">xs</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">(#)</span> <span class="skolem">x</span> <span class="main">`</span> <span class="main">{</span><span class="skolem">xs</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">(</span><span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">ys</span></span> <span class="main">∈</span> <span class="main">(#)</span> <span class="skolem">x</span> <span class="main">`</span> set <span class="main">(</span>subseqs <span class="skolem">xs</span><span class="main">)</span><span class="main">.</span> length <span class="bound">ys</span> <span class="main">=</span> Suc <span class="main">(</span>length <span class="skolem">xs</span><span class="main">)</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> length_subseqs<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> subseqs_length_simple_False <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(#)</span> <span class="skolem">x</span> <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">ys</span></span> <span class="main">∈</span> set <span class="main">(</span>subseqs <span class="skolem">xs</span><span class="main">)</span><span class="main">.</span> length <span class="bound">ys</span> <span class="main">=</span> length <span class="skolem">xs</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(#)</span> <span class="skolem">x</span> <span class="main">`</span> <span class="main">{</span><span class="skolem">xs</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> nth_concat_split<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="main">(</span>concat <span class="free">xs</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">j</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∧</span> concat <span class="free">xs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">!</span> <span class="bound">k</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">=</span> <span class="skolem">i</span> <span class="main">-</span> length <span class="skolem">x</span>"</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">x</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> l <span class="main">=</span> this
    <span class="keyword1"><span class="command">hence</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"concat <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> i
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">i</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> Cons l<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> l <span class="main">=</span> this
    <span class="keyword1"><span class="command">from</span></span> l Cons<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> length <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">&lt;</span> length <span class="main">(</span>concat <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> I_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> iI<span class="main">:</span> <span class="quoted"><span class="quoted">"concat <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> concat <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> i<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="skolem">xs</span> <span class="main">∧</span> <span class="skolem">k</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∧</span> concat <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">I</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">!</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> iI
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="skolem"><span class="skolem"><span class="skolem">j</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">k</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> IH<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> nth_concat_diff<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i1</span> <span class="main">&lt;</span> length <span class="main">(</span>concat <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i2</span> <span class="main">&lt;</span> length <span class="main">(</span>concat <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i1</span> <span class="main">≠</span> <span class="free">i2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">j1</span> <span class="bound">k1</span> <span class="bound">j2</span> <span class="bound">k2</span><span class="main">.</span> <span class="main">(</span><span class="bound">j1</span><span class="main">,</span><span class="bound">k1</span><span class="main">)</span> <span class="main">≠</span> <span class="main">(</span><span class="bound">j2</span><span class="main">,</span><span class="bound">k2</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">j1</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">∧</span> <span class="bound">j2</span> <span class="main">&lt;</span> length <span class="free">xs</span>
    <span class="main">∧</span> <span class="bound">k1</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">j1</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">k2</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">j2</span><span class="main">)</span> 
    <span class="main">∧</span> concat <span class="free">xs</span> <span class="main">!</span> <span class="free">i1</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">j1</span> <span class="main">!</span> <span class="bound">k1</span> <span class="main">∧</span> concat <span class="free">xs</span> <span class="main">!</span> <span class="free">i2</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">j2</span> <span class="main">!</span> <span class="bound">k2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i1</span></span> <span class="quoted"><span class="free">i2</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">I1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I1</span> <span class="main">=</span> <span class="skolem">i1</span> <span class="main">-</span> length <span class="skolem">x</span>"</span></span> 
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">I2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I2</span> <span class="main">=</span> <span class="skolem">i2</span> <span class="main">-</span> length <span class="skolem">x</span>"</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i1</span> <span class="main">&lt;</span> length <span class="skolem">x</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> l1 <span class="main">=</span> this
    <span class="keyword1"><span class="command">hence</span></span> i1<span class="main">:</span> <span class="quoted"><span class="quoted">"concat <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i1</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">!</span> <span class="skolem">i1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i2</span> <span class="main">&lt;</span> length <span class="skolem">x</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> l2 <span class="main">=</span> this
      <span class="keyword1"><span class="command">hence</span></span> i2<span class="main">:</span> <span class="quoted"><span class="quoted">"concat <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i2</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">!</span> <span class="skolem">i2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> i1 i2 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">i1</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">i2</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> 
         <span class="operator">insert</span> Cons<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> l1 l2<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> l2 <span class="main">=</span> this
      <span class="keyword1"><span class="command">from</span></span> l2 Cons<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> i22<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i2</span> <span class="main">=</span> length <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">I2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I2</span> <span class="main">&lt;</span> length <span class="main">(</span>concat <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> I2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> i2<span class="main">:</span> <span class="quoted"><span class="quoted">"concat <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i2</span> <span class="main">=</span> concat <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">I2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> nth_concat_split<span class="main">[</span><span class="operator">OF</span> i22<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j2</span></span> <span class="skolem"><span class="skolem">k2</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j2</span> <span class="main">&lt;</span> length <span class="skolem">xs</span> <span class="main">∧</span> <span class="skolem">k2</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">j2</span><span class="main">)</span> <span class="main">∧</span> concat <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">I2</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">j2</span> <span class="main">!</span> <span class="skolem">k2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> i1 i2
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">i1</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="skolem"><span class="skolem"><span class="skolem">j2</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">k2</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
         <span class="operator">insert</span> * l1<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> l1 <span class="main">=</span> this
    <span class="keyword1"><span class="command">from</span></span> l1 Cons<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> i11<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i1</span> <span class="main">=</span> length <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">I1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I1</span> <span class="main">&lt;</span> length <span class="main">(</span>concat <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> I1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> i1<span class="main">:</span> <span class="quoted"><span class="quoted">"concat <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i1</span> <span class="main">=</span> concat <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">I1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i2</span> <span class="main">&lt;</span> length <span class="skolem">x</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> l2 <span class="main">=</span> this
      <span class="keyword1"><span class="command">from</span></span> l2 Cons<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> i22<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i2</span> <span class="main">=</span> length <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">I2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I2</span> <span class="main">&lt;</span> length <span class="main">(</span>concat <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> I2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> i2<span class="main">:</span> <span class="quoted"><span class="quoted">"concat <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i2</span> <span class="main">=</span> concat <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">I2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>4<span class="main">)</span> i11 i22 <span class="keyword1"><span class="command">have</span></span> diff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I1</span> <span class="main">≠</span> <span class="skolem">I2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> i11<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> i22<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> diff<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j1</span></span> <span class="skolem"><span class="skolem">k1</span></span> <span class="skolem"><span class="skolem">j2</span></span> <span class="skolem"><span class="skolem">k2</span></span>
        <span class="keyword2"><span class="keyword">where</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">j1</span><span class="main">,</span><span class="skolem">k1</span><span class="main">)</span> <span class="main">≠</span> <span class="main">(</span><span class="skolem">j2</span><span class="main">,</span><span class="skolem">k2</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">j1</span> <span class="main">&lt;</span> length <span class="skolem">xs</span> <span class="main">∧</span> <span class="skolem">j2</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>
        <span class="main">∧</span> <span class="skolem">k1</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">j1</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">k2</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">j2</span><span class="main">)</span> 
        <span class="main">∧</span> concat <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">I1</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">j1</span> <span class="main">!</span> <span class="skolem">k1</span> <span class="main">∧</span> concat <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">I2</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">j2</span> <span class="main">!</span> <span class="skolem">k2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> i1 i2 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="skolem"><span class="skolem"><span class="skolem">j1</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">k1</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="skolem"><span class="skolem"><span class="skolem">j2</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">k2</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">insert</span> IH<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> l2 <span class="main">=</span> this
      <span class="keyword1"><span class="command">hence</span></span> i2<span class="main">:</span> <span class="quoted"><span class="quoted">"concat <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i2</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">!</span> <span class="skolem">i2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> nth_concat_split<span class="main">[</span><span class="operator">OF</span> i11<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j1</span></span> <span class="skolem"><span class="skolem">k1</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j1</span> <span class="main">&lt;</span> length <span class="skolem">xs</span> <span class="main">∧</span> <span class="skolem">k1</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">j1</span><span class="main">)</span> <span class="main">∧</span> concat <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">I1</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">j1</span> <span class="main">!</span> <span class="skolem">k1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> i1 i2
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="skolem"><span class="skolem"><span class="skolem">j1</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">k1</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">i2</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
         <span class="operator">insert</span> * l2<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>      
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> list_all2_map_map<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="free">R</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> list_all2 <span class="free">R</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>map <span class="free">g</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Partitions›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Check whether a list of sets forms a partition, i.e.,
whether the sets are pairwise disjoint.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_partition</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> set<span class="main">)</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_partition</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span>length <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="bound">j</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>

<span class="comment1">(* and an equivalent but more symmetric version *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_partition_alt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> set<span class="main">)</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_partition_alt</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">≠</span> <span class="bound">j</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">!</span><span class="bound">i</span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">!</span><span class="bound">j</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_partition_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"is_partition <span class="main">=</span> is_partition_alt"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">cs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set list"</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"is_partition_alt <span class="skolem">cs</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_partition <span class="skolem">cs</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_partition_def is_partition_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> part<span class="main">:</span> <span class="quoted"><span class="quoted">"is_partition <span class="skolem">cs</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_partition_alt <span class="skolem">cs</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_partition_alt_def
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">cs</span> <span class="main">∧</span> <span class="skolem">j</span> <span class="main">&lt;</span> length <span class="skolem">cs</span> <span class="main">∧</span> <span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> part <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">∩</span> <span class="skolem">cs</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> is_partition_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"is_partition <span class="skolem">cs</span> <span class="main">=</span> is_partition_alt <span class="skolem">cs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
      
<span class="keyword1"><span class="command">lemma</span></span> is_partition_Nil<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_partition <span class="main">[]</span> <span class="main">=</span> True"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_partition_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> is_partition_Cons<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_partition <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">⟷</span> is_partition <span class="free">xs</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∩</span> <span class="main">⋃</span><span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span>
  <span class="keyword1"><span class="command">have</span></span> one<span class="main">:</span> <span class="quoted"><span class="quoted">"is_partition <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> is_partition_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> allI impI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">j</span> <span class="main">&lt;</span> length<span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">&lt;</span> Suc <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?l</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> is_partition_def<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> mp<span class="main">,</span><span class="operator">THEN</span> spec<span class="main">,</span><span class="operator">THEN</span> mp<span class="main">,</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span><span class="main">!</span><span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span><span class="main">!</span><span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span><span class="main">!</span><span class="skolem">i</span> <span class="main">∩</span> <span class="free">xs</span><span class="main">!</span><span class="skolem">j</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> two<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∩</span> <span class="main">⋃</span><span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∩</span> <span class="main">⋃</span><span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span>set <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span><span class="main">!</span><span class="skolem">i</span> <span class="main">=</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> in_set_conv_nth<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">z</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">z</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span><span class="main">!</span>Suc <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∈</span> <span class="free">x</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span><span class="main">!</span><span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span><span class="main">!</span><span class="main">0</span> <span class="main">∩</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span><span class="main">!</span>Suc <span class="skolem">i</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">&lt;</span> length<span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?l</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> is_partition_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">best</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> one two <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> is_partition_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> allI impI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> i <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j'</span></span> <span class="keyword2"><span class="keyword">where</span></span> j'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> Suc <span class="skolem">j'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> j <span class="keyword1"><span class="command">have</span></span> j'len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> j'elem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="skolem">j'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">∩</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
      <span class="keyword1"><span class="command">with</span></span> j'elem <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">∩</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> <span class="free">x</span> <span class="main">∩</span> <span class="free">xs</span> <span class="main">!</span> <span class="skolem">j'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> <span class="free">x</span> <span class="main">∩</span> <span class="main">⋃</span><span class="main">(</span>set <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j'len <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?r</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> i j' <span class="keyword1"><span class="command">have</span></span> i'j'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&lt;</span> <span class="skolem">j'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> Suc j' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">∩</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="skolem">i'</span> <span class="main">∩</span> <span class="free">xs</span> <span class="main">!</span> <span class="skolem">j'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?r</span>›</span></span> i'j' j'len <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_partition_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_partition_sublist<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_partition <span class="main">(</span><span class="free">us</span> <span class="main">@</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">@</span> <span class="free">zs</span> <span class="main">@</span> <span class="free">vs</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_partition <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_partition <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> *<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">∩</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> is_partition_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">+</span> length <span class="free">us</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">+</span> length <span class="free">us</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?m</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">us</span> <span class="main">@</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">@</span> <span class="free">zs</span> <span class="main">@</span> <span class="free">vs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> i <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?n</span> <span class="main">&lt;</span> <span class="var">?m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">us</span> <span class="main">@</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">@</span> <span class="free">zs</span> <span class="main">@</span> <span class="free">vs</span><span class="main">)</span> <span class="main">!</span> <span class="var">?n</span> <span class="main">∩</span> <span class="main">(</span><span class="free">us</span> <span class="main">@</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">@</span> <span class="free">zs</span> <span class="main">@</span> <span class="free">vs</span><span class="main">)</span> <span class="main">!</span> <span class="var">?m</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> i True * nth_append 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> add_diff_cancel_right' not_add_less2 order.strict_trans<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> is_partition_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">+</span> length <span class="free">us</span> <span class="main">+</span> length <span class="free">ys</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> j <span class="keyword1"><span class="command">have</span></span> m<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="var">?m</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">us</span> <span class="main">@</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">@</span> <span class="free">zs</span> <span class="main">@</span> <span class="free">vs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> mj<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">us</span> <span class="main">@</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">@</span> <span class="free">zs</span> <span class="main">@</span> <span class="free">vs</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="var">?m</span> <span class="main">=</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> nth_append <span class="keyword1"><span class="command">using</span></span> False j <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">+</span> length <span class="free">us</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> i <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?n</span> <span class="main">&lt;</span> <span class="var">?m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">us</span> <span class="main">@</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">@</span> <span class="free">zs</span> <span class="main">@</span> <span class="free">vs</span><span class="main">)</span> <span class="main">!</span> <span class="var">?n</span> <span class="main">=</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> True nth_append<span class="main">)</span> 
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> * m assms mj <span class="keyword1"><span class="command">unfolding</span></span> is_partition_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">+</span> length <span class="free">us</span> <span class="main">+</span> length <span class="free">ys</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> i <span class="keyword1"><span class="command">have</span></span> i<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="var">?n</span> <span class="main">&lt;</span> <span class="var">?m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">us</span> <span class="main">@</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">@</span> <span class="free">zs</span> <span class="main">@</span> <span class="free">vs</span><span class="main">)</span> <span class="main">!</span> <span class="var">?n</span> <span class="main">=</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> nth_append <span class="keyword1"><span class="command">using</span></span> False i j less_diff_conv2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> * m assms mj <span class="keyword1"><span class="command">unfolding</span></span> is_partition_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_partition_inj_map<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_partition <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_partition <span class="main">(</span>map <span class="main">(</span><span class="main">(`)</span> <span class="free">f</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_partition <span class="main">(</span>map <span class="main">(</span><span class="main">(`)</span> <span class="free">f</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> neq<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">j</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>map <span class="main">(</span><span class="main">(`)</span> <span class="free">f</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="main">(</span>map <span class="main">(</span><span class="main">(`)</span> <span class="free">f</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">(`)</span> <span class="free">f</span><span class="main">)</span> <span class="free">xs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">∩</span> map <span class="main">(</span><span class="main">(`)</span> <span class="free">f</span><span class="main">)</span> <span class="free">xs</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> is_partition_alt is_partition_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> map <span class="main">(</span><span class="main">(`)</span> <span class="free">f</span><span class="main">)</span> <span class="free">xs</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> map <span class="main">(</span><span class="main">(`)</span> <span class="free">f</span><span class="main">)</span> <span class="free">xs</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> yi<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">xs</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> yx<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> zj<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="free">xs</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> zx<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">z</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> i j <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">z</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> zj yi neq assms<span class="main">(</span>1<span class="main">)</span> i j <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_partition_alt is_partition_alt_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> yi i <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> zj j <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> inj_on_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">xs</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span><span class="main">]</span> False zx yx <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">fun</span></span> <span class="entity">is_partition_impl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set list <span class="main">⇒</span> <span class="tfree">'a</span> set option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_partition_impl</span> <span class="main">[]</span> <span class="main">=</span> Some <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">is_partition_impl</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">rest</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">all</span> <span class="main">←</span> <span class="free">is_partition_impl</span> <span class="free"><span class="bound"><span class="entity">rest</span></span></span><span class="main">;</span>
      <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">∩</span> <span class="bound">all</span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> Some <span class="main">(</span><span class="bound">all</span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="keyword1">else</span> None
    <span class="main">}</span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> is_partition_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_partition <span class="free">as</span> <span class="main">=</span> <span class="main">(</span>is_partition_impl <span class="free">as</span> <span class="main">≠</span> None<span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> is_partition_Cons is_partition_Nil
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">bs</span><span class="main">.</span> <span class="main">(</span>is_partition <span class="free">as</span> <span class="main">=</span> <span class="main">(</span>is_partition_impl <span class="free">as</span> <span class="main">≠</span> None<span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span>is_partition_impl <span class="free">as</span> <span class="main">=</span> Some <span class="bound">bs</span> <span class="main">⟶</span> <span class="bound">bs</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span>set <span class="free">as</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">as</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">as</span> <span class="skolem">rest</span> <span class="skolem">bs</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"is_partition <span class="skolem">rest</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> rest<span class="main">:</span> <span class="quoted"><span class="quoted">"is_partition_impl <span class="skolem">rest</span> <span class="main">=</span> Some <span class="skolem">c</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"is_partition_impl <span class="skolem">rest</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> Cons True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> case_prod_partition<span class="main">:</span>
  <span class="quoted"><span class="quoted">"case_prod <span class="free">f</span> <span class="main">(</span>partition <span class="free">p</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>filter <span class="free">p</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span>Not <span class="main">∘</span> <span class="free">p</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemmas</span></span> map_id<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> list.map_id


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹merging functions›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fun_merge</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span>list <span class="main">⇒</span> <span class="tfree">'a</span> set list <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">fun_merge</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">!</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fun_merge<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> 
      i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">as</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="free">as</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> ident<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span> <span class="bound">j</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">as</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">as</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">as</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">as</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">a</span> <span class="main">=</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="bound">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fun_merge <span class="free">fs</span> <span class="free">as</span> <span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">as</span> <span class="main">∧</span> <span class="free">a</span> <span class="main">∈</span> <span class="free">as</span> <span class="main">!</span> <span class="bound">i</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">LEAST</span> <span class="bound">i</span><span class="main">.</span> <span class="var">?p</span> <span class="bound">i</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="var">?l</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> LeastI<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i a<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> fun_merge_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ident<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ i _ a<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> p<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fun_merge_part<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> 
      part<span class="main">:</span> <span class="quoted"><span class="quoted">"is_partition <span class="free">as</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">as</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="free">as</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fun_merge <span class="free">fs</span> <span class="free">as</span> <span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> fun_merge<span class="main"><span class="main">[</span></span><span class="operator">OF</span> i a<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">a</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">as</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">as</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="free">as</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="free">as</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> part<span class="main">[</span><span class="operator">unfolded</span> is_partition_alt is_partition_alt_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="free">fs</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> map_nth_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="free">f</span> <span class="free">ss</span> <span class="main">=</span> map <span class="free">g</span> <span class="free">ts</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">ss</span><span class="main">.</span> <span class="free">f</span><span class="main">(</span><span class="free">ss</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span><span class="main">(</span><span class="free">ts</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"map <span class="free">f</span> <span class="free">ss</span> <span class="main">=</span> map <span class="free">g</span> <span class="free">ts</span> <span class="main">⟹</span> <span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">ss</span> <span class="main">⟹</span> <span class="free">f</span><span class="main">(</span><span class="free">ss</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span><span class="main">(</span><span class="free">ts</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ss</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="free">ts</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">ts</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">s</span> <span class="skolem">ss</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">ts</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_take_drop<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dist<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">vs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">vs</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct<span class="main">(</span>take <span class="free">i</span> <span class="free">vs</span> <span class="main">@</span> drop <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">vs</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"distinct<span class="main">(</span><span class="var">?xs</span><span class="main">@</span><span class="var">?ys</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> id_take_nth_drop<span class="main">[</span><span class="operator">OF</span> len<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> vs<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">vs</span> <span class="main">=</span> <span class="var">?xs</span> <span class="main">@</span> <span class="free">vs</span><span class="main">!</span><span class="free">i</span> <span class="main">#</span> <span class="var">?ys</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">with</span></span> dist <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="var">?xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct<span class="main">(</span><span class="free">vs</span><span class="main">!</span><span class="free">i</span><span class="main">#</span><span class="var">?ys</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="var">?xs</span> <span class="main">∩</span> set<span class="main">(</span><span class="free">vs</span><span class="main">!</span><span class="free">i</span><span class="main">#</span><span class="var">?ys</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> distinct_append<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?xs</span></span></span> <span class="quoted"><span class="quoted">"<span class="free">vs</span><span class="main">!</span><span class="free">i</span><span class="main">#</span><span class="var">?ys</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"distinct <span class="var">?ys</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="var">?xs</span> <span class="main">∩</span> set <span class="var">?ys</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹distinct <span class="var">?xs</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> distinct_append<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?xs</span></span></span> <span class="var"><span class="quoted"><span class="var">?ys</span></span></span><span class="main">]</span> vs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_nth_eq_conv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="free">ys</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span> <span class="main">=</span> map id <span class="free">ys</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">ys</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> id <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> map_nth_conv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted">id</span> <span class="quoted"><span class="free">ys</span></span><span class="main">]</span> nth_map_conv<span class="main">[</span><span class="operator">OF</span> len<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted">id</span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> len
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">finally</span></span>  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_upt_len_conv<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span> <span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">xs</span><span class="main">]</span> <span class="main">=</span> map <span class="free">f</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nth_equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_upt_add'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map <span class="free">f</span> <span class="main">[</span><span class="free">a</span><span class="main">..&lt;</span><span class="free">a</span><span class="main">+</span><span class="free">b</span><span class="main">]</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">a</span> <span class="main">+</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">b</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">b</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">generate_lists</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">generate_lists</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> concat_lists <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> set_generate_lists<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>generate_lists <span class="free">n</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">as</span><span class="main">.</span> length <span class="bound">as</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> set <span class="bound">as</span> <span class="main">⊆</span> set <span class="free">xs</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">as</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="skolem">as</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>length <span class="skolem">as</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> set <span class="skolem">as</span> <span class="main">⊆</span> set <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">as</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> length <span class="skolem">as</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>set <span class="skolem">as</span> <span class="main">⊆</span> set <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> n
          <span class="keyword1"><span class="command">unfolding</span></span> all_set_conv_all_nth<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">as</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> generate_lists_def <span class="keyword1"><span class="command">unfolding</span></span> set_concat_lists <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nth_append_take<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> length <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>take <span class="free">i</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">y</span><span class="main">#</span><span class="free">ys</span><span class="main">)</span><span class="main">!</span><span class="free">i</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"length<span class="main">(</span>take <span class="free">i</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>take <span class="free">i</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">y</span><span class="main">#</span><span class="free">ys</span><span class="main">)</span><span class="main">!</span><span class="main">(</span>length<span class="main">(</span>take <span class="free">i</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nth_append_length<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> a <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nth_append_take_is_nth_conv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> length <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>take <span class="free">j</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span><span class="main">!</span><span class="free">i</span> <span class="main">=</span> <span class="free">xs</span><span class="main">!</span><span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length<span class="main">(</span>take <span class="free">j</span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>take <span class="free">j</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span><span class="main">!</span><span class="free">i</span> <span class="main">=</span> take <span class="free">j</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> nth_append <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> nth_take<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nth_append_drop_is_nth_conv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> length <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>take <span class="free">j</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> drop <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">!</span><span class="free">i</span> <span class="main">=</span> <span class="free">xs</span><span class="main">!</span><span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc<span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> less_imp_Suc_add <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> length<span class="main">(</span>take <span class="free">j</span> <span class="free">xs</span><span class="main">)</span> <span class="main">+</span> Suc <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="free">j</span> <span class="main">+</span> <span class="skolem">n</span> <span class="main">≤</span> length <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>take <span class="free">j</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> drop <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">!</span><span class="free">i</span> <span class="main">=</span>
    <span class="main">(</span><span class="free">y</span> <span class="main">#</span> drop <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">!</span><span class="main">(</span><span class="free">i</span> <span class="main">-</span> length<span class="main">(</span>take <span class="free">j</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> nth_append i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="free">y</span> <span class="main">#</span> drop <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">!</span><span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">!</span><span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ij len <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nth_append_take_drop_is_nth_conv<span class="main">:</span> 
 <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> length <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> length <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="free">j</span>"</span></span> 
 <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>take <span class="free">j</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> drop <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">!</span><span class="free">i</span> <span class="main">=</span> <span class="free">xs</span><span class="main">!</span><span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">∨</span> <span class="free">i</span> <span class="main">&gt;</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms 
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append_take_is_nth_conv nth_append_drop_is_nth_conv<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> take_drop_imp_nth<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>take <span class="free">i</span> <span class="free">ss</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> drop <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">ss</span> <span class="main">=</span> <span class="free">ss</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="free">ss</span><span class="main">!</span><span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ss</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
 <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">s</span> <span class="skolem">ss</span><span class="main">)</span>
 <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹take <span class="skolem">i</span> <span class="main">(</span><span class="skolem">s</span><span class="main">#</span><span class="skolem">ss</span><span class="main">)</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> drop <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">s</span><span class="main">#</span><span class="skolem">ss</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">s</span><span class="main">#</span><span class="skolem">ss</span><span class="main">)</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
 <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Cons <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="skolem">i</span> <span class="skolem">ss</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> drop <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">ss</span> <span class="main">=</span> <span class="skolem">ss</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="skolem">ss</span><span class="main">!</span><span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> Suc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="skolem">i</span> <span class="skolem">ss</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> drop <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">ss</span> <span class="main">=</span> <span class="skolem">ss</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> IH <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> take_drop_update_first<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">ds</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">cs</span> <span class="main">=</span> length <span class="free">ds</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>take <span class="free">j</span> <span class="free">ds</span> <span class="main">@</span> drop <span class="free">j</span> <span class="free">cs</span><span class="main">)</span><span class="main">[</span><span class="free">j</span> <span class="main">:=</span> <span class="free">ds</span> <span class="main">!</span> <span class="free">j</span><span class="main">]</span> <span class="main">=</span> take <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="free">ds</span> <span class="main">@</span> drop <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="free">cs</span>"</span></span> 
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">j</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ds</span></span> <span class="quoted"><span class="free">cs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="skolem"><span class="skolem">dds</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="skolem"><span class="skolem">ccs</span></span> <span class="keyword2"><span class="keyword">where</span></span> ds<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ds</span> <span class="main">=</span> <span class="skolem">d</span> <span class="main">#</span> <span class="skolem">dds</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> cs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cs</span> <span class="main">=</span> <span class="skolem">c</span> <span class="main">#</span> <span class="skolem">ccs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ds</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">cs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> ds cs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="skolem"><span class="skolem">dds</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="skolem"><span class="skolem">ccs</span></span> <span class="keyword2"><span class="keyword">where</span></span> ds<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ds</span> <span class="main">=</span> <span class="skolem">d</span> <span class="main">#</span> <span class="skolem">dds</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> cs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cs</span> <span class="main">=</span> <span class="skolem">c</span> <span class="main">#</span> <span class="skolem">ccs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ds</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">cs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Suc<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">dds</span></span> <span class="quoted"><span class="skolem">ccs</span></span><span class="main">]</span> Suc<span class="main">(</span>2<span class="main">)</span> Suc<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> ds cs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> take_drop_update_second<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">ds</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">cs</span> <span class="main">=</span> length <span class="free">ds</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>take <span class="free">j</span> <span class="free">ds</span> <span class="main">@</span> drop <span class="free">j</span> <span class="free">cs</span><span class="main">)</span><span class="main">[</span><span class="free">j</span> <span class="main">:=</span> <span class="free">cs</span> <span class="main">!</span> <span class="free">j</span><span class="main">]</span> <span class="main">=</span> take <span class="free">j</span> <span class="free">ds</span> <span class="main">@</span> drop <span class="free">j</span> <span class="free">cs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">j</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ds</span></span> <span class="quoted"><span class="free">cs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="skolem"><span class="skolem">dds</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="skolem"><span class="skolem">ccs</span></span> <span class="keyword2"><span class="keyword">where</span></span> ds<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ds</span> <span class="main">=</span> <span class="skolem">d</span> <span class="main">#</span> <span class="skolem">dds</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> cs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cs</span> <span class="main">=</span> <span class="skolem">c</span> <span class="main">#</span> <span class="skolem">ccs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ds</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">cs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> ds cs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="skolem"><span class="skolem">dds</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="skolem"><span class="skolem">ccs</span></span> <span class="keyword2"><span class="keyword">where</span></span> ds<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ds</span> <span class="main">=</span> <span class="skolem">d</span> <span class="main">#</span> <span class="skolem">dds</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> cs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cs</span> <span class="main">=</span> <span class="skolem">c</span> <span class="main">#</span> <span class="skolem">ccs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ds</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">cs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Suc<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">dds</span></span> <span class="quoted"><span class="skolem">ccs</span></span><span class="main">]</span> Suc<span class="main">(</span>2<span class="main">)</span> Suc<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> ds cs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> nth_take_prefix<span class="main">:</span>
 <span class="quoted"><span class="quoted">"length <span class="free">ys</span> <span class="main">≤</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">ys</span><span class="main">.</span> <span class="free">xs</span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> <span class="free">ys</span><span class="main">!</span><span class="bound">i</span> <span class="main">⟹</span> take <span class="main">(</span>length <span class="free">ys</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2'<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="skolem">ys</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">ys</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> 4<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> 4<span class="main"><span class="main">(</span></span>2-3<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 4<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">lemma</span></span> take_upt_idx<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">ls</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"take <span class="free">i</span> <span class="free">ls</span> <span class="main">=</span> <span class="main">[</span> <span class="free">ls</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">.</span> j <span class="main">←</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">]</span><span class="main">]</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">+</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> take_upt<span class="main">[</span><span class="operator">OF</span> e<span class="main">]</span> take_map map_nth
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>hide_lams<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> add.left_neutral i nat_less_le take_upt<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">distinct_eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">distinct_eq</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">distinct_eq</span> <span class="free"><span class="bound"><span class="entity">eq</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">∀</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">eq</span></span></span> <span class="bound">y</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free">distinct_eq</span> <span class="free"><span class="bound"><span class="entity">eq</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_eq_append<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct_eq <span class="free">eq</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>distinct_eq <span class="free">eq</span> <span class="free">xs</span> <span class="main">∧</span> distinct_eq <span class="free">eq</span> <span class="free">ys</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="free">ys</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="free">eq</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> append_Cons_nth_left<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">u</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms nth_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">xs</span></span> <span class="main">_</span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> append_Cons_nth_middle<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">zs</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> append_Cons_nth_right<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&gt;</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">u</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">z</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">-</span> length <span class="free">xs</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">-</span> length <span class="free">xs</span> <span class="main">=</span> Suc <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">-</span> length <span class="free">xs</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> append_Cons_nth_not_middle<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">u</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">z</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_Cons_nth_left<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False 
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&gt;</span> length <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> append_Cons_nth_right<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> append_Cons_nth <span class="main">=</span> append_Cons_nth_middle append_Cons_nth_not_middle

<span class="keyword1"><span class="command">lemma</span></span> concat_all_nth<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> length <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span>length <span class="main">(</span>concat <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>concat <span class="free">xs</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span>concat <span class="free">ys</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> xy<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">x</span> <span class="main">=</span> length <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> xy <span class="keyword1"><span class="command">have</span></span> pxy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="skolem">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> Cons<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span>"</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">have</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span><span class="skolem">ys</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span>"</span></span><span class="main">]</span> i <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> len <span class="keyword2"><span class="keyword">and</span></span> this
  <span class="keyword1"><span class="command">}</span></span> 
  <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> ind<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> length <span class="main">(</span>concat <span class="skolem">xs</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>concat <span class="skolem">xs</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span>concat <span class="skolem">ys</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> concat.simps
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword3"><span class="command">assume</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">x</span> <span class="main">@</span> concat <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">@</span> concat <span class="skolem">xs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span> <span class="main">@</span> concat <span class="skolem">ys</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="skolem">x</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> nth_append <span class="keyword1"><span class="command">using</span></span> True xy pxy<span class="main">[</span><span class="operator">OF</span> True<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> k <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">-</span> <span class="main">(</span>length <span class="skolem">x</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="main">(</span>concat <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">-</span> length <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nxs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="main">(</span>concat <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> nth_append n n<span class="main">[</span><span class="operator">unfolded</span> xy<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> False xy ind<span class="main">[</span><span class="operator">OF</span> nxs<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_length_concat_nth<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> length <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>concat <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>concat <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> xy<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">x</span> <span class="main">=</span> length <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> Cons<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span>"</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span><span class="skolem">ys</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span> 
  <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> ind<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>concat <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>concat <span class="skolem">ys</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> xy ind <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">list_union</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">list_union</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">list_union</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">zs</span> <span class="main">=</span> <span class="free">list_union</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> set <span class="bound">zs</span> <span class="keyword1">then</span> <span class="bound">zs</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="bound">zs</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> set_list_union<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>list_union <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs</span> <span class="main">∪</span> set <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">(</span>list_union <span class="skolem">xs</span> <span class="free">ys</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">declare</span></span> list_union.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword">del</span></span><span class="main">]</span>

<span class="comment1">(*Why was list_inter thrown out of List.thy?*)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">list_inter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">list_inter</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">list_inter</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free">list_inter</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="keyword1">else</span> <span class="free">list_inter</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> set_list_inter<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>list_inter <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs</span> <span class="main">∩</span> set <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_inter.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">declare</span></span> list_inter.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword">del</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">list_diff</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">list_diff</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">list_diff</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">zs</span> <span class="main">=</span> <span class="free">list_diff</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="keyword1">then</span> <span class="bound">zs</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="bound">zs</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> set_list_diff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>list_diff <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs</span> <span class="main">-</span> set <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="free">ys</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">declare</span></span> list_diff.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword">del</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> nth_drop_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="free">ss</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">ss</span><span class="main">!</span><span class="main">0</span><span class="main">)</span><span class="main">#</span>drop <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">ss</span> <span class="main">=</span> <span class="free">ss</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ss</span></span><span class="main">)</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">lemma</span></span> set_foldr_remdups_set_map_conv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>foldr <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">xs</span><span class="main">.</span> remdups <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="main">@</span> <span class="bound">xs</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>map <span class="main">(</span>set <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">lemma</span></span> subset_set_code<span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> set <span class="free">ys</span> <span class="main">⟷</span> list_all <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">ys</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> list_all_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">union_list_sorted</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">union_list_sorted</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> 
   <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free">union_list_sorted</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> 
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free">union_list_sorted</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free">union_list_sorted</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">union_list_sorted</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">union_list_sorted</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>union_list_sorted <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs</span> <span class="main">∪</span> set <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> union_list_sorted.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">subtract_list_sorted</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">subtract_list_sorted</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> 
   <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> <span class="free">subtract_list_sorted</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> 
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free">subtract_list_sorted</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="free">subtract_list_sorted</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subtract_list_sorted</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subtract_list_sorted</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> set_subtract_list_sorted<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="free">xs</span> <span class="main">⟹</span> sorted <span class="free">ys</span> <span class="main">⟹</span>
  set <span class="main">(</span>subtract_list_sorted <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs</span> <span class="main">-</span> set <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> subtract_list_sorted.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> xxs<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span> 
  <span class="keyword1"><span class="command">have</span></span> yys<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">have</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> xxs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> True xs yys<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> neq <span class="main">=</span> this
    <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> 1<span class="main">(</span>2-3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">y</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> IH xxs yys False<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>  

<span class="keyword1"><span class="command">lemma</span></span> subset_subtract_listed_sorted<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>subtract_list_sorted <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⊆</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> subtract_list_sorted.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> set_subtract_list_distinct<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span> <span class="main">⟹</span> distinct <span class="main">(</span>subtract_list_sorted <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> subtract_list_sorted.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> subset_subtract_listed_sorted<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">remdups_sort</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> remdups_adj <span class="main">(</span>sort <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> remdups_sort<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>remdups_sort <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>remdups_sort <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs</span>"</span></span>
  <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>remdups_sort <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remdups_sort_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹maximum and minimum›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> max_list_mono<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">-</span> set <span class="free">ys</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="free">ys</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"max_list <span class="free">xs</span> <span class="main">≤</span> max_list <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> max_list <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="free">ys</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">from</span></span> max_list<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> Cons<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set <span class="free">ys</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> xy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> xy max_list<span class="main">[</span><span class="operator">OF</span> y<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"max_list <span class="skolem">xs</span> <span class="main">≤</span> max_list <span class="free">ys</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Cons<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> Cons<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">min_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">min_list</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">min_list</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> min <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free">min_list</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> min_list<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> min_list <span class="free">xs</span> <span class="main">≤</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> oCons <span class="main">:</span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ys</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> oCons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">z</span> <span class="skolem">zs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"min_list <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span> min <span class="skolem">y</span> <span class="main">(</span>min_list <span class="skolem">ys</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> id True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min <span class="skolem">y</span> <span class="main">(</span>min_list <span class="skolem">ys</span><span class="main">)</span> <span class="main">≤</span> min_list <span class="skolem">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> oCons False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> id <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> min_list_Cons<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> xy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> xsys<span class="main">:</span> <span class="quoted"><span class="quoted">"min_list <span class="free">xs</span> <span class="main">≤</span> min_list <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"min_list <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">≤</span> min_list <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">with</span></span> len <span class="keyword1"><span class="command">have</span></span> ys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> xy Nil <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x'</span> <span class="skolem">xs'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> len <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y'</span></span> <span class="skolem"><span class="skolem">ys'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">=</span> <span class="skolem">y'</span> <span class="main">#</span> <span class="skolem">ys'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ys</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Cons <span class="keyword1"><span class="command">have</span></span> one<span class="main">:</span> <span class="quoted"><span class="quoted">"min_list <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> min <span class="free">x</span> <span class="main">(</span>min_list <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> ys <span class="keyword1"><span class="command">have</span></span> two<span class="main">:</span> <span class="quoted"><span class="quoted">"min_list <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> min <span class="free">y</span> <span class="main">(</span>min_list <span class="free">ys</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> one two <span class="keyword1"><span class="command">using</span></span> xy xsys 
    <span class="keyword1"><span class="command">unfolding</span></span>  min_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> min_list_nth<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">ys</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">ys</span> <span class="main">!</span> <span class="bound">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"min_list <span class="free">xs</span> <span class="main">≤</span> min_list <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">zs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span> zs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">zs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> Cons <span class="main">=</span> Cons<span class="main">[</span><span class="operator">unfolded</span> zs<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">=</span> length <span class="skolem">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> xy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> Cons<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span>"</span></span><span class="main">]</span> Cons<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">ys</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span> 
  <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> len this<span class="main">]</span> Cons<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> ind<span class="main">:</span> <span class="quoted"><span class="quoted">"min_list <span class="skolem">xs</span> <span class="main">≤</span> min_list <span class="skolem">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> zs
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> min_list_Cons<span class="main"><span class="main">[</span></span><span class="operator">OF</span> xy len ind<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> min_list_ex<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">xs</span><span class="main">.</span> min_list <span class="free">xs</span> <span class="main">=</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> oCons <span class="main">:</span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"min_list <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> min <span class="skolem">x</span> <span class="main">(</span>min_list <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nNil<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> min_list <span class="skolem">xs</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> id 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> True<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> min_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> id min_def
        <span class="keyword1"><span class="command">using</span></span> oCons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> nNil<span class="main">]</span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> min_list_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> subset<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">ys</span> <span class="main">⊆</span> set <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"min_list <span class="free">xs</span> <span class="main">∈</span> set <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"min_list <span class="free">xs</span> <span class="main">=</span> min_list <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> subset mem <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> min_list_ex<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> mx<span class="main">:</span> <span class="quoted"><span class="quoted">"min_list <span class="free">xs</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> min_list<span class="main">[</span><span class="operator">OF</span> mem<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> two<span class="main">:</span> <span class="quoted"><span class="quoted">"min_list <span class="free">ys</span> <span class="main">≤</span> min_list <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> mem <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> min_list_ex<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set <span class="free">ys</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> my<span class="main">:</span> <span class="quoted"><span class="quoted">"min_list <span class="free">ys</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> y subset <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> min_list<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> one<span class="main">:</span> <span class="quoted"><span class="quoted">"min_list <span class="free">xs</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> one two 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> mx my <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Apply a permutation to a list.›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">permut_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> nat<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">permut_aux</span> <span class="main">[]</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">permut_aux</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">0</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="free">permut_aux</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">permut</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> nat<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">permut</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> permut_aux <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span>"</span></span>
<span class="keyword1"><span class="command">declare</span></span> permut_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> permut_aux_sound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">as</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"permut_aux <span class="free">as</span> <span class="free">f</span> <span class="free">bs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">bs</span> <span class="main">!</span> <span class="main">(</span><span class="free">f</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">as</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">bs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Cons<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> Suc <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> permut_sound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">as</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"permut <span class="free">as</span> <span class="free">f</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">as</span> <span class="main">!</span> <span class="main">(</span><span class="free">f</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> permut_aux_sound <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> permut_aux_length<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="free">f</span> <span class="main">{..&lt;</span>length <span class="free">as</span><span class="main">}</span> <span class="main">{..&lt;</span>length <span class="free">bs</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>permut_aux <span class="free">as</span> <span class="free">f</span> <span class="free">bs</span><span class="main">)</span> <span class="main">=</span> length <span class="free">as</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">as</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">bs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> permut_length<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="free">f</span> <span class="main">{..&lt;</span> length <span class="free">as</span><span class="main">}</span> <span class="main">{..&lt;</span> length <span class="free">as</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>permut <span class="free">as</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> length <span class="free">as</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> permut_aux_length<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
 
<span class="keyword1"><span class="command">declare</span></span> permut_def<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> foldl_assoc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">b</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⋅</span>"</span> 55<span class="main">)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">g</span> <span class="bound">h</span><span class="main">.</span> <span class="bound">f</span> <span class="main"><span class="free">⋅</span></span> <span class="main">(</span><span class="bound">g</span> <span class="main"><span class="free">⋅</span></span> <span class="bound">h</span><span class="main">)</span> <span class="main">=</span> <span class="bound">f</span> <span class="main"><span class="free">⋅</span></span> <span class="bound">g</span> <span class="main"><span class="free">⋅</span></span> <span class="bound">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"foldl <span class="main"><span class="free">(⋅)</span></span> <span class="main">(</span><span class="free">x</span> <span class="main"><span class="free">⋅</span></span> <span class="free">y</span><span class="main">)</span> <span class="free">zs</span> <span class="main">=</span> <span class="free">x</span> <span class="main"><span class="free">⋅</span></span> foldl <span class="main"><span class="free">(⋅)</span></span> <span class="free">y</span> <span class="free">zs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">zs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">y</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> foldr_assoc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">g</span> <span class="bound">h</span><span class="main">.</span> <span class="free">b</span> <span class="main">(</span><span class="free">b</span> <span class="bound">f</span> <span class="bound">g</span><span class="main">)</span> <span class="bound">h</span> <span class="main">=</span> <span class="free">b</span> <span class="bound">f</span> <span class="main">(</span><span class="free">b</span> <span class="bound">g</span> <span class="bound">h</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"foldr <span class="free">b</span> <span class="free">xs</span> <span class="main">(</span><span class="free">b</span> <span class="free">y</span> <span class="free">z</span><span class="main">)</span> <span class="main">=</span> <span class="free">b</span> <span class="main">(</span>foldr <span class="free">b</span> <span class="free">xs</span> <span class="free">y</span><span class="main">)</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> foldl_foldr_o_id<span class="main">:</span>
  <span class="quoted"><span class="quoted">"foldl <span class="main">(∘)</span> id <span class="free">fs</span> <span class="main">=</span> foldr <span class="main">(∘)</span> <span class="free">fs</span> id"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">fs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">f</span> <span class="skolem">fs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"id <span class="main">∘</span> <span class="skolem">f</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">∘</span> id"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> Cons <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> foldl_Cons foldr_Cons o_apply <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted">id</span><span class="main"><span class="main">]</span></span> foldl_assoc o_assoc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> foldr_o_o_id<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"foldr <span class="main">(</span><span class="main">(∘)</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="free">xs</span> id <span class="free">a</span> <span class="main">=</span> foldr <span class="free">f</span> <span class="free">xs</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> Ex_list_of_length_P<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">xs</span><span class="main">.</span> length <span class="bound">xs</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="bound">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟶</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> choice<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="skolem">xs</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"map <span class="skolem"><span class="skolem"><span class="skolem">xs</span></span></span> <span class="main"><span class="main"><span class="main">[</span></span></span><span class="main"><span class="main"><span class="main">0</span></span></span> <span class="main"><span class="main"><span class="main">..&lt;</span></span></span> <span class="free"><span class="free"><span class="free">n</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> xs<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ex_set_conv_ex_nth<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">xs</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="free">xs</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> in_set_conv_nth<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">xs</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> map_eq_set_zipD <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"map <span class="free">f</span> <span class="free">xs</span> <span class="main">=</span> map <span class="free">f</span> <span class="free">ys</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="free">f</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ys</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">span</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">×</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">span</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">zs</span><span class="main">)</span> <span class="main">=</span> <span class="free">span</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">in</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="bound">ys</span><span class="main">,</span> <span class="bound">zs</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">span</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> span<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"span <span class="free">P</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span>takeWhile <span class="free">P</span> <span class="free">xs</span><span class="main">,</span> dropWhile <span class="free">P</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> span.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword">del</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> parallel_list_update<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> 
  one_update<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">xs</span> <span class="bound">i</span> <span class="bound">y</span><span class="main">.</span> length <span class="bound">xs</span> <span class="main">=</span> <span class="free">n</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">(</span><span class="bound">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">p</span> <span class="bound">xs</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">(</span><span class="bound">xs</span><span class="main">[</span><span class="bound">i</span> <span class="main">:=</span> <span class="bound">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> init<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> rel<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">ys</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> len <span class="main">=</span> rel<span class="main">(</span>1<span class="main">)</span> init<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">(</span>take <span class="skolem">i</span> <span class="free">ys</span> <span class="main">@</span> drop <span class="skolem">i</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword1"><span class="command">with</span></span> init <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">(</span>take <span class="skolem">i</span> <span class="free">ys</span> <span class="main">@</span> drop <span class="skolem">i</span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> Suc <span class="keyword1"><span class="command">have</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>take <span class="skolem">i</span> <span class="free">ys</span> <span class="main">@</span> drop <span class="skolem">i</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="var">?xs</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i len <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> one_update<span class="main">[</span><span class="operator">OF</span> this i _ IH<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span><span class="main">]</span> rel<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> i<span class="main">]</span> i len
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append take_drop_update_first<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> len <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nth_concat_two_lists<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="main">(</span>concat <span class="main">(</span><span class="free">xs</span> <span class="main">::</span> <span class="tfree">'a</span> list list<span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> length <span class="main">(</span><span class="free">ys</span> <span class="main">::</span> <span class="tfree">'b</span> list list<span class="main">)</span> <span class="main">=</span> length <span class="free">xs</span> 
  <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> length <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>
  <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">j</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>concat <span class="free">xs</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">∧</span>
     <span class="main">(</span>concat <span class="free">ys</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">!</span> <span class="bound">k</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">i</span> <span class="skolem">yys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span> yys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">yys</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">yys</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> Cons <span class="main">=</span> Cons<span class="main">[</span><span class="operator">unfolded</span> yys<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">y</span> <span class="main">=</span> length <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">x</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> yys
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">i</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> True Cons<span class="main"><span class="main">(</span></span>2-4<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">-</span> length <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> False Cons<span class="main">(</span>2-3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?i</span> <span class="main">&lt;</span> length <span class="main">(</span>concat <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ys</span> <span class="main">=</span> length <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> Cons<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">ys</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">from</span></span> IH<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> IH1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> 
      <span class="quoted"><span class="quoted">"concat <span class="skolem">xs</span> <span class="main">!</span> <span class="var">?i</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">!</span> <span class="skolem">k</span>"</span></span>
      <span class="quoted"><span class="quoted">"concat <span class="skolem">ys</span> <span class="main">!</span> <span class="var">?i</span> <span class="main">=</span> <span class="skolem">ys</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">!</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> yys
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="skolem"><span class="skolem"><span class="skolem">j</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">k</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> IH1 False<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Removing duplicates w.r.t. some function.›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">remdups_gen</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">remdups_gen</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">remdups_gen</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free">remdups_gen</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">[</span><span class="bound">y</span> <span class="main">&lt;-</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">.</span> <span class="main">¬</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">y</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> remdups_gen_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>remdups_gen <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⊆</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> remdups_gen.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> remdups_gen_elem_imp_elem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span>remdups_gen <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> remdups_gen_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> elem_imp_remdups_gen_elem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>remdups_gen <span class="free">f</span> <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> remdups_gen.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">f</span> <span class="skolem">z</span> <span class="skolem">zs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="free">x</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">z</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> 2<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="main">[</span><span class="bound">y</span><span class="main">←</span><span class="skolem">zs</span> <span class="main">.</span> <span class="skolem">f</span> <span class="skolem">z</span> <span class="main">≠</span> <span class="skolem">f</span> <span class="bound">y</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> 2<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">lemma</span></span> take_nth_drop_concat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xss</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xss</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">ys</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">ys</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">!</span> <span class="free">j</span> <span class="main">=</span> <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">k</span></span> <span class="main">&lt;</span> length <span class="main">(</span>concat <span class="free">xss</span><span class="main">)</span><span class="main">.</span>
    take <span class="bound">k</span> <span class="main">(</span>concat <span class="free">xss</span><span class="main">)</span> <span class="main">=</span> concat <span class="main">(</span>take <span class="free">i</span> <span class="free">xss</span><span class="main">)</span> <span class="main">@</span> take <span class="free">j</span> <span class="free">ys</span> <span class="main">∧</span>
    concat <span class="free">xss</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">=</span> <span class="free">xss</span> <span class="main">!</span> <span class="free">i</span> <span class="main">!</span> <span class="free">j</span> <span class="main">∧</span>
    drop <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">(</span>concat <span class="free">xss</span><span class="main">)</span> <span class="main">=</span> drop <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="free">ys</span> <span class="main">@</span> concat <span class="main">(</span>drop <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">xss</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span> 2<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xss</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> List.rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">xs</span> <span class="skolem">xss</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">xss</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> concat_map_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">[]</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> map_upt_len_same_len_conv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> length <span class="free">ys</span><span class="main">]</span> <span class="main">=</span> map <span class="free">f</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> assms <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> map_upt_len_conv<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> concat_map_concat <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"concat <span class="main">(</span>map concat <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> concat <span class="main">(</span>concat <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> concat_concat_map<span class="main">:</span>
  <span class="quoted"><span class="quoted">"concat <span class="main">(</span>concat <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> concat <span class="main">(</span>map <span class="main">(</span>concat <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> UN_upt_len_conv <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> <span class="free">n</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Ball_at_Least0LessThan_conv <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> <span class="free">n</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> atLeast0LessThan in_set_conv_nth lessThan_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_list_replicate_length <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>replicate <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> list_all2_in_set2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">P</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> set <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">x</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> map_eq_conv'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map <span class="free">f</span> <span class="free">xs</span> <span class="main">=</span> map <span class="free">g</span> <span class="free">ys</span> <span class="main">⟷</span> length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">xs</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> map_eq_imp_length_eq map_nth_conv <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_map_conv<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> list_3_cases<span class="main">[</span><span class="operator">case_names</span> Nil 1 2<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">ys</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">x</span><span class="main">#</span><span class="bound">y</span><span class="main">#</span><span class="bound">ys</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">P</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"tl <span class="free">xs</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> list_4_cases<span class="main">[</span><span class="operator">case_names</span> Nil 1 2 3<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">]</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span> <span class="bound">zs</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">y</span> <span class="main">#</span> <span class="bound">z</span> <span class="main">#</span> <span class="bound">zs</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">P</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"tl <span class="free">xs</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"tl <span class="main">(</span>tl <span class="free">xs</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> foldr_append2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"foldr <span class="main">(</span><span class="main">(@)</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="free">xs</span> <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span> <span class="main">=</span> foldr <span class="main">(</span><span class="main">(@)</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">@</span> <span class="free">zs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> foldr_append2_Nil <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"foldr <span class="main">(</span><span class="main">(@)</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="free">xs</span> <span class="main">[]</span> <span class="main">@</span> <span class="free">zs</span> <span class="main">=</span> foldr <span class="main">(</span><span class="main">(@)</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="free">xs</span> <span class="free">zs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> foldr_append2 <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> UNION_set_zip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">xs</span><span class="main">]</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">xs</span><span class="main">.</span> <span class="free">g</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_conv_nth<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zip_fst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="free">as</span> <span class="free">bs</span><span class="main">)</span> <span class="main">⟹</span> fst <span class="free">p</span> <span class="main">∈</span> set <span class="free">as</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">p</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> set_zip_leftD<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zip_snd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="free">as</span> <span class="free">bs</span><span class="main">)</span> <span class="main">⟹</span> snd <span class="free">p</span> <span class="main">∈</span> set <span class="free">bs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">p</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> set_zip_rightD<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zip_size_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"size_list <span class="main">(</span>size <span class="keyword1">o</span> snd<span class="main">)</span> <span class="main">(</span>zip <span class="free">ts</span> <span class="free">ls</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span>size_list size <span class="free">ls</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ls</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ts</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">l</span> <span class="skolem">ls</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ts</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We definie the function that remove the nth element of
a list. It uses take and drop and the soundness is therefore not
too hard to prove thanks to the already existing lemmas.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">remove_nth</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">remove_nth</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> <span class="main">(</span>take <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> remove_nth_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> remove_nth_len<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> Suc <span class="main">(</span>length <span class="main">(</span>remove_nth <span class="free">i</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> arg_cong<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"length"</span></span><span class="main">,</span> <span class="operator">OF</span> id_take_nth_drop<span class="main"><span class="main">[</span></span><span class="operator">OF</span> i<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> remove_nth_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> remove_nth_length <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> n_bd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>remove_nth <span class="free">n</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> length <span class="free">xs</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
 <span class="keyword1"><span class="command">from</span></span> length_take <span class="keyword1"><span class="command">have</span></span> ll<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟶</span> length <span class="main">(</span>take <span class="free">n</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">from</span></span> length_drop <span class="keyword1"><span class="command">have</span></span> lr<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>drop <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> length <span class="free">xs</span> <span class="main">-</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command">from</span></span> ll <span class="keyword2"><span class="keyword">and</span></span> lr <span class="keyword2"><span class="keyword">and</span></span> length_append <span class="keyword2"><span class="keyword">and</span></span> n_bd <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> remove_nth_id <span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> remove_nth <span class="free">n</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> take_all drop_all append_Nil2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> remove_nth_sound_l <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p_ub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>remove_nth <span class="free">n</span> <span class="free">xs</span><span class="main">)</span> <span class="main">!</span> <span class="free">p</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span><span class="main">)</span>
 <span class="keyword3"><span class="command">case</span></span> True  
  <span class="keyword1"><span class="command">from</span></span> length_take <span class="keyword2"><span class="keyword">and</span></span> True <span class="keyword1"><span class="command">have</span></span> ltk<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>take <span class="free">n</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command">{</span></span>
     <span class="keyword3"><span class="command">assume</span></span> pltn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
     <span class="keyword1"><span class="command">from</span></span> this <span class="keyword2"><span class="keyword">and</span></span> ltk <span class="keyword1"><span class="command">have</span></span> plttk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&lt;</span> length <span class="main">(</span>take <span class="free">n</span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command">with</span></span> nth_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"take <span class="free">n</span> <span class="free">xs</span>"</span></span> <span class="main">_</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
     <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>take <span class="free">n</span> <span class="free">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="free">p</span> <span class="main">=</span> take <span class="free">n</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">with</span></span> pltn <span class="keyword2"><span class="keyword">and</span></span> nth_take <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>take <span class="free">n</span> <span class="free">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="free">p</span> <span class="main">=</span>  <span class="free">xs</span> <span class="main">!</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword2"><span class="keyword">and</span></span> ltk <span class="keyword2"><span class="keyword">and</span></span> p_ub <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command">next</span></span>
 <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">with</span></span> remove_nth_id <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> remove_nth_sound_r <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>remove_nth <span class="free">n</span> <span class="free">xs</span><span class="main">)</span> <span class="main">!</span> <span class="free">p</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="main">(</span>Suc <span class="free">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
 <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">≤</span> <span class="free">p</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">&lt;</span> length <span class="free">xs</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> n_ub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
 <span class="keyword1"><span class="command">from</span></span> length_take <span class="keyword2"><span class="keyword">and</span></span> n_ub <span class="keyword1"><span class="command">have</span></span> ltk<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>take <span class="free">n</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">≤</span> <span class="free">p</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> ltk <span class="keyword2"><span class="keyword">and</span></span> nth_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"take <span class="free">n</span> <span class="free">xs</span>"</span></span> <span class="main">_</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
 <span class="keyword1"><span class="command">have</span></span> Hrew<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>take <span class="free">n</span> <span class="free">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="free">p</span> <span class="main">=</span> drop <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">xs</span> <span class="main">!</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">≤</span> <span class="free">p</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> idx<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="free">n</span> <span class="main">+</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> Suc <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
 <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">&lt;</span> length <span class="free">xs</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> Sp_ub<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="free">p</span> <span class="main">≤</span> length <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
 <span class="keyword1"><span class="command">from</span></span> idx <span class="keyword2"><span class="keyword">and</span></span> Sp_ub <span class="keyword2"><span class="keyword">and</span></span> nth_drop <span class="keyword1"><span class="command">have</span></span> Hrew'<span class="main">:</span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">xs</span> <span class="main">!</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="main">(</span>Suc <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command">from</span></span> Hrew <span class="keyword2"><span class="keyword">and</span></span> Hrew' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nth_remove_nth_conv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="main">(</span>remove_nth <span class="free">n</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"remove_nth <span class="free">n</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="keyword1">then</span> <span class="free">i</span> <span class="keyword1">else</span> Suc <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms remove_nth_sound_l remove_nth_sound_r<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> remove_nth_P_compat <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> aslbs<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">as</span> <span class="main">=</span> length <span class="free">bs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> Pab<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">as</span> <span class="main">⟶</span> <span class="free">P</span> <span class="main">(</span><span class="free">as</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">bs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="main">(</span>remove_nth <span class="free">p</span> <span class="free">as</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">P</span> <span class="main">(</span>remove_nth <span class="free">p</span> <span class="free">as</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>remove_nth <span class="free">p</span> <span class="free">bs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&lt;</span> length <span class="free">as</span>"</span></span><span class="main">)</span>
 <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">hence</span></span> p_ub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&lt;</span> length <span class="free">as</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command">with</span></span> remove_nth_length <span class="keyword1"><span class="command">have</span></span> lr_ub<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>remove_nth <span class="free">p</span> <span class="free">as</span><span class="main">)</span> <span class="main">=</span> length <span class="free">as</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> i_ub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>remove_nth <span class="free">p</span> <span class="free">as</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>remove_nth <span class="free">p</span> <span class="free">as</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>remove_nth <span class="free">p</span> <span class="free">bs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span><span class="main">)</span>
     <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">from</span></span> i_ub <span class="keyword2"><span class="keyword">and</span></span> lr_ub <span class="keyword1"><span class="command">have</span></span> i_ub2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">as</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
      <span class="keyword1"><span class="command">from</span></span> i_ub2 <span class="keyword2"><span class="keyword">and</span></span> Pab <span class="keyword1"><span class="command">have</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="free">as</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="free">bs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> P <span class="keyword2"><span class="keyword">and</span></span> remove_nth_sound_l<span class="main">[</span><span class="operator">OF</span> True<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">as</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> remove_nth_sound_l<span class="main">[</span><span class="operator">OF</span> True<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">bs</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command">next</span></span>
     <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> p_ub2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≤</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
      <span class="keyword1"><span class="command">from</span></span> i_ub <span class="keyword2"><span class="keyword">and</span></span> lr_ub <span class="keyword1"><span class="command">have</span></span> Si_ub<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">as</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
      <span class="keyword1"><span class="command">with</span></span> Pab <span class="keyword1"><span class="command">have</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="free">as</span> <span class="main">!</span> Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="free">bs</span> <span class="main">!</span> Suc <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> i_ub <span class="keyword2"><span class="keyword">and</span></span> lr_ub <span class="keyword1"><span class="command">have</span></span> i_uba<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">as</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
      <span class="keyword1"><span class="command">from</span></span> i_uba <span class="keyword2"><span class="keyword">and</span></span> aslbs <span class="keyword1"><span class="command">have</span></span> i_ubb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">bs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>      
      <span class="keyword1"><span class="command">from</span></span> P <span class="keyword2"><span class="keyword">and</span></span> p_ub <span class="keyword2"><span class="keyword">and</span></span> aslbs <span class="keyword2"><span class="keyword">and</span></span> remove_nth_sound_r<span class="main">[</span><span class="operator">OF</span> p_ub2 i_uba<span class="main">]</span>
       <span class="keyword2"><span class="keyword">and</span></span> remove_nth_sound_r<span class="main">[</span><span class="operator">OF</span> p_ub2 i_ubb<span class="main">]</span>
       <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command">next</span></span>    
 <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> p_lba<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">as</span> <span class="main">≤</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">with</span></span> aslbs <span class="keyword1"><span class="command">have</span></span> p_lbb<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">bs</span> <span class="main">≤</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> remove_nth_id<span class="main">[</span><span class="operator">OF</span> p_lba<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> remove_nth_id<span class="main">[</span><span class="operator">OF</span> p_lbb<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> Pab
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">declare</span></span> remove_nth_def<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">adjust_idx</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">adjust_idx</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="keyword1">else</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">adjust_idx_rev</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">adjust_idx_rev</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> adjust_idx_rev1<span class="main">:</span> <span class="quoted"><span class="quoted">"adjust_idx_rev <span class="free">i</span> <span class="main">(</span>adjust_idx <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> adjust_idx_def adjust_idx_rev_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> adjust_idx_rev2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≠</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"adjust_idx <span class="free">i</span> <span class="main">(</span>adjust_idx_rev <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> adjust_idx_def adjust_idx_rev_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> adjust_idx_i<span class="main">:</span>
  <span class="quoted"><span class="quoted">"adjust_idx <span class="free">i</span> <span class="free">j</span> <span class="main">≠</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> adjust_idx_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> adjust_idx_nth<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"remove_nth <span class="free">i</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">j</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> adjust_idx <span class="free">i</span> <span class="free">j</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?j</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"adjust_idx <span class="free">i</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> i <span class="keyword1"><span class="command">have</span></span> ltake<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>take <span class="free">i</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">note</span></span> nth_xs <span class="main">=</span> arg_cong<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">!</span> <span class="var">?j</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> id_take_nth_drop<span class="main"><span class="main">[</span></span><span class="operator">OF</span> i<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">unfolded</span> nth_append ltake<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?j</span> <span class="main">=</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> adjust_idx_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> nth_xs <span class="keyword1"><span class="command">unfolding</span></span> j remove_nth_def nth_append ltake
      <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?j</span> <span class="main">=</span> Suc <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> adjust_idx_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> i <span class="keyword1"><span class="command">have</span></span> lxs<span class="main">:</span> <span class="quoted"><span class="quoted">"min <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> nth_xs <span class="keyword1"><span class="command">unfolding</span></span> j remove_nth_def nth_append
      <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lxs<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> adjust_idx_rev_nth<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ji<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≠</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"remove_nth <span class="free">i</span> <span class="free">xs</span> <span class="main">!</span> adjust_idx_rev <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">j</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?j</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"adjust_idx_rev <span class="free">i</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> i <span class="keyword1"><span class="command">have</span></span> ltake<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>take <span class="free">i</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">note</span></span> nth_xs <span class="main">=</span> arg_cong<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">!</span> <span class="free">j</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> id_take_nth_drop<span class="main"><span class="main">[</span></span><span class="operator">OF</span> i<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">unfolded</span> nth_append ltake<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?j</span> <span class="main">=</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> adjust_idx_rev_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> nth_xs <span class="keyword1"><span class="command">unfolding</span></span> j remove_nth_def nth_append ltake
      <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> ji <span class="keyword1"><span class="command">have</span></span> ji<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&gt;</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?j</span> <span class="main">=</span> <span class="free">j</span> <span class="main">-</span> Suc <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> adjust_idx_rev_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> nth_xs <span class="keyword1"><span class="command">unfolding</span></span> j remove_nth_def nth_append ltake
      <span class="keyword1"><span class="command">using</span></span> ji <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> adjust_idx_length<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="main">(</span>remove_nth <span class="free">i</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"adjust_idx <span class="free">i</span> <span class="free">j</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> j <span class="keyword1"><span class="command">unfolding</span></span> remove_nth_len<span class="main">[</span><span class="operator">OF</span> i<span class="main">]</span> adjust_idx_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> adjust_idx_rev_length<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≠</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"adjust_idx_rev <span class="free">i</span> <span class="free">j</span> <span class="main">&lt;</span> length <span class="main">(</span>remove_nth <span class="free">i</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> adjust_idx_rev_def remove_nth_len<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹If a binary relation holds on two couples of lists, then it holds on
the concatenation of the two couples.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> P_as_bs_extend<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> lab<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">as</span> <span class="main">=</span> length <span class="free">bs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> lcd<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">cs</span> <span class="main">=</span> length <span class="free">ds</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nsab<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">bs</span> <span class="main">⟶</span> <span class="free">P</span> <span class="main">(</span><span class="free">as</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">bs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nscd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">ds</span> <span class="main">⟶</span> <span class="free">P</span> <span class="main">(</span><span class="free">cs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">ds</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">bs</span> <span class="main">@</span> <span class="free">ds</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">P</span> <span class="main">(</span><span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="free">cs</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">bs</span> <span class="main">@</span> <span class="free">ds</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
 <span class="keyword1"><span class="command">{</span></span>
   <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
   <span class="keyword3"><span class="command">assume</span></span> i_bd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">bs</span> <span class="main">@</span> <span class="free">ds</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="main">(</span><span class="free">as</span> <span class="main">@</span> <span class="free">cs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">bs</span> <span class="main">@</span> <span class="free">ds</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">as</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
     <span class="keyword1"><span class="command">with</span></span> nth_append <span class="keyword2"><span class="keyword">and</span></span> nsab <span class="keyword2"><span class="keyword">and</span></span> lab
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">next</span></span>
     <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> lab <span class="keyword2"><span class="keyword">and</span></span> lcd <span class="keyword2"><span class="keyword">and</span></span> i_bd <span class="keyword2"><span class="keyword">and</span></span> length_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">bs</span></span> <span class="quoted"><span class="free">ds</span></span><span class="main">]</span>
       <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> length <span class="free">as</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="free">cs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
      <span class="keyword1"><span class="command">with</span></span> False <span class="keyword2"><span class="keyword">and</span></span> nth_append<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> lab <span class="keyword2"><span class="keyword">and</span></span> lcd
       <span class="keyword2"><span class="keyword">and</span></span> nscd<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
   <span class="keyword1"><span class="command">qed</span></span>
 <span class="keyword1"><span class="command">}</span></span>
 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarify</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Extension of filter and partition to binary relations.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">filter2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'b</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> list <span class="main">×</span> <span class="tfree">'b</span> list<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">filter2</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">[]</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">filter2</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">filter2</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>
        <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> fst <span class="main">(</span><span class="free">filter2</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">#</span> snd <span class="main">(</span><span class="free">filter2</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span><span class="main">)</span>
        <span class="keyword1">else</span> <span class="free">filter2</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> filter2_length<span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="main">(</span>fst <span class="main">(</span>filter2 <span class="free">P</span> <span class="free">as</span> <span class="free">bs</span><span class="main">)</span><span class="main">)</span> <span class="main">≡</span> length <span class="main">(</span>snd <span class="main">(</span>filter2 <span class="free">P</span> <span class="free">as</span> <span class="free">bs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">as</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">bs</span></span><span class="main">)</span>
 <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command">next</span></span>
 <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">as</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> this
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">bs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
     <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">b</span> <span class="skolem">bs</span><span class="main">)</span>
     <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">a</span> <span class="skolem">b</span>"</span></span><span class="main">)</span>
       <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword2"><span class="keyword">and</span></span> IH <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command">next</span></span>
       <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword2"><span class="keyword">and</span></span> IH <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> filter2_sound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="main">(</span>fst <span class="main">(</span>filter2 <span class="free">P</span> <span class="free">as</span> <span class="free">bs</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">P</span> <span class="main">(</span>fst <span class="main">(</span>filter2 <span class="free">P</span> <span class="free">as</span> <span class="free">bs</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>filter2 <span class="free">P</span> <span class="free">as</span> <span class="free">bs</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">as</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">bs</span></span><span class="main">)</span>
 <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command">next</span></span>
 <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">as</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> this
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">bs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
     <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">b</span> <span class="skolem">bs</span><span class="main">)</span>
     <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">a</span> <span class="skolem">b</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
       <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword2"><span class="keyword">and</span></span> IH <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> True
       <span class="keyword1"><span class="command">{</span></span>
         <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
         <span class="keyword3"><span class="command">assume</span></span> i_bd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>fst <span class="main">(</span>filter2 <span class="free">P</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span><span class="skolem">b</span> <span class="main">#</span> <span class="skolem">bs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
         <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>fst <span class="main">(</span>filter2 <span class="free">P</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span><span class="skolem">b</span> <span class="main">#</span> <span class="skolem">bs</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>filter2 <span class="free">P</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">(</span><span class="skolem">b</span> <span class="main">#</span> <span class="skolem">bs</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>         <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> 0
           <span class="keyword1"><span class="command">with</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span>
           <span class="keyword1"><span class="command">with</span></span> i_bd <span class="keyword2"><span class="keyword">and</span></span> True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="main">(</span>fst <span class="main">(</span>filter2 <span class="free">P</span> <span class="skolem">as</span> <span class="skolem">bs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command">with</span></span> Suc <span class="keyword2"><span class="keyword">and</span></span> IH <span class="keyword2"><span class="keyword">and</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command">qed</span></span>
       <span class="keyword1"><span class="command">}</span></span>
       <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command">qed</span></span>
 <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">partition2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'b</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> list <span class="main">×</span> <span class="tfree">'b</span> list<span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span> list <span class="main">×</span> <span class="tfree">'b</span> list<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">partition2</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">(</span>filter2 <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span> <span class="main">,</span> <span class="main">(</span>filter2 <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> partition2_sound_P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="main">(</span>fst <span class="main">(</span>fst <span class="main">(</span>partition2 <span class="free">P</span> <span class="free">as</span> <span class="free">bs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
  <span class="free">P</span> <span class="main">(</span>fst <span class="main">(</span>fst <span class="main">(</span>partition2 <span class="free">P</span> <span class="free">as</span> <span class="free">bs</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>fst <span class="main">(</span>partition2 <span class="free">P</span> <span class="free">as</span> <span class="free">bs</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
 <span class="keyword1"><span class="command">from</span></span> filter2_sound <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> partition2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> partition2_sound_nP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="main">(</span>fst <span class="main">(</span>snd <span class="main">(</span>partition2 <span class="free">P</span> <span class="free">as</span> <span class="free">bs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
  <span class="main">¬</span> <span class="free">P</span> <span class="main">(</span>fst <span class="main">(</span>snd <span class="main">(</span>partition2 <span class="free">P</span> <span class="free">as</span> <span class="free">bs</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>snd <span class="main">(</span>partition2 <span class="free">P</span> <span class="free">as</span> <span class="free">bs</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
 <span class="keyword1"><span class="command">from</span></span> filter2_sound <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> partition2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Membership decision function that actually returns the
value of the index where the value can be found.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mem_idx</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> nat Option.option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mem_idx</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span>       <span class="main">=</span> None"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">mem_idx</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">then</span> Some <span class="main">0</span> <span class="keyword1">else</span> map_option Suc <span class="main">(</span><span class="free">mem_idx</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mem_idx_sound_output<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mem_idx <span class="free">x</span> <span class="free">as</span> <span class="main">=</span> Some <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">as</span> <span class="main">∧</span> <span class="free">as</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">as</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">as</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> this
   <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span><span class="main">)</span>
     <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> IH<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command">next</span></span>
     <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> neq_x_a <span class="main">=</span> this
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"mem_idx <span class="free">x</span> <span class="skolem">as</span>"</span></span><span class="main">)</span>
       <span class="keyword3"><span class="command">case</span></span> None <span class="keyword1"><span class="command">with</span></span> IH<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> neq_x_a <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command">next</span></span>
       <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">j</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> IH<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> neq_x_a <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> Suc <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">with</span></span> IH<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> Some <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
   <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mem_idx_sound_output2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mem_idx <span class="free">x</span> <span class="free">as</span> <span class="main">=</span> Some <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">⟶</span> <span class="free">as</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">≠</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">as</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">as</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> this
   <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span><span class="main">)</span>
     <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> IH <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command">next</span></span>
     <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> neq_x_a <span class="main">=</span> this
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"mem_idx <span class="free">x</span> <span class="skolem">as</span>"</span></span><span class="main">)</span>
       <span class="keyword3"><span class="command">case</span></span> None <span class="keyword1"><span class="command">with</span></span> IH<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> neq_x_a <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command">next</span></span>
       <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">j</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> IH<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> neq_x_a <span class="keyword1"><span class="command">have</span></span> eq_i_Sj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> Suc <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="keyword3"><span class="command">assume</span></span> k_bd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">≠</span> <span class="free">x</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword1"><span class="command">with</span></span> neq_x_a <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">l</span><span class="main">)</span>
            <span class="keyword1"><span class="command">with</span></span> k_bd <span class="keyword2"><span class="keyword">and</span></span> eq_i_Sj <span class="keyword1"><span class="command">have</span></span> l_bd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
            <span class="keyword1"><span class="command">with</span></span> IH<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> Some <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">!</span> <span class="skolem">l</span> <span class="main">≠</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">with</span></span> Suc <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
   <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mem_idx_sound<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">∈</span> set <span class="free">as</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> mem_idx <span class="free">x</span> <span class="free">as</span> <span class="main">=</span> Some <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">as</span></span><span class="main">)</span>
 <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
 <span class="keyword1"><span class="command">next</span></span>
 <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">as</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> this
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span><span class="main">)</span>
   <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command">next</span></span>
   <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">as</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">with</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="skolem">as</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command">with</span></span> IH <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> Some_i<span class="main">:</span> <span class="quoted"><span class="quoted">"mem_idx <span class="free">x</span> <span class="skolem">as</span> <span class="main">=</span> Some <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
       <span class="keyword1"><span class="command">with</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mem_idx <span class="free">x</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> mem_idx <span class="free">x</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> mem_idx <span class="free">x</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">i</span>"</span></span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> Some_i<span class="main">:</span> <span class="quoted"><span class="quoted">"mem_idx <span class="free">x</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
       <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="skolem">as</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
         <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword1"><span class="command">with</span></span> mem_idx_sound_output<span class="main">[</span><span class="operator">OF</span> Some_i<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command">next</span></span>
         <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> Some_i <span class="keyword2"><span class="keyword">and</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mem_idx <span class="free">x</span> <span class="skolem">as</span> <span class="main">=</span> Some <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> mem_idx <span class="free">x</span> <span class="skolem">as</span> <span class="main">=</span> Some <span class="bound">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">with</span></span> IH <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command">qed</span></span>
       <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">as</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mem_idx_sound2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">∉</span> set <span class="free">as</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>mem_idx <span class="free">x</span> <span class="free">as</span> <span class="main">=</span> None<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mem_idx_sound <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_list_replicate_mono<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w1</span> <span class="main">≤</span> <span class="main">(</span><span class="free">w2</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>replicate <span class="free">n</span> <span class="free">w1</span><span class="main">)</span> <span class="main">≤</span> sum_list <span class="main">(</span>replicate <span class="free">n</span> <span class="free">w2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">w1</span> <span class="main">≤</span> <span class="free">w2</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> all_gt_0_sum_list_map<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>nat<span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> x len
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="free">x</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> *<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"hd <span class="skolem">xs</span>"</span></span><span class="main">]</span> Cons<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> Cons<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">z</span> <span class="main">#</span> <span class="skolem">zs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="skolem">zs</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
      <span class="keyword1"><span class="command">with</span></span> x xs *<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> xs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> x this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span> <span class="bound">xs</span> <span class="main">.</span> distinct <span class="bound">xs</span> <span class="main">∧</span> set <span class="bound">xs</span> <span class="main">=</span> <span class="free">X</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="var">?S</span> <span class="free">X</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">with</span></span> finite_set <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="free">X</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> id <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> True<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">x</span> <span class="skolem">X</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span> card <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">X</span><span class="main">)</span><span class="main">}</span> <span class="main">×</span> <span class="var">?S</span> <span class="skolem">X</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> 2<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="var">?L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">xs</span><span class="main">)</span><span class="main">.</span> take <span class="bound">i</span> <span class="bound">xs</span> <span class="main">@</span> <span class="skolem">x</span> <span class="main">#</span> drop <span class="bound">i</span> <span class="bound">xs</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> finite_surj<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fin<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?f</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> <span class="var">?S</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">X</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> dis<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> set<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">=</span> insert <span class="skolem">x</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> distinct_card<span class="main">[</span><span class="operator">OF</span> dis<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">=</span> card <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> set<span class="main">[</span><span class="operator">unfolded</span> set_conv_nth<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> i <span class="keyword1"><span class="command">have</span></span> min<span class="main">:</span> <span class="quoted"><span class="quoted">"min <span class="main">(</span>length <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ys</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"take <span class="skolem">i</span> <span class="skolem">xs</span> <span class="main">@</span> drop <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> id_take_nth_drop<span class="main">[</span><span class="operator">OF</span> i<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> xsi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> take <span class="skolem">i</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">#</span> drop <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?f</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="var">?ys</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> split
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min x<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="var">?f</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="var">?ys</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> <span class="var">?f</span> <span class="main">`</span> <span class="var">?L</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> image_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> xs<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> SigmaI<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>card <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">X</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i<span class="main">[</span><span class="operator">unfolded</span> len<span class="main">]</span> set<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword1"><span class="command">from</span></span> dis xsi <span class="keyword1"><span class="command">have</span></span> disxsi<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>take <span class="skolem">i</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">#</span> drop <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">note</span></span> disxsi <span class="main">=</span> disxsi<span class="main">[</span><span class="operator">unfolded</span> distinct_append x<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> xys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> set <span class="var">?ys</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> disxsi <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> distinct_take_drop<span class="main">[</span><span class="operator">OF</span> dis i<span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> disys<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="var">?ys</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert <span class="skolem">x</span> <span class="main">(</span>set <span class="var">?ys</span><span class="main">)</span> <span class="main">=</span> set <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> xsi<span class="main">,</span> <span class="operator">of</span> <span class="quoted">set</span><span class="main">]</span> x <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"insert <span class="skolem">x</span> <span class="main">(</span>set <span class="var">?ys</span><span class="main">)</span> <span class="main">=</span> insert <span class="skolem">x</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> set <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> insert_eq_iff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> xys 2<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ys</span> <span class="main">∈</span> <span class="var">?S</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> disys <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_distinct_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span> <span class="bound">xs</span> <span class="main">.</span> distinct <span class="bound">xs</span> <span class="main">∧</span> set <span class="bound">xs</span> <span class="main">⊆</span> <span class="free">X</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="var">?S</span> <span class="free">X</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="main">{</span> <span class="bound">xs</span><span class="main">.</span> distinct <span class="bound">xs</span> <span class="main">∧</span> set <span class="bound">xs</span> <span class="main">=</span> <span class="bound">Y</span><span class="main">}</span> <span class="main">|</span> <span class="bound">Y</span><span class="main">.</span> <span class="bound">Y</span> <span class="main">⊆</span> <span class="free">X</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="free">X</span> <span class="main">=</span> <span class="main">⋃</span> <span class="var">?X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> id
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> finite_Union<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">M</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">∈</span> <span class="var">?X</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> finite_distinct <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">M</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_of_filter<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map_of <span class="main">[</span><span class="main">(</span><span class="bound">x'</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">←</span> <span class="free">ys</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x'</span><span class="main">]</span> <span class="free">x</span> <span class="main">=</span> map_of <span class="free">ys</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">xy</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> xy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xy</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x'</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">=</span> <span class="free">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> assms xy Cons<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> set_subset_insertI<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> set <span class="main">(</span>List.insert <span class="free">x</span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> set_removeAll_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>removeAll <span class="free">x</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⊆</span> set <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> map_of_append_Some<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_of <span class="free">xs</span> <span class="free">y</span> <span class="main">=</span> Some <span class="free">z</span> <span class="main">⟹</span> map_of <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="free">y</span> <span class="main">=</span> Some <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> map_of_append_None<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_of <span class="free">xs</span> <span class="free">y</span> <span class="main">=</span> None <span class="main">⟹</span> map_of <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="free">y</span> <span class="main">=</span> map_of <span class="free">ys</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Missing_Multiset">
<div class="head">
<h1>Theory Missing_Multiset</h1>
</div>
<pre class="source"><span class="comment1">(*  
    Author:      René Thiemann 
                 Akihisa Yamada
    License:     BSD
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Preliminaries›</span></span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Missing Multiset›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This theory provides some definitions and lemmas on multisets which we did not find in the 
  Isabelle distribution.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Missing_Multiset
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Multiset.html">HOL-Library.Multiset</a>"</span>
  <a href="Missing_List.html">Missing_List</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> remove_nth_soundness<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">as</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span>remove_nth <span class="free">n</span> <span class="free">as</span><span class="main">)</span> <span class="main">=</span> mset <span class="free">as</span> <span class="main">-</span> <span class="main">{#</span><span class="main">(</span><span class="free">as</span><span class="main">!</span><span class="free">n</span><span class="main">)</span><span class="main">#}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">as</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">as</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> remove_nth_def
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword1"><span class="command">have</span></span> n_bd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="skolem">as</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span>remove_nth <span class="skolem">n</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">=</span> mset <span class="skolem">as</span> <span class="main">-</span> <span class="main">{#</span><span class="skolem">as</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">#}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span>remove_nth <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">as</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> mset <span class="skolem">as</span> <span class="main">-</span> <span class="main">{#</span><span class="skolem">as</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">#}</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">a</span><span class="main">#}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">as</span><span class="main">!</span><span class="skolem">n</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> G <span class="keyword2"><span class="keyword">and</span></span> Suc <span class="keyword2"><span class="keyword">and</span></span> insert_DiffM2<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
        <span class="keyword2"><span class="keyword">and</span></span> insert_DiffM2<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="skolem">as</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">#}</span>"</span></span><span class="main">]</span>
        <span class="keyword2"><span class="keyword">and</span></span> nth_mem_mset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">as</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> n_bd
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">from</span></span> G <span class="keyword2"><span class="keyword">and</span></span> Suc <span class="keyword2"><span class="keyword">and</span></span> diff_union_swap<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">lemma</span></span> multiset_subset_insert<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">ps</span><span class="main">.</span> <span class="bound">ps</span> <span class="main">⊆#</span> add_mset <span class="free">x</span> <span class="free">xs</span><span class="main">}</span> <span class="main">=</span>
    <span class="main">{</span><span class="bound">ps</span><span class="main">.</span> <span class="bound">ps</span> <span class="main">⊆#</span> <span class="free">xs</span><span class="main">}</span> <span class="main">∪</span> add_mset <span class="free">x</span> <span class="main">`</span> <span class="main">{</span><span class="bound">ps</span><span class="main">.</span> <span class="bound">ps</span> <span class="main">⊆#</span> <span class="free">xs</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ps</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ps</span> <span class="main">∈</span> <span class="var">?l</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span> <span class="main">⊆#</span> <span class="free">xs</span> <span class="main">+</span> <span class="main">{#</span> <span class="free">x</span> <span class="main">#}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span> <span class="main">∈</span> <span class="var">?r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈#</span> <span class="skolem">ps</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qs</span></span> <span class="keyword2"><span class="keyword">where</span></span> ps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ps</span> <span class="main">=</span> <span class="skolem">qs</span> <span class="main">+</span> <span class="main">{#</span><span class="free">x</span><span class="main">#}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insert_DiffM2<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> ps mset_subset_eq_mono_add_right_cancel
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mset_subset_eq_insertD<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ps</span> <span class="main">⊆#</span> <span class="free">xs</span> <span class="main">+</span> <span class="main">{#</span><span class="free">x</span><span class="main">#}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span> <span class="main">⊆#</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_mset.inf.absorb_iff2 inter_add_left1<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> id <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ps</span> <span class="main">∈</span> <span class="var">?l</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ps</span> <span class="main">∈</span> <span class="var">?r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> multiset_of_subseqs<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="main">`</span> set <span class="main">(</span>subseqs <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span> <span class="bound">ps</span><span class="main">.</span> <span class="bound">ps</span> <span class="main">⊆#</span> mset <span class="free">xs</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="main">=</span> <span class="main">{</span><span class="bound">ps</span><span class="main">.</span> <span class="bound">ps</span> <span class="main">⊆#</span> mset <span class="skolem">xs</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span>add_mset <span class="skolem">x</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound">ps</span><span class="main">.</span> <span class="bound">ps</span> <span class="main">⊆#</span> mset <span class="skolem">xs</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> multiset_subset_insert<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> id Cons<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> UnCI image_iff mset.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> remove1_mset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> set <span class="free">vs</span> <span class="main">⟹</span> mset <span class="main">(</span>remove1 <span class="free">w</span> <span class="free">vs</span><span class="main">)</span> <span class="main">+</span> <span class="main">{#</span><span class="free">w</span><span class="main">#}</span> <span class="main">=</span> mset <span class="free">vs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">vs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fold_remove1_mset<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="free">ws</span> <span class="main">⊆#</span> mset <span class="free">vs</span> <span class="main">⟹</span> mset <span class="main">(</span>fold remove1 <span class="free">ws</span> <span class="free">vs</span><span class="main">)</span> <span class="main">+</span> mset <span class="free">ws</span> <span class="main">=</span> mset <span class="free">vs</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ws</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">vs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">w</span> <span class="skolem">ws</span> <span class="skolem">vs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> set <span class="skolem">vs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> set_mset_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> remove1_mset<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> vs<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="skolem">vs</span> <span class="main">=</span> mset <span class="main">(</span>remove1 <span class="skolem">w</span> <span class="skolem">vs</span><span class="main">)</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">w</span><span class="main">#}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> vs<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mset <span class="skolem">ws</span> <span class="main">⊆#</span> mset <span class="main">(</span>remove1 <span class="skolem">w</span> <span class="skolem">vs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> vs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> subseqs_sub_mset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ws</span> <span class="main">∈</span> set <span class="main">(</span>subseqs <span class="free">vs</span><span class="main">)</span> <span class="main">⟹</span> mset <span class="free">ws</span> <span class="main">⊆#</span> mset <span class="free">vs</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">vs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ws</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">v</span> <span class="skolem">vs</span> <span class="skolem">Ws</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> mem <span class="main">=</span> Cons<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> Cons<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">Ws</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">w</span> <span class="skolem">ws</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="skolem">w</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">from</span></span> mem Cons <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ws</span> <span class="main">∈</span> set <span class="main">(</span>subseqs <span class="skolem">vs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def Cons_in_subseqsD<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">ws</span></span> <span class="quoted"><span class="skolem">vs</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> IH<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> Cons True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> mem Cons <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ws</span> <span class="main">∈</span> set <span class="main">(</span>subseqs <span class="skolem">vs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def Cons_in_subseqsD<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">ws</span></span> <span class="quoted"><span class="skolem">vs</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>      
      <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> mset_subset_eq_count<span class="main">[</span><span class="operator">OF</span> IH<span class="main"><span class="main">[</span></span><span class="operator">OF</span> this<span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">with</span></span> IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">v</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mset_subset_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">linarith</span><span class="main">)</span> 
    <span class="keyword1"><span class="command">qed</span></span> 
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> filter_mset_inequality<span class="main">:</span> <span class="quoted"><span class="quoted">"filter_mset <span class="free">f</span> <span class="free">xs</span> <span class="main">≠</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">xs</span><span class="main">.</span> <span class="main">¬</span> <span class="free">f</span> <span class="bound">x</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Precomputation">
<div class="head">
<h1>Theory Precomputation</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span> <span class="plain_text">Precomputation</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This theory contains precomputation functions, which take another function $f$ and a 
  finite set of inputs, and provide the same function $f$ as output, except that now all
  values $f\ i$ are precomputed if $i$ is contained in the set of finite inputs.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Precomputation
<span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="../Containers/RBT_Set2.html">Containers.RBT_Set2</a>
  <span class="quoted">"<a href="../../HOL/HOL-Library/RBT_Mapping.html">HOL-Library.RBT_Mapping</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> lookup_tabulate<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> Mapping.lookup <span class="main">(</span>Mapping.tabulate <span class="free">xs</span> <span class="free">f</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_of_map_Pair_key<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lookup_tabulate2<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="main">(</span>Mapping.tabulate <span class="free">xs</span> <span class="free">f</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">y</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">metis</span> map_of_map_Pair_key option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> option.sel<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">memo_int</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> int <span class="main">⇒</span> <span class="main">(</span>int <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>int <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">memo_int</span> <span class="free"><span class="bound"><span class="entity">low</span></span></span> <span class="free"><span class="bound"><span class="entity">up</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="keyword1">let</span> <span class="bound">m</span> <span class="main">=</span> Mapping.tabulate <span class="main">[</span><span class="free"><span class="bound"><span class="entity">low</span></span></span> <span class="main">..</span> <span class="free"><span class="bound"><span class="entity">up</span></span></span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>
     <span class="keyword1">in</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">≥</span> <span class="free"><span class="bound"><span class="entity">low</span></span></span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">up</span></span></span> <span class="keyword1">then</span> the <span class="main">(</span>Mapping.lookup <span class="bound">m</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> memo_int<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"memo_int <span class="free">low</span> <span class="free">up</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"memo_int <span class="free">low</span> <span class="free">up</span> <span class="free">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≥</span> <span class="free">low</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="free">up</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> memo_int_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">from</span></span> True <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">[</span><span class="free">low</span> <span class="main">..</span> <span class="free">up</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> True lookup_tabulate<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> memo_int_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">memo_nat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">memo_nat</span> <span class="free"><span class="bound"><span class="entity">low</span></span></span> <span class="free"><span class="bound"><span class="entity">up</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="keyword1">let</span> <span class="bound">m</span> <span class="main">=</span> Mapping.tabulate <span class="main">[</span><span class="free"><span class="bound"><span class="entity">low</span></span></span> <span class="main">..&lt;</span> <span class="free"><span class="bound"><span class="entity">up</span></span></span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>
     <span class="keyword1">in</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">≥</span> <span class="free"><span class="bound"><span class="entity">low</span></span></span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">up</span></span></span> <span class="keyword1">then</span> the <span class="main">(</span>Mapping.lookup <span class="bound">m</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> memo_nat<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"memo_nat <span class="free">low</span> <span class="free">up</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"memo_nat <span class="free">low</span> <span class="free">up</span> <span class="free">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≥</span> <span class="free">low</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">up</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> memo_nat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">from</span></span> True <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">[</span><span class="free">low</span> <span class="main">..&lt;</span> <span class="free">up</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> True lookup_tabulate<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> memo_nat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">memo</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">memo</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="keyword1">let</span> <span class="bound">m</span> <span class="main">=</span> Mapping.tabulate <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>
     <span class="keyword1">in</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="bound">m</span> <span class="bound">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="main">|</span> Some <span class="bound">y</span> <span class="main">⇒</span> <span class="bound">y</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> memo<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"memo <span class="free">xs</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"memo <span class="free">xs</span> <span class="free">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="main">(</span>Mapping.tabulate <span class="free">xs</span> <span class="free">f</span><span class="main">)</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> memo_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">y</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> lookup_tabulate2<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> memo_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Order_Polynomial">
<div class="head">
<h1>Theory Order_Polynomial</h1>
</div>
<pre class="source"><span class="comment1">(*  
    Author:      René Thiemann 
                 Akihisa Yamada
    License:     BSD
*)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Order of Polynomial Roots›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We extend the collection of results on the order of roots of polynomials.
  Moreover, we provide code-equations to compute the order for a given root and
polynomial.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Order_Polynomial
<span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="../Polynomial_Interpolation/Missing_Polynomial.html">Polynomial_Interpolation.Missing_Polynomial</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> order_linear<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"order <span class="free">a</span> <span class="main">[:</span><span class="main">-</span> <span class="free">a</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> order_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Least_equality<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> notI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">[:</span><span class="main">-</span> <span class="free">a</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="main">^</span> Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="keyword1">dvd</span> <span class="main">[:</span><span class="main">-</span> <span class="free">a</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> dvd_imp_degree_le<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">[:</span><span class="main">-</span> <span class="free">a</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="main">^</span> Suc <span class="skolem">n</span> <span class="keyword1">dvd</span> <span class="main">[:</span><span class="main">-</span> <span class="free">a</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">0</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">declare</span></span> order_power_n_n<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> linear_power_nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[:</span> <span class="free">a</span><span class="main">,</span> <span class="main">1</span> <span class="main">:]</span> <span class="main">^</span> <span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">[:</span> <span class="free">a</span><span class="main">,</span> <span class="main">1</span> <span class="main">:]</span><span class="main">^</span><span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted">degree</span><span class="main">,</span> <span class="operator">unfolded</span> degree_linear_power<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> order_linear_power'<span class="main">:</span> <span class="quoted"><span class="quoted">"order <span class="free">a</span> <span class="main">(</span><span class="main">[:</span> <span class="free">b</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span><span class="main">^</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="main">=</span> <span class="main">-</span><span class="free">a</span> <span class="keyword1">then</span> Suc <span class="free">n</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="main">-</span><span class="free">a</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> True order_power_n_n <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">[:</span> <span class="free">b</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span><span class="main">^</span>Suc <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> linear_power_nonzero <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">a</span><span class="main">←</span> replicate <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">b</span><span class="main">.</span> <span class="main">[:</span><span class="bound">a</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"order <span class="free">a</span> <span class="var">?p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> ord<span class="main">:</span> <span class="quoted"><span class="quoted">"order <span class="free">a</span> <span class="var">?p</span> <span class="main">=</span> Suc <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"order <span class="free">a</span> <span class="var">?p</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> order<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="var">?p</span> <span class="main">≠</span> <span class="main">0</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">a</span></span><span class="main">,</span> <span class="operator">unfolded</span> ord<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[:</span><span class="main">-</span> <span class="free">a</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="main">^</span> Suc <span class="skolem">m</span> <span class="keyword1">dvd</span> <span class="var">?p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>        
    <span class="keyword1"><span class="command">from</span></span> poly_linear_exp_linear_factors<span class="main">[</span><span class="operator">OF</span> dvd<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> p<span class="main"><span class="main">]</span></span><span class="main">]</span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"order <span class="free">a</span> <span class="var">?p</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> order_linear_power<span class="main">:</span> <span class="quoted"><span class="quoted">"order <span class="free">a</span> <span class="main">(</span><span class="main">[:</span> <span class="free">b</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span><span class="main">^</span><span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="main">=</span> <span class="main">-</span><span class="free">a</span> <span class="keyword1">then</span> <span class="free">n</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> Suc order_linear_power' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">lemma</span></span> order_linear'<span class="main">:</span> <span class="quoted"><span class="quoted">"order <span class="free">a</span> <span class="main">[:</span> <span class="free">b</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="main">=</span> <span class="main">-</span><span class="free">a</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> order_linear_power'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> degree_div_less<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>field poly<span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="keyword1">dvd</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> deg<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">r</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span><span class="free">p</span> <span class="keyword1">div</span> <span class="free">r</span><span class="main">)</span> <span class="main">&lt;</span> degree <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> dvd <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> prq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="free">r</span> <span class="main">*</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">=</span> degree <span class="free">r</span> <span class="main">+</span> degree <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> prq
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> degree_mult_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> p prq<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> deg <span class="keyword1"><span class="command">have</span></span> deg<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">q</span> <span class="main">&lt;</span> degree <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> prq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> <span class="free">p</span> <span class="keyword1">div</span> <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> deg p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> deg <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> order_sum_degree<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span><span class="main">.</span> order <span class="bound">a</span> <span class="free">p</span><span class="main">)</span> <span class="main">{</span> <span class="bound">a</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">a</span> <span class="main">=</span> <span class="main">0</span> <span class="main">}</span> <span class="main">≤</span> degree <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> degree <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> n_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>›</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>0 <span class="skolem">p</span><span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> coeff <span class="skolem">p</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> 0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="main">[:</span> <span class="skolem">a</span> <span class="main">:]</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> a_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> degree_0_id<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> 0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">m</span> <span class="skolem">p</span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> order <span class="main">=</span> order<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≠</span> <span class="main">0</span>›</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">a</span><span class="main">.</span> poly <span class="skolem">p</span> <span class="bound">a</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> root<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="skolem">p</span> <span class="skolem">a</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> order_root<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span> Suc <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> orda<span class="main">:</span> <span class="quoted"><span class="quoted">"order <span class="skolem">a</span> <span class="skolem">p</span> <span class="main">=</span> Suc <span class="skolem">n</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"order <span class="skolem">a</span> <span class="skolem">p</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">[:</span> <span class="main">-</span><span class="skolem">a</span><span class="main">,</span> <span class="main">1</span> <span class="main">:]</span> <span class="main">^</span> Suc <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> order_decomp<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≠</span> <span class="main">0</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">,</span> <span class="operator">unfolded</span> orda<span class="main">]</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="var">?a</span> <span class="main">*</span> <span class="skolem">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ndvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">[:</span><span class="main">-</span> <span class="skolem">a</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="keyword1">dvd</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≠</span> <span class="main">0</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> p<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> nz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> deg<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">p</span> <span class="main">=</span> degree <span class="var">?a</span> <span class="main">+</span> degree <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> p
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> degree_mult_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> ord<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span><span class="main">.</span> order <span class="bound">a</span> <span class="skolem">p</span> <span class="main">=</span> order <span class="bound">a</span> <span class="var">?a</span> <span class="main">+</span> order <span class="bound">a</span> <span class="skolem">q</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> p
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> order_mult<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> nz<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> roots<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="bound">a</span><span class="main">.</span> poly <span class="skolem">p</span> <span class="bound">a</span> <span class="main">=</span> <span class="main">0</span> <span class="main">}</span> <span class="main">=</span> insert <span class="skolem">a</span> <span class="main">(</span><span class="main">{</span> <span class="bound">a</span><span class="main">.</span> poly <span class="skolem">q</span> <span class="bound">a</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> root
        <span class="keyword1"><span class="command">unfolding</span></span> p poly_mult <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">a</span><span class="main">.</span> poly <span class="skolem">q</span> <span class="bound">a</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> poly_roots_finite<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">q</span> <span class="main">≠</span> <span class="main">0</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span> <span class="main">=</span> order <span class="skolem">a</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> orda <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Suc <span class="skolem">n</span> <span class="main">+</span> order <span class="skolem">a</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ord order_linear_power' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"order <span class="skolem">a</span> <span class="skolem">q</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> order_root<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">q</span></span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">q</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> qa<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="skolem">q</span> <span class="skolem">a</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span><span class="main">{</span><span class="bound">a</span><span class="main">.</span> poly <span class="skolem">q</span> <span class="bound">a</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span><span class="main">.</span> order <span class="bound">a</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span><span class="main">{</span><span class="bound">a</span><span class="main">.</span> poly <span class="skolem">q</span> <span class="bound">a</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span><span class="main">.</span> order <span class="bound">a</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> poly <span class="skolem">q</span> <span class="bound">a</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≠</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"order <span class="skolem">b</span> <span class="var">?a</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> order_linear_power' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"order <span class="skolem">b</span> <span class="skolem">p</span> <span class="main">=</span> order <span class="skolem">b</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ord <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span><span class="main">{</span><span class="bound">a</span><span class="main">.</span> poly <span class="skolem">q</span> <span class="bound">a</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span><span class="main">.</span> order <span class="bound">a</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> qa <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> degree <span class="skolem">q</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Suc<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="skolem">q</span> <span class="main">≠</span> <span class="main">0</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> 
        <span class="operator">insert</span> deg<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> degree_linear_power<span class="main"><span class="main">]</span></span> Suc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span><span class="main">{</span><span class="bound">a</span><span class="main">.</span> poly <span class="skolem">q</span> <span class="bound">a</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span><span class="main">.</span> order <span class="bound">a</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">≤</span> degree <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>      
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> roots deg <span class="keyword1"><span class="command">using</span></span> fin
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.insert<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> degree_linear_power<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> orda<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> order_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"order <span class="main">(</span><span class="free">a</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>idom_divide<span class="main">)</span> <span class="free">p</span> <span class="main">=</span> 
  <span class="main">(</span><span class="keyword1">if</span> <span class="free">p</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> Code.abort <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''order of polynomial 0 undefined''</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> order <span class="free">a</span> <span class="free">p</span><span class="main">)</span> 
   <span class="keyword1">else</span> <span class="keyword1">if</span> poly <span class="free">p</span> <span class="free">a</span> <span class="main">≠</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> Suc <span class="main">(</span>order <span class="free">a</span> <span class="main">(</span><span class="free">p</span> <span class="keyword1">div</span> <span class="main">[:</span> <span class="main">-</span><span class="free">a</span><span class="main">,</span> <span class="main">1</span> <span class="main">:]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> p <span class="main">=</span> this
  <span class="keyword1"><span class="command">note</span></span> order <span class="main">=</span> order<span class="main">[</span><span class="operator">OF</span> p<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"poly <span class="free">p</span> <span class="free">a</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> order_root<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span> p <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> ord<span class="main">:</span> <span class="quoted"><span class="quoted">"order <span class="free">a</span> <span class="free">p</span> <span class="main">=</span> Suc <span class="skolem">n</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"order <span class="free">a</span> <span class="free">p</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[:</span> <span class="main">-</span><span class="free">a</span><span class="main">,</span> <span class="main">1</span> <span class="main">:]</span> <span class="keyword1">dvd</span> <span class="free">p</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> True poly_eq_0_iff_dvd <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">[:</span> <span class="main">-</span><span class="free">a</span><span class="main">,</span> <span class="main">1</span> <span class="main">:]</span> <span class="main">*</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> ord<span class="main">:</span> <span class="quoted"><span class="quoted">"order <span class="free">a</span> <span class="free">p</span> <span class="main">=</span> order <span class="free">a</span> <span class="main">[:</span> <span class="main">-</span><span class="free">a</span><span class="main">,</span> <span class="main">1</span> <span class="main">:]</span> <span class="main">+</span> order <span class="free">a</span> <span class="skolem">q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> p False order_mult<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[:</span> <span class="main">-</span><span class="free">a</span><span class="main">,</span> <span class="main">1</span> <span class="main">:]</span>"</span></span> <span class="quoted"><span class="skolem">q</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">div</span> <span class="main">[:</span> <span class="main">-</span><span class="free">a</span><span class="main">,</span> <span class="main">1</span> <span class="main">:]</span> <span class="main">=</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False p 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult_zero_left nonzero_mult_div_cancel_left<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> ord q <span class="keyword1"><span class="command">using</span></span> False True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> order_root<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span> p <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Explicit_Roots">
<div class="head">
<h1>Theory Explicit_Roots</h1>
</div>
<pre class="source"><span class="comment1">(*  
    Author:      René Thiemann 
                 Akihisa Yamada
    License:     BSD
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Explicit Formulas for Roots›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We provide algorithms which use the explicit formulas to 
  compute the roots of polynomials of degree up to 2. We also define the formula for 
  polynomials of degree 3, but did not (yet) prove anything about it.›</span></span>  

<span class="keyword1"><span class="command">theory</span></span> Explicit_Roots
<span class="keyword2"><span class="keyword">imports</span></span>   
  <a href="../Polynomial_Interpolation/Missing_Polynomial.html">Polynomial_Interpolation.Missing_Polynomial</a>
  <a href="../Sqrt_Babylonian/Sqrt_Babylonian.html">Sqrt_Babylonian.Sqrt_Babylonian</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> roots0<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p0<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> degree0_coeffs<span class="main">[</span><span class="operator">OF</span> p0<span class="main">]</span> p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">roots1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> field poly <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">roots1</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">-</span> coeff <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">0</span> <span class="main">/</span> coeff <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> roots1<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> field poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p1<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span>roots1 <span class="free">p</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> degree1_coeffs<span class="main">[</span><span class="operator">OF</span> p1<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> roots1_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_eq_0_iff nonzero_neg_divide_eq_eq2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> roots2<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> field_char_0 poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">[:</span> <span class="free">c</span><span class="main">,</span> <span class="free">b</span><span class="main">,</span> <span class="free">a</span> <span class="main">:]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span> <span class="main">-</span> <span class="main">(</span> <span class="free">b</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="bound">e</span> <span class="main">|</span> <span class="bound">e</span><span class="main">.</span> <span class="bound">e</span><span class="main">^</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">(</span> <span class="free">b</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="free">c</span><span class="main">/</span><span class="free">a</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">b2a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b2a</span> <span class="main">=</span> <span class="free">b</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">∈</span> <span class="var">?l</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">*</span> <span class="skolem">x</span> <span class="main">*</span> <span class="free">a</span> <span class="main">+</span> <span class="skolem">x</span> <span class="main">*</span> <span class="free">b</span> <span class="main">+</span> <span class="free">c</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> p2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">*</span> <span class="skolem">x</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">x</span> <span class="main">*</span> <span class="skolem">b2a</span><span class="main">)</span> <span class="main">+</span> <span class="free">c</span><span class="main">/</span><span class="free">a</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> b2a_def <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">*</span> <span class="skolem">x</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">x</span> <span class="main">*</span> <span class="skolem">b2a</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">*</span> <span class="skolem">x</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">x</span> <span class="main">*</span> <span class="skolem">b2a</span> <span class="main">+</span> <span class="skolem">b2a</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">b2a</span><span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">+</span> <span class="skolem">b2a</span><span class="main">)</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">-</span> <span class="skolem">b2a</span> <span class="main">^</span> <span class="numeral">2</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> power2_eq_square<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">…</span> <span class="main">+</span> <span class="free">c</span> <span class="main">/</span> <span class="free">a</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">+</span> <span class="skolem">b2a</span><span class="main">)</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">=</span> <span class="skolem">b2a</span><span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="free">c</span><span class="main">/</span><span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">algebra</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">∈</span> <span class="var">?r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> b2a_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">∈</span> <span class="var">?l</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">∈</span> <span class="var">?r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">croots2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"complex poly <span class="main">⇒</span> complex list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">croots2</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">a</span> <span class="main">=</span> coeff <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="numeral">2</span><span class="main">;</span> <span class="bound">b</span> <span class="main">=</span> coeff <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">1</span><span class="main">;</span> <span class="bound">c</span> <span class="main">=</span> coeff <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">0</span><span class="main">;</span> <span class="bound">b2a</span> <span class="main">=</span> <span class="bound">b</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="bound">a</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">bac</span> <span class="main">=</span> <span class="bound">b2a</span><span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="bound">c</span><span class="main">/</span><span class="bound">a</span><span class="main">;</span>
    <span class="bound">e</span> <span class="main">=</span> csqrt <span class="bound">bac</span> 
    <span class="keyword1">in</span>
     remdups <span class="main">[</span><span class="main">-</span> <span class="bound">b2a</span> <span class="main">+</span> <span class="bound">e</span><span class="main">,</span> <span class="main">-</span> <span class="bound">b2a</span> <span class="main">-</span> <span class="bound">e</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">complex_rat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"complex <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">complex_rat</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span>Re <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> <span class="main">ℚ</span> <span class="main">∧</span> Im <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> <span class="main">ℚ</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> croots2<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span> set <span class="main">(</span>croots2 <span class="free">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> degree2_coeffs<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">c</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">[:</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">b</span><span class="main">,</span> <span class="skolem">a</span><span class="main">:]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> main <span class="main">=</span> roots2<span class="main">[</span><span class="operator">OF</span> p a<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">=</span> Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> coeff<span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="free">p</span> <span class="numeral">2</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"coeff <span class="free">p</span> <span class="main">1</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"coeff <span class="free">p</span> <span class="main">0</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> 2<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b2a</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">a</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">b2a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b2a</span> <span class="main">=</span> <span class="var">?b2a</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?bac</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">b2a</span><span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="skolem">c</span><span class="main">/</span><span class="skolem">a</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">bac</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bac</span> <span class="main">=</span> <span class="var">?bac</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> roots<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>croots2 <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">-</span> <span class="skolem">b2a</span> <span class="main">+</span> csqrt <span class="skolem">bac</span><span class="main">,</span> <span class="main">-</span> <span class="skolem">b2a</span> <span class="main">-</span> csqrt <span class="skolem">bac</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> croots2_def Let_def coeff b2a_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> bac_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> roots main b2a_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> bac_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> power2_eq_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rroots2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly <span class="main">⇒</span> real list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rroots2</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">a</span> <span class="main">=</span> coeff <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="numeral">2</span><span class="main">;</span> <span class="bound">b</span> <span class="main">=</span> coeff <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">1</span><span class="main">;</span> <span class="bound">c</span> <span class="main">=</span> coeff <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">0</span><span class="main">;</span> <span class="bound">b2a</span> <span class="main">=</span> <span class="bound">b</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="bound">a</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">bac</span> <span class="main">=</span> <span class="bound">b2a</span><span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="bound">c</span><span class="main">/</span><span class="bound">a</span>
  <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">bac</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">[</span><span class="main">-</span> <span class="bound">b2a</span><span class="main">]</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">bac</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">[]</span>
    <span class="keyword1">else</span> <span class="keyword1">let</span> <span class="bound">e</span> <span class="main">=</span> sqrt <span class="bound">bac</span>
    <span class="keyword1">in</span>
     <span class="main">[</span><span class="main">-</span> <span class="bound">b2a</span> <span class="main">+</span> <span class="bound">e</span><span class="main">,</span> <span class="main">-</span> <span class="bound">b2a</span> <span class="main">-</span> <span class="bound">e</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rat_roots2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat poly <span class="main">⇒</span> rat list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rat_roots2</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">a</span> <span class="main">=</span> coeff <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="numeral">2</span><span class="main">;</span> <span class="bound">b</span> <span class="main">=</span> coeff <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">1</span><span class="main">;</span> <span class="bound">c</span> <span class="main">=</span> coeff <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">0</span><span class="main">;</span> <span class="bound">b2a</span> <span class="main">=</span> <span class="bound">b</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="bound">a</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">bac</span> <span class="main">=</span> <span class="bound">b2a</span><span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="bound">c</span><span class="main">/</span><span class="bound">a</span>
  <span class="keyword1">in</span> map <span class="main">(</span><span class="main">λ</span> <span class="bound">e</span><span class="main">.</span> <span class="main">-</span> <span class="bound">b2a</span> <span class="main">+</span> <span class="bound">e</span><span class="main">)</span> <span class="main">(</span>sqrt_rat <span class="bound">bac</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rroots2<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span> set <span class="main">(</span>rroots2 <span class="free">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> degree2_coeffs<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">c</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">[:</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">b</span><span class="main">,</span> <span class="skolem">a</span><span class="main">:]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> main <span class="main">=</span> roots2<span class="main">[</span><span class="operator">OF</span> p a<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">=</span> Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> coeff<span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="free">p</span> <span class="numeral">2</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"coeff <span class="free">p</span> <span class="main">1</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"coeff <span class="free">p</span> <span class="main">0</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> 2<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b2a</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">a</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">b2a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b2a</span> <span class="main">=</span> <span class="var">?b2a</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?bac</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">b2a</span><span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="skolem">c</span><span class="main">/</span><span class="skolem">a</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">bac</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bac</span> <span class="main">=</span> <span class="var">?bac</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> roots<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>rroots2 <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">bac</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">{}</span> <span class="keyword1">else</span> <span class="main">{</span><span class="main">-</span> <span class="skolem">b2a</span> <span class="main">+</span> sqrt <span class="skolem">bac</span><span class="main">,</span> <span class="main">-</span> <span class="skolem">b2a</span> <span class="main">-</span> sqrt <span class="skolem">bac</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rroots2_def Let_def coeff b2a_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> bac_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> roots main b2a_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> bac_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rat_roots2<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span> set <span class="main">(</span>rat_roots2 <span class="free">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> degree2_coeffs<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">c</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">[:</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">b</span><span class="main">,</span> <span class="skolem">a</span><span class="main">:]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> main <span class="main">=</span> roots2<span class="main">[</span><span class="operator">OF</span> p a<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">=</span> Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> coeff<span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="free">p</span> <span class="numeral">2</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"coeff <span class="free">p</span> <span class="main">1</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"coeff <span class="free">p</span> <span class="main">0</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> 2<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b2a</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">a</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">b2a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b2a</span> <span class="main">=</span> <span class="var">?b2a</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?bac</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">b2a</span><span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="skolem">c</span><span class="main">/</span><span class="skolem">a</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">bac</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bac</span> <span class="main">=</span> <span class="var">?bac</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> roots<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rat_roots2 <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">e</span><span class="main">.</span> <span class="main">-</span><span class="skolem">b2a</span> <span class="main">+</span> <span class="bound">e</span><span class="main">)</span> <span class="main">(</span>sqrt_rat <span class="skolem">bac</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rat_roots2_def Let_def coeff b2a_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> bac_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> roots main b2a_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> bac_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> power2_eq_square<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Determinining roots of complex polynomials of degree up to 2.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">croots</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"complex poly <span class="main">⇒</span> complex list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">croots</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> degree <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">&gt;</span> <span class="numeral">2</span> <span class="keyword1">then</span> <span class="main">[]</span> 
    <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">if</span> degree <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">[]</span> <span class="keyword1">else</span> <span class="keyword1">if</span> degree <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">[</span>roots1 <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">]</span>
    <span class="keyword1">else</span> croots2 <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> croots<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">≤</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>croots <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> croots_def
  <span class="keyword1"><span class="command">using</span></span> roots0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> roots1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> croots2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Determinining roots of real polynomials of degree up to 2.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rroots</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly <span class="main">⇒</span> real list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rroots</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> degree <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">&gt;</span> <span class="numeral">2</span> <span class="keyword1">then</span> <span class="main">[]</span> 
    <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">if</span> degree <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">[]</span> <span class="keyword1">else</span> <span class="keyword1">if</span> degree <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">[</span>roots1 <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">]</span>
    <span class="keyword1">else</span> rroots2 <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rroots<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">≤</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>rroots <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> rroots_def
  <span class="keyword1"><span class="command">using</span></span> roots0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> roots1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> rroots2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Although there is a closed form for cubic roots, 
  which is specified below, we did not yet integrate it into the
 <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> croots<span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> rroots<span class="antiquote"><span class="antiquote">}</span></span></span></span> algorithms.
 One obstracle is that for complex numbers, the cubic root is not
 even defined. Therefore, we also did not proof soundness of the croots3 algorithm.›</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">croot</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> complex <span class="main">⇒</span> complex"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">croots3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"complex poly <span class="main">⇒</span> complex <span class="main">×</span> complex <span class="main">×</span> complex <span class="main">×</span> complex"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">croots3</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">a</span> <span class="main">=</span> coeff <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="numeral">3</span><span class="main">;</span> <span class="bound">b</span> <span class="main">=</span> coeff <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="numeral">2</span><span class="main">;</span> <span class="bound">c</span> <span class="main">=</span> coeff <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">1</span><span class="main">;</span> <span class="bound">d</span> <span class="main">=</span> coeff <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">0</span><span class="main">;</span> 
    <span class="bound">Δ<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="bound">b</span><span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="numeral">3</span> <span class="main">*</span> <span class="bound">a</span> <span class="main">*</span> <span class="bound">c</span><span class="main">;</span>
    <span class="bound">Δ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="bound">b</span><span class="main">^</span><span class="numeral">3</span> <span class="main">-</span> <span class="numeral">9</span> <span class="main">*</span> <span class="bound">a</span> <span class="main">*</span> <span class="bound">b</span> <span class="main">*</span> <span class="bound">c</span> <span class="main">+</span> <span class="numeral">27</span> <span class="main">*</span> <span class="bound">a</span><span class="main">^</span><span class="numeral">2</span> <span class="main">*</span> <span class="bound">d</span><span class="main">;</span>
    <span class="bound">C</span> <span class="main">=</span> <span class="free">croot</span> <span class="numeral">3</span> <span class="main">(</span><span class="main">(</span><span class="bound">Δ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">+</span> csqrt <span class="main">(</span> <span class="bound">Δ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="numeral">4</span> <span class="main">*</span> <span class="bound">Δ<span class="hidden">⇩</span><sub>0</sub></span><span class="main">^</span><span class="numeral">3</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">1</span><span class="main">;</span>
    <span class="bound">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span> <span class="main">+</span> <span class="keyword1">𝗂</span> <span class="main">*</span> csqrt <span class="numeral">3</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">;</span>
    <span class="bound">u<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">=</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span> <span class="main">-</span> <span class="keyword1">𝗂</span> <span class="main">*</span> csqrt <span class="numeral">3</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">;</span>
    <span class="bound">x<span class="hidden">⇩</span><sub>k</sub></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">u</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">*</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="bound">b</span> <span class="main">+</span> <span class="bound">u</span> <span class="main">*</span> <span class="bound">C</span> <span class="main">+</span> <span class="bound">Δ<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">/</span> <span class="main">(</span><span class="bound">u</span> <span class="main">*</span> <span class="bound">C</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">in</span>
     <span class="main">(</span><span class="bound">x<span class="hidden">⇩</span><sub>k</sub></span> <span class="bound">u<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">x<span class="hidden">⇩</span><sub>k</sub></span> <span class="bound">u<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="bound">x<span class="hidden">⇩</span><sub>k</sub></span> <span class="bound">u<span class="hidden">⇩</span><sub>3</sub></span><span class="main">,</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Dvd_Int_Poly">
<div class="head">
<h1>Theory Dvd_Int_Poly</h1>
</div>
<pre class="source"><span class="comment1">(*  
    Author:      Sebastiaan Joosten
                 René Thiemann                  
    License:     BSD
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Division of Polynomials over Integers›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This theory contains an algorithm to efficiently compute
  divisibility of two integer polynomials.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Dvd_Int_Poly
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../Polynomial_Interpolation/Ring_Hom_Poly.html">Polynomial_Interpolation.Ring_Hom_Poly</a>
  <a href="../Polynomial_Interpolation/Divmod_Int.html">Polynomial_Interpolation.Divmod_Int</a>
  <a href="../Polynomial_Interpolation/Is_Rat_To_Rat.html">Polynomial_Interpolation.Is_Rat_To_Rat</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">div_int_poly_step</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int poly <span class="main">⇒</span> int <span class="main">⇒</span> <span class="main">(</span>int poly <span class="main">×</span> int poly<span class="main">)</span> option <span class="main">⇒</span> <span class="main">(</span>int poly <span class="main">×</span> int poly<span class="main">)</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">div_int_poly_step</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">sro</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">sro</span> <span class="keyword1">of</span> Some <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">⇒</span>
      <span class="keyword1">let</span> <span class="bound">ar</span> <span class="main">=</span> pCons <span class="bound">a</span> <span class="bound">r</span><span class="main">;</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">=</span> divmod_int <span class="main">(</span>coeff <span class="bound">ar</span> <span class="main">(</span>degree <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>coeff <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">(</span>degree <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span><span class="main">)</span>
      <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">m</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> Some <span class="main">(</span>pCons <span class="bound">b</span> <span class="bound">s</span><span class="main">,</span> <span class="bound">ar</span> <span class="main">-</span> smult <span class="bound">b</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="keyword1">else</span> None <span class="main">|</span> None <span class="main">⇒</span> None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> div_int_poly_step_def<span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">div_mod_int_poly</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int poly <span class="main">⇒</span> int poly <span class="main">⇒</span> <span class="main">(</span>int poly <span class="main">×</span> int poly<span class="main">)</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">div_mod_int_poly</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> None
    <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">n</span> <span class="main">=</span> degree <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">;</span> <span class="bound">qn</span> <span class="main">=</span> coeff <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="bound">n</span>
    <span class="keyword1">in</span> fold_coeffs <span class="main">(</span>div_int_poly_step <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span>Some <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">div_int_poly</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int poly <span class="main">⇒</span> int poly <span class="main">⇒</span> int poly option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">div_int_poly</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> 
    <span class="main">(</span><span class="keyword1">case</span> div_mod_int_poly <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> None <span class="main">|</span> Some <span class="main">(</span><span class="bound">d</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">m</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> Some <span class="bound">d</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">div_rat_poly_step</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>field poly <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> poly <span class="main">×</span> <span class="tfree">'a</span> poly <span class="main">⇒</span> <span class="tfree">'a</span> poly <span class="main">×</span> <span class="tfree">'a</span> poly"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">div_rat_poly_step</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span>
      <span class="keyword1">let</span> <span class="bound">b</span> <span class="main">=</span> coeff <span class="main">(</span>pCons <span class="bound">a</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span>degree <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">/</span> coeff <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">(</span>degree <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>
      <span class="keyword1">in</span> <span class="main">(</span>pCons <span class="bound">b</span> <span class="bound">s</span><span class="main">,</span> pCons <span class="bound">a</span> <span class="bound">r</span> <span class="main">-</span> smult <span class="bound">b</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> foldr_cong_plus<span class="main">:</span> <span class="comment1">(* a more elaborate version of foldr_cong. Using f'=id, g'=id and s = set lst would give foldr_cong exactly. *)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f_is_g <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">f'</span> <span class="bound">a</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">b</span> <span class="main">(</span><span class="free">f'</span> <span class="bound">c</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">g'</span> <span class="bound">a</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">b</span> <span class="main">(</span><span class="free">g'</span> <span class="bound">c</span><span class="main">)</span>"</span></span> <span class="comment1">(* main assumption *)</span>
      <span class="keyword2"><span class="keyword">and</span></span> f'_inj <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">f'</span> <span class="bound">a</span> <span class="main">=</span> <span class="free">f'</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">=</span> <span class="bound">b</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> f_bit_sur <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">.</span> <span class="free">f'</span> <span class="bound">a</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">b</span> <span class="bound">c</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">c'</span><span class="main">.</span> <span class="bound">c</span> <span class="main">=</span> <span class="free">f'</span> <span class="bound">c'</span>"</span></span> <span class="comment1">(* should be provable by cases c *)</span>
      <span class="keyword2"><span class="keyword">and</span></span> lst_in_s <span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">lst</span> <span class="main">⊆</span> <span class="free">s</span>"</span></span> <span class="comment1">(* formulated like this to make induction easier *)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f'</span> <span class="free">a</span> <span class="main">=</span> foldr <span class="free">f</span> <span class="free">lst</span> <span class="main">(</span><span class="free">f'</span> <span class="free">b</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">g'</span> <span class="free">a</span> <span class="main">=</span> foldr <span class="free">g</span> <span class="free">lst</span> <span class="main">(</span><span class="free">g'</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> lst_in_s
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">lst</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> prems<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f'</span> <span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span> <span class="main">∘</span> foldr <span class="free">f</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="free">f'</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons.prems <span class="keyword1"><span class="command">unfolding</span></span> foldr_Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">c'</span><span class="main">.</span> <span class="free">f'</span> <span class="bound">c'</span> <span class="main">=</span> foldr <span class="free">f</span> <span class="skolem">xs</span> <span class="main">(</span><span class="free">f'</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f_bit_sur <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c'</span></span> <span class="keyword2"><span class="keyword">where</span></span> c'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f'</span> <span class="skolem">c'</span> <span class="main">=</span> foldr <span class="free">f</span> <span class="skolem">xs</span> <span class="main">(</span><span class="free">f'</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">f'</span> <span class="skolem">a</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">x</span> <span class="main">(</span><span class="free">f'</span> <span class="skolem">c'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">g'</span> <span class="skolem">a</span> <span class="main">=</span> <span class="free">g</span> <span class="skolem">x</span> <span class="main">(</span><span class="free">g'</span> <span class="skolem">c'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f_is_g Cons.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g'</span> <span class="skolem">c'</span> <span class="main">=</span> foldr <span class="free">g</span> <span class="skolem">xs</span> <span class="main">(</span><span class="free">g'</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons.hyps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">c'</span></span><span class="main">]</span> c'_def Cons.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g'</span> <span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="free">g</span> <span class="skolem">x</span> <span class="main">∘</span> foldr <span class="free">g</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="free">g'</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> foldr_Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> f'_inj<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">rp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int poly <span class="main">⇒</span> rat poly"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">rp</span> <span class="main">≡</span> map_poly rat_of_int"</span></span>

<span class="comment1">(* fully transitive proof, right to left also holds without the precondition: 
     int_step_then_rat_poly_step
   Left to right holds if q≠0: rat_poly_step_then_int_step *)</span>
<span class="keyword1"><span class="command">lemma</span></span> rat_int_poly_step_agree <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>pCons <span class="free">b</span> <span class="free">c2</span><span class="main">)</span> <span class="main">(</span>degree <span class="free">q</span><span class="main">)</span> <span class="keyword1">mod</span> coeff <span class="free">q</span> <span class="main">(</span>degree <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rp <span class="free">a1</span><span class="main">,</span>rp <span class="free">a2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>div_rat_poly_step <span class="main">(</span>rp <span class="free">q</span><span class="main">)</span> <span class="main">∘</span> rat_of_int<span class="main">)</span> <span class="free">b</span> <span class="main">(</span>rp <span class="free">c1</span><span class="main">,</span>rp <span class="free">c2</span><span class="main">)</span>
         <span class="main">⟷</span> Some <span class="main">(</span><span class="free">a1</span><span class="main">,</span><span class="free">a2</span><span class="main">)</span> <span class="main">=</span> div_int_poly_step <span class="free">q</span> <span class="free">b</span> <span class="main">(</span>Some <span class="main">(</span><span class="free">c1</span><span class="main">,</span><span class="free">c2</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> coeffs<span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>pCons <span class="free">b</span> <span class="free">c2</span><span class="main">)</span> <span class="main">(</span>degree <span class="free">q</span><span class="main">)</span> <span class="keyword1">mod</span> coeff <span class="free">q</span> <span class="main">(</span>degree <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ri</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rat_of_int"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?withDiv1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"pCons <span class="main">(</span><span class="var">?ri</span> <span class="main">(</span>coeff <span class="main">(</span>pCons <span class="free">b</span> <span class="free">c2</span><span class="main">)</span> <span class="main">(</span>degree <span class="free">q</span><span class="main">)</span> <span class="keyword1">div</span> coeff <span class="free">q</span> <span class="main">(</span>degree <span class="free">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>rp <span class="free">c1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?withSls1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"pCons <span class="main">(</span>coeff <span class="main">(</span>pCons <span class="main">(</span><span class="var">?ri</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span>rp <span class="free">c2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>degree <span class="free">q</span><span class="main">)</span> <span class="main">/</span> coeff <span class="main">(</span>rp <span class="free">q</span><span class="main">)</span> <span class="main">(</span>degree <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>rp <span class="free">c1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ident1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?withDiv1</span> <span class="main">=</span> <span class="var">?withSls1</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?withDiv2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rp <span class="main">(</span>pCons <span class="free">b</span> <span class="free">c2</span> <span class="main">-</span> smult <span class="main">(</span>coeff <span class="main">(</span>pCons <span class="free">b</span> <span class="free">c2</span><span class="main">)</span> <span class="main">(</span>degree <span class="free">q</span><span class="main">)</span> <span class="keyword1">div</span> coeff <span class="free">q</span> <span class="main">(</span>degree <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?withSls2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"pCons <span class="main">(</span><span class="var">?ri</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span>rp <span class="free">c2</span><span class="main">)</span> <span class="main">-</span> smult <span class="main">(</span>coeff <span class="main">(</span>pCons <span class="main">(</span><span class="var">?ri</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span>rp <span class="free">c2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>degree <span class="free">q</span><span class="main">)</span> <span class="main">/</span> coeff <span class="main">(</span>rp <span class="free">q</span><span class="main">)</span> <span class="main">(</span>degree <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>rp <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ident2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?withDiv2</span> <span class="main">=</span> <span class="var">?withSls2</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> simps <span class="main">=</span> div_int_poly_step_def option.simps Let_def prod.simps
  <span class="keyword1"><span class="command">have</span></span> id1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="var">?ri</span> <span class="main">(</span>coeff <span class="main">(</span>pCons <span class="free">b</span> <span class="free">c2</span><span class="main">)</span> <span class="main">(</span>degree <span class="free">q</span><span class="main">)</span> <span class="keyword1">div</span> coeff <span class="free">q</span> <span class="main">(</span>degree <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
            <span class="var">?ri</span> <span class="main">(</span>coeff <span class="main">(</span>pCons <span class="free">b</span> <span class="free">c2</span><span class="main">)</span> <span class="main">(</span>degree <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="var">?ri</span> <span class="main">(</span>coeff <span class="free">q</span> <span class="main">(</span>degree <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> coeffs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> id2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="var">?ident1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> id1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fold</span> of_int_hom.coeff_map_poly_hom of_int_hom.map_poly_pCons_hom<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> id3<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="var">?ident2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> id2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">hom_distribs</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> c1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>rp <span class="main">(</span>pCons <span class="main">(</span>coeff <span class="main">(</span>pCons <span class="free">b</span> <span class="free">c2</span><span class="main">)</span> <span class="main">(</span>degree <span class="free">q</span><span class="main">)</span> <span class="keyword1">div</span> coeff <span class="free">q</span> <span class="main">(</span>degree <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="free">c1</span><span class="main">)</span>
            <span class="main">,</span>rp <span class="main">(</span>pCons <span class="free">b</span> <span class="free">c2</span> <span class="main">-</span> smult <span class="main">(</span>coeff <span class="main">(</span>pCons <span class="free">b</span> <span class="free">c2</span><span class="main">)</span> <span class="main">(</span>degree <span class="free">q</span><span class="main">)</span> <span class="keyword1">div</span> coeff <span class="free">q</span> <span class="main">(</span>degree <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>
           <span class="main">=</span> div_rat_poly_step <span class="main">(</span>rp <span class="free">q</span><span class="main">)</span> <span class="main">(</span><span class="var">?ri</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span>rp <span class="free">c1</span><span class="main">,</span>rp <span class="free">c2</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="var">?ident1</span> <span class="main">∧</span> <span class="var">?ident2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> div_rat_poly_step_def simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">hom_distribs</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>rp <span class="free">a1</span><span class="main">,</span> rp <span class="free">a2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>div_rat_poly_step <span class="main">(</span>rp <span class="free">q</span><span class="main">)</span> <span class="main">∘</span> rat_of_int<span class="main">)</span> <span class="free">b</span> <span class="main">(</span>rp <span class="free">c1</span><span class="main">,</span> rp <span class="free">c2</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span>
             <span class="main">(</span>rp <span class="free">a1</span> <span class="main">=</span> <span class="var">?withSls1</span> <span class="main">∧</span> rp <span class="free">a2</span> <span class="main">=</span> <span class="var">?withSls2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> div_rat_poly_step_def simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span>
      <span class="main">(</span><span class="main">(</span><span class="free">a1</span> <span class="main">=</span> pCons <span class="main">(</span>coeff <span class="main">(</span>pCons <span class="free">b</span> <span class="free">c2</span><span class="main">)</span> <span class="main">(</span>degree <span class="free">q</span><span class="main">)</span> <span class="keyword1">div</span> coeff <span class="free">q</span> <span class="main">(</span>degree <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="free">c1</span><span class="main">)</span> <span class="main">∧</span>
       <span class="main">(</span><span class="free">a2</span> <span class="main">=</span> pCons <span class="free">b</span> <span class="free">c2</span> <span class="main">-</span> smult <span class="main">(</span>coeff <span class="main">(</span>pCons <span class="free">b</span> <span class="free">c2</span><span class="main">)</span> <span class="main">(</span>degree <span class="free">q</span><span class="main">)</span> <span class="keyword1">div</span> coeff <span class="free">q</span> <span class="main">(</span>degree <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fold</span> id2 id3 of_int_hom.map_poly_pCons_hom<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> of_int_poly_hom.eq_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> c0<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> Some <span class="main">(</span><span class="free">a1</span><span class="main">,</span><span class="free">a2</span><span class="main">)</span> <span class="main">=</span> div_int_poly_step <span class="free">q</span> <span class="free">b</span> <span class="main">(</span>Some <span class="main">(</span><span class="free">c1</span><span class="main">,</span><span class="free">c2</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> divmod_int_def div_int_poly_step_def option.simps Let_def prod.simps
    <span class="keyword1"><span class="command">using</span></span> coeffs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits prod.splits if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> int_step_then_rat_poly_step <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Some<span class="main">:</span><span class="quoted"><span class="quoted">"Some <span class="main">(</span><span class="free">a1</span><span class="main">,</span><span class="free">a2</span><span class="main">)</span> <span class="main">=</span> div_int_poly_step <span class="free">q</span> <span class="free">b</span> <span class="main">(</span>Some <span class="main">(</span><span class="free">c1</span><span class="main">,</span><span class="free">c2</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rp <span class="free">a1</span><span class="main">,</span>rp <span class="free">a2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>div_rat_poly_step <span class="main">(</span>rp <span class="free">q</span><span class="main">)</span> <span class="main">∘</span> rat_of_int<span class="main">)</span> <span class="free">b</span> <span class="main">(</span>rp <span class="free">c1</span><span class="main">,</span>rp <span class="free">c2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> simps <span class="main">=</span> div_int_poly_step_def option.simps Let_def divmod_int_def prod.simps
  <span class="keyword1"><span class="command">from</span></span> Some<span class="main">[</span><span class="operator">unfolded</span> simps<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> mod0<span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>pCons <span class="free">b</span> <span class="free">c2</span><span class="main">)</span> <span class="main">(</span>degree <span class="free">q</span><span class="main">)</span> <span class="keyword1">mod</span> coeff <span class="free">q</span> <span class="main">(</span>degree <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits prod.splits if_splits<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms rat_int_poly_step_agree <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_int_rat_division <span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_int_rat <span class="main">(</span>rat_of_int <span class="free">x</span> <span class="main">/</span> rat_of_int <span class="free">y</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">x</span> <span class="keyword1">mod</span> <span class="free">y</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"is_int_rat <span class="main">(</span>rat_of_int <span class="free">x</span> <span class="main">/</span> rat_of_int <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> v_def<span class="main">:</span><span class="quoted"><span class="quoted">"rat_of_int <span class="skolem">v</span> <span class="main">=</span> rat_of_int <span class="free">x</span> <span class="main">/</span> rat_of_int <span class="free">y</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> int_of_rat<span class="main">(</span>2<span class="main">)</span> is_int_rat <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="main">⌊</span>rat_of_int <span class="free">x</span> <span class="main">/</span> rat_of_int <span class="free">y</span><span class="main">⌋</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">*</span> <span class="free">y</span> <span class="main">=</span> <span class="free">x</span> <span class="main">-</span> <span class="free">x</span> <span class="keyword1">mod</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> div_is_floor_divide_rat mod_div_equality_int <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"rat_of_int <span class="skolem">v</span> <span class="main">*</span> rat_of_int <span class="free">y</span> <span class="main">=</span> rat_of_int <span class="free">x</span> <span class="main">-</span> rat_of_int <span class="main">(</span><span class="free">x</span> <span class="keyword1">mod</span> <span class="free">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fold</span> <span class="dynamic"><span class="dynamic">hom_distribs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> of_int_hom.eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rat_of_int <span class="free">x</span> <span class="main">/</span> rat_of_int <span class="free">y</span><span class="main">)</span> <span class="main">*</span> rat_of_int <span class="free">y</span> <span class="main">=</span> rat_of_int <span class="free">x</span> <span class="main">-</span> rat_of_int <span class="main">(</span><span class="free">x</span> <span class="keyword1">mod</span> <span class="free">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> v_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"rat_of_int <span class="free">x</span> <span class="main">=</span> rat_of_int <span class="free">x</span> <span class="main">-</span> rat_of_int <span class="main">(</span><span class="free">x</span> <span class="keyword1">mod</span> <span class="free">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">mod</span> <span class="free">y</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">force</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pCons_of_rp_contains_ints <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rp <span class="free">a</span> <span class="main">=</span> pCons <span class="free">b</span> <span class="free">c</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_int_rat <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">b</span> <span class="bound">n</span><span class="main">.</span> rp <span class="free">a</span> <span class="main">=</span> <span class="bound">b</span> <span class="main">⟹</span> is_int_rat <span class="main">(</span>coeff <span class="bound">b</span> <span class="bound">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"rp <span class="free">a</span> <span class="main">=</span> pCons <span class="free">b</span> <span class="free">c</span> <span class="main">⟹</span> is_int_rat <span class="main">(</span>coeff <span class="main">(</span>pCons <span class="free">b</span> <span class="free">c</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rat_step_then_int_poly_step <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rp <span class="free">a1</span><span class="main">,</span>rp <span class="free">a2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>div_rat_poly_step <span class="main">(</span>rp <span class="free">q</span><span class="main">)</span> <span class="main">∘</span> rat_of_int<span class="main">)</span> <span class="free">b2</span> <span class="main">(</span>rp <span class="free">c1</span><span class="main">,</span>rp <span class="free">c2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Some <span class="main">(</span><span class="free">a1</span><span class="main">,</span><span class="free">a2</span><span class="main">)</span> <span class="main">=</span> div_int_poly_step <span class="free">q</span> <span class="free">b2</span> <span class="main">(</span>Some <span class="main">(</span><span class="free">c1</span><span class="main">,</span><span class="free">c2</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mustbeint</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rat_of_int <span class="main">(</span>coeff <span class="main">(</span>pCons <span class="free">b2</span> <span class="free">c2</span><span class="main">)</span> <span class="main">(</span>degree <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> rat_of_int <span class="main">(</span>coeff <span class="free">q</span> <span class="main">(</span>degree <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mustbeint2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>pCons <span class="main">(</span>rat_of_int <span class="free">b2</span><span class="main">)</span> <span class="main">(</span>rp <span class="free">c2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>degree <span class="main">(</span>rp <span class="free">q</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">/</span> coeff <span class="main">(</span>rp <span class="free">q</span><span class="main">)</span> <span class="main">(</span>degree <span class="main">(</span>rp <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> mustbeint <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?mustbeint</span> <span class="main">=</span> <span class="var">?mustbeint2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fold</span> <span class="dynamic"><span class="dynamic">hom_distribs</span></span> of_int_hom.coeff_map_poly_hom<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> simps <span class="main">=</span> div_int_poly_step_def option.simps Let_def divmod_int_def prod.simps
  <span class="keyword1"><span class="command">from</span></span> assms leading_coeff_neq_0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">q</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> q0<span class="main">:</span><span class="quoted"><span class="quoted">"coeff <span class="free">q</span> <span class="main">(</span>degree <span class="free">q</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rp <span class="free">a1</span> <span class="main">=</span> pCons <span class="var">?mustbeint2</span> <span class="main">(</span>rp <span class="free">c1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> div_rat_poly_step_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>div_int_poly_step_def Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_int_rat <span class="var">?mustbeint2</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> div_rat_poly_step_def <span class="keyword1"><span class="command">using</span></span> pCons_of_rp_contains_ints <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_int_rat <span class="var">?mustbeint</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> mustbeint <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>pCons <span class="free">b2</span> <span class="free">c2</span><span class="main">)</span> <span class="main">(</span>degree <span class="free">q</span><span class="main">)</span> <span class="keyword1">mod</span> coeff <span class="free">q</span> <span class="main">(</span>degree <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> is_int_rat_division q0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> rat_int_poly_step_agree assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> div_int_poly_step_surjective <span class="main">:</span> <span class="quoted"><span class="quoted">"Some <span class="free">a</span> <span class="main">=</span> div_int_poly_step <span class="free">q</span> <span class="free">b</span> <span class="free">c</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">c'</span><span class="main">.</span> <span class="free">c</span> <span class="main">=</span> Some <span class="bound">c'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> div_int_poly_step_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span>  div_mod_int_poly_then_pdivmod<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"div_mod_int_poly <span class="free">p</span> <span class="free">q</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span>rp <span class="free">p</span> <span class="keyword1">div</span> rp <span class="free">q</span><span class="main">,</span> rp <span class="free">p</span> <span class="keyword1">mod</span> rp <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>rp <span class="free">r</span><span class="main">,</span> rp <span class="free">m</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rpp</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>rp <span class="bound">a</span><span class="main">,</span>rp <span class="bound">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rp <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rp <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rp <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rp <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?div_rat_step</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"div_rat_poly_step <span class="var">?q</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?div_int_step</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"div_int_poly_step <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> q0 <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> div_mod_int_poly_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"div_mod_int_poly <span class="free">p</span> <span class="free">q</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="free">m</span><span class="main">)</span> <span class="main">⟷</span> Some <span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="free">m</span><span class="main">)</span> <span class="main">=</span> foldr <span class="main">(</span>div_int_poly_step <span class="free">q</span><span class="main">)</span> <span class="main">(</span>coeffs <span class="free">p</span><span class="main">)</span> <span class="main">(</span>Some <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> div_mod_int_poly_def fold_coeffs_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits prod.splits if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> innerRes<span class="main">:</span> <span class="quoted"><span class="quoted">"Some <span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="free">m</span><span class="main">)</span> <span class="main">=</span> foldr <span class="main">(</span><span class="var">?div_int_step</span><span class="main">)</span> <span class="main">(</span>coeffs <span class="free">p</span><span class="main">)</span> <span class="main">(</span>Some <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">oldRes</span> <span class="skolem">res</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int poly <span class="main">×</span> int poly"</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">lst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int list"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Some <span class="skolem">res</span> <span class="main">=</span> foldr <span class="var">?div_int_step</span> <span class="skolem">lst</span> <span class="main">(</span>Some <span class="skolem">oldRes</span><span class="main">)</span> <span class="main">⟹</span>
          <span class="var">?rpp</span> <span class="skolem">res</span> <span class="main">=</span> foldr <span class="main">(</span><span class="var">?div_rat_step</span> <span class="main">∘</span> rat_of_int<span class="main">)</span> <span class="skolem">lst</span> <span class="main">(</span><span class="var">?rpp</span> <span class="skolem">oldRes</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> foldr_cong_plus<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"set <span class="skolem">lst</span>"</span></span> <span class="quoted">Some</span> <span class="var"><span class="quoted"><span class="var">?div_int_step</span></span></span> <span class="var"><span class="quoted"><span class="var">?rpp</span></span></span> <span class="quoted"><span class="quoted">"<span class="var">?div_rat_step</span> <span class="main">∘</span> rat_of_int"</span></span> 
        <span class="quoted"><span class="skolem">lst</span></span> <span class="quoted"><span class="skolem">res</span></span> <span class="quoted"><span class="skolem">oldRes</span></span><span class="main">]</span> int_step_then_rat_poly_step div_int_poly_step_surjective <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Some <span class="skolem">res</span> <span class="main">=</span> foldr <span class="var">?div_int_step</span> <span class="skolem">lst</span> <span class="main">(</span>Some <span class="skolem">oldRes</span><span class="main">)</span> 
      <span class="main">⟹</span> <span class="var">?rpp</span> <span class="skolem">res</span> <span class="main">=</span> foldr <span class="var">?div_rat_step</span> <span class="main">(</span>map rat_of_int <span class="skolem">lst</span><span class="main">)</span> <span class="main">(</span><span class="var">?rpp</span> <span class="skolem">oldRes</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> foldr_map<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?div_rat_step</span></span></span> <span class="quoted">rat_of_int</span> <span class="quoted"><span class="skolem">lst</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> equal_foldr <span class="main">:</span> <span class="quoted"><span class="quoted">"Some <span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="free">m</span><span class="main">)</span> <span class="main">=</span> foldr <span class="main">(</span><span class="var">?div_int_step</span><span class="main">)</span> <span class="main">(</span>coeffs <span class="free">p</span><span class="main">)</span> <span class="main">(</span>Some <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">⟹</span> <span class="var">?rpp</span> <span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="free">m</span><span class="main">)</span> <span class="main">=</span> foldr <span class="main">(</span><span class="var">?div_rat_step</span><span class="main">)</span> <span class="main">(</span>map rat_of_int <span class="main">(</span>coeffs <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="var">?rpp</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map rat_of_int <span class="main">(</span>coeffs <span class="free">p</span><span class="main">)</span> <span class="main">=</span> coeffs <span class="var">?p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?r</span><span class="main">,</span><span class="var">?m</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>foldr <span class="main">(</span><span class="var">?div_rat_step</span><span class="main">)</span> <span class="main">(</span>coeffs <span class="var">?p</span><span class="main">)</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> equal_foldr innerRes <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?p</span> <span class="keyword1">div</span> <span class="var">?q</span><span class="main">,</span> <span class="var">?p</span> <span class="keyword1">mod</span> <span class="var">?q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="var">?r</span><span class="main">,</span><span class="var">?m</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> fold_coeffs_def <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="var">?div_rat_step</span>"</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span><span class="main">]</span> q0 
      div_mod_fold_coeffs <span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> div_rat_poly_step_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> div_rat_poly_step_sur<span class="main">:</span>
 <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> <span class="free">a</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>rp <span class="bound">a</span><span class="main">,</span> rp <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>div_rat_poly_step <span class="main">(</span>rp <span class="free">q</span><span class="main">)</span> <span class="main">∘</span> rat_of_int<span class="main">)</span> <span class="free">x</span> <span class="free">pair</span>"</span></span>
   <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c'</span><span class="main">.</span> <span class="free">pair</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">c'</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>rp <span class="bound">a</span><span class="main">,</span> rp <span class="bound">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b1</span></span> <span class="skolem"><span class="skolem">b2</span></span> <span class="keyword2"><span class="keyword">where</span></span> pair<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pair</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">b1</span><span class="main">,</span> <span class="skolem">b2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">pair</span></span><span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">p12</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p12</span> <span class="main">=</span> coeff <span class="main">(</span>pCons <span class="main">(</span>rat_of_int <span class="free">x</span><span class="main">)</span> <span class="skolem">b2</span><span class="main">)</span> <span class="main">(</span>degree <span class="main">(</span>rp <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> coeff <span class="main">(</span>rp <span class="free">q</span><span class="main">)</span> <span class="main">(</span>degree <span class="main">(</span>rp <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a1</span></span> <span class="skolem"><span class="skolem">a2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a1</span><span class="main">,</span> <span class="skolem">a2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> assms pair <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rp <span class="skolem">a1</span><span class="main">,</span> rp <span class="skolem">a2</span><span class="main">)</span> <span class="main">=</span> div_rat_poly_step <span class="main">(</span>rp <span class="free">q</span><span class="main">)</span> <span class="main">(</span>rat_of_int <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">b1</span><span class="main">,</span> <span class="skolem">b2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>    
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"rp <span class="skolem">a1</span> <span class="main">=</span> pCons <span class="skolem">p12</span> <span class="skolem">b1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rp <span class="skolem">a2</span> <span class="main">=</span> pCons <span class="main">(</span>rat_of_int <span class="free">x</span><span class="main">)</span> <span class="skolem">b2</span> <span class="main">-</span> smult <span class="skolem">p12</span> <span class="main">(</span>rp <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def div_rat_poly_step_def p12_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p21</span></span> <span class="skolem"><span class="skolem">p22</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"rp <span class="skolem">p21</span> <span class="main">=</span> pCons <span class="skolem">p22</span> <span class="skolem">b2</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> coeff_pCons_0 of_int_hom.map_poly_hom_add of_int_hom.map_poly_hom_smult of_int_hom.coeff_map_poly_hom<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p21'</span></span> <span class="skolem"><span class="skolem">p21q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p21</span> <span class="main">=</span> pCons <span class="skolem">p21'</span> <span class="skolem">p21q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pCons_cases<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b2</span> <span class="main">=</span> rp <span class="skolem">p2</span> "</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">hom_distribs</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a1'</span></span> <span class="skolem"><span class="skolem">a1q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a1</span> <span class="main">=</span> pCons <span class="skolem">a1'</span> <span class="skolem">a1q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pCons_cases<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> a1 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b1</span> <span class="main">=</span> rp <span class="skolem">p1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">hom_distribs</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">pair</span> <span class="main">=</span> <span class="main">(</span>rp <span class="skolem">p1</span><span class="main">,</span> rp <span class="skolem">p2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pair <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span>  pdivmod_then_div_mod_int_poly<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> q0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rp <span class="free">p</span> <span class="keyword1">div</span> rp <span class="free">q</span><span class="main">,</span> rp <span class="free">p</span> <span class="keyword1">mod</span> rp <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>rp <span class="free">r</span><span class="main">,</span> rp <span class="free">m</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"div_mod_int_poly <span class="free">p</span> <span class="free">q</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="free">m</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rpp</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>rp <span class="bound">a</span><span class="main">,</span>rp <span class="bound">b</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="comment1">(* rp pair *)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rp <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rp <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rp <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rp <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?div_rat_step</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"div_rat_poly_step <span class="var">?q</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?div_int_step</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"div_int_poly_step <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">oldRes</span> <span class="skolem">res</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int poly <span class="main">×</span> int poly"</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">lst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int list"</span></span>
    <span class="keyword1"><span class="command">have</span></span> inj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">a</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>rp <span class="bound">a</span><span class="main">,</span> rp <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">b</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>rp <span class="bound">a</span><span class="main">,</span> rp <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">=</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> set <span class="skolem">lst</span> <span class="main">⟹</span>
              <span class="main">(</span><span class="keyword1">case</span> <span class="bound">a</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>map_poly rat_of_int <span class="bound">a</span><span class="main">,</span> map_poly rat_of_int <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
              <span class="main">(</span>div_rat_poly_step <span class="main">(</span>map_poly rat_of_int <span class="free">q</span><span class="main">)</span> <span class="main">∘</span> rat_of_int<span class="main">)</span> <span class="bound">b</span>
               <span class="main">(</span><span class="keyword1">case</span> <span class="bound">c</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>map_poly rat_of_int <span class="bound">a</span><span class="main">,</span> map_poly rat_of_int <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
              Some <span class="bound">a</span> <span class="main">=</span> div_int_poly_step <span class="free">q</span> <span class="bound">b</span> <span class="main">(</span>Some <span class="bound">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rat_step_then_int_poly_step<span class="main">[</span><span class="operator">OF</span> q0<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rpp</span> <span class="skolem">res</span> <span class="main">=</span> foldr <span class="main">(</span><span class="var">?div_rat_step</span> <span class="main">∘</span> rat_of_int<span class="main">)</span> <span class="skolem">lst</span> <span class="main">(</span><span class="var">?rpp</span> <span class="skolem">oldRes</span><span class="main">)</span>
          <span class="main">⟹</span> Some <span class="skolem">res</span> <span class="main">=</span> foldr <span class="var">?div_int_step</span> <span class="skolem">lst</span> <span class="main">(</span>Some <span class="skolem">oldRes</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> foldr_cong_plus<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"set <span class="skolem">lst</span>"</span></span> <span class="var"><span class="quoted"><span class="var">?rpp</span></span></span> <span class="quoted"><span class="quoted">"<span class="var">?div_rat_step</span> <span class="main">∘</span> rat_of_int"</span></span> <span class="quoted">Some</span> <span class="var"><span class="quoted"><span class="var">?div_int_step</span></span></span> <span class="quoted"><span class="skolem">lst</span></span> <span class="quoted"><span class="skolem">res</span></span> <span class="quoted"><span class="skolem">oldRes</span></span><span class="main">]</span>
            div_rat_poly_step_sur inj <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rpp</span> <span class="skolem">res</span> <span class="main">=</span> foldr <span class="var">?div_rat_step</span> <span class="main">(</span>map rat_of_int <span class="skolem">lst</span><span class="main">)</span> <span class="main">(</span><span class="var">?rpp</span> <span class="skolem">oldRes</span><span class="main">)</span>
       <span class="main">⟹</span> Some <span class="skolem">res</span> <span class="main">=</span> foldr <span class="var">?div_int_step</span> <span class="skolem">lst</span> <span class="main">(</span>Some <span class="skolem">oldRes</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> foldr_map<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?div_rat_step</span></span></span> <span class="quoted">rat_of_int</span> <span class="quoted"><span class="skolem">lst</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> equal_foldr <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?rpp</span> <span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="free">m</span><span class="main">)</span> <span class="main">=</span> foldr <span class="main">(</span><span class="var">?div_rat_step</span><span class="main">)</span> <span class="main">(</span>map rat_of_int <span class="main">(</span>coeffs <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="var">?rpp</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span>
                   <span class="main">⟹</span> Some <span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="free">m</span><span class="main">)</span> <span class="main">=</span> foldr <span class="main">(</span><span class="var">?div_int_step</span><span class="main">)</span> <span class="main">(</span>coeffs <span class="free">p</span><span class="main">)</span> <span class="main">(</span>Some <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?r</span><span class="main">,</span><span class="var">?m</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>foldr <span class="main">(</span><span class="var">?div_rat_step</span><span class="main">)</span> <span class="main">(</span>coeffs <span class="var">?p</span><span class="main">)</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fold_coeffs_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="var">?div_rat_step</span>"</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span><span class="main">]</span> assms
      div_mod_fold_coeffs <span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> div_rat_poly_step_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Some <span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="free">m</span><span class="main">)</span> <span class="main">=</span> foldr <span class="main">(</span><span class="var">?div_int_step</span><span class="main">)</span> <span class="main">(</span>coeffs <span class="free">p</span><span class="main">)</span> <span class="main">(</span>Some <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> equal_foldr <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> q0 <span class="keyword1"><span class="command">unfolding</span></span> div_mod_int_poly_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fold_coeffs_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> div_int_then_rqp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"div_int_poly <span class="free">p</span> <span class="free">q</span> <span class="main">=</span> Some <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">*</span> <span class="free">q</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rpp</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>rp <span class="bound">a</span><span class="main">,</span>rp <span class="bound">b</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="comment1">(* rp pair *)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rp <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rp <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rp <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Some <span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">=</span> div_mod_int_poly <span class="free">p</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> div_int_poly_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>  option.splits prod.splits if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> div_mod_int_poly_then_pdivmod<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">p</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">q</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">r</span></span></span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="keyword1">div</span> <span class="var">?q</span> <span class="main">=</span> <span class="var">?r</span> <span class="main">∧</span> <span class="var">?p</span> <span class="keyword1">mod</span> <span class="var">?q</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> div_mult_mod_eq<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">=</span> <span class="var">?r</span> <span class="main">*</span> <span class="var">?q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> rp <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">hom_distribs</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">=</span> rp <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">q</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">*</span> <span class="free">q</span> <span class="main">=</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> div_int_poly_def div_mod_int_poly_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits prod.splits if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> rqp_then_div_int<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">*</span> <span class="free">q</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> q0<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"div_int_poly <span class="free">p</span> <span class="free">q</span> <span class="main">=</span> Some <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rpp</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>rp <span class="bound">a</span><span class="main">,</span>rp <span class="bound">b</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="comment1">(* rp pair *)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rp <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rp <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rp <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">=</span> <span class="var">?r</span> <span class="main">*</span> <span class="var">?q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">hom_distribs</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="keyword1">div</span> <span class="var">?q</span> <span class="main">=</span> <span class="var">?r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="keyword1">mod</span> <span class="var">?q</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> q0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rp <span class="free">p</span> <span class="keyword1">div</span> rp <span class="free">q</span><span class="main">,</span> rp <span class="free">p</span> <span class="keyword1">mod</span> rp <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>rp <span class="free">r</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rp <span class="free">p</span> <span class="keyword1">div</span> rp <span class="free">q</span><span class="main">,</span> rp <span class="free">p</span> <span class="keyword1">mod</span> rp <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>rp <span class="free">r</span><span class="main">,</span> rp <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Some <span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">=</span> div_mod_int_poly <span class="free">p</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pdivmod_then_div_mod_int_poly<span class="main">[</span><span class="operator">OF</span> q0<span class="main">,</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> div_mod_int_poly_def div_int_poly_def <span class="keyword1"><span class="command">using</span></span> q0 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> option.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> split_conv<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> div_int_poly<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>div_int_poly <span class="free">p</span> <span class="free">q</span> <span class="main">=</span> Some <span class="free">r</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">q</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">p</span> <span class="main">=</span> <span class="free">r</span> <span class="main">*</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> div_int_then_rqp rqp_then_div_int <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">dvd_int_poly</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int poly <span class="main">⇒</span> int poly <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dvd_int_poly</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">else</span> div_int_poly <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">≠</span> None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dvd_int_poly<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dvd_int_poly <span class="free">q</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="free">q</span> <span class="keyword1">dvd</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> dvd_def dvd_int_poly_def <span class="keyword1"><span class="command">using</span></span> div_int_poly<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">q</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">dvd_int_poly_non_0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int poly <span class="main">⇒</span> int poly <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dvd_int_poly_non_0</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span>div_int_poly <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">≠</span> None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dvd_int_poly_non_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> dvd_int_poly_non_0 <span class="free">q</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="free">q</span> <span class="keyword1">dvd</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> dvd_def dvd_int_poly_non_0_def <span class="keyword1"><span class="command">using</span></span> div_int_poly<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">q</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">dvd</span> <span class="free">q</span> <span class="main">⟷</span> dvd_int_poly <span class="free">p</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">hide_const</span></span> rp
<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="Missing_Polynomial_Factorial">
<div class="head">
<h1>Theory Missing_Polynomial_Factorial</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹More on Polynomials›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This theory contains several results on content, gcd, primitive part, etc..
  Moreover, there is a slightly improved code-equation for computing the gcd.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Missing_Polynomial_Factorial
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../../HOL/HOL-Computational_Algebra/Polynomial_Factorial.html">HOL-Computational_Algebra.Polynomial_Factorial</a>"</span>
   <a href="../Polynomial_Interpolation/Missing_Polynomial.html">Polynomial_Interpolation.Missing_Polynomial</a>  
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Improved code equation for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> gcd_poly_code<span class="antiquote"><span class="antiquote">}</span></span></span></span>
  which avoids computing the content twice.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> gcd_poly_code_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"gcd_poly_code <span class="free">p</span> <span class="free">q</span> <span class="main">=</span>
           <span class="main">(</span><span class="keyword1">if</span> <span class="free">p</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> normalize <span class="free">q</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free">q</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> normalize <span class="free">p</span> <span class="keyword1">else</span> <span class="keyword1">let</span>
              <span class="bound">c1</span> <span class="main">=</span> content <span class="free">p</span><span class="main">;</span>
              <span class="bound">c2</span> <span class="main">=</span> content <span class="free">q</span><span class="main">;</span>
              <span class="bound">p'</span> <span class="main">=</span> map_poly <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">div</span> <span class="bound">c1</span><span class="main">)</span> <span class="free">p</span><span class="main">;</span>
              <span class="bound">q'</span> <span class="main">=</span> map_poly <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">div</span> <span class="bound">c2</span><span class="main">)</span> <span class="free">q</span>
              <span class="keyword1">in</span> smult <span class="main">(</span>gcd <span class="bound">c1</span> <span class="bound">c2</span><span class="main">)</span> <span class="main">(</span>gcd_poly_code_aux <span class="bound">p'</span> <span class="bound">q'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gcd_poly_code_def Let_def primitive_part_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> gcd_smult<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>factorial_ring_gcd<span class="main">,</span>semiring_gcd_mult_normalize<span class="main">}</span> poly"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> cf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cf</span> <span class="main">≡</span> content <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> cg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cg</span> <span class="main">≡</span> content <span class="free">g</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gcd <span class="main">(</span>smult <span class="free">a</span> <span class="free">f</span><span class="main">)</span> <span class="free">g</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">a</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">f</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> normalize <span class="free">g</span> <span class="keyword1">else</span>
  smult <span class="main">(</span>gcd <span class="free">a</span> <span class="main">(</span><span class="free">cg</span> <span class="keyword1">div</span> <span class="main">(</span>gcd <span class="free">cf</span> <span class="free">cg</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>gcd <span class="free">f</span> <span class="free">g</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">f</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"content"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?pp</span></span></span> <span class="main">=</span> <span class="quoted">primitive_part</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ua</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"unit_factor <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?na</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"normalize <span class="free">a</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">H</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">=</span> gcd <span class="main">(</span><span class="var">?c</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="var">?c</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="keyword1">dvd</span> <span class="var">?c</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> H_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="keyword2"><span class="keyword">where</span></span> fh<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?c</span> <span class="free">f</span> <span class="main">=</span> <span class="skolem">H</span> <span class="main">*</span> <span class="skolem">F</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> cf0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?c</span> <span class="free">f</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> H_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> fh<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="keyword1">div</span> <span class="skolem">H</span>"</span></span><span class="main">]</span> H <span class="keyword1"><span class="command">have</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">=</span> <span class="var">?c</span> <span class="free">f</span> <span class="keyword1">div</span> <span class="skolem">H</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="keyword1">dvd</span> <span class="var">?c</span> <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> H_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">G</span></span> <span class="keyword2"><span class="keyword">where</span></span> gh<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?c</span> <span class="free">g</span> <span class="main">=</span> <span class="skolem">H</span> <span class="main">*</span> <span class="skolem">G</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> gh<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="keyword1">div</span> <span class="skolem">H</span>"</span></span><span class="main">]</span> H <span class="keyword1"><span class="command">have</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="main">=</span> <span class="var">?c</span> <span class="free">g</span> <span class="keyword1">div</span> <span class="skolem">H</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">F</span> <span class="skolem">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">unfolding</span></span> F G H_def
    <span class="keyword1"><span class="command">using</span></span> cf0 div_gcd_coprime <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_unit <span class="var">?ua</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ua<span class="main">:</span> <span class="quoted"><span class="quoted">"is_unit <span class="main">[:</span> <span class="var">?ua</span> <span class="main">:]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_unit_const_poly_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gcd <span class="main">(</span>smult <span class="free">a</span> <span class="free">f</span><span class="main">)</span> <span class="free">g</span> <span class="main">=</span> smult <span class="main">(</span>gcd <span class="main">(</span><span class="var">?na</span> <span class="main">*</span> <span class="var">?c</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="var">?c</span> <span class="free">g</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>gcd <span class="main">(</span>smult <span class="var">?ua</span> <span class="main">(</span><span class="var">?pp</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="var">?pp</span> <span class="free">g</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> gcd_poly_decompose<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"smult <span class="free">a</span> <span class="free">f</span>"</span></span><span class="main">]</span>
    content_smult primitive_part_smult <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"smult <span class="var">?ua</span> <span class="main">(</span><span class="var">?pp</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="var">?pp</span> <span class="free">f</span> <span class="main">*</span> <span class="main">[:</span> <span class="var">?ua</span> <span class="main">:]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gcd <span class="main">…</span> <span class="main">(</span><span class="var">?pp</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> gcd <span class="main">(</span><span class="var">?pp</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="var">?pp</span> <span class="free">g</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> gcd_mult_unit1<span class="main">[</span><span class="operator">OF</span> ua<span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gcd <span class="main">(</span><span class="var">?na</span> <span class="main">*</span> <span class="var">?c</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="var">?c</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> gcd <span class="main">(</span><span class="main">(</span><span class="var">?na</span> <span class="main">*</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">H</span><span class="main">)</span> <span class="main">(</span><span class="skolem">G</span> <span class="main">*</span> <span class="skolem">H</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> fh gh <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> gcd <span class="main">(</span><span class="var">?na</span> <span class="main">*</span> <span class="skolem">F</span><span class="main">)</span> <span class="skolem">G</span> <span class="main">*</span> normalize <span class="skolem">H</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> gcd_mult_right gcd.commute<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">G</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> normalize_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"normalize <span class="skolem">H</span> <span class="main">=</span> <span class="skolem">H</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> H_def normalize_gcd<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gcd <span class="main">(</span>smult <span class="free">a</span> <span class="free">f</span><span class="main">)</span> <span class="free">g</span> <span class="main">=</span> smult <span class="main">(</span>gcd <span class="main">(</span><span class="var">?na</span> <span class="main">*</span> <span class="skolem">F</span><span class="main">)</span> <span class="skolem">G</span><span class="main">)</span> <span class="main">(</span>smult  <span class="skolem">H</span> <span class="main">(</span>gcd <span class="main">(</span><span class="var">?pp</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="var">?pp</span> <span class="free">g</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"smult <span class="skolem">H</span> <span class="main">(</span>gcd <span class="main">(</span><span class="var">?pp</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="var">?pp</span> <span class="free">g</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> gcd <span class="free">f</span> <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> H_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gcd_poly_decompose<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gcd <span class="main">(</span><span class="var">?na</span> <span class="main">*</span> <span class="skolem">F</span><span class="main">)</span> <span class="skolem">G</span> <span class="main">=</span> gcd <span class="main">(</span><span class="skolem">F</span> <span class="main">*</span> <span class="var">?na</span><span class="main">)</span> <span class="skolem">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> gcd <span class="var">?na</span> <span class="skolem">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹coprime <span class="skolem">F</span> <span class="skolem">G</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gcd_mult_right_left_cancel <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> G H_def cg cf <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"gcd <span class="main">(</span>smult <span class="free">a</span> <span class="free">f</span><span class="main">)</span> <span class="free">g</span> <span class="main">=</span> normalize <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gcd_smult_ex<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">b</span><span class="main">.</span> gcd <span class="main">(</span>smult <span class="free">a</span> <span class="free">f</span><span class="main">)</span> <span class="free">g</span> <span class="main">=</span> smult <span class="bound">b</span> <span class="main">(</span>gcd <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">b</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">1</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">f</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> gcd_smult id if_False
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> refl<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> primitive_part_idemp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>semiring_gcd<span class="main">,</span>normalization_semidom_multiplicative<span class="main">}</span> poly"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"primitive_part <span class="main">(</span>primitive_part <span class="free">f</span><span class="main">)</span> <span class="main">=</span> primitive_part <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> content_primitive_part<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">f</span></span></span></span></span></span><span class="main"><span class="main">]</span></span> primitive_part_eq_0_iff primitive_part_prim<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> content_gcd_primitive<span class="main">:</span>
   <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> content <span class="main">(</span>gcd <span class="main">(</span>primitive_part <span class="free">f</span><span class="main">)</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> content <span class="main">(</span>gcd <span class="main">(</span>primitive_part <span class="free">f</span><span class="main">)</span> <span class="main">(</span>primitive_part <span class="free">g</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> content_dvd_contentI content_primitive_part gcd_dvd1 is_unit_content_iff<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> content_gcd_content<span class="main">:</span> <span class="quoted"><span class="quoted">"content <span class="main">(</span>gcd <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> gcd <span class="main">(</span>content <span class="free">f</span><span class="main">)</span> <span class="main">(</span>content <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"content"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> normalize <span class="main">(</span>gcd <span class="main">(</span><span class="var">?c</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="var">?c</span> <span class="free">g</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span>
    <span class="var">?c</span> <span class="main">(</span>gcd <span class="main">(</span>primitive_part <span class="free">f</span><span class="main">)</span> <span class="main">(</span>primitive_part <span class="free">g</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> gcd_poly_decompose<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">g</span></span><span class="main">]</span> content_smult <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> gcd <span class="main">(</span><span class="var">?c</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="var">?c</span> <span class="free">g</span><span class="main">)</span> <span class="main">*</span>
    <span class="var">?c</span> <span class="main">(</span>gcd <span class="main">(</span>primitive_part <span class="free">f</span><span class="main">)</span> <span class="main">(</span>primitive_part <span class="free">g</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> content_gcd_primitive<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">f</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">g</span></span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> content_dvd_contentI content_eq_zero_iff
    content_primitive_part gcd_dvd2 gcd_eq_0_iff is_unit_content_iff mult_cancel_left1<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gcd_primitive_part<span class="main">:</span>
  <span class="quoted"><span class="quoted">"gcd <span class="main">(</span>primitive_part <span class="free">f</span><span class="main">)</span> <span class="main">(</span>primitive_part <span class="free">g</span><span class="main">)</span> <span class="main">=</span> normalize <span class="main">(</span>primitive_part <span class="main">(</span>gcd <span class="free">f</span> <span class="free">g</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> gcd_poly_decompose<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">g</span></span><span class="main">]</span> gcd_0_left primitive_part_0 True
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> associatedI primitive_part_dvd_primitive_partI<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"normalize <span class="main">1</span> <span class="main">=</span> normalize <span class="main">(</span>unit_factor <span class="main">(</span>gcd <span class="main">(</span>content <span class="free">f</span><span class="main">)</span> <span class="main">(</span>content <span class="free">g</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> False<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> gcd_poly_decompose<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">g</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Polynomial.normalize_smult content_gcd_primitive<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> False<span class="main"><span class="main">]</span></span> content_times_primitive_part normalize_gcd primitive_part_smult<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> primitive_part_gcd<span class="main">:</span> <span class="quoted"><span class="quoted">"primitive_part <span class="main">(</span>gcd <span class="free">f</span> <span class="free">g</span><span class="main">)</span>
  <span class="main">=</span> unit_factor <span class="main">(</span>gcd <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">*</span> gcd <span class="main">(</span>primitive_part <span class="free">f</span><span class="main">)</span> <span class="main">(</span>primitive_part <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gcd_primitive_part
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span>
  content_times_primitive_part gcd.normalize_idem mult_cancel_left2 mult_smult_left
  normalize_eq_0_iff normalize_mult_unit_factor primitive_part_eq_0_iff
  smult_content_normalize_primitive_part unit_factor_mult_normalize<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> primitive_part_normalize<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>semiring_gcd<span class="main">,</span>idom_divide<span class="main">,</span>normalization_semidom_multiplicative<span class="main">}</span> poly"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"primitive_part <span class="main">(</span>normalize <span class="free">f</span><span class="main">)</span> <span class="main">=</span> normalize <span class="main">(</span>primitive_part <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"normalize <span class="main">(</span>content <span class="main">(</span>normalize <span class="main">(</span>primitive_part <span class="free">f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> content_primitive_part<span class="main">[</span><span class="operator">OF</span> False<span class="main">]</span> content_dvd content_const
          content_dvd_contentI dvd_normalize_iff is_unit_content_iff <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"content <span class="main">(</span>normalize <span class="main">(</span>primitive_part <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"content <span class="main">(</span>normalize <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">*</span> content <span class="free">f</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> content_smult mult.commute normalize_content
    smult_content_normalize_primitive_part<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"content <span class="free">f</span> <span class="main">=</span> content <span class="main">(</span>normalize <span class="free">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> smult_content_normalize_primitive_part<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">,</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> False content_times_primitive_part mult.commute mult_cancel_left
                                   mult_smult_right smult_content_normalize_primitive_part<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> length_coeffs_primitive_part<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>coeffs <span class="main">(</span>primitive_part <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>coeffs <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>coeffs <span class="free">f</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>coeffs <span class="main">(</span>primitive_part <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> degree_primitive_part<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">,</span> <span class="operator">unfolded</span> degree_eq_length_coeffs<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> degree_unit_factor<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span>unit_factor <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> monom_0 unit_factor_poly_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> degree_normalize<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span>normalize <span class="free">f</span><span class="main">)</span> <span class="main">=</span> degree <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">f</span> <span class="main">=</span> degree <span class="main">(</span>unit_factor <span class="free">f</span> <span class="main">*</span> normalize <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> degree <span class="main">(</span>unit_factor <span class="free">f</span><span class="main">)</span> <span class="main">+</span> degree <span class="main">(</span>normalize <span class="free">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> degree_mult_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> False<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  
<span class="keyword1"><span class="command">lemma</span></span> content_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">dvd</span> content <span class="free">p</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> set <span class="main">(</span>coeffs <span class="free">p</span><span class="main">)</span><span class="main">.</span> <span class="free">x</span> <span class="keyword1">dvd</span> <span class="bound">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> content_def dvd_gcd_list_iff<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> is_unit_field_poly<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>field poly<span class="main">)</span> <span class="keyword1">dvd</span> <span class="main">1</span> <span class="main">⟷</span> <span class="free">p</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> degree <span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> iffI conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> conj_imp_eq_imp_imp<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"is_unit <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">*</span> <span class="skolem">q</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> dvdE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> * <span class="keyword3"><span class="command">show</span></span> p0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> q0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> * degree_mult_eq<span class="main">[</span><span class="operator">OF</span> p0 q0<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> degree0_coeffs<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">[:</span><span class="skolem">c</span><span class="main">:]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> c <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> c <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">=</span> <span class="free">p</span> <span class="main">*</span> <span class="main">[:</span><span class="main">1</span><span class="main">/</span><span class="skolem">c</span><span class="main">:]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> dvdI<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"is_unit <span class="free">p</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">primitive</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">primitive</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>coeffs <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">dvd</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="keyword1">dvd</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> primitiveI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>coeffs <span class="free">f</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="keyword1">dvd</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="keyword1">dvd</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"primitive <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> primitive_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> primitiveD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"primitive <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>coeffs <span class="free">f</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="keyword1">dvd</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="keyword1">dvd</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> primitive_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> not_primitiveE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> primitive <span class="free">f</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>coeffs <span class="free">f</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="keyword1">dvd</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="bound">x</span> <span class="keyword1">dvd</span> <span class="main">1</span> <span class="main">⟹</span> <span class="free">thesis</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> primitive_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> primitive_iff_content_eq_1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> semiring_gcd poly"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"primitive <span class="free">f</span> <span class="main">⟷</span> content <span class="free">f</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> iffI primitiveI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>coeffs <span class="free">f</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="keyword1">dvd</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> gcd_list_greatest<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"coeffs <span class="free">f</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">dvd</span> content <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> content_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"content <span class="free">f</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">dvd</span> <span class="main">1</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"primitive <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> primitiveD<span class="main">[</span><span class="operator">OF</span> this list_gcd<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"coeffs <span class="free">f</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">folded</span> content_def<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"content <span class="free">f</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> primitive_prod_list<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">fs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>factorial_semiring<span class="main">,</span>semiring_Gcd<span class="main">,</span>normalization_semidom_multiplicative<span class="main">}</span> poly list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"primitive <span class="main">(</span>prod_list <span class="free">fs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> set <span class="free">fs</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"primitive <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="free">fs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">f'</span> <span class="skolem">fs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Cons.prems
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_unit <span class="main">(</span>content <span class="skolem">f'</span> <span class="main">*</span> content <span class="main">(</span>prod_list <span class="skolem">fs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> content_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> is_unit_mult_iff<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"content <span class="skolem">f'</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"content <span class="main">(</span>prod_list <span class="skolem">fs</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> Cons.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="skolem">f'</span> <span class="main">∨</span> <span class="skolem">f</span> <span class="main">∈</span> set <span class="skolem">fs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons.hyps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> irreducible_imp_primitive<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>idom<span class="main">,</span>semiring_gcd<span class="main">}</span> poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> irr<span class="main">:</span> <span class="quoted"><span class="quoted">"irreducible <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> deg<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">f</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"primitive <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> not<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?thesis</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">[:</span>content <span class="free">f</span><span class="main">:]</span> <span class="keyword1">dvd</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="main">[:</span>content <span class="free">f</span><span class="main">:]</span> <span class="main">*</span> primitive_part <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">note</span></span> Factorial_Ring.irreducibleD<span class="main">[</span><span class="operator">OF</span> irr this<span class="main">]</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"primitive_part <span class="free">f</span> <span class="keyword1">dvd</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> poly_dvd_1<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">f</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> deg <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> irreducible_primitive_connect<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>idom<span class="main">,</span>semiring_gcd<span class="main">}</span> poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cf<span class="main">:</span> <span class="quoted"><span class="quoted">"primitive <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="free">f</span> <span class="main">⟷</span> irreducible <span class="free">f</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">⟷</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> l<span class="main">:</span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> not_irreducibleE<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> l <span class="keyword1"><span class="command">have</span></span> deg<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">f</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> irreducible<span class="hidden">⇩</span><sub>d</sub>D<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> cf <span class="keyword1"><span class="command">have</span></span> f0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">dvd</span> <span class="main">1</span> <span class="main">⟹</span> False"</span></span> <span class="keyword1"><span class="command">using</span></span> deg <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>poly_dvd_1<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="keyword3"><span class="command">assume</span></span> fab<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">*</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">a</span> <span class="keyword1">dvd</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">b</span> <span class="keyword1">dvd</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> af<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="keyword1">dvd</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> bf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="keyword1">dvd</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> f0 <span class="keyword1"><span class="command">have</span></span> a0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> irreducible<span class="hidden">⇩</span><sub>d</sub>D<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> l<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span> af dvd_imp_degree_le<span class="main">[</span><span class="operator">OF</span> af f0<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">a</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> degree <span class="skolem">a</span> <span class="main">=</span> degree <span class="free">f</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> degree_smult_le irreducible<span class="hidden">⇩</span><sub>d</sub>_dvd_smult l le_antisym Nat.neq0_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">a</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> ac<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">[:</span><span class="skolem">c</span><span class="main">:]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> degree0_coeffs<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> fab<span class="main">[</span><span class="operator">unfolded</span> ac<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="keyword1">dvd</span> content <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> content_iff coeffs_smult<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> cf <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="keyword1">dvd</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="keyword1">dvd</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ac<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> a1 <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> dega<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">a</span> <span class="main">=</span> degree <span class="free">f</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> f0 degree_mult_eq<span class="main">[</span><span class="operator">OF</span> a0 b0<span class="main">]</span> fab <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">b</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> bc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> <span class="main">[:</span><span class="skolem">c</span><span class="main">:]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> degree0_coeffs<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> fab<span class="main">[</span><span class="operator">unfolded</span> bc<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="keyword1">dvd</span> content <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> content_iff coeffs_smult<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> cf <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="keyword1">dvd</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="keyword1">dvd</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bc<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> b1 <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> r<span class="main">:</span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> irreducible<span class="hidden">⇩</span><sub>d</sub>I<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">f</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>degree <span class="free">f</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f0</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="main">[:</span><span class="skolem">f0</span><span class="main">:]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> degree0_coeffs<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> cf<span class="main">[</span><span class="operator">unfolded</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"normalize <span class="skolem">f0</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f0</span> <span class="keyword1">dvd</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> normalize_1_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> r<span class="main">[</span><span class="operator">unfolded</span> f irreducible_const_poly_iff<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">g</span> <span class="skolem">h</span> <span class="keyword3"><span class="command">assume</span></span> deg_g<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">g</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> deg_gf<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">g</span> <span class="main">&lt;</span> degree <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fgh<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="skolem">g</span> <span class="main">*</span> <span class="skolem">h</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> r <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="keyword1">dvd</span> <span class="main">1</span> <span class="main">∨</span> <span class="skolem">h</span> <span class="keyword1">dvd</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> deg_g <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">h</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> poly_dvd_1<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> deg_gf<span class="main">[</span><span class="operator">unfolded</span> fgh<span class="main">]</span> degree_mult_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">g</span></span> <span class="quoted"><span class="skolem">h</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">h</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> deg_not_zero_imp_not_unit<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>idom_divide<span class="main">,</span>semidom_divide_unit_factor<span class="main">}</span> poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> deg_f<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">f</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_unit <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span>normalize <span class="free">f</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> deg_f degree_normalize <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"normalize <span class="free">f</span> <span class="main">≠</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_unit <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> normalize_1_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> content_pCons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"content <span class="main">(</span>pCons <span class="free">a</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> gcd <span class="free">a</span> <span class="main">(</span>content <span class="free">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>pCons <span class="skolem">c</span> <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> content_def cCons_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> content_field_poly<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>field<span class="main">,</span>semiring_gcd<span class="main">}</span> poly"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"content <span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">f</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">f</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dvd_field_iff is_unit_normalize<span class="main">)</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Gauss_Lemma">
<div class="head">
<h1>Theory Gauss_Lemma</h1>
</div>
<pre class="source"><span class="comment1">(*  
    Author:      René Thiemann 
                 Akihisa Yamada
    License:     BSD
*)</span>
<span class="comment1">(*TODO: Rename! *)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Gauss Lemma›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We formalized Gauss Lemma, that the content of a product of two polynomials $p$ and $q$
  is the product of the contents of $p$ and $q$. As a corollary we provide an algorithm
  to convert a rational factor of an integer polynomial into an integer factor.
  
  In contrast to the theory on unique factorization domains -- where Gauss Lemma is also proven 
   in a more generic setting --
  we are here in an executable setting and do not use the unspecified $some-gcd$ function.
  Moreover, there is a slight difference in the definition of content: in this theory it is only
  defined for integer-polynomials, whereas in the UFD theory, the content is defined for 
  polynomials in the fraction field.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Gauss_Lemma
<span class="keyword2"><span class="keyword">imports</span></span> 
  <span class="quoted">"<a href="../../HOL/HOL-Computational_Algebra/Primes.html">HOL-Computational_Algebra.Primes</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Computational_Algebra/Field_as_Ring.html">HOL-Computational_Algebra.Field_as_Ring</a>"</span>
  <a href="../Polynomial_Interpolation/Ring_Hom_Poly.html">Polynomial_Interpolation.Ring_Hom_Poly</a>
  <a href="Missing_Polynomial_Factorial.html">Missing_Polynomial_Factorial</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> primitive_part_alt_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">"primitive_part <span class="free">p</span> <span class="main">=</span> sdiv_poly <span class="free">p</span> <span class="main">(</span>content <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> primitive_part_def sdiv_poly_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">common_denom</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat list <span class="main">⇒</span> int <span class="main">×</span> int list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">common_denom</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> <span class="keyword1">let</span> 
     <span class="bound">nds</span> <span class="main">=</span> map quotient_of <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">;</span>
     <span class="bound">denom</span> <span class="main">=</span> list_lcm <span class="main">(</span>map snd <span class="bound">nds</span><span class="main">)</span><span class="main">;</span>
     <span class="bound">ints</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">n</span><span class="main">,</span><span class="bound">d</span><span class="main">)</span><span class="main">.</span> <span class="bound">n</span> <span class="main">*</span> <span class="bound">denom</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span> <span class="bound">nds</span>
   <span class="keyword1">in</span> <span class="main">(</span><span class="bound">denom</span><span class="main">,</span> <span class="bound">ints</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rat_to_int_poly</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat poly <span class="main">⇒</span> int <span class="main">×</span> int poly"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rat_to_int_poly</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> <span class="keyword1">let</span>
     <span class="bound">ais</span> <span class="main">=</span> coeffs <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">;</span>
     <span class="bound">d</span> <span class="main">=</span> fst <span class="main">(</span>common_denom <span class="bound">ais</span><span class="main">)</span>
   <span class="keyword1">in</span> <span class="main">(</span><span class="bound">d</span><span class="main">,</span> map_poly <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> quotient_of <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">q</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">p</span> <span class="main">*</span> <span class="bound">d</span> <span class="keyword1">div</span> <span class="bound">q</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rat_to_normalized_int_poly</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat poly <span class="main">⇒</span> rat <span class="main">×</span> int poly"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rat_to_normalized_int_poly</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="keyword1">else</span> <span class="keyword1">case</span> rat_to_int_poly <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">q</span><span class="main">)</span>
    <span class="main">⇒</span> <span class="main">(</span>of_int <span class="main">(</span>content <span class="bound">q</span><span class="main">)</span> <span class="main">/</span> of_int <span class="bound">s</span><span class="main">,</span> primitive_part <span class="bound">q</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rat_to_normalized_int_poly_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"rat_to_normalized_int_poly <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">p</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="keyword1">else</span> <span class="keyword1">case</span> rat_to_int_poly <span class="free">p</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">q</span><span class="main">)</span>
    <span class="main">⇒</span> <span class="keyword1">let</span> <span class="bound">c</span> <span class="main">=</span> content <span class="bound">q</span> <span class="keyword1">in</span> <span class="main">(</span>of_int <span class="bound">c</span> <span class="main">/</span> of_int <span class="bound">s</span><span class="main">,</span> sdiv_poly <span class="bound">q</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Let_def rat_to_normalized_int_poly_def primitive_part_alt_def <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">lemma</span></span> common_denom<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> cd<span class="main">:</span> <span class="quoted"><span class="quoted">"common_denom <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span><span class="free">dd</span><span class="main">,</span><span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> of_int <span class="bound">i</span> <span class="main">/</span> of_int <span class="free">dd</span><span class="main">)</span> <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">dd</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> rat_of_int <span class="main">(</span><span class="keyword1">case</span> quotient_of <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">n</span> <span class="main">*</span> <span class="free">dd</span> <span class="keyword1">div</span> <span class="bound">x</span><span class="main">)</span> <span class="main">/</span> rat_of_int <span class="free">dd</span> <span class="main">=</span> <span class="bound">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?nds</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map quotient_of <span class="free">xs</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">nds</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nds</span> <span class="main">=</span> <span class="var">?nds</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?denom</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"list_lcm <span class="main">(</span>map snd <span class="skolem">nds</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ints</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">n</span><span class="main">,</span><span class="bound">d</span><span class="main">)</span><span class="main">.</span> <span class="bound">n</span> <span class="main">*</span> <span class="free">dd</span> <span class="keyword1">div</span> <span class="bound">d</span><span class="main">)</span> <span class="skolem">nds</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> cd<span class="main">[</span><span class="operator">unfolded</span> common_denom_def Let_def<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> dd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dd</span> <span class="main">=</span> <span class="var">?denom</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">=</span> <span class="var">?ints</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> nds_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> dd0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dd</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dd 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> list_lcm_pos<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nds_def quotient_of_nonzero<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> quot<span class="main">:</span> <span class="quoted"><span class="quoted">"quotient_of <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">p</span><span class="main">,</span><span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">from</span></span> x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span><span class="main">,</span><span class="skolem">q</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">nds</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> nds_def <span class="keyword1"><span class="command">using</span></span> quot <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> set <span class="main">(</span>map snd <span class="skolem">nds</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">from</span></span> list_lcm<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="keyword1">dvd</span> <span class="free">dd</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dd <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rat_of_int <span class="main">(</span><span class="keyword1">case</span> quotient_of <span class="skolem">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">n</span> <span class="main">*</span> <span class="free">dd</span> <span class="keyword1">div</span> <span class="bound">x</span><span class="main">)</span> <span class="main">/</span> rat_of_int <span class="free">dd</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> quot split <span class="keyword1"><span class="command">unfolding</span></span> quotient_of_div<span class="main">[</span><span class="operator">OF</span> quot<span class="main">]</span>  
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">*</span> <span class="main">(</span><span class="free">dd</span> <span class="keyword1">div</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">dd</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> dvd_mult_div_cancel q <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rat_of_int <span class="main">(</span><span class="free">dd</span> <span class="keyword1">div</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> dd0 dvd_mult_div_cancel q <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"rat_of_int <span class="main">(</span><span class="skolem">p</span> <span class="main">*</span> <span class="free">dd</span> <span class="keyword1">div</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">/</span> rat_of_int <span class="free">dd</span> <span class="main">=</span> rat_of_int <span class="skolem">p</span> <span class="main">/</span> rat_of_int <span class="skolem">q</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> f1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> div_mult_swap mult_divide_mult_cancel_right of_int_mult q<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> main <span class="main">=</span> this
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> of_int <span class="bound">i</span> <span class="main">/</span> of_int <span class="free">dd</span><span class="main">)</span> <span class="free">ys</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ys map_map o_def nds_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> map_idI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> main<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rat_to_int_poly<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rat_to_int_poly <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="free">d</span><span class="main">,</span><span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> smult <span class="main">(</span>inverse <span class="main">(</span>of_int <span class="free">d</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map_poly of_int <span class="free">q</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> quotient_of <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">pa</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">pa</span> <span class="main">*</span> <span class="free">d</span> <span class="keyword1">div</span> <span class="bound">x</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="var">?f</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">[</span><span class="operator">unfolded</span> rat_to_int_poly_def Let_def<span class="main">]</span> 
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> cd<span class="main">:</span> <span class="quoted"><span class="quoted">"common_denom <span class="main">(</span>coeffs <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">d</span><span class="main">,</span><span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> map_poly <span class="skolem">f</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> f_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"common_denom <span class="main">(</span>coeffs <span class="free">p</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> common_denom<span class="main">[</span><span class="operator">OF</span> cd<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>  <span class="keyword2"><span class="keyword">and</span></span> 
    id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>coeffs <span class="free">p</span><span class="main">)</span> <span class="main">⟹</span> rat_of_int <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">/</span> rat_of_int <span class="free">d</span> <span class="main">=</span> <span class="bound">x</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> f0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"rat_of_int <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>coeff <span class="free">p</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> rat_of_int <span class="free">d</span> <span class="main">=</span> coeff <span class="free">p</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">using</span></span> id<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"coeff <span class="free">p</span> <span class="skolem">n</span>"</span></span><span class="main">]</span> f0 range_coeff <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"coeff <span class="free">p</span> <span class="skolem">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> smult <span class="main">(</span>inverse <span class="main">(</span>of_int <span class="free">d</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map_poly of_int <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> q smult_as_map_poly <span class="keyword1"><span class="command">using</span></span> id f0
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> poly_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> coeff_map_poly<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> content_ge_0_int<span class="main">:</span> <span class="quoted"><span class="quoted">"content <span class="free">p</span> <span class="main">≥</span> <span class="main">(</span><span class="main">0</span> <span class="main">::</span> int<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> content_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"coeffs <span class="free">p</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> abs_content_int<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int poly"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"abs <span class="main">(</span>content <span class="free">p</span><span class="main">)</span> <span class="main">=</span> content <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> content_ge_0_int<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> content_smult_int<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int poly"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"content <span class="main">(</span>smult <span class="free">a</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> abs <span class="free">a</span> <span class="main">*</span> content <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> normalize_non_0_smult<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> semiring_gcd<span class="main">)</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> smult <span class="bound">a</span> <span class="main">(</span>primitive_part <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">1</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"content <span class="free"><span class="free"><span class="free">p</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rat_to_normalized_int_poly<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rat_to_normalized_int_poly <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="free">d</span><span class="main">,</span><span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> smult <span class="free">d</span> <span class="main">(</span>map_poly of_int <span class="free">q</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> content <span class="free">q</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">q</span> <span class="main">=</span> degree <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> smult <span class="free">d</span> <span class="main">(</span>map_poly of_int <span class="free">q</span><span class="main">)</span> <span class="main">∧</span> <span class="free">d</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="free">p</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟶</span> content <span class="free">q</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> rat_to_normalized_int_poly_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_poly_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> p0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"rat_to_int_poly <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rat_of_int <span class="main">(</span>content <span class="skolem">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rat_of_int <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_poly rat_of_int <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> rat_to_int_poly<span class="main">[</span><span class="operator">OF</span> id<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> smult <span class="main">(</span>inverse <span class="var">?s</span><span class="main">)</span> <span class="main">(</span>map_poly of_int <span class="skolem">r</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_poly rat_of_int <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> p0 assms<span class="main">[</span><span class="operator">unfolded</span> rat_to_normalized_int_poly_def id split<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">=</span> <span class="var">?cr</span> <span class="main">/</span> <span class="var">?s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> primitive_part <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> content_times_primitive_part<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">,</span> <span class="operator">folded</span> q<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> qr<span class="main">:</span> <span class="quoted"><span class="quoted">"smult <span class="main">(</span>content <span class="skolem">r</span><span class="main">)</span> <span class="free">q</span> <span class="main">=</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"smult <span class="free">d</span> <span class="var">?q</span> <span class="main">=</span> smult <span class="main">(</span><span class="var">?cr</span> <span class="main">/</span> <span class="var">?s</span><span class="main">)</span> <span class="var">?q</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> d <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?cr</span> <span class="main">/</span> <span class="var">?s</span> <span class="main">=</span> <span class="var">?cr</span> <span class="main">*</span> inverse <span class="var">?s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> divide_inverse<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> inverse <span class="var">?s</span> <span class="main">*</span> <span class="var">?cr</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"smult <span class="main">(</span>inverse <span class="var">?s</span> <span class="main">*</span> <span class="var">?cr</span><span class="main">)</span> <span class="var">?q</span> <span class="main">=</span> smult <span class="main">(</span>inverse <span class="var">?s</span><span class="main">)</span> <span class="main">(</span>smult <span class="var">?cr</span> <span class="var">?q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"smult <span class="var">?cr</span> <span class="var">?q</span> <span class="main">=</span> map_poly of_int <span class="main">(</span>smult <span class="main">(</span>content <span class="skolem">r</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">hom_distribs</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> map_poly of_int <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> qr <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> pq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> smult <span class="free">d</span> <span class="var">?q</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> p p0 <span class="keyword1"><span class="command">have</span></span> r0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> content_eq_zero_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">]</span> content_ge_0_int<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">]</span> r0 <span class="keyword1"><span class="command">have</span></span> cr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?cr</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">with</span></span> s <span class="keyword1"><span class="command">have</span></span> d0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> d <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> content_primitive_part<span class="main">[</span><span class="operator">OF</span> r0<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> cq<span class="main">:</span> <span class="quoted"><span class="quoted">"content <span class="free">q</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> q <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">from</span></span> pq d0 cq <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> smult <span class="free">d</span> <span class="main">(</span>map_poly of_int <span class="free">q</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> content <span class="free">q</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">q</span> <span class="main">=</span> degree <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> p smult_as_map_poly
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> map_poly_map_poly<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> degree_map_poly<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> d<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> content_dvd_1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"content <span class="free">g</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"content <span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> semiring_gcd<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="keyword1">dvd</span> <span class="free">f</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">g</span> <span class="keyword1">dvd</span> <span class="free">f</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"content <span class="free">g</span> <span class="keyword1">dvd</span> content <span class="free">f</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> content_dvd_contentI<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹content <span class="free">f</span> <span class="main">=</span> <span class="main">1</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dvd_smult_int<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span> <span class="main">::</span> <span class="quoted">int</span> <span class="keyword2"><span class="keyword">assumes</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="keyword1">dvd</span> <span class="main">(</span>smult <span class="free">c</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"primitive_part <span class="free">q</span> <span class="keyword1">dvd</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> p0 <span class="main">=</span> this
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cp</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"smult <span class="free">c</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> p0 c <span class="keyword1"><span class="command">have</span></span> cp0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?cp</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> dvd <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> prod<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?cp</span> <span class="main">=</span> <span class="free">q</span> <span class="main">*</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> prod cp0 <span class="keyword1"><span class="command">have</span></span> q0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> r0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"content <span class="main">::</span> int poly <span class="main">⇒</span> int"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"primitive_part <span class="main">::</span> int poly <span class="main">⇒</span> int poly"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?pn</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> smult <span class="main">(</span><span class="var">?c</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="var">?n</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> cq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?c</span> <span class="free">q</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="keyword1"><span class="command">using</span></span> content_eq_zero_iff q0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> prod <span class="keyword1"><span class="command">have</span></span> id1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?cp</span> <span class="main">=</span> <span class="var">?pn</span> <span class="free">q</span> <span class="main">*</span> <span class="var">?pn</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> content_times_primitive_part <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted">content</span><span class="main">,</span> <span class="operator">unfolded</span> content_smult_int content_mult
    content_primitive_part<span class="main"><span class="main">[</span></span><span class="operator">OF</span> r0<span class="main"><span class="main">]</span></span> content_primitive_part<span class="main"><span class="main">[</span></span><span class="operator">OF</span> q0<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
    p0<span class="main">[</span><span class="operator">folded</span> content_eq_zero_iff<span class="main">]</span> c
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abs <span class="free">c</span> <span class="keyword1">dvd</span> <span class="var">?c</span> <span class="free">q</span> <span class="main">*</span> <span class="var">?c</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="keyword1">dvd</span> <span class="var">?c</span> <span class="free">q</span> <span class="main">*</span> <span class="var">?c</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?c</span> <span class="free">q</span> <span class="main">*</span> <span class="var">?c</span> <span class="skolem">r</span> <span class="main">=</span> <span class="free">c</span> <span class="main">*</span> <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?cp</span> <span class="main">=</span> <span class="var">?pn</span> <span class="free">q</span> <span class="main">*</span> <span class="var">?pn</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> smult <span class="main">(</span><span class="free">c</span> <span class="main">*</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span><span class="var">?n</span> <span class="free">q</span> <span class="main">*</span> <span class="var">?n</span> <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> id <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> content_mult content_times_primitive_part primitive_part_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?cp</span> <span class="main">=</span> smult <span class="free">c</span> <span class="main">(</span><span class="var">?n</span> <span class="free">q</span> <span class="main">*</span> smult <span class="skolem">d</span> <span class="main">(</span><span class="var">?n</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.commute<span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> map_poly_inj_zero_hom <span class="quoted"><span class="quoted">"<span class="main">(*)</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="var">?n</span> <span class="free">q</span> <span class="main">*</span> smult <span class="skolem">d</span> <span class="main">(</span><span class="var">?n</span> <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> id<span class="main">[</span><span class="operator">unfolded</span> smult_as_map_poly<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">c</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?n</span> <span class="free">q</span> <span class="keyword1">dvd</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> irreducible<span class="hidden">⇩</span><sub>d</sub>_primitive_part<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int poly"</span></span> <span class="comment1">(* can be relaxed but primitive_part_mult has bad type constraint *)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="main">(</span>primitive_part <span class="free">p</span><span class="main">)</span> <span class="main">⟷</span> irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="free">p</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">⟷</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> irreducible<span class="hidden">⇩</span><sub>d</sub>I<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> l<span class="main">:</span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> dpp<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span>primitive_part <span class="free">p</span><span class="main">)</span> <span class="main">=</span> degree <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span> <span class="skolem">r</span>
  <span class="keyword3"><span class="command">assume</span></span> deg<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">q</span> <span class="main">&lt;</span> degree <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">r</span> <span class="main">&lt;</span> degree <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="skolem">q</span> <span class="main">*</span> <span class="skolem">r</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> pp<span class="main">:</span> <span class="quoted"><span class="quoted">"primitive_part <span class="free">p</span> <span class="main">=</span> primitive_part <span class="skolem">q</span> <span class="main">*</span> primitive_part <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> primitive_part_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="main">(</span>primitive_part <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> reducible<span class="hidden">⇩</span><sub>d</sub>I<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"primitive_part <span class="skolem"><span class="skolem">q</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"primitive_part <span class="skolem"><span class="skolem">r</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> dpp<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> deg pp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> l <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="main">⟹</span> <span class="var">?l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> irreducible<span class="hidden">⇩</span><sub>d</sub>_smultI normalize_non_0_smult<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> irreducible<span class="hidden">⇩</span><sub>d</sub>_smult_int<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span> <span class="main">::</span> <span class="quoted">int</span> <span class="keyword2"><span class="keyword">assumes</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="main">(</span>smult <span class="free">c</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="free">p</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> irreducible<span class="hidden">⇩</span><sub>d</sub>_primitive_part<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"smult <span class="free">c</span> <span class="free">p</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> primitive_part_smult<span class="main">]</span> c
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add.inverse_inverse add.inverse_neutral c irreducible<span class="hidden">⇩</span><sub>d</sub>_smultI normalize_non_0_smult smult_1_left smult_minus_left<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> irreducible<span class="hidden">⇩</span><sub>d</sub>_primitive_part<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> irreducible<span class="hidden">⇩</span><sub>d</sub>_as_irreducible<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int poly"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="free">p</span> <span class="main">⟷</span> irreducible <span class="main">(</span>primitive_part <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> irreducible_primitive_connect<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"primitive_part <span class="free">p</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> irreducible<span class="hidden">⇩</span><sub>d</sub>_primitive_part<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> rat_to_int_factor_content_1<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int poly"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> cp<span class="main">:</span> <span class="quoted"><span class="quoted">"content <span class="free">p</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pgh<span class="main">:</span> <span class="quoted"><span class="quoted">"map_poly rat_of_int <span class="free">p</span> <span class="main">=</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"rat_to_normalized_int_poly <span class="free">g</span> <span class="main">=</span> <span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="free">rg</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"rat_to_normalized_int_poly <span class="free">h</span> <span class="main">=</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">sh</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="free">rg</span> <span class="main">*</span> <span class="free">sh</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rat_of_int"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rp</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_poly <span class="var">?r</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> p <span class="keyword1"><span class="command">have</span></span> rp0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?rp</span> <span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> pgh <span class="keyword1"><span class="command">have</span></span> g0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> h0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> rat_to_normalized_int_poly<span class="main">[</span><span class="operator">OF</span> g<span class="main">]</span> g0 
  <span class="keyword1"><span class="command">have</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">=</span> smult <span class="free">r</span> <span class="main">(</span><span class="var">?rp</span> <span class="free">rg</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> crg<span class="main">:</span> <span class="quoted"><span class="quoted">"content <span class="free">rg</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> rat_to_normalized_int_poly<span class="main">[</span><span class="operator">OF</span> h<span class="main">]</span> h0 
  <span class="keyword1"><span class="command">have</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">=</span> smult <span class="free">s</span> <span class="main">(</span><span class="var">?rp</span> <span class="free">sh</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> csh<span class="main">:</span> <span class="quoted"><span class="quoted">"content <span class="free">sh</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?irs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"inverse <span class="main">(</span><span class="free">r</span> <span class="main">*</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> r s <span class="keyword1"><span class="command">have</span></span> irs0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?irs</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rp</span> <span class="main">(</span><span class="free">rg</span> <span class="main">*</span> <span class="free">sh</span><span class="main">)</span> <span class="main">=</span> <span class="var">?rp</span> <span class="free">rg</span> <span class="main">*</span> <span class="var">?rp</span> <span class="free">sh</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">hom_distribs</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> smult <span class="var">?irs</span> <span class="main">(</span><span class="var">?rp</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> pgh g h <span class="keyword1"><span class="command">using</span></span> r s
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?rp</span> <span class="main">(</span><span class="free">rg</span> <span class="main">*</span> <span class="free">sh</span><span class="main">)</span> <span class="main">=</span> smult <span class="var">?irs</span> <span class="main">(</span><span class="var">?rp</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> rsZ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?irs</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> not<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?irs</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> irs'<span class="main">:</span> <span class="quoted"><span class="quoted">"quotient_of <span class="var">?irs</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span><span class="skolem">d</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">from</span></span> quotient_of_denom_pos<span class="main">[</span><span class="operator">OF</span> irs'<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">from</span></span> not quotient_of_div<span class="main">[</span><span class="operator">OF</span> irs'<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">≠</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> irs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?irs</span> <span class="main">=</span> <span class="var">?r</span> <span class="skolem">n</span> <span class="main">/</span> <span class="var">?r</span> <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> irs0 <span class="keyword1"><span class="command">have</span></span> n0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">≠</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">d</span> <span class="keyword1">dvd</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> content_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">d</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">,</span> <span class="operator">unfolded</span> cp<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> set <span class="main">(</span>coeffs <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">d</span> <span class="keyword1">dvd</span> <span class="skolem">c</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> c range_coeff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> coeff <span class="free">p</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> id<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> coeff <span class="bound">p</span> <span class="skolem">i</span>"</span></span><span class="main">,</span> 
      <span class="operator">unfolded</span> coeff_smult of_int_hom.coeff_map_poly_hom this<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> irs<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="skolem">n</span> <span class="main">/</span> <span class="var">?r</span> <span class="skolem">d</span> <span class="main">*</span> <span class="var">?r</span> <span class="skolem">c</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Ints_of_int<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="skolem">n</span> <span class="main">/</span> <span class="var">?r</span> <span class="skolem">d</span> <span class="main">*</span> <span class="var">?r</span> <span class="skolem">c</span> <span class="main">=</span> <span class="var">?r</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">*</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">/</span> <span class="var">?r</span> <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> inZ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">*</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">/</span> <span class="var">?r</span> <span class="skolem">d</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">have</span></span> cop<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">n</span> <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> quotient_of_coprime<span class="main"><span class="main">[</span></span><span class="operator">OF</span> irs'<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="comment1">(* now there comes tedious reasoning that `coprime n d` `¬ d dvd c` ` nc / d ∈ ℤ` yields a 
       contradiction *)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">prod</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">prod</span> <span class="main">=</span> <span class="var">?r</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">*</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">/</span> <span class="var">?r</span> <span class="skolem">d</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="skolem"><span class="skolem">d'</span></span> <span class="keyword2"><span class="keyword">where</span></span> quot<span class="main">:</span> <span class="quoted"><span class="quoted">"quotient_of <span class="skolem">prod</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n'</span><span class="main">,</span><span class="skolem">d'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">have</span></span> qr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> quotient_of <span class="main">(</span><span class="var">?r</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Rat.of_int_def quotient_of_int <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> quotient_of_denom_pos<span class="main">[</span><span class="operator">OF</span> quot<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d'</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">with</span></span> quotient_of_div<span class="main">[</span><span class="operator">OF</span> quot<span class="main">]</span> inZ<span class="main">[</span><span class="operator">folded</span> prod_def<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d'</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Ints_cases Rat.of_int_def old.prod.inject quot quotient_of_int<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> quotient_of_div<span class="main">[</span><span class="operator">OF</span> quot<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">prod</span> <span class="main">=</span> <span class="var">?r</span> <span class="skolem">n'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted">quotient_of</span><span class="main">,</span> <span class="operator">unfolded</span> prod_def rat_divide_code qr Let_def split<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Rat.normalize <span class="main">(</span><span class="skolem">n</span> <span class="main">*</span> <span class="skolem">c</span><span class="main">,</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n'</span><span class="main">,</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> normalize_crossproduct<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">≠</span> <span class="main">0</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">*</span> <span class="skolem">c</span>"</span></span> <span class="quoted"><span class="skolem">n'</span></span><span class="main">,</span> <span class="operator">unfolded</span> this<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">*</span> <span class="skolem">c</span> <span class="main">=</span> <span class="skolem">n'</span> <span class="main">*</span> <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">from</span></span> quotient_of_coprime<span class="main">[</span><span class="operator">OF</span> irs'<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">n</span> <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">with</span></span> id <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="keyword1">dvd</span> <span class="skolem">c</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> coprime_commute coprime_dvd_mult_right_iff dvd_triv_right<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> dc <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">irs</span></span> <span class="keyword2"><span class="keyword">where</span></span> irs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?irs</span> <span class="main">=</span> <span class="var">?r</span> <span class="skolem">irs</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Ints_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> id<span class="main">[</span><span class="operator">unfolded</span> irs<span class="main">,</span> <span class="operator">folded</span> <span class="dynamic"><span class="dynamic">hom_distribs</span></span><span class="main">,</span> <span class="operator">unfolded</span> of_int_poly_hom.eq_iff<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rg</span> <span class="main">*</span> <span class="free">sh</span> <span class="main">=</span> smult <span class="skolem">irs</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"content <span class="main">(</span><span class="free">rg</span> <span class="main">*</span> <span class="free">sh</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> content_mult crg csh <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> p content_smult_int cp<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abs <span class="skolem">irs</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"abs <span class="var">?irs</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> irs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> r s <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?irs</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> irs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">irs</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> p <span class="keyword3"><span class="command">show</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="free">rg</span> <span class="main">*</span> <span class="free">sh</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rat_to_int_factor_explicit<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int poly"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> pgh<span class="main">:</span> <span class="quoted"><span class="quoted">"map_poly rat_of_int <span class="free">p</span> <span class="main">=</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"rat_to_normalized_int_poly <span class="free">g</span> <span class="main">=</span> <span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="free">rg</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">r</span><span class="main">.</span> <span class="free">p</span> <span class="main">=</span> <span class="free">rg</span> <span class="main">*</span> smult <span class="main">(</span>content <span class="free">p</span><span class="main">)</span> <span class="bound">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> True
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> degree_monom_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rat_of_int"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rp</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_poly <span class="var">?r</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> primitive_part <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> content_times_primitive_part<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">,</span> <span class="operator">folded</span> q_def<span class="main">]</span> content_eq_zero_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> p
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> pq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> smult <span class="skolem">a</span> <span class="skolem">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> acp<span class="main">:</span> <span class="quoted"><span class="quoted">"content <span class="free">p</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">from</span></span> a pq p <span class="keyword1"><span class="command">have</span></span> ra<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="skolem">a</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> q0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> content_primitive_part<span class="main">[</span><span class="operator">OF</span> p<span class="main">,</span> <span class="operator">folded</span> q_def<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> cq<span class="main">:</span> <span class="quoted"><span class="quoted">"content <span class="skolem">q</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">sh</span></span> <span class="keyword2"><span class="keyword">where</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"rat_to_normalized_int_poly <span class="main">(</span>smult <span class="main">(</span>inverse <span class="main">(</span><span class="var">?r</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="free">h</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">sh</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> pgh<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> pq<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"smult <span class="main">(</span>inverse <span class="main">(</span><span class="var">?r</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span> ra
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rp</span> <span class="skolem">q</span> <span class="main">=</span> <span class="free">g</span> <span class="main">*</span> smult <span class="main">(</span>inverse <span class="main">(</span><span class="var">?r</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="free">h</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">hom_distribs</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> rat_to_int_factor_content_1<span class="main">[</span><span class="operator">OF</span> cq this g h q0<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> qrs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> <span class="free">rg</span> <span class="main">*</span> <span class="skolem">sh</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> acp <span class="keyword1"><span class="command">unfolding</span></span> pq qrs 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">sh</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rat_to_int_factor<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int poly"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> pgh<span class="main">:</span> <span class="quoted"><span class="quoted">"map_poly rat_of_int <span class="free">p</span> <span class="main">=</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">g'</span> <span class="bound">h'</span><span class="main">.</span> <span class="free">p</span> <span class="main">=</span> <span class="bound">g'</span> <span class="main">*</span> <span class="bound">h'</span> <span class="main">∧</span> degree <span class="bound">g'</span> <span class="main">=</span> degree <span class="free">g</span> <span class="main">∧</span> degree <span class="bound">h'</span> <span class="main">=</span> degree <span class="free">h</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">with</span></span> pgh <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">h</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> True degree_0 mult_hom.hom_zero mult_zero_left rat_to_normalized_int_poly<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> surj_pair<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">rg</span></span> <span class="keyword2"><span class="keyword">where</span></span> ri<span class="main">:</span> <span class="quoted"><span class="quoted">"rat_to_normalized_int_poly <span class="main">(</span>smult <span class="main">(</span><span class="main">1</span> <span class="main">/</span> of_int <span class="main">(</span>content <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">r</span><span class="main">,</span><span class="skolem">rg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">qh</span></span> <span class="keyword2"><span class="keyword">where</span></span> ri2<span class="main">:</span> <span class="quoted"><span class="quoted">"rat_to_normalized_int_poly <span class="free">h</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">q</span><span class="main">,</span><span class="skolem">qh</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"of_int_poly <span class="main">(</span>primitive_part <span class="free">p</span><span class="main">)</span> <span class="main">=</span> smult <span class="main">(</span><span class="main">1</span> <span class="main">/</span> of_int <span class="main">(</span>content <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="main">*</span> <span class="free">h</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> primitive_part_def pgh<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> smult_map_poly map_poly_map_poly o_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> map_poly_cong<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> content_dvd_coeffs div_by_0 dvd_mult_div_cancel floor_of_int nonzero_mult_div_cancel_left of_int_hom.hom_zero of_int_mult<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> smult <span class="main">(</span><span class="main">1</span> <span class="main">/</span> of_int <span class="main">(</span>content <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"of_int_poly <span class="main">(</span>primitive_part <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">…</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">note</span></span> main <span class="main">=</span> rat_to_int_factor_content_1<span class="main">[</span><span class="operator">OF</span> _ this ri ri2<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">OF</span> False<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> smult <span class="main">(</span>content <span class="free">p</span><span class="main">)</span> <span class="skolem">rg</span> <span class="main">*</span> <span class="skolem">qh</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> main<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> ri2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">qh</span> <span class="main">=</span> degree <span class="free">h</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> rat_to_normalized_int_poly<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> rat_to_normalized_int_poly<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> ri<span class="main">]</span> False
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span>smult <span class="main">(</span>content <span class="free">p</span><span class="main">)</span> <span class="skolem">rg</span><span class="main">)</span> <span class="main">=</span> degree <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rat_to_int_factor_normalized_int_poly<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat poly"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> pgh<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="free">g</span> <span class="main">*</span> <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"rat_to_normalized_int_poly <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">ip</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">g'</span> <span class="bound">h'</span><span class="main">.</span> <span class="free">ip</span> <span class="main">=</span> <span class="bound">g'</span> <span class="main">*</span> <span class="bound">h'</span> <span class="main">∧</span> degree <span class="bound">g'</span> <span class="main">=</span> degree <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> rat_to_normalized_int_poly<span class="main">[</span><span class="operator">OF</span> p<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> smult <span class="free">i</span> <span class="main">(</span>map_poly rat_of_int <span class="free">ip</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> p<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"smult <span class="main">(</span>inverse <span class="free">i</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> pgh<span class="main">]</span> i
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_poly rat_of_int <span class="free">ip</span> <span class="main">=</span> <span class="free">g</span> <span class="main">*</span> smult <span class="main">(</span>inverse <span class="free">i</span><span class="main">)</span> <span class="free">h</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> rat_to_int_factor<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* TODO: move *)</span>
<span class="keyword1"><span class="command">lemma</span></span> irreducible_smult <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> field"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"irreducible <span class="main">(</span>smult <span class="free">c</span> <span class="free">p</span><span class="main">)</span> <span class="main">⟷</span> irreducible <span class="free">p</span> <span class="main">∧</span> <span class="free">c</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> irreducible_mult_unit_left<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[:</span><span class="free">c</span><span class="main">:]</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A polynomial with integer coefficients is
   irreducible over the rationals, if it is irreducible over the integers.›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> irreducible<span class="hidden">⇩</span><sub>d</sub>_int_rat<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int poly"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="main">(</span>map_poly rat_of_int <span class="free">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> irreducible<span class="hidden">⇩</span><sub>d</sub>I<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> irreducible<span class="hidden">⇩</span><sub>d</sub>D<span class="main">[</span><span class="operator">OF</span> p<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> irr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">q</span> <span class="bound">r</span><span class="main">.</span> degree <span class="bound">q</span> <span class="main">&lt;</span> degree <span class="free">p</span> <span class="main">⟹</span> degree <span class="bound">r</span> <span class="main">&lt;</span> degree <span class="free">p</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">≠</span> <span class="bound">q</span> <span class="main">*</span> <span class="bound">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rat_of_int"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rp</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_poly <span class="var">?r</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> p <span class="keyword3"><span class="command">show</span></span> rp<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span><span class="var">?rp</span> <span class="free">p</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> p <span class="keyword1"><span class="command">have</span></span> p0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">g</span> <span class="skolem">h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat poly"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> deg<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">g</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">g</span> <span class="main">&lt;</span> degree <span class="main">(</span><span class="var">?rp</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">h</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">h</span> <span class="main">&lt;</span> degree <span class="main">(</span><span class="var">?rp</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> pgh<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?rp</span> <span class="free">p</span> <span class="main">=</span> <span class="skolem">g</span> <span class="main">*</span> <span class="skolem">h</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> rat_to_int_factor<span class="main">[</span><span class="operator">OF</span> pgh<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g'</span></span> <span class="skolem"><span class="skolem">h'</span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="skolem">g'</span> <span class="main">*</span> <span class="skolem">h'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dg<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">g'</span> <span class="main">=</span> degree <span class="skolem">g</span>"</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">h'</span> <span class="main">=</span> degree <span class="skolem">h</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> irr<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">g'</span></span> <span class="quoted"><span class="skolem">h'</span></span><span class="main">]</span> deg<span class="main">[</span><span class="operator">unfolded</span> dg<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> degree_mult_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">g'</span></span> <span class="quoted"><span class="skolem">h'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> p dg<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> irreducible<span class="hidden">⇩</span><sub>d</sub>_rat_to_normalized_int_poly<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> rp<span class="main">:</span> <span class="quoted"><span class="quoted">"rat_to_normalized_int_poly <span class="free">rp</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">ip</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> ip<span class="main">:</span> <span class="quoted"><span class="quoted">"irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="free">ip</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="free">rp</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> rat_to_normalized_int_poly<span class="main">[</span><span class="operator">OF</span> rp<span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> rp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rp</span> <span class="main">=</span> smult <span class="free">a</span> <span class="main">(</span>map_poly rat_of_int <span class="free">ip</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> irreducible<span class="hidden">⇩</span><sub>d</sub>_int_rat<span class="main">[</span><span class="operator">OF</span> ip<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dvd_content_dvd<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"content <span class="free">f</span> <span class="keyword1">dvd</span> content <span class="free">g</span>"</span></span> <span class="quoted"><span class="quoted">"primitive_part <span class="free">f</span> <span class="keyword1">dvd</span> primitive_part <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">dvd</span> <span class="free">g</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cf</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"content <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?nf</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"primitive_part <span class="free">f</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cg</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"content <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ng</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"primitive_part <span class="free">g</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">dvd</span> <span class="free">g</span> <span class="main">=</span> <span class="main">(</span>smult <span class="var">?cf</span> <span class="var">?nf</span> <span class="keyword1">dvd</span> smult <span class="var">?cg</span> <span class="var">?ng</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> content_times_primitive_part <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> dvd<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ch</span></span> <span class="keyword2"><span class="keyword">where</span></span> cg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?cg</span> <span class="main">=</span> <span class="var">?cf</span> <span class="main">*</span> <span class="skolem">ch</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> dvd<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">nh</span></span> <span class="keyword2"><span class="keyword">where</span></span> ng<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ng</span> <span class="main">=</span> <span class="var">?nf</span> <span class="main">*</span> <span class="skolem">nh</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">dvd</span> <span class="free">g</span> <span class="main">=</span> <span class="main">(</span>smult <span class="var">?cf</span> <span class="var">?nf</span> <span class="keyword1">dvd</span> smult <span class="var">?cg</span> <span class="var">?ng</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> content_times_primitive_part<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> content_times_primitive_part<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">g</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>smult <span class="var">?cf</span> <span class="var">?nf</span> <span class="keyword1">dvd</span> smult <span class="var">?cf</span> <span class="var">?nf</span> <span class="main">*</span> smult <span class="skolem">ch</span> <span class="skolem">nh</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> cg ng
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult.commute mult_smult_right smult_smult<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> dvd_triv_left<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sdiv_poly_smult<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> sdiv_poly <span class="main">(</span>smult <span class="free">c</span> <span class="free">f</span><span class="main">)</span> <span class="free">c</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> poly_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> coeff_sdiv_poly coeff_smult<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> primitive_part_smult_int<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int poly"</span></span> <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"primitive_part <span class="main">(</span>smult <span class="free">d</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> smult <span class="main">(</span>sgn <span class="free">d</span><span class="main">)</span> <span class="main">(</span>primitive_part <span class="free">f</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">f</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cf</span></span> <span class="keyword2"><span class="keyword">where</span></span> cf<span class="main">:</span> <span class="quoted"><span class="quoted">"content <span class="free">f</span> <span class="main">=</span> <span class="skolem">cf</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> False <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cf</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> poly_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> primitive_part_alt_def coeff_sdiv_poly content_smult_int coeff_smult cf<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>pos<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="main">|</span> <span class="main">(</span>neg<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">*</span> coeff <span class="free">f</span> <span class="skolem">n</span> <span class="keyword1">div</span> <span class="main">(</span><span class="main">¦</span><span class="free">d</span><span class="main">¦</span> <span class="main">*</span> <span class="skolem">cf</span><span class="main">)</span> <span class="main">=</span> sgn <span class="free">d</span> <span class="main">*</span> <span class="main">(</span>coeff <span class="free">f</span> <span class="skolem">n</span> <span class="keyword1">div</span> <span class="skolem">cf</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> neg
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span> <span class="main">=</span> <span class="main">(</span><span class="free">d</span> <span class="main">*</span> coeff <span class="free">f</span> <span class="skolem">n</span> <span class="keyword1">div</span> <span class="main">-</span> <span class="main">(</span><span class="free">d</span> <span class="main">*</span> <span class="skolem">cf</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span> <span class="main">(</span>coeff <span class="free">f</span> <span class="skolem">n</span> <span class="keyword1">div</span> <span class="skolem">cf</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">*</span> coeff <span class="free">f</span> <span class="skolem">n</span> <span class="keyword1">div</span> <span class="main">-</span> <span class="main">(</span><span class="free">d</span> <span class="main">*</span> <span class="skolem">cf</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span> <span class="main">(</span><span class="free">d</span> <span class="main">*</span> coeff <span class="free">f</span> <span class="skolem">n</span> <span class="keyword1">div</span> <span class="main">(</span><span class="free">d</span> <span class="main">*</span> <span class="skolem">cf</span><span class="main">)</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> dvd_div_neg<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> 0<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">*</span> coeff <span class="free">f</span> <span class="skolem">n</span> <span class="keyword1">div</span> <span class="main">(</span><span class="free">d</span> <span class="main">*</span> <span class="skolem">cf</span><span class="main">)</span> <span class="main">=</span> coeff <span class="free">f</span> <span class="skolem">n</span> <span class="keyword1">div</span> <span class="skolem">cf</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> gcd_smult_left<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gcd <span class="main">(</span>smult <span class="free">c</span> <span class="free">f</span><span class="main">)</span> <span class="free">g</span> <span class="main">=</span> gcd <span class="free">f</span> <span class="main">(</span><span class="free">g</span> <span class="main">::</span> <span class="tfree">'b</span> <span class="main">::</span> <span class="main">{</span>field_gcd<span class="main">}</span> poly<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"normalize <span class="free">c</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> dvd_field_iff is_unit_normalize<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Polynomial.normalize_smult gcd.commute gcd.left_commute gcd_left_idem gcd_self smult_1_left<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gcd_smult_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> gcd <span class="free">f</span> <span class="main">(</span>smult <span class="free">c</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> gcd <span class="free">f</span> <span class="main">(</span><span class="free">g</span> <span class="main">::</span> <span class="tfree">'b</span> <span class="main">::</span> <span class="main">{</span>field_gcd<span class="main">}</span> poly<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> gcd_smult_left<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gcd.commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> gcd_rat_to_gcd_int<span class="main">:</span> <span class="quoted"><span class="quoted">"gcd <span class="main">(</span>of_int_poly <span class="free">f</span> <span class="main">::</span> rat poly<span class="main">)</span> <span class="main">(</span>of_int_poly <span class="free">g</span><span class="main">)</span> <span class="main">=</span> 
  smult <span class="main">(</span>inverse <span class="main">(</span>of_int <span class="main">(</span>lead_coeff <span class="main">(</span>gcd <span class="free">f</span> <span class="free">g</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>of_int_poly <span class="main">(</span>gcd <span class="free">f</span> <span class="free">g</span><span class="main">)</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">g</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted">rat_of_int</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rp</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_poly <span class="var">?r</span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> gcd0<span class="main">:</span> <span class="quoted"><span class="quoted">"gcd <span class="free">f</span> <span class="free">g</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> lc0<span class="main">:</span> <span class="quoted"><span class="quoted">"lead_coeff <span class="main">(</span>gcd <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"inverse <span class="main">(</span><span class="var">?r</span> <span class="main">(</span>lead_coeff <span class="main">(</span>gcd <span class="free">f</span> <span class="free">g</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> gcdI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gcd <span class="free">f</span> <span class="free">g</span> <span class="keyword1">dvd</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> gcd <span class="free">f</span> <span class="free">g</span> <span class="main">*</span> <span class="skolem">h</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>    
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> smult_dvd<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ inv<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> f<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?rp</span></span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">hom_distribs</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gcd <span class="free">f</span> <span class="free">g</span> <span class="keyword1">dvd</span> <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">=</span> gcd <span class="free">f</span> <span class="free">g</span> <span class="main">*</span> <span class="skolem">h</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>    
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> smult_dvd<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ inv<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> g<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?rp</span></span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">hom_distribs</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">h</span><span class="main">)</span>    
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> dvd_smult<span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ch</span></span> <span class="skolem"><span class="skolem">ph</span></span> <span class="keyword2"><span class="keyword">where</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"rat_to_normalized_int_poly <span class="skolem">h</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ch</span><span class="main">,</span> <span class="skolem">ph</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">from</span></span> 3 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ff</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?rp</span> <span class="free">f</span> <span class="main">=</span> <span class="skolem">h</span> <span class="main">*</span> <span class="skolem">ff</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> 3 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">gg</span></span> <span class="keyword2"><span class="keyword">where</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?rp</span> <span class="free">g</span> <span class="main">=</span> <span class="skolem">h</span> <span class="main">*</span> <span class="skolem">gg</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> rat_to_int_factor_explicit<span class="main">[</span><span class="operator">OF</span> f h<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f'</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="skolem">ph</span> <span class="main">*</span> <span class="skolem">f'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> rat_to_int_factor_explicit<span class="main">[</span><span class="operator">OF</span> g h<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g'</span></span> <span class="keyword2"><span class="keyword">where</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">=</span> <span class="skolem">ph</span> <span class="main">*</span> <span class="skolem">g'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> f g <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ph</span> <span class="keyword1">dvd</span> gcd <span class="free">f</span> <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">gg</span></span> <span class="keyword2"><span class="keyword">where</span></span> gcd<span class="main">:</span> <span class="quoted"><span class="quoted">"gcd <span class="free">f</span> <span class="free">g</span> <span class="main">=</span> <span class="skolem">ph</span> <span class="main">*</span> <span class="skolem">gg</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> rat_to_normalized_int_poly<span class="main">[</span><span class="operator">OF</span> h<span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="keyword1">dvd</span> <span class="var">?rp</span> <span class="main">(</span>gcd <span class="free">f</span> <span class="free">g</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> gcd *<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> smult_dvd<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> *<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 4
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[:</span><span class="main">1</span><span class="main">:]</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> normalize_poly_def 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> poly_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Prime_Factorization">
<div class="head">
<h1>Theory Prime_Factorization</h1>
</div>
<pre class="source"><span class="comment1">(*  
    Author:      René Thiemann 
                 Akihisa Yamada
    License:     BSD
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Prime Factorization›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This theory contains not-completely naive algorithms to test primality
  and to perform prime factorization. More precisely, it corresponds to prime factorization
  algorithm A in Knuth's textbook \cite{Knuth}.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Prime_Factorization
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../../HOL/HOL-Computational_Algebra/Primes.html">HOL-Computational_Algebra.Primes</a>"</span>
  <a href="Missing_List.html">Missing_List</a>
  <a href="Missing_Multiset.html">Missing_Multiset</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definitions›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">primes_1000</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">primes_1000</span> <span class="main">=</span> <span class="main">[</span><span class="numeral">2</span><span class="main">,</span> <span class="numeral">3</span><span class="main">,</span> <span class="numeral">5</span><span class="main">,</span> <span class="numeral">7</span><span class="main">,</span> <span class="numeral">11</span><span class="main">,</span> <span class="numeral">13</span><span class="main">,</span> <span class="numeral">17</span><span class="main">,</span> <span class="numeral">19</span><span class="main">,</span> <span class="numeral">23</span><span class="main">,</span> <span class="numeral">29</span><span class="main">,</span> <span class="numeral">31</span><span class="main">,</span> <span class="numeral">37</span><span class="main">,</span> <span class="numeral">41</span><span class="main">,</span> <span class="numeral">43</span><span class="main">,</span> <span class="numeral">47</span><span class="main">,</span> <span class="numeral">53</span><span class="main">,</span> <span class="numeral">59</span><span class="main">,</span> <span class="numeral">61</span><span class="main">,</span> <span class="numeral">67</span><span class="main">,</span> <span class="numeral">71</span><span class="main">,</span> <span class="numeral">73</span><span class="main">,</span> <span class="numeral">79</span><span class="main">,</span> <span class="numeral">83</span><span class="main">,</span> <span class="numeral">89</span><span class="main">,</span> <span class="numeral">97</span><span class="main">,</span> <span class="numeral">101</span><span class="main">,</span>
  <span class="numeral">103</span><span class="main">,</span> <span class="numeral">107</span><span class="main">,</span> <span class="numeral">109</span><span class="main">,</span> <span class="numeral">113</span><span class="main">,</span> <span class="numeral">127</span><span class="main">,</span> <span class="numeral">131</span><span class="main">,</span> <span class="numeral">137</span><span class="main">,</span> <span class="numeral">139</span><span class="main">,</span> <span class="numeral">149</span><span class="main">,</span> <span class="numeral">151</span><span class="main">,</span> <span class="numeral">157</span><span class="main">,</span> <span class="numeral">163</span><span class="main">,</span> <span class="numeral">167</span><span class="main">,</span> <span class="numeral">173</span><span class="main">,</span> <span class="numeral">179</span><span class="main">,</span> <span class="numeral">181</span><span class="main">,</span> <span class="numeral">191</span><span class="main">,</span> <span class="numeral">193</span><span class="main">,</span> <span class="numeral">197</span><span class="main">,</span> <span class="numeral">199</span><span class="main">,</span>
  <span class="numeral">211</span><span class="main">,</span> <span class="numeral">223</span><span class="main">,</span> <span class="numeral">227</span><span class="main">,</span> <span class="numeral">229</span><span class="main">,</span> <span class="numeral">233</span><span class="main">,</span> <span class="numeral">239</span><span class="main">,</span> <span class="numeral">241</span><span class="main">,</span> <span class="numeral">251</span><span class="main">,</span> <span class="numeral">257</span><span class="main">,</span> <span class="numeral">263</span><span class="main">,</span> <span class="numeral">269</span><span class="main">,</span> <span class="numeral">271</span><span class="main">,</span> <span class="numeral">277</span><span class="main">,</span> <span class="numeral">281</span><span class="main">,</span> <span class="numeral">283</span><span class="main">,</span> <span class="numeral">293</span><span class="main">,</span> <span class="numeral">307</span><span class="main">,</span> <span class="numeral">311</span><span class="main">,</span> <span class="numeral">313</span><span class="main">,</span> <span class="numeral">317</span><span class="main">,</span>
  <span class="numeral">331</span><span class="main">,</span> <span class="numeral">337</span><span class="main">,</span> <span class="numeral">347</span><span class="main">,</span> <span class="numeral">349</span><span class="main">,</span> <span class="numeral">353</span><span class="main">,</span> <span class="numeral">359</span><span class="main">,</span> <span class="numeral">367</span><span class="main">,</span> <span class="numeral">373</span><span class="main">,</span> <span class="numeral">379</span><span class="main">,</span> <span class="numeral">383</span><span class="main">,</span> <span class="numeral">389</span><span class="main">,</span> <span class="numeral">397</span><span class="main">,</span> <span class="numeral">401</span><span class="main">,</span> <span class="numeral">409</span><span class="main">,</span> <span class="numeral">419</span><span class="main">,</span> <span class="numeral">421</span><span class="main">,</span> <span class="numeral">431</span><span class="main">,</span> <span class="numeral">433</span><span class="main">,</span> <span class="numeral">439</span><span class="main">,</span> <span class="numeral">443</span><span class="main">,</span>
  <span class="numeral">449</span><span class="main">,</span> <span class="numeral">457</span><span class="main">,</span> <span class="numeral">461</span><span class="main">,</span> <span class="numeral">463</span><span class="main">,</span> <span class="numeral">467</span><span class="main">,</span> <span class="numeral">479</span><span class="main">,</span> <span class="numeral">487</span><span class="main">,</span> <span class="numeral">491</span><span class="main">,</span> <span class="numeral">499</span><span class="main">,</span> <span class="numeral">503</span><span class="main">,</span> <span class="numeral">509</span><span class="main">,</span> <span class="numeral">521</span><span class="main">,</span> <span class="numeral">523</span><span class="main">,</span> <span class="numeral">541</span><span class="main">,</span> <span class="numeral">547</span><span class="main">,</span> <span class="numeral">557</span><span class="main">,</span> <span class="numeral">563</span><span class="main">,</span> <span class="numeral">569</span><span class="main">,</span> <span class="numeral">571</span><span class="main">,</span> <span class="numeral">577</span><span class="main">,</span>
  <span class="numeral">587</span><span class="main">,</span> <span class="numeral">593</span><span class="main">,</span> <span class="numeral">599</span><span class="main">,</span> <span class="numeral">601</span><span class="main">,</span> <span class="numeral">607</span><span class="main">,</span> <span class="numeral">613</span><span class="main">,</span> <span class="numeral">617</span><span class="main">,</span> <span class="numeral">619</span><span class="main">,</span> <span class="numeral">631</span><span class="main">,</span> <span class="numeral">641</span><span class="main">,</span> <span class="numeral">643</span><span class="main">,</span> <span class="numeral">647</span><span class="main">,</span> <span class="numeral">653</span><span class="main">,</span> <span class="numeral">659</span><span class="main">,</span> <span class="numeral">661</span><span class="main">,</span> <span class="numeral">673</span><span class="main">,</span> <span class="numeral">677</span><span class="main">,</span> <span class="numeral">683</span><span class="main">,</span> <span class="numeral">691</span><span class="main">,</span> <span class="numeral">701</span><span class="main">,</span>
  <span class="numeral">709</span><span class="main">,</span> <span class="numeral">719</span><span class="main">,</span> <span class="numeral">727</span><span class="main">,</span> <span class="numeral">733</span><span class="main">,</span> <span class="numeral">739</span><span class="main">,</span> <span class="numeral">743</span><span class="main">,</span> <span class="numeral">751</span><span class="main">,</span> <span class="numeral">757</span><span class="main">,</span> <span class="numeral">761</span><span class="main">,</span> <span class="numeral">769</span><span class="main">,</span> <span class="numeral">773</span><span class="main">,</span> <span class="numeral">787</span><span class="main">,</span> <span class="numeral">797</span><span class="main">,</span> <span class="numeral">809</span><span class="main">,</span> <span class="numeral">811</span><span class="main">,</span> <span class="numeral">821</span><span class="main">,</span> <span class="numeral">823</span><span class="main">,</span> <span class="numeral">827</span><span class="main">,</span> <span class="numeral">829</span><span class="main">,</span> <span class="numeral">839</span><span class="main">,</span>
  <span class="numeral">853</span><span class="main">,</span> <span class="numeral">857</span><span class="main">,</span> <span class="numeral">859</span><span class="main">,</span> <span class="numeral">863</span><span class="main">,</span> <span class="numeral">877</span><span class="main">,</span> <span class="numeral">881</span><span class="main">,</span> <span class="numeral">883</span><span class="main">,</span> <span class="numeral">887</span><span class="main">,</span> <span class="numeral">907</span><span class="main">,</span> <span class="numeral">911</span><span class="main">,</span> <span class="numeral">919</span><span class="main">,</span> <span class="numeral">929</span><span class="main">,</span> <span class="numeral">937</span><span class="main">,</span> <span class="numeral">941</span><span class="main">,</span> <span class="numeral">947</span><span class="main">,</span> <span class="numeral">953</span><span class="main">,</span> <span class="numeral">967</span><span class="main">,</span> <span class="numeral">971</span><span class="main">,</span> <span class="numeral">977</span><span class="main">,</span> <span class="numeral">983</span><span class="main">,</span>
  <span class="numeral">991</span><span class="main">,</span> <span class="numeral">997</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> primes_1000<span class="main">:</span> <span class="quoted"><span class="quoted">"primes_1000 <span class="main">=</span> filter prime <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="numeral">1001</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">next_candidates</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">×</span> nat list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next_candidates</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">(</span><span class="numeral">1001</span><span class="main">,</span>primes_1000<span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="numeral">30</span><span class="main">,</span> 
    <span class="main">[</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">+</span><span class="numeral">2</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">+</span><span class="numeral">6</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">+</span><span class="numeral">8</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">+</span><span class="numeral">12</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">+</span><span class="numeral">18</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">+</span><span class="numeral">20</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">+</span><span class="numeral">26</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">candidate_invariant</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">mod</span> <span class="numeral">30</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">11</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>tailrec<span class="main">)</span> <span class="entity">remove_prime_factor</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat list <span class="main">⇒</span> nat <span class="main">×</span> nat list "</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">remove_prime_factor</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> Divides.divmod_nat <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">n'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">⇒</span> 
     <span class="keyword1">if</span> <span class="bound">m</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="free">remove_prime_factor</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">n'</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> 
  
<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>tailrec<span class="main">)</span> <span class="entity">prime_factorization_nat_main</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat list <span class="main">⇒</span> nat list <span class="main">⇒</span> nat list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prime_factorization_nat_main</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="keyword1">of</span> 
     <span class="main">[]</span> <span class="main">⇒</span> 
       <span class="main">(</span><span class="keyword1">case</span> next_candidates <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">j</span><span class="main">,</span><span class="bound">is</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">prime_factorization_nat_main</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">j</span> <span class="bound">is</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span>
   <span class="main">|</span> <span class="main">(</span><span class="bound">i</span> <span class="main">#</span> <span class="bound">is</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> Divides.divmod_nat <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">i</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">n'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">⇒</span> 
       <span class="keyword1">if</span> <span class="bound">m</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="keyword1">case</span> remove_prime_factor <span class="bound">i</span> <span class="bound">n'</span> <span class="main">(</span><span class="bound">i</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span>
       <span class="keyword1">of</span> <span class="main">(</span><span class="bound">n'</span><span class="main">,</span><span class="bound">ps'</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">n'</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="bound">ps'</span> <span class="keyword1">else</span> 
         <span class="free">prime_factorization_nat_main</span> <span class="bound">n'</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="bound">is</span> <span class="bound">ps'</span>
       <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">*</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">then</span> <span class="free">prime_factorization_nat_main</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="bound">is</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span>
       <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>tailrec<span class="main">)</span> <span class="entity">prime_nat_main</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">prime_nat_main</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="keyword1">of</span> 
    <span class="main">[]</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> next_candidates <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">j</span><span class="main">,</span><span class="bound">is</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">prime_nat_main</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">j</span> <span class="bound">is</span><span class="main">)</span>
  <span class="main">|</span> <span class="main">(</span><span class="bound">i</span> <span class="main">#</span> <span class="bound">is</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">i</span> <span class="keyword1">dvd</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">then</span> <span class="bound">i</span> <span class="main">≥</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">*</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">then</span> <span class="free">prime_nat_main</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="bound">is</span>
    <span class="keyword1">else</span> True<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">prime_nat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">prime_nat</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="keyword1">then</span> False <span class="keyword1">else</span> <span class="comment1">― ‹TODO: integrate precomputed map›</span>
     <span class="keyword1">case</span> next_candidates <span class="main">0</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">j</span><span class="main">,</span><span class="bound">is</span><span class="main">)</span> <span class="main">⇒</span> prime_nat_main <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">j</span> <span class="bound">is</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">prime_factorization_nat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">prime_factorization_nat</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> rev <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="keyword1">then</span> <span class="main">[]</span> <span class="keyword1">else</span> 
    <span class="keyword1">case</span> next_candidates <span class="main">0</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">j</span><span class="main">,</span><span class="bound">is</span><span class="main">)</span> <span class="main">⇒</span> prime_factorization_nat_main <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">j</span> <span class="bound">is</span> <span class="main">[]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">divisors_nat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat list"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">divisors_nat</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">[]</span> <span class="keyword1">else</span> 
     remdups_adj <span class="main">(</span>sort <span class="main">(</span>map prod_list <span class="main">(</span>subseqs <span class="main">(</span>prime_factorization_nat <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">divisors_int_pos</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> int list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">divisors_int_pos</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> map int <span class="main">(</span>divisors_nat <span class="main">(</span>nat <span class="main">(</span>abs <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">divisors_int</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> int list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">divisors_int</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="keyword1">let</span> <span class="bound">xs</span> <span class="main">=</span> divisors_int_pos <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">in</span> <span class="bound">xs</span> <span class="main">@</span> <span class="main">(</span>map uminus <span class="bound">xs</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Proofs›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> remove_prime_factor<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"remove_prime_factor <span class="free">i</span> <span class="free">n</span> <span class="free">ps</span> <span class="main">=</span> <span class="main">(</span><span class="free">m</span><span class="main">,</span><span class="free">qs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">rs</span><span class="main">.</span> <span class="free">qs</span> <span class="main">=</span> <span class="bound">rs</span> <span class="main">@</span> <span class="free">ps</span> <span class="main">∧</span> <span class="free">n</span> <span class="main">=</span> <span class="free">m</span> <span class="main">*</span> prod_list <span class="bound">rs</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">i</span> <span class="keyword1">dvd</span> <span class="free">m</span> <span class="main">∧</span> set <span class="bound">rs</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> res n
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">n</span> <span class="skolem">ps</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="skolem"><span class="skolem">mo</span></span> <span class="keyword2"><span class="keyword">where</span></span> dm<span class="main">:</span> <span class="quoted"><span class="quoted">"Divides.divmod_nat <span class="skolem">n</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n'</span><span class="main">,</span><span class="skolem">mo</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">hence</span></span> n'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span> <span class="main">=</span> <span class="skolem">n</span> <span class="keyword1">div</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> mo<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">mo</span> <span class="main">=</span> <span class="skolem">n</span> <span class="keyword1">mod</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> divmod_nat_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> less<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> remove_prime_factor.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main"><span class="main">]</span></span> dm<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> <span class="skolem">mo</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> remove_prime_factor <span class="free">i</span> <span class="skolem">n'</span> <span class="main">(</span><span class="free">i</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">m</span><span class="main">,</span> <span class="free">qs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> less<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> n' i <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> less<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">mo</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> mo n' <span class="keyword1"><span class="command">have</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="skolem">n'</span> <span class="main">*</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> n'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> True res <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"remove_prime_factor <span class="free">i</span> <span class="skolem">n'</span> <span class="main">(</span><span class="free">i</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">m</span><span class="main">,</span><span class="free">qs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> IH<span class="main">[</span><span class="operator">OF</span> this n'<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      <span class="quoted"><span class="quoted">"<span class="free">qs</span> <span class="main">=</span> <span class="skolem">rs</span> <span class="main">@</span> <span class="free">i</span> <span class="main">#</span> <span class="skolem">ps</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span> <span class="main">=</span> <span class="free">m</span> <span class="main">*</span> prod_list <span class="skolem">rs</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">i</span> <span class="keyword1">dvd</span> <span class="free">m</span> <span class="main">∧</span> set <span class="skolem">rs</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">rs</span></span></span> <span class="main"><span class="main"><span class="main">@</span></span></span> <span class="main"><span class="main"><span class="main">[</span></span></span><span class="free"><span class="free"><span class="free">i</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> n<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> mo <span class="keyword1"><span class="command">have</span></span> i_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">i</span> <span class="keyword1">dvd</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> False res <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">qs</span> <span class="main">=</span> <span class="skolem">ps</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> id <span class="keyword1"><span class="command">using</span></span> i_n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> prime_sqrtI<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> small<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">j</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="bound">j</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">i</span> <span class="main">*</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"prime <span class="main">(</span><span class="free">n</span><span class="main">::</span>nat<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> prime_nat_iff
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI impI allI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
  <span class="keyword3"><span class="command">assume</span></span> jn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> jn <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> njk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="skolem">j</span> <span class="main">*</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> jn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dvd_imp_le jn neq0_conv not_less0<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> <span class="skolem">j</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?thesis</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> njk n <span class="keyword1"><span class="command">have</span></span> j1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">∧</span> <span class="skolem">j</span> <span class="main">≠</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">j</span> <span class="bound">k</span><span class="main">.</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="bound">j</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">∧</span> <span class="free">n</span> <span class="main">=</span> <span class="bound">j</span> <span class="main">*</span> <span class="bound">k</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> njk <span class="keyword1"><span class="command">using</span></span> j1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">k</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">j</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> j1 njk False<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="main">(</span><span class="operator">metis</span> Suc_lessI mult_0_right neq0_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> j1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> jk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> njk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="skolem">j</span> <span class="main">*</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> small<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> ji<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≥</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">from</span></span> mult_mono<span class="main">[</span><span class="operator">OF</span> ji ji<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">*</span> <span class="free">i</span> <span class="main">≤</span> <span class="skolem">j</span> <span class="main">*</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> i <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">*</span> <span class="skolem">j</span> <span class="main">&gt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> njk<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> jk <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> candidate_invariant_0<span class="main">:</span> <span class="quoted"><span class="quoted">"candidate_invariant <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> candidate_invariant_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> next_candidates<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"next_candidates <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="free">m</span><span class="main">,</span><span class="free">ps</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"candidate_invariant <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"candidate_invariant <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"sorted <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> prime <span class="bound">i</span> <span class="main">∧</span> <span class="free">n</span> <span class="main">≤</span> <span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">m</span><span class="main">}</span> <span class="main">⊆</span> set <span class="free">ps</span>"</span></span> 
    <span class="quoted"><span class="quoted">"set <span class="free">ps</span> <span class="main">⊆</span> <span class="main">{</span><span class="numeral">2</span><span class="main">..}</span> <span class="main">∩</span> <span class="main">{</span><span class="free">n</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> candidate_invariant_def
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> res<span class="main">[</span><span class="operator">unfolded</span> next_candidates_def<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> n <span class="main">=</span> n<span class="main">[</span><span class="operator">unfolded</span> candidate_invariant_def<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">m</span> <span class="keyword1">mod</span> <span class="numeral">30</span> <span class="main">=</span> <span class="numeral">11</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> res n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sorted <span class="free">ps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> res n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> primes_1000_def sorted2_simps <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> sorted.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="free">ps</span> <span class="main">⊆</span> <span class="main">{</span><span class="numeral">2</span><span class="main">..}</span> <span class="main">∩</span> <span class="main">{</span><span class="free">n</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> res n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> primes_1000_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">ps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> res n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> primes_1000_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> res n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> primes_1000_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> res <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> prime <span class="bound">i</span> <span class="main">∧</span> <span class="free">n</span> <span class="main">≤</span> <span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">m</span><span class="main">}</span> <span class="main">⊆</span> set <span class="free">ps</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="numeral">1001</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">=</span> primes_1000"</span></span> <span class="keyword1"><span class="command">using</span></span> res <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> * True primes_1000 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="keyword1">mod</span> <span class="numeral">30</span> <span class="main">=</span> <span class="numeral">11</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="free">n</span> <span class="main">+</span> <span class="numeral">30</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">=</span> <span class="main">[</span><span class="free">n</span><span class="main">,</span><span class="free">n</span><span class="main">+</span><span class="numeral">2</span><span class="main">,</span><span class="free">n</span><span class="main">+</span><span class="numeral">6</span><span class="main">,</span><span class="free">n</span><span class="main">+</span><span class="numeral">8</span><span class="main">,</span><span class="free">n</span><span class="main">+</span><span class="numeral">12</span><span class="main">,</span><span class="free">n</span><span class="main">+</span><span class="numeral">18</span><span class="main">,</span><span class="free">n</span><span class="main">+</span><span class="numeral">20</span><span class="main">,</span><span class="free">n</span><span class="main">+</span><span class="numeral">26</span><span class="main">]</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> res n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">+</span> <span class="numeral">30</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∉</span> set <span class="free">ps</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> n * <span class="keyword1"><span class="command">have</span></span> i11<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≥</span> <span class="numeral">11</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="skolem">i</span> <span class="main">-</span> <span class="free">n</span>"</span></span> 
      <span class="keyword1"><span class="command">have</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="free">n</span> <span class="main">+</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">≤</span> <span class="skolem">i</span>›</span></span> j_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="keyword1">mod</span> <span class="numeral">30</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="numeral">30</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">≤</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> j_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">j</span> <span class="keyword1">mod</span> <span class="numeral">30</span> <span class="main">+</span> <span class="free">n</span> <span class="keyword1">mod</span> <span class="numeral">30</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="numeral">30</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">mod_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">j</span> <span class="keyword1">mod</span> <span class="numeral">30</span> <span class="main">+</span> <span class="numeral">11</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="numeral">30</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> i30<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="keyword1">mod</span> <span class="numeral">30</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">j</span> <span class="keyword1">mod</span> <span class="numeral">30</span> <span class="main">+</span> <span class="numeral">11</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="numeral">30</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="numeral">30</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 112<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">11</span> <span class="keyword1">mod</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="numeral">11</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="numeral">2</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mod_add_cong<span class="main">)</span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command">with</span></span> arg_cong <span class="main">[</span><span class="operator">OF</span> i30<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="keyword1">mod</span> <span class="numeral">2</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">j</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="numeral">2</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">mod_simps</span></span> mod_mod_cancel <span class="main"><span class="main">[</span></span><span class="operator">OF</span> 2<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">3</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="numeral">30</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 113<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">11</span> <span class="keyword1">mod</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="numeral">11</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="numeral">3</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="numeral">3</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mod_add_cong<span class="main">)</span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command">with</span></span> arg_cong <span class="main">[</span><span class="operator">OF</span> i30<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="keyword1">mod</span> <span class="numeral">3</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="keyword1">mod</span> <span class="numeral">3</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">j</span> <span class="keyword1">mod</span> <span class="numeral">3</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="numeral">3</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">mod_simps</span></span> mod_mod_cancel <span class="main"><span class="main">[</span></span><span class="operator">OF</span> 3<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">5</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="numeral">30</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 115<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">11</span> <span class="keyword1">mod</span> <span class="main">(</span><span class="numeral">5</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="numeral">11</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="numeral">5</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="numeral">5</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mod_add_cong<span class="main">)</span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command">with</span></span> arg_cong <span class="main">[</span><span class="operator">OF</span> i30<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="keyword1">mod</span> <span class="numeral">5</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="keyword1">mod</span> <span class="numeral">5</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">j</span> <span class="keyword1">mod</span> <span class="numeral">5</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="numeral">5</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">mod_simps</span></span> mod_mod_cancel <span class="main"><span class="main">[</span></span><span class="operator">OF</span> 5<span class="main"><span class="main">]</span></span><span class="main">)</span>
      
      <span class="keyword1"><span class="command">from</span></span> n *<span class="main">(</span>2-<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> ps i<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> 
        <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span><span class="numeral">3</span><span class="main">,</span><span class="numeral">5</span><span class="main">,</span><span class="numeral">7</span><span class="main">,</span><span class="numeral">9</span><span class="main">,</span><span class="numeral">11</span><span class="main">,</span><span class="numeral">13</span><span class="main">,</span><span class="numeral">15</span><span class="main">,</span><span class="numeral">17</span><span class="main">,</span><span class="numeral">19</span><span class="main">,</span><span class="numeral">21</span><span class="main">,</span><span class="numeral">23</span><span class="main">,</span><span class="numeral">25</span><span class="main">,</span><span class="numeral">27</span><span class="main">,</span><span class="numeral">29</span><span class="main">}</span> <span class="main">∨</span> <span class="skolem">j</span> <span class="main">∈</span> <span class="main">{</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">10</span><span class="main">,</span><span class="numeral">16</span><span class="main">,</span><span class="numeral">22</span><span class="main">,</span><span class="numeral">28</span><span class="main">}</span> <span class="main">∨</span> <span class="skolem">j</span> <span class="main">∈</span> <span class="main">{</span><span class="numeral">14</span><span class="main">,</span><span class="numeral">24</span><span class="main">}</span>"</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="var">?j2</span> <span class="main">∨</span> <span class="skolem">j</span> <span class="main">∈</span> <span class="var">?j3</span> <span class="main">∨</span> <span class="skolem">j</span> <span class="main">∈</span> <span class="var">?j5</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="operator">presburger</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="var">?j2</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> i11 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="keyword1">dvd</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
        <span class="keyword1"><span class="command">with</span></span> *<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">unfolding</span></span> prime_nat_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="var">?j3</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="keyword1">mod</span> <span class="numeral">3</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> 3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="keyword1">mod</span> <span class="numeral">3</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> i11 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">3</span> <span class="keyword1">dvd</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> <span class="numeral">3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
        <span class="keyword1"><span class="command">with</span></span> *<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">unfolding</span></span> prime_nat_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="var">?j5</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="keyword1">mod</span> <span class="numeral">5</span> <span class="main">=</span> <span class="numeral">4</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> 5 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="keyword1">mod</span> <span class="numeral">5</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> i11 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">5</span> <span class="keyword1">dvd</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> <span class="numeral">5</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
        <span class="keyword1"><span class="command">with</span></span> *<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">unfolding</span></span> prime_nat_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> m ps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> prime_test_iterate2<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> small<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">j</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">i</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="bound">j</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> odd<span class="main">:</span> <span class="quoted"><span class="quoted">"odd <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≥</span> <span class="numeral">3</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≥</span> <span class="numeral">3</span>"</span></span> <span class="quoted"><span class="quoted">"odd <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> mod<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">i</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">j</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">assume</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> small<span class="main">[</span><span class="operator">OF</span> j<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≥</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">with</span></span> dvd mod <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&gt;</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="free">j</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> j <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">=</span> Suc <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> i <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"even <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> dvd j<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dvd_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> odd <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prime_divisor<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">p</span> <span class="main">::</span> nat<span class="main">.</span> prime <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="keyword1">dvd</span> <span class="free">j</span> <span class="main">∧</span> <span class="bound">p</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?pf</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"prime_factors <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> prime_factorization_nat<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">p</span><span class="main">∈</span><span class="var">?pf</span><span class="main">.</span> <span class="bound">p</span> <span class="main">^</span> multiplicity <span class="bound">p</span> <span class="free">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">≥</span> <span class="numeral">2</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?pf</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="var">?pf</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
  <span class="keyword1"><span class="command">hence</span></span> pr<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">rem</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rem</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">p</span><span class="main">∈</span><span class="var">?pf</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span><span class="main">.</span> <span class="bound">p</span> <span class="main">^</span> multiplicity <span class="bound">p</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> p <span class="keyword1"><span class="command">have</span></span> mult<span class="main">:</span> <span class="quoted"><span class="quoted">"multiplicity <span class="skolem">p</span> <span class="free">j</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prime_factors_multiplicity<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?pf</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">p</span><span class="main">∈</span><span class="var">?pf</span><span class="main">.</span> <span class="bound">p</span> <span class="main">^</span> multiplicity <span class="bound">p</span> <span class="free">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?pf</span> <span class="main">=</span> <span class="main">(</span>insert <span class="skolem">p</span> <span class="main">(</span><span class="var">?pf</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="bound">p</span><span class="main">∈</span>insert <span class="skolem">p</span> <span class="main">(</span><span class="var">?pf</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">^</span> multiplicity <span class="bound">p</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> 
    <span class="skolem">p</span> <span class="main">^</span> multiplicity <span class="skolem">p</span> <span class="free">j</span> <span class="main">*</span> <span class="skolem">rem</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> rem_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> prod.insert<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">^</span> <span class="main">(</span>multiplicity <span class="skolem">p</span> <span class="free">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">rem</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mult 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"multiplicity <span class="skolem">p</span> <span class="free">j</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> pj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="keyword1">dvd</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dvd_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> pj pr <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prime_nat_main<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ni</span> <span class="main">=</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span><span class="free">i</span><span class="main">,</span><span class="free">is</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≥</span> <span class="numeral">2</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">≥</span> <span class="numeral">2</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span> <span class="bound">j</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="main">(</span><span class="bound">j</span> <span class="keyword1">dvd</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span> <span class="bound">j</span><span class="main">.</span> <span class="free">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">jj</span> <span class="main">⟹</span> prime <span class="bound">j</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">∈</span> set <span class="free">is</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">jj</span> <span class="main">⟹</span>
  sorted <span class="free">is</span> <span class="main">⟹</span> distinct <span class="free">is</span> <span class="main">⟹</span> candidate_invariant <span class="free">jj</span> <span class="main">⟹</span> set <span class="free">is</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">jj</span><span class="main">}</span> <span class="main">⟹</span> 
  <span class="free">res</span> <span class="main">=</span> prime_nat_main <span class="free">n</span> <span class="free">jj</span> <span class="free">is</span> <span class="main">⟹</span> 
  <span class="free">res</span> <span class="main">=</span> prime <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ni</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span>"</span></span> <span class="quoted"><span class="free">jj</span></span> <span class="quoted"><span class="free">res</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> wf_induct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 
    wf_measures<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[</span></span><span class="main"><span class="main">λ</span></span> <span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">n</span></span><span class="main"><span class="main">,</span></span><span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">,</span></span><span class="bound"><span class="bound">is</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">n</span></span> <span class="main"><span class="main">-</span></span> <span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">,</span></span> <span class="main"><span class="main">λ</span></span> <span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">n</span></span><span class="main"><span class="main">,</span></span><span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">,</span></span><span class="bound"><span class="bound">is</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="keyword1"><span class="keyword1">if</span></span> <span class="bound"><span class="bound">is</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">[]</span></span> <span class="keyword1"><span class="keyword1">then</span></span> <span class="main"><span class="main">1</span></span> <span class="keyword1"><span class="keyword1">else</span></span> <span class="main"><span class="main">0</span></span><span class="main"><span class="main">]</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">ni</span> <span class="skolem">n</span> <span class="skolem">i</span> <span class="quoted">"<span class="skolem">is</span>"</span> <span class="skolem">jj</span> <span class="skolem">res</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> 1<span class="main">(</span>12<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 1<span class="main">(</span>3-4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i2<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> 1<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">j</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="skolem">i</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="bound">j</span> <span class="keyword1">dvd</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> 1<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> ijj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">jj</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">note</span></span> sort_dist <span class="main">=</span> 1<span class="main">(</span>8-9<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted">"is"</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">j</span><span class="main">.</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="skolem">jj</span> <span class="main">⟹</span> prime <span class="bound">j</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">∈</span> set <span class="skolem">is</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> 1<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> simps <span class="main">=</span> prime_nat_main.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">jj</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> 1<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">unfolded</span> 1<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">OF</span> _ refl<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">jjj</span></span> <span class="skolem"><span class="skolem">iis</span></span> <span class="keyword2"><span class="keyword">where</span></span> can<span class="main">:</span> <span class="quoted"><span class="quoted">"next_candidates <span class="skolem">jj</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">jjj</span><span class="main">,</span><span class="skolem">iis</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">from</span></span> res<span class="main">[</span><span class="operator">unfolded</span> simps<span class="main">,</span> <span class="operator">unfolded</span> Nil can split<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">res</span> <span class="main">=</span> prime_nat_main <span class="skolem">n</span> <span class="skolem">jjj</span> <span class="skolem">iis</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> next_candidates<span class="main">[</span><span class="operator">OF</span> can 1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span>10<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> can<span class="main">:</span> 
      <span class="quoted"><span class="quoted">"sorted <span class="skolem">iis</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">iis</span>"</span></span> <span class="quoted"><span class="quoted">"candidate_invariant <span class="skolem">jjj</span>"</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> prime <span class="bound">i</span> <span class="main">∧</span> <span class="skolem">jj</span> <span class="main">≤</span> <span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">jjj</span><span class="main">}</span> <span class="main">⊆</span> set <span class="skolem">iis</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">iis</span> <span class="main">⊆</span> <span class="main">{</span><span class="numeral">2</span><span class="main">..}</span> <span class="main">∩</span> <span class="main">{</span><span class="skolem">jj</span><span class="main">..&lt;</span><span class="skolem">jjj</span><span class="main">}</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">iis</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">jj</span> <span class="main">&lt;</span> <span class="skolem">jjj</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">from</span></span> can ijj <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">jjj</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> IH<span class="main">[</span><span class="operator">OF</span> _ i n dvd _ this can<span class="main"><span class="main">(</span></span>1-3<span class="main"><span class="main">)</span></span> _ res<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> IH<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Nil can<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> ix<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> xj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">jjj</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> px<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"is"</span><span class="main">[</span><span class="operator">OF</span> ix _ px<span class="main">]</span> Nil <span class="keyword1"><span class="command">have</span></span> jx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">jj</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">with</span></span> can<span class="main">(</span>4<span class="main">)</span> xj px <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">iis</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> can<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> ijj<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">i'</span> <span class="skolem">iis</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> res<span class="main">[</span><span class="operator">unfolded</span> simps<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">res</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">i'</span> <span class="keyword1">dvd</span> <span class="skolem">n</span> <span class="keyword1">then</span> <span class="skolem">n</span> <span class="main">≤</span> <span class="skolem">i'</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="skolem">i'</span> <span class="main">*</span> <span class="skolem">i'</span> <span class="main">≤</span> <span class="skolem">n</span> <span class="keyword1">then</span> prime_nat_main <span class="skolem">n</span> <span class="skolem">jj</span> <span class="skolem">iis</span> <span class="keyword1">else</span> True<span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> 1<span class="main">(</span>11<span class="main">)</span> Cons <span class="keyword1"><span class="command">have</span></span> iis<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">iis</span> <span class="main">⊆</span> <span class="main">{</span><span class="skolem">i</span><span class="main">..&lt;</span><span class="skolem">jj</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">i'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&lt;</span> <span class="skolem">jj</span>"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i'</span> <span class="main">≤</span> <span class="skolem">jj</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> sort_dist <span class="keyword1"><span class="command">have</span></span> sd_iis<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="skolem">iis</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">iis</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">∉</span> set <span class="skolem">iis</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Cons<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> sort_dist<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">iis</span> <span class="main">⊆</span> <span class="main">{</span><span class="skolem">i'</span><span class="main">..}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Cons<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> iis <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">iis</span> <span class="main">⊆</span> <span class="main">{</span><span class="skolem">i'</span><span class="main">..&lt;</span><span class="skolem">jj</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">∉</span> set <span class="skolem">iis</span>›</span></span>  <span class="keyword1"><span class="command">have</span></span> iis<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">iis</span> <span class="main">⊆</span> <span class="main">{</span>Suc <span class="skolem">i'</span><span class="main">..&lt;</span><span class="skolem">jj</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">x</span> <span class="main">=</span> <span class="skolem">i'</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
      <span class="keyword3"><span class="command">assume</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">i'</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">j</span> <span class="keyword1">dvd</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="keyword1">dvd</span> <span class="skolem">n</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> prime_divisor<span class="main">[</span><span class="operator">OF</span> j<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
          p<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> pj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> dvd_imp_le<span class="main"><span class="main">[</span></span><span class="operator">OF</span> p<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> j<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> p2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prime_ge_2_nat<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> dvd<span class="main">[</span><span class="operator">OF</span> p2<span class="main">]</span> p<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> pi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≥</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">from</span></span> pj j<span class="main">(</span>2<span class="main">)</span> i' <span class="quoted">"is"</span><span class="main">[</span><span class="operator">OF</span> pi _ p<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> set <span class="skolem">is</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹sorted <span class="skolem">is</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">≤</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Cons<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> pj j<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> dvd <span class="main">=</span> this
    <span class="keyword1"><span class="command">from</span></span> i' i <span class="keyword1"><span class="command">have</span></span> i'2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> Suc <span class="skolem">i'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> IH<span class="main">[</span><span class="operator">OF</span> _ i'2 n _ _ i'<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> sd_iis 1<span class="main"><span class="main">(</span></span>10<span class="main"><span class="main">)</span></span> iis<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="keyword1">dvd</span> <span class="skolem">n</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> dvdi <span class="main">=</span> this
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
        <span class="keyword3"><span class="command">assume</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> Suc <span class="skolem">i'</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">j</span> <span class="keyword1">dvd</span> <span class="skolem">n</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="skolem">i'</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">with</span></span> j <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">i'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> dvd<span class="main">[</span><span class="operator">OF</span> j<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> False<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> dvds <span class="main">=</span> this
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">*</span> <span class="skolem">i'</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> iin <span class="main">=</span> this
        <span class="keyword1"><span class="command">with</span></span> res False <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">res</span> <span class="main">=</span> prime_nat_main <span class="skolem">n</span> <span class="skolem">jj</span> <span class="skolem">iis</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> iin <span class="keyword1"><span class="command">have</span></span> i_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> dvd dvdi n nat_neq_iff dvd_refl <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i'</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">jj</span>"</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">jj</span>"</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"is"</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">is</span>"</span></span> <span class="keyword1"><span class="command">.</span></span> 
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">i'</span> <span class="main">≤</span> <span class="skolem">x</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">iis</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> iis <span class="main">=</span> this
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> IH<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ dvds iis res<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i_n i'<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">with</span></span> res dvdi <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">res</span> <span class="main">=</span> True"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="skolem">n</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prime_sqrtI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> n dvd False<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> res <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i i' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="keyword1">dvd</span> <span class="skolem">n</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="skolem">i'</span> <span class="main">*</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">with</span></span> n <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> <span class="skolem">i'</span> <span class="main">*</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&lt;</span> <span class="skolem">n</span> <span class="main">∨</span> <span class="skolem">i'</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> True res <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">res</span> <span class="main">⟷</span> <span class="skolem">i'</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> prime <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≥</span> <span class="numeral">2</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="keyword1">dvd</span> <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> prime <span class="skolem">n</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prime_nat_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">&lt;</span> <span class="skolem">n</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> dvd n <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">n</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prime_nat_iff'<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">=</span> <span class="skolem">n</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prime_factorization_nat_main<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ni</span> <span class="main">=</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span><span class="free">i</span><span class="main">,</span><span class="free">is</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≥</span> <span class="numeral">2</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">≥</span> <span class="numeral">2</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span> <span class="bound">j</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="main">(</span><span class="bound">j</span> <span class="keyword1">dvd</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> 
  <span class="main">(</span><span class="main">⋀</span> <span class="bound">j</span><span class="main">.</span> <span class="free">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">jj</span> <span class="main">⟹</span> prime <span class="bound">j</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">∈</span> set <span class="free">is</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">jj</span> <span class="main">⟹</span>
  sorted <span class="free">is</span> <span class="main">⟹</span> distinct <span class="free">is</span> <span class="main">⟹</span> candidate_invariant <span class="free">jj</span> <span class="main">⟹</span> set <span class="free">is</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">jj</span><span class="main">}</span> <span class="main">⟹</span> 
  <span class="free">res</span> <span class="main">=</span> prime_factorization_nat_main <span class="free">n</span> <span class="free">jj</span> <span class="free">is</span> <span class="free">ps</span> <span class="main">⟹</span> 
  <span class="main">∃</span> <span class="bound">qs</span><span class="main">.</span> <span class="free">res</span> <span class="main">=</span> <span class="bound">qs</span> <span class="main">@</span> <span class="free">ps</span> <span class="main">∧</span> Ball <span class="main">(</span>set <span class="bound">qs</span><span class="main">)</span> prime <span class="main">∧</span> <span class="free">n</span> <span class="main">=</span> prod_list <span class="bound">qs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ni</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span>"</span></span> <span class="quoted"><span class="free">jj</span></span> <span class="quoted"><span class="free">res</span></span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> wf_induct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 
  wf_measures<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[</span></span><span class="main"><span class="main">λ</span></span> <span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">n</span></span><span class="main"><span class="main">,</span></span><span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">,</span></span><span class="bound"><span class="bound">is</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">n</span></span> <span class="main"><span class="main">-</span></span> <span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">,</span></span> <span class="main"><span class="main">λ</span></span> <span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">n</span></span><span class="main"><span class="main">,</span></span><span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">,</span></span><span class="bound"><span class="bound">is</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">.</span></span> <span class="keyword1"><span class="keyword1">if</span></span> <span class="bound"><span class="bound">is</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">[]</span></span> <span class="keyword1"><span class="keyword1">then</span></span> <span class="main"><span class="main">1</span></span> <span class="keyword1"><span class="keyword1">else</span></span> <span class="main"><span class="main">0</span></span><span class="main"><span class="main">]</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">ni</span> <span class="skolem">n</span> <span class="skolem">i</span> <span class="quoted">"<span class="skolem">is</span>"</span> <span class="skolem">jj</span> <span class="skolem">res</span> <span class="skolem">ps</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> 1<span class="main">(</span>12<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 1<span class="main">(</span>3-4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i2<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> 1<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">j</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="skolem">i</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="bound">j</span> <span class="keyword1">dvd</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> 1<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> ijj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">jj</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">note</span></span> sort_dist <span class="main">=</span> 1<span class="main">(</span>8-9<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted">"is"</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">j</span><span class="main">.</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="skolem">jj</span> <span class="main">⟹</span> prime <span class="bound">j</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">∈</span> set <span class="skolem">is</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> 1<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> simps <span class="main">=</span> prime_factorization_nat_main.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">jj</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> 1<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">unfolded</span> 1<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">OF</span> _ refl<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">jjj</span></span> <span class="skolem"><span class="skolem">iis</span></span> <span class="keyword2"><span class="keyword">where</span></span> can<span class="main">:</span> <span class="quoted"><span class="quoted">"next_candidates <span class="skolem">jj</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">jjj</span><span class="main">,</span><span class="skolem">iis</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">from</span></span> res<span class="main">[</span><span class="operator">unfolded</span> simps<span class="main">,</span> <span class="operator">unfolded</span> Nil can split<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">res</span> <span class="main">=</span> prime_factorization_nat_main <span class="skolem">n</span> <span class="skolem">jjj</span> <span class="skolem">iis</span> <span class="skolem">ps</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> next_candidates<span class="main">[</span><span class="operator">OF</span> can 1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span>10<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> can<span class="main">:</span> 
      <span class="quoted"><span class="quoted">"sorted <span class="skolem">iis</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">iis</span>"</span></span> <span class="quoted"><span class="quoted">"candidate_invariant <span class="skolem">jjj</span>"</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> prime <span class="bound">i</span> <span class="main">∧</span> <span class="skolem">jj</span> <span class="main">≤</span> <span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">jjj</span><span class="main">}</span> <span class="main">⊆</span> set <span class="skolem">iis</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">iis</span> <span class="main">⊆</span> <span class="main">{</span><span class="numeral">2</span><span class="main">..}</span> <span class="main">∩</span> <span class="main">{</span><span class="skolem">jj</span><span class="main">..&lt;</span><span class="skolem">jjj</span><span class="main">}</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">iis</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">jj</span> <span class="main">&lt;</span> <span class="skolem">jjj</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">from</span></span> can ijj <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">jjj</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> IH<span class="main">[</span><span class="operator">OF</span> _ i n dvd _ this can<span class="main"><span class="main">(</span></span>1-3<span class="main"><span class="main">)</span></span> _ res<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> IH<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Nil can<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> ix<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> xj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">jjj</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> px<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"is"</span><span class="main">[</span><span class="operator">OF</span> ix _ px<span class="main">]</span> Nil <span class="keyword1"><span class="command">have</span></span> jx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">jj</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">with</span></span> can<span class="main">(</span>4<span class="main">)</span> xj px <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">iis</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> can<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> ijj<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">i'</span> <span class="skolem">iis</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> dm<span class="main">:</span> <span class="quoted"><span class="quoted">"Divides.divmod_nat <span class="skolem">n</span> <span class="skolem">i'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n'</span><span class="main">,</span><span class="skolem">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">hence</span></span> n'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span> <span class="main">=</span> <span class="skolem">n</span> <span class="keyword1">div</span> <span class="skolem">i'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> <span class="skolem">n</span> <span class="keyword1">mod</span> <span class="skolem">i'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> divmod_nat_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">m</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">i'</span> <span class="keyword1">dvd</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> m <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> Cons res<span class="main">[</span><span class="operator">unfolded</span> simps<span class="main">]</span> dm m n'
    <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">res</span> <span class="main">=</span> <span class="main">(</span>
       <span class="keyword1">if</span> <span class="skolem">i'</span> <span class="keyword1">dvd</span> <span class="skolem">n</span> <span class="keyword1">then</span> <span class="keyword1">case</span> remove_prime_factor <span class="skolem">i'</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">div</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">i'</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span> <span class="keyword1">of</span>
            <span class="main">(</span><span class="bound">n'</span><span class="main">,</span> <span class="bound">ps'</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">n'</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="bound">ps'</span> <span class="keyword1">else</span> prime_factorization_nat_main <span class="bound">n'</span> <span class="skolem">jj</span> <span class="skolem">iis</span> <span class="bound">ps'</span>
       <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="skolem">i'</span> <span class="main">*</span> <span class="skolem">i'</span> <span class="main">≤</span> <span class="skolem">n</span> <span class="keyword1">then</span> prime_factorization_nat_main <span class="skolem">n</span> <span class="skolem">jj</span> <span class="skolem">iis</span> <span class="skolem">ps</span> <span class="keyword1">else</span> <span class="skolem">n</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> 1<span class="main">(</span>11<span class="main">)</span> i Cons <span class="keyword1"><span class="command">have</span></span> iis<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">iis</span> <span class="main">⊆</span> <span class="main">{</span><span class="skolem">i</span><span class="main">..&lt;</span><span class="skolem">jj</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">i'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&lt;</span> <span class="skolem">jj</span>"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i'</span> <span class="main">≤</span> <span class="skolem">jj</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> sort_dist <span class="keyword1"><span class="command">have</span></span> sd_iis<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="skolem">iis</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">iis</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">∉</span> set <span class="skolem">iis</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Cons<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> sort_dist<span class="main">(</span>1<span class="main">)</span> Cons <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">iis</span> <span class="main">⊆</span> <span class="main">{</span><span class="skolem">i'</span><span class="main">..}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> iis <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">iis</span> <span class="main">⊆</span> <span class="main">{</span><span class="skolem">i'</span><span class="main">..&lt;</span><span class="skolem">jj</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">∉</span> set <span class="skolem">iis</span>›</span></span>  <span class="keyword1"><span class="command">have</span></span> iis<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">iis</span> <span class="main">⊆</span> <span class="main">{</span>Suc <span class="skolem">i'</span><span class="main">..&lt;</span><span class="skolem">jj</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">x</span> <span class="main">=</span> <span class="skolem">i'</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
      <span class="keyword3"><span class="command">assume</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">i'</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">j</span> <span class="keyword1">dvd</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="keyword1">dvd</span> <span class="skolem">n</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> prime_divisor<span class="main">[</span><span class="operator">OF</span> j<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
          p<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> pj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> dvd_imp_le<span class="main"><span class="main">[</span></span><span class="operator">OF</span> p<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> j<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> p2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prime_ge_2_nat<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> dvd<span class="main">[</span><span class="operator">OF</span> p2<span class="main">]</span> p<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> pi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≥</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">from</span></span> pj j<span class="main">(</span>2<span class="main">)</span> i' <span class="quoted">"is"</span><span class="main">[</span><span class="operator">OF</span> pi _ p<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> set <span class="skolem">is</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹sorted <span class="skolem">is</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">≤</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Cons<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> pj j<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> dvd <span class="main">=</span> this
    <span class="keyword1"><span class="command">from</span></span> i' i <span class="keyword1"><span class="command">have</span></span> i'2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> Suc <span class="skolem">i'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> IH<span class="main">[</span><span class="operator">OF</span> _ i'2 _ _ _ i'<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> sd_iis 1<span class="main"><span class="main">(</span></span>10<span class="main"><span class="main">)</span></span> iis<span class="main">]</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i'</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">jj</span>"</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">jj</span>"</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"is"</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">is</span>"</span></span> <span class="keyword1"><span class="command">.</span></span> 
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">i'</span> <span class="main">≤</span> <span class="skolem">x</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">iis</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> iis <span class="main">=</span> this
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="keyword1">dvd</span> <span class="skolem">n</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> dvdi <span class="main">=</span> this
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
        <span class="keyword3"><span class="command">assume</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> Suc <span class="skolem">i'</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">j</span> <span class="keyword1">dvd</span> <span class="skolem">n</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="skolem">i'</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">with</span></span> j <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">i'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> dvd<span class="main">[</span><span class="operator">OF</span> j<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> False<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> dvds <span class="main">=</span> this
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">*</span> <span class="skolem">i'</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> iin <span class="main">=</span> this
        <span class="keyword1"><span class="command">with</span></span> res False <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">res</span> <span class="main">=</span> prime_factorization_nat_main <span class="skolem">n</span> <span class="skolem">jj</span> <span class="skolem">iis</span> <span class="skolem">ps</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> iin <span class="keyword1"><span class="command">have</span></span> i_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dvd dvdi n nat_neq_iff dvd_refl <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> IH<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ n dvds iis res<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i_n i'<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">with</span></span> res dvdi <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">res</span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">#</span> <span class="skolem">ps</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="skolem">n</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prime_sqrtI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> n dvd False<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> res <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>    
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> i_n <span class="main">=</span> this
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n''</span></span> <span class="skolem"><span class="skolem">qs</span></span> <span class="keyword2"><span class="keyword">where</span></span> rp<span class="main">:</span> <span class="quoted"><span class="quoted">"remove_prime_factor <span class="skolem">i'</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">div</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">i'</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n''</span><span class="main">,</span><span class="skolem">qs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">with</span></span> res True 
      <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">res</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">n''</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="skolem">qs</span> <span class="keyword1">else</span> prime_factorization_nat_main <span class="skolem">n''</span> <span class="skolem">jj</span> <span class="skolem">iis</span> <span class="skolem">qs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> pi<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="skolem">i'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> prime_nat_iff
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI allI impI<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="skolem">i'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i' i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
        <span class="keyword3"><span class="command">assume</span></span> ji<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="keyword1">dvd</span> <span class="skolem">i'</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> i' i <span class="keyword1"><span class="command">have</span></span> j0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> ji i_n <span class="keyword1"><span class="command">have</span></span> jn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="keyword1">dvd</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dvd_trans<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> dvd<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">&gt;</span> <span class="skolem">j</span> <span class="main">∨</span> <span class="skolem">j</span> <span class="main">≥</span> <span class="skolem">i'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
        <span class="keyword1"><span class="command">from</span></span> ji <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> <span class="skolem">i'</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> <span class="skolem">i'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dvd_imp_le ji<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> j j0 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> <span class="skolem">j</span> <span class="main">=</span> <span class="skolem">i'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">from</span></span> True n' <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="skolem">n'</span> <span class="main">*</span> <span class="skolem">i'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> n id <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> id <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> remove_prime_factor<span class="main">[</span><span class="operator">OF</span> rp<span class="main"><span class="main">[</span></span><span class="operator">folded</span> n'<span class="main"><span class="main">]</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> <span class="skolem">i'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n'</span> <span class="main">≠</span> <span class="main">0</span>›</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs</span></span>
        <span class="keyword2"><span class="keyword">where</span></span> qs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">qs</span> <span class="main">=</span> <span class="skolem">rs</span> <span class="main">@</span> <span class="skolem">i'</span> <span class="main">#</span> <span class="skolem">ps</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span> <span class="main">=</span> <span class="skolem">n''</span> <span class="main">*</span> prod_list <span class="skolem">rs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i_n''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">i'</span> <span class="keyword1">dvd</span> <span class="skolem">n''</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> rs<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">rs</span> <span class="main">⊆</span> <span class="main">{</span><span class="skolem">i'</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="keyword1">dvd</span> <span class="skolem">n''</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="keyword1">dvd</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> id n' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> dvd' <span class="main">=</span> this
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n''</span> <span class="main">=</span> <span class="main">1</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">with</span></span> res <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">res</span> <span class="main">=</span> prime_factorization_nat_main <span class="skolem">n''</span> <span class="skolem">jj</span> <span class="skolem">iis</span> <span class="skolem">qs</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">from</span></span> i i' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">from</span></span> False n' <span class="quoted"><span class="quoted">‹<span class="skolem">n'</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> n2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n''</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n''</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> lrs<span class="main">:</span> <span class="quoted"><span class="quoted">"prod_list <span class="skolem">rs</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n' <span class="quoted"><span class="quoted">‹<span class="skolem">n'</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"prod_list <span class="skolem">rs</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≥</span> <span class="numeral">2</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prod_list <span class="skolem">rs</span> <span class="main">*</span> <span class="skolem">i'</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"prod_list <span class="skolem">rs</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> nn''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&gt;</span> <span class="skolem">n''</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> id n' <span class="keyword1"><span class="command">using</span></span> n2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">≠</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> id n' <span class="keyword1"><span class="command">using</span></span> pi False <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≤</span> <span class="skolem">n</span>›</span></span> i' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&gt;</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> nn'' i i' <span class="keyword1"><span class="command">have</span></span> less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">-</span> <span class="skolem">i</span> <span class="main">&gt;</span> <span class="skolem">n''</span> <span class="main">-</span> Suc <span class="skolem">i'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
          <span class="keyword3"><span class="command">assume</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ji<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> Suc <span class="skolem">i'</span>"</span></span> 
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">j</span> <span class="keyword1">dvd</span> <span class="skolem">n''</span>"</span></span> 
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="skolem">i'</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> False
            <span class="keyword1"><span class="command">with</span></span> ji <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">i'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">from</span></span> dvd' dvd<span class="main">[</span><span class="operator">OF</span> 2 this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> i_n''<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">from</span></span> IH<span class="main">[</span><span class="operator">OF</span> _ n2 this iis res<span class="main">]</span> less <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ss</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
          res<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">res</span> <span class="main">=</span> <span class="skolem">ss</span> <span class="main">@</span> <span class="skolem">qs</span> <span class="main">∧</span> Ball <span class="main">(</span>set <span class="skolem">ss</span><span class="main">)</span> prime <span class="main">∧</span> <span class="skolem">n''</span> <span class="main">=</span> prod_list <span class="skolem">ss</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> id n' qs <span class="keyword1"><span class="command">using</span></span> pi rs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">with</span></span> res <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">res</span> <span class="main">=</span> <span class="skolem">qs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> id n' res qs True <span class="keyword1"><span class="command">using</span></span> rs <span class="quoted"><span class="quoted">‹prime <span class="skolem">i'</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">rs</span></span></span> <span class="main"><span class="main"><span class="main">@</span></span></span> <span class="main"><span class="main"><span class="main">[</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">i'</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prime_nat<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prime_nat <span class="free">n</span> <span class="main">=</span> prime <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> <span class="numeral">2</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> prime_nat_def prime_nat_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">jj</span></span> <span class="quoted">"<span class="skolem"><span class="skolem">is</span></span>"</span> <span class="keyword2"><span class="keyword">where</span></span> can<span class="main">:</span> <span class="quoted"><span class="quoted">"next_candidates <span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">jj</span><span class="main">,</span><span class="skolem">is</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> next_candidates<span class="main">[</span><span class="operator">OF</span> this candidate_invariant_0<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> cann<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="skolem">is</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">is</span>"</span></span> <span class="quoted"><span class="quoted">"candidate_invariant <span class="skolem">jj</span>"</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> prime <span class="bound">i</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">jj</span><span class="main">}</span> <span class="main">⊆</span> set <span class="skolem">is</span>"</span></span>
    <span class="quoted"><span class="quoted">"set <span class="skolem">is</span> <span class="main">⊆</span> <span class="main">{</span><span class="numeral">2</span><span class="main">..}</span> <span class="main">∩</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">jj</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">is</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
  <span class="keyword1"><span class="command">from</span></span> cann <span class="keyword1"><span class="command">have</span></span> sub<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">is</span> <span class="main">⊆</span> <span class="main">{</span><span class="numeral">2</span><span class="main">..&lt;</span><span class="skolem">jj</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> jj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">jj</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> n can <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"prime_nat <span class="free">n</span> <span class="main">=</span> prime_nat_main <span class="free">n</span> <span class="skolem">jj</span> <span class="skolem">is</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> prime_nat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> prime_nat_main<span class="main">[</span><span class="operator">OF</span> refl le_refl n _ _ jj cann<span class="main"><span class="main">(</span></span>1-3<span class="main"><span class="main">)</span></span> sub res<span class="main">]</span> cann<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prime_factorization_nat<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">pf</span> <span class="main">≡</span> prime_factorization_nat <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Ball <span class="main">(</span>set <span class="free">pf</span><span class="main">)</span> prime"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> prod_list <span class="free">pf</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">pf</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> pf <span class="main">=</span> pf_def<span class="main">[</span><span class="operator">unfolded</span> prime_factorization_nat_def<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Ball <span class="main">(</span>set <span class="free">pf</span><span class="main">)</span> prime <span class="main">∧</span> <span class="main">(</span><span class="free">n</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟶</span> prod_list <span class="free">pf</span> <span class="main">=</span> <span class="free">n</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> <span class="free">pf</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> <span class="numeral">2</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> pf <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">jj</span></span> <span class="quoted">"<span class="skolem"><span class="skolem">is</span></span>"</span> <span class="keyword2"><span class="keyword">where</span></span> can<span class="main">:</span> <span class="quoted"><span class="quoted">"next_candidates <span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">jj</span><span class="main">,</span><span class="skolem">is</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">from</span></span> next_candidates<span class="main">[</span><span class="operator">OF</span> this candidate_invariant_0<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> cann<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="skolem">is</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">is</span>"</span></span> <span class="quoted"><span class="quoted">"candidate_invariant <span class="skolem">jj</span>"</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> prime <span class="bound">i</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">jj</span><span class="main">}</span> <span class="main">⊆</span> set <span class="skolem">is</span>"</span></span>
      <span class="quoted"><span class="quoted">"set <span class="skolem">is</span> <span class="main">⊆</span> <span class="main">{</span><span class="numeral">2</span><span class="main">..}</span> <span class="main">∩</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">jj</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">is</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
    <span class="keyword1"><span class="command">from</span></span> cann <span class="keyword1"><span class="command">have</span></span> sub<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">is</span> <span class="main">⊆</span> <span class="main">{</span><span class="numeral">2</span><span class="main">..&lt;</span><span class="skolem">jj</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> jj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">jj</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?pfm</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"prime_factorization_nat_main <span class="free">n</span> <span class="skolem">jj</span> <span class="skolem">is</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> pf<span class="main">[</span><span class="operator">unfolded</span> can<span class="main">]</span> False
    <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pf</span> <span class="main">=</span> rev <span class="var">?pfm</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> prime_factorization_nat_main<span class="main">[</span><span class="operator">OF</span> refl le_refl n _ _ jj cann<span class="main"><span class="main">(</span></span>1-3<span class="main"><span class="main">)</span></span> sub refl<span class="main">,</span> <span class="operator">of</span> <span class="quoted">Nil</span><span class="main">]</span> cann<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Ball <span class="main">(</span>set <span class="var">?pfm</span><span class="main">)</span> prime"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> prod_list <span class="var">?pfm</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> res <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"Ball <span class="main">(</span>set <span class="free">pf</span><span class="main">)</span> prime"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> prod_list <span class="free">pf</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">pf</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prod_mset_multiset_prime_factorization_nat <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> prod_mset <span class="main">(</span>prime_factorization <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">(* TODO Move *)</span>
<span class="keyword1"><span class="command">lemma</span></span> prime_factorization_unique''<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>factorial_semiring_multiplicative<span class="main">}</span> multiset"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈#</span> <span class="free">A</span> <span class="main">⟹</span> prime <span class="bound">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prod_mset <span class="free">A</span> <span class="main">=</span> normalize <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"prime_factorization <span class="free">x</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prod_mset <span class="free">A</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"prod_mset <span class="main">(</span>prime_factorization <span class="free">x</span><span class="main">)</span> <span class="main">=</span> prod_mset <span class="free">A</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms prod_mset_prime_factorization<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> prime_factorization_unique'<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> multiset_prime_factorization_nat_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"prime_factorization <span class="free">n</span> <span class="main">=</span> mset <span class="main">(</span>prime_factorization_nat <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> pf <span class="main">=</span> prime_factorization_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> pf<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">note</span></span> pf <span class="main">=</span> pf<span class="main">(</span>1<span class="main">)</span> pf<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> False<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> prime_factorization_unique''<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈#</span> mset <span class="main">(</span>prime_factorization_nat <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span>
        <span class="keyword1"><span class="command">using</span></span> pf<span class="main">(</span>1<span class="main">)</span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">∏</span><span class="bound">i</span><span class="main">∈#</span>prime_factorization <span class="free">n</span><span class="main">.</span> <span class="bound">i</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">∏</span><span class="bound">i</span><span class="main">∈#</span>mset <span class="main">(</span>prime_factorization_nat <span class="free">n</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"prod_mset <span class="main">(</span>mset <span class="main">(</span>prime_factorization_nat <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> normalize <span class="free">n</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pf<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> prod_mset_prod_list<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> multiset_prime_factorization_code<span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"prime_factorization <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> mset <span class="main">(</span>prime_factorization_nat <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext multiset_prime_factorization_nat_correct<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> divisors_nat<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> set <span class="main">(</span>divisors_nat <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="keyword1">dvd</span> <span class="free">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>divisors_nat <span class="free">n</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"divisors_nat <span class="main">0</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>divisors_nat <span class="free">n</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"divisors_nat <span class="main">0</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> divisors_nat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">assume</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> n <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>    
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="keyword1">dvd</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> multiplicity <span class="bound">p</span> <span class="skolem">x</span> <span class="main">≤</span> multiplicity <span class="bound">p</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dvd_multiplicity_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> n <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> dvd <span class="main">=</span> this
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?dn</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>divisors_nat <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mf</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="main">(</span><span class="bound">n</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">.</span> prime_factorization <span class="bound">n</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?dn</span> <span class="main">=</span> prod_list <span class="main">`</span> set <span class="main">(</span>subseqs <span class="main">(</span>prime_factorization_nat <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> divisors_nat_def
    <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> prod_mset <span class="main">`</span> mset <span class="main">`</span> set <span class="main">(</span>subseqs <span class="main">(</span>prime_factorization_nat <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prod_mset_prod_list<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mset <span class="main">`</span> set <span class="main">(</span>subseqs <span class="main">(</span>prime_factorization_nat <span class="free">n</span><span class="main">)</span><span class="main">)</span>
    <span class="main">=</span> <span class="main">{</span> <span class="bound">ps</span><span class="main">.</span> <span class="bound">ps</span> <span class="main">⊆#</span> mset <span class="main">(</span>prime_factorization_nat <span class="free">n</span><span class="main">)</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> multiset_of_subseqs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">{</span> <span class="bound">ps</span><span class="main">.</span> <span class="bound">ps</span> <span class="main">⊆#</span> <span class="var">?mf</span> <span class="free">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">thm</span></span> multiset_prime_factorization_code<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> multiset_prime_factorization_nat_correct<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prod_mset <span class="main">`</span> <span class="main">…</span> <span class="main">=</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="keyword1">dvd</span> <span class="free">n</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> dvd<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="keyword1">dvd</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?mf</span> <span class="skolem">x</span> <span class="main">⊆#</span> <span class="var">?mf</span> <span class="free">n</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> prime_factorization_subset_iff_dvd<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prod_mset <span class="main">(</span><span class="var">?mf</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prime_factorization_nat<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sub <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">}</span></span> 
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?l</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> prod_mset <span class="skolem">ps</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ps</span> <span class="main">⊆#</span> <span class="var">?mf</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prod_mset_subset_imp_dvd<span class="main">[</span><span class="operator">OF</span> sub<span class="main">]</span> n x <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>divisors_nat <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="keyword1">dvd</span> <span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> divisors_int_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> set <span class="main">(</span>divisors_int_pos <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="keyword1">dvd</span> <span class="free">x</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>divisors_int_pos <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"divisors_int_pos <span class="main">0</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"divisors_int_pos <span class="main">0</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">code_simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>divisors_int_pos <span class="free">x</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> divisors_int_pos_def <span class="keyword1"><span class="command">using</span></span> divisors_nat<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"nat <span class="main">(</span>abs <span class="free">x</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinct_map inj_on_def<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"nat <span class="main">(</span>abs <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> x <span class="keyword1"><span class="command">have</span></span> xx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> x <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="keyword1">dvd</span> <span class="free">x</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"int <span class="main">`</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> int <span class="bound">p</span> <span class="keyword1">dvd</span> <span class="free">x</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="keyword1">dvd</span> <span class="free">x</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">i</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="var">?l</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> int <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"int <span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> y <span class="keyword1"><span class="command">using</span></span> dvd 0<span class="main">[</span><span class="operator">OF</span> dvd<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="var">?r</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="keyword1">dvd</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> y0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> nat <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> y0 <span class="keyword1"><span class="command">have</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> int <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> n_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> dvd <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="var">?l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> xx <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>divisors_int_pos <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="keyword1">dvd</span> <span class="free">x</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> divisors_int_pos_def divisors_nat id<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> divisors_int<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> set <span class="main">(</span>divisors_int <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="keyword1">dvd</span> <span class="free">x</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>divisors_int <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"divisors_int <span class="main">0</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"divisors_int <span class="main">0</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">code_simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>divisors_int <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True 
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">code_simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">from</span></span> divisors_int_pos<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> False<span class="main">]</span> divisors_int_pos<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> divisors_int_def Let_def distinct_append distinct_map inj_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>divisors_int <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="keyword1">dvd</span> <span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> divisors_int_def Let_def set_append set_map divisors_int_pos<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> x<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> x
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> dvd_mult_div_cancel image_eqI linorder_neqE_linordered_idom 
  mem_Collect_eq minus_dvd_iff minus_minus mult_zero_left neg_less_0_iff_less<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">divisors_fun</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>comm_monoid_mult<span class="main">,</span>zero<span class="main">}</span><span class="main">)</span> list<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">divisors_fun</span> <span class="free"><span class="bound"><span class="entity">df</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟶</span> set <span class="main">(</span><span class="free"><span class="bound"><span class="entity">df</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span> <span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="bound">x</span> <span class="main">}</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> distinct <span class="main">(</span><span class="free"><span class="bound"><span class="entity">df</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> divisors_funD<span class="main">:</span> <span class="quoted"><span class="quoted">"divisors_fun <span class="free">df</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">d</span> <span class="keyword1">dvd</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">d</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">df</span> <span class="free">x</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> divisors_fun_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">divisors_pos_fun</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>comm_monoid_mult<span class="main">,</span>zero<span class="main">,</span>ord<span class="main">}</span><span class="main">)</span> list<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">divisors_pos_fun</span> <span class="free"><span class="bound"><span class="entity">df</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟶</span> set <span class="main">(</span><span class="free"><span class="bound"><span class="entity">df</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span> <span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="keyword1">dvd</span> <span class="bound">x</span> <span class="main">∧</span> <span class="bound">d</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> distinct <span class="main">(</span><span class="free"><span class="bound"><span class="entity">df</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> divisors_pos_funD<span class="main">:</span> <span class="quoted"><span class="quoted">"divisors_pos_fun <span class="free">df</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">d</span> <span class="keyword1">dvd</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">d</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">d</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">df</span> <span class="free">x</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> divisors_pos_fun_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> divisors_fun_nat<span class="main">:</span> <span class="quoted"><span class="quoted">"divisors_fun divisors_nat"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> divisors_fun_def <span class="keyword1"><span class="command">using</span></span> divisors_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> divisors_fun_int<span class="main">:</span> <span class="quoted"><span class="quoted">"divisors_fun divisors_int"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> divisors_fun_def <span class="keyword1"><span class="command">using</span></span> divisors_int <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> divisors_pos_fun_int<span class="main">:</span> <span class="quoted"><span class="quoted">"divisors_pos_fun divisors_int_pos"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> divisors_pos_fun_def <span class="keyword1"><span class="command">using</span></span> divisors_int_pos <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Rational_Root_Test">
<div class="head">
<h1>Theory Rational_Root_Test</h1>
</div>
<pre class="source"><span class="comment1">(*  
    Author:      René Thiemann 
                 Akihisa Yamada
    License:     BSD
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Rational Root Test›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This theory contains a formalization of the rational root test, i.e., a decision
  procedure to test whether a polynomial over the rational numbers has a rational root.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Rational_Root_Test
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Gauss_Lemma.html">Gauss_Lemma</a>
  <a href="Missing_List.html">Missing_List</a>
  <a href="Prime_Factorization.html">Prime_Factorization</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rational_root_test_main</span> <span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>int <span class="main">⇒</span> int list<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>int <span class="main">⇒</span> int list<span class="main">)</span> <span class="main">⇒</span> rat poly <span class="main">⇒</span> rat option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rational_root_test_main</span> <span class="free"><span class="bound"><span class="entity">df</span></span></span> <span class="free"><span class="bound"><span class="entity">dp</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> <span class="keyword1">let</span> <span class="bound">ip</span> <span class="main">=</span> snd <span class="main">(</span>rat_to_normalized_int_poly <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">;</span> 
    <span class="bound">a0</span> <span class="main">=</span> coeff <span class="bound">ip</span> <span class="main">0</span><span class="main">;</span> <span class="bound">an</span> <span class="main">=</span> coeff <span class="bound">ip</span> <span class="main">(</span>degree <span class="bound">ip</span><span class="main">)</span>
    <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">a0</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> Some <span class="main">0</span> <span class="keyword1">else</span>
     <span class="keyword1">let</span> <span class="bound">d0</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">df</span></span></span> <span class="bound">a0</span><span class="main">;</span> <span class="bound">dn</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">dp</span></span></span> <span class="bound">an</span> 
     <span class="keyword1">in</span> map_option fst 
     <span class="main">(</span>find_map_filter <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span>poly <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> 
     <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">res</span><span class="main">)</span><span class="main">.</span> <span class="bound">res</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">[</span>rat_of_int <span class="bound">b0</span> <span class="main">/</span> of_int <span class="bound">bn</span> <span class="main">.</span> b0 <span class="main">&lt;-</span> <span class="bound">d0</span><span class="main">,</span> bn <span class="main">&lt;-</span> <span class="bound">dn</span><span class="main">,</span> coprime <span class="bound">b0</span> <span class="bound">bn</span> <span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rational_root_test</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat poly <span class="main">⇒</span> rat option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rational_root_test</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> 
     rational_root_test_main divisors_int divisors_int_pos <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rational_root_test_main<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"rational_root_test_main <span class="free">df</span> <span class="free">dp</span> <span class="free">p</span> <span class="main">=</span> Some <span class="free">x</span> <span class="main">⟹</span> poly <span class="free">p</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="quoted"><span class="quoted">"divisors_fun <span class="free">df</span> <span class="main">⟹</span> divisors_pos_fun <span class="free">dp</span> <span class="main">⟹</span> rational_root_test_main <span class="free">df</span> <span class="free">dp</span> <span class="free">p</span> <span class="main">=</span> None <span class="main">⟹</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rat_of_int"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rp</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_poly <span class="var">?r</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">ip</span></span> <span class="keyword2"><span class="keyword">where</span></span> rp<span class="main">:</span> <span class="quoted"><span class="quoted">"rat_to_normalized_int_poly <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">ip</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> rat_to_normalized_int_poly<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> smult <span class="skolem">a</span> <span class="main">(</span><span class="var">?rp</span> <span class="skolem">ip</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> a00<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> cip<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> content <span class="skolem">ip</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a0</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"coeff <span class="skolem">ip</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?an</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"coeff <span class="skolem">ip</span> <span class="main">(</span>degree <span class="skolem">ip</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?d0</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">df</span> <span class="var">?a0</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?dn</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">dp</span> <span class="var">?an</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ip</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?rp</span> <span class="skolem">ip</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">tests</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tests</span> <span class="main">=</span> <span class="main">[</span>rat_of_int <span class="bound">b0</span> <span class="main">/</span> rat_of_int <span class="bound">bn</span> <span class="main">.</span> b0 <span class="main">&lt;-</span> <span class="var">?d0</span><span class="main">,</span> bn <span class="main">&lt;-</span> <span class="var">?dn</span><span class="main">,</span> coprime <span class="bound">b0</span> <span class="bound">bn</span> <span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span>poly <span class="free">p</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?test</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">res</span><span class="main">)</span><span class="main">.</span> <span class="bound">res</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">mo</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mo</span> <span class="main">=</span> find_map_filter <span class="var">?f</span> <span class="var">?test</span> <span class="skolem">tests</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> d <span class="main">=</span> rational_root_test_main_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">df</span></span> <span class="quoted"><span class="free">dp</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">,</span> <span class="operator">unfolded</span> Let_def rp snd_conv mo_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> tests_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"rational_root_test_main <span class="free">df</span> <span class="free">dp</span> <span class="free">p</span> <span class="main">=</span> Some <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> d<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a0</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> map_option fst <span class="skolem">mo</span> <span class="main">=</span> Some <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"poly <span class="free">p</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?a0</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"coeff <span class="free">p</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> p coeff_smult <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"poly <span class="free">p</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">p</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"map_option fst <span class="skolem">mo</span> <span class="main">=</span> Some <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pair</span></span> <span class="keyword2"><span class="keyword">where</span></span> find<span class="main">:</span> <span class="quoted"><span class="quoted">"find_map_filter <span class="var">?f</span> <span class="var">?test</span> <span class="skolem">tests</span> <span class="main">=</span> Some <span class="skolem">pair</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> fst <span class="skolem">pair</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> mo_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>      
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> pair<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pair</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="skolem">z</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">pair</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> find_map_filter_Some<span class="main">[</span><span class="operator">OF</span> find<span class="main">,</span> <span class="operator">unfolded</span> pair split<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"poly <span class="free">p</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">assume</span></span> df<span class="main">:</span> <span class="quoted"><span class="quoted">"divisors_fun <span class="free">df</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dp<span class="main">:</span> <span class="quoted"><span class="quoted">"divisors_pos_fun <span class="free">dp</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"rational_root_test_main <span class="free">df</span> <span class="free">dp</span> <span class="free">p</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">note</span></span> df <span class="main">=</span> divisors_funD<span class="main">[</span><span class="operator">OF</span> df<span class="main">]</span> <span class="keyword1"><span class="command">note</span></span> dp <span class="main">=</span> divisors_pos_funD<span class="main">[</span><span class="operator">OF</span> dp<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> res<span class="main">[</span><span class="operator">unfolded</span> d<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> a0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?a0</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"map_option fst <span class="skolem">mo</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> res<span class="main">[</span><span class="operator">unfolded</span> mo_def<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> find<span class="main">:</span> <span class="quoted"><span class="quoted">"find_map_filter <span class="var">?f</span> <span class="var">?test</span> <span class="skolem">tests</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"poly <span class="free">p</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> p<span class="main">]</span> a00 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span><span class="var">?rp</span> <span class="skolem">ip</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> poly_eq_0_iff_dvd<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[:</span> <span class="main">-</span><span class="skolem">x</span> <span class="main">,</span> <span class="main">1</span> <span class="main">:]</span> <span class="keyword1">dvd</span> <span class="var">?ip</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> ip_id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ip</span> <span class="main">=</span> <span class="main">[:</span> <span class="main">-</span><span class="skolem">x</span><span class="main">,</span> <span class="main">1</span> <span class="main">:]</span> <span class="main">*</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> x1<span class="main">:</span> <span class="quoted"><span class="quoted">"rat_to_normalized_int_poly <span class="main">[:</span> <span class="main">-</span><span class="skolem">x</span><span class="main">,</span> <span class="main">1</span> <span class="main">:]</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">from</span></span> rat_to_int_factor_explicit<span class="main">[</span><span class="operator">OF</span> ip_id x1<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span>  ip<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ip</span> <span class="main">=</span> <span class="skolem">q</span> <span class="main">*</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> rat_to_normalized_int_poly<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> x1<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> deg<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">q</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> degree1_coeffs<span class="main">[</span><span class="operator">OF</span> deg<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> <span class="main">[:</span> <span class="skolem">b</span><span class="main">,</span> <span class="skolem">a</span> <span class="main">:]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> ipr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ip</span> <span class="main">=</span> <span class="main">[:</span> <span class="skolem">b</span><span class="main">,</span> <span class="skolem">a</span> <span class="main">:]</span> <span class="main">*</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ip q <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> ipr<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> coeff <span class="bound">p</span> <span class="main">0</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> ba0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="keyword1">dvd</span> <span class="var">?a0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> rpq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?rp</span> <span class="skolem">q</span> <span class="main">=</span> <span class="main">[:</span> <span class="var">?r</span> <span class="skolem">b</span><span class="main">,</span> <span class="var">?r</span> <span class="skolem">a</span> <span class="main">:]</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> q
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> poly_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> of_int_hom.coeff_map_poly_hom<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="main">(</span>coeff <span class="main">[:</span><span class="skolem">b</span><span class="main">,</span> <span class="skolem">a</span><span class="main">:]</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> coeff <span class="main">[:</span> <span class="var">?r</span> <span class="skolem">b</span><span class="main">,</span> <span class="var">?r</span> <span class="skolem">a</span><span class="main">:]</span> <span class="skolem">n</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> coeff_pCons
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> ip<span class="main">,</span> <span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?rp</span></span></span><span class="main">,</span> <span class="operator">unfolded</span> of_int_poly_hom.hom_mult rpq<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[:</span> <span class="var">?r</span> <span class="skolem">b</span><span class="main">,</span> <span class="var">?r</span> <span class="skolem">a</span> <span class="main">:]</span> <span class="keyword1">dvd</span> <span class="var">?rp</span> <span class="skolem">ip</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"smult <span class="main">(</span>inverse <span class="main">(</span><span class="var">?r</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">[:</span> <span class="var">?r</span> <span class="skolem">b</span> <span class="main">,</span> <span class="var">?r</span> <span class="skolem">a</span> <span class="main">:]</span> <span class="keyword1">dvd</span> <span class="var">?rp</span> <span class="skolem">ip</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> smult_dvd<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> a<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"smult <span class="main">(</span>inverse <span class="main">(</span><span class="var">?r</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">[:</span> <span class="var">?r</span> <span class="skolem">b</span> <span class="main">,</span> <span class="var">?r</span> <span class="skolem">a</span> <span class="main">:]</span> <span class="main">=</span> <span class="main">[:</span> <span class="var">?r</span> <span class="skolem">b</span> <span class="main">/</span> <span class="var">?r</span> <span class="skolem">a</span><span class="main">,</span> <span class="main">1</span> <span class="main">:]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[:</span> <span class="main">-</span> <span class="main">(</span><span class="main">-</span> <span class="var">?r</span> <span class="skolem">b</span> <span class="main">/</span> <span class="var">?r</span> <span class="skolem">a</span><span class="main">)</span><span class="main">,</span> <span class="main">1</span> <span class="main">:]</span> <span class="keyword1">dvd</span> <span class="var">?rp</span> <span class="skolem">ip</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> poly_eq_0_iff_dvd<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">have</span></span> rt<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span><span class="var">?rp</span> <span class="skolem">ip</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span> <span class="var">?r</span> <span class="skolem">b</span> <span class="main">/</span> <span class="var">?r</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">hence</span></span> rt<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="free">p</span> <span class="main">(</span><span class="main">-</span> <span class="var">?r</span> <span class="skolem">b</span> <span class="main">/</span> <span class="var">?r</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> p <span class="keyword1"><span class="command">using</span></span> a00 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">aa</span></span> <span class="skolem"><span class="skolem">bb</span></span> <span class="keyword2"><span class="keyword">where</span></span> quot<span class="main">:</span> <span class="quoted"><span class="quoted">"quotient_of <span class="main">(</span><span class="main">-</span> <span class="var">?r</span> <span class="skolem">b</span> <span class="main">/</span> <span class="var">?r</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">bb</span><span class="main">,</span><span class="skolem">aa</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"quotient_of <span class="main">(</span><span class="var">?r</span> <span class="main">(</span><span class="main">-</span><span class="skolem">b</span><span class="main">)</span> <span class="main">/</span> <span class="var">?r</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">bb</span><span class="main">,</span> <span class="skolem">aa</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> quotient_of_int_div<span class="main">[</span><span class="operator">OF</span> this <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">≠</span> <span class="main">0</span>›</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="skolem">b</span> <span class="main">=</span> <span class="skolem">z</span> <span class="main">*</span> <span class="skolem">bb</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">z</span> <span class="main">*</span> <span class="skolem">aa</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> rt<span class="main">[</span><span class="operator">unfolded</span> quotient_of_div<span class="main"><span class="main">[</span></span><span class="operator">OF</span> quot<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> rt<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="free">p</span> <span class="main">(</span><span class="var">?r</span> <span class="skolem">bb</span> <span class="main">/</span> <span class="var">?r</span> <span class="skolem">aa</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> quotient_of_coprime<span class="main">[</span><span class="operator">OF</span> quot<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> cop<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">bb</span> <span class="skolem">aa</span>"</span></span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span><span class="main">-</span> <span class="skolem">bb</span><span class="main">)</span> <span class="skolem">aa</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> quotient_of_denom_pos<span class="main">[</span><span class="operator">OF</span> quot<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> aa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">aa</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> ba0 arg_cong<span class="main">[</span><span class="operator">OF</span> b<span class="main">,</span> <span class="operator">of</span> <span class="quoted">uminus</span><span class="main">]</span> z <span class="keyword1"><span class="command">have</span></span> bba0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bb</span> <span class="keyword1">dvd</span> <span class="var">?a0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ba0 dvdE dvd_mult_right minus_dvd_iff<span class="main">)</span>      
    <span class="keyword1"><span class="command">hence</span></span> bb0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bb</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> df<span class="main">[</span><span class="operator">OF</span> a0 bba0<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> bb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bb</span> <span class="main">∈</span> set <span class="var">?d0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> a0 <span class="keyword1"><span class="command">have</span></span> ip0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ip</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> an0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?an</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> ipr ip0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> degree_mult_eq<span class="main">[</span><span class="operator">OF</span> _ this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[:</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">a</span><span class="main">:]</span>"</span></span><span class="main">,</span> <span class="operator">folded</span> ipr<span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> ipr 
    <span class="keyword1"><span class="command">have</span></span> deg<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">ip</span> <span class="main">=</span> Suc <span class="main">(</span>degree <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> ipr<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> coeff <span class="bound">p</span> <span class="main">(</span>degree <span class="skolem">ip</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> ba0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="keyword1">dvd</span> <span class="var">?an</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> deg <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> coeff_eq_0<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">aa</span> <span class="keyword1">dvd</span> <span class="var">?an</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dvd_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> dp<span class="main">[</span><span class="operator">OF</span> an0 this aa<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> aa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">aa</span> <span class="main">∈</span> set <span class="var">?dn</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">from</span></span> find_map_filter_None<span class="main">[</span><span class="operator">OF</span> find<span class="main">]</span> rt <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?r</span> <span class="skolem">bb</span> <span class="main">/</span> <span class="var">?r</span> <span class="skolem">aa</span><span class="main">)</span> <span class="main">∉</span> set <span class="skolem">tests</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> test <span class="main">=</span> this<span class="main">[</span><span class="operator">unfolded</span> tests_def<span class="main">,</span> <span class="operator">simplified</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">aa</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">bb</span></span><span class="main">]</span> cop bb aa
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rational_root_test<span class="main">:</span>   
  <span class="quoted"><span class="quoted">"rational_root_test <span class="free">p</span> <span class="main">=</span> Some <span class="free">x</span> <span class="main">⟹</span> poly <span class="free">p</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="quoted"><span class="quoted">"rational_root_test <span class="free">p</span> <span class="main">=</span> None <span class="main">⟹</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rational_root_test_main<span class="main">(</span>1<span class="main">)</span> rational_root_test_main<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> divisors_fun_int divisors_pos_fun_int<span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> rational_root_test_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Kronecker_Factorization">
<div class="head">
<h1>Theory Kronecker_Factorization</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Kronecker Factorization›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This theory contains Kronecker's factorization algorithm to factor 
  integer or rational polynomials.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Kronecker_Factorization
<span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="../Polynomial_Interpolation/Polynomial_Interpolation.html">Polynomial_Interpolation.Polynomial_Interpolation</a>
  <a href="../Sqrt_Babylonian/Sqrt_Babylonian_Auxiliary.html">Sqrt_Babylonian.Sqrt_Babylonian_Auxiliary</a>
  <a href="Missing_List.html">Missing_List</a>
  <a href="Prime_Factorization.html">Prime_Factorization</a>
  <a href="Precomputation.html">Precomputation</a>
  <a href="Gauss_Lemma.html">Gauss_Lemma</a>
  <a href="Dvd_Int_Poly.html">Dvd_Int_Poly</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definitions›</span></span>  
<span class="keyword1"><span class="command">context</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">df</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> int list"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">dp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> int list"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">bnd</span> <span class="main">::</span> <span class="quoted">nat</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">kronecker_samples</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> int list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">kronecker_samples</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> <span class="keyword1">let</span> <span class="bound">min</span> <span class="main">=</span> <span class="main">-</span> int <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">in</span> <span class="main">[</span><span class="bound">min</span> <span class="main">..</span> <span class="bound">min</span> <span class="main">+</span> int <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> kronecker_samples_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∈</span> set <span class="main">(</span>kronecker_samples <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> kronecker_samples_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Since 0 is always a samples value, we make a case analysis: 
   we only take positive divisors of $p(0)$, and consider all divisors for other $p(j)$.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">kronecker_factorization_main</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int poly <span class="main">⇒</span> int poly option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">kronecker_factorization_main</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> degree <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≤</span> <span class="main">1</span> <span class="keyword1">then</span> None <span class="keyword1">else</span> <span class="keyword1">let</span> 
     <span class="bound">p</span> <span class="main">=</span> primitive_part <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">;</span>
     <span class="bound">js</span> <span class="main">=</span> kronecker_samples <span class="free">bnd</span><span class="main">;</span>
     <span class="bound">cjs</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span>poly <span class="bound">p</span> <span class="bound">j</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="bound">js</span>
   <span class="keyword1">in</span> <span class="main">(</span><span class="keyword1">case</span> map_of <span class="bound">cjs</span> <span class="main">0</span> <span class="keyword1">of</span> 
     Some <span class="bound">j</span> <span class="main">⇒</span> Some <span class="main">(</span><span class="main">[:</span><span class="main">-</span> <span class="bound">j</span><span class="main">,</span> <span class="main">1</span> <span class="main">:]</span><span class="main">)</span>
   <span class="main">|</span> None <span class="main">⇒</span> <span class="keyword1">let</span> <span class="bound">djs</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> map <span class="main">(</span>Pair <span class="bound">j</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">j</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="free">dp</span> <span class="bound">v</span> <span class="keyword1">else</span> <span class="free">df</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="bound">cjs</span> <span class="keyword1">in</span> 
     map_option the <span class="main">(</span>find_map_filter newton_interpolation_poly_int
     <span class="main">(</span><span class="main">λ</span> <span class="bound">go</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">go</span> <span class="keyword1">of</span> None <span class="main">⇒</span> False <span class="main">|</span> Some <span class="bound">g</span> <span class="main">⇒</span> dvd_int_poly_non_0 <span class="bound">g</span> <span class="bound">p</span> <span class="main">∧</span> degree <span class="bound">g</span> <span class="main">≥</span> <span class="main">1</span><span class="main">)</span> 
       <span class="main">(</span>concat_lists <span class="bound">djs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">kronecker_factorization_rat_main</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat poly <span class="main">⇒</span> rat poly option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">kronecker_factorization_rat_main</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> map_option <span class="main">(</span>map_poly of_int<span class="main">)</span> 
     <span class="main">(</span>kronecker_factorization_main <span class="main">(</span>snd <span class="main">(</span>rat_to_normalized_int_poly <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">kronecker_factorization</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int poly <span class="main">⇒</span> int poly option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">kronecker_factorization</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> 
     kronecker_factorization_main divisors_int divisors_int_pos <span class="main">(</span>degree <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">kronecker_factorization_rat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat poly <span class="main">⇒</span> rat poly option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">kronecker_factorization_rat</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> 
     kronecker_factorization_rat_main divisors_int divisors_int_pos <span class="main">(</span>degree <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Code setup for divisors›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">divisors_nat_copy</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">[]</span> <span class="keyword1">else</span> remdups_adj <span class="main">(</span>sort <span class="main">(</span>map prod_list <span class="main">(</span>subseqs <span class="main">(</span>prime_factorization_nat <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> divisors_nat_copy<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"divisors_nat_copy <span class="main">=</span> divisors_nat"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> divisors_nat_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> divisors_nat_copy_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">memo_divisors_nat</span> <span class="main">≡</span> memo_nat <span class="main">0</span> <span class="numeral">100</span> divisors_nat_copy"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> memo_divisors_nat<span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"divisors_nat <span class="main">=</span> memo_divisors_nat"</span></span>  
  <span class="keyword1"><span class="command">unfolding</span></span> memo_divisors_nat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Proofs›</span></span>

<span class="keyword1"><span class="command">context</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rat_to_int_poly_of_int<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> rp<span class="main">:</span> <span class="quoted"><span class="quoted">"rat_to_int_poly <span class="main">(</span>map_poly of_int <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> map <span class="main">(</span>snd <span class="main">∘</span> quotient_of<span class="main">)</span> <span class="main">(</span>coeffs <span class="main">(</span>map_poly rat_of_int <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> xs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">[</span><span class="operator">unfolded</span> rat_to_int_poly_def Let_def<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> fst <span class="main">(</span>common_denom <span class="main">(</span>coeffs <span class="main">(</span>map_poly rat_of_int <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> list_lcm <span class="skolem">xs</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> common_denom_def Let_def xs_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> xs
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> rat_to_int_poly<span class="main">[</span><span class="operator">OF</span> rp<span class="main">,</span> <span class="operator">unfolded</span> c<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rat_to_normalized_int_poly_of_int<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rat_to_normalized_int_poly <span class="main">(</span>map_poly of_int <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">=</span> of_int <span class="main">(</span>content <span class="free">p</span><span class="main">)</span> <span class="main">∧</span> <span class="free">q</span> <span class="main">=</span> primitive_part <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> ri<span class="main">:</span> <span class="quoted"><span class="quoted">"rat_to_int_poly <span class="main">(</span>map_poly rat_of_int <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">d</span><span class="main">,</span><span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> rat_to_int_poly_of_int<span class="main">[</span><span class="operator">OF</span> ri<span class="main">]</span>
    assms<span class="main">[</span><span class="operator">unfolded</span> rat_to_normalized_int_poly_def ri split<span class="main">]</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">=</span> of_int <span class="main">(</span>content <span class="free">p</span><span class="main">)</span> <span class="main">∧</span> <span class="free">q</span> <span class="main">=</span> primitive_part <span class="free">p</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dvd_poly_int_content_1<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> c_x<span class="main">:</span> <span class="quoted"><span class="quoted">"content <span class="free">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="keyword1">dvd</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>map_poly rat_of_int <span class="free">x</span> <span class="keyword1">dvd</span> map_poly of_int <span class="free">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rat_of_int"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rp</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_poly <span class="var">?r</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">dvd</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="free">x</span> <span class="main">*</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?rp</span></span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rp</span> <span class="free">x</span> <span class="keyword1">dvd</span> <span class="var">?rp</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?rp</span> <span class="free">x</span> <span class="keyword1">dvd</span> <span class="var">?rp</span> <span class="free">y</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">dvd</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> y0 <span class="main">=</span> this
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rp</span> <span class="free">y</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> rx0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?rp</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dvd <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> x0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> dvd <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> prod<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?rp</span> <span class="free">y</span> <span class="main">=</span> <span class="var">?rp</span> <span class="free">x</span> <span class="main">*</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cx</span></span> <span class="skolem"><span class="skolem">xx</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"rat_to_normalized_int_poly <span class="main">(</span><span class="var">?rp</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">cx</span><span class="main">,</span> <span class="skolem">xx</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">from</span></span> rat_to_int_factor_explicit<span class="main">[</span><span class="operator">OF</span> prod x<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="skolem">xx</span> <span class="main">*</span> smult <span class="main">(</span>content <span class="free">y</span><span class="main">)</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> rat_to_normalized_int_poly<span class="main">[</span><span class="operator">OF</span> x<span class="main">]</span> rx0 <span class="keyword1"><span class="command">have</span></span> xx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?rp</span> <span class="free">x</span> <span class="main">=</span> smult <span class="skolem">cx</span> <span class="main">(</span><span class="var">?rp</span> <span class="skolem">xx</span><span class="main">)</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> cxx<span class="main">:</span> <span class="quoted"><span class="quoted">"content <span class="skolem">xx</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> cx0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cx</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cn</span></span> <span class="skolem"><span class="skolem">cd</span></span> <span class="keyword2"><span class="keyword">where</span></span> quot<span class="main">:</span> <span class="quoted"><span class="quoted">"quotient_of <span class="skolem">cx</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">cn</span><span class="main">,</span><span class="skolem">cd</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">from</span></span> quotient_of_div<span class="main">[</span><span class="operator">OF</span> quot<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> cx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cx</span> <span class="main">=</span> <span class="var">?r</span> <span class="skolem">cn</span> <span class="main">/</span> <span class="var">?r</span> <span class="skolem">cd</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> quotient_of_denom_pos<span class="main">[</span><span class="operator">OF</span> quot<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> cd0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cd</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> cx cx0 <span class="keyword1"><span class="command">have</span></span> cn0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cn</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_less_divide_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> xx<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"smult <span class="main">(</span><span class="var">?r</span> <span class="skolem">cd</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"smult <span class="main">(</span><span class="var">?r</span> <span class="skolem">cd</span><span class="main">)</span> <span class="main">(</span><span class="var">?rp</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> smult <span class="main">(</span><span class="var">?r</span> <span class="skolem">cn</span><span class="main">)</span> <span class="main">(</span><span class="var">?rp</span> <span class="skolem">xx</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> cx <span class="keyword1"><span class="command">using</span></span> cd0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"smult <span class="skolem">cd</span> <span class="free">x</span> <span class="main">=</span> smult <span class="skolem">cn</span> <span class="skolem">xx</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fold</span> <span class="dynamic"><span class="dynamic">hom_distribs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> of_int_poly_hom.eq_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted">content</span><span class="main">,</span> <span class="operator">unfolded</span> content_smult_int cxx<span class="main">]</span> cn0 cd0 
      <span class="keyword1"><span class="command">have</span></span> cn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cn</span> <span class="main">=</span> <span class="skolem">cd</span> <span class="main">*</span> content <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> quotient_of_coprime<span class="main">[</span><span class="operator">OF</span> quot<span class="main">,</span> <span class="operator">unfolded</span> cn<span class="main">]</span> cd0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cd</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> cx <span class="keyword1"><span class="command">have</span></span> cx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cx</span> <span class="main">=</span> <span class="var">?r</span> <span class="skolem">cn</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> xx<span class="main">[</span><span class="operator">unfolded</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> smult <span class="skolem">cn</span> <span class="skolem">xx</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fold</span> <span class="dynamic"><span class="dynamic">hom_distribs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted">content</span><span class="main">,</span> <span class="operator">unfolded</span> content_smult_int c_x cxx<span class="main">]</span> cn0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cn</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> x <span class="keyword1"><span class="command">have</span></span> xx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xx</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">dvd</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> y<span class="main">[</span><span class="operator">unfolded</span> xx<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> content_x_minus_const_int<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"content <span class="main">[:</span> <span class="free">c</span><span class="main">,</span> <span class="main">1</span> <span class="main">:]</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">::</span> int<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> content_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> length_upto_add_nat<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">[</span><span class="free">a</span> <span class="main">..</span> <span class="free">a</span> <span class="main">+</span> int <span class="free">n</span><span class="main">]</span> <span class="main">=</span> Suc <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>0 <span class="skolem">a</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> upto.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="skolem">a</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Suc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">+</span> <span class="main">1</span>"</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> upto.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">+</span> int <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> kronecker_samples<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>kronecker_samples <span class="free">n</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>kronecker_samples <span class="free">n</span><span class="main">)</span> <span class="main">=</span> Suc <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> kronecker_samples_def Let_def length_upto_add_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">lemma</span></span> dvd_int_poly_non_0_degree_1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">q</span> <span class="main">≥</span> <span class="main">1</span> <span class="main">⟹</span> dvd_int_poly_non_0 <span class="free">q</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="free">q</span> <span class="keyword1">dvd</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> dvd_int_poly_non_0<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">df</span> <span class="free">dp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> int list"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">bnd</span> <span class="main">::</span> <span class="quoted">nat</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> kronecker_factorization_main_sound<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> some<span class="main">:</span> <span class="quoted"><span class="quoted">"kronecker_factorization_main <span class="free">df</span> <span class="free">dp</span> <span class="free">bnd</span> <span class="free">p</span> <span class="main">=</span> Some <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> bnd<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">≥</span> <span class="numeral">2</span> <span class="main">⟹</span> <span class="free">bnd</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">q</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">q</span> <span class="main">≤</span> <span class="free">bnd</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="keyword1">dvd</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rat_of_int"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rp</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_poly <span class="var">?r</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> some<span class="main">[</span><span class="operator">unfolded</span> kronecker_factorization_main_def Let_def<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> res <span class="keyword1"><span class="command">have</span></span> dp<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>degree <span class="free">p</span> <span class="main">≤</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> res<span class="main">[</span><span class="operator">unfolded</span> this if_False<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> bnd <span class="main">=</span> bnd<span class="main">[</span><span class="operator">OF</span> dp<span class="main">]</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> primitive_part <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> degP<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">P</span> <span class="main">=</span> degree <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> P_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">js</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">js</span> <span class="main">=</span> kronecker_samples <span class="free">bnd</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">filt</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">filt</span> <span class="main">=</span> <span class="main">(</span>case_option False <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> dvd_int_poly_non_0 <span class="bound">g</span> <span class="skolem">P</span> <span class="main">∧</span> <span class="main">1</span> <span class="main">≤</span> degree <span class="bound">g</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">tests</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tests</span> <span class="main">=</span> concat_lists <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">.</span> map <span class="main">(</span>Pair <span class="bound">j</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">j</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="free">dp</span> <span class="bound">v</span> <span class="keyword1">else</span> <span class="free">df</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span>poly <span class="skolem">P</span> <span class="bound">j</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="skolem">js</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> res<span class="main">[</span><span class="operator">folded</span> P_def<span class="main">,</span> <span class="operator">folded</span> js_def filt_def<span class="main">,</span> <span class="operator">folded</span> tests_def<span class="main">]</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?zero</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span>poly <span class="skolem">P</span> <span class="bound">j</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="skolem">js</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> res <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> map_of <span class="var">?zero</span> <span class="main">0</span> <span class="keyword1">of</span>
     None <span class="main">⇒</span> map_option the <span class="main">(</span>find_map_filter newton_interpolation_poly_int <span class="skolem">filt</span> <span class="skolem">tests</span><span class="main">)</span> <span class="main">|</span> Some <span class="bound">j</span> <span class="main">⇒</span> Some <span class="main">[:</span><span class="main">-</span> <span class="bound">j</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span><span class="main">)</span> <span class="main">=</span>
     Some <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">q</span> <span class="main">≥</span> <span class="main">1</span> <span class="main">∧</span> degree <span class="free">q</span> <span class="main">≤</span> <span class="free">bnd</span> <span class="main">∧</span> <span class="free">q</span> <span class="keyword1">dvd</span> <span class="skolem">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"map_of <span class="var">?zero</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">j</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> res <span class="keyword1"><span class="command">have</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="main">[:</span> <span class="main">-</span> <span class="skolem">j</span><span class="main">,</span> <span class="main">1</span> <span class="main">:]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> map_of_SomeD<span class="main">[</span><span class="operator">OF</span> Some<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="skolem">P</span> <span class="skolem">j</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span><span class="var">?rp</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span><span class="var">?r</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[:</span> <span class="main">-</span> <span class="var">?r</span> <span class="skolem">j</span><span class="main">,</span> <span class="main">1</span> <span class="main">:]</span> <span class="keyword1">dvd</span> <span class="var">?rp</span> <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> poly_eq_0_iff_dvd <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[:</span> <span class="main">-</span> <span class="var">?r</span> <span class="skolem">j</span><span class="main">,</span> <span class="main">1</span> <span class="main">:]</span> <span class="main">=</span> <span class="var">?rp</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> q <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?rp</span> <span class="free">q</span> <span class="keyword1">dvd</span> <span class="var">?rp</span> <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="keyword1">dvd</span> <span class="skolem">P</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> dvd_poly_int_content_1<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> dvd q<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> q dp bnd <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword1"><span class="command">from</span></span> res<span class="main">[</span><span class="operator">unfolded</span> None<span class="main">]</span> 
    <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"map_option the <span class="main">(</span>find_map_filter newton_interpolation_poly_int <span class="skolem">filt</span> <span class="skolem">tests</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qq</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      res<span class="main">:</span> <span class="quoted"><span class="quoted">"find_map_filter newton_interpolation_poly_int <span class="skolem">filt</span> <span class="skolem">tests</span> <span class="main">=</span> Some <span class="skolem">qq</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> the <span class="skolem">qq</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> find_map_filter_Some<span class="main">[</span><span class="operator">OF</span> res<span class="main">]</span> 
    <span class="keyword1"><span class="command">have</span></span> filt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">filt</span> <span class="skolem">qq</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> tests<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">qq</span> <span class="main">∈</span> newton_interpolation_poly_int <span class="main">`</span> set <span class="skolem">tests</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> filt<span class="main">[</span><span class="operator">unfolded</span> filt_def<span class="main">]</span> q <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="keyword1">dvd</span> <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> degree <span class="skolem">g</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> qq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">qq</span> <span class="main">=</span> Some <span class="skolem">g</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">qq</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> q qq <span class="keyword1"><span class="command">have</span></span> gq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">=</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> tests <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> set <span class="skolem">tests</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"newton_interpolation_poly_int <span class="skolem">t</span> <span class="main">=</span> Some <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> qq 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> t<span class="main">[</span><span class="operator">unfolded</span> tests_def<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> lent<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">t</span> <span class="main">=</span> length <span class="skolem">js</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="skolem">js</span> <span class="main">⟹</span> map fst <span class="skolem">t</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">js</span> <span class="main">!</span> <span class="bound">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"map fst <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">js</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nth_equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> dist<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">js</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> lenj<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">js</span> <span class="main">=</span> Suc <span class="free">bnd</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> js_def degP
      <span class="keyword1"><span class="command">using</span></span> kronecker_samples <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> newton_interpolation_poly_int_Some<span class="main">[</span><span class="operator">OF</span> dist<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">folded</span></span> id<span class="main"><span class="main"><span class="main">]</span></span></span> l<span class="main">,</span> <span class="operator">unfolded</span> lent lenj<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">g</span> <span class="main">≤</span> <span class="free">bnd</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> dvd dg <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> gq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command">note</span></span> main <span class="main">=</span> this
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">q</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">q</span> <span class="main">≤</span> <span class="free">bnd</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> content_times_primitive_part<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> smult <span class="main">(</span>content <span class="free">p</span><span class="main">)</span> <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> P_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> main <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="keyword1">dvd</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dvd_smult<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> kronecker_factorization_rat_main_sound<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> 
  some<span class="main">:</span> <span class="quoted"><span class="quoted">"kronecker_factorization_rat_main <span class="free">df</span> <span class="free">dp</span> <span class="free">bnd</span> <span class="free">p</span> <span class="main">=</span> Some <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> bnd<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">≥</span> <span class="numeral">2</span> <span class="main">⟹</span> <span class="free">bnd</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">q</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">q</span> <span class="main">≤</span> <span class="free">bnd</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="keyword1">dvd</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rat_of_int"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rp</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_poly <span class="var">?r</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rat_to_normalized_int_poly <span class="free">p</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span> rp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> rat_to_normalized_int_poly<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> smult <span class="skolem">a</span> <span class="main">(</span><span class="var">?rp</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> deg<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">P</span> <span class="main">=</span> degree <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> some<span class="main">[</span><span class="operator">unfolded</span> kronecker_factorization_rat_main_def rp<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="keyword2"><span class="keyword">where</span></span> some<span class="main">:</span> <span class="quoted"><span class="quoted">"kronecker_factorization_main <span class="free">df</span> <span class="free">dp</span> <span class="free">bnd</span> <span class="skolem">P</span> <span class="main">=</span> Some <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="var">?rp</span> <span class="skolem">Q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> kronecker_factorization_main_sound<span class="main">[</span><span class="operator">OF</span> some bnd<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> dQ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> degree <span class="skolem">Q</span>"</span></span> 
    <span class="quoted"><span class="quoted">"degree <span class="skolem">Q</span> <span class="main">≤</span> <span class="free">bnd</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="keyword1">dvd</span> <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> deg <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> dvd <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="keyword2"><span class="keyword">where</span></span> PQR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> <span class="skolem">Q</span> <span class="main">*</span> <span class="skolem">R</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> p<span class="main">[</span><span class="operator">unfolded</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> this<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?rp</span></span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="free">q</span> <span class="main">*</span> smult <span class="skolem">a</span> <span class="main">(</span><span class="var">?rp</span> <span class="skolem">R</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> q <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">hom_distribs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="keyword1">dvd</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> q dQ <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">q</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">q</span> <span class="main">≤</span> <span class="free">bnd</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> df<span class="main">:</span> <span class="quoted"><span class="quoted">"divisors_fun <span class="free">df</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dpf<span class="main">:</span> <span class="quoted"><span class="quoted">"divisors_pos_fun <span class="free">dp</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> kronecker_factorization_main_complete<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> 
  none<span class="main">:</span> <span class="quoted"><span class="quoted">"kronecker_factorization_main <span class="free">df</span> <span class="free">dp</span> <span class="free">bnd</span> <span class="free">p</span> <span class="main">=</span> None"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> dp<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">q</span><span class="main">.</span> <span class="main">1</span> <span class="main">≤</span> degree <span class="bound">q</span> <span class="main">∧</span> degree <span class="bound">q</span> <span class="main">≤</span> <span class="free">bnd</span> <span class="main">∧</span> <span class="bound">q</span> <span class="keyword1">dvd</span> <span class="free">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rat_of_int"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rp</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_poly <span class="var">?r</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> dp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>degree <span class="free">p</span> <span class="main">≤</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> none<span class="main">[</span><span class="operator">unfolded</span> kronecker_factorization_main_def Let_def this if_False<span class="main">]</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> primitive_part <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> degP<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">P</span> <span class="main">=</span> degree <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> P_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">js</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">js</span> <span class="main">=</span> kronecker_samples <span class="free">bnd</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">filt</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">filt</span> <span class="main">=</span> <span class="main">(</span>case_option False <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> dvd_int_poly_non_0 <span class="bound">g</span> <span class="skolem">P</span> <span class="main">∧</span> <span class="main">1</span> <span class="main">≤</span> degree <span class="bound">g</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">tests</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tests</span> <span class="main">=</span> concat_lists <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">.</span> map <span class="main">(</span>Pair <span class="bound">j</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">j</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="free">dp</span> <span class="bound">v</span> <span class="keyword1">else</span> <span class="free">df</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span>poly <span class="skolem">P</span> <span class="bound">j</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="skolem">js</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> res<span class="main">[</span><span class="operator">folded</span> P_def<span class="main">,</span> <span class="operator">folded</span> js_def filt_def<span class="main">,</span> <span class="operator">folded</span> tests_def<span class="main">]</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?zero</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span>poly <span class="skolem">P</span> <span class="bound">j</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="skolem">js</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> res <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> map_of <span class="var">?zero</span> <span class="main">0</span> <span class="keyword1">of</span>
     None <span class="main">⇒</span> map_option the <span class="main">(</span>find_map_filter newton_interpolation_poly_int <span class="skolem">filt</span> <span class="skolem">tests</span><span class="main">)</span> <span class="main">|</span> Some <span class="bound">j</span> <span class="main">⇒</span> Some <span class="main">[:</span><span class="main">-</span> <span class="bound">j</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span><span class="main">)</span> <span class="main">=</span>
     None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> zero<span class="main">:</span> <span class="quoted"><span class="quoted">"map_of <span class="var">?zero</span> <span class="main">0</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> res <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"find_map_filter newton_interpolation_poly_int <span class="skolem">filt</span> <span class="skolem">tests</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">qq</span>
    <span class="keyword3"><span class="command">assume</span></span> qq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> degree <span class="skolem">qq</span>"</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">qq</span> <span class="main">≤</span> <span class="free">bnd</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">qq</span> <span class="keyword1">dvd</span> <span class="free">p</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">=</span> primitive_part <span class="skolem">qq</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> poly <span class="skolem">q'</span> <span class="main">0</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="skolem">q'</span> <span class="keyword1">else</span> <span class="main">-</span><span class="skolem">q'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> qq <span class="keyword1"><span class="command">have</span></span> q'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> degree <span class="skolem">q'</span>"</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">q'</span> <span class="main">≤</span> <span class="free">bnd</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> q'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> degree <span class="skolem">q</span>"</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">q</span> <span class="main">≤</span> <span class="free">bnd</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> q_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> dvd <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">qq</span> <span class="keyword1">dvd</span> <span class="main">(</span>smult <span class="main">(</span>content <span class="free">p</span><span class="main">)</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> content_times_primitive_part<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> P_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> dvd_smult_int<span class="main">[</span><span class="operator">OF</span> _ this<span class="main">]</span> dp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="keyword1">dvd</span> <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> q'_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">hence</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="keyword1">dvd</span> <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> q_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>      
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> <span class="skolem">q</span> <span class="main">*</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
      <span class="keyword3"><span class="command">assume</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> set <span class="skolem">js</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> P <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="skolem">P</span> <span class="skolem">j</span> <span class="main">=</span> poly <span class="skolem">q</span> <span class="skolem">j</span> <span class="main">*</span> poly <span class="skolem">r</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="skolem">q</span> <span class="skolem">j</span> <span class="keyword1">dvd</span> poly <span class="skolem">P</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> j <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>poly <span class="skolem">P</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> set <span class="var">?zero</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> zero <span class="keyword1"><span class="command">have</span></span> zero<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="skolem">P</span> <span class="skolem">j</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> map_of_eq_None_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">with</span></span> id <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"poly <span class="skolem">q</span> <span class="skolem">j</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> poly <span class="skolem">q</span> <span class="skolem">j</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> q_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> divisors_funD<span class="main">[</span><span class="operator">OF</span> df zero dvd<span class="main">]</span> divisors_pos_funD<span class="main">[</span><span class="operator">OF</span> dpf zero dvd this<span class="main">]</span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"poly <span class="skolem">q</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">df</span> <span class="main">(</span>poly <span class="skolem">P</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> poly <span class="skolem">q</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">dp</span> <span class="main">(</span>poly <span class="skolem">P</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> mem1 <span class="main">=</span> this
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="bound">j</span><span class="main">,</span> poly <span class="skolem">q</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="skolem">js</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> set <span class="skolem">tests</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> tests_def concat_lists_listset listset length_map map_map o_def
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI allI impI<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">t</span> <span class="main">=</span> length <span class="skolem">js</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> t_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">js</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> jsi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">js</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">∈</span> set <span class="skolem">js</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> ti<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">js</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">,</span> poly <span class="skolem">q</span> <span class="main">(</span><span class="skolem">js</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> t_def <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> set <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span>poly <span class="skolem">P</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">⇒</span> map <span class="main">(</span>Pair <span class="bound">j</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">j</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="free">dp</span> <span class="bound">v</span> <span class="keyword1">else</span> <span class="free">df</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">∈</span> map <span class="var">?f</span> <span class="skolem">js</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> ti nth_map<span class="main">[</span><span class="operator">OF</span> i<span class="main">]</span> split <span class="keyword1"><span class="command">using</span></span> mem1<span class="main">[</span><span class="operator">OF</span> jsi<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> dist<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">js</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> lenj<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">js</span> <span class="main">=</span> Suc <span class="free">bnd</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> js_def degP
      <span class="keyword1"><span class="command">using</span></span> kronecker_samples <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> map_fst<span class="main">:</span> <span class="quoted"><span class="quoted">"map fst <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">js</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> t_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nth_equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> dist <span class="keyword1"><span class="command">have</span></span> dist<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> lenj q degP <span class="keyword1"><span class="command">have</span></span> degq<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">q</span> <span class="main">&lt;</span> length <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> t_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> find_map_filter_None<span class="main">[</span><span class="operator">OF</span> res<span class="main">]</span> t 
    <span class="keyword1"><span class="command">have</span></span> nfilt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">filt</span> <span class="main">(</span>newton_interpolation_poly_int <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> qt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">t</span> <span class="main">⟹</span> poly <span class="skolem">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> t_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> interpolation_poly_int_None<span class="main">[</span><span class="operator">OF</span> dist _ qt degq<span class="main">,</span> <span class="operator">of</span> <span class="quoted">Newton</span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"newton_interpolation_poly_int <span class="skolem">t</span> <span class="main">≠</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> lt<span class="main">:</span> <span class="quoted"><span class="quoted">"newton_interpolation_poly_int <span class="skolem">t</span> <span class="main">=</span> Some <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> newton_interpolation_poly_int_Some<span class="main">[</span><span class="operator">OF</span> dist lt<span class="main">]</span> 
    <span class="keyword1"><span class="command">have</span></span> gt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">t</span> <span class="main">⟹</span> poly <span class="skolem">g</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> degg<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">g</span> <span class="main">&lt;</span> length <span class="skolem">t</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> degq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> uniqueness_of_interpolation_point_list<span class="main">[</span><span class="operator">OF</span> dist qt degq gt degg<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">=</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> nfilt<span class="main">[</span><span class="operator">unfolded</span> lt g<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">filt</span> <span class="main">(</span>Some <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> filt_def<span class="main">]</span> q dvd <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> main <span class="main">=</span> this
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> kronecker_factorization_rat_main_complete<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> 
  none<span class="main">:</span> <span class="quoted"><span class="quoted">"kronecker_factorization_rat_main <span class="free">df</span> <span class="free">dp</span> <span class="free">bnd</span> <span class="free">p</span> <span class="main">=</span> None"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> dp<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">q</span><span class="main">.</span> <span class="main">1</span> <span class="main">≤</span> degree <span class="bound">q</span> <span class="main">∧</span> degree <span class="bound">q</span> <span class="main">≤</span> <span class="free">bnd</span> <span class="main">∧</span> <span class="bound">q</span> <span class="keyword1">dvd</span> <span class="free">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">q</span><span class="main">.</span> <span class="main">1</span> <span class="main">≤</span> degree <span class="bound">q</span> <span class="main">∧</span> degree <span class="bound">q</span> <span class="main">≤</span> <span class="free">bnd</span> <span class="main">∧</span> <span class="bound">q</span> <span class="keyword1">dvd</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> degree <span class="skolem">q</span>"</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">q</span> <span class="main">≤</span> <span class="free">bnd</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="keyword1">dvd</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> dvd <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> prod<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="skolem">q</span> <span class="main">*</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rat_of_int"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rp</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_poly <span class="var">?r</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rat_to_normalized_int_poly <span class="free">p</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span> rp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> rat_to_normalized_int_poly<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> deg<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">P</span> <span class="main">=</span> degree <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> rat_to_int_factor_normalized_int_poly<span class="main">[</span><span class="operator">OF</span> prod rp<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g'</span></span> <span class="keyword2"><span class="keyword">where</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g'</span> <span class="keyword1">dvd</span> <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dg<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">g'</span> <span class="main">=</span> degree <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> dvdI<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"kronecker_factorization_main <span class="free">df</span> <span class="free">dp</span> <span class="free">bnd</span> <span class="skolem">P</span> <span class="main">=</span> None"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> none<span class="main">[</span><span class="operator">unfolded</span> kronecker_factorization_rat_main_def rp<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> kronecker_factorization_main_complete<span class="main">[</span><span class="operator">OF</span> this dp<span class="main"><span class="main">[</span></span><span class="operator">folded</span> deg<span class="main"><span class="main">]</span></span><span class="main">]</span> dg dvd q <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> kronecker_factorization<span class="main">:</span>
  <span class="quoted"><span class="quoted">"kronecker_factorization <span class="free">p</span> <span class="main">=</span> Some <span class="free">q</span> <span class="main">⟹</span> 
    degree <span class="free">q</span> <span class="main">≥</span> <span class="main">1</span> <span class="main">∧</span> degree <span class="free">q</span> <span class="main">&lt;</span> degree <span class="free">p</span> <span class="main">∧</span> <span class="free">q</span> <span class="keyword1">dvd</span> <span class="free">p</span>"</span></span>
  <span class="quoted"><span class="quoted">"kronecker_factorization <span class="free">p</span> <span class="main">=</span> None <span class="main">⟹</span> degree <span class="free">p</span> <span class="main">≥</span> <span class="main">1</span> <span class="main">⟹</span> irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="free">p</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> d <span class="main">=</span> kronecker_factorization_def
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"kronecker_factorization <span class="free">p</span> <span class="main">=</span> Some <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> kronecker_factorization_main_sound<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span><span class="operator"><span class="operator"><span class="operator">unfolded</span></span></span> d<span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">q</span> <span class="main">≥</span> <span class="main">1</span> <span class="main">∧</span> degree <span class="free">q</span> <span class="main">&lt;</span> degree <span class="free">p</span> <span class="main">∧</span> <span class="free">q</span> <span class="keyword1">dvd</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">assume</span></span> kf<span class="main">:</span> <span class="quoted"><span class="quoted">"kronecker_factorization <span class="free">p</span> <span class="main">=</span> None"</span></span> <span class="keyword2"><span class="keyword">and</span></span> deg<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">=</span> <span class="main">1</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True 
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> linear_irreducible<span class="hidden">⇩</span><sub>d</sub><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> deg <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> kronecker_factorization_main_complete<span class="main">[</span><span class="operator">OF</span> divisors_fun_int divisors_pos_fun_int kf<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> d<span class="main"><span class="main">]</span></span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> irreducible<span class="hidden">⇩</span><sub>d</sub>I2<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> kronecker_factorization_rat<span class="main">:</span>
  <span class="quoted"><span class="quoted">"kronecker_factorization_rat <span class="free">p</span> <span class="main">=</span> Some <span class="free">q</span> <span class="main">⟹</span> 
    degree <span class="free">q</span> <span class="main">≥</span> <span class="main">1</span> <span class="main">∧</span> degree <span class="free">q</span> <span class="main">&lt;</span> degree <span class="free">p</span> <span class="main">∧</span> <span class="free">q</span> <span class="keyword1">dvd</span> <span class="free">p</span>"</span></span>
  <span class="quoted"><span class="quoted">"kronecker_factorization_rat <span class="free">p</span> <span class="main">=</span> None <span class="main">⟹</span> degree <span class="free">p</span> <span class="main">≥</span> <span class="main">1</span> <span class="main">⟹</span> irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="free">p</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> d <span class="main">=</span> kronecker_factorization_rat_def
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"kronecker_factorization_rat <span class="free">p</span> <span class="main">=</span> Some <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> kronecker_factorization_rat_main_sound<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span><span class="operator"><span class="operator"><span class="operator">unfolded</span></span></span> d<span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">q</span> <span class="main">≥</span> <span class="main">1</span> <span class="main">∧</span> degree <span class="free">q</span> <span class="main">&lt;</span> degree <span class="free">p</span> <span class="main">∧</span> <span class="free">q</span> <span class="keyword1">dvd</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">assume</span></span> kf<span class="main">:</span> <span class="quoted"><span class="quoted">"kronecker_factorization_rat <span class="free">p</span> <span class="main">=</span> None"</span></span> <span class="keyword2"><span class="keyword">and</span></span> deg<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">=</span> <span class="main">1</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True 
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> linear_irreducible<span class="hidden">⇩</span><sub>d</sub><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> deg <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> kronecker_factorization_rat_main_complete<span class="main">[</span><span class="operator">OF</span> divisors_fun_int divisors_pos_fun_int kf<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> d<span class="main"><span class="main">]</span></span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> irreducible<span class="hidden">⇩</span><sub>d</sub>I2<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>  
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Polynomial_Divisibility">
<div class="head">
<h1>Theory Polynomial_Divisibility</h1>
</div>
<pre class="source"><span class="comment1">(*  
    Author:      René Thiemann 
                 Akihisa Yamada
    License:     BSD
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Polynomial Divisibility›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We make a connection between irreducibility of Missing-Polynomial and Factorial-Ring.›</span></span>


<span class="keyword1"><span class="command">theory</span></span> Polynomial_Divisibility
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../Polynomial_Interpolation/Missing_Polynomial.html">Polynomial_Interpolation.Missing_Polynomial</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dvd_gcd_mult<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> semiring_gcd"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="keyword1">dvd</span> <span class="free">p</span> <span class="main">*</span> <span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="keyword1">dvd</span> <span class="free">p</span> <span class="main">*</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="keyword1">dvd</span> <span class="free">p</span> <span class="main">*</span> gcd <span class="free">q</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> dvd_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> gcd_greatest<span class="main"><span class="main">[</span></span><span class="operator">OF</span> dvd<span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mult_dvd_mono <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gcd_mult_left<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> poly_gcd_monic_factor<span class="main">:</span>
  <span class="quoted"><span class="quoted">"monic <span class="free">p</span> <span class="main">⟹</span>  gcd <span class="main">(</span><span class="free">p</span> <span class="main">*</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">*</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span> <span class="main">*</span> gcd <span class="free">q</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gcdI <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> normalize_mult normalize_monic dvd_gcd_mult<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">SORT_CONSTRAINT</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> field<span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> field_poly_irreducible_dvd_mult<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> irr<span class="main">:</span> <span class="quoted"><span class="quoted">"irreducible <span class="main">(</span><span class="free">p</span> <span class="main">::</span> <span class="tfree">'a</span> poly<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">dvd</span> <span class="free">q</span> <span class="main">*</span> <span class="free">r</span> <span class="main">⟷</span> <span class="free">p</span> <span class="keyword1">dvd</span> <span class="free">q</span> <span class="main">∨</span> <span class="free">p</span> <span class="keyword1">dvd</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> field_poly_irreducible_imp_prime<span class="main">[</span><span class="operator">OF</span> irr<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prime_elem_dvd_mult_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> irreducible_dvd_pow<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> poly"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> irr<span class="main">:</span> <span class="quoted"><span class="quoted">"irreducible <span class="free">p</span>"</span></span>  
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">dvd</span> <span class="free">q</span> <span class="main">^</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">p</span> <span class="keyword1">dvd</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> field_poly_irreducible_imp_prime<span class="main">[</span><span class="operator">OF</span> irr<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prime_elem_dvd_power<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> irreducible_dvd_prod<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> irr<span class="main">:</span> <span class="quoted"><span class="quoted">"irreducible <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">dvd</span> prod <span class="free">f</span> <span class="free">as</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">as</span><span class="main">.</span> <span class="free">p</span> <span class="keyword1">dvd</span> <span class="free">f</span> <span class="bound">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> dvd<span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="free">as</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infinite_finite_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> irr<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> irreducible_dvd_prod_list<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> irr<span class="main">:</span> <span class="quoted"><span class="quoted">"irreducible <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">dvd</span> prod_list <span class="free">as</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="free">as</span><span class="main">.</span> <span class="free">p</span> <span class="keyword1">dvd</span> <span class="bound">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> dvd<span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="free">as</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> irr<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> dvd_mult_imp_degree<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> poly"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">dvd</span> <span class="free">q</span> <span class="main">*</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> irreducible <span class="bound">s</span> <span class="main">∧</span> <span class="free">p</span> <span class="main">=</span> <span class="bound">s</span> <span class="main">*</span> <span class="bound">t</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">s</span> <span class="keyword1">dvd</span> <span class="free">q</span> <span class="main">∨</span> <span class="bound">s</span> <span class="keyword1">dvd</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> irreducible<span class="hidden">⇩</span><sub>d</sub>_factor<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">t</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> irred<span class="main">:</span> <span class="quoted"><span class="quoted">"irreducible <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="skolem">s</span> <span class="main">*</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="keyword1">dvd</span> <span class="free">q</span> <span class="main">*</span> <span class="free">r</span>›</span></span> p <span class="keyword1"><span class="command">have</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="keyword1">dvd</span> <span class="free">q</span> <span class="main">*</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> s p irred <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Fundamental_Theorem_Algebra_Factorized">
<div class="head">
<h1>Theory Fundamental_Theorem_Algebra_Factorized</h1>
</div>
<pre class="source"><span class="comment1">(*  
    Author:      René Thiemann 
    License:     BSD
*)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Fundamental Theorem of Algebra for Factorizations›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Via the existing formulation of the fundamental theorem of algebra,
  we prove that we always get a linear factorization of a complex polynomial.
  Using this factorization we show that root-square-freeness of complex polynomial
  is identical to the statement that the cardinality of the set of all roots 
  is equal to the degree of the polynomial.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Fundamental_Theorem_Algebra_Factorized
<span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="Order_Polynomial.html">Order_Polynomial</a>
  <span class="quoted">"<a href="../../HOL/HOL-Computational_Algebra/Fundamental_Theorem_Algebra.html">HOL-Computational_Algebra.Fundamental_Theorem_Algebra</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fundamental_theorem_algebra_factorized<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"complex poly"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">as</span><span class="main">.</span> smult <span class="main">(</span>coeff <span class="free">p</span> <span class="main">(</span>degree <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">∏</span> <span class="bound">a</span> <span class="main">←</span> <span class="bound">as</span><span class="main">.</span> <span class="main">[:</span><span class="main">-</span> <span class="bound">a</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∧</span> length <span class="bound">as</span> <span class="main">=</span> degree <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> degree <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> n_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>0 <span class="skolem">p</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">c</span><span class="main">.</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">[:</span> <span class="bound">c</span> <span class="main">:]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">p</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">Nil</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="skolem">p</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> dp<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">p</span> <span class="main">=</span> Suc <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> constant <span class="main">(</span>poly <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> constant_degree<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> fundamental_theorem_of_algebra<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> rt<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="skolem">p</span> <span class="skolem">c</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[:</span><span class="main">-</span><span class="skolem">c</span><span class="main">,</span><span class="main">1</span> <span class="main">:]</span> <span class="keyword1">dvd</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dvd_iff_poly_eq_0<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="skolem">q</span> <span class="main">*</span> <span class="main">[:</span> <span class="main">-</span><span class="skolem">c</span><span class="main">,</span><span class="main">1</span> <span class="main">:]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dvd_def mult.commute<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹degree <span class="skolem">p</span> <span class="main">=</span> Suc <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> dq<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">q</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> add.right_neutral degree_synthetic_div diff_Suc_1 mult.commute mult_left_cancel p pCons_eq_0_iff rt synthetic_div_correct' zero_neq_one<span class="main">)</span> 
    <span class="keyword1"><span class="command">from</span></span> Suc<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="keyword2"><span class="keyword">where</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[:</span>coeff <span class="skolem">q</span> <span class="main">(</span>degree <span class="skolem">q</span><span class="main">)</span><span class="main">:]</span> <span class="main">*</span> <span class="main">(</span><span class="main">∏</span><span class="bound">a</span><span class="main">←</span><span class="skolem">as</span><span class="main">.</span> <span class="main">[:</span><span class="main">-</span> <span class="bound">a</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">q</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> deg<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">as</span> <span class="main">=</span> degree <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> dc<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">p</span> <span class="main">=</span> degree <span class="skolem">q</span> <span class="main">+</span> degree <span class="main">[:</span> <span class="main">-</span><span class="skolem">c</span><span class="main">,</span> <span class="main">1</span> <span class="main">:]</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dq dp <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> cq<span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="skolem">q</span> <span class="main">(</span>degree <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> coeff <span class="skolem">p</span> <span class="main">(</span>degree <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dc <span class="keyword1"><span class="command">unfolding</span></span> p coeff_mult_degree_sum <span class="keyword1"><span class="command">unfolding</span></span> dq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> p<span class="main">[</span><span class="operator">unfolded</span> q<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> cq<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">c</span></span></span> <span class="main"><span class="main"><span class="main">#</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">as</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> deg dc<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rsquarefree_card_degree<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> p0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">::</span> complex poly<span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rsquarefree <span class="free">p</span> <span class="main">=</span> <span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span> degree <span class="free">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> fundamental_theorem_algebra_factorized<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="skolem"><span class="skolem">as</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> smult <span class="skolem">c</span> <span class="main">(</span><span class="main">∏</span> <span class="bound">a</span> <span class="main">←</span> <span class="skolem">as</span><span class="main">.</span> <span class="main">[:</span><span class="main">-</span> <span class="bound">a</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> pas<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">=</span> length <span class="skolem">as</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> coeff <span class="free">p</span> <span class="main">(</span>degree <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?prod</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="bound">a</span><span class="main">←</span><span class="skolem">as</span><span class="main">.</span> <span class="main">[:</span><span class="main">-</span> <span class="bound">a</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> p0 <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> c <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> roots<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span> set <span class="skolem">as</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> p poly_smult_zero_iff poly_prod_list prod_list_zero_iff
    <span class="keyword1"><span class="command">using</span></span> c <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> idr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span> degree <span class="free">p</span><span class="main">)</span> <span class="main">=</span> distinct <span class="skolem">as</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> roots pas
    <span class="keyword1"><span class="command">using</span></span> card_distinct distinct_card <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="free">p</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="bound">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> dist<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">as</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span><span class="skolem">as</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">a</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">≤</span> Suc <span class="main">0</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">a</span><span class="main">.</span> <span class="var">?r</span> <span class="bound">a</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">as</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">from</span></span> not_distinct_decomp<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">zs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?r</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
      <span class="keyword1"><span class="command">from</span></span> True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">as</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">b</span> <span class="skolem">bs</span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">with</span></span> Cons<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> set <span class="skolem">bs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span> <span class="skolem">bs</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">a</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">bs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rsquarefree <span class="free">p</span> <span class="main">=</span> distinct <span class="skolem">as</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> rsquarefree_def' id <span class="keyword1"><span class="command">unfolding</span></span> p order_smult<span class="main">[</span><span class="operator">OF</span> c<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> order_prod_list<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def order_linear' dist<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> idr <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Square_Free_Factorization">
<div class="head">
<h1>Theory Square_Free_Factorization</h1>
</div>
<pre class="source"><span class="comment1">(*  
    Author:      René Thiemann 
                 Akihisa Yamada
    License:     BSD
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Square Free Factorization›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We implemented Yun's algorithm to perform a square-free factorization of a polynomial.
We further show properties of a square-free factorization, namely that the exponents in
the square-free factorization are exactly the orders of the roots. We also show that 
factorizing the result of square-free factorization further will again result in a 
square-free factorization, and that square-free factorizations can be lifted homomorphically.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Square_Free_Factorization
<span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="../Matrix/Utility.html">Matrix.Utility</a>
  <a href="Polynomial_Divisibility.html">Polynomial_Divisibility</a>
  <a href="Order_Polynomial.html">Order_Polynomial</a>
  <a href="Fundamental_Theorem_Algebra_Factorized.html">Fundamental_Theorem_Algebra_Factorized</a>
  <a href="../Polynomial_Interpolation/Ring_Hom_Poly.html">Polynomial_Interpolation.Ring_Hom_Poly</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">square_free</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> comm_semiring_1 poly <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">square_free</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">q</span><span class="main">.</span> degree <span class="bound">q</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="main">(</span><span class="bound">q</span> <span class="main">*</span> <span class="bound">q</span> <span class="keyword1">dvd</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> square_freeI<span class="main">:</span>  
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">q</span><span class="main">.</span> degree <span class="bound">q</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="bound">q</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="bound">q</span> <span class="main">*</span> <span class="bound">q</span> <span class="keyword1">dvd</span> <span class="free">p</span> <span class="main">⟹</span> False"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"square_free <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> square_free_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI conjI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> p<span class="main"><span class="main">]</span></span> impI notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">q</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> 1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> _ 1<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> 1<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> square_free_multD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sf<span class="main">:</span> <span class="quoted"><span class="quoted">"square_free <span class="main">(</span><span class="free">f</span> <span class="main">*</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="keyword1">dvd</span> <span class="free">f</span> <span class="main">⟹</span> <span class="free">h</span> <span class="keyword1">dvd</span> <span class="free">g</span> <span class="main">⟹</span> degree <span class="free">h</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"square_free <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"square_free <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> sf<span class="main">[</span><span class="operator">unfolded</span> square_free_def<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">*</span> <span class="bound">q</span> <span class="keyword1">dvd</span> <span class="free">f</span> <span class="main">*</span> <span class="free">g</span> <span class="main">⟹</span> degree <span class="bound">q</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"square_free <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"square_free <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> square_free_def<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="keyword1">dvd</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="keyword1">dvd</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">*</span> <span class="free">h</span> <span class="keyword1">dvd</span> <span class="free">f</span> <span class="main">*</span> <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_dvd_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> dvd<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">h</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> irreducible<span class="hidden">⇩</span><sub>d</sub>_square_free<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>comm_semiring_1<span class="main">,</span> semiring_no_zero_divisors<span class="main">}</span> poly"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="free">p</span> <span class="main">⟹</span> square_free <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> degree_0 degree_mult_eq degree_mult_eq_0 irreducible<span class="hidden">⇩</span><sub>d</sub>D<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> irreducible<span class="hidden">⇩</span><sub>d</sub>D<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> irreducible<span class="hidden">⇩</span><sub>d</sub>_dvd_smult irreducible<span class="hidden">⇩</span><sub>d</sub>_smultI less_add_same_cancel2 not_gr_zero square_free_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> square_free_factor<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">dvd</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> sf<span class="main">:</span> <span class="quoted"><span class="quoted">"square_free <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"square_free <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> square_freeI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
  <span class="keyword3"><span class="command">assume</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">q</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">*</span> <span class="skolem">q</span> <span class="keyword1">dvd</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">*</span> <span class="skolem">q</span> <span class="keyword1">dvd</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dvd dvd_trans sf square_free_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> sf<span class="main">[</span><span class="operator">unfolded</span> square_free_def<span class="main">]</span> q <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> dvd sf<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> square_free_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> square_free_prod_list_distinct<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> sf<span class="main">:</span> <span class="quoted"><span class="quoted">"square_free <span class="main">(</span>prod_list <span class="free">us</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> idom poly<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> us<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> set <span class="free">us</span> <span class="main">⟹</span> degree <span class="bound">u</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">us</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> distinct <span class="free">us</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> not_distinct_decomp<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span>
     <span class="quoted"><span class="quoted">"<span class="free">us</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">u</span> <span class="main">#</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="skolem">u</span> <span class="main">#</span> <span class="skolem">zs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">*</span> <span class="skolem">u</span> <span class="keyword1">dvd</span> prod_list <span class="free">us</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> set <span class="free">us</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> dvd us<span class="main">[</span><span class="operator">OF</span> u<span class="main">]</span> sf <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prod_list <span class="free">us</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> square_free_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∈</span> set <span class="free">us</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_list_zero_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> us<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">separable</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">separable</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> coprime <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>pderiv <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> separable_imp_square_free<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sep<span class="main">:</span> <span class="quoted"><span class="quoted">"separable <span class="main">(</span><span class="free">f</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>field<span class="main">,</span> factorial_ring_gcd<span class="main">,</span> semiring_gcd_mult_normalize<span class="main">}</span> poly<span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"square_free <span class="free">f</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> sep <span class="main">=</span> sep<span class="main">[</span><span class="operator">unfolded</span> separable_def<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> sep <span class="keyword1"><span class="command">have</span></span> f0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">f</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> square_free <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">g</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">*</span> <span class="skolem">g</span> <span class="keyword1">dvd</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f0 <span class="keyword1"><span class="command">unfolding</span></span> square_free_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="skolem">g</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">g</span> <span class="main">*</span> <span class="skolem">h</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pderiv <span class="free">f</span> <span class="main">=</span> <span class="skolem">g</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="skolem">g</span> <span class="main">*</span> pderiv <span class="skolem">h</span> <span class="main">+</span> <span class="skolem">h</span> <span class="main">*</span> pderiv <span class="skolem">g</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">h</span> <span class="main">*</span> pderiv <span class="skolem">g</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> f pderiv_mult<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">g</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="keyword1">dvd</span> pderiv <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="keyword1">dvd</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> f dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="keyword1">dvd</span> <span class="main">(</span>gcd <span class="free">f</span> <span class="main">(</span>pderiv <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gcd <span class="free">f</span> <span class="main">(</span>pderiv <span class="free">f</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> g dvd <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span>gcd <span class="free">f</span> <span class="main">(</span>pderiv <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sep poly_dvd_1<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> coprime <span class="free">f</span> <span class="main">(</span>pderiv <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> sep <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> square_free_rsquarefree<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"square_free <span class="free">f</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rsquarefree <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rsquarefree_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI allI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"order <span class="skolem">x</span> <span class="free">f</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> order <span class="skolem">x</span> <span class="free">f</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?thesis</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> ord<span class="main">:</span> <span class="quoted"><span class="quoted">"order <span class="skolem">x</span> <span class="free">f</span> <span class="main">=</span> Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"order <span class="skolem">x</span> <span class="free">f</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"order <span class="skolem">x</span> <span class="free">f</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="main">[:</span><span class="main">-</span><span class="skolem">x</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> order_divides<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">,</span> <span class="operator">unfolded</span> ord<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">*</span> <span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> p_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> square_free <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> square_free_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> f<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> square_free_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> square_free_prodD<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">fs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>field<span class="main">,</span>euclidean_ring_gcd<span class="main">,</span>semiring_gcd_mult_normalize<span class="main">}</span> poly set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sf<span class="main">:</span> <span class="quoted"><span class="quoted">"square_free <span class="main">(</span><span class="main">∏</span> <span class="free">fs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> <span class="free">fs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> fg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≠</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">f</span> <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span> <span class="free">fs</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">*</span> <span class="main">(</span><span class="main">∏</span> <span class="main">(</span><span class="free">fs</span> <span class="main">-</span> <span class="main">{</span><span class="free">f</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod.remove<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fin f<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span> <span class="main">(</span><span class="free">fs</span> <span class="main">-</span> <span class="main">{</span><span class="free">f</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span> <span class="main">*</span> <span class="main">(</span><span class="main">∏</span> <span class="main">(</span><span class="free">fs</span> <span class="main">-</span> <span class="main">{</span><span class="free">f</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="free">g</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod.remove<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> fin g fg<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> sf<span class="main">:</span> <span class="quoted"><span class="quoted">"square_free <span class="main">(</span><span class="free">f</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sf <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> sf<span class="main">[</span><span class="operator">unfolded</span> square_free_def<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">*</span> <span class="bound">q</span> <span class="keyword1">dvd</span> <span class="free">f</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="skolem">k</span> <span class="main">⟹</span> degree <span class="bound">q</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gcd <span class="free">f</span> <span class="free">g</span> <span class="main">*</span> gcd <span class="free">f</span> <span class="free">g</span> <span class="keyword1">dvd</span> <span class="free">f</span> <span class="main">*</span> <span class="free">g</span> <span class="main">*</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_dvd_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> dvd<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span>gcd <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span> 
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gcd <span class="free">f</span> <span class="free">g</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">f</span> <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> is_unit_gcd<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">g</span></span><span class="main">]</span> is_unit_iff_degree<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"gcd <span class="free">f</span> <span class="free">g</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>    
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rsquarefree_square_free_complex<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rsquarefree <span class="main">(</span><span class="free">p</span> <span class="main">::</span> complex poly<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"square_free <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> square_freeI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
  <span class="keyword3"><span class="command">assume</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">q</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">*</span> <span class="skolem">q</span> <span class="keyword1">dvd</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> d <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> constant <span class="main">(</span>poly <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> constant_degree<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> fundamental_theorem_of_algebra<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"poly <span class="skolem">q</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[:</span><span class="main">-</span><span class="skolem">x</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span> <span class="keyword1">dvd</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> poly_eq_0_iff_dvd<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> <span class="main">[:</span><span class="main">-</span><span class="skolem">x</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span> <span class="main">*</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> dvd <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="skolem">q</span> <span class="main">*</span> <span class="skolem">q</span> <span class="main">*</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> p<span class="main">[</span><span class="operator">unfolded</span> q<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">[:</span><span class="main">-</span><span class="skolem">x</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span><span class="main">^</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">*</span> <span class="skolem">k</span> <span class="main">*</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">algebra</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[:</span><span class="main">-</span><span class="skolem">x</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span><span class="main">^</span><span class="numeral">2</span> <span class="keyword1">dvd</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> order_divides<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="main">¬</span> order <span class="skolem">x</span> <span class="free">p</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> rsquarefree_def' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rsquarefree_def<span class="main">)</span>
   
<span class="keyword1"><span class="command">lemma</span></span> square_free_separable_main<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>field<span class="main">,</span>factorial_ring_gcd<span class="main">,</span>semiring_gcd_mult_normalize<span class="main">}</span> poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"square_free <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> sep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> separable <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">g</span> <span class="bound">k</span><span class="main">.</span> <span class="free">f</span> <span class="main">=</span> <span class="bound">g</span> <span class="main">*</span> <span class="bound">k</span> <span class="main">∧</span> degree <span class="bound">g</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> pderiv <span class="bound">g</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> cop <span class="main">=</span> sep<span class="main">[</span><span class="operator">unfolded</span> separable_def<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> square_free_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"gcd <span class="free">f</span> <span class="main">(</span>pderiv <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">G</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="main">=</span> <span class="var">?g</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> poly_gcd_monic<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="quoted">"pderiv <span class="free">f</span>"</span></span><span class="main">]</span> f <span class="keyword1"><span class="command">have</span></span> mon<span class="main">:</span> <span class="quoted"><span class="quoted">"monic <span class="var">?g</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> deg<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">G</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">G</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">from</span></span> degree0_coeffs<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> cop mon <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G_def coprime_iff_gcd_eq_1<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> gf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="keyword1">dvd</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> G_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> gf'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="keyword1">dvd</span> pderiv <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> G_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> irreducible<span class="hidden">⇩</span><sub>d</sub>_factor<span class="main">[</span><span class="operator">OF</span> deg<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"irreducible <span class="skolem">g</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="main">=</span> <span class="skolem">g</span> <span class="main">*</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> gf <span class="keyword1"><span class="command">have</span></span> gf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="keyword1">dvd</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> dvd_mult_left<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> gf' <span class="keyword1"><span class="command">have</span></span> gf'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="keyword1">dvd</span> pderiv <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> dvd_mult_left<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> g0<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">g</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> g <span class="keyword1"><span class="command">unfolding</span></span> irreducible<span class="hidden">⇩</span><sub>d</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> gf <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> fgk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="skolem">g</span> <span class="main">*</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> id1<span class="main">:</span> <span class="quoted"><span class="quoted">"pderiv <span class="free">f</span> <span class="main">=</span> <span class="skolem">g</span> <span class="main">*</span> pderiv <span class="skolem">k</span> <span class="main">+</span> <span class="skolem">k</span> <span class="main">*</span> pderiv <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> fgk pderiv_mult <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> gf' <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"pderiv <span class="free">f</span> <span class="main">=</span> <span class="skolem">g</span> <span class="main">*</span> <span class="skolem">h</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> id1<span class="main">[</span><span class="operator">unfolded</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">*</span> pderiv <span class="skolem">g</span> <span class="main">=</span> <span class="skolem">g</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">h</span> <span class="main">-</span> pderiv <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="keyword1">dvd</span> <span class="skolem">k</span> <span class="main">*</span> pderiv <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="keyword1">dvd</span> <span class="skolem">k</span>"</span></span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="skolem">g</span> <span class="main">*</span> <span class="skolem">h</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> fgk <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">*</span> <span class="skolem">g</span> <span class="keyword1">dvd</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> g0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> square_free <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> square_free_def <span class="keyword1"><span class="command">using</span></span> f <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span>  g dvd 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="keyword1">dvd</span> pderiv <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> divides_degree<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> degree_pderiv_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">g</span></span><span class="main">]</span> g0
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pderiv <span class="skolem">g</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">with</span></span> fgk g0 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> square_free_imp_separable<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>field_char_0<span class="main">,</span>factorial_ring_gcd<span class="main">,</span>semiring_gcd_mult_normalize<span class="main">}</span> poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"square_free <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"separable <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> separable <span class="free">f</span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> square_free_separable_main<span class="main">[</span><span class="operator">OF</span> assms this<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="skolem">g</span> <span class="main">*</span> <span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">g</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"pderiv <span class="skolem">g</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="keyword1">dvd</span> pderiv <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_pderiv_iff <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
   

<span class="keyword1"><span class="command">lemma</span></span> square_free_iff_separable<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"square_free <span class="main">(</span><span class="free">f</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>field_char_0<span class="main">,</span>factorial_ring_gcd<span class="main">,</span>semiring_gcd_mult_normalize<span class="main">}</span> poly<span class="main">)</span> <span class="main">=</span> separable <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> separable_imp_square_free<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> square_free_imp_separable<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">SORT_CONSTRAINT</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>field<span class="main">,</span>factorial_ring_gcd<span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lemma</span></span> square_free_smult<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> square_free <span class="main">(</span><span class="free">f</span> <span class="main">::</span> <span class="tfree">'a</span> poly<span class="main">)</span> <span class="main">⟹</span> square_free <span class="main">(</span>smult <span class="free">c</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> square_free_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> dvd_smult_cancel<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">c</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> square_free_smult_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> square_free <span class="main">(</span>smult <span class="free">c</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> square_free <span class="main">(</span><span class="free">f</span> <span class="main">::</span> <span class="tfree">'a</span> poly<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> square_free_smult<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> square_free_smult<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"inverse <span class="free">c</span>"</span></span> <span class="quoted"><span class="quoted">"smult <span class="free">c</span> <span class="free">f</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">SORT_CONSTRAINT</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>factorial_ring_gcd<span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">square_free_factorization</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> poly <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span> poly <span class="main">×</span> nat<span class="main">)</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">square_free_factorization</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">cbs</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">cbs</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">bs</span><span class="main">)</span> <span class="main">⇒</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> smult <span class="bound">c</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span> set <span class="bound">bs</span><span class="main">.</span> <span class="bound">a</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span>
  <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> <span class="bound">c</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">bs</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span>
  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">a</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="bound">bs</span> <span class="main">⟶</span> square_free <span class="bound">a</span> <span class="main">∧</span> degree <span class="bound">a</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span>
  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">a</span> <span class="bound">i</span> <span class="bound">b</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="bound">bs</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span> <span class="main">∈</span> set <span class="bound">bs</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">≠</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span> <span class="main">⟶</span> coprime <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span>
  <span class="main">∧</span> distinct <span class="bound">bs</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> square_free_factorizationD<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"square_free_factorization <span class="free">p</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">bs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> smult <span class="free">c</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span> set <span class="free">bs</span><span class="main">.</span> <span class="bound">a</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">bs</span> <span class="main">⟹</span> square_free <span class="free">a</span> <span class="main">∧</span> degree <span class="free">a</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">bs</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">b</span><span class="main">,</span><span class="free">j</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">bs</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">i</span><span class="main">)</span> <span class="main">≠</span> <span class="main">(</span><span class="free">b</span><span class="main">,</span><span class="free">j</span><span class="main">)</span> <span class="main">⟹</span> coprime <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">bs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="quoted"><span class="quoted">"distinct <span class="free">bs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> square_free_factorization_def split <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> square_free_factorization_prod_list<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"square_free_factorization <span class="free">p</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">bs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> smult <span class="free">c</span> <span class="main">(</span>prod_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">.</span> <span class="bound">a</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span> <span class="free">bs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> sff <span class="main">=</span> square_free_factorizationD<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> sff<span class="main">(</span>1<span class="main">)</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod.distinct_set_conv_list<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sff<span class="main"><span class="main"><span class="main">(</span></span></span>5<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Yun's factorization algorithm›</span></span>
<span class="keyword1"><span class="command">locale</span></span> yun_gcd <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Gcd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> factorial_ring_gcd poly <span class="main">⇒</span> <span class="tfree">'a</span> poly <span class="main">⇒</span> <span class="tfree">'a</span> poly"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>tailrec<span class="main">)</span> <span class="entity">yun_factorization_main</span> <span class="main">::</span> 
  <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> poly <span class="main">⇒</span> <span class="tfree">'a</span> poly <span class="main">⇒</span>
    nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> poly <span class="main">×</span> nat<span class="main">)</span>list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> poly <span class="main">×</span> nat<span class="main">)</span>list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">yun_factorization_main</span> <span class="free"><span class="bound"><span class="entity">bn</span></span></span> <span class="free"><span class="bound"><span class="entity">cn</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">sqr</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">bn</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">sqr</span></span></span>
    <span class="keyword1">else</span> <span class="main">(</span>
    <span class="keyword1">let</span> 
      <span class="bound">dn</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">cn</span></span></span> <span class="main">-</span> pderiv <span class="free"><span class="bound"><span class="entity">bn</span></span></span><span class="main">;</span>
      <span class="bound">an</span> <span class="main">=</span> <span class="free">Gcd</span> <span class="free"><span class="bound"><span class="entity">bn</span></span></span> <span class="bound">dn</span>
    <span class="keyword1">in</span> <span class="free">yun_factorization_main</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bn</span></span></span> <span class="keyword1">div</span> <span class="bound">an</span><span class="main">)</span> <span class="main">(</span><span class="bound">dn</span> <span class="keyword1">div</span> <span class="bound">an</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="bound">an</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">sqr</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">yun_monic_factorization</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> poly <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> poly <span class="main">×</span> nat<span class="main">)</span>list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">yun_monic_factorization</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span>
    <span class="bound">pp</span> <span class="main">=</span> pderiv <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">;</span>
    <span class="bound">u</span> <span class="main">=</span> <span class="free">Gcd</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">pp</span><span class="main">;</span>
    <span class="bound">b0</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">div</span> <span class="bound">u</span><span class="main">;</span>
    <span class="bound">c0</span> <span class="main">=</span> <span class="bound">pp</span> <span class="keyword1">div</span> <span class="bound">u</span>
    <span class="keyword1">in</span> 
      <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">.</span> <span class="bound">a</span> <span class="main">≠</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>yun_factorization_main <span class="bound">b0</span> <span class="bound">c0</span> <span class="main">0</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">square_free_monic_poly</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> poly <span class="main">⇒</span> <span class="tfree">'a</span> poly"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">square_free_monic_poly</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">div</span> <span class="main">(</span><span class="free">Gcd</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span>pderiv <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">declare</span></span> yun_gcd.yun_monic_factorization_def <span class="main">[</span><span class="operator">code</span><span class="main">]</span> 
<span class="keyword1"><span class="command">declare</span></span> yun_gcd.yun_factorization_main.simps <span class="main">[</span><span class="operator">code</span><span class="main">]</span> 
<span class="keyword1"><span class="command">declare</span></span> yun_gcd.square_free_monic_poly_def <span class="main">[</span><span class="operator">code</span><span class="main">]</span>

<span class="keyword1"><span class="command">context</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Gcd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>field_char_0<span class="main">,</span>euclidean_ring_gcd<span class="main">}</span> poly <span class="main">⇒</span> <span class="tfree">'a</span> poly <span class="main">⇒</span> <span class="tfree">'a</span> poly"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">interpretation</span></span> yun_gcd <span class="quoted"><span class="free">Gcd</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">square_free_poly</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> poly <span class="main">⇒</span> <span class="tfree">'a</span> poly"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">square_free_poly</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> 
     square_free_monic_poly <span class="main">(</span>smult <span class="main">(</span>inverse <span class="main">(</span>coeff <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span>degree <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">yun_factorization</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> poly <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span> poly <span class="main">×</span> nat<span class="main">)</span>list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">yun_factorization</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">0</span>
    <span class="keyword1">then</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">let</span> 
      <span class="bound">c</span> <span class="main">=</span> coeff <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span>degree <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">;</span>
      <span class="bound">q</span> <span class="main">=</span> smult <span class="main">(</span>inverse <span class="bound">c</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>
    <span class="keyword1">in</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span> yun_monic_factorization <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> yun_factorization_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"yun_factorization <span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> yun_factorization_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> monic_factorization <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">as</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>field_char_0<span class="main">,</span>euclidean_ring_gcd<span class="main">,</span>semiring_gcd_mult_normalize<span class="main">}</span> poly <span class="main">×</span> nat<span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> prod <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">.</span> <span class="bound">a</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span> <span class="free">as</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">as</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> as_distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="bound">i</span> <span class="bound">b</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">as</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span> <span class="main">∈</span> <span class="free">as</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">≠</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">≠</span> <span class="bound">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> as_irred<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">as</span> <span class="main">⟹</span> irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="bound">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> as_monic<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">as</span> <span class="main">⟹</span> monic <span class="bound">a</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> poly_exp_expand<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">(</span>prod <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">.</span> <span class="bound">a</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span> <span class="free">as</span><span class="main">)</span> <span class="main">*</span> prod <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">.</span> <span class="bound">a</span><span class="main">)</span> <span class="free">as</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> p prod.distrib<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pderiv_exp_prod<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"pderiv <span class="free">p</span> <span class="main">=</span> <span class="main">(</span>prod <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">.</span> <span class="bound">a</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span> <span class="free">as</span> <span class="main">*</span> sum <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">.</span> 
    prod <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> <span class="bound">b</span><span class="main">)</span> <span class="main">(</span><span class="free">as</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">*</span> smult <span class="main">(</span>of_nat <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>pderiv <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="free">as</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> p pderiv_prod sum_distrib_left
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">as</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">as</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?si</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"smult <span class="main">(</span>of_nat <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">::</span> <span class="tfree">'a</span> poly <span class="main">⇒</span> <span class="tfree">'a</span> poly"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span><span class="free">as</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">.</span> <span class="bound">a</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> pderiv <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">a</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span> <span class="main">=</span>
         <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span><span class="free">as</span><span class="main">.</span> <span class="bound">a</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span>
         <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span><span class="free">as</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> <span class="bound">a</span><span class="main">)</span> <span class="main">*</span> smult <span class="main">(</span>of_nat <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>pderiv <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> x split pderiv_power_Suc
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?prod</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span><span class="free">as</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> <span class="bound">a</span> <span class="main">^</span> Suc <span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?prod</span> <span class="main">*</span> <span class="main">(</span><span class="var">?si</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">^</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">*</span> pderiv <span class="skolem">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span><span class="free">as</span><span class="main">.</span> <span class="bound">a</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span><span class="free">as</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> <span class="bound">a</span><span class="main">)</span> <span class="main">*</span> <span class="var">?si</span> <span class="main">(</span>pderiv <span class="skolem">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">^</span> <span class="skolem">i</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span><span class="free">as</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> <span class="bound">a</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span><span class="free">as</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> <span class="bound">a</span><span class="main">)</span> <span class="main">*</span> <span class="var">?si</span> <span class="main">(</span>pderiv <span class="skolem">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> prod.remove<span class="main">[</span><span class="operator">OF</span> fin mem<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span><span class="free">as</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> <span class="bound">a</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span><span class="free">as</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> <span class="bound">a</span><span class="main">)</span> 
      <span class="main">=</span> <span class="var">?prod</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> prod.distrib<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod.cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> monic_gen<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">bs</span> <span class="main">⊆</span> <span class="free">as</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"monic <span class="main">(</span><span class="main">∏</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">bs</span><span class="main">.</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> monic_prod<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> assms as_monic<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nonzero_gen<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">bs</span> <span class="main">⊆</span> <span class="free">as</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">bs</span><span class="main">.</span> <span class="bound">a</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> monic_gen<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> monic_Prod<span class="main">:</span> <span class="quoted"><span class="quoted">"monic <span class="main">(</span><span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span><span class="free">as</span><span class="main">.</span> <span class="bound">a</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> monic_prod<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> as_monic<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> monic_power<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> coprime_generic<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> bs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bs</span> <span class="main">⊆</span> <span class="free">as</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">bs</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">bs</span><span class="main">.</span> <span class="bound">a</span><span class="main">)</span>
     <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span> <span class="free">bs</span><span class="main">.</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">∈</span> <span class="free">bs</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span> <span class="main">.</span> <span class="bound">b</span><span class="main">)</span> <span class="main">*</span> smult <span class="main">(</span>of_nat <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>pderiv <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"coprime <span class="var">?single</span> <span class="var">?onederiv</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> single<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?single</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nonzero_gen<span class="main"><span class="main">[</span></span><span class="operator">OF</span> bs<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> gcd_eq_1_imp_coprime<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> gcdI <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword3"><span class="command">assume</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="keyword1">dvd</span> <span class="var">?single</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="keyword1">dvd</span> <span class="var">?onederiv</span>"</span></span>
    <span class="keyword1"><span class="command">note</span></span> bs_monic <span class="main">=</span> as_monic<span class="main">[</span><span class="operator">OF</span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> bs<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">from</span></span> dvd<span class="main">(</span>1<span class="main">)</span> single <span class="keyword1"><span class="command">have</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="keyword1">dvd</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> k <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="main">[:</span><span class="skolem">c</span><span class="main">:]</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> degree0_coeffs<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> k <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">=</span> <span class="main">[:</span><span class="skolem">c</span><span class="main">:]</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"is_unit <span class="skolem">k</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> dvdI <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="quoted">"<span class="main">[:</span><span class="skolem">c</span><span class="main">:]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[:</span><span class="main">1</span> <span class="main">/</span> <span class="skolem">c</span><span class="main">:]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">from</span></span> irreducible<span class="hidden">⇩</span><sub>d</sub>_factor<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">*</span> <span class="skolem">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"irreducible <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> k dvd <span class="keyword1"><span class="command">have</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="var">?single</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="var">?onederiv</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> irreducible_dvd_prod<span class="main">[</span><span class="operator">OF</span> p dvd<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> ai<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">bs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> pa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="skolem">a</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">*</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> p<span class="main">[</span><span class="operator">unfolded</span> irreducible<span class="hidden">⇩</span><sub>d</sub>_def<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> p0<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">p</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> irreducible<span class="hidden">⇩</span><sub>d</sub>_dvd_smult<span class="main">[</span><span class="operator">OF</span> p0 as_irred pa<span class="main">]</span> ai bs
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ap<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> smult <span class="skolem">c</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> ap'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> smult <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="skolem">c</span><span class="main">)</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?prod</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">a</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">∈</span><span class="free">bs</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> <span class="bound">b</span><span class="main">)</span> <span class="main">*</span> smult <span class="main">(</span>of_nat <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>pderiv <span class="bound">a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?prod'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">aa</span> <span class="bound">ii</span> <span class="bound">a</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">∈</span><span class="free">bs</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="bound">aa</span><span class="main">,</span><span class="bound">ii</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> <span class="bound">b</span><span class="main">)</span> <span class="main">*</span> smult <span class="main">(</span>of_nat <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>pderiv <span class="bound">a</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">factor</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">factor</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> <span class="var">?prod'</span> <span class="skolem">a</span> <span class="skolem">i</span> <span class="bound">b</span> <span class="bound">j</span> <span class="main">)</span> <span class="main">(</span><span class="free">bs</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">fac</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">fac</span> <span class="main">=</span> <span class="skolem">q</span> <span class="main">*</span> <span class="skolem">factor</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> fin finite_subset<span class="main">[</span><span class="operator">OF</span> bs<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">bs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?onederiv</span> <span class="main">=</span> <span class="var">?prod</span> <span class="skolem">a</span> <span class="skolem">i</span> <span class="main">+</span> sum <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> <span class="var">?prod</span> <span class="bound">b</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span><span class="free">bs</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.remove<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fin ai<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> <span class="var">?prod</span> <span class="bound">b</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span><span class="free">bs</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>
        <span class="main">=</span> <span class="skolem">a</span> <span class="main">*</span> <span class="skolem">factor</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> factor_def sum_distrib_left
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">bj</span>
        <span class="keyword3"><span class="command">assume</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bj</span> <span class="main">∈</span> <span class="free">bs</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span><span class="main">}</span>"</span></span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> bj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bj</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">from</span></span> mem bj ai <span class="keyword1"><span class="command">have</span></span> ai<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">bs</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bs</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="skolem">b</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="free">bs</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> <span class="var">?prod</span> <span class="bound">b</span> <span class="bound">j</span><span class="main">)</span> <span class="skolem">bj</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">*</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> <span class="var">?prod'</span> <span class="skolem">a</span> <span class="skolem">i</span> <span class="bound">b</span> <span class="bound">j</span><span class="main">)</span> <span class="skolem">bj</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> bj split
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> prod.remove<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ ai<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> fin<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> id <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?onederiv</span> <span class="main">=</span> <span class="var">?prod</span> <span class="skolem">a</span> <span class="skolem">i</span> <span class="main">+</span> <span class="skolem">p</span> <span class="main">*</span> <span class="skolem">fac</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> fac_def a <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> dvd<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="var">?prod</span> <span class="skolem">a</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">algebra</span>
      <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> field_poly_irreducible_dvd_mult<span class="main"><span class="main">[</span></span><span class="operator">OF</span> p<span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">∈</span><span class="free">bs</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> <span class="bound">b</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">from</span></span> irreducible_dvd_prod<span class="main">[</span><span class="operator">OF</span> p this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> bj'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> <span class="free">bs</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span><span class="main">}</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> pb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> bj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> <span class="free">bs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> as_irred bj bs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> irreducible<span class="hidden">⇩</span><sub>d</sub>_dvd_smult<span class="main">[</span><span class="operator">OF</span> p0 this pb<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
          <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> smult <span class="skolem">d</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> ap c <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"smult <span class="main">(</span><span class="skolem">c</span><span class="main">/</span><span class="skolem">d</span><span class="main">)</span> <span class="skolem">b</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> deg<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">a</span> <span class="main">=</span> degree <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> coeff_smult<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span><span class="main">/</span><span class="skolem">d</span>"</span></span> <span class="quoted"><span class="skolem">b</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">b</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> id<span class="main">]</span> deg bs_monic<span class="main">[</span><span class="operator">OF</span> ai<span class="main">]</span> bs_monic<span class="main">[</span><span class="operator">OF</span> bj<span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">/</span> <span class="skolem">d</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">from</span></span> id<span class="main">[</span><span class="operator">unfolded</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">with</span></span> as_distinct<span class="main">[</span><span class="operator">OF</span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> bs ai<span class="main"><span class="main">]</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> bs bj<span class="main"><span class="main">]</span></span><span class="main">]</span> bj'
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword1"><span class="command">from</span></span> f<span class="main">[</span><span class="operator">OF</span> ai<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> fi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">i</span> <span class="main">=</span> Suc <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">i</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> smult <span class="main">(</span>of_nat <span class="main">(</span><span class="free">f</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>pderiv <span class="skolem">a</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="main">(</span>pderiv <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> fi <span class="keyword1"><span class="command">using</span></span> dvd_smult_cancel of_nat_eq_0_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> ap<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> pderiv <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="keyword1">dvd</span> pderiv <span class="skolem">a</span>›</span></span> ap' dvd_trans dvd_triv_right mult.left_neutral pderiv_smult smult_dvd_cancel<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> not_dvd_pderiv p0 <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="keyword1">dvd</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> <span class="quoted"><span class="quoted">‹<span class="var">?single</span> <span class="main">≠</span> <span class="main">0</span>›</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pderiv_exp_gcd<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"gcd <span class="free">p</span> <span class="main">(</span>pderiv <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span><span class="free">as</span><span class="main">.</span> <span class="bound">a</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?prod</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?sum</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span><span class="free">as</span><span class="main">.</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">∈</span><span class="free">as</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> <span class="bound">b</span><span class="main">)</span> <span class="main">*</span> smult <span class="main">(</span>of_nat <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>pderiv <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?single</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span><span class="free">as</span><span class="main">.</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?prd</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">a</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">∈</span><span class="free">as</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> <span class="bound">b</span><span class="main">)</span> <span class="main">*</span> smult <span class="main">(</span>of_nat <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>pderiv <span class="bound">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?onederiv</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">∑</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span><span class="free">as</span><span class="main">.</span> <span class="var">?prd</span> <span class="bound">a</span> <span class="bound">i</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> pp<span class="main">:</span> <span class="quoted"><span class="quoted">"pderiv <span class="free">p</span> <span class="main">=</span> <span class="var">?prod</span> <span class="main">*</span> <span class="var">?sum</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pderiv_exp_prod<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="var">?prod</span> <span class="main">*</span> <span class="var">?single</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> poly_exp_expand<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> monic<span class="main">:</span> <span class="quoted"><span class="quoted">"monic <span class="var">?prod</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> monic_Prod<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> gcd<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="var">?single</span> <span class="var">?onederiv</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> coprime_generic<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> gcd<span class="main">:</span> <span class="quoted"><span class="quoted">"gcd <span class="var">?single</span> <span class="var">?onederiv</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> pp <span class="keyword1"><span class="command">unfolding</span></span> p poly_gcd_monic_factor <span class="main">[</span><span class="operator">OF</span> monic<span class="main">]</span> gcd <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> p_div_gcd_p_pderiv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">div</span> <span class="main">(</span>gcd <span class="free">p</span> <span class="main">(</span>pderiv <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span><span class="free">as</span><span class="main">.</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pderiv_exp_gcd <span class="keyword1"><span class="command">unfolding</span></span> poly_exp_expand
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nonzero_mult_div_cancel_left<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> monic_Prod<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">A</span> <span class="entity">B</span> <span class="entity">C</span> <span class="entity">D</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> poly"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> gcd <span class="main">(</span><span class="free">B</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">D</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">0</span> <span class="main">=</span> <span class="free">p</span> <span class="keyword1">div</span> <span class="main">(</span>gcd <span class="free">p</span> <span class="main">(</span>pderiv <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">B</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">div</span> <span class="free">A</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">0</span> <span class="main">=</span> pderiv <span class="free">p</span> <span class="keyword1">div</span> <span class="main">(</span>gcd <span class="free">p</span> <span class="main">(</span>pderiv <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">D</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">div</span> <span class="free">A</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="free">C</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">-</span> pderiv <span class="main">(</span><span class="free">B</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> A_B_C_D<span class="main">:</span> <span class="quoted"><span class="quoted">"A <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">as</span> <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">{</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"B <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">as</span> <span class="main">-</span> UNIV <span class="main">×</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"C <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span><span class="free">as</span> <span class="main">-</span> UNIV <span class="main">×</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">}</span><span class="main">.</span> 
    <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">∈</span><span class="free">as</span> <span class="main">-</span> UNIV <span class="main">×</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> <span class="bound">b</span><span class="main">)</span> <span class="main">*</span> smult <span class="main">(</span>of_nat <span class="main">(</span>Suc <span class="bound">i</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>pderiv <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"D <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">as</span> <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">{</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="bound">a</span><span class="main">)</span> <span class="main">*</span> 
    <span class="main">(</span><span class="main">∑</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">∈</span><span class="free">as</span> <span class="main">-</span> UNIV <span class="main">×</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> Suc <span class="free">n</span><span class="main">}</span><span class="main">.</span> 
      <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">∈</span> <span class="free">as</span> <span class="main">-</span> UNIV <span class="main">×</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> Suc <span class="free">n</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> <span class="bound">b</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>smult <span class="main">(</span>of_nat <span class="main">(</span><span class="bound">i</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>pderiv <span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">n</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">n</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> A_B_C_D.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">n</span><span class="main">)</span> <span class="comment1">(* A *)</span>
  <span class="keyword1"><span class="command">note</span></span> Bn <span class="main">=</span> 1<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> Dn <span class="main">=</span> 1<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span><span class="free">as</span> <span class="main">-</span> UNIV <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span> <span class="skolem">n</span><span class="main">}</span><span class="main">.</span> <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span><span class="free">as</span> <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">{</span><span class="skolem">n</span><span class="main">}</span><span class="main">.</span> <span class="bound">a</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span><span class="free">as</span> <span class="main">-</span> UNIV <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">n</span><span class="main">}</span><span class="main">.</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> prod.union_disjoint<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> fin<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> prod.cong<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> Bn' <span class="main">=</span> Bn<span class="main">[</span><span class="operator">unfolded</span> this<span class="main">]</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?an</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">as</span> <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">{</span><span class="skolem">n</span><span class="main">}</span><span class="main">.</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?bn</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span><span class="free">as</span> <span class="main">-</span> UNIV <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">n</span><span class="main">}</span><span class="main">.</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"A <span class="skolem">n</span> <span class="main">=</span> <span class="var">?an</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> A.simps
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> gcdI<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ _ _ normalize_monic<span class="main"><span class="main">[</span></span><span class="operator">OF</span> monic_gen<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> monB1<span class="main">:</span> <span class="quoted"><span class="quoted">"monic <span class="main">(</span>B <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Bn <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> monic_gen<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"B <span class="skolem">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?dn</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">∈</span><span class="free">as</span> <span class="main">-</span> UNIV <span class="main">×</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> Suc <span class="skolem">n</span><span class="main">}</span><span class="main">.</span> 
        <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">∈</span> <span class="free">as</span> <span class="main">-</span> UNIV <span class="main">×</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> Suc <span class="skolem">n</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> <span class="bound">b</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>smult <span class="main">(</span>of_nat <span class="main">(</span><span class="bound">i</span> <span class="main">-</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>pderiv <span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> Dn<span class="main">:</span> <span class="quoted"><span class="quoted">"D <span class="skolem">n</span> <span class="main">=</span> <span class="var">?an</span> <span class="main">*</span> <span class="var">?dn</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Dn <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> dvd1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?an</span> <span class="keyword1">dvd</span> B <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Bn' dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> dvd2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?an</span> <span class="keyword1">dvd</span> D <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Dn dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="keyword1">dvd</span> B <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="keyword1">dvd</span> D <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> dvd_gcd_mult<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> Bn' Dn<span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="keyword1">dvd</span> <span class="var">?an</span> <span class="main">*</span> <span class="main">(</span>gcd <span class="var">?bn</span> <span class="var">?dn</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coprime <span class="var">?bn</span> <span class="var">?dn</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> coprime_generic<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="keyword1">dvd</span> <span class="var">?an</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="comment1">(* B 0 *)</span>
  <span class="keyword1"><span class="command">have</span></span> as<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">-</span> UNIV <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="main">0</span><span class="main">}</span> <span class="main">=</span> <span class="free">as</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> B.simps as p_div_gcd_p_pderiv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">n</span><span class="main">)</span> <span class="comment1">(* B n *)</span>
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span><span class="free">as</span> <span class="main">-</span> UNIV <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span> <span class="skolem">n</span><span class="main">}</span><span class="main">.</span> <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span><span class="free">as</span> <span class="main">-</span> UNIV <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">n</span><span class="main">}</span><span class="main">.</span> <span class="bound">a</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span><span class="free">as</span> <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">{</span><span class="skolem">n</span><span class="main">}</span><span class="main">.</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> prod.union_disjoint<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> fin<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> prod.cong<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> B.simps 3 id
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> nonzero_mult_div_cancel_right<span class="main"><span class="main">[</span></span><span class="operator">OF</span> nonzero_gen<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 4 <span class="comment1">(* C 0 *)</span>
  <span class="keyword1"><span class="command">have</span></span> as<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">-</span> UNIV <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="main">0</span><span class="main">}</span> <span class="main">=</span> <span class="free">as</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> Suc <span class="bound">i</span> <span class="main">-</span> <span class="main">0</span> <span class="main">=</span> Suc <span class="bound">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> C.simps pderiv_exp_gcd <span class="keyword1"><span class="command">unfolding</span></span> pderiv_exp_prod as
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nonzero_mult_div_cancel_left<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> monic_Prod<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">n</span><span class="main">)</span> <span class="comment1">(* C n *)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> C.simps 5
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> nonzero_mult_div_cancel_left<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> nonzero_gen<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">n</span><span class="main">)</span> <span class="comment1">(* D n *)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">∈</span><span class="free">as</span> <span class="main">-</span> UNIV <span class="main">×</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="skolem">n</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> <span class="bound">b</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>smult <span class="main">(</span>of_nat <span class="main">(</span><span class="bound">i</span> <span class="main">-</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>pderiv <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"D <span class="skolem">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">∈</span><span class="free">as</span> <span class="main">-</span> UNIV <span class="main">×</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="skolem">n</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">∈</span><span class="free">as</span> <span class="main">-</span> UNIV <span class="main">×</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="skolem">n</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> <span class="bound">b</span><span class="main">)</span> <span class="main">*</span> 
    <span class="main">(</span>smult <span class="main">(</span>of_nat <span class="main">(</span>Suc <span class="bound">i</span> <span class="main">-</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>pderiv <span class="bound">a</span><span class="main">)</span> <span class="main">-</span> pderiv <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> D.simps 6 pderiv_prod sum_subtractf<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> right_diff_distrib
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum <span class="var">?f</span> <span class="main">(</span><span class="free">as</span> <span class="main">-</span> UNIV <span class="main">×</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="skolem">n</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">as</span> <span class="main">-</span> UNIV <span class="main">×</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="skolem">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">&gt;</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">-</span> <span class="skolem">n</span> <span class="main">=</span> Suc <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"of_nat <span class="main">(</span>Suc <span class="skolem">i</span> <span class="main">-</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> of_nat <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> id <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"smult <span class="main">(</span>of_nat <span class="main">(</span>Suc <span class="skolem">i</span> <span class="main">-</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>pderiv <span class="skolem">a</span><span class="main">)</span> <span class="main">-</span> pderiv <span class="skolem">a</span> <span class="main">=</span> smult <span class="main">(</span>of_nat <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>pderiv <span class="skolem">a</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> id smult_add_left <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span> <span class="main">::</span> <span class="tfree">'a</span> poly<span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">*</span> <span class="bound">z</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">*</span> <span class="bound">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> <span class="skolem">x</span> <span class="keyword1">of</span>
          <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⇒</span>
            <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">∈</span><span class="free">as</span> <span class="main">-</span> UNIV <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">n</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> <span class="bound">b</span><span class="main">)</span> <span class="main">*</span>
            <span class="main">(</span>smult <span class="main">(</span>of_nat <span class="main">(</span>Suc <span class="bound">i</span> <span class="main">-</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>pderiv <span class="bound">a</span><span class="main">)</span> <span class="main">-</span> pderiv <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
         <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">x</span> <span class="keyword1">of</span>
          <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">∈</span><span class="free">as</span> <span class="main">-</span> UNIV <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">n</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> <span class="bound">b</span><span class="main">)</span> <span class="main">*</span> smult <span class="main">(</span>of_nat <span class="main">(</span><span class="bound">i</span> <span class="main">-</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>pderiv <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> x split id
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum <span class="var">?f</span> <span class="main">(</span><span class="free">as</span> <span class="main">-</span> UNIV <span class="main">×</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> Suc <span class="skolem">n</span><span class="main">}</span><span class="main">)</span> <span class="main">+</span> sum <span class="var">?f</span> <span class="main">(</span><span class="free">as</span> <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">{</span><span class="skolem">n</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.union_disjoint<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> fin<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sum.cong<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="var">?f</span> <span class="main">(</span><span class="free">as</span> <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">{</span><span class="skolem">n</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.neutral<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"D <span class="skolem">n</span> <span class="main">=</span> sum <span class="var">?f</span> <span class="main">(</span><span class="free">as</span> <span class="main">-</span> UNIV <span class="main">×</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> Suc <span class="skolem">n</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> id sum_distrib_left
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">as</span> <span class="main">-</span> UNIV <span class="main">×</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> Suc <span class="skolem">n</span><span class="main">}</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">with</span></span> mem <span class="keyword1"><span class="command">have</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&gt;</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span> <span class="bound">v</span> <span class="main">::</span> <span class="tfree">'a</span> poly<span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">*</span> <span class="bound">v</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">*</span> <span class="bound">z</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">*</span> <span class="main">(</span><span class="bound">v</span> <span class="main">*</span> <span class="bound">z</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> <span class="skolem">x</span> <span class="keyword1">of</span>
          <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">∈</span><span class="free">as</span> <span class="main">-</span> UNIV <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">n</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> <span class="bound">b</span><span class="main">)</span> <span class="main">*</span> smult <span class="main">(</span>of_nat <span class="main">(</span><span class="bound">i</span> <span class="main">-</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>pderiv <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
         <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span><span class="free">as</span> <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">{</span><span class="skolem">n</span><span class="main">}</span><span class="main">.</span> <span class="bound">a</span><span class="main">)</span> <span class="main">*</span>
         <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⇒</span>
            <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">∈</span><span class="free">as</span> <span class="main">-</span> UNIV <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">n</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> <span class="bound">b</span><span class="main">)</span> <span class="main">*</span> smult <span class="main">(</span>of_nat <span class="main">(</span><span class="bound">i</span> <span class="main">-</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>pderiv <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> x split
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> prod.union_disjoint<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> fin<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>3<span class="main"><span class="keyword3">]</span></span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">rule</span> prod.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> A <span class="main">=</span> A_B_C_D<span class="main">(</span>1<span class="main">)</span>
<span class="keyword1"><span class="command">lemmas</span></span> B <span class="main">=</span> A_B_C_D<span class="main">(</span>2<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> ABCD_simps <span class="main">=</span> A.simps B.simps C.simps D.simps
<span class="keyword1"><span class="command">declare</span></span> ABCD_simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span></span></span></span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> prod_A<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span> <span class="free">n</span><span class="main">.</span> A <span class="bound">i</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span> <span class="free">as</span> <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="bound">a</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> Suc <span class="skolem">n</span><span class="main">}</span> <span class="main">=</span> insert <span class="skolem">n</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="skolem">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> id2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> Suc <span class="skolem">n</span><span class="main">}</span> <span class="main">=</span> <span class="free">as</span> <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">{</span><span class="skolem">n</span><span class="main">}</span> <span class="main">∪</span> <span class="free">as</span> <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="skolem">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">*</span> <span class="bound">z</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">*</span> <span class="bound">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> id2 <span class="keyword1"><span class="command">unfolding</span></span> id 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> prod.insert<span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">subst</span> prod.union_disjoint<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">unfold</span> Suc<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">;</span></span> 
    <span class="main">(</span><span class="operator">unfold</span> A<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> cong<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span><span class="free">as</span> <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">{</span><span class="skolem">n</span><span class="main">}</span><span class="main">.</span> <span class="bound">a</span><span class="main">)</span> <span class="main">^</span> Suc <span class="skolem">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span><span class="free">as</span> <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">{</span><span class="skolem">n</span><span class="main">}</span><span class="main">.</span> <span class="bound">a</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> prod_power_distrib
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> fin<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> prod_A_is_p_unknown<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">as</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span> <span class="free">n</span><span class="main">.</span> A <span class="bound">i</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span><span class="free">as</span><span class="main">.</span> <span class="bound">a</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> p<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span> <span class="free">n</span><span class="main">.</span> A <span class="bound">i</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> prod_A
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bound</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bound</span> <span class="main">=</span> Suc <span class="main">(</span>Max <span class="main">(</span>snd <span class="main">`</span> <span class="free">as</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bound<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≥</span> bound"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"B <span class="free">m</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?set</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">-</span> UNIV <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> ai<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?set</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> snd <span class="main">`</span> <span class="free">as</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">from</span></span> Max_ge<span class="main">[</span><span class="operator">OF</span> _ this<span class="main">]</span> fin <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> Max <span class="main">(</span>snd <span class="main">`</span> <span class="free">as</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> ai m<span class="main">[</span><span class="operator">unfolded</span> bound_def<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?set</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"B <span class="free">m</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> B id <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> coprime_A_A<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span>A <span class="free">i</span><span class="main">)</span> <span class="main">(</span>A <span class="free">j</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> coprimeI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>  
  <span class="keyword3"><span class="command">assume</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="keyword1">dvd</span> A <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="keyword1">dvd</span> A <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> Ai<span class="main">:</span> <span class="quoted"><span class="quoted">"A <span class="free">i</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> A
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nonzero_gen<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> dvd <span class="keyword1"><span class="command">have</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"is_unit <span class="skolem">k</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> kc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="main">[:</span> <span class="skolem">c</span> <span class="main">:]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> degree0_coeffs<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> k <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">=</span> <span class="skolem">k</span> <span class="main">*</span> <span class="main">[:</span><span class="main">1</span> <span class="main">/</span> <span class="skolem">c</span><span class="main">:]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">from</span></span> irreducible_monic_factor<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="skolem">q</span> <span class="main">*</span> <span class="skolem">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"irreducible <span class="skolem">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> mq<span class="main">:</span> <span class="quoted"><span class="quoted">"monic <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> dvd <span class="keyword1"><span class="command">have</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="keyword1">dvd</span> A <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="keyword1">dvd</span> A <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> q <span class="keyword1"><span class="command">have</span></span> q0<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">q</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> irreducible<span class="hidden">⇩</span><sub>d</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> irreducible_dvd_prod<span class="main">[</span><span class="operator">OF</span> q dvd<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> A<span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> ai<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="free">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">as</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> qa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="keyword1">dvd</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> irreducible_dvd_prod<span class="main">[</span><span class="operator">OF</span> q dvd<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> A<span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> bj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b</span><span class="main">,</span><span class="free">j</span><span class="main">)</span> <span class="main">∈</span> <span class="free">as</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> qb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="keyword1">dvd</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> as_distinct<span class="main">[</span><span class="operator">OF</span> ai bj<span class="main">]</span> assms <span class="keyword1"><span class="command">have</span></span> neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≠</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> irreducible<span class="hidden">⇩</span><sub>d</sub>_dvd_smult<span class="main">[</span><span class="operator">OF</span> q0 as_irred<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ai<span class="main"><span class="main">]</span></span> qa<span class="main">]</span>
      irreducible<span class="hidden">⇩</span><sub>d</sub>_dvd_smult<span class="main">[</span><span class="operator">OF</span> q0 as_irred<span class="main"><span class="main">[</span></span><span class="operator">OF</span> bj<span class="main"><span class="main">]</span></span> qb<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> smult <span class="skolem">c</span> <span class="skolem">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> smult <span class="skolem">d</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> ab<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> smult <span class="main">(</span><span class="skolem">c</span> <span class="main">/</span> <span class="skolem">d</span><span class="main">)</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">/</span> <span class="skolem">d</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> as_monic<span class="main">[</span><span class="operator">OF</span> bj<span class="main">]</span> as_monic<span class="main">[</span><span class="operator">OF</span> ai<span class="main">]</span> arg_cong<span class="main">[</span><span class="operator">OF</span> ab<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> coeff <span class="bound">p</span> <span class="main">(</span>degree <span class="bound">p</span><span class="main">)</span>"</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> coeff_smult degree_smult_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> neq <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> A_monic<span class="main">:</span> <span class="quoted"><span class="quoted">"monic <span class="main">(</span>A <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> monic_gen<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> A_square_free<span class="main">:</span> <span class="quoted"><span class="quoted">"square_free <span class="main">(</span>A <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> square_freeI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span> <span class="skolem">k</span>
  <span class="keyword1"><span class="command">have</span></span> mon<span class="main">:</span> <span class="quoted"><span class="quoted">"monic <span class="main">(</span>A <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> A_monic<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> Ai<span class="main">:</span> <span class="quoted"><span class="quoted">"A <span class="free">i</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">assume</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">q</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">*</span> <span class="skolem">q</span> <span class="keyword1">dvd</span> A <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> irreducible_monic_factor<span class="main">[</span><span class="operator">OF</span> q<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> <span class="skolem">r</span> <span class="main">*</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
    irr<span class="main">:</span> <span class="quoted"><span class="quoted">"irreducible <span class="skolem">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> mr<span class="main">:</span> <span class="quoted"><span class="quoted">"monic <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> dvd<span class="main">[</span><span class="operator">unfolded</span> q<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> dvd2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">*</span> <span class="skolem">r</span> <span class="keyword1">dvd</span> A <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dvd1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="keyword1">dvd</span> A <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> irreducible_dvd_prod<span class="main">[</span><span class="operator">OF</span> irr dvd1<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> A<span class="main"><span class="main">]</span></span><span class="main">]</span> 
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> ai<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="free">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">as</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ra<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="keyword1">dvd</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rem</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span><span class="free">as</span> <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="free">i</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> as_irred<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ai<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> irreducible<span class="hidden">⇩</span><sub>d</sub>_dvd_smult<span class="main">[</span><span class="operator">OF</span> _ a ra<span class="main">]</span> irr
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> ar<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> smult <span class="skolem">c</span> <span class="skolem">r</span>"</span></span>  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">with</span></span> mr as_monic<span class="main">[</span><span class="operator">OF</span> ai<span class="main">]</span> arg_cong<span class="main">[</span><span class="operator">OF</span> ar<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> coeff <span class="bound">p</span> <span class="main">(</span>degree <span class="bound">p</span><span class="main">)</span>"</span></span><span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> coeff_smult degree_smult_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">with</span></span> dvd2 <span class="keyword1"><span class="command">have</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">*</span> <span class="skolem">a</span> <span class="keyword1">dvd</span> A <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"A <span class="free">i</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">*</span> <span class="var">?rem</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> A
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> prod.remove<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">(</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">a</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span><span class="free"><span class="free"><span class="free">i</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> ai fin<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> dvd <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="keyword1">dvd</span> <span class="var">?rem</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a id Ai <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> irreducible_dvd_prod<span class="main">[</span><span class="operator">OF</span> _ this<span class="main">]</span> a <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> bi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b</span><span class="main">,</span><span class="free">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">as</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≠</span> <span class="skolem">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ab<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="keyword1">dvd</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> as_irred<span class="main">[</span><span class="operator">OF</span> bi<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">.</span></span> 
  <span class="keyword1"><span class="command">from</span></span> irreducible<span class="hidden">⇩</span><sub>d</sub>_dvd_smult<span class="main">[</span><span class="operator">OF</span> _ b ab<span class="main">]</span> a<span class="main">[</span><span class="operator">unfolded</span> irreducible<span class="hidden">⇩</span><sub>d</sub>_def<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ba<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> smult <span class="skolem">c</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> as_monic<span class="main">[</span><span class="operator">OF</span> bi<span class="main">]</span> as_monic<span class="main">[</span><span class="operator">OF</span> ai<span class="main">]</span> arg_cong<span class="main">[</span><span class="operator">OF</span> ba<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> coeff <span class="bound">p</span> <span class="main">(</span>degree <span class="bound">p</span><span class="main">)</span>"</span></span><span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> coeff_smult degree_smult_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> neq <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> A_monic<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">i</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> prod_A_is_p_B_bound<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"B <span class="free">n</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span> <span class="free">n</span><span class="main">.</span> A <span class="bound">i</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> prod_A_is_p_unknown<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">assume</span></span> ai<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">as</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rem</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span><span class="free">as</span> <span class="main">-</span> UNIV <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> rem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?rem</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nonzero_gen<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> as_irred<span class="main">[</span><span class="operator">OF</span> ai<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">hence</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">a</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> irreducible<span class="hidden">⇩</span><sub>d</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?thesis</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≥</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> ai <span class="keyword1"><span class="command">have</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">as</span> <span class="main">-</span> UNIV <span class="main">×</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">=</span> degree <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span><span class="free">as</span> <span class="main">-</span> UNIV <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="bound">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> degree <span class="main">(</span><span class="skolem">a</span> <span class="main">*</span> <span class="var">?rem</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> prod.remove<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ mem<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> fin<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> degree <span class="skolem">a</span> <span class="main">+</span> degree <span class="var">?rem</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> degree_mult_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> a<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> rem<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> a<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> yun_gcd <span class="quoted">gcd</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> square_free_monic_poly<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>poly <span class="main">(</span>square_free_monic_poly <span class="free">p</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>poly <span class="free">p</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> square_free_monic_poly_def <span class="keyword1"><span class="command">unfolding</span></span> p_div_gcd_p_pderiv
    <span class="keyword1"><span class="command">unfolding</span></span> p poly_prod prod_zero_iff<span class="main">[</span><span class="operator">OF</span> fin<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> yun_factorization_induct<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> base<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">bn</span> <span class="bound">cn</span><span class="main">.</span> <span class="bound">bn</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">bn</span> <span class="bound">cn</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">bn</span> <span class="bound">cn</span><span class="main">.</span> <span class="bound">bn</span> <span class="main">≠</span> <span class="main">1</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">bn</span> <span class="keyword1">div</span> <span class="main">(</span>gcd <span class="bound">bn</span> <span class="main">(</span><span class="bound">cn</span> <span class="main">-</span> pderiv <span class="bound">bn</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">(</span><span class="main">(</span><span class="bound">cn</span> <span class="main">-</span> pderiv <span class="bound">bn</span><span class="main">)</span> <span class="keyword1">div</span> <span class="main">(</span>gcd <span class="bound">bn</span> <span class="main">(</span><span class="bound">cn</span> <span class="main">-</span> pderiv <span class="bound">bn</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">bn</span> <span class="bound">cn</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bn</span> <span class="main">=</span> <span class="free">p</span> <span class="keyword1">div</span> gcd <span class="free">p</span> <span class="main">(</span>pderiv <span class="free">p</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">cn</span> <span class="main">=</span> pderiv <span class="free">p</span> <span class="keyword1">div</span> gcd <span class="free">p</span> <span class="main">(</span>pderiv <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">bn</span> <span class="free">cn</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">n</span><span class="main">.</span> bound <span class="main">-</span> <span class="bound">n</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>B <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>C <span class="skolem">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> wf_induct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf_measure<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?m</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> 1<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"B <span class="skolem">n</span> <span class="main">=</span> <span class="main">1</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> base <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> Bn <span class="main">=</span> this
      <span class="keyword1"><span class="command">with</span></span> bound<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> bound <span class="main">≤</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Suc <span class="skolem">n</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> measure <span class="var">?m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> IH<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> step<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Bn<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> IH<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> D.simps C.simps B.simps A.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> id n_def B.simps C.simps <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> yun_factorization_main<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"yun_factorization_main <span class="main">(</span>B <span class="free">n</span><span class="main">)</span> <span class="main">(</span>C <span class="free">n</span><span class="main">)</span> <span class="free">n</span> <span class="free">bs</span> <span class="main">=</span> <span class="free">cs</span>"</span></span>
  <span class="quoted"><span class="quoted">"set <span class="free">bs</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span>A <span class="bound">i</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">|</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map snd <span class="free">bs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">m</span><span class="main">.</span> set <span class="free">cs</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span>A <span class="bound">i</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">|</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">m</span><span class="main">}</span> <span class="main">∧</span> B <span class="bound">m</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> distinct <span class="main">(</span>map snd <span class="free">cs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">n</span><span class="main">.</span> bound <span class="main">-</span> <span class="bound">n</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> wf_induct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf_measure<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?m</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> 1<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"yun_factorization_main <span class="main">(</span>B <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>C <span class="skolem">n</span><span class="main">)</span> <span class="skolem">n</span> <span class="skolem">bs</span> <span class="main">=</span> <span class="free">cs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> res<span class="main">[</span><span class="operator">unfolded</span> yun_factorization_main.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"B <span class="skolem">n</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> bs<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">bs</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span>A <span class="bound">i</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map snd <span class="skolem">bs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"B <span class="skolem">n</span> <span class="main">=</span> <span class="main">1</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> res <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bs</span> <span class="main">=</span> <span class="free">cs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> True bs <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> Bn <span class="main">=</span> this
      <span class="keyword1"><span class="command">with</span></span> bound<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> bound <span class="main">≤</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Suc <span class="skolem">n</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> measure <span class="var">?m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> IH<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
      <span class="keyword1"><span class="command">from</span></span> Bn res<span class="main">[</span><span class="operator">unfolded</span> Let_def<span class="main">,</span> <span class="operator">folded</span> D.simps C.simps B.simps A.simps<span class="main">]</span> 
      <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"yun_factorization_main <span class="main">(</span>B <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>C <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>A <span class="skolem">n</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">bs</span><span class="main">)</span> <span class="main">=</span> <span class="free">cs</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> IH<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> 
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> Suc <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
      <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> missing <span class="main">=</span> this
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="main">(</span>A <span class="skolem">n</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">bs</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span>A <span class="bound">i</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> Suc <span class="skolem">n</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> list.simps bs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> missing<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> IH<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
      <span class="keyword1"><span class="command">from</span></span> bs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map snd <span class="main">(</span><span class="main">(</span>A <span class="skolem">n</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">bs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> IH<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> IH<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> yun_monic_factorization_res<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"yun_monic_factorization <span class="free">p</span> <span class="main">=</span> <span class="free">bs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">m</span><span class="main">.</span> set <span class="free">bs</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span>A <span class="bound">i</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">|</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">m</span> <span class="main">∧</span> A <span class="bound">i</span> <span class="main">≠</span> <span class="main">1</span><span class="main">}</span> <span class="main">∧</span> B <span class="bound">m</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> distinct <span class="main">(</span>map snd <span class="free">bs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> res<span class="main">[</span><span class="operator">unfolded</span> yun_monic_factorization_def Let_def<span class="main">,</span> 
    <span class="operator">folded</span> B.simps C.simps<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cs</span></span> <span class="keyword2"><span class="keyword">where</span></span> yun<span class="main">:</span> <span class="quoted"><span class="quoted">"yun_factorization_main <span class="main">(</span>B <span class="main">0</span><span class="main">)</span> <span class="main">(</span>C <span class="main">0</span><span class="main">)</span> <span class="main">0</span> <span class="main">[]</span> <span class="main">=</span> <span class="skolem">cs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> bs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bs</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">.</span> <span class="bound">a</span> <span class="main">≠</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">cs</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> yun_factorization_main<span class="main">[</span><span class="operator">OF</span> yun<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> bs
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> distinct_map_filter<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>                                                    

<span class="keyword1"><span class="command">lemma</span></span> yun_monic_factorization<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> yun<span class="main">:</span> <span class="quoted"><span class="quoted">"yun_monic_factorization <span class="free">p</span> <span class="main">=</span> <span class="free">bs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"square_free_factorization <span class="free">p</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span><span class="free">bs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b</span><span class="main">,</span><span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">bs</span> <span class="main">⟹</span> monic <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map snd <span class="free">bs</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> yun_monic_factorization_res<span class="main">[</span><span class="operator">OF</span> yun<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> bs<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">bs</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span>A <span class="bound">i</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">|</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">m</span> <span class="main">∧</span> A <span class="bound">i</span> <span class="main">≠</span> <span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"B <span class="skolem">m</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> dist<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map snd <span class="free">bs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="skolem">m</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">m</span> <span class="main">∧</span> A <span class="bound">i</span> <span class="main">=</span> <span class="main">1</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">m</span> <span class="main">∧</span> A <span class="bound">i</span> <span class="main">≠</span> <span class="main">1</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?ignore</span> <span class="main">∪</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="skolem">m</span><span class="main">.</span> A <span class="bound">i</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod_A_is_p_B_bound<span class="main"><span class="main">[</span></span><span class="operator">OF</span> B<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> prod <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> A <span class="bound">i</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">m</span> <span class="main">∧</span> A <span class="bound">i</span> <span class="main">≠</span> <span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> id 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> prod.union_disjoint<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">force</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>3<span class="main"><span class="keyword3">]</span></span><span class="main"><span class="keyword3">,</span></span>
    <span class="operator">subst</span> prod.neutral<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?ignore</span></span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span> set <span class="free">bs</span><span class="main">.</span> <span class="bound">a</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> bs
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod.reindex_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">snd</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span> set <span class="free">bs</span><span class="main">.</span> <span class="bound">a</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">bs</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> A <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"A <span class="skolem">i</span> <span class="main">≠</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> bs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> A_square_free<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> A_monic<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"square_free <span class="skolem">a</span> <span class="main">∧</span> degree <span class="skolem">a</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"monic <span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> monic_degree_0<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> 2 <span class="main">=</span> this
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">i</span> <span class="skolem">b</span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span> ai<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">bs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> bj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">bs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span> <span class="main">≠</span> <span class="main">(</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> A <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> A <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> bs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> neq dist ai bj <span class="keyword1"><span class="command">have</span></span> neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a b <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> coprime_A_A <span class="main">[</span><span class="operator">OF</span> neq<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">a</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> a b <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> 3 <span class="main">=</span> this
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"monic <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> p 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> monic_prod<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> as_monic<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> monic_power monic_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> dist <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">bs</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> distinct_map <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"square_free_factorization <span class="free">p</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span><span class="free">bs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> square_free_factorization_def <span class="keyword1"><span class="command">using</span></span> 1 2 3 4 5
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b</span><span class="main">,</span><span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">bs</span> <span class="main">⟹</span> monic <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map snd <span class="free">bs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> monic_factorization<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"monic <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">as</span><span class="main">.</span> monic_factorization <span class="bound">as</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> monic_irreducible_factorization<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">as</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">a</span><span class="main">∈</span><span class="skolem">as</span><span class="main">.</span> <span class="bound">a</span> <span class="main">^</span> Suc <span class="main">(</span><span class="skolem">f</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> as<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="bound">q</span> <span class="main">∧</span> monic <span class="bound">q</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">cs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cs</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="skolem">f</span> <span class="bound">a</span><span class="main">)</span> <span class="main">|</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="skolem">as</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">standard</span><span class="main">)</span>  
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">cs</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> cs_def <span class="keyword1"><span class="command">using</span></span> fin <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">i</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">cs</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"monic <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> cs_def <span class="keyword1"><span class="command">using</span></span> as <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> irr <span class="main">=</span> this
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">i</span> <span class="bound">b</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">cs</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">cs</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≠</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">≠</span> <span class="bound">b</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> cs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span><span class="skolem">cs</span><span class="main">.</span> <span class="bound">a</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> p cs_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod.reindex_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> square_free_monic_poly<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"monic <span class="main">(</span><span class="free">p</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>field_char_0<span class="main">,</span> euclidean_ring_gcd<span class="main">,</span>semiring_gcd_mult_normalize<span class="main">}</span> poly<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>poly <span class="main">(</span>yun_gcd.square_free_monic_poly gcd <span class="free">p</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>poly <span class="free">p</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> monic_factorization<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"monic_factorization <span class="skolem">as</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">from</span></span> monic_factorization.square_free_monic_poly<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> yun_factorization_induct<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> base<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">bn</span> <span class="bound">cn</span><span class="main">.</span> <span class="bound">bn</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">bn</span> <span class="bound">cn</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">bn</span> <span class="bound">cn</span><span class="main">.</span> <span class="bound">bn</span> <span class="main">≠</span> <span class="main">1</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">bn</span> <span class="keyword1">div</span> <span class="main">(</span>gcd <span class="bound">bn</span> <span class="main">(</span><span class="bound">cn</span> <span class="main">-</span> pderiv <span class="bound">bn</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">(</span><span class="main">(</span><span class="bound">cn</span> <span class="main">-</span> pderiv <span class="bound">bn</span><span class="main">)</span> <span class="keyword1">div</span> <span class="main">(</span>gcd <span class="bound">bn</span> <span class="main">(</span><span class="bound">cn</span> <span class="main">-</span> pderiv <span class="bound">bn</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">bn</span> <span class="bound">cn</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bn</span> <span class="main">=</span> <span class="free">p</span> <span class="keyword1">div</span> gcd <span class="free">p</span> <span class="main">(</span>pderiv <span class="free">p</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">cn</span> <span class="main">=</span> pderiv <span class="free">p</span> <span class="keyword1">div</span> gcd <span class="free">p</span> <span class="main">(</span>pderiv <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> monic<span class="main">:</span> <span class="quoted"><span class="quoted">"monic <span class="main">(</span><span class="free">p</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>field_char_0<span class="main">,</span>euclidean_ring_gcd<span class="main">,</span>semiring_gcd_mult_normalize<span class="main">}</span> poly<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">bn</span> <span class="free">cn</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> monic_factorization<span class="main">[</span><span class="operator">OF</span> monic<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"monic_factorization <span class="skolem">as</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">from</span></span> monic_factorization.yun_factorization_induct<span class="main">[</span><span class="operator">OF</span> this base step id<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> square_free_poly<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>poly <span class="main">(</span>square_free_poly gcd <span class="free">p</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>poly <span class="free">p</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> square_free_poly_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"coeff <span class="free">p</span> <span class="main">(</span>degree <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ic</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"inverse <span class="var">?c</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"square_free_poly gcd <span class="free">p</span> <span class="main">=</span> yun_gcd.square_free_monic_poly gcd <span class="main">(</span>smult <span class="var">?ic</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> square_free_poly_def <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> mon<span class="main">:</span> <span class="quoted"><span class="quoted">"monic <span class="main">(</span>smult <span class="var">?ic</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ic<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ic</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> id square_free_monic_poly<span class="main">[</span><span class="operator">OF</span> mon<span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> ic <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>  


<span class="keyword1"><span class="command">lemma</span></span> yun_monic_factorization<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>field_char_0<span class="main">,</span>euclidean_ring_gcd<span class="main">,</span>semiring_gcd_mult_normalize<span class="main">}</span> poly"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"yun_gcd.yun_monic_factorization gcd <span class="free">p</span> <span class="main">=</span> <span class="free">bs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> monic<span class="main">:</span> <span class="quoted"><span class="quoted">"monic <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"square_free_factorization <span class="free">p</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span><span class="free">bs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b</span><span class="main">,</span><span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">bs</span> <span class="main">⟹</span> monic <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map snd <span class="free">bs</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> monic_factorization<span class="main">[</span><span class="operator">OF</span> monic<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"monic_factorization <span class="skolem">as</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"monic_factorization.yun_monic_factorization"</span><span class="main">[</span><span class="operator">OF</span> this res<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"square_free_factorization <span class="free">p</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span><span class="free">bs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b</span><span class="main">,</span><span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">bs</span> <span class="main">⟹</span> monic <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map snd <span class="free">bs</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> square_free_factorization_smult<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> sf<span class="main">:</span> <span class="quoted"><span class="quoted">"square_free_factorization <span class="free">p</span> <span class="main">(</span><span class="free">d</span><span class="main">,</span><span class="free">bs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"square_free_factorization <span class="main">(</span>smult <span class="free">c</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">c</span> <span class="main">*</span> <span class="free">d</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> sf<span class="main">[</span><span class="operator">unfolded</span> square_free_factorization_def split<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> smult <span class="free">d</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span>set <span class="free">bs</span><span class="main">.</span> <span class="bound">a</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> <span class="free">d</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">bs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> eq c <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"smult <span class="free">c</span> <span class="free">p</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> <span class="free">c</span> <span class="main">*</span> <span class="free">d</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">bs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> p <span class="keyword1"><span class="command">have</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"smult <span class="free">c</span> <span class="free">p</span> <span class="main">=</span> smult <span class="main">(</span><span class="free">c</span> <span class="main">*</span> <span class="free">d</span><span class="main">)</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span>set <span class="free">bs</span><span class="main">.</span> <span class="bound">a</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> eq p sf <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> square_free_factorization_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> yun_factorization<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"yun_factorization gcd <span class="free">p</span> <span class="main">=</span> <span class="free">c_bs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"square_free_factorization <span class="free">p</span> <span class="free">c_bs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b</span><span class="main">,</span><span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>snd <span class="free">c_bs</span><span class="main">)</span> <span class="main">⟹</span> monic <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> yun_gcd <span class="quoted">gcd</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> res<span class="main">[</span><span class="operator">unfolded</span> yun_factorization_def Let_def<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"square_free_factorization <span class="free">p</span> <span class="free">c_bs</span> <span class="main">∧</span> <span class="main">(</span><span class="main">(</span><span class="free">b</span><span class="main">,</span><span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>snd <span class="free">c_bs</span><span class="main">)</span> <span class="main">⟶</span> monic <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> res <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c_bs</span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>    
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> square_free_factorization_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"coeff <span class="free">p</span> <span class="main">(</span>degree <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ic</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"inverse <span class="var">?c</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> cbs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c_bs</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">c</span><span class="main">,</span><span class="skolem">bs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">with</span></span> False res
    <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="var">?c</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?c</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fact<span class="main">:</span> <span class="quoted"><span class="quoted">"yun_monic_factorization <span class="main">(</span>smult <span class="var">?ic</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">bs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> mon<span class="main">:</span> <span class="quoted"><span class="quoted">"monic <span class="main">(</span>smult <span class="var">?ic</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> yun_monic_factorization<span class="main">[</span><span class="operator">OF</span> fact mon<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> sff<span class="main">:</span> <span class="quoted"><span class="quoted">"square_free_factorization <span class="main">(</span>smult <span class="var">?ic</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="skolem">bs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">bs</span> <span class="main">⟹</span> monic <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"smult <span class="var">?c</span> <span class="main">(</span>smult <span class="var">?ic</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> square_free_factorization_smult<span class="main">[</span><span class="operator">OF</span> c<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> sff<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">unfolded</span> id<span class="main">]</span> sff
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> cbs c <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"square_free_factorization <span class="free">p</span> <span class="free">c_bs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b</span><span class="main">,</span><span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>snd <span class="free">c_bs</span><span class="main">)</span> <span class="main">⟹</span> monic <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> prod_list_pow_suc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="bound">x</span><span class="main">←</span><span class="free">bs</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> comm_monoid_mult<span class="main">)</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">^</span> <span class="free">i</span><span class="main">)</span> 
  <span class="main">=</span> prod_list <span class="free">bs</span> <span class="main">*</span> prod_list <span class="free">bs</span> <span class="main">^</span> <span class="free">i</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">bs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> irreducible_linear_field_poly<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main">!</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">context</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">SORT_CONSTRAINT</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>field<span class="main">,</span> factorial_ring_gcd<span class="main">,</span>semiring_gcd_mult_normalize<span class="main">}</span><span class="main">)</span>"</span></span> 
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lemma</span></span> square_free_factorization_order_root_mem<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> sff<span class="main">:</span> <span class="quoted"><span class="quoted">"square_free_factorization <span class="free">p</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">bs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">(</span><span class="main">0</span> <span class="main">::</span> <span class="tfree">'a</span> poly<span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ai<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">bs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> rt<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="free">a</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"order <span class="free">x</span> <span class="free">p</span> <span class="main">=</span> Suc <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> sff <span class="main">=</span> square_free_factorizationD<span class="main">[</span><span class="operator">OF</span> sff<span class="main">]</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?prod</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span>set <span class="free">bs</span><span class="main">.</span> <span class="bound">a</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> sff <span class="keyword1"><span class="command">have</span></span> pf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> smult <span class="free">c</span> <span class="var">?prod</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> p <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> ord<span class="main">:</span> <span class="quoted"><span class="quoted">"order <span class="free">x</span> <span class="free">p</span> <span class="main">=</span> order <span class="free">x</span> <span class="var">?prod</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> pf 
    <span class="keyword1"><span class="command">using</span></span> order_smult<span class="main">[</span><span class="operator">OF</span> c<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> <span class="main">[:</span> <span class="main">-</span><span class="free">x</span><span class="main">,</span> <span class="main">1</span> <span class="main">:]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> q0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> q_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> iq<span class="main">:</span> <span class="quoted"><span class="quoted">"irreducible <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> q_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> rt <span class="keyword1"><span class="command">have</span></span> qa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="keyword1">dvd</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> q_def poly_eq_0_iff_dvd <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> aqb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="skolem">q</span> <span class="main">*</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> sff<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> ai<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> sq<span class="main">:</span> <span class="quoted"><span class="quoted">"square_free <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> mon<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">a</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rem</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span>set <span class="free">bs</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">i</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> <span class="bound">a</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> p0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?prod</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p pf <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?prod</span> <span class="main">=</span> <span class="free">a</span> <span class="main">^</span> Suc <span class="free">i</span> <span class="main">*</span> <span class="var">?rem</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> prod.remove<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ ai<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">^</span> Suc <span class="free">i</span> <span class="main">=</span> <span class="skolem">q</span> <span class="main">^</span> Suc <span class="free">i</span> <span class="main">*</span> <span class="skolem">b</span> <span class="main">^</span> Suc <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> aqb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?prod</span> <span class="main">=</span> <span class="skolem">q</span> <span class="main">^</span> Suc <span class="free">i</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">b</span> <span class="main">^</span> Suc <span class="free">i</span> <span class="main">*</span> <span class="var">?rem</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">^</span> Suc <span class="free">i</span> <span class="keyword1">dvd</span> <span class="var">?prod</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">^</span> Suc <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="keyword1">dvd</span> <span class="var">?prod</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="keyword1">dvd</span> <span class="var">?prod</span> <span class="keyword1">div</span> <span class="skolem">q</span> <span class="main">^</span> Suc <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dvd dvd_0_left_iff dvd_div_iff_mult p0 power_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?prod</span> <span class="keyword1">div</span> <span class="skolem">q</span> <span class="main">^</span> Suc <span class="free">i</span> <span class="main">=</span> <span class="skolem">b</span> <span class="main">^</span> Suc <span class="free">i</span> <span class="main">*</span> <span class="var">?rem</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> id <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nonzero_mult_div_cancel_left<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> q0<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="keyword1">dvd</span> <span class="skolem">b</span> <span class="main">∨</span> <span class="skolem">q</span> <span class="keyword1">dvd</span> <span class="var">?rem</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> iq irreducible_dvd_pow<span class="main">[</span><span class="operator">OF</span> iq<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="keyword1">dvd</span> <span class="skolem">b</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> aqb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">*</span> <span class="skolem">q</span> <span class="keyword1">dvd</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> sq<span class="main">[</span><span class="operator">unfolded</span> square_free_def<span class="main">]</span> mon iq <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">unfolding</span></span> irreducible<span class="hidden">⇩</span><sub>d</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="keyword1">dvd</span> <span class="var">?rem</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> irreducible_dvd_prod<span class="main">[</span><span class="operator">OF</span> iq this<span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> bj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">bs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">i</span><span class="main">)</span> <span class="main">≠</span> <span class="main">(</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="keyword1">dvd</span> <span class="skolem">b</span> <span class="main">^</span> Suc <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> irreducible_dvd_pow<span class="main">[</span><span class="operator">OF</span> iq dvd<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> qb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="keyword1">dvd</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">from</span></span> sff<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> ai bj neq<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> gcd<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="free">a</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">from</span></span> qb qa <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="keyword1">dvd</span> gcd <span class="free">a</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> dvd_imp_degree_le<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> gcd<span class="main"><span class="main">]</span></span><span class="main">]</span> iq q0 <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> gcd <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> ndvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">q</span> <span class="main">^</span> Suc <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="keyword1">dvd</span> <span class="var">?prod</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> dvd <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"order <span class="free">x</span> <span class="var">?prod</span> <span class="main">=</span> Suc <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> q_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> order_unique_lemma<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> ord <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> square_free_factorization_order_root_no_mem<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> sff<span class="main">:</span> <span class="quoted"><span class="quoted">"square_free_factorization <span class="free">p</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">bs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">(</span><span class="main">0</span> <span class="main">::</span> <span class="tfree">'a</span> poly<span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> no_root<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">bs</span> <span class="main">⟹</span> poly <span class="bound">a</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"order <span class="free">x</span> <span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> o0<span class="main">:</span> <span class="quoted"><span class="quoted">"order <span class="free">x</span> <span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> order_root<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> p <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="free">p</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> sff <span class="main">=</span> square_free_factorizationD<span class="main">[</span><span class="operator">OF</span> sff<span class="main">]</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?prod</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span>set <span class="free">bs</span><span class="main">.</span> <span class="bound">a</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> sff <span class="keyword1"><span class="command">have</span></span> pf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> smult <span class="free">c</span> <span class="var">?prod</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> p <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> 0 <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="var">?prod</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> pf <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> <span class="main">[:</span> <span class="main">-</span><span class="free">x</span><span class="main">,</span> <span class="main">1</span> <span class="main">:]</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> 0 <span class="keyword1"><span class="command">have</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="keyword1">dvd</span> <span class="var">?prod</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> poly_eq_0_iff_dvd <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> q_def<span class="main">)</span>  
  <span class="keyword1"><span class="command">have</span></span> q0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> q_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> iq<span class="main">:</span> <span class="quoted"><span class="quoted">"irreducible <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> q_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> irreducible_dvd_prod<span class="main">[</span><span class="operator">OF</span> iq dvd<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> ai<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">bs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="keyword1">dvd</span> <span class="skolem">a</span> <span class="main">^</span> Suc <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> irreducible_dvd_pow<span class="main">[</span><span class="operator">OF</span> iq dvd<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="keyword1">dvd</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"poly <span class="skolem">a</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> q_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> poly_eq_0_iff_dvd q_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> no_root<span class="main">[</span><span class="operator">OF</span> ai<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> square_free_factorization_order_root<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> sff<span class="main">:</span> <span class="quoted"><span class="quoted">"square_free_factorization <span class="free">p</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">bs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">(</span><span class="main">0</span> <span class="main">::</span> <span class="tfree">'a</span> poly<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"order <span class="free">x</span> <span class="free">p</span> <span class="main">=</span> <span class="free">i</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">i</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">a</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">bs</span> <span class="main">⟶</span> poly <span class="bound">a</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span> 
    <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">a</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">bs</span> <span class="main">∧</span> poly <span class="bound">a</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">=</span> Suc <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="main">(</span><span class="var">?r1</span> <span class="main">∨</span> <span class="var">?r2</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> mem <span class="main">=</span> square_free_factorization_order_root_mem<span class="main">[</span><span class="operator">OF</span> sff p<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> no_mem <span class="main">=</span> square_free_factorization_order_root_no_mem<span class="main">[</span><span class="operator">OF</span> sff p<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r1</span> <span class="main">∨</span> <span class="var">?r2</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?r2</span></span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> aj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">bs</span>"</span></span> <span class="quoted"><span class="quoted">"poly <span class="skolem">a</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> Suc <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> mem<span class="main">[</span><span class="operator">OF</span> aj<span class="main">]</span> i <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?r1</span></span></span> 
      <span class="keyword1"><span class="command">with</span></span> no_mem<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r1</span> <span class="main">∨</span> <span class="var">?r2</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">bs</span> <span class="main">∧</span> poly <span class="bound">a</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">bs</span>"</span></span> <span class="quoted"><span class="quoted">"poly <span class="skolem">a</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> mem<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="var">?l</span>›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?r2</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> no_mem<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="var">?l</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?r1</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> square_free_factorization_root<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> sff<span class="main">:</span> <span class="quoted"><span class="quoted">"square_free_factorization <span class="free">p</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">bs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">(</span><span class="main">0</span> <span class="main">::</span> <span class="tfree">'a</span> poly<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">a</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">bs</span> <span class="main">∧</span> poly <span class="bound">a</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> square_free_factorization_order_root<span class="main">[</span><span class="operator">OF</span> sff p<span class="main">]</span> p
  <span class="keyword1"><span class="command">unfolding</span></span> order_root <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> square_free_factorizationD'<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sf<span class="main">:</span> <span class="quoted"><span class="quoted">"square_free_factorization <span class="free">p</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> smult <span class="free">c</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">←</span> <span class="free">bs</span><span class="main">.</span> <span class="bound">a</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"square_free <span class="main">(</span>prod_list <span class="main">(</span>map fst <span class="free">bs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">b</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">bs</span> <span class="main">⟹</span> degree <span class="bound">b</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">bs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> sf <span class="main">=</span> square_free_factorizationD<span class="main">[</span><span class="operator">OF</span> sf<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> smult <span class="free">c</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">←</span> <span class="free">bs</span><span class="main">.</span> <span class="bound">a</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sf<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> sf<span class="main">(</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod.distinct_set_conv_list<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> bs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">b</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">bs</span> <span class="main">⟹</span> degree <span class="bound">b</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sf<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">bs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sf<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"square_free <span class="main">(</span>prod_list <span class="main">(</span>map fst <span class="free">bs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> square_freeI<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> bs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">bs</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">b</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"prod_list <span class="main">(</span>map fst <span class="free">bs</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> prod_list_zero_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">q</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">*</span> <span class="skolem">q</span> <span class="keyword1">dvd</span> prod_list <span class="main">(</span>map fst <span class="free">bs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> irreducible<span class="hidden">⇩</span><sub>d</sub>_factor<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      irr<span class="main">:</span> <span class="quoted"><span class="quoted">"irreducible <span class="skolem">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">*</span> <span class="skolem">q</span> <span class="keyword1">dvd</span> prod_list <span class="main">(</span>map fst <span class="free">bs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> dvd'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="keyword1">dvd</span> prod_list <span class="main">(</span>map fst <span class="free">bs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> irreducible_dvd_prod_list<span class="main">[</span><span class="operator">OF</span> irr dvd'<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">bs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dvd1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="keyword1">dvd</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> dvd1 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> <span class="skolem">q</span> <span class="main">*</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> split_list<span class="main">[</span><span class="operator">OF</span> mem<span class="main">]</span> b <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bs1</span></span> <span class="skolem"><span class="skolem">bs2</span></span> <span class="keyword2"><span class="keyword">where</span></span> bs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bs</span> <span class="main">=</span> <span class="skolem">bs1</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">b</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">bs2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> irr <span class="keyword1"><span class="command">have</span></span> q0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dq<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">q</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> irreducible<span class="hidden">⇩</span><sub>d</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> sf<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> mem<span class="main">,</span> <span class="operator">unfolded</span> b<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"square_free <span class="main">(</span><span class="skolem">q</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> square_free_def<span class="main">,</span> <span class="operator">THEN</span> conjunct2<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> dq<span class="main">]</span> 
    <span class="keyword1"><span class="command">have</span></span> qk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">q</span> <span class="keyword1">dvd</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> dvd<span class="main">[</span><span class="operator">unfolded</span> bs b<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">*</span> <span class="skolem">q</span> <span class="keyword1">dvd</span> <span class="skolem">q</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">*</span> prod_list <span class="main">(</span>map fst <span class="main">(</span><span class="skolem">bs1</span> <span class="main">@</span> <span class="skolem">bs2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> q0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="keyword1">dvd</span> <span class="skolem">k</span> <span class="main">*</span> prod_list <span class="main">(</span>map fst <span class="main">(</span><span class="skolem">bs1</span> <span class="main">@</span> <span class="skolem">bs2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> irr qk <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="keyword1">dvd</span> prod_list <span class="main">(</span>map fst <span class="main">(</span><span class="skolem">bs1</span> <span class="main">@</span> <span class="skolem">bs2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> irreducible_dvd_prod_list<span class="main">[</span><span class="operator">OF</span> irr this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b'</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      mem'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b'</span><span class="main">,</span><span class="skolem">i'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">bs1</span> <span class="main">@</span> <span class="skolem">bs2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dvd2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="keyword1">dvd</span> <span class="skolem">b'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">from</span></span> dvd1 dvd2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="keyword1">dvd</span> gcd <span class="skolem">b</span> <span class="skolem">b'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> dq is_unit_iff_degree<span class="main">[</span><span class="operator">OF</span> q0<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> cop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> coprime <span class="skolem">b</span> <span class="skolem">b'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">from</span></span> mem' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b'</span><span class="main">,</span><span class="skolem">i'</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">bs</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> bs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> sf<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> mem this<span class="main">]</span> cop <span class="keyword1"><span class="command">have</span></span> b'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b'</span><span class="main">,</span><span class="skolem">i'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> coprime_iff_gcd_eq_1<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> mem' sf<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> bs<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
  

<span class="keyword1"><span class="command">lemma</span></span> square_free_factorizationI'<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> prod<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> smult <span class="free">c</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">←</span> <span class="free">bs</span><span class="main">.</span> <span class="bound">a</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> sf<span class="main">:</span> <span class="quoted"><span class="quoted">"square_free <span class="main">(</span>prod_list <span class="main">(</span>map fst <span class="free">bs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> deg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">b</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">bs</span> <span class="main">⟹</span> degree <span class="bound">b</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">bs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"square_free_factorization <span class="free">p</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> square_free_factorization_def split
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI impI allI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">bs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> bi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">bs</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> deg<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">b</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="keyword1">dvd</span> prod_list <span class="main">(</span>map fst <span class="free">bs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> prod_list_dvd<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> bi<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> square_free_factor<span class="main">[</span><span class="operator">OF</span> this sf<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"square_free <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">show</span></span> dist<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">bs</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?thesis</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> not_distinct_decomp<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bs1</span></span> <span class="skolem"><span class="skolem">bs2</span></span> <span class="skolem"><span class="skolem">bs3</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      bs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bs</span> <span class="main">=</span> <span class="skolem">bs1</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">bs2</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">bs3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">*</span> <span class="skolem">b</span> <span class="keyword1">dvd</span> prod_list <span class="main">(</span>map fst <span class="free">bs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> sf<span class="main">[</span><span class="operator">unfolded</span> square_free_def<span class="main">,</span> <span class="operator">THEN</span> conjunct2<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">have</span></span> db<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">b</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> bs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">bs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> deg<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> db <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>    
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> smult <span class="free">c</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span>set <span class="free">bs</span><span class="main">.</span> <span class="bound">a</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> prod <span class="keyword1"><span class="command">using</span></span> dist 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod.distinct_set_conv_list<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">i</span> <span class="skolem">b</span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span> ai<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">bs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> bj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">bs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> diff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≠</span> <span class="main">(</span><span class="skolem">b</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> split_list<span class="main">[</span><span class="operator">OF</span> ai<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bs1</span></span> <span class="skolem"><span class="skolem">bs2</span></span> <span class="keyword2"><span class="keyword">where</span></span> bs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bs</span> <span class="main">=</span> <span class="skolem">bs1</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">bs2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> bj diff <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">bs1</span> <span class="main">@</span> <span class="skolem">bs2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> split_list<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cs1</span></span> <span class="skolem"><span class="skolem">cs2</span></span> <span class="keyword2"><span class="keyword">where</span></span> cs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bs1</span> <span class="main">@</span> <span class="skolem">bs2</span> <span class="main">=</span> <span class="skolem">cs1</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">cs2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prod_list <span class="main">(</span>map fst <span class="free">bs</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">*</span> prod_list <span class="main">(</span>map fst <span class="main">(</span><span class="skolem">bs1</span> <span class="main">@</span> <span class="skolem">bs2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> bs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">*</span> <span class="skolem">b</span> <span class="main">*</span> prod_list <span class="main">(</span>map fst <span class="main">(</span><span class="skolem">cs1</span> <span class="main">@</span> <span class="skolem">cs2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> cs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> lp<span class="main">:</span> <span class="quoted"><span class="quoted">"prod_list <span class="main">(</span>map fst <span class="free">bs</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">*</span> <span class="skolem">b</span> <span class="main">*</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> deg<span class="main">[</span><span class="operator">OF</span> ai<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"gcd <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> gcd<span class="main">:</span> <span class="quoted"><span class="quoted">"gcd <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">*</span> gcd <span class="skolem">a</span> <span class="skolem">b</span> <span class="keyword1">dvd</span> prod_list <span class="main">(</span>map fst <span class="free">bs</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> lp <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_dvd_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span>gcd <span class="skolem">a</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> sf<span class="main">[</span><span class="operator">unfolded</span> square_free_def<span class="main">,</span> <span class="operator">THEN</span> conjunct2<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> this<span class="main">]</span> gcd
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span>gcd <span class="skolem">a</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> 0 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">a</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> is_unit_gcd is_unit_iff_degree <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> square_free_factorization_def'<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> poly"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"square_free_factorization <span class="free">p</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">bs</span><span class="main">)</span> <span class="main">⟷</span>
  <span class="main">(</span><span class="free">p</span> <span class="main">=</span> smult <span class="free">c</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">←</span> <span class="free">bs</span><span class="main">.</span> <span class="bound">a</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span>square_free <span class="main">(</span>prod_list <span class="main">(</span>map fst <span class="free">bs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">∀</span> <span class="bound">b</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">bs</span> <span class="main">⟶</span> degree <span class="bound">b</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span><span class="free">p</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> <span class="free">c</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">bs</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> square_free_factorizationD'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">p</span></span></span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">c</span></span></span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">bs</span></span></span></span></span></span></span></span><span class="main">]</span>
  square_free_factorizationI'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">bs</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> square_free_factorization_smult_prod_listI<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sff<span class="main">:</span> <span class="quoted"><span class="quoted">"square_free_factorization <span class="free">p</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="free">bs1</span> <span class="main">@</span> <span class="main">(</span>smult <span class="free">b</span> <span class="main">(</span>prod_list <span class="free">bs</span><span class="main">)</span><span class="main">,</span><span class="free">i</span><span class="main">)</span> <span class="main">#</span> <span class="free">bs2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> bs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> set <span class="free">bs</span> <span class="main">⟹</span> degree <span class="bound">b</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"square_free_factorization <span class="free">p</span> <span class="main">(</span><span class="free">c</span> <span class="main">*</span> <span class="free">b</span><span class="main">^</span><span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">,</span> <span class="free">bs1</span> <span class="main">@</span> map <span class="main">(</span><span class="main">λ</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span><span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="free">bs</span> <span class="main">@</span> <span class="free">bs2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> square_free_factorizationD'<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> sff<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"smult <span class="free">b</span> <span class="main">(</span>prod_list <span class="free">bs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> sff <span class="main">=</span> square_free_factorizationD'<span class="main">[</span><span class="operator">OF</span> sff<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> square_free_factorizationI'<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> sff<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def <span class="dynamic"><span class="dynamic">field_simps</span></span> smult_power prod_list_pow_suc<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> sff<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span> o_def square_free_smult_iff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> b<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 3
    <span class="keyword1"><span class="command">with</span></span> sff<span class="main">(</span>3<span class="main">)</span> bs <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 4
    <span class="keyword1"><span class="command">from</span></span> sff<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> square_free_factorization_further_factorization<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sff<span class="main">:</span> <span class="quoted"><span class="quoted">"square_free_factorization <span class="free">p</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> bs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">b</span> <span class="bound">i</span> <span class="bound">d</span> <span class="bound">fs</span><span class="main">.</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">bs</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">b</span> <span class="main">=</span> <span class="main">(</span><span class="bound">d</span><span class="main">,</span><span class="bound">fs</span><span class="main">)</span> 
    <span class="main">⟹</span> <span class="bound">b</span> <span class="main">=</span> smult <span class="bound">d</span> <span class="main">(</span>prod_list <span class="bound">fs</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">f</span> <span class="main">∈</span> set <span class="bound">fs</span><span class="main">.</span> degree <span class="bound">f</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">case</span> <span class="free">f</span> <span class="bound">b</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">d</span><span class="main">,</span><span class="bound">fs</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">d</span><span class="main">^</span>Suc <span class="bound">i</span><span class="main">,</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">f</span><span class="main">.</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="bound">fs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> gs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gs</span> <span class="main">=</span> map <span class="free">h</span> <span class="free">bs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">=</span> <span class="free">c</span> <span class="main">*</span> prod_list <span class="main">(</span>map fst <span class="free">gs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> es<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">es</span> <span class="main">=</span> concat <span class="main">(</span>map snd <span class="free">gs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"square_free_factorization <span class="free">p</span> <span class="main">(</span><span class="free">d</span><span class="main">,</span> <span class="free">es</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> sff <span class="main">=</span> square_free_factorizationD'<span class="main">[</span><span class="operator">OF</span> sff<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> square_free_factorizationI'<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> sff<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">es</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> d es gs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">←</span><span class="free">bs</span><span class="main">.</span> <span class="bound">a</span> <span class="main">*</span> <span class="bound">a</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> smult <span class="main">(</span>prod_list <span class="main">(</span>map fst <span class="free">gs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">←</span><span class="free">es</span><span class="main">.</span> <span class="bound">a</span> <span class="main">*</span> <span class="bound">a</span> <span class="main">^</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> es gs h map_map o_def <span class="keyword1"><span class="command">using</span></span> bs
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">bs</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">bi</span> <span class="skolem">bs</span><span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> bi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bi</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="skolem"><span class="skolem">fs</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">b</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">d</span><span class="main">,</span><span class="skolem">fs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ f<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> smult <span class="skolem">d</span> <span class="main">(</span>prod_list <span class="skolem">fs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> bi <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Cons<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="main"><span class="bound">_</span></span> <span class="bound">i</span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main">.</span> <span class="bound">i</span>"</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> bi
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f o_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> b <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> IH<span class="main"><span class="keyword3">,</span></span> 
          <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smult_power prod_list_pow_suc <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> smult <span class="free">d</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">←</span><span class="free">es</span><span class="main">.</span> <span class="bound">a</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sff<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> id
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> d<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">fi</span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> fi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">fi</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">es</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> es<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">G</span></span> <span class="keyword2"><span class="keyword">where</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free">gs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">fi</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> G<span class="main">[</span><span class="operator">unfolded</span> gs<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> bi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">bs</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="main">=</span> snd <span class="main">(</span><span class="free">h</span> <span class="main">(</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="skolem"><span class="skolem">fs</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">b</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">d</span><span class="main">,</span><span class="skolem">fs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">fi</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bs<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> conjunct2<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> bi f<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> fi G f<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> h<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">c</span><span class="main">.</span> prod_list <span class="main">(</span>map fst <span class="free">bs</span><span class="main">)</span> <span class="main">=</span> smult <span class="bound">c</span> <span class="main">(</span>prod_list <span class="main">(</span>map fst <span class="free">es</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> es gs map_map o_def <span class="keyword1"><span class="command">using</span></span> bs
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">bs</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">bi</span> <span class="skolem">bs</span><span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> bi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bi</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="skolem"><span class="skolem">fs</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">b</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">d</span><span class="main">,</span><span class="skolem">fs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ f<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> smult <span class="skolem">d</span> <span class="main">(</span>prod_list <span class="skolem">fs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> bi <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c</span><span class="main">.</span> prod_list <span class="main">(</span>map fst <span class="skolem">bs</span><span class="main">)</span> <span class="main">=</span> smult <span class="bound">c</span> <span class="main">(</span>prod_list <span class="main">(</span>map fst <span class="main">(</span>concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> snd <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">bs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Cons<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Cons<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
        IH<span class="main">:</span> <span class="quoted"><span class="quoted">"prod_list <span class="main">(</span>map fst <span class="skolem">bs</span><span class="main">)</span> <span class="main">=</span> smult <span class="skolem">c</span> <span class="main">(</span>prod_list <span class="main">(</span>map fst <span class="main">(</span>concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> snd <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">bs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> bi
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">c</span></span></span> <span class="main"><span class="main"><span class="main">*</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">d</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> b IH<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> h f<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> b<span class="main"><span class="main">]</span></span> o_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main">1</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"prod_list <span class="main">(</span>map fst <span class="free">bs</span><span class="main">)</span> <span class="main">=</span> smult <span class="skolem">c</span> <span class="main">(</span>prod_list <span class="main">(</span>map fst <span class="free">es</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> sff<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"square_free <span class="main">(</span>prod_list <span class="main">(</span>map fst <span class="free">es</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> smult_eq_0_iff square_free_def square_free_smult_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> square_free_factorization_prod_listI<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sff<span class="main">:</span> <span class="quoted"><span class="quoted">"square_free_factorization <span class="free">p</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="free">bs1</span> <span class="main">@</span> <span class="main">(</span><span class="main">(</span>prod_list <span class="free">bs</span><span class="main">)</span><span class="main">,</span><span class="free">i</span><span class="main">)</span> <span class="main">#</span> <span class="free">bs2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> bs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> set <span class="free">bs</span> <span class="main">⟹</span> degree <span class="bound">b</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"square_free_factorization <span class="free">p</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="free">bs1</span> <span class="main">@</span> map <span class="main">(</span><span class="main">λ</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span><span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="free">bs</span> <span class="main">@</span> <span class="free">bs2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> square_free_factorization_smult_prod_listI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">bs1</span></span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">bs2</span></span><span class="main">]</span> sff bs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> square_free_factorization_factorI<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sff<span class="main">:</span> <span class="quoted"><span class="quoted">"square_free_factorization <span class="free">p</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="free">bs1</span> <span class="main">@</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">i</span><span class="main">)</span> <span class="main">#</span> <span class="free">bs2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">r</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">s</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">r</span> <span class="main">*</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"square_free_factorization <span class="free">p</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="free">bs1</span> <span class="main">@</span> <span class="main">(</span><span class="main">(</span><span class="free">r</span><span class="main">,</span><span class="free">i</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">i</span><span class="main">)</span> <span class="main">#</span> <span class="free">bs2</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> square_free_factorization_prod_listI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">bs1</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">r</span><span class="main">,</span><span class="free">s</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">bs2</span></span><span class="main">]</span> sff r s a <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> monic_square_free_irreducible_factorization<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> mon<span class="main">:</span> <span class="quoted"><span class="quoted">"monic <span class="main">(</span><span class="free">f</span> <span class="main">::</span> <span class="tfree">'b</span> <span class="main">::</span> field poly<span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> sf<span class="main">:</span> <span class="quoted"><span class="quoted">"square_free <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">P</span><span class="main">.</span> finite <span class="bound">P</span> <span class="main">∧</span> <span class="free">f</span> <span class="main">=</span> <span class="main">∏</span><span class="bound">P</span> <span class="main">∧</span> <span class="bound">P</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> irreducible <span class="bound">q</span> <span class="main">∧</span> monic <span class="bound">q</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> mon <span class="keyword1"><span class="command">have</span></span> f0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> monic_irreducible_factorization<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    P<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="bound">q</span> <span class="main">∧</span> monic <span class="bound">q</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">a</span><span class="main">∈</span><span class="skolem">P</span><span class="main">.</span> <span class="bound">a</span> <span class="main">^</span> Suc <span class="main">(</span><span class="skolem">n</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">a</span> <span class="main">∈</span> <span class="skolem">P</span><span class="main">.</span> <span class="skolem">n</span> <span class="bound">a</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?thesis</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="skolem">a</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">^</span> <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">n</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∏</span><span class="bound">b</span><span class="main">∈</span><span class="skolem">P</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span><span class="main">.</span> <span class="bound">b</span> <span class="main">^</span> Suc <span class="main">(</span><span class="skolem">n</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> f <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod.remove<span class="main"><span class="main">[</span></span><span class="operator">OF</span> P<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> a<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> n <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">*</span> <span class="skolem">a</span> <span class="keyword1">dvd</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="skolem">a</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> sf<span class="main">[</span><span class="operator">unfolded</span> square_free_def<span class="main">]</span> f0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">a</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> a P<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> irreducible<span class="hidden">⇩</span><sub>d</sub>_def<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="main">∏</span> <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> f
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod.cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> *<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> P <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">SORT_CONSTRAINT</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>field<span class="main">,</span> factorial_ring_gcd<span class="main">}</span><span class="main">)</span>"</span></span> 
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lemma</span></span> monic_factorization_uniqueness<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> poly set"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> finite_P<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">P</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> PQ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∏</span><span class="free">P</span> <span class="main">=</span> <span class="main">∏</span><span class="free">Q</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="bound">q</span> <span class="main">∧</span> monic <span class="bound">q</span><span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> finite_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Q</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="bound">q</span> <span class="main">∧</span> monic <span class="bound">q</span><span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">=</span> <span class="free">Q</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span> subsetI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> irr_x<span class="main">:</span> <span class="quoted"><span class="quoted">"irreducible <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x P <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span><span class="main">∈</span><span class="free">Q</span><span class="main">.</span> <span class="skolem">x</span> <span class="keyword1">dvd</span> id <span class="bound">a</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> irreducible_dvd_prod<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">dvd</span> prod id <span class="free">Q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> PQ x 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dvd_refl dvd_prod finite_P id_apply prod.cong<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">∈</span><span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x_dvd_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">dvd</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> id_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">=</span><span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x P a Q irreducible<span class="hidden">⇩</span><sub>d</sub>_dvd_eq<span class="main">[</span><span class="operator">OF</span> _ _ x_dvd_a<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">Q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> irr_x<span class="main">:</span> <span class="quoted"><span class="quoted">"irreducible <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x Q <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span><span class="main">∈</span><span class="free">P</span><span class="main">.</span> <span class="skolem">x</span> <span class="keyword1">dvd</span> id <span class="bound">a</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> irreducible_dvd_prod<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">dvd</span> prod id <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> PQ x 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dvd_refl dvd_prod finite_Q id_apply prod.cong<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">∈</span><span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x_dvd_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">dvd</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> id_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">=</span><span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x P a Q irreducible<span class="hidden">⇩</span><sub>d</sub>_dvd_eq<span class="main">[</span><span class="operator">OF</span> _ _ x_dvd_a<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Yun factorization and homomorphisms›</span></span>

<span class="keyword1"><span class="command">locale</span></span> field_hom_0' <span class="main">=</span> field_hom <span class="quoted"><span class="free">hom</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">hom</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>field_char_0<span class="main">,</span>field_gcd<span class="main">}</span> <span class="main">⇒</span>
              <span class="tfree">'b</span> <span class="main">::</span> <span class="main">{</span>field_char_0<span class="main">,</span>field_gcd<span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">sublocale</span></span> field_hom' <span class="keyword1"><span class="command">..</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> field_hom_0'<span class="main">)</span> yun_factorization_main_hom<span class="main">:</span>
  <span class="keyword2"><span class="keyword">defines</span></span> hp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">hp</span> <span class="main">≡</span> map_poly <span class="free">hom</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> hpi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">hpi</span> <span class="main">≡</span> map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">hp</span> <span class="bound">f</span><span class="main">,</span> <span class="bound">i</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> monic<span class="main">:</span> <span class="quoted"><span class="quoted">"monic <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="free">p</span> <span class="keyword1">div</span> gcd <span class="free">p</span> <span class="main">(</span>pderiv <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">=</span> pderiv <span class="free">p</span> <span class="keyword1">div</span> gcd <span class="free">p</span> <span class="main">(</span>pderiv <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"yun_gcd.yun_factorization_main gcd <span class="main">(</span><span class="free">hp</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">hp</span> <span class="free">g</span><span class="main">)</span> <span class="free">i</span> <span class="main">(</span><span class="free">hpi</span> <span class="free">as</span><span class="main">)</span> <span class="main">=</span> <span class="free">hpi</span> <span class="main">(</span>yun_gcd.yun_factorization_main gcd <span class="free">f</span> <span class="free">g</span> <span class="free">i</span> <span class="free">as</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">f</span> <span class="bound">g</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">i</span> <span class="bound">as</span><span class="main">.</span> yun_gcd.yun_factorization_main gcd <span class="main">(</span><span class="free">hp</span> <span class="bound">f</span><span class="main">)</span> <span class="main">(</span><span class="free">hp</span> <span class="bound">g</span><span class="main">)</span> <span class="bound">i</span> <span class="main">(</span><span class="free">hpi</span> <span class="bound">as</span><span class="main">)</span> <span class="main">=</span> <span class="free">hpi</span> <span class="main">(</span>yun_gcd.yun_factorization_main gcd <span class="bound">f</span> <span class="bound">g</span> <span class="bound">i</span> <span class="bound">as</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> ind <span class="main">=</span> yun_factorization_induct<span class="main">[</span><span class="operator">OF</span> _ _ f g monic<span class="main">,</span> <span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
  <span class="keyword1"><span class="command">interpret</span></span> map_poly_hom<span class="main">:</span> map_poly_inj_comm_ring_hom<span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> p<span class="main">:</span> inj_comm_ring_hom <span class="quoted"><span class="free">hp</span></span> <span class="keyword1"><span class="command">unfolding</span></span> hp<span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">note</span></span> homs <span class="main">=</span> map_poly_gcd<span class="main">[</span><span class="operator">folded</span> hp<span class="main">]</span> 
      map_poly_pderiv<span class="main">[</span><span class="operator">folded</span> hp<span class="main">]</span> 
      p.hom_minus 
      map_poly_div<span class="main">[</span><span class="operator">folded</span> hp<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ind<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">f</span> <span class="skolem">g</span> <span class="skolem">i</span> <span class="skolem">as</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> yun_gcd.yun_factorization_main.simps<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="free">hp</span> <span class="skolem">f</span>"</span></span><span class="main">]</span> yun_gcd.yun_factorization_main.simps<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">f</span> <span class="skolem">g</span> <span class="skolem">i</span> <span class="skolem">as</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">f</span> <span class="bound">i</span> <span class="bound">fis</span><span class="main">.</span> <span class="free">hpi</span> <span class="main">(</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">#</span> <span class="bound">fis</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">hp</span> <span class="bound">f</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">#</span> <span class="free">hpi</span> <span class="bound">fis</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> hpi <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> yun_gcd.yun_factorization_main.simps<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="free">hp</span> <span class="skolem">f</span>"</span></span><span class="main">]</span> yun_gcd.yun_factorization_main.simps<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted">"p.hom_1_iff"</span>
      <span class="keyword1"><span class="command">unfolding</span></span> Let_def
      <span class="keyword1"><span class="command">unfolding</span></span> homs<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> id<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> 2<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> square_free_square_free_factorization<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"square_free <span class="main">(</span><span class="free">p</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>field<span class="main">,</span>factorial_ring_gcd<span class="main">,</span>semiring_gcd_mult_normalize<span class="main">}</span> poly<span class="main">)</span> <span class="main">⟹</span> 
     degree <span class="free">p</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> square_free_factorization <span class="free">p</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span><span class="main">[</span><span class="main">(</span><span class="free">p</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> square_free_factorizationI'<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> constant_square_free_factorization<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> square_free_factorization <span class="free">p</span> <span class="main">(</span>coeff <span class="free">p</span> <span class="main">0</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> degree0_coeffs <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">p</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> square_free_factorization_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> field_hom_0'<span class="main">)</span> yun_monic_factorization<span class="main">:</span>
  <span class="keyword2"><span class="keyword">defines</span></span> hp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">hp</span> <span class="main">≡</span> map_poly <span class="free">hom</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> hpi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">hpi</span> <span class="main">≡</span> map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">hp</span> <span class="bound">f</span><span class="main">,</span> <span class="bound">i</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> monic<span class="main">:</span> <span class="quoted"><span class="quoted">"monic <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"yun_gcd.yun_monic_factorization gcd <span class="main">(</span><span class="free">hp</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="free">hpi</span> <span class="main">(</span>yun_gcd.yun_monic_factorization gcd <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> map_poly_hom<span class="main">:</span> map_poly_inj_comm_ring_hom<span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> p<span class="main">:</span> inj_ring_hom <span class="quoted"><span class="free">hp</span></span> <span class="keyword1"><span class="command">unfolding</span></span> hp<span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">have</span></span> hpiN<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">hpi</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> hpi <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">res</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">res</span> <span class="main">=</span> 
    yun_gcd.yun_factorization_main gcd <span class="main">(</span><span class="free">f</span> <span class="keyword1">div</span> gcd <span class="free">f</span> <span class="main">(</span>pderiv <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>pderiv <span class="free">f</span> <span class="keyword1">div</span> gcd <span class="free">f</span> <span class="main">(</span>pderiv <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> homs <span class="main">=</span> map_poly_gcd<span class="main">[</span><span class="operator">folded</span> hp<span class="main">]</span> 
      map_poly_pderiv<span class="main">[</span><span class="operator">folded</span> hp<span class="main">]</span> 
      p.hom_minus 
      map_poly_div<span class="main">[</span><span class="operator">folded</span> hp<span class="main">]</span>
      yun_factorization_main_hom<span class="main">[</span><span class="operator">folded</span> hp<span class="main">,</span> <span class="operator">folded</span> hpi<span class="main">,</span> <span class="operator">symmetric</span><span class="main">,</span> <span class="operator">OF</span> monic refl refl<span class="main">,</span> <span class="operator">of</span> <span class="main">_</span> <span class="quoted">Nil</span><span class="main">,</span> <span class="operator">unfolded</span> hpiN<span class="main">]</span>
      this   
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> yun_gcd.yun_monic_factorization_def Let_def
    <span class="keyword1"><span class="command">unfolding</span></span> homs<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> hpi
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">res</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> field_hom_0'<span class="main">)</span> yun_factorization_hom<span class="main">:</span>
  <span class="keyword2"><span class="keyword">defines</span></span> hp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">hp</span> <span class="main">≡</span> map_poly <span class="free">hom</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> hpi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">hpi</span> <span class="main">≡</span> map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">hp</span> <span class="bound">f</span><span class="main">,</span> <span class="bound">i</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"yun_factorization gcd <span class="main">(</span><span class="free">hp</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> map_prod <span class="free">hom</span> <span class="free">hpi</span> <span class="main">(</span>yun_factorization gcd <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> yun_monic_factorization<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"smult <span class="main">(</span>inverse <span class="main">(</span>coeff <span class="free">f</span> <span class="main">(</span>degree <span class="free">f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> yun_factorization_def Let_def hp hpi
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">hom_distribs</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> field_hom_0'<span class="main">)</span> square_free_map_poly<span class="main">:</span>
  <span class="quoted"><span class="quoted">"square_free <span class="main">(</span>map_poly <span class="free">hom</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> square_free <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> map_poly_hom<span class="main">:</span> map_poly_inj_comm_ring_hom<span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> square_free_iff_separable separable_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">hom_distribs</span></span> <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="comment1">(*fold doesn't work!*)</span><span class="main">)</span>
      <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> coprime_iff_gcd_eq_1 map_poly_gcd <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Gcd_Rat_Poly">
<div class="head">
<h1>Theory Gcd_Rat_Poly</h1>
</div>
<pre class="source"><span class="comment1">(*
    Author:      René Thiemann
    License:     BSD
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹GCD of rational polynomials via GCD for integer polynomials›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This theory contains an algorithm to compute GCDs of rational polynomials via 
  a conversion to integer polynomials and then invoking the integer polynomial GCD algorithm.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Gcd_Rat_Poly
<span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="Gauss_Lemma.html">Gauss_Lemma</a>
  <span class="quoted">"<a href="../../HOL/HOL-Computational_Algebra/Field_as_Ring.html">HOL-Computational_Algebra.Field_as_Ring</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">gcd_rat_poly</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat poly <span class="main">⇒</span> rat poly <span class="main">⇒</span> rat poly"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gcd_rat_poly</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span>
     <span class="bound">f'</span> <span class="main">=</span> snd <span class="main">(</span>rat_to_int_poly <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span><span class="main">;</span>
     <span class="bound">g'</span> <span class="main">=</span> snd <span class="main">(</span>rat_to_int_poly <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span><span class="main">;</span>
     <span class="bound">h</span> <span class="main">=</span> map_poly rat_of_int <span class="main">(</span>gcd <span class="bound">f'</span> <span class="bound">g'</span><span class="main">)</span>
   <span class="keyword1">in</span> smult <span class="main">(</span>inverse <span class="main">(</span>lead_coeff <span class="bound">h</span><span class="main">)</span><span class="main">)</span> <span class="bound">h</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gcd_rat_poly<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"gcd_rat_poly <span class="main">=</span> gcd"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="skolem">g</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ri</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_poly rat_of_int"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a'</span></span> <span class="skolem"><span class="skolem">f'</span></span> <span class="keyword2"><span class="keyword">where</span></span> faf'<span class="main">:</span> <span class="quoted"><span class="quoted">"rat_to_int_poly <span class="skolem">f</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a'</span><span class="main">,</span><span class="skolem">f'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> rat_to_int_poly<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> smult <span class="skolem">a</span> <span class="main">(</span><span class="var">?ri</span> <span class="skolem">f'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b'</span></span> <span class="skolem"><span class="skolem">g'</span></span> <span class="keyword2"><span class="keyword">where</span></span> gbg'<span class="main">:</span> <span class="quoted"><span class="quoted">"rat_to_int_poly <span class="skolem">g</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">b'</span><span class="main">,</span><span class="skolem">g'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> rat_to_int_poly<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">=</span> smult <span class="skolem">b</span> <span class="main">(</span><span class="var">?ri</span> <span class="skolem">g'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">=</span> gcd <span class="skolem">f'</span> <span class="skolem">g'</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?ri</span> <span class="skolem">h</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">lc</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lc</span> <span class="main">=</span> inverse <span class="main">(</span>coeff <span class="var">?h</span> <span class="main">(</span>degree <span class="var">?h</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?gcd</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"smult <span class="skolem">lc</span> <span class="var">?h</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"gcd_rat_poly <span class="skolem">f</span> <span class="skolem">g</span> <span class="main">=</span> <span class="var">?gcd</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lc_def h_def gcd_rat_poly_def Let_def faf' gbg' snd_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"gcd_rat_poly <span class="skolem">f</span> <span class="skolem">g</span> <span class="main">=</span> gcd <span class="skolem">f</span> <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> id
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> gcdI<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="keyword1">dvd</span> <span class="skolem">f'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> h_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?h</span> <span class="keyword1">dvd</span> <span class="var">?ri</span> <span class="skolem">f'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">hom_distribs</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?h</span> <span class="keyword1">dvd</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> f <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> dvd_smult<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> dvd_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?gcd</span> <span class="keyword1">dvd</span> <span class="skolem">f</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dvdE inverse_zero_imp_zero lc_def leading_coeff_neq_0 mult_eq_0_iff smult_dvd_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="keyword1">dvd</span> <span class="skolem">g'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> h_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?h</span> <span class="keyword1">dvd</span> <span class="var">?ri</span> <span class="skolem">g'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">hom_distribs</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?h</span> <span class="keyword1">dvd</span> <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> g <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> dvd_smult<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> dvd_g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?gcd</span> <span class="keyword1">dvd</span> <span class="skolem">g</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dvdE inverse_zero_imp_zero lc_def leading_coeff_neq_0 mult_eq_0_iff smult_dvd_iff<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"normalize <span class="var">?gcd</span> <span class="main">=</span> <span class="var">?gcd</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">lc</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> normalize_poly_def pCons_one <span class="dynamic"><span class="dynamic">field_simps</span></span> lc_def<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword3"><span class="command">assume</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="keyword1">dvd</span> <span class="skolem">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="keyword1">dvd</span> <span class="skolem">g</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> kck<span class="main">:</span> <span class="quoted"><span class="quoted">"rat_to_normalized_int_poly <span class="skolem">k</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">c</span><span class="main">,</span><span class="skolem">k'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">from</span></span> rat_to_normalized_int_poly<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> smult <span class="skolem">c</span> <span class="main">(</span><span class="var">?ri</span> <span class="skolem">k'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> dvd<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> kf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="keyword1">dvd</span> <span class="var">?ri</span> <span class="skolem">f'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> f <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> dvd_smult_cancel<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> dvd<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> kg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="keyword1">dvd</span> <span class="var">?ri</span> <span class="skolem">g'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> g <span class="keyword1"><span class="command">using</span></span> b <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> dvd_smult_cancel<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> kf kg <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">kf</span></span> <span class="skolem"><span class="skolem">kg</span></span> <span class="keyword2"><span class="keyword">where</span></span> kf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ri</span> <span class="skolem">f'</span> <span class="main">=</span> <span class="skolem">k</span> <span class="main">*</span> <span class="skolem">kf</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> kg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ri</span> <span class="skolem">g'</span> <span class="main">=</span> <span class="skolem">k</span> <span class="main">*</span> <span class="skolem">kg</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>    
    <span class="keyword1"><span class="command">from</span></span> rat_to_int_factor_explicit<span class="main">[</span><span class="operator">OF</span> kf kck<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> kf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="keyword1">dvd</span> <span class="skolem">f'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> rat_to_int_factor_explicit<span class="main">[</span><span class="operator">OF</span> kg kck<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> kg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="keyword1">dvd</span> <span class="skolem">g'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> kf kg <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="keyword1">dvd</span> <span class="skolem">h</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> h_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ri</span> <span class="skolem">k'</span> <span class="keyword1">dvd</span> <span class="var">?ri</span> <span class="skolem">h</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">hom_distribs</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="keyword1">dvd</span> <span class="var">?ri</span> <span class="skolem">h</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> k <span class="keyword1"><span class="command">using</span></span> c <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> smult_dvd<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="keyword1">dvd</span> <span class="var">?gcd</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> dvd_smult<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gcd_rat_poly_unfold<span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"gcd <span class="main">=</span> gcd_rat_poly"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Rational_Factorization">
<div class="head">
<h1>Theory Rational_Factorization</h1>
</div>
<pre class="source"><span class="comment1">(*  
    Author:      René Thiemann 
                 Akihisa Yamada
    License:     BSD
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Rational Factorization›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We combine the rational root test, the
  formulas for explicit roots, and the Kronecker's factorization algorithm to provide a
  basic factorization algorithm for polynomial over rational numbers. Moreover, also the roots
  of a rational polynomial can be determined.›</span></span>
  
<span class="keyword1"><span class="command">theory</span></span> Rational_Factorization
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Explicit_Roots.html">Explicit_Roots</a>
  <a href="Kronecker_Factorization.html">Kronecker_Factorization</a>
  <a href="Square_Free_Factorization.html">Square_Free_Factorization</a>
  <a href="Rational_Root_Test.html">Rational_Root_Test</a>
  <a href="Gcd_Rat_Poly.html">Gcd_Rat_Poly</a>
  <a href="../Show/Show_Poly.html">Show.Show_Poly</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">roots_of_rat_poly_main</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat poly <span class="main">⇒</span> rat list"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">roots_of_rat_poly_main</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">n</span> <span class="main">=</span> degree <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">[]</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">[</span>roots1 <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">]</span>
  <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">=</span> <span class="numeral">2</span> <span class="keyword1">then</span> rat_roots2 <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">else</span> 
  <span class="keyword1">case</span> rational_root_test <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">[]</span> <span class="main">|</span> Some <span class="bound">x</span> <span class="main">⇒</span> <span class="bound">x</span> <span class="main">#</span> <span class="free">roots_of_rat_poly_main</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">div</span> <span class="main">[:</span><span class="main">-</span><span class="bound">x</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure degree"</span></span><span class="main"><span class="keyword3">,</span></span> 
  <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> rational_root_test<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> degree_div_less <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> poly_eq_0_iff_dvd<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> roots_of_rat_poly_main_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"roots_of_rat_poly_main <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">n</span> <span class="main">=</span> degree <span class="free">p</span> <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">[]</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">[</span>roots1 <span class="free">p</span><span class="main">]</span>
  <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">=</span> <span class="numeral">2</span> <span class="keyword1">then</span> rat_roots2 <span class="free">p</span> <span class="keyword1">else</span> 
  <span class="keyword1">case</span> rational_root_test <span class="free">p</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">[]</span> <span class="main">|</span> Some <span class="bound">x</span> <span class="main">⇒</span> <span class="bound">x</span> <span class="main">#</span> roots_of_rat_poly_main <span class="main">(</span><span class="free">p</span> <span class="keyword1">div</span> <span class="main">[:</span><span class="main">-</span><span class="bound">x</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> d <span class="main">=</span> roots_of_rat_poly_main.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> Let_def
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"rational_root_test <span class="free">p</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">[:</span><span class="main">-</span><span class="skolem">x</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> rational_root_test<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Some<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="keyword1">dvd</span> <span class="free">p</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> poly_eq_0_iff_dvd<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> dvd_mult_div_cancel<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> pp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">div</span> <span class="var">?x</span> <span class="main">=</span> <span class="var">?x</span> <span class="main">*</span> <span class="main">(</span><span class="free">p</span> <span class="keyword1">div</span> <span class="var">?x</span><span class="main">)</span> <span class="keyword1">div</span> <span class="var">?x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> d Some <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> d<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> roots_of_rat_poly_main<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> set <span class="main">(</span>roots_of_rat_poly_main <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> roots_of_rat_poly_main.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> 1<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> p <span class="main">=</span> 1<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">p</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"roots_of_rat_poly_main"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">from</span></span> roots0<span class="main">[</span><span class="operator">OF</span> p True<span class="main">]</span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> 0 <span class="main">=</span> this
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?n</span> <span class="main">=</span> <span class="main">1</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">from</span></span> roots1<span class="main">[</span><span class="operator">OF</span> True<span class="main">]</span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> 1 <span class="main">=</span> this
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?n</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">from</span></span> rat_roots2<span class="main">[</span><span class="operator">OF</span> True<span class="main">]</span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> 2 <span class="main">=</span> this
        <span class="keyword1"><span class="command">from</span></span> 0 1 2 <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?rr</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> rational_root_test <span class="skolem">p</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">[]</span> <span class="main">|</span> Some <span class="bound">x</span> <span class="main">⇒</span> 
          <span class="bound">x</span> <span class="main">#</span> <span class="var">?rr</span> <span class="main">(</span><span class="skolem">p</span> <span class="keyword1">div</span> <span class="main">[:</span> <span class="main">-</span><span class="bound">x</span><span class="main">,</span> <span class="main">1</span> <span class="main">:]</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"rational_root_test <span class="skolem">p</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> None
          <span class="keyword1"><span class="command">from</span></span> rational_root_test<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> None<span class="main">]</span> None id <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">x</span><span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> rational_root_test<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Some<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[:</span> <span class="main">-</span><span class="skolem">x</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="keyword1">dvd</span> <span class="skolem">p</span>"</span></span>         
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> poly_eq_0_iff_dvd<span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> dvd_mult_div_cancel<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
          <span class="keyword1"><span class="command">have</span></span> pp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="main">[:</span> <span class="main">-</span><span class="skolem">x</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">p</span> <span class="keyword1">div</span> <span class="main">[:</span> <span class="main">-</span><span class="skolem">x</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">with</span></span> p <span class="keyword1"><span class="command">have</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">div</span> <span class="main">[:</span><span class="main">-</span> <span class="skolem">x</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> pp<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="bound">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span><span class="main">]</span>
             rational_root_test<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Some<span class="main">]</span> IH<span class="main">[</span><span class="operator">OF</span> refl 0 1 2 Some p<span class="main">]</span>  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> id Some <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">declare</span></span> roots_of_rat_poly_main.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">roots_of_rat_poly</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat poly <span class="main">⇒</span> rat list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">roots_of_rat_poly</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">pis</span><span class="main">)</span> <span class="main">=</span> yun_factorization gcd_rat_poly <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">in</span>
    concat <span class="main">(</span>map <span class="main">(</span>roots_of_rat_poly_main <span class="keyword1">o</span> fst<span class="main">)</span> <span class="bound">pis</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> roots_of_rat_poly<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>roots_of_rat_poly <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="skolem"><span class="skolem">pis</span></span> <span class="keyword2"><span class="keyword">where</span></span> yun<span class="main">:</span> <span class="quoted"><span class="quoted">"yun_factorization gcd <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">c</span><span class="main">,</span><span class="skolem">pis</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> yun
  <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"roots_of_rat_poly <span class="free">p</span> <span class="main">=</span> concat <span class="main">(</span>map <span class="main">(</span>roots_of_rat_poly_main <span class="main">∘</span> fst<span class="main">)</span> <span class="skolem">pis</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> roots_of_rat_poly_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> yun <span class="main">=</span> square_free_factorizationD<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> yun_factorization<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span><span class="operator"><span class="operator"><span class="operator">OF</span></span></span> yun<span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> yun<span class="main">(</span>1<span class="main">)</span> p <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> yun<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> smult <span class="skolem">c</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span>set <span class="skolem">pis</span><span class="main">.</span> <span class="bound">a</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">∈</span>set <span class="skolem">pis</span><span class="main">.</span> <span class="bound">a</span> <span class="main">^</span> Suc <span class="bound">i</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> p <span class="keyword1"><span class="command">using</span></span> c <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="bound">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> fst <span class="main">`</span> set <span class="skolem">pis</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> poly_prod_0<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span> <span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">pis</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>roots_of_rat_poly_main <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="skolem">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> roots_of_rat_poly_main<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> yun<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> p<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> main <span class="main">=</span> this
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>roots_of_rat_poly <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">.</span> set <span class="main">(</span>roots_of_rat_poly_main <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> set <span class="skolem">pis</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> res o_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> main <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> r <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">root_free</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> comm_semiring_0 poly <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">root_free</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span>degree <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> poly <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> irreducible_root_free<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> idom poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"irreducible <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"root_free <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> p0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"poly <span class="free">p</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> degp<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">≠</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[:</span><span class="main">-</span><span class="skolem">x</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span> <span class="keyword1">dvd</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> poly_eq_0_iff_dvd <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">[:</span><span class="main">-</span><span class="skolem">x</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span> <span class="main">*</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> dvdE<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> p0 <span class="keyword1"><span class="command">have</span></span> q0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> irreducibleD<span class="main">[</span><span class="operator">OF</span> assms p<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="keyword1">dvd</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> one_neq_zero poly_1 poly_eq_0_iff_dvd<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">q</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> poly_dvd_1<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> degree_mult_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[:</span><span class="main">-</span><span class="skolem">x</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span>"</span></span> <span class="quoted"><span class="skolem">q</span></span><span class="main">,</span> <span class="operator">folded</span> p<span class="main">]</span> q0 degp
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> root_free_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>tailrec<span class="main">)</span> <span class="entity">factorize_root_free_main</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat poly <span class="main">⇒</span> rat list <span class="main">⇒</span> rat poly list <span class="main">⇒</span> rat <span class="main">×</span> rat poly list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">factorize_root_free_main</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">of</span> Nil <span class="main">⇒</span> 
     <span class="keyword1">let</span> <span class="bound">l</span> <span class="main">=</span> coeff <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span>degree <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">;</span> <span class="bound">q</span> <span class="main">=</span> smult <span class="main">(</span>inverse <span class="bound">l</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">in</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">q</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span> <span class="keyword1">else</span> <span class="bound">q</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span> <span class="main">)</span>
  <span class="main">|</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">xs</span> <span class="main">⇒</span> 
    <span class="keyword1">if</span> poly <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="free">factorize_root_free_main</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">div</span> <span class="main">[:</span><span class="main">-</span><span class="bound">x</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span><span class="main">)</span> <span class="main">(</span><span class="bound">x</span> <span class="main">#</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">(</span><span class="main">[:</span><span class="main">-</span><span class="bound">x</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="free">factorize_root_free_main</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">xs</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">factorize_root_free</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat poly <span class="main">⇒</span> rat <span class="main">×</span> rat poly list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">factorize_root_free</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> degree <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">(</span>coeff <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">0</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span> <span class="keyword1">else</span>
     factorize_root_free_main <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span>roots_of_rat_poly <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">[]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> factorize_root_free_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"factorize_root_free <span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> factorize_root_free_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> factorize_root_free<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"factorize_root_free <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">qs</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> smult <span class="free">c</span> <span class="main">(</span>prod_list <span class="free">qs</span><span class="main">)</span>"</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> set <span class="free">qs</span> <span class="main">⟹</span> root_free <span class="bound">q</span> <span class="main">∧</span> monic <span class="bound">q</span> <span class="main">∧</span> degree <span class="bound">q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> smult <span class="free">c</span> <span class="main">(</span>prod_list <span class="free">qs</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">q</span> <span class="main">∈</span> set <span class="free">qs</span><span class="main">.</span> root_free <span class="bound">q</span> <span class="main">∧</span> monic <span class="bound">q</span> <span class="main">∧</span> degree <span class="bound">q</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> res <span class="keyword1"><span class="command">unfolding</span></span> factorize_root_free_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> degree0_coeffs<span class="main">)</span> 
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> p0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">fs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">fs</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span> <span class="main">::</span> rat poly list<span class="main">)</span>"</span></span> 
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> roots_of_rat_poly <span class="free">p</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span>  <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> degree <span class="skolem">q</span> <span class="main">+</span> length <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">have</span></span> prod<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="skolem">q</span> <span class="main">*</span> prod_list <span class="skolem">fs</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> q_def fs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="skolem">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">⊆</span> set <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> roots_of_rat_poly<span class="main">[</span><span class="operator">OF</span> p0<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> q_def xs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> fs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> set <span class="skolem">fs</span> <span class="main">⟹</span> root_free <span class="bound">q</span> <span class="main">∧</span> monic <span class="bound">q</span> <span class="main">∧</span> degree <span class="bound">q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> fs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"factorize_root_free_main <span class="skolem">q</span> <span class="skolem">xs</span> <span class="skolem">fs</span> <span class="main">=</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">qs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> res False 
      <span class="keyword1"><span class="command">unfolding</span></span> xs_def fs_def q_def factorize_root_free_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> q_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> prod sub fs res n this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">q</span></span> <span class="quoted"><span class="skolem">fs</span></span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> wf_induct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf_less<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">n</span> <span class="skolem">q</span> <span class="skolem">fs</span> <span class="skolem">xs</span><span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> simp <span class="main">=</span> factorize_root_free_main.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">q</span></span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quoted"><span class="skolem">fs</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> 1<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span>
      <span class="keyword1"><span class="command">note</span></span> 0 <span class="main">=</span> 1<span class="main">(</span>2-<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> simp<span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> Nil
        <span class="keyword1"><span class="command">note</span></span> 0 <span class="main">=</span> 0<span class="main">[</span><span class="operator">unfolded</span> Nil Let_def<span class="main">]</span>
        <span class="keyword1"><span class="command">hence</span></span> no_rt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> poly <span class="skolem">q</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"smult <span class="main">(</span>inverse <span class="free">c</span><span class="main">)</span> <span class="skolem">q</span>"</span></span>
        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="var">?r</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> 0<span class="main">(</span>4-5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> coeff <span class="skolem">q</span> <span class="main">(</span>degree <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> qs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">qs</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="skolem">fs</span> <span class="keyword1">else</span> <span class="skolem">r</span> <span class="main">#</span> <span class="skolem">fs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> r_def<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> q c qs 0<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> c0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> smult <span class="free">c</span> <span class="main">(</span>prod_list <span class="main">(</span><span class="skolem">r</span> <span class="main">#</span> <span class="skolem">fs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> r_def<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> p <span class="keyword1"><span class="command">have</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> smult <span class="free">c</span> <span class="main">(</span>prod_list <span class="free">qs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> qs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
        <span class="keyword1"><span class="command">from</span></span> 0<span class="main">(</span>2<span class="main">,</span>5<span class="main">)</span> c0 c <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"root_free <span class="var">?r</span>"</span></span> <span class="quoted"><span class="quoted">"monic <span class="var">?r</span>"</span></span> 
          <span class="keyword1"><span class="command">unfolding</span></span> root_free_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> 0<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> set <span class="free">qs</span> <span class="main">⟹</span> root_free <span class="bound">q</span> <span class="main">∧</span> monic <span class="bound">q</span> <span class="main">∧</span> degree <span class="bound">q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> qs 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">q</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> degree0_coeffs<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">q</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> r_def<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> p <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
        <span class="keyword1"><span class="command">note</span></span> 0 <span class="main">=</span> 0<span class="main">[</span><span class="operator">unfolded</span> Cons<span class="main">]</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"poly <span class="skolem">q</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="keyword1">div</span> <span class="main">[:</span><span class="main">-</span><span class="skolem">x</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span>"</span></span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">[:</span><span class="main">-</span><span class="skolem">x</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span>"</span></span> 
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?fs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">#</span> <span class="skolem">fs</span>"</span></span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span>"</span></span>
          <span class="keyword1"><span class="command">from</span></span> True <span class="keyword1"><span class="command">have</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> <span class="var">?q</span> <span class="main">*</span> <span class="var">?x</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dvd_mult_div_cancel mult.commute poly_eq_0_iff_dvd<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> 0<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> q'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> deg<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">q</span> <span class="main">=</span> Suc <span class="main">(</span>degree <span class="var">?q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> q<span class="main">,</span> <span class="operator">of</span> <span class="quoted">degree</span><span class="main">]</span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> degree_mult_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> q'<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="var">?q</span> <span class="main">+</span> length <span class="var">?xs</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 0<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> q<span class="main">,</span> <span class="operator">of</span> <span class="quoted">poly</span><span class="main">]</span> 0<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> rt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="var">?q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">⊆</span> set <span class="var">?xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="var">?q</span> <span class="main">*</span> prod_list <span class="var">?fs</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> prod_list.Cons 0<span class="main">(</span>1<span class="main">)</span> mult.assoc<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> q<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"root_free <span class="var">?x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> root_free_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> 0<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> rf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> set <span class="var">?fs</span> <span class="main">⟹</span> root_free <span class="bound">f</span> <span class="main">∧</span> monic <span class="bound">f</span> <span class="main">∧</span> degree <span class="bound">f</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> True 0<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"factorize_root_free_main <span class="var">?q</span> <span class="var">?xs</span> <span class="var">?fs</span> <span class="main">=</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">qs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> IH<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ p rt rf res refl q'<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> n<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">with</span></span> 0<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"factorize_root_free_main <span class="skolem">q</span> <span class="skolem">xs</span> <span class="skolem">fs</span> <span class="main">=</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">qs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">from</span></span> 0<span class="main">(</span>5<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> degree <span class="skolem">q</span> <span class="main">+</span> length <span class="skolem">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> Suc <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> False 0<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> rt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="skolem">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">⊆</span> set <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> IH<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ 0<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> rt 0<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> res m 0<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> n<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> smult <span class="free">c</span> <span class="main">(</span>prod_list <span class="free">qs</span><span class="main">)</span>"</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> set <span class="free">qs</span> <span class="main">⟹</span> root_free <span class="bound">q</span> <span class="main">∧</span> monic <span class="bound">q</span> <span class="main">∧</span> degree <span class="bound">q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rational_proper_factor</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat poly <span class="main">⇒</span> rat poly option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rational_proper_factor</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> degree <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≤</span> <span class="main">1</span> <span class="keyword1">then</span> None
    <span class="keyword1">else</span> <span class="keyword1">if</span> degree <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="numeral">2</span> <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">case</span> rat_roots2 <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">of</span> Nil <span class="main">⇒</span> None <span class="main">|</span> Cons <span class="bound">x</span> <span class="bound">xs</span> <span class="main">⇒</span> Some <span class="main">[:</span><span class="main">-</span><span class="bound">x</span><span class="main">,</span><span class="main">1</span> <span class="main">:]</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> degree <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="numeral">3</span> <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">case</span> rational_root_test <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> None <span class="main">|</span> Some <span class="bound">x</span> <span class="main">⇒</span> Some <span class="main">[:</span><span class="main">-</span><span class="bound">x</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span><span class="main">)</span>
    <span class="keyword1">else</span> kronecker_factorization_rat <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> degree_1_dvd_root<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span><span class="free">q</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> field poly<span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> rt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">q</span> <span class="keyword1">dvd</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> degree1_coeffs<span class="main">[</span><span class="operator">OF</span> q<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="main">[:</span> <span class="skolem">b</span><span class="main">,</span> <span class="skolem">a</span> <span class="main">:]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> smult <span class="skolem">a</span> <span class="main">[:</span> <span class="main">-</span> <span class="main">(</span><span class="main">-</span> <span class="skolem">b</span> <span class="main">/</span> <span class="skolem">a</span><span class="main">)</span><span class="main">,</span> <span class="main">1</span> <span class="main">:]</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> q 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> poly_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> coeff_smult<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> a<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> coeff_pCons
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> q smult_dvd_iff poly_eq_0_iff_dvd<span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> a rt <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>




<span class="keyword1"><span class="command">lemma</span></span> rational_proper_factor<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> rational_proper_factor <span class="free">p</span> <span class="main">=</span> None <span class="main">⟹</span> irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="free">p</span>"</span></span> 
  <span class="quoted"><span class="quoted">"rational_proper_factor <span class="free">p</span> <span class="main">=</span> Some <span class="free">q</span> <span class="main">⟹</span> <span class="free">q</span> <span class="keyword1">dvd</span> <span class="free">p</span> <span class="main">∧</span> degree <span class="free">q</span> <span class="main">≥</span> <span class="main">1</span> <span class="main">∧</span> degree <span class="free">q</span> <span class="main">&lt;</span> degree <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rp</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rational_proper_factor <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rational_root_test"</span></span>
  <span class="keyword1"><span class="command">note</span></span> d <span class="main">=</span> rational_proper_factor_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>degree <span class="free">p</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟶</span> <span class="var">?rp</span> <span class="main">=</span> None <span class="main">⟶</span> irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="free">p</span><span class="main">)</span> <span class="main">∧</span> 
        <span class="main">(</span><span class="var">?rp</span> <span class="main">=</span> Some <span class="free">q</span> <span class="main">⟶</span> <span class="free">q</span> <span class="keyword1">dvd</span> <span class="free">p</span> <span class="main">∧</span> degree <span class="free">q</span> <span class="main">≥</span> <span class="main">1</span> <span class="main">∧</span> degree <span class="free">q</span> <span class="main">&lt;</span> degree <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> d <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> 0 <span class="main">=</span> this
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">=</span> <span class="main">1</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rp</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> d <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> linear_irreducible<span class="hidden">⇩</span><sub>d</sub><span class="main">[</span><span class="operator">OF</span> True<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> 1 <span class="main">=</span> this
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">hence</span></span> rp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?rp</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> rat_roots2 <span class="free">p</span> <span class="keyword1">of</span> Nil <span class="main">⇒</span> None <span class="main">|</span> Cons <span class="bound">x</span> <span class="bound">xs</span> <span class="main">⇒</span> Some <span class="main">[:</span><span class="main">-</span><span class="bound">x</span><span class="main">,</span><span class="main">1</span> <span class="main">:]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> d <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"rat_roots2 <span class="free">p</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> Nil
          <span class="keyword1"><span class="command">with</span></span> rp <span class="keyword1"><span class="command">have</span></span> rp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?rp</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> Nil rat_roots2<span class="main">[</span><span class="operator">OF</span> True<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> nex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="free">p</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> irreducible<span class="hidden">⇩</span><sub>d</sub>I<span class="main">)</span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span> <span class="skolem">r</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat poly"</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">q</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">q</span> <span class="main">&lt;</span> degree <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="skolem">q</span> <span class="main">*</span> <span class="skolem">r</span>"</span></span>
            <span class="keyword1"><span class="command">with</span></span> True <span class="keyword1"><span class="command">have</span></span> dq<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">q</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">q</span> <span class="keyword1">dvd</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> degree_1_dvd_root<span class="main"><span class="main">[</span></span><span class="operator">OF</span> dq<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> nex<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
            <span class="keyword1"><span class="command">with</span></span> p <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> True<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> rp <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> Cons rat_roots2<span class="main">[</span><span class="operator">OF</span> True<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"poly <span class="free">p</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> poly_eq_0_iff_dvd<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[:</span> <span class="main">-</span><span class="skolem">x</span> <span class="main">,</span> <span class="main">1</span> <span class="main">:]</span> <span class="keyword1">dvd</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> Cons rp <span class="keyword1"><span class="command">have</span></span> rp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?rp</span> <span class="main">=</span> Some <span class="main">(</span><span class="main">[:</span> <span class="main">-</span> <span class="skolem">x</span><span class="main">,</span> <span class="main">1</span> <span class="main">:]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> True x <span class="keyword1"><span class="command">unfolding</span></span> rp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> 2 <span class="main">=</span> this
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">=</span> <span class="numeral">3</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">hence</span></span> rp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?rp</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="var">?rr</span> <span class="free">p</span> <span class="keyword1">of</span> None <span class="main">⇒</span> None <span class="main">|</span> Some <span class="bound">x</span> <span class="main">⇒</span> Some <span class="main">[:</span><span class="main">-</span> <span class="bound">x</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> d <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?rr</span> <span class="free">p</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> None
            <span class="keyword1"><span class="command">from</span></span> rational_root_test<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> None<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> nex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">from</span></span> rp<span class="main">[</span><span class="operator">unfolded</span> None<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> rp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?rp</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="free">p</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> irreducible<span class="hidden">⇩</span><sub>d</sub>I2<span class="main">)</span>
              <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat poly"</span></span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">q</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">q</span> <span class="main">≤</span> degree <span class="free">p</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
              <span class="keyword1"><span class="command">with</span></span> True <span class="keyword1"><span class="command">have</span></span> dq<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">q</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">q</span> <span class="keyword1">dvd</span> <span class="free">p</span>"</span></span> 
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> degree_1_dvd_root<span class="main"><span class="main">[</span></span><span class="operator">OF</span> dq<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> nex<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
            <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> True<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
            <span class="keyword1"><span class="command">with</span></span> rp <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">x</span><span class="main">)</span>
            <span class="keyword1"><span class="command">from</span></span> rational_root_test<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Some<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"poly <span class="free">p</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
            <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> poly_eq_0_iff_dvd<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[:</span> <span class="main">-</span><span class="skolem">x</span> <span class="main">,</span> <span class="main">1</span> <span class="main">:]</span> <span class="keyword1">dvd</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">from</span></span> Some rp <span class="keyword1"><span class="command">have</span></span> rp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?rp</span> <span class="main">=</span> Some <span class="main">(</span><span class="main">[:</span> <span class="main">-</span> <span class="skolem">x</span><span class="main">,</span> <span class="main">1</span> <span class="main">:]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> True x <span class="keyword1"><span class="command">unfolding</span></span> rp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> 3 <span class="main">=</span> this
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?kp</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"kronecker_factorization_rat <span class="free">p</span>"</span></span>
          <span class="keyword1"><span class="command">from</span></span> 0 1 2 3 <span class="keyword1"><span class="command">have</span></span> d4<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">≥</span> <span class="numeral">4</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> d1<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">hence</span></span> rp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?rp</span> <span class="main">=</span> <span class="var">?kp</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> d4 d <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?kp</span></span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> None
            <span class="keyword1"><span class="command">with</span></span> rp kronecker_factorization_rat<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> None d1<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">q</span><span class="main">)</span>
            <span class="keyword1"><span class="command">with</span></span> rp kronecker_factorization_rat<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Some<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> rational_proper_factor <span class="free">p</span> <span class="main">=</span> None <span class="main">⟹</span> irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="free">p</span>"</span></span> 
    <span class="quoted"><span class="quoted">"rational_proper_factor <span class="free">p</span> <span class="main">=</span> Some <span class="free">q</span> <span class="main">⟹</span> <span class="free">q</span> <span class="keyword1">dvd</span> <span class="free">p</span> <span class="main">∧</span> degree <span class="free">q</span> <span class="main">≥</span> <span class="main">1</span> <span class="main">∧</span> degree <span class="free">q</span> <span class="main">&lt;</span> degree <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">factorize_rat_poly_main</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat <span class="main">⇒</span> rat poly list <span class="main">⇒</span> rat poly list <span class="main">⇒</span> rat <span class="main">×</span> rat poly list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">factorize_rat_poly_main</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">irr</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">irr</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">factorize_rat_poly_main</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">irr</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> degree <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">0</span> 
    <span class="keyword1">then</span> <span class="free">factorize_rat_poly_main</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">*</span> coeff <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">0</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">irr</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> 
    <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">case</span> rational_proper_factor <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">of</span> 
      None <span class="main">⇒</span> <span class="free">factorize_rat_poly_main</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">irr</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span>
    <span class="main">|</span> Some <span class="bound">q</span> <span class="main">⇒</span> <span class="free">factorize_rat_poly_main</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">irr</span></span></span> <span class="main">(</span><span class="bound">q</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">div</span> <span class="bound">q</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">factorize_rat_poly_main_wf_rel</span> <span class="main">=</span> inv_image <span class="main">(</span>mult1 <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="bound">irr</span><span class="main">,</span> <span class="bound">ps</span><span class="main">)</span><span class="main">.</span> mset <span class="main">(</span>map degree <span class="bound">ps</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wf_factorize_rat_poly_main_wf_rel<span class="main">:</span> <span class="quoted"><span class="quoted">"wf factorize_rat_poly_main_wf_rel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> factorize_rat_poly_main_wf_rel_def <span class="keyword1"><span class="command">using</span></span> wf_mult1<span class="main">[</span><span class="operator">OF</span> wf_less<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> factorize_rat_poly_main_wf_rel_sub<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">,</span> <span class="free">ps</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="free">d</span><span class="main">,</span> <span class="free">p</span> <span class="main">#</span> <span class="free">ps</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> factorize_rat_poly_main_wf_rel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> factorize_rat_poly_main_wf_rel_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> mult1I <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> factorize_rat_poly_main_wf_rel_two<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">q</span> <span class="main">&lt;</span> degree <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">r</span> <span class="main">&lt;</span> degree <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">,</span><span class="free">q</span> <span class="main">#</span> <span class="free">r</span> <span class="main">#</span> <span class="free">ps</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">d</span><span class="main">,</span><span class="free">p</span> <span class="main">#</span> <span class="free">ps</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> factorize_rat_poly_main_wf_rel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> factorize_rat_poly_main_wf_rel_def mult1_def
  <span class="keyword1"><span class="command">using</span></span> add_eq_conv_ex assms ab_semigroup_add_class.add_ac
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">termination</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted">factorize_rat_poly_main_wf_rel</span><span class="main"><span class="keyword3">,</span></span>
  <span class="operator">rule</span> wf_factorize_rat_poly_main_wf_rel<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> factorize_rat_poly_main_wf_rel_sub<span class="main"><span class="keyword3">,</span></span> 
  <span class="operator">rule</span> factorize_rat_poly_main_wf_rel_sub<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> factorize_rat_poly_main_wf_rel_two<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">q</span>
  <span class="keyword3"><span class="command">assume</span></span> rf<span class="main">:</span> <span class="quoted"><span class="quoted">"rational_proper_factor <span class="skolem">p</span> <span class="main">=</span> Some <span class="skolem">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dp<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> rational_proper_factor<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> rf<span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="keyword1">dvd</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> deg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> degree <span class="skolem">q</span>"</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">q</span> <span class="main">&lt;</span> degree <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">q</span> <span class="main">&lt;</span> degree <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">from</span></span> dvd <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="skolem">q</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">p</span> <span class="keyword1">div</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted">degree</span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">p</span> <span class="main">=</span> degree <span class="skolem">q</span> <span class="main">+</span> degree <span class="main">(</span><span class="skolem">p</span> <span class="keyword1">div</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> degree_mult_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> dp<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> deg
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span><span class="skolem">p</span> <span class="keyword1">div</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">&lt;</span> degree <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1"><span class="command">declare</span></span> factorize_rat_poly_main.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword">del</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> factorize_rat_poly_main<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"factorize_rat_poly_main <span class="free">c</span> <span class="free">irr</span> <span class="free">ps</span> <span class="main">=</span> <span class="main">(</span><span class="free">d</span><span class="main">,</span><span class="free">qs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Ball <span class="main">(</span>set <span class="free">irr</span><span class="main">)</span> irreducible<span class="hidden">⇩</span><sub>d</sub>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Ball <span class="main">(</span>set <span class="free">qs</span><span class="main">)</span> irreducible<span class="hidden">⇩</span><sub>d</sub>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?g1</span></span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"smult <span class="free">c</span> <span class="main">(</span>prod_list <span class="main">(</span><span class="free">irr</span> <span class="main">@</span> <span class="free">ps</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> smult <span class="free">d</span> <span class="main">(</span>prod_list <span class="free">qs</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?g2</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize</span><span class="main"><span class="main">(</span></span><span class="quasi_keyword">full</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">irr</span></span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> factorize_rat_poly_main.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">c</span> <span class="skolem">irr</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> factorize_rat_poly_main.simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">c</span> <span class="skolem">irr</span> <span class="skolem">p</span> <span class="skolem">ps</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> 2<span class="main">(</span>1-3<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> 2<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> factorize_rat_poly_main.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">c</span></span> <span class="quoted"><span class="skolem">irr</span></span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">ps</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> irr <span class="main">=</span> 2<span class="main">(</span>5<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted">factorize_rat_poly_main</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> res <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">(</span><span class="skolem">c</span> <span class="main">*</span> coeff <span class="skolem">p</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">irr</span> <span class="skolem">ps</span> <span class="main">=</span> <span class="main">(</span><span class="free">d</span><span class="main">,</span><span class="free">qs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> degree0_coeffs<span class="main">[</span><span class="operator">OF</span> True<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="main">[:</span> <span class="skolem">a</span> <span class="main">:]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> True res irr<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> IH<span class="main">(</span>2-<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> False<span class="main">]</span>
    <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>degree <span class="skolem">p</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> res<span class="main">[</span><span class="operator">unfolded</span> this if_False<span class="main">]</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rf</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rational_proper_factor <span class="skolem">p</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?rf</span></span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> None
      <span class="keyword1"><span class="command">with</span></span> res <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="skolem">c</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">irr</span><span class="main">)</span> <span class="skolem">ps</span> <span class="main">=</span> <span class="main">(</span><span class="free">d</span><span class="main">,</span><span class="free">qs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> rational_proper_factor<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ None<span class="main">]</span> False
      <span class="keyword1"><span class="command">have</span></span> irp<span class="main">:</span> <span class="quoted"><span class="quoted">"irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">note</span></span> IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> None res<span class="main">,</span> <span class="operator">unfolded</span> atomize_imp imp_conjR<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
      <span class="keyword1"><span class="command">note</span></span> 1 <span class="main">=</span> conjunct1<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span> conjunct2<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>
      <span class="keyword1"><span class="command">from</span></span> irr irp <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>1 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">q</span><span class="main">)</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">pq</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pq</span> <span class="main">=</span> <span class="skolem">p</span> <span class="keyword1">div</span> <span class="skolem">q</span>"</span></span> 
      <span class="keyword1"><span class="command">from</span></span> Some res <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="skolem">c</span> <span class="skolem">irr</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">#</span> <span class="skolem">pq</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">d</span><span class="main">,</span><span class="free">qs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> pq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> rational_proper_factor<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Some<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="keyword1">dvd</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="skolem">q</span> <span class="main">*</span> <span class="skolem">pq</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> pq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Some<span class="main">,</span> <span class="operator">folded</span> pq_def<span class="main">,</span> <span class="operator">OF</span> res irr<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> p 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">factorize_rat_poly_basic</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> factorize_rat_poly_main <span class="main">1</span> <span class="main">[]</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">]</span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> factorize_rat_poly_basic<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"factorize_rat_poly_basic <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">qs</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> smult <span class="free">c</span> <span class="main">(</span>prod_list <span class="free">qs</span><span class="main">)</span>"</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> set <span class="free">qs</span> <span class="main">⟹</span> irreducible<span class="hidden">⇩</span><sub>d</sub> <span class="bound">q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> factorize_rat_poly_main<span class="main">[</span><span class="operator">OF</span> res<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">unfolded</span></span> factorize_rat_poly_basic_def<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We removed the factorize-rat-poly function from this theory, since the one in 
  Berlekamp-Zassenhaus is easier to use and implements a more efficient algorithm.›</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>