<div id="Lucas_Lehmer_Auxiliary">
<div class="head">
<h1>Theory Lucas_Lehmer_Auxiliary</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary material›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Lucas_Lehmer_Auxiliary
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../../HOL/HOL-Algebra/Ring.html">HOL-Algebra.Ring</a>"</span>
  <span class="quoted">"<a href="../Probabilistic_Prime_Tests/Jacobi_Symbol.html">Probabilistic_Prime_Tests.Jacobi_Symbol</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* TODO: Much of this belongs in the library *)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary  number-theoretic material›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> congD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">=</span> <span class="free">b</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">a</span> <span class="keyword1">mod</span> <span class="free">n</span> <span class="main">=</span> <span class="free">b</span> <span class="keyword1">mod</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eval_coprime<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> euclidean_semiring_gcd<span class="main">)</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> coprime <span class="free">a</span> <span class="free">b</span> <span class="main">⟷</span> coprime <span class="free">b</span> <span class="main">(</span><span class="free">a</span> <span class="keyword1">mod</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> coprime_commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> two_power_odd_mod_12<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"odd <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span> <span class="main">=</span> <span class="numeral">8</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="main">(</span><span class="numeral">12</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="numeral">3</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> less.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&gt;</span> <span class="numeral">3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> oddE<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">8</span> <span class="main">*</span> <span class="numeral">4</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="numeral">12</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> power_add <span class="keyword1"><span class="command">using</span></span> less.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cong_mult less<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">&gt;</span> <span class="numeral">3</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Legendre_3_right<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&gt;</span> <span class="numeral">3</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">12</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span> <span class="numeral">5</span><span class="main">,</span> <span class="numeral">7</span><span class="main">,</span> <span class="numeral">11</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Legendre <span class="free">p</span> <span class="numeral">3</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">12</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span> <span class="numeral">7</span><span class="main">}</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">p</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p prime_nat_not_dvd<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="numeral">2</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> prime_imp_coprime<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dvd_imp_le<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">p</span> <span class="numeral">3</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> prime_imp_coprime<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">p</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">*</span> <span class="numeral">3</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> coprime_mult_right_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"coprime <span class="numeral">12</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> coprime_commute<span class="main">)</span>
  
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">12</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">p</span></span><span class="main">∈</span><span class="main">{..</span><span class="numeral">11</span><span class="main">}</span><span class="main">.</span> coprime <span class="numeral">12</span> <span class="bound">p</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">p</span></span><span class="main">∈</span><span class="main">{..</span><span class="numeral">11</span><span class="main">}</span><span class="main">.</span> coprime <span class="numeral">12</span> <span class="bound">p</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">1</span><span class="main">::</span>nat<span class="main">,</span> <span class="numeral">5</span><span class="main">,</span> <span class="numeral">7</span><span class="main">,</span> <span class="numeral">11</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> atMost_nat_numeral pred_numeral_simps arith_simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> coprime_imp_gcd_eq_1 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_coprime<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">12</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span> <span class="numeral">5</span><span class="main">,</span> <span class="numeral">7</span><span class="main">,</span> <span class="numeral">11</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">12</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> <span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">12</span> <span class="main">=</span> <span class="numeral">5</span> <span class="main">∨</span> <span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">12</span> <span class="main">=</span> <span class="numeral">7</span> <span class="main">∨</span> <span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">12</span> <span class="main">=</span> <span class="numeral">11</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"Legendre <span class="free">p</span> <span class="numeral">3</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">12</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span> <span class="numeral">7</span><span class="main">}</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">12</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Legendre <span class="main">(</span>int <span class="free">p</span><span class="main">)</span> <span class="numeral">3</span> <span class="main">=</span> Legendre <span class="main">(</span>int <span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">3</span><span class="main">)</span> <span class="numeral">3</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Legendre_mod <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">12</span> <span class="main">=</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">12</span> <span class="keyword1">mod</span> <span class="numeral">3</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">3</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mod_mod_cancel<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"int <span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">3</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Legendre <span class="free">p</span> <span class="numeral">3</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">12</span> <span class="main">=</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">12</span> <span class="main">=</span> <span class="numeral">5</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Legendre <span class="main">(</span>int <span class="free">p</span><span class="main">)</span> <span class="numeral">3</span> <span class="main">=</span> Legendre <span class="main">(</span>int <span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">3</span><span class="main">)</span> <span class="numeral">3</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Legendre_mod <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">12</span> <span class="main">=</span> <span class="numeral">5</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">12</span> <span class="keyword1">mod</span> <span class="numeral">3</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">3</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mod_mod_cancel<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"int <span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">3</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Legendre <span class="free">p</span> <span class="numeral">3</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> supplement2_Legendre<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">12</span> <span class="main">=</span> <span class="numeral">5</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">12</span> <span class="main">=</span> <span class="numeral">7</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Legendre <span class="main">(</span>int <span class="free">p</span><span class="main">)</span> <span class="numeral">3</span> <span class="main">=</span> Legendre <span class="main">(</span>int <span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">3</span><span class="main">)</span> <span class="numeral">3</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Legendre_mod <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">12</span> <span class="main">=</span> <span class="numeral">7</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">12</span> <span class="keyword1">mod</span> <span class="numeral">3</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">3</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mod_mod_cancel<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"int <span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">3</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Legendre <span class="free">p</span> <span class="numeral">3</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">12</span> <span class="main">=</span> <span class="numeral">7</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">12</span> <span class="main">=</span> <span class="numeral">11</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Legendre <span class="main">(</span>int <span class="free">p</span><span class="main">)</span> <span class="numeral">3</span> <span class="main">=</span> Legendre <span class="main">(</span>int <span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">3</span><span class="main">)</span> <span class="numeral">3</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Legendre_mod <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">12</span> <span class="main">=</span> <span class="numeral">11</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">12</span> <span class="keyword1">mod</span> <span class="numeral">3</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">3</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mod_mod_cancel<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"int <span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">3</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Legendre <span class="free">p</span> <span class="numeral">3</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> supplement2_Legendre<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">12</span> <span class="main">=</span> <span class="numeral">11</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Legendre_3_left<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&gt;</span> <span class="numeral">3</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"Legendre <span class="numeral">3</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">12</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span> <span class="numeral">11</span><span class="main">}</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">12</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> <span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">12</span> <span class="main">=</span> <span class="numeral">5</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">12</span> <span class="keyword1">mod</span> <span class="numeral">4</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"even <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> even_mod_4_div_2<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mod_mod_cancel<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Quadratic_Reciprocity<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="numeral">3</span></span><span class="main">]</span> Legendre_3_right<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> assms True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">with</span></span> Legendre_3_right<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">12</span> <span class="main">=</span> <span class="numeral">7</span> <span class="main">∨</span> <span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">12</span> <span class="main">=</span> <span class="numeral">11</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">12</span> <span class="keyword1">mod</span> <span class="numeral">4</span> <span class="main">=</span> <span class="numeral">3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"odd <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> odd_mod_4_div_2<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mod_mod_cancel<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Quadratic_Reciprocity<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="numeral">3</span></span><span class="main">]</span> Legendre_3_right<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> assms * <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> supplement2_Legendre'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Legendre <span class="numeral">2</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">8</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> <span class="free">p</span> <span class="keyword1">mod</span> <span class="numeral">8</span> <span class="main">=</span> <span class="numeral">7</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&gt;</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prime_gt_1_int<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword2"><span class="keyword">and</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"odd <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prime_odd_int<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> supplement2_Jacobi'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> assms prime_odd_int<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prime_p_Jacobi_eq_Legendre<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1"><span class="command">lemma</span></span> little_Fermat_nat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">p</span> <span class="keyword1">dvd</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> <span class="free">a</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> Suc <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prime_gt_0_nat<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> totient <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> totient_prime<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">^</span> <span class="main">(</span>Suc <span class="main">…</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span> <span class="main">*</span> <span class="free">a</span> <span class="main">^</span> totient <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">…</span> <span class="main">=</span> <span class="free">a</span> <span class="main">*</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prime_imp_coprime<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cong_mult cong_refl euler_theorem<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> coprime_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> little_Fermat_int<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted">int</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">p</span> <span class="keyword1">dvd</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> <span class="free">a</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prime_gt_1_nat assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>int <span class="free">p</span> <span class="keyword1">dvd</span> <span class="free">a</span> <span class="keyword1">mod</span> int <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dvd_mod_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">mod</span> int <span class="free">p</span> <span class="main">=</span> int <span class="main">(</span>nat <span class="main">(</span><span class="free">a</span> <span class="keyword1">mod</span> int <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> not_dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">p</span> <span class="keyword1">dvd</span> nat <span class="main">(</span><span class="free">a</span> <span class="keyword1">mod</span> int <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> int_dvd_int_iff<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span> <span class="main">^</span> <span class="free">p</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cong_pow<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span> <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span>int <span class="main">(</span>nat <span class="main">(</span><span class="free">a</span> <span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">^</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> of_nat_nat<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> int <span class="main">(</span>nat <span class="main">(</span><span class="free">a</span> <span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span> <span class="main">^</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">…</span> <span class="main">=</span> int <span class="main">(</span>nat <span class="main">(</span><span class="free">a</span> <span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> cong_int_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> little_Fermat_nat<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> assms not_dvd <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"int <span class="main">(</span>nat <span class="main">(</span><span class="free">a</span> <span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span> <span class="keyword1">mod</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="keyword1">mod</span> <span class="free">p</span> <span class="main">=</span> <span class="free">a</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prime_dvd_choose<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="free">p</span> <span class="keyword1">choose</span> <span class="free">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&lt;</span> <span class="free">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">dvd</span> fact <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prime_dvd_fact_iff<span class="main">)</span>   
  
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">p</span> <span class="keyword1">dvd</span> fact <span class="free">k</span> <span class="main">*</span> fact <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> prime_dvd_mult_iff<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> prime_dvd_fact_iff<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> binomial_fact_lemma<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">≤</span> <span class="free">p</span>›</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> assms prime_dvd_multD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prime_natD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prime <span class="main">(</span><span class="free">p</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">dvd</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> <span class="free">a</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prime_nat_iff<span class="main">)</span>
  
  <span class="keyword1"><span class="command">lemma</span></span> not_prime_imp_ex_prod_nat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> prime <span class="main">(</span><span class="free">m</span><span class="main">::</span>nat<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span> <span class="bound">k</span><span class="main">.</span> <span class="free">m</span> <span class="main">=</span> <span class="bound">n</span> <span class="main">*</span> <span class="bound">k</span> <span class="main">∧</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="bound">n</span> <span class="main">∧</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">∧</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>Factorial_Ring.irreducible <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> prime_elem_iff_irreducible<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> nk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">*</span> <span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≠</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≠</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Factorial_Ring.irreducible_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> nk <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> assms nk <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="keyword1">dvd</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="keyword1">dvd</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≤</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> <span class="free">m</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> dvd_imp_le<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> nk <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≠</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≠</span> <span class="free">m</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary algebraic material›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group<span class="main">)</span> ord_eqI_prime_factors<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> prime_factors <span class="free">n</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">[^]</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="bound">p</span><span class="main">)</span> <span class="main">≠</span> <span class="main">𝟭</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">[^]</span> <span class="free">n</span> <span class="main">=</span> <span class="main">𝟭</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> carrier <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"group.ord <span class="free">G</span> <span class="free">x</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"group.ord <span class="free">G</span> <span class="free">x</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> pow_eq_id <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> group.ord <span class="free">G</span> <span class="free">x</span> <span class="main">*</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≠</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">dvd</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prime_factor_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">[^]</span> <span class="main">(</span>group.ord <span class="free">G</span> <span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">k</span> <span class="keyword1">div</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">𝟭</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> pow_eq_id<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"group.ord <span class="free">G</span> <span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">k</span> <span class="keyword1">div</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span> <span class="keyword1">div</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> k<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">[^]</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">𝟭</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">[^]</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">≠</span> <span class="main">𝟭</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> p k assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> assms<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_prime_factors_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> k <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> monoid<span class="main">)</span> pow_nat_eq_1_imp_unit<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">[^]</span> <span class="free">n</span> <span class="main">=</span> <span class="main">𝟭</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> carrier <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> Units <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">[^]</span> <span class="main">(</span><span class="main">1</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">⊗</span> <span class="free">x</span> <span class="main">[^]</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span> <span class="main">[^]</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> nat_pow_mult<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊗</span> <span class="free">x</span> <span class="main">[^]</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">𝟭</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">[^]</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">⊗</span> <span class="free">x</span> <span class="main">[^]</span> <span class="main">(</span><span class="main">1</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">=</span> <span class="free">x</span> <span class="main">[^]</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> nat_pow_mult<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">[^]</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">⊗</span> <span class="free">x</span> <span class="main">=</span> <span class="main">𝟭</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Units_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cring<span class="main">)</span> finsum_reindex_bij_betw<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="free">h</span> <span class="free">S</span> <span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> <span class="free">T</span> <span class="main">→</span> carrier <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"finsum <span class="free">R</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">g</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span> <span class="main">=</span> finsum <span class="free">R</span> <span class="free">g</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bij_betw_def finsum_reindex<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cring<span class="main">)</span> finsum_reindex_bij_witness<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> witness<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">(</span><span class="free">j</span> <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> <span class="bound">a</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">j</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">T</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free">T</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">(</span><span class="free">i</span> <span class="bound">b</span><span class="main">)</span> <span class="main">=</span> <span class="bound">b</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free">T</span> <span class="main">⟹</span> <span class="free">i</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">g</span> <span class="bound">b</span> <span class="main">∈</span> carrier <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">h</span> <span class="main">(</span><span class="free">j</span> <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finsum <span class="free">R</span> <span class="free">g</span> <span class="free">S</span> <span class="main">=</span> finsum <span class="free">R</span> <span class="free">h</span> <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> bij<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw <span class="free">j</span> <span class="free">S</span> <span class="free">T</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bij_betw_byWitness<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">j</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> f'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> A'<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">T</span></span><span class="main">]</span> witness <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> T_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">=</span> <span class="free">j</span> <span class="main">`</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bij_betw_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">∈</span> <span class="free">T</span> <span class="main">→</span> carrier <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> T_eq<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finsum <span class="free">R</span> <span class="free">g</span> <span class="free">S</span> <span class="main">=</span> finsum <span class="free">R</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">h</span> <span class="main">(</span><span class="free">j</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> finsum_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eq<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> finsum_reindex_bij_betw<span class="main">[</span><span class="operator">OF</span> bij<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">h</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cring<span class="main">)</span> binomial<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> carrier <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> carrier <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">⊕</span> <span class="free">y</span><span class="main">)</span> <span class="main">[^]</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨁</span><span class="bound">i</span><span class="main">∈</span><span class="main">{..</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> add_pow <span class="free">R</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">choose</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">[^]</span> <span class="bound">i</span> <span class="main">⊗</span> <span class="free">y</span> <span class="main">[^]</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> binomial_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span> <span class="keyword1">choose</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> Suc_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span> <span class="main">-</span> <span class="skolem">i</span> <span class="main">=</span> Suc <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">⊕</span> <span class="free">y</span><span class="main">)</span> <span class="main">[^]</span> Suc <span class="skolem">n</span> <span class="main">=</span>
          <span class="main">(</span><span class="main">⨁</span><span class="bound">i</span><span class="main">∈</span><span class="main">{..</span><span class="skolem">n</span><span class="main">}</span><span class="main">.</span> add_pow <span class="free">R</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">[^]</span> <span class="bound">i</span> <span class="main">⊗</span> <span class="free">y</span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⊗</span> <span class="free">x</span> <span class="main">⊕</span>
          <span class="main">(</span><span class="main">⨁</span><span class="bound">i</span><span class="main">∈</span><span class="main">{..</span><span class="skolem">n</span><span class="main">}</span><span class="main">.</span> add_pow <span class="free">R</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">[^]</span> <span class="bound">i</span> <span class="main">⊗</span> <span class="free">y</span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⊗</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> semiring_simprules Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⨁</span><span class="bound">i</span><span class="main">∈</span><span class="main">{..</span><span class="skolem">n</span><span class="main">}</span><span class="main">.</span> add_pow <span class="free">R</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">[^]</span> <span class="bound">i</span> <span class="main">⊗</span> <span class="free">y</span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⊗</span> <span class="free">x</span> <span class="main">=</span>
             <span class="main">(</span><span class="main">⨁</span><span class="bound">i</span><span class="main">∈</span><span class="main">{..</span><span class="skolem">n</span><span class="main">}</span><span class="main">.</span> add_pow <span class="free">R</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">[^]</span> Suc <span class="bound">i</span> <span class="main">⊗</span> <span class="free">y</span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> finsum_ldistr<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cring_simprules Suc add_pow_rdistr <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> finsum_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨁</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="main">1</span><span class="main">..</span>Suc <span class="skolem">n</span><span class="main">}</span><span class="main">.</span> add_pow <span class="free">R</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="main">(</span><span class="bound">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">[^]</span> <span class="bound">i</span> <span class="main">⊗</span> <span class="free">y</span> <span class="main">[^]</span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> finsum_reindex_bij_witness<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">i</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="bound"><span class="bound"><span class="bound">i</span></span></span> <span class="main"><span class="main"><span class="main">-</span></span></span> <span class="main"><span class="main"><span class="main">1</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">Suc</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">1</span><span class="main">..</span>Suc <span class="skolem">n</span><span class="main">}</span> <span class="main">=</span> insert <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⨁</span><span class="bound">i</span><span class="main">∈</span><span class="main">…</span><span class="main">.</span> add_pow <span class="free">R</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="main">(</span><span class="bound">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">[^]</span> <span class="bound">i</span> <span class="main">⊗</span> <span class="free">y</span> <span class="main">[^]</span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
             <span class="free">x</span> <span class="main">[^]</span> Suc <span class="skolem">n</span> <span class="main">⊕</span> <span class="main">(</span><span class="main">⨁</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">}</span><span class="main">.</span> add_pow <span class="free">R</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="main">(</span><span class="bound">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">[^]</span> <span class="bound">i</span> <span class="main">⊗</span> <span class="free">y</span> <span class="main">[^]</span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">_</span> <span class="main">⊕</span> <span class="var">?S1</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> finsum_insert<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⨁</span><span class="bound">i</span><span class="main">∈</span><span class="main">{..</span><span class="skolem">n</span><span class="main">}</span><span class="main">.</span> add_pow <span class="free">R</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">[^]</span> <span class="bound">i</span> <span class="main">⊗</span> <span class="free">y</span> <span class="main">[^]</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⊗</span> <span class="free">y</span> <span class="main">=</span>
             <span class="main">(</span><span class="main">⨁</span><span class="bound">i</span><span class="main">∈</span><span class="main">{..</span><span class="skolem">n</span><span class="main">}</span><span class="main">.</span> add_pow <span class="free">R</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">[^]</span> <span class="bound">i</span> <span class="main">⊗</span> <span class="free">y</span> <span class="main">[^]</span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> finsum_ldistr<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cring_simprules Suc add_pow_rdistr Suc_diff <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> finsum_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{..</span><span class="skolem">n</span><span class="main">}</span> <span class="main">=</span> insert <span class="main">0</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⨁</span><span class="bound">i</span><span class="main">∈</span><span class="main">…</span><span class="main">.</span> add_pow <span class="free">R</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">[^]</span> <span class="bound">i</span> <span class="main">⊗</span> <span class="free">y</span> <span class="main">[^]</span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
             <span class="free">y</span> <span class="main">[^]</span> Suc <span class="skolem">n</span> <span class="main">⊕</span> <span class="main">(</span><span class="main">⨁</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">}</span><span class="main">.</span> add_pow <span class="free">R</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">[^]</span> <span class="bound">i</span> <span class="main">⊗</span> <span class="free">y</span> <span class="main">[^]</span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">_</span> <span class="main">⊕</span> <span class="var">?S2</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> finsum_insert<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">[^]</span> Suc <span class="skolem">n</span> <span class="main">⊕</span> <span class="var">?S1</span><span class="main">)</span> <span class="main">⊕</span> <span class="main">(</span><span class="free">y</span> <span class="main">[^]</span> Suc <span class="skolem">n</span> <span class="main">⊕</span> <span class="var">?S2</span><span class="main">)</span> <span class="main">=</span>
               <span class="free">x</span> <span class="main">[^]</span> Suc <span class="skolem">n</span> <span class="main">⊕</span> <span class="free">y</span> <span class="main">[^]</span> Suc <span class="skolem">n</span> <span class="main">⊕</span> <span class="main">(</span><span class="var">?S1</span> <span class="main">⊕</span> <span class="var">?S2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cring_simprules<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S1</span> <span class="main">⊕</span> <span class="var">?S2</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨁</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">}</span><span class="main">.</span> add_pow <span class="free">R</span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">[^]</span> <span class="bound">i</span> <span class="main">⊗</span> <span class="free">y</span> <span class="main">[^]</span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> finsum_addf <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> finsum_cong'<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> finsum_cong <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> binomial_Suc add.nat_pow_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">[^]</span> Suc <span class="skolem">n</span> <span class="main">⊕</span> <span class="free">y</span> <span class="main">[^]</span> Suc <span class="skolem">n</span> <span class="main">⊕</span> <span class="main">…</span> <span class="main">=</span>
               <span class="main">(</span><span class="main">⨁</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">,</span> Suc <span class="skolem">n</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">}</span><span class="main">.</span> add_pow <span class="free">R</span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="keyword1">choose</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">[^]</span> <span class="bound">i</span> <span class="main">⊗</span> <span class="free">y</span> <span class="main">[^]</span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> finsum_Un_disjoint<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cring_simprules<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">,</span> Suc <span class="skolem">n</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="skolem">n</span><span class="main">}</span> <span class="main">=</span> <span class="main">{..</span>Suc <span class="skolem">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> cring<span class="main">)</span> binomial_finite_char<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> carrier <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> carrier <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"add_pow <span class="free">R</span> <span class="free">p</span> <span class="main">𝟭</span> <span class="main">=</span> <span class="main">𝟬</span>"</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">⊕</span> <span class="free">y</span><span class="main">)</span> <span class="main">[^]</span> <span class="free">p</span> <span class="main">=</span> <span class="free">x</span> <span class="main">[^]</span> <span class="free">p</span> <span class="main">⊕</span> <span class="free">y</span> <span class="main">[^]</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"add_pow <span class="free">R</span> <span class="main">(</span><span class="free">p</span> <span class="keyword1">choose</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">[^]</span> <span class="skolem">i</span> <span class="main">⊗</span> <span class="free">y</span> <span class="main">[^]</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">𝟬</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">p</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="free">p</span> <span class="keyword1">choose</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prime_dvd_choose<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> that assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="keyword1">choose</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span> <span class="main">*</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"add_pow <span class="free">R</span> <span class="main">(</span><span class="free">p</span> <span class="keyword1">choose</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">[^]</span> <span class="skolem">i</span> <span class="main">⊗</span> <span class="free">y</span> <span class="main">[^]</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
            add_pow <span class="free">R</span> <span class="main">(</span><span class="free">p</span> <span class="keyword1">choose</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">𝟭</span> <span class="main">⊗</span> <span class="main">(</span><span class="free">x</span> <span class="main">[^]</span> <span class="skolem">i</span> <span class="main">⊗</span> <span class="free">y</span> <span class="main">[^]</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_pow_ldistr<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"add_pow <span class="free">R</span> <span class="main">(</span><span class="free">p</span> <span class="keyword1">choose</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">𝟭</span> <span class="main">=</span> <span class="main">𝟬</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> add.nat_pow_pow<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">⊕</span> <span class="free">y</span><span class="main">)</span> <span class="main">[^]</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨁</span><span class="bound">i</span><span class="main">∈</span><span class="main">{..</span><span class="free">p</span><span class="main">}</span><span class="main">.</span> add_pow <span class="free">R</span> <span class="main">(</span><span class="free">p</span> <span class="keyword1">choose</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">[^]</span> <span class="bound">i</span> <span class="main">⊗</span> <span class="free">y</span> <span class="main">[^]</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> binomial<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨁</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="free">p</span><span class="main">}</span><span class="main">.</span> add_pow <span class="free">R</span> <span class="main">(</span><span class="free">p</span> <span class="keyword1">choose</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">[^]</span> <span class="bound">i</span> <span class="main">⊗</span> <span class="free">y</span> <span class="main">[^]</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> add.finprod_mono_neutral_cong_right<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">x</span> <span class="main">[^]</span> <span class="free">p</span> <span class="main">⊕</span> <span class="free">y</span> <span class="main">[^]</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms prime_gt_0_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cring_simprules<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> ring_hom_cring<span class="main">)</span> hom_add_pow_nat<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> carrier <span class="free">R</span> <span class="main">⟹</span> <span class="free">h</span> <span class="main">(</span>add_pow <span class="free">R</span> <span class="main">(</span><span class="free">n</span><span class="main">::</span>nat<span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> add_pow <span class="free">S</span> <span class="free">n</span> <span class="main">(</span><span class="free">h</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Lucas_Lehmer">
<div class="head">
<h1>Theory Lucas_Lehmer</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The Lucas--Lehmer test›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Lucas_Lehmer
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Lucas_Lehmer_Auxiliary.html">Lucas_Lehmer_Auxiliary</a>
  <span class="quoted">"<a href="../../HOL/HOL-Algebra/Ring.html">HOL-Algebra.Ring</a>"</span>
  <span class="quoted">"<a href="../Probabilistic_Prime_Tests/Jacobi_Symbol.html">Probabilistic_Prime_Tests.Jacobi_Symbol</a>"</span>
  <span class="quoted">"<a href="../Pell/Pell.html">Pell.Pell</a>"</span> <span class="comment1">(* only needed for irrationality of sqrt(3) *)</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹General properties of Mersenne numbers and Mersenne primes›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We mostly follow the proofs given on Wikipedia~\cite{wiki:mersenne,wiki:lucas_lehmer} in the
  following sections.

  We first show some basic and theorems about Mersenne numbers and Mersenne primes in general,
  beginning with this: Mersenne primes are the only primes of the form $a^n - 1$ for $n &gt; 1$.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> prime_power_minus_oneD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prime <span class="main">(</span><span class="free">a</span> <span class="main">^</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> <span class="free">a</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Nat.gr0I<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">use</span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> zero_power›</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">-</span> <span class="main">1</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> <span class="main">0</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cong_add<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">^</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="main">1</span> <span class="main">^</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cong_pow cong_diff_nat<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="free">a</span> <span class="main">^</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_0_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> <span class="free">a</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="free">a</span> <span class="main">^</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹prime <span class="main">(</span><span class="free">a</span> <span class="main">^</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">dvd</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prime_natD<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="free">a</span> <span class="main">^</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">^</span> <span class="free">n</span> <span class="main">=</span> <span class="free">a</span> <span class="main">^</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Nat.eq_diff_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">&gt;</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> power_inject_exp<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Next, we show that if a prime <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>q›</span></span></span></span> divides a Mersenne number $2^p - 1$ with an odd prime
  exponent <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span>, then <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>q›</span></span></span></span> must be of the form $q = 1 + 2kp$ for some $k &gt; 0$.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> prime_dvd_mersenneD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="free">q</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="numeral">2</span>"</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">q</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"odd <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prime_gt_1_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> prime_odd_nat<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≠</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≠</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Nat.gr0I<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">&gt;</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹prime <span class="free">q</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"odd <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prime_odd_nat<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ord <span class="free">q</span> <span class="numeral">2</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> <span class="main">0</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cong_add cong_refl<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cong_0_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ord <span class="free">q</span> <span class="numeral">2</span> <span class="keyword1">dvd</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> ord_divides<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ord <span class="free">q</span> <span class="numeral">2</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> ord <span class="free">q</span> <span class="numeral">2</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹prime <span class="free">p</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> prime_natD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ord <span class="free">q</span> <span class="numeral">2</span> <span class="main">≠</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ord_works<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">2</span></span> <span class="quoted"><span class="free">q</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹prime <span class="free">q</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cong_altdef_nat<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ord <span class="free">q</span> <span class="numeral">2</span> <span class="main">=</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> q_dvd_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="skolem">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">p</span> <span class="keyword1">dvd</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="skolem">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">[</span><span class="numeral">2</span> <span class="main">^</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cong_altdef_nat<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> ord <span class="free">q</span> <span class="numeral">2</span> <span class="keyword1">dvd</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ord_divides<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹ord <span class="free">q</span> <span class="numeral">2</span> <span class="main">=</span> <span class="free">p</span>›</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">q</span> <span class="main">&gt;</span> <span class="numeral">2</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">q</span> <span class="keyword1">dvd</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> primes_dvd_imp_eq two_is_prime_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="main">1</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> fermat_theorem cong_diff_nat<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_0_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> q_dvd_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">q</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">q</span> <span class="main">&gt;</span> <span class="numeral">2</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cong_altdef_nat prime_gt_1_nat<span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">q</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹odd <span class="free">q</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cong_def odd_iff_mod_2_eq_one<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">q</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹odd <span class="free">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> coprime_cong_mult_nat<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prime_dvd_mersenneD'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="free">q</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="numeral">2</span>"</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">k</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> <span class="free">q</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="bound">k</span> <span class="main">*</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≠</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≠</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Nat.gr0I<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">&gt;</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">q</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prime_dvd_mersenneD<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="free">q</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">q</span> <span class="main">&gt;</span> <span class="numeral">2</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cong_altdef_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">k</span> <span class="main">*</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">q</span> <span class="main">&gt;</span> <span class="numeral">2</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">q</span> <span class="main">&gt;</span> <span class="numeral">2</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> k <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Nat.gr0I<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A Mersenne number is any number of the form $2^p - 1$ for a natural number $p$. To make things
  a bit more pleasant, we additionally exclude $2^2 - 1$, i.e. we require $p &gt; 2$. It can
  be shown that $p$ is then always an odd prime.
›</span></span>
<span class="keyword1"><span class="command">locale</span></span> mersenne_prime <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="free">M</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≡</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p_gt_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&gt;</span> <span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> prime<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="free">M</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> M_gt_6<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">&gt;</span> <span class="numeral">6</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> p_gt_2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">≥</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="numeral">3</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> power_increasing<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> M_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> M_odd<span class="main">:</span> <span class="quoted"><span class="quoted">"odd <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> p_gt_2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> M_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> p_prime<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>prime <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> ab<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">*</span> <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> p_gt_2 not_prime_imp_ex_prod_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> geometric_sum_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span> <span class="main">::</span> int<span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span><span class="skolem">a</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">^</span> <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">^</span> <span class="skolem">a</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="skolem">b</span> <span class="main">-</span> <span class="main">1</span> <span class="main">::</span> int<span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span><span class="skolem">a</span><span class="main">.</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">^</span> <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">a</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> geometric_sum_aux<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">a</span><span class="main">*</span><span class="skolem">b</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="skolem">b</span> <span class="main">-</span> <span class="main">1</span> <span class="main">::</span> int<span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">&lt;</span><span class="skolem">a</span><span class="main">.</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="bound">k</span><span class="main">*</span><span class="skolem">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> power_mult <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="skolem">b</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">a</span><span class="main">*</span><span class="skolem">b</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">::</span> int<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"int <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="skolem">b</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">dvd</span> int <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">*</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> of_nat_diff<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> of_nat_diff<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="skolem">b</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">*</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> int_dvd_int_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> prime <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> <span class="skolem">b</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">∨</span> <span class="numeral">2</span> <span class="main">^</span> <span class="skolem">b</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ab M_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> prime_natD<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> <span class="skolem">b</span> <span class="main">&gt;</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">1</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ab <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> power_strict_increasing<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> <span class="skolem">b</span> <span class="main">&lt;</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ab <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> power_strict_increasing<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> <span class="skolem">b</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> less_diff_iff<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> p_odd<span class="main">:</span> <span class="quoted"><span class="quoted">"odd <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> p_prime p_gt_2 prime_odd_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now first show a few more properties of Mersenne primes regarding congruences
  and the Legendre symbol.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> M_cong_7_mod_12<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">M</span> <span class="main">=</span> <span class="numeral">7</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="numeral">12</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">M</span> <span class="main">=</span> <span class="numeral">8</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="numeral">12</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> p_gt_2 p_odd <span class="keyword1"><span class="command">unfolding</span></span> M_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cong_diff_nat two_power_odd_mod_12<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">M</span> <span class="main">=</span> <span class="numeral">7</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="numeral">12</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Legendre_3_M<span class="main">:</span> <span class="quoted"><span class="quoted">"Legendre <span class="numeral">3</span> <span class="free">M</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> prime M_cong_7_mod_12 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Legendre_3_left<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> M_cong_7_mod_8<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">M</span> <span class="main">=</span> <span class="numeral">7</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="numeral">8</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> <span class="numeral">3</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">::</span> int<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> p_gt_2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> le_imp_power_dvd<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="main">0</span> <span class="main">-</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="main">(</span><span class="numeral">8</span> <span class="main">::</span> int<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cong_diff<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> int <span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> M_def of_nat_diff<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"int <span class="free">M</span> <span class="keyword1">mod</span> int <span class="numeral">8</span> <span class="main">=</span> <span class="numeral">7</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">M</span> <span class="main">=</span> <span class="numeral">7</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="numeral">8</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> zmod_int <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> Legendre_2_M<span class="main">:</span> <span class="quoted"><span class="quoted">"Legendre <span class="numeral">2</span> <span class="free">M</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> prime M_gt_6 M_cong_7_mod_8
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> supplement2_Legendre'<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cong_def nat_mod_as_int<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> M_not_dvd_24<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">M</span> <span class="keyword1">dvd</span> <span class="numeral">24</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="keyword1">dvd</span> <span class="numeral">24</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="keyword1">dvd</span> <span class="numeral">2</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">*</span> <span class="numeral">3</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?this</span> <span class="main">⟷</span> <span class="free">M</span> <span class="keyword1">dvd</span> <span class="numeral">2</span> <span class="main">∨</span> <span class="free">M</span> <span class="keyword1">dvd</span> <span class="numeral">3</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prime <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> prime_dvd_mult_iff<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> M_gt_6 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dvd_imp_le<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Lucas--Lehmer sequence›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now define the Lucas--Lehmer sequence $a_{n+1} = a_n ^ 2 - 2$. The starting value
  we will always use is $a_0 = 4$.
›</span></span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">gen_lucas_lehmer_sequence</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> nat <span class="main">⇒</span> int"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gen_lucas_lehmer_sequence</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">0</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">gen_lucas_lehmer_sequence</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">gen_lucas_lehmer_sequence</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">-</span> <span class="numeral">2</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gen_lucas_lehmer_sequence_Suc'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"gen_lucas_lehmer_sequence <span class="free">a</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> gen_lucas_lehmer_sequence <span class="main">(</span><span class="free">a</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> gen_lucas_lehmer_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span> <span class="main">=</span>
  gen_lucas_lehmer_sequence.simps<span class="main">(</span>1<span class="main">)</span> gen_lucas_lehmer_sequence_Suc'

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  For $a_0 = 4$, the recurrence has the closed form $a_{4,n} = \omega^{2^n} + \bar\omega^{2^n}$
  with $\omega = 2 + \sqrt{3}$ and $\bar\omega = 2 - \sqrt{3}$.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> gen_lucas_lehmer_sequence_4_closed_form1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"real_of_int <span class="main">(</span>gen_lucas_lehmer_sequence <span class="numeral">4</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">+</span> sqrt <span class="numeral">3</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">-</span> sqrt <span class="numeral">3</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> power2_eq_square power_mult <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> power_mult_distrib<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> gen_lucas_lehmer_sequence_4_closed_form2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"gen_lucas_lehmer_sequence <span class="numeral">4</span> <span class="free">n</span> <span class="main">=</span> round <span class="main">(</span><span class="main">(</span><span class="numeral">2</span> <span class="main">+</span> sqrt <span class="numeral">3</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> round_unique'<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">5</span> <span class="main">/</span> <span class="numeral">3</span> <span class="main">&lt;</span> sqrt <span class="main">(</span><span class="numeral">3</span> <span class="main">::</span> real<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> real_less_rsqrt<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> power2_eq_square<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span> <span class="main">-</span> sqrt <span class="numeral">3</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="numeral">3</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> power_strict_mono<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> real_le_lsqrt<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="numeral">3</span><span class="main">)</span> <span class="main">^</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> power_decreasing<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span> <span class="main">-</span> sqrt <span class="numeral">3</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span> <span class="main">-</span> sqrt <span class="numeral">3</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> zero_le_power<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> real_le_lsqrt<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="main">(</span><span class="numeral">2</span> <span class="main">+</span> sqrt <span class="numeral">3</span><span class="main">)</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span> <span class="main">-</span> real_of_int <span class="main">(</span>gen_lucas_lehmer_sequence <span class="numeral">4</span> <span class="free">n</span><span class="main">)</span><span class="main">¦</span> <span class="main">&lt;</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> gen_lucas_lehmer_sequence_4_closed_form1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gen_lucas_lehmer_sequence_4_closed_form3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"gen_lucas_lehmer_sequence <span class="numeral">4</span> <span class="free">n</span> <span class="main">=</span> <span class="main">⌈</span><span class="main">(</span><span class="numeral">2</span> <span class="main">+</span> sqrt <span class="numeral">3</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span><span class="main">⌉</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ceiling_unique<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"real_of_int <span class="main">(</span>gen_lucas_lehmer_sequence <span class="numeral">4</span> <span class="free">n</span><span class="main">)</span> <span class="main">≥</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">+</span> sqrt <span class="numeral">3</span><span class="main">)</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> gen_lucas_lehmer_sequence_4_closed_form1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> zero_le_power real_le_lsqrt<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">5</span> <span class="main">/</span> <span class="numeral">3</span> <span class="main">&lt;</span> sqrt <span class="main">(</span><span class="numeral">3</span> <span class="main">::</span> real<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> real_less_rsqrt<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> power2_eq_square<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span> <span class="main">-</span> sqrt <span class="numeral">3</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="numeral">3</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> power_strict_mono<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> real_le_lsqrt<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="numeral">3</span><span class="main">)</span> <span class="main">^</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> power_decreasing<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span> <span class="main">-</span> sqrt <span class="numeral">3</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span> <span class="main">-</span> sqrt <span class="numeral">3</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> zero_le_power<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> real_le_lsqrt<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"real_of_int <span class="main">(</span>gen_lucas_lehmer_sequence <span class="numeral">4</span> <span class="free">n</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">+</span> sqrt <span class="numeral">3</span><span class="main">)</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> gen_lucas_lehmer_sequence_4_closed_form1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The ring $\mathbb{Z}[\sqrt{3}]$›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  To relate this sequence to Mersenne primes, we now first need to define the ring
  $\mathbb{Z}[\sqrt{3}]$, which is a subring of $\mathbb{R}$. This ring can be seen as the
  lattice on $\mathbb{R}$ that is freely generated by $1$ and $\sqrt{3}$.

  It is, however, more convenient to explicitly describe it as a ring structure over the 
  set $\mathbb{Z}\times\mathbb{Z}$ with a corresponding injective homomorphism
  $\mathbb{Z}\times\mathbb{Z} \to \mathbb{R}$.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lucas_lehmer_add'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">×</span> int <span class="main">⇒</span> int <span class="main">×</span> int <span class="main">⇒</span> int <span class="main">×</span> int"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lucas_lehmer_add'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">d</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span> <span class="main">+</span> <span class="bound">c</span><span class="main">,</span> <span class="bound">b</span> <span class="main">+</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lucas_lehmer_mult'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">×</span> int <span class="main">⇒</span> int <span class="main">×</span> int <span class="main">⇒</span> int <span class="main">×</span> int"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lucas_lehmer_mult'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">d</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span> <span class="main">*</span> <span class="bound">c</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> <span class="bound">b</span> <span class="main">*</span> <span class="bound">d</span><span class="main">,</span> <span class="bound">a</span> <span class="main">*</span> <span class="bound">d</span> <span class="main">+</span> <span class="bound">b</span> <span class="main">*</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lucas_lehmer_ring</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>int <span class="main">×</span> int<span class="main">)</span> ring"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lucas_lehmer_ring</span> <span class="main">=</span>
     <span class="main">⦇</span>carrier <span class="main">=</span> UNIV<span class="main">,</span>
      monoid.mult <span class="main">=</span> lucas_lehmer_mult'<span class="main">,</span>
      one <span class="main">=</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span>
      ring.zero <span class="main">=</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span>
      add <span class="main">=</span> lucas_lehmer_add'<span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> carrier_lucas_lehmer_ring <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"carrier lucas_lehmer_ring <span class="main">=</span> UNIV"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lucas_lehmer_ring_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> cring_lucas_lehmer_ring <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"cring <span class="main">(</span>lucas_lehmer_ring<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">aa</span> <span class="bound">ba</span><span class="main">.</span> lucas_lehmer_add' <span class="main">(</span><span class="bound">aa</span><span class="main">,</span> <span class="bound">ba</span><span class="main">)</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span>
                lucas_lehmer_add' <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">(</span><span class="bound">aa</span><span class="main">,</span> <span class="bound">ba</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">-</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">a</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">-</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">b</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lucas_lehmer_add'_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"carrier <span class="main">(</span>add_monoid lucas_lehmer_ring<span class="main">)</span> <span class="main">⊆</span> Units <span class="main">(</span>add_monoid lucas_lehmer_ring<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Units_def lucas_lehmer_ring_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lucas_lehmer_ring_def lucas_lehmer_add'_def lucas_lehmer_mult'_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The ring $(\mathbb{Z}/m\mathbb{Z})[\sqrt{3}]$›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We shall also need the ring $(\mathbb{Z}/m\mathbb{Z})[\sqrt{3}]$, which is obtained from
  $\mathbb{Z}[\sqrt{3}]$ by reducing each component separately modulo $m$. This essentially
  identifies any two points that are a multiple of $m$ apart and then all those that are
  a multiple of $m\sqrt{3}$ apart.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lucas_lehmer_mult</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">×</span> nat <span class="main">⇒</span> nat <span class="main">×</span> nat <span class="main">⇒</span> nat <span class="main">×</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lucas_lehmer_mult</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">d</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">a</span> <span class="main">*</span> <span class="bound">c</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> <span class="bound">b</span> <span class="main">*</span> <span class="bound">d</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="main">(</span><span class="bound">a</span> <span class="main">*</span> <span class="bound">d</span> <span class="main">+</span> <span class="bound">b</span> <span class="main">*</span> <span class="bound">c</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lucas_lehmer_add</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">×</span> nat <span class="main">⇒</span> nat <span class="main">×</span> nat <span class="main">⇒</span> nat <span class="main">×</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lucas_lehmer_add</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">d</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">a</span> <span class="main">+</span> <span class="bound">c</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="main">(</span><span class="bound">b</span> <span class="main">+</span> <span class="bound">d</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lucas_lehmer_ring_mod</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span> ring"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lucas_lehmer_ring_mod</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span>
     <span class="main">⦇</span>carrier <span class="main">=</span> <span class="main">{..&lt;</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">}</span> <span class="main">×</span> <span class="main">{..&lt;</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">}</span><span class="main">,</span>
      monoid.mult <span class="main">=</span> lucas_lehmer_mult <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span>
      one <span class="main">=</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span>
      ring.zero <span class="main">=</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span>
      add <span class="main">=</span> lucas_lehmer_add <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lucas_lehmer_add_in_carrier<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> lucas_lehmer_add <span class="free">m</span> <span class="free">x</span> <span class="free">y</span> <span class="main">∈</span> <span class="main">{..&lt;</span><span class="free">m</span><span class="main">}</span> <span class="main">×</span> <span class="main">{..&lt;</span><span class="free">m</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lucas_lehmer_add_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lucas_lehmer_mult_in_carrier<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> lucas_lehmer_mult <span class="free">m</span> <span class="free">x</span> <span class="free">y</span> <span class="main">∈</span> <span class="main">{..&lt;</span><span class="free">m</span><span class="main">}</span> <span class="main">×</span> <span class="main">{..&lt;</span><span class="free">m</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lucas_lehmer_mult_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lucas_lehmer_add_cong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span>fst <span class="main">(</span>lucas_lehmer_add <span class="free">m</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> fst <span class="free">x</span> <span class="main">+</span> fst <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span>snd <span class="main">(</span>lucas_lehmer_add <span class="free">m</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> snd <span class="free">x</span> <span class="main">+</span> snd <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lucas_lehmer_add_def cong_def case_prod_unfold<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lucas_lehmer_mult_cong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span>fst <span class="main">(</span>lucas_lehmer_mult <span class="free">m</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> fst <span class="free">x</span> <span class="main">*</span> fst <span class="free">y</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> snd <span class="free">x</span> <span class="main">*</span> snd <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span>snd <span class="main">(</span>lucas_lehmer_mult <span class="free">m</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> fst <span class="free">x</span> <span class="main">*</span> snd <span class="free">y</span> <span class="main">+</span> snd <span class="free">x</span> <span class="main">*</span> fst <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lucas_lehmer_mult_def cong_def case_prod_unfold<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lucas_lehmer_add_neutral <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">x</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="free">x</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"lucas_lehmer_add <span class="free">m</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"lucas_lehmer_add <span class="free">m</span> <span class="free">x</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lucas_lehmer_add_def case_prod_unfold<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lucas_lehmer_mult_neutral <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">x</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="free">x</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"lucas_lehmer_mult <span class="free">m</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"lucas_lehmer_mult <span class="free">m</span> <span class="free">x</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lucas_lehmer_mult_def case_prod_unfold<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lucas_lehmer_add_commute<span class="main">:</span> <span class="quoted"><span class="quoted">"lucas_lehmer_add <span class="free">m</span> <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> lucas_lehmer_add <span class="free">m</span> <span class="free">y</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lucas_lehmer_add_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span> case_prod_unfold<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lucas_lehmer_mult_commute<span class="main">:</span> <span class="quoted"><span class="quoted">"lucas_lehmer_mult <span class="free">m</span> <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> lucas_lehmer_mult <span class="free">m</span> <span class="free">y</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lucas_lehmer_mult_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span> case_prod_unfold<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lucas_lehmer_add_assoc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"lucas_lehmer_add <span class="free">m</span> <span class="free">x</span> <span class="main">(</span>lucas_lehmer_add <span class="free">m</span> <span class="free">y</span> <span class="free">z</span><span class="main">)</span> <span class="main">=</span>
           lucas_lehmer_add <span class="free">m</span> <span class="main">(</span>lucas_lehmer_add <span class="free">m</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="free">z</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> prod_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?add</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"lucas_lehmer_add <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span>fst <span class="main">(</span><span class="var">?add</span> <span class="free">x</span> <span class="main">(</span><span class="var">?add</span> <span class="free">y</span> <span class="free">z</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fst <span class="free">x</span> <span class="main">+</span> <span class="main">(</span>fst <span class="free">y</span> <span class="main">+</span> fst <span class="free">z</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lucas_lehmer_add_cong<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> cong_trans<span class="main"><span class="main">]</span></span> cong_add cong_mult cong_refl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">x</span> <span class="main">+</span> <span class="main">(</span>fst <span class="free">y</span> <span class="main">+</span> fst <span class="free">z</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fst <span class="free">x</span> <span class="main">+</span> fst <span class="free">y</span><span class="main">)</span> <span class="main">+</span> fst <span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_ac<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">…</span> <span class="main">=</span> fst <span class="main">(</span><span class="var">?add</span> <span class="main">(</span><span class="var">?add</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="free">z</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cong_sym<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> lucas_lehmer_add_cong<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> cong_trans<span class="main"><span class="main">]</span></span> cong_add cong_mult cong_refl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="var">?add</span> <span class="free">x</span> <span class="main">(</span><span class="var">?add</span> <span class="free">y</span> <span class="free">z</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span><span class="var">?add</span> <span class="main">(</span><span class="var">?add</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="free">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cong_less_modulus_unique_nat<span class="main">)</span>
       <span class="main">(</span><span class="operator">use</span> m <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main">:</span> lucas_lehmer_add_def case_prod_unfold›</span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span>snd <span class="main">(</span><span class="var">?add</span> <span class="free">x</span> <span class="main">(</span><span class="var">?add</span> <span class="free">y</span> <span class="free">z</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> snd <span class="free">x</span> <span class="main">+</span> <span class="main">(</span>snd <span class="free">y</span> <span class="main">+</span> snd <span class="free">z</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lucas_lehmer_add_cong<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> cong_trans<span class="main"><span class="main">]</span></span> cong_add cong_mult cong_refl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="free">x</span> <span class="main">+</span> <span class="main">(</span>snd <span class="free">y</span> <span class="main">+</span> snd <span class="free">z</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>snd <span class="free">x</span> <span class="main">+</span> snd <span class="free">y</span><span class="main">)</span> <span class="main">+</span> snd <span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_ac<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">…</span> <span class="main">=</span> snd <span class="main">(</span><span class="var">?add</span> <span class="main">(</span><span class="var">?add</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="free">z</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cong_sym<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> lucas_lehmer_add_cong<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> cong_trans<span class="main"><span class="main">]</span></span> cong_add cong_mult cong_refl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="var">?add</span> <span class="free">x</span> <span class="main">(</span><span class="var">?add</span> <span class="free">y</span> <span class="free">z</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span><span class="var">?add</span> <span class="main">(</span><span class="var">?add</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="free">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cong_less_modulus_unique_nat<span class="main">)</span>
       <span class="main">(</span><span class="operator">use</span> m <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main">:</span> lucas_lehmer_add_def case_prod_unfold›</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lucas_lehmer_mult_assoc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"lucas_lehmer_mult <span class="free">m</span> <span class="free">x</span> <span class="main">(</span>lucas_lehmer_mult <span class="free">m</span> <span class="free">y</span> <span class="free">z</span><span class="main">)</span> <span class="main">=</span>
           lucas_lehmer_mult <span class="free">m</span> <span class="main">(</span>lucas_lehmer_mult <span class="free">m</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="free">z</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> prod_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mul</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"lucas_lehmer_mult <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span>fst <span class="main">(</span><span class="var">?mul</span> <span class="free">x</span> <span class="main">(</span><span class="var">?mul</span> <span class="free">y</span> <span class="free">z</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fst <span class="free">x</span> <span class="main">*</span> <span class="main">(</span>fst <span class="free">y</span> <span class="main">*</span> fst <span class="free">z</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> snd <span class="free">y</span> <span class="main">*</span> snd <span class="free">z</span><span class="main">)</span> <span class="main">+</span>
           <span class="numeral">3</span> <span class="main">*</span> snd <span class="free">x</span> <span class="main">*</span> <span class="main">(</span>fst <span class="free">y</span> <span class="main">*</span> snd <span class="free">z</span> <span class="main">+</span> snd <span class="free">y</span> <span class="main">*</span> fst <span class="free">z</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lucas_lehmer_mult_cong<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> cong_trans<span class="main"><span class="main">]</span></span> cong_add cong_mult cong_refl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">x</span> <span class="main">*</span> <span class="main">(</span>fst <span class="free">y</span> <span class="main">*</span> fst <span class="free">z</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> snd <span class="free">y</span> <span class="main">*</span> snd <span class="free">z</span><span class="main">)</span> <span class="main">+</span>
               <span class="numeral">3</span> <span class="main">*</span> snd <span class="free">x</span> <span class="main">*</span> <span class="main">(</span>fst <span class="free">y</span> <span class="main">*</span> snd <span class="free">z</span> <span class="main">+</span> snd <span class="free">y</span> <span class="main">*</span> fst <span class="free">z</span><span class="main">)</span> <span class="main">=</span>
             <span class="main">(</span>fst <span class="free">x</span> <span class="main">*</span> fst <span class="free">y</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> snd <span class="free">x</span> <span class="main">*</span> snd <span class="free">y</span><span class="main">)</span> <span class="main">*</span> fst <span class="free">z</span> <span class="main">+</span>
               <span class="numeral">3</span> <span class="main">*</span> <span class="main">(</span>fst <span class="free">x</span> <span class="main">*</span> snd <span class="free">y</span> <span class="main">+</span> snd <span class="free">x</span> <span class="main">*</span> fst <span class="free">y</span><span class="main">)</span> <span class="main">*</span> snd <span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">…</span> <span class="main">=</span> fst <span class="main">(</span><span class="var">?mul</span> <span class="main">(</span><span class="var">?mul</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="free">z</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cong_sym<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> lucas_lehmer_mult_cong<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> cong_trans<span class="main"><span class="main">]</span></span> cong_add cong_mult cong_refl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="var">?mul</span> <span class="free">x</span> <span class="main">(</span><span class="var">?mul</span> <span class="free">y</span> <span class="free">z</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span><span class="var">?mul</span> <span class="main">(</span><span class="var">?mul</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="free">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cong_less_modulus_unique_nat<span class="main">)</span>
       <span class="main">(</span><span class="operator">use</span> m <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main">:</span> lucas_lehmer_mult_def case_prod_unfold›</span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span>snd <span class="main">(</span><span class="var">?mul</span> <span class="free">x</span> <span class="main">(</span><span class="var">?mul</span> <span class="free">y</span> <span class="free">z</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fst <span class="free">x</span> <span class="main">*</span> <span class="main">(</span>fst <span class="free">y</span> <span class="main">*</span> snd <span class="free">z</span> <span class="main">+</span> snd <span class="free">y</span> <span class="main">*</span> fst <span class="free">z</span><span class="main">)</span> <span class="main">+</span>
     snd <span class="free">x</span> <span class="main">*</span> <span class="main">(</span>fst <span class="free">y</span> <span class="main">*</span> fst <span class="free">z</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> snd <span class="free">y</span> <span class="main">*</span> snd <span class="free">z</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lucas_lehmer_mult_cong<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> cong_trans<span class="main"><span class="main">]</span></span> cong_add cong_mult cong_refl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">x</span> <span class="main">*</span> <span class="main">(</span>fst <span class="free">y</span> <span class="main">*</span> snd <span class="free">z</span> <span class="main">+</span> snd <span class="free">y</span> <span class="main">*</span> fst <span class="free">z</span><span class="main">)</span> <span class="main">+</span> snd <span class="free">x</span> <span class="main">*</span> <span class="main">(</span>fst <span class="free">y</span> <span class="main">*</span> fst <span class="free">z</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> snd <span class="free">y</span> <span class="main">*</span> snd <span class="free">z</span><span class="main">)</span> <span class="main">=</span>
             <span class="main">(</span>fst <span class="free">x</span> <span class="main">*</span> fst <span class="free">y</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> snd <span class="free">x</span> <span class="main">*</span> snd <span class="free">y</span><span class="main">)</span> <span class="main">*</span> snd <span class="free">z</span> <span class="main">+</span> <span class="main">(</span>fst <span class="free">x</span> <span class="main">*</span> snd <span class="free">y</span> <span class="main">+</span> snd <span class="free">x</span> <span class="main">*</span> fst <span class="free">y</span><span class="main">)</span> <span class="main">*</span> fst <span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">…</span> <span class="main">=</span> snd <span class="main">(</span><span class="var">?mul</span> <span class="main">(</span><span class="var">?mul</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="free">z</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cong_sym<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> lucas_lehmer_mult_cong<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> cong_trans<span class="main"><span class="main">]</span></span> cong_add cong_mult cong_refl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="var">?mul</span> <span class="free">x</span> <span class="main">(</span><span class="var">?mul</span> <span class="free">y</span> <span class="free">z</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span><span class="var">?mul</span> <span class="main">(</span><span class="var">?mul</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="free">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cong_less_modulus_unique_nat<span class="main">)</span>
       <span class="main">(</span><span class="operator">use</span> m <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main">:</span> lucas_lehmer_mult_def case_prod_unfold›</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lucas_lehmer_distrib_right<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lucas_lehmer_mult <span class="free">m</span> <span class="main">(</span>lucas_lehmer_add <span class="free">m</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="free">z</span> <span class="main">=</span>
         lucas_lehmer_add <span class="free">m</span> <span class="main">(</span>lucas_lehmer_mult <span class="free">m</span> <span class="free">x</span> <span class="free">z</span><span class="main">)</span> <span class="main">(</span>lucas_lehmer_mult <span class="free">m</span> <span class="free">y</span> <span class="free">z</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> prod_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mul</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"lucas_lehmer_mult <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?add</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"lucas_lehmer_add <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span>fst <span class="main">(</span><span class="var">?mul</span> <span class="main">(</span><span class="var">?add</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="free">z</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fst <span class="free">x</span> <span class="main">+</span> fst <span class="free">y</span><span class="main">)</span> <span class="main">*</span> fst <span class="free">z</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> <span class="main">(</span>snd <span class="free">x</span> <span class="main">+</span> snd <span class="free">y</span><span class="main">)</span> <span class="main">*</span> snd <span class="free">z</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lucas_lehmer_mult_cong<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> cong_trans<span class="main"><span class="main">]</span></span> lucas_lehmer_add_cong<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> cong_trans<span class="main"><span class="main">]</span></span>
             cong_add cong_mult cong_refl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="free">x</span> <span class="main">+</span> fst <span class="free">y</span><span class="main">)</span> <span class="main">*</span> fst <span class="free">z</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> <span class="main">(</span>snd <span class="free">x</span> <span class="main">+</span> snd <span class="free">y</span><span class="main">)</span> <span class="main">*</span> snd <span class="free">z</span> <span class="main">=</span>
               <span class="main">(</span>fst <span class="free">x</span> <span class="main">*</span> fst <span class="free">z</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> snd <span class="free">x</span> <span class="main">*</span> snd <span class="free">z</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>fst <span class="free">y</span> <span class="main">*</span> fst <span class="free">z</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> snd <span class="free">y</span> <span class="main">*</span> snd <span class="free">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">…</span> <span class="main">=</span> fst <span class="main">(</span><span class="var">?add</span> <span class="main">(</span><span class="var">?mul</span> <span class="free">x</span> <span class="free">z</span><span class="main">)</span> <span class="main">(</span><span class="var">?mul</span> <span class="free">y</span> <span class="free">z</span><span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cong_sym<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> lucas_lehmer_mult_cong<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> cong_trans<span class="main"><span class="main">]</span></span>
          lucas_lehmer_add_cong<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> cong_trans<span class="main"><span class="main">]</span></span> cong_add cong_mult cong_refl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="var">?mul</span> <span class="main">(</span><span class="var">?add</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="free">z</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span><span class="var">?add</span> <span class="main">(</span><span class="var">?mul</span> <span class="free">x</span> <span class="free">z</span><span class="main">)</span> <span class="main">(</span><span class="var">?mul</span> <span class="free">y</span> <span class="free">z</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cong_less_modulus_unique_nat<span class="main">)</span>
       <span class="main">(</span><span class="operator">use</span> m <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main">:</span> lucas_lehmer_add_def lucas_lehmer_mult_def case_prod_unfold›</span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span>snd <span class="main">(</span><span class="var">?mul</span> <span class="main">(</span><span class="var">?add</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="free">z</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fst <span class="free">x</span> <span class="main">+</span> fst <span class="free">y</span><span class="main">)</span> <span class="main">*</span> snd <span class="free">z</span> <span class="main">+</span> <span class="main">(</span>snd <span class="free">x</span> <span class="main">+</span> snd <span class="free">y</span><span class="main">)</span> <span class="main">*</span> fst <span class="free">z</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lucas_lehmer_mult_cong<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> cong_trans<span class="main"><span class="main">]</span></span> lucas_lehmer_add_cong<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> cong_trans<span class="main"><span class="main">]</span></span>
             cong_add cong_mult cong_refl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="free">x</span> <span class="main">+</span> fst <span class="free">y</span><span class="main">)</span> <span class="main">*</span> snd <span class="free">z</span> <span class="main">+</span> <span class="main">(</span>snd <span class="free">x</span> <span class="main">+</span> snd <span class="free">y</span><span class="main">)</span> <span class="main">*</span> fst <span class="free">z</span> <span class="main">=</span>
               <span class="main">(</span>fst <span class="free">x</span> <span class="main">*</span> snd <span class="free">z</span> <span class="main">+</span> snd <span class="free">x</span> <span class="main">*</span> fst <span class="free">z</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>fst <span class="free">y</span> <span class="main">*</span> snd <span class="free">z</span> <span class="main">+</span> snd <span class="free">y</span> <span class="main">*</span> fst <span class="free">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">…</span> <span class="main">=</span> snd <span class="main">(</span><span class="var">?add</span> <span class="main">(</span><span class="var">?mul</span> <span class="free">x</span> <span class="free">z</span><span class="main">)</span> <span class="main">(</span><span class="var">?mul</span> <span class="free">y</span> <span class="free">z</span><span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cong_sym<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> lucas_lehmer_mult_cong<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> cong_trans<span class="main"><span class="main">]</span></span>
          lucas_lehmer_add_cong<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> cong_trans<span class="main"><span class="main">]</span></span> cong_add cong_mult cong_refl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="var">?mul</span> <span class="main">(</span><span class="var">?add</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="free">z</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span><span class="var">?add</span> <span class="main">(</span><span class="var">?mul</span> <span class="free">x</span> <span class="free">z</span><span class="main">)</span> <span class="main">(</span><span class="var">?mul</span> <span class="free">y</span> <span class="free">z</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cong_less_modulus_unique_nat<span class="main">)</span>
       <span class="main">(</span><span class="operator">use</span> m <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main">:</span> lucas_lehmer_add_def lucas_lehmer_mult_def case_prod_unfold›</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lucas_lehmer_distrib_left<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lucas_lehmer_mult <span class="free">m</span> <span class="free">z</span> <span class="main">(</span>lucas_lehmer_add <span class="free">m</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span>
         lucas_lehmer_add <span class="free">m</span> <span class="main">(</span>lucas_lehmer_mult <span class="free">m</span> <span class="free">z</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>lucas_lehmer_mult <span class="free">m</span> <span class="free">z</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lucas_lehmer_distrib_right<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">z</span></span><span class="main">]</span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lucas_lehmer_mult_commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> cring_lucas_lehmer_ring_mod <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"cring <span class="main">(</span>lucas_lehmer_ring_mod <span class="free">m</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?neg</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="free">m</span> <span class="main">-</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">∈</span>carrier <span class="main">(</span>lucas_lehmer_ring_mod <span class="free">m</span><span class="main">)</span><span class="main">.</span>
           <span class="bound">x</span> <span class="main">⊕</span><span class="main"><span class="hidden">⇘</span><sub></sub></span>lucas_lehmer_ring_mod <span class="free">m</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">𝟬</span><span class="main"><span class="hidden">⇘</span><sub></sub></span>lucas_lehmer_ring_mod <span class="free">m</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">∧</span>
           <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">⊕</span><span class="main"><span class="hidden">⇘</span><sub></sub></span>lucas_lehmer_ring_mod <span class="free">m</span><span class="main"><span class="hidden">⇙</span></span> <span class="bound">x</span> <span class="main">=</span> <span class="main">𝟬</span><span class="main"><span class="hidden">⇘</span><sub></sub></span>lucas_lehmer_ring_mod <span class="free">m</span><span class="main"><span class="hidden">⇙</span></span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> carrier <span class="main">(</span>lucas_lehmer_ring_mod <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
    <span class="keyword1"><span class="command">using</span></span> that assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">(</span></span></span><span class="var"><span class="var"><span class="var">?neg</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">a</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="var"><span class="var"><span class="var">?neg</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">b</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lucas_lehmer_ring_mod_def lucas_lehmer_add_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"carrier <span class="main">(</span>add_monoid <span class="main">(</span>lucas_lehmer_ring_mod <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> Units <span class="main">(</span>add_monoid <span class="main">(</span>lucas_lehmer_ring_mod <span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Units_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span>
     <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lucas_lehmer_ring_mod_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span> lucas_lehmer_mult_assoc
                lucas_lehmer_add_assoc lucas_lehmer_distrib_right lucas_lehmer_distrib_left
          <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> lucas_lehmer_mult_in_carrier lucas_lehmer_add_in_carrier
                 lucas_lehmer_add_commute lucas_lehmer_mult_commute<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Since $0$ is clearly not a unit in the ring and its carrier has size $m ^ 2$, the 
  number of units is strictly less than $m ^ 2$.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> card_lucas_lehmer_Units<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"card <span class="main">(</span>Units <span class="main">(</span>lucas_lehmer_ring_mod <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">^</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> cring <span class="quoted"><span class="quoted">"lucas_lehmer_ring_mod <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>Units <span class="main">(</span>lucas_lehmer_ring_mod <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span><span class="main">{..&lt;</span><span class="free">m</span><span class="main">}</span> <span class="main">×</span> <span class="main">{..&lt;</span><span class="free">m</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> card_mono<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Units_def lucas_lehmer_ring_mod_def lucas_lehmer_mult_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">m</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> card_Diff_subset<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> power2_eq_square<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">m</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Consider now the case of a prime modulus $m$: Since $\mathbb{Z}/m\mathbb{Z} = \text{GF}(m)$
  is a field, any element of $\mathbb{Z}/m\mathbb{Z}$ is a unit in
  $(\mathbb{Z}/m\mathbb{Z})[\sqrt{3}]$.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> int_in_Units_lucas_lehmer_ring_mod<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">∈</span> Units <span class="main">(</span>lucas_lehmer_ring_mod <span class="free">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">=</span> lucas_lehmer_ring_mod <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="free">x</span> <span class="main">^</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span> <span class="main">*</span> <span class="free">x</span> <span class="main">^</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cong_mult<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">*</span> <span class="free">x</span> <span class="main">^</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span> <span class="main">^</span> <span class="main">(</span>Suc <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_ac<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prime_gt_1_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span> <span class="main">^</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> fermat_theorem<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dvd_imp_le<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">⊗</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="free">x</span> <span class="main">^</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">p</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">𝟭</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">R</span><span class="main"><span class="hidden">⇙</span></span>"</span></span>
               <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">^</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">p</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">⊗</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">𝟭</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">R</span><span class="main"><span class="hidden">⇙</span></span>"</span></span>
               <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">^</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">p</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">∈</span> carrier <span class="skolem">R</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prime_gt_1_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lucas_lehmer_mult_def cong_def lucas_lehmer_ring_mod_def mult_ac R_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">∈</span> carrier <span class="skolem">R</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> R_def lucas_lehmer_ring_mod_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Units_def R_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹$\mathbb{Z}[\sqrt{3}]$ as a subring of $\mathbb{R}$›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now define the homomorphism from $\mathbb{Z}[\sqrt{3}]$ into the reals:
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lucas_lehmer_to_real</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">×</span> int <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lucas_lehmer_to_real</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> real_of_int <span class="bound">a</span> <span class="main">+</span> real_of_int <span class="bound">b</span> <span class="main">*</span> sqrt <span class="numeral">3</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> cring <span class="quoted">lucas_lehmer_ring</span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">lemma</span></span> minus_lucas_lehmer_ring<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊖</span><span class="main"><span class="hidden">⇘</span><sub></sub></span>lucas_lehmer_ring<span class="main"><span class="hidden">⇙</span></span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">-</span><span class="bound">a</span><span class="main">,</span> <span class="main">-</span><span class="bound">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> sum_zero_eq_neg<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> case_prod_unfold lucas_lehmer_ring_def lucas_lehmer_add'_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lucas_lehmer_to_real_simps1<span class="main">:</span>
      <span class="quoted"><span class="quoted">"lucas_lehmer_to_real <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> of_int <span class="free">a</span> <span class="main">+</span> of_int <span class="free">b</span> <span class="main">*</span> sqrt <span class="numeral">3</span>"</span></span>
      <span class="quoted"><span class="quoted">"lucas_lehmer_to_real <span class="main">(</span><span class="free">x</span> <span class="main">⊕</span><span class="main"><span class="hidden">⇘</span><sub></sub></span>lucas_lehmer_ring<span class="main"><span class="hidden">⇙</span></span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span>
       lucas_lehmer_to_real <span class="free">x</span> <span class="main">+</span> lucas_lehmer_to_real <span class="free">y</span>"</span></span>
      <span class="quoted"><span class="quoted">"lucas_lehmer_to_real <span class="main">(</span><span class="free">x</span> <span class="main">⊗</span><span class="main"><span class="hidden">⇘</span><sub></sub></span>lucas_lehmer_ring<span class="main"><span class="hidden">⇙</span></span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span>
       lucas_lehmer_to_real <span class="free">x</span> <span class="main">*</span> lucas_lehmer_to_real <span class="free">y</span>"</span></span>
      <span class="quoted"><span class="quoted">"lucas_lehmer_to_real <span class="main">(</span><span class="main">⊖</span><span class="main"><span class="hidden">⇘</span><sub></sub></span>lucas_lehmer_ring<span class="main"><span class="hidden">⇙</span></span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span>lucas_lehmer_to_real <span class="free">x</span>"</span></span>
      <span class="quoted"><span class="quoted">"lucas_lehmer_to_real <span class="main">(</span><span class="main">𝟬</span><span class="main"><span class="hidden">⇘</span><sub></sub></span>lucas_lehmer_ring<span class="main"><span class="hidden">⇙</span></span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="quoted"><span class="quoted">"lucas_lehmer_to_real <span class="main">(</span><span class="main">𝟭</span><span class="main"><span class="hidden">⇘</span><sub></sub></span>lucas_lehmer_ring<span class="main"><span class="hidden">⇙</span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> minus_lucas_lehmer_ring
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lucas_lehmer_to_real_def lucas_lehmer_add'_def lucas_lehmer_mult'_def
                    case_prod_unfold <span class="dynamic"><span class="dynamic">algebra_simps</span></span> lucas_lehmer_ring_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lucas_lehmer_to_add_pow_nat<span class="main">:</span>
  <span class="quoted"><span class="quoted">"lucas_lehmer_to_real <span class="main">(</span><span class="main">[</span><span class="free">n</span><span class="main">]</span> <span class="main">⋅</span><span class="main"><span class="hidden">⇘</span><sub></sub></span>lucas_lehmer_ring<span class="main"><span class="hidden">⇙</span></span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> of_nat <span class="free">n</span> <span class="main">*</span> lucas_lehmer_to_real <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lucas_lehmer_to_real_simps1 <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lucas_lehmer_to_add_pow_int<span class="main">:</span>
  <span class="quoted"><span class="quoted">"lucas_lehmer_to_real <span class="main">(</span><span class="main">[</span><span class="free">n</span><span class="main">]</span> <span class="main">⋅</span><span class="main"><span class="hidden">⇘</span><sub></sub></span>lucas_lehmer_ring<span class="main"><span class="hidden">⇙</span></span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> of_int <span class="free">n</span> <span class="main">*</span> lucas_lehmer_to_real <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≥</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"lucas_lehmer_to_real <span class="main">(</span><span class="main">[</span><span class="free">n</span><span class="main">]</span> <span class="main">⋅</span><span class="main"><span class="hidden">⇘</span><sub></sub></span>lucas_lehmer_ring<span class="main"><span class="hidden">⇙</span></span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span>
         lucas_lehmer_to_real <span class="main">(</span><span class="main">[</span>int <span class="main">(</span>nat <span class="free">n</span><span class="main">)</span><span class="main">]</span> <span class="main">⋅</span><span class="main"><span class="hidden">⇘</span><sub></sub></span>lucas_lehmer_ring<span class="main"><span class="hidden">⇙</span></span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lucas_lehmer_to_real <span class="main">(</span><span class="main">[</span>nat <span class="free">n</span><span class="main">]</span> <span class="main">⋅</span><span class="main"><span class="hidden">⇘</span><sub></sub></span>lucas_lehmer_ring<span class="main"><span class="hidden">⇙</span></span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_pow_int_ge<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> of_int <span class="free">n</span> <span class="main">*</span> lucas_lehmer_to_real <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lucas_lehmer_to_add_pow_nat <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"lucas_lehmer_to_real <span class="main">(</span><span class="main">[</span><span class="free">n</span><span class="main">]</span> <span class="main">⋅</span><span class="main"><span class="hidden">⇘</span><sub></sub></span>lucas_lehmer_ring<span class="main"><span class="hidden">⇙</span></span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span>
         lucas_lehmer_to_real <span class="main">(</span>add_pow lucas_lehmer_ring <span class="main">(</span><span class="main">-</span>int <span class="main">(</span>nat <span class="main">(</span><span class="main">-</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"add_pow lucas_lehmer_ring <span class="main">(</span><span class="main">-</span>int <span class="main">(</span>nat <span class="main">(</span><span class="main">-</span><span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span>
              <span class="main">⊖</span><span class="main"><span class="hidden">⇘</span><sub></sub></span>lucas_lehmer_ring<span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span>add_pow lucas_lehmer_ring <span class="main">(</span>nat <span class="main">(</span><span class="main">-</span><span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> add.int_pow_neg_int<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lucas_lehmer_ring_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lucas_lehmer_to_real <span class="main">…</span> <span class="main">=</span> of_int <span class="free">n</span> <span class="main">*</span> lucas_lehmer_to_real <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lucas_lehmer_to_add_pow_nat lucas_lehmer_to_real_simps1 <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lucas_lehmer_to_real_power<span class="main">:</span>
  <span class="quoted"><span class="quoted">"lucas_lehmer_to_real <span class="main">(</span><span class="free">x</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span>lucas_lehmer_ring<span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="free">n</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span> <span class="main">=</span> lucas_lehmer_to_real <span class="free">x</span> <span class="main">^</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lucas_lehmer_to_real_simps1<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> lucas_lehmer_to_real_simps <span class="main">=</span>
  lucas_lehmer_to_real_simps1 lucas_lehmer_to_real_power
  lucas_lehmer_to_add_pow_nat lucas_lehmer_to_add_pow_int

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lucas_lehmer_to_real_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj lucas_lehmer_to_real"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> injI<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span> <span class="skolem">d</span> <span class="main">::</span> <span class="quoted">int</span>
  <span class="keyword3"><span class="command">assume</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"lucas_lehmer_to_real <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">=</span> lucas_lehmer_to_real <span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">d</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> <span class="skolem">d</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≠</span> <span class="skolem">d</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sqrt <span class="numeral">3</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">c</span> <span class="main">-</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">b</span> <span class="main">-</span> <span class="skolem">d</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lucas_lehmer_to_real_def <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">∈</span> <span class="main">ℚ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sqrt <span class="numeral">3</span> <span class="main">∈</span> <span class="main">ℚ</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sqrt <span class="numeral">3</span> <span class="main">∉</span> <span class="main">ℚ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> is_nth_power_prime_power_nat_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">3</span></span> <span class="quoted"><span class="numeral">2</span></span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span> irrat_sqrt_nonsquare<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">3</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword2"><span class="keyword">and</span></span> eq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lucas_lehmer_to_real_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">c</span> <span class="main">∧</span> <span class="skolem">b</span> <span class="main">=</span> <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The canonical homomorphism $\mathbb{Z}[\sqrt 3] \to (\mathbb{Z}/m\mathbb{Z})[\sqrt 3]$›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Next, we show that reduction modulo $m$ is indeed a homomorphism.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lucas_lehmer_hom</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span>int <span class="main">×</span> int<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lucas_lehmer_hom</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>nat <span class="main">(</span><span class="bound">x</span> <span class="keyword1">mod</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">,</span> nat <span class="main">(</span><span class="bound">y</span> <span class="keyword1">mod</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lucas_lehmer_hom_cong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span>fst <span class="free">x</span> <span class="main">=</span> fst <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> int <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">[</span>snd <span class="free">x</span> <span class="main">=</span> snd <span class="free">y</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> int <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span>
   lucas_lehmer_hom <span class="free">m</span> <span class="free">x</span> <span class="main">=</span> lucas_lehmer_hom <span class="free">m</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lucas_lehmer_hom_def cong_def case_prod_unfold<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lucas_lehmer_hom_cong'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">=</span> <span class="free">b</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> int <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">c</span> <span class="main">=</span> <span class="free">d</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> int <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span>
   lucas_lehmer_hom <span class="free">m</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> lucas_lehmer_hom <span class="free">m</span> <span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">d</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lucas_lehmer_hom_def cong_def<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">m</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lucas_lehmer_hom_in_carrier<span class="main">:</span> <span class="quoted"><span class="quoted">"lucas_lehmer_hom <span class="free">m</span> <span class="free">x</span> <span class="main">∈</span> <span class="main">{..&lt;</span><span class="free">m</span><span class="main">}</span> <span class="main">×</span> <span class="main">{..&lt;</span><span class="free">m</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> m nat_less_iff <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lucas_lehmer_hom_def case_prod_unfold<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lucas_lehmer_hom_add<span class="main">:</span>
  <span class="quoted"><span class="quoted">"lucas_lehmer_hom <span class="free">m</span> <span class="main">(</span>lucas_lehmer_add' <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span>
   lucas_lehmer_add <span class="free">m</span> <span class="main">(</span>lucas_lehmer_hom <span class="free">m</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>lucas_lehmer_hom <span class="free">m</span> <span class="free">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> prod_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?add1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"lucas_lehmer_add'"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?add2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"lucas_lehmer_add <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?φ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"lucas_lehmer_hom <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="var">?φ</span> <span class="main">(</span><span class="var">?add1</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> nat <span class="main">(</span><span class="main">(</span>fst <span class="free">x</span> <span class="main">+</span> fst <span class="free">y</span><span class="main">)</span> <span class="keyword1">mod</span> int <span class="free">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lucas_lehmer_hom_def lucas_lehmer_add'_def case_prod_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="free">x</span> <span class="main">+</span> fst <span class="free">y</span><span class="main">)</span> <span class="keyword1">mod</span> int <span class="free">m</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>fst <span class="free">x</span> <span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>fst <span class="free">y</span> <span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> int <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mod_add_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nat <span class="main">…</span> <span class="main">=</span> <span class="main">(</span>nat <span class="main">(</span>fst <span class="free">x</span> <span class="keyword1">mod</span> int <span class="free">m</span><span class="main">)</span> <span class="main">+</span> nat <span class="main">(</span>fst <span class="free">y</span> <span class="keyword1">mod</span> int <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> m nat_add_distrib nat_mod_distrib <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> fst <span class="main">(</span><span class="var">?add2</span> <span class="main">(</span><span class="var">?φ</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="var">?φ</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lucas_lehmer_hom_def lucas_lehmer_add_def case_prod_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="var">?φ</span> <span class="main">(</span><span class="var">?add1</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span><span class="var">?add2</span> <span class="main">(</span><span class="var">?φ</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="var">?φ</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="var">?φ</span> <span class="main">(</span><span class="var">?add1</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> nat <span class="main">(</span><span class="main">(</span>snd <span class="free">x</span> <span class="main">+</span> snd <span class="free">y</span><span class="main">)</span> <span class="keyword1">mod</span> int <span class="free">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lucas_lehmer_hom_def lucas_lehmer_add'_def case_prod_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>snd <span class="free">x</span> <span class="main">+</span> snd <span class="free">y</span><span class="main">)</span> <span class="keyword1">mod</span> int <span class="free">m</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>snd <span class="free">x</span> <span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>snd <span class="free">y</span> <span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> int <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mod_add_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nat <span class="main">…</span> <span class="main">=</span> <span class="main">(</span>nat <span class="main">(</span>snd <span class="free">x</span> <span class="keyword1">mod</span> int <span class="free">m</span><span class="main">)</span> <span class="main">+</span> nat <span class="main">(</span>snd <span class="free">y</span> <span class="keyword1">mod</span> int <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> m nat_add_distrib nat_mod_distrib <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> snd <span class="main">(</span><span class="var">?add2</span> <span class="main">(</span><span class="var">?φ</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="var">?φ</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lucas_lehmer_hom_def lucas_lehmer_add_def case_prod_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="var">?φ</span> <span class="main">(</span><span class="var">?add1</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span><span class="var">?add2</span> <span class="main">(</span><span class="var">?φ</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="var">?φ</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lucas_lehmer_hom_mult<span class="main">:</span>
  <span class="quoted"><span class="quoted">"lucas_lehmer_hom <span class="free">m</span> <span class="main">(</span>lucas_lehmer_mult' <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span>
   lucas_lehmer_mult <span class="free">m</span> <span class="main">(</span>lucas_lehmer_hom <span class="free">m</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>lucas_lehmer_hom <span class="free">m</span> <span class="free">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> prod_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mul1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"lucas_lehmer_mult'"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?mul2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"lucas_lehmer_mult <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?φ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"lucas_lehmer_hom <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="var">?φ</span> <span class="main">(</span><span class="var">?mul1</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> nat <span class="main">(</span><span class="main">(</span>fst <span class="free">x</span> <span class="main">*</span> fst <span class="free">y</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> snd <span class="free">x</span> <span class="main">*</span> snd <span class="free">y</span><span class="main">)</span> <span class="keyword1">mod</span> int <span class="free">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lucas_lehmer_hom_def lucas_lehmer_mult'_def case_prod_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="free">x</span> <span class="main">*</span> fst <span class="free">y</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> snd <span class="free">x</span> <span class="main">*</span> snd <span class="free">y</span><span class="main">)</span> <span class="keyword1">mod</span> int <span class="free">m</span> <span class="main">=</span>
               <span class="main">(</span><span class="main">(</span>fst <span class="free">x</span> <span class="keyword1">mod</span> int <span class="free">m</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>fst <span class="free">y</span> <span class="keyword1">mod</span> int <span class="free">m</span><span class="main">)</span> <span class="main">+</span>
                <span class="numeral">3</span> <span class="main">*</span> <span class="main">(</span>snd <span class="free">x</span> <span class="keyword1">mod</span> int <span class="free">m</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>snd <span class="free">y</span> <span class="keyword1">mod</span> int <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> congD cong_mult cong_add cong_refl<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> int <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span><span class="main">(</span>fst <span class="free">x</span> <span class="keyword1">mod</span> int <span class="free">m</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>fst <span class="free">y</span> <span class="keyword1">mod</span> int <span class="free">m</span><span class="main">)</span> <span class="main">+</span>
                <span class="numeral">3</span> <span class="main">*</span> <span class="main">(</span>snd <span class="free">x</span> <span class="keyword1">mod</span> int <span class="free">m</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>snd <span class="free">y</span> <span class="keyword1">mod</span> int <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> m <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> of_nat_nat<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> int <span class="main">(</span>nat <span class="main">(</span>fst <span class="free">x</span> <span class="keyword1">mod</span> int <span class="free">m</span><span class="main">)</span> <span class="main">*</span> nat <span class="main">(</span>fst <span class="free">y</span> <span class="keyword1">mod</span> int <span class="free">m</span><span class="main">)</span> <span class="main">+</span>
                <span class="numeral">3</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">(</span>snd <span class="free">x</span> <span class="keyword1">mod</span> int <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> nat <span class="main">(</span>snd <span class="free">y</span> <span class="keyword1">mod</span> int <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> m <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nat <span class="main">…</span> <span class="main">=</span> <span class="main">(</span>nat <span class="main">(</span>fst <span class="free">x</span> <span class="keyword1">mod</span> int <span class="free">m</span><span class="main">)</span> <span class="main">*</span> nat <span class="main">(</span>fst <span class="free">y</span> <span class="keyword1">mod</span> int <span class="free">m</span><span class="main">)</span> <span class="main">+</span>
           <span class="numeral">3</span> <span class="main">*</span> nat <span class="main">(</span>snd <span class="free">x</span> <span class="keyword1">mod</span> int <span class="free">m</span><span class="main">)</span> <span class="main">*</span> nat <span class="main">(</span>snd <span class="free">y</span> <span class="keyword1">mod</span> int <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> m <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> nat_int zmod_int<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> fst <span class="main">(</span><span class="var">?mul2</span> <span class="main">(</span><span class="var">?φ</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="var">?φ</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lucas_lehmer_hom_def lucas_lehmer_mult_def case_prod_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="var">?φ</span> <span class="main">(</span><span class="var">?mul1</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span><span class="var">?mul2</span> <span class="main">(</span><span class="var">?φ</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="var">?φ</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="var">?φ</span> <span class="main">(</span><span class="var">?mul1</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> nat <span class="main">(</span><span class="main">(</span>fst <span class="free">x</span> <span class="main">*</span> snd <span class="free">y</span> <span class="main">+</span> snd <span class="free">x</span> <span class="main">*</span> fst <span class="free">y</span><span class="main">)</span> <span class="keyword1">mod</span> int <span class="free">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lucas_lehmer_hom_def lucas_lehmer_mult'_def case_prod_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="free">x</span> <span class="main">*</span> snd <span class="free">y</span> <span class="main">+</span> snd <span class="free">x</span> <span class="main">*</span> fst <span class="free">y</span><span class="main">)</span> <span class="keyword1">mod</span> int <span class="free">m</span> <span class="main">=</span>
               <span class="main">(</span><span class="main">(</span>fst <span class="free">x</span> <span class="keyword1">mod</span> int <span class="free">m</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>snd <span class="free">y</span> <span class="keyword1">mod</span> int <span class="free">m</span><span class="main">)</span> <span class="main">+</span>
                <span class="main">(</span>snd <span class="free">x</span> <span class="keyword1">mod</span> int <span class="free">m</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>fst <span class="free">y</span> <span class="keyword1">mod</span> int <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> congD cong_mult cong_add cong_refl<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> int <span class="main">(</span>nat <span class="main">(</span><span class="main">(</span><span class="main">(</span>fst <span class="free">x</span> <span class="keyword1">mod</span> int <span class="free">m</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>snd <span class="free">y</span> <span class="keyword1">mod</span> int <span class="free">m</span><span class="main">)</span> <span class="main">+</span>
                <span class="main">(</span>snd <span class="free">x</span> <span class="keyword1">mod</span> int <span class="free">m</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>fst <span class="free">y</span> <span class="keyword1">mod</span> int <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> m <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> of_nat_nat<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> int <span class="main">(</span>nat <span class="main">(</span>fst <span class="free">x</span> <span class="keyword1">mod</span> int <span class="free">m</span><span class="main">)</span> <span class="main">*</span> nat <span class="main">(</span>snd <span class="free">y</span> <span class="keyword1">mod</span> int <span class="free">m</span><span class="main">)</span> <span class="main">+</span>
                    <span class="main">(</span>nat <span class="main">(</span>snd <span class="free">x</span> <span class="keyword1">mod</span> int <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> nat <span class="main">(</span>fst <span class="free">y</span> <span class="keyword1">mod</span> int <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> m <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nat <span class="main">…</span> <span class="main">=</span> <span class="main">(</span>nat <span class="main">(</span>fst <span class="free">x</span> <span class="keyword1">mod</span> int <span class="free">m</span><span class="main">)</span> <span class="main">*</span> nat <span class="main">(</span>snd <span class="free">y</span> <span class="keyword1">mod</span> int <span class="free">m</span><span class="main">)</span> <span class="main">+</span>
               nat <span class="main">(</span>snd <span class="free">x</span> <span class="keyword1">mod</span> int <span class="free">m</span><span class="main">)</span> <span class="main">*</span> nat <span class="main">(</span>fst <span class="free">y</span> <span class="keyword1">mod</span> int <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> m <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> nat_int zmod_int<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> snd <span class="main">(</span><span class="var">?mul2</span> <span class="main">(</span><span class="var">?φ</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="var">?φ</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lucas_lehmer_hom_def lucas_lehmer_mult_def case_prod_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="var">?φ</span> <span class="main">(</span><span class="var">?mul1</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span><span class="var">?mul2</span> <span class="main">(</span><span class="var">?φ</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="var">?φ</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lucas_lehmer_hom_1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lucas_lehmer_hom <span class="free">m</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> m <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lucas_lehmer_hom_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ring_hom_lucas_lehmer_hom<span class="main">:</span>
  <span class="quoted"><span class="quoted">"lucas_lehmer_hom <span class="free">m</span> <span class="main">∈</span> ring_hom lucas_lehmer_ring <span class="main">(</span>lucas_lehmer_ring_mod <span class="free">m</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> R<span class="main">:</span> cring <span class="quoted">lucas_lehmer_ring</span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">from</span></span> m <span class="keyword1"><span class="command">interpret</span></span> S<span class="main">:</span> cring <span class="quoted"><span class="quoted">"lucas_lehmer_ring_mod <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ring_hom_def <span class="keyword1"><span class="command">using</span></span> lucas_lehmer_hom_in_carrier m
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lucas_lehmer_ring_mod_def lucas_lehmer_hom_add
                   lucas_lehmer_ring_def lucas_lehmer_hom_mult<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Correctness of the Lucas--Lehmer test›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In this section, we will prove that the Lucas--Lehmer test is both a necessary and sufficient
  condition for the primality of a Mersenne number of the form $2^p - 1$ for an odd prime $p$.
  The proof that shall be given here is rather explicit and heavily draws from the Wikipedia
  article on the Lucas--Lehmer test~\cite{wiki:lucas_lehmer}.

  A shorter and more high-level proof of a more general statement can be obtained using more
  theory on finite fields (in particular the field $\text{GF}(q^2)$ (cf.\ e.\,g.\ 
  Rödseth~\cite{roedseth94}).
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lucas_lehmer_test</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lucas_lehmer_test</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">&gt;</span> <span class="numeral">2</span> <span class="main">∧</span>
     <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">dvd</span> gen_lucas_lehmer_sequence <span class="numeral">4</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We can now prove that any Mersenne number $2^p - 1$ for $p$ prime that passes the 
  Lucas--Lehmer test is prime. We follow the simple argument given by Bruce~\cite{bruce93},
  which is also given on Wikipedia~\cite{wiki:lucas_lehmer}.
›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> lucas_lehmer_sufficient<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"odd <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">dvd</span> gen_lucas_lehmer_sequence <span class="numeral">4</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"prime <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> not_prime<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>prime <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="main">::</span> <span class="quoted">int</span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"gen_lucas_lehmer_sequence <span class="numeral">4</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">k</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> dvdE<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mult_ac<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&gt;</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> odd_prime_gt_2_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">&gt;</span> <span class="numeral">2</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">≥</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="numeral">3</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> power_increasing<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">≥</span> <span class="main">(</span><span class="numeral">8</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> Min <span class="main">(</span>prime_factors <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> prime_factors <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">≥</span> <span class="numeral">8</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> q_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Min_in<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prime_factorization_empty_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="skolem">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_prime_factors_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> q_minimal<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">≤</span> <span class="skolem">q'</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">∈</span> prime_factors <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">q'</span>
    <span class="keyword1"><span class="command">unfolding</span></span> q_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Min_le<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> that <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span> <span class="main">≥</span> <span class="skolem">q</span> <span class="main">^</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> q <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="skolem">q</span> <span class="main">*</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prime_factorization <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">≠</span> <span class="main">{#</span><span class="skolem">q</span><span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"prime_factorization <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">=</span> <span class="main">{#</span><span class="skolem">q</span><span class="main">#}</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> prod_mset <span class="main">(</span>prime_factorization <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">≥</span> <span class="numeral">8</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> prod_mset_prime_factorization_nat<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> *<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> not_prime q <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"prime_factorization <span class="skolem">k</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> q k <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">≥</span> <span class="numeral">8</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> k<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> prime_factorization_mult<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Nat.gr0I <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prime_factorization_prime<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≠</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prime_factorization_empty_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> q'<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="skolem">q'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="keyword1">dvd</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prime_factor_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> q' k <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">≥</span> <span class="numeral">8</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">≤</span> <span class="skolem">q'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> q_minimal<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_prime_factors_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Nat.gr0I<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="skolem">q</span> <span class="main">*</span> <span class="skolem">q'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> power2_eq_square <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_mono<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">*</span> <span class="skolem">q'</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> q q' k <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">≥</span> <span class="numeral">8</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> dvd_imp_le<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Nat.gr0I<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span> <span class="main">≥</span> <span class="skolem">q</span> <span class="main">^</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">≠</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> q <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">&gt;</span> <span class="numeral">2</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> q <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">≠</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">&gt;</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">write</span></span> lucas_lehmer_ring <span class="main">(</span><span class="quoted">"<span class="keyword1">R</span>"</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> lucas_lehmer_ring_mod <span class="skolem">q</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">S'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S'</span> <span class="main">=</span> units_of <span class="skolem">S</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">φ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">=</span> lucas_lehmer_hom <span class="skolem">q</span>"</span></span>

  <span class="keyword1"><span class="command">interpret</span></span> R<span class="main">:</span> cring <span class="quoted"><span class="keyword1">R</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> S<span class="main">:</span> cring <span class="quoted"><span class="skolem">S</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> S_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cring_lucas_lehmer_ring_mod<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> <span class="quoted"><span class="quoted">‹<span class="skolem">q</span> <span class="main">&gt;</span> <span class="numeral">2</span>›</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> S'<span class="main">:</span> comm_group <span class="quoted"><span class="skolem">S'</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> S'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> S.units_comm_group<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">∈</span> ring_hom <span class="keyword1">R</span> <span class="skolem">S</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> φ_def S_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ring_hom_lucas_lehmer_hom<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> <span class="quoted"><span class="quoted">‹<span class="skolem">q</span> <span class="main">&gt;</span> <span class="numeral">2</span>›</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> φ<span class="main">:</span> ring_hom_cring <span class="quoted"><span class="keyword1">R</span></span> <span class="quoted"><span class="skolem">S</span></span> <span class="quoted"><span class="skolem">φ</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="operator">fact</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span> <span class="main">+</span> sqrt <span class="numeral">3</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">-</span> sqrt <span class="numeral">3</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
          real_of_int <span class="main">(</span>gen_lucas_lehmer_sequence <span class="numeral">4</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> gen_lucas_lehmer_sequence_4_closed_form1 <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> real_of_int <span class="skolem">k</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> k<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span> <span class="main">+</span> sqrt <span class="numeral">3</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                     real_of_int <span class="skolem">k</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">-</span> sqrt <span class="numeral">3</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="numeral">2</span> <span class="main">+</span> sqrt <span class="numeral">3</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">=</span>
             real_of_int <span class="skolem">k</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">+</span> sqrt <span class="numeral">3</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span>
             <span class="main">(</span><span class="numeral">2</span> <span class="main">-</span> sqrt <span class="numeral">3</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">+</span> sqrt <span class="numeral">3</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> power2_eq_square <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> *<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="numeral">2</span> <span class="main">+</span> sqrt <span class="numeral">3</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">+</span> sqrt <span class="numeral">3</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> power_mult <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_ac<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>Suc <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">&gt;</span> <span class="numeral">2</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span> <span class="main">-</span> sqrt <span class="numeral">3</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">+</span> sqrt <span class="numeral">3</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> power_mult_distrib <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span> <span class="main">+</span> sqrt <span class="numeral">3</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                  real_of_int <span class="skolem">k</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">+</span> sqrt <span class="numeral">3</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span> <span class="main">+</span> sqrt <span class="numeral">3</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
               lucas_lehmer_to_real <span class="main">(</span><span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lucas_lehmer_to_real_simps<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real_of_int <span class="skolem">k</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">+</span> sqrt <span class="numeral">3</span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span>
               lucas_lehmer_to_real <span class="main">(</span><span class="main">(</span><span class="skolem">k</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">⊗</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span>
                 <span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">⊕</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">⊖</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">𝟭</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lucas_lehmer_to_real_simps<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                <span class="main">(</span><span class="main">(</span><span class="skolem">k</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">⊗</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">⊕</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">⊖</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">𝟭</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> injD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> lucas_lehmer_to_real_inj<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">(</span><span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span> <span class="main">=</span>
           <span class="skolem">φ</span> <span class="main">(</span><span class="main">(</span><span class="skolem">k</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">⊗</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">⊕</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">⊖</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">𝟭</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">(</span><span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">φ</span> <span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"int <span class="skolem">q</span> <span class="keyword1">dvd</span> int <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> int_dvd_int_iff<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> q <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"int <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> of_nat_diff<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">𝟬</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> φ_def lucas_lehmer_hom_def S_def lucas_lehmer_ring_mod_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">(</span><span class="main">(</span><span class="skolem">k</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">⊗</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">⊕</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">⊖</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">𝟭</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span><span class="main">)</span> <span class="main">=</span> 
           <span class="main">⊖</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">𝟭</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">=</span> <span class="main">⊖</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">𝟭</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">=</span> <span class="skolem">φ</span> <span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">&gt;</span> <span class="numeral">2</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mult_ac<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">φ</span> <span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="numeral">2</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> S.nat_pow_pow<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">𝟭</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> eq<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> numeral_2_eq_2 S.l_minus<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> eq'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">=</span> <span class="main">𝟭</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">from</span></span> eq' <span class="keyword1"><span class="command">have</span></span> unit<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span> <span class="main">∈</span> Units <span class="skolem">S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> S.pow_nat_eq_1_imp_unit<span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> neg_one_not_one<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊖</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">𝟭</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">≠</span> <span class="main">𝟭</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊖</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">𝟭</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">=</span> <span class="main">𝟭</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⊖</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">𝟭</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span><span class="main">)</span> <span class="main">⊕</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">𝟭</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">=</span> <span class="main">𝟬</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> S.l_neg<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">𝟭</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">⊕</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">𝟭</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">=</span> <span class="main">𝟬</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> *<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">q</span> <span class="main">&gt;</span> <span class="numeral">2</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> S_def lucas_lehmer_ring_mod_def lucas_lehmer_add_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>Units <span class="skolem">S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"carrier <span class="skolem"><span class="skolem"><span class="skolem">S</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Units_def S_def lucas_lehmer_ring_mod_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"group.ord <span class="skolem">S'</span> <span class="main">(</span><span class="skolem">φ</span> <span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">&gt;</span> <span class="numeral">2</span>›</span></span> eq eq' unit neg_one_not_one
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> S'.ord_eqI_prime_factors<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prime_factors_power prime_factorization_prime
                   S'_def S.units_of_pow units_of_carrier units_of_one power_diff<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> group.ord <span class="skolem">S'</span> <span class="main">(</span><span class="skolem">φ</span> <span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> card <span class="main">(</span>generate <span class="skolem">S'</span> <span class="main">{</span><span class="skolem">φ</span> <span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> unit fin
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> S'.generate_pow_card<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> S'_def units_of_carrier<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> card <span class="main">(</span>carrier <span class="skolem">S'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fin unit <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> card_mono S'.generate_incl<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> S'_def units_of_carrier<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="skolem">q</span> <span class="main">^</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> S'_def S_def <span class="keyword1"><span class="command">using</span></span> card_lucas_lehmer_Units<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">q</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">q</span> <span class="main">&gt;</span> <span class="numeral">2</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> units_of_carrier<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">q</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span>›</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Next, we show that any Mersenne prime passes the Lucas--Lehmer test. We again follow the
  rather explicit proof outlined on Wikipedia~\cite{wiki:lucas_lehmer}, which is a simplified
  (but less general and less abstract) version of the proof by Rödseth~\cite{roedseth94}.
›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> mersenne_prime<span class="main">)</span> lucas_lehmer_necessary<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">dvd</span> gen_lucas_lehmer_sequence <span class="numeral">4</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">write</span></span> lucas_lehmer_ring <span class="main">(</span><span class="quoted">"<span class="keyword1">R</span>"</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> lucas_lehmer_ring_mod <span class="free">M</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">S'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S'</span> <span class="main">=</span> units_of <span class="skolem">S</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">φ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">=</span> lucas_lehmer_hom <span class="free">M</span>"</span></span>

  <span class="keyword1"><span class="command">interpret</span></span> R<span class="main">:</span> cring <span class="quoted"><span class="keyword1">R</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> S<span class="main">:</span> cring <span class="quoted"><span class="skolem">S</span></span> <span class="keyword1"><span class="command">unfolding</span></span> S_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cring_lucas_lehmer_ring_mod<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> M_gt_6 <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> S'<span class="main">:</span> comm_group <span class="quoted"><span class="skolem">S'</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> S'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> S.units_comm_group<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">∈</span> ring_hom <span class="keyword1">R</span> <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> φ_def S_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ring_hom_lucas_lehmer_hom<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> M_gt_6 <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> φ<span class="main">:</span> ring_hom_cring <span class="quoted"><span class="keyword1">R</span></span> <span class="quoted"><span class="skolem">S</span></span> <span class="quoted"><span class="skolem">φ</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="operator">fact</span>

  <span class="keyword1"><span class="command">have</span></span> R_pow_int<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="skolem">m</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">^</span> <span class="skolem">m</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span> <span class="main">::</span> <span class="quoted">int</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">m</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">m</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lucas_lehmer_ring_def lucas_lehmer_mult'_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"add_pow <span class="keyword1">R</span> <span class="skolem">n</span> <span class="main">𝟭</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">=</span> <span class="main">(</span>int <span class="skolem">n</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">n</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lucas_lehmer_ring_def lucas_lehmer_add'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"add_pow <span class="keyword1">R</span> <span class="free">M</span> <span class="main">𝟭</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">=</span> <span class="main">(</span>int <span class="free">M</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">…</span> <span class="main">=</span> <span class="main">𝟬</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> φ_def S_def lucas_lehmer_ring_mod_def lucas_lehmer_hom_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"add_pow <span class="skolem">S</span> <span class="free">M</span> <span class="main">𝟭</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">=</span> <span class="main">𝟬</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> φ.hom_add_pow_nat<span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">×</span> int"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> eq1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">(</span><span class="main">(</span><span class="numeral">6</span><span class="main">,</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">M</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">φ</span> <span class="main">(</span><span class="numeral">6</span><span class="main">,</span> <span class="main">-</span><span class="numeral">2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">6</span><span class="main">,</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">6</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">⊕</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="skolem">σ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lucas_lehmer_ring_def σ_def lucas_lehmer_add'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">(</span><span class="main">…</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">M</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">φ</span> <span class="main">(</span><span class="main">(</span><span class="numeral">6</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">M</span><span class="main">)</span> <span class="main">⊕</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="skolem">φ</span> <span class="main">(</span><span class="skolem">σ</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">M</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prime <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹add_pow <span class="skolem">S</span> <span class="free">M</span> <span class="main">𝟭</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">=</span> <span class="main">𝟬</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S.binomial_finite_char<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">6</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">M</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">6</span> <span class="main">^</span> <span class="free">M</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R_pow_int<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="numeral">6</span> <span class="main">^</span> <span class="free">M</span> <span class="main">=</span> <span class="numeral">6</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="main">(</span>int <span class="free">M</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> M_gt_6
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> little_Fermat_int<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> prime <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main">:</span> dvd_nat_abs_iff›</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">(</span><span class="numeral">6</span> <span class="main">^</span> <span class="free">M</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">φ</span> <span class="main">(</span><span class="numeral">6</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> φ_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> lucas_lehmer_hom_cong<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">⊗</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> σ_def lucas_lehmer_ring_def lucas_lehmer_mult'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">(</span><span class="skolem">σ</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">M</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">φ</span> <span class="main">(</span><span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">M</span> <span class="main">⊗</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">M</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> R.nat_pow_distrib <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">φ</span> <span class="main">(</span><span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">M</span><span class="main">)</span> <span class="main">⊗</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="skolem">φ</span> <span class="main">(</span><span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">M</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">M</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">M</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R_pow_int<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">M</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> int <span class="free">M</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> M_gt_6 prime
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> little_Fermat_int<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> dvd_nat_abs_iff <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dvd_imp_le<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">M</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">φ</span> <span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> φ_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> lucas_lehmer_hom_cong<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> M_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> Suc <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">M</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> M_odd <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">M</span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span> <span class="main">⊗</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="numeral">2</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="main">(</span><span class="free">M</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> M_eq<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> R.nat_pow_mult R.nat_pow_pow R.cring_simprules<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="numeral">2</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">3</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_nat_numeral<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lucas_lehmer_ring_def lucas_lehmer_mult'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">(</span><span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span> <span class="main">⊗</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="numeral">3</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="main">(</span><span class="free">M</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
                 <span class="skolem">φ</span> <span class="main">(</span><span class="main">(</span><span class="numeral">3</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="main">(</span><span class="free">M</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">⊗</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="skolem">φ</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S.cring_simprules<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">3</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="main">(</span><span class="free">M</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">^</span> <span class="main">(</span><span class="main">(</span><span class="free">M</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R_pow_int<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">^</span> <span class="main">(</span><span class="main">(</span><span class="free">M</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">φ</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> φ_def
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> lucas_lehmer_hom_cong'<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="numeral">3</span> <span class="main">^</span> <span class="main">(</span><span class="main">(</span><span class="free">M</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> Legendre <span class="numeral">3</span> <span class="free">M</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> int <span class="free">M</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cong_sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> euler_criterion<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> prime M_gt_6 <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="numeral">3</span> <span class="main">^</span> <span class="main">(</span><span class="main">(</span><span class="free">M</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> int <span class="free">M</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Legendre_3_M<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">⊗</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="skolem">φ</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">⊗</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="skolem">φ</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">φ</span> <span class="main">(</span><span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">⊗</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">⊗</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R.cring_simprules S.cring_simprules<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">(</span><span class="numeral">6</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">⊕</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="skolem">φ</span> <span class="main">(</span><span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">⊗</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">⊗</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                 <span class="skolem">φ</span> <span class="main">(</span><span class="main">(</span><span class="numeral">6</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">⊕</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">⊗</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">⊗</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">φ</span> <span class="main">(</span><span class="numeral">6</span><span class="main">,</span> <span class="main">-</span><span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> φ_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> lucas_lehmer_hom_cong<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lucas_lehmer_ring_def lucas_lehmer_mult'_def lucas_lehmer_add'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">(</span><span class="main">(</span><span class="numeral">6</span><span class="main">,</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">M</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">φ</span> <span class="main">(</span><span class="numeral">6</span><span class="main">,</span> <span class="main">-</span><span class="numeral">2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R.cring_simprules S.cring_simprules<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> eq2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">(</span><span class="main">(</span><span class="numeral">24</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="main">(</span><span class="free">M</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">⊖</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">𝟭</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">24</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="numeral">3</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">⊗</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="numeral">3</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_nat_numeral<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lucas_lehmer_ring_def lucas_lehmer_mult'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="main">(</span><span class="free">M</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span>
                 <span class="main">(</span><span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="main">(</span><span class="free">M</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="numeral">3</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">⊗</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="numeral">3</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="main">(</span><span class="free">M</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R.cring_simprules R.nat_pow_distrib R.nat_pow_pow mult_ac<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">φ</span> <span class="main">(</span><span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="main">(</span><span class="free">M</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="numeral">3</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">⊗</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> 
                      <span class="skolem">φ</span> <span class="main">(</span><span class="main">(</span><span class="numeral">3</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="main">(</span><span class="free">M</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="main">(</span><span class="free">M</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="main">(</span><span class="free">M</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R_pow_int<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">…</span> <span class="main">=</span> <span class="skolem">φ</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> φ_def
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> lucas_lehmer_hom_cong'<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="main">(</span><span class="free">M</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> Legendre <span class="numeral">2</span> <span class="free">M</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> int <span class="free">M</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cong_sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> euler_criterion<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> prime M_gt_6 <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="main">(</span><span class="free">M</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> int <span class="free">M</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Legendre_2_M <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">𝟭</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lucas_lehmer_ring_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">3</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="main">(</span><span class="free">M</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">^</span> <span class="main">(</span><span class="main">(</span><span class="free">M</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R_pow_int<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">…</span> <span class="main">=</span> <span class="skolem">φ</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> φ_def
    <span class="keyword1"><span class="command">proof</span></span>  <span class="main">(</span><span class="operator">intro</span> lucas_lehmer_hom_cong'<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="numeral">3</span> <span class="main">^</span> <span class="main">(</span><span class="main">(</span><span class="free">M</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> Legendre <span class="numeral">3</span> <span class="free">M</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> int <span class="free">M</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cong_sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> euler_criterion<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> prime M_gt_6 <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="numeral">3</span> <span class="main">^</span> <span class="main">(</span><span class="main">(</span><span class="free">M</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> int <span class="free">M</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Legendre_3_M <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">⊖</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">𝟭</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> minus_lucas_lehmer_ring <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lucas_lehmer_ring_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">(</span><span class="main">(</span><span class="numeral">24</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="main">(</span><span class="free">M</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">⊖</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">𝟭</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ω</span></span> <span class="skolem"><span class="skolem">ω'</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">×</span> int"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ω</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ω'</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> eq3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">(</span><span class="skolem">ω</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">⊖</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">𝟭</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">=</span> Suc <span class="main">(</span><span class="main">(</span><span class="free">M</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> M_odd M_gt_6 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> oddE<span class="main">)</span>  
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">(</span><span class="main">(</span><span class="numeral">24</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">⊗</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="skolem">ω</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">φ</span> <span class="main">(</span><span class="main">(</span><span class="numeral">6</span><span class="main">,</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="numeral">2</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> φ_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> lucas_lehmer_hom_cong<span class="main">)</span>
         <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_nat_numeral<span class="main"><span class="keyword3">,</span></span>
          <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lucas_lehmer_ring_def lucas_lehmer_mult'_def ω_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">(</span><span class="main">⊖</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">𝟭</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span><span class="main">)</span> <span class="main">⊗</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="skolem">φ</span> <span class="main">(</span><span class="main">(</span><span class="numeral">24</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">⊗</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="skolem">ω</span><span class="main">)</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span>
            <span class="skolem">φ</span> <span class="main">(</span><span class="main">⊖</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">𝟭</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span><span class="main">)</span> <span class="main">⊗</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="skolem">φ</span> <span class="main">(</span><span class="main">(</span><span class="numeral">6</span><span class="main">,</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="numeral">2</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> *<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">(</span><span class="main">⊖</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">𝟭</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span><span class="main">)</span> <span class="main">⊗</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="skolem">φ</span> <span class="main">(</span><span class="main">(</span><span class="numeral">24</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">⊗</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="skolem">φ</span> <span class="main">(</span><span class="skolem">ω</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
            <span class="skolem">φ</span> <span class="main">(</span><span class="main">⊖</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">𝟭</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span><span class="main">)</span> <span class="main">⊗</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="skolem">φ</span> <span class="main">(</span><span class="main">(</span><span class="numeral">6</span><span class="main">,</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> R.nat_pow_distrib S.nat_pow_distrib R.nat_pow_pow
                    S.nat_pow_pow R.cring_simprules S.cring_simprules<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="free">M</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> M_odd <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">(</span><span class="numeral">24</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">⊗</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="skolem">φ</span> <span class="main">(</span><span class="main">⊖</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">𝟭</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span><span class="main">)</span> <span class="main">⊗</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="skolem">φ</span> <span class="main">(</span><span class="main">(</span><span class="numeral">24</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="main">(</span><span class="free">M</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⊗</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> 
                    <span class="skolem">φ</span> <span class="main">(</span><span class="skolem">ω</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                  <span class="skolem">φ</span> <span class="main">(</span><span class="main">⊖</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">𝟭</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span><span class="main">)</span> <span class="main">⊗</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="skolem">φ</span> <span class="main">(</span><span class="numeral">6</span><span class="main">,</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">⊗</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="skolem">φ</span> <span class="main">(</span><span class="main">(</span><span class="numeral">6</span><span class="main">,</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">M</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">=</span> <span class="main">_</span>›</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S.cring_simprules R.cring_simprules<span class="main">)</span>
  
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">(</span><span class="main">(</span><span class="numeral">24</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="main">(</span><span class="free">M</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">⊖</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">𝟭</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> eq2<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">φ</span> <span class="main">(</span><span class="main">⊖</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">𝟭</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span><span class="main">)</span> <span class="main">⊗</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">⊖</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">𝟭</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span><span class="main">)</span> <span class="main">=</span> <span class="main">𝟭</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S.cring_simprules<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">(</span><span class="main">(</span><span class="numeral">6</span><span class="main">,</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="free">M</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">φ</span> <span class="main">(</span><span class="numeral">6</span><span class="main">,</span> <span class="main">-</span><span class="numeral">2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> eq1<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">(</span><span class="numeral">6</span><span class="main">,</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">⊗</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="skolem">φ</span> <span class="main">(</span><span class="numeral">6</span><span class="main">,</span> <span class="main">-</span><span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">φ</span> <span class="main">(</span><span class="main">(</span><span class="numeral">6</span><span class="main">,</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">⊗</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="numeral">6</span><span class="main">,</span> <span class="main">-</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">φ</span> <span class="main">(</span><span class="numeral">24</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> φ_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> lucas_lehmer_hom_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lucas_lehmer_ring_def lucas_lehmer_mult'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">(</span><span class="numeral">24</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">⊗</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="skolem">φ</span> <span class="main">(</span><span class="skolem">ω</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                  <span class="skolem">φ</span> <span class="main">(</span><span class="numeral">24</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">⊗</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="skolem">φ</span> <span class="main">(</span><span class="main">⊖</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">𝟭</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S.cring_simprules<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">(</span><span class="numeral">24</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">24</span> <span class="keyword1">mod</span> <span class="free">M</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> φ_def lucas_lehmer_hom_def nat_mod_as_int<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">24</span> <span class="keyword1">mod</span> <span class="free">M</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">⊗</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="skolem">φ</span> <span class="main">(</span><span class="skolem">ω</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                  <span class="main">(</span><span class="numeral">24</span> <span class="keyword1">mod</span> <span class="free">M</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">⊗</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="skolem">φ</span> <span class="main">(</span><span class="main">⊖</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">𝟭</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">24</span> <span class="keyword1">mod</span> <span class="free">M</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">∈</span> Units <span class="skolem">S</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> S_def <span class="keyword1"><span class="command">using</span></span> M_gt_6 prime M_not_dvd_24
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> int_in_Units_lucas_lehmer_ring_mod<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dvd_mod_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Nat.gr0I<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">(</span><span class="skolem">ω</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">⊖</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">𝟭</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> S.Units_l_cancel<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> eq4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">(</span><span class="skolem">ω</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">⊕</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="skolem">ω'</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">𝟬</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="var">?lhs</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">(</span><span class="skolem">ω</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">⊗</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="skolem">φ</span> <span class="main">(</span><span class="skolem">ω'</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">4</span><span class="main">)</span><span class="main">)</span> <span class="main">⊕</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span>
            <span class="skolem">φ</span> <span class="main">(</span><span class="skolem">ω'</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">4</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">𝟬</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> eq3<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> S.cring_simprules<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> <span class="numeral">2</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> le_imp_power_dvd<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> p_gt_2 <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">4</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> M_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">=</span> <span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">4</span> <span class="main">+</span> <span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">4</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">(</span><span class="skolem">ω</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">…</span><span class="main">)</span> <span class="main">⊗</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="skolem">φ</span> <span class="main">(</span><span class="skolem">ω'</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">4</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
               <span class="skolem">φ</span> <span class="main">(</span><span class="skolem">ω</span> <span class="main">⊗</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="skolem">ω'</span><span class="main">)</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">4</span><span class="main">)</span> <span class="main">⊗</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span> <span class="skolem">φ</span> <span class="main">(</span><span class="skolem">ω</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">4</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S.cring_simprules S.nat_pow_distrib <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> S.nat_pow_mult<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">(</span><span class="skolem">ω</span> <span class="main">⊗</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="skolem">ω'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">φ</span> <span class="main">𝟭</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> φ_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> lucas_lehmer_hom_cong<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ω_def ω'_def lucas_lehmer_ring_def lucas_lehmer_mult'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">4</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> p_gt_2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> M_def power_diff<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> eq4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">(</span><span class="skolem">ω</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">⊕</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="skolem">ω'</span> <span class="main">[^]</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="keyword1">R</span><span class="main"><span class="hidden">⇙</span></span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">𝟬</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="var">?lhs</span> <span class="main">=</span> <span class="main">𝟬</span><span class="main"><span class="hidden">⇘</span><sub></sub></span><span class="skolem">S</span><span class="main"><span class="hidden">⇙</span></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eq4<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lucas_lehmer_to_real <span class="var">?lhs</span> <span class="main">=</span>
             lucas_lehmer_to_real <span class="main">(</span>gen_lucas_lehmer_sequence <span class="numeral">4</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ω_def ω'_def lucas_lehmer_to_real_simps gen_lucas_lehmer_sequence_4_closed_form1<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="main">(</span>gen_lucas_lehmer_sequence <span class="numeral">4</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> injD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> lucas_lehmer_to_real_inj<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gen_lucas_lehmer_sequence <span class="numeral">4</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">M</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> M_gt_6
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> φ_def lucas_lehmer_hom_def S_def lucas_lehmer_ring_mod_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">dvd</span> gen_lucas_lehmer_sequence <span class="numeral">4</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> M_def mod_eq_0_iff_dvd of_nat_diff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> lucas_lehmer_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"prime <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">⟷</span>
     prime <span class="free">p</span> <span class="main">∧</span> <span class="main">(</span><span class="free">p</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">∨</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">dvd</span> gen_lucas_lehmer_sequence <span class="numeral">4</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> iffI<span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">elim</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> prime<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> prime <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Nat.gr0I<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">∨</span> <span class="free">p</span> <span class="main">&gt;</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span> <span class="main">∧</span> <span class="main">(</span><span class="free">p</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">∨</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">dvd</span> gen_lucas_lehmer_sequence <span class="numeral">4</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&gt;</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> prime <span class="keyword1"><span class="command">interpret</span></span> mersenne_prime <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
    <span class="keyword1"><span class="command">from</span></span> lucas_lehmer_necessary p_prime <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> prime<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">∨</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">dvd</span> gen_lucas_lehmer_sequence <span class="numeral">4</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="numeral">2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">dvd</span> gen_lucas_lehmer_sequence <span class="numeral">4</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"prime <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">dvd</span> gen_lucas_lehmer_sequence <span class="numeral">4</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹prime <span class="free">p</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">≠</span> <span class="numeral">2</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&gt;</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prime_gt_1_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> prime <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"odd <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prime_odd_nat<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> prime dvd <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>      
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> lucas_lehmer_sufficient<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> lucas_lehmer_correct'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"prime <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">⟷</span> prime <span class="free">p</span> <span class="main">∧</span> <span class="main">(</span><span class="free">p</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">∨</span> lucas_lehmer_test <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lucas_lehmer_correct<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> prime_gt_1_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lucas_lehmer_test_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹A first executable version Lucas--Lehmer test›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following is an implementation of the Lucas--Lehmer test using modular
  arithmetic on the integers. This is not the most efficient implementation --
  the modular arithmetic can be replaced by much cheaper bitwise operations,
  and we will do that in the next section.
›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">gen_lucas_lehmer_sequence'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> int <span class="main">⇒</span> nat <span class="main">⇒</span> int"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gen_lucas_lehmer_sequence'</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">0</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">gen_lucas_lehmer_sequence'</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">gen_lucas_lehmer_sequence'</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gen_lucas_lehmer_sequence'_Suc'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"gen_lucas_lehmer_sequence' <span class="free">m</span> <span class="free">a</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>gen_lucas_lehmer_sequence' <span class="free">m</span> <span class="free">a</span> <span class="free">n</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> gen_lucas_lehmer_sequence'_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"gen_lucas_lehmer_sequence' <span class="free">m</span> <span class="free">a</span> <span class="free">n</span> <span class="main">=</span> gen_lucas_lehmer_sequence <span class="free">a</span> <span class="free">n</span> <span class="keyword1">mod</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gen_lucas_lehmer_sequence' <span class="free">m</span> <span class="free">a</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span>
          <span class="main">(</span><span class="main">(</span>gen_lucas_lehmer_sequence <span class="free">a</span> <span class="skolem">n</span> <span class="keyword1">mod</span> <span class="free">m</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">unfolding</span></span> gen_lucas_lehmer_sequence'_Suc' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>gen_lucas_lehmer_sequence <span class="free">a</span> <span class="skolem">n</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> congD cong_diff cong_pow cong_refl<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> lucas_lehmer_test_code_arithmetic <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lucas_lehmer_test <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="free">p</span> <span class="main">&gt;</span> <span class="numeral">2</span> <span class="main">∧</span>
     gen_lucas_lehmer_sequence' <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="numeral">4</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lucas_lehmer_test_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conj_cong refl<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&gt;</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">≥</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="numeral">3</span> <span class="main">::</span> int<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> power_increasing<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">dvd</span> gen_lucas_lehmer_sequence <span class="numeral">4</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span>
          gen_lucas_lehmer_sequence <span class="numeral">4</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gen_lucas_lehmer_sequence <span class="numeral">4</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span>
             gen_lucas_lehmer_sequence' <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="numeral">4</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">≥</span> <span class="numeral">2</span> <span class="main">^</span> <span class="numeral">3</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> gen_lucas_lehmer_sequence'_correct <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">dvd</span> gen_lucas_lehmer_sequence <span class="numeral">4</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                <span class="main">(</span>gen_lucas_lehmer_sequence' <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="numeral">4</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mersenne_prime_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"mersenne_prime <span class="free">p</span> <span class="main">⟷</span> <span class="free">p</span> <span class="main">&gt;</span> <span class="numeral">2</span> <span class="main">∧</span> prime <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mersenne_prime_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mersenne_prime_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"mersenne_prime <span class="free">p</span> <span class="main">⟷</span> prime <span class="free">p</span> <span class="main">∧</span> lucas_lehmer_test <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mersenne_prime_iff <span class="keyword1"><span class="command">using</span></span> lucas_lehmer_correct'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lucas_lehmer_test_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Lucas_Lehmer_Code">
<div class="head">
<h1>Theory Lucas_Lehmer_Code</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Efficient code for testing Mersenne primes›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Lucas_Lehmer_Code
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Lucas_Lehmer.html">Lucas_Lehmer</a>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Code_Target_Numeral.html">HOL-Library.Code_Target_Numeral</a>"</span>
  <span class="quoted">"<a href="../Native_Word/Code_Target_Bits_Int.html">Native_Word.Code_Target_Bits_Int</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Efficient computation of remainders modulo a Mersenne number›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We have $k = k\ \text{mod}\ 2^n + k\ \text{div}\ 2^n\ \ (\text{mod}\ (2^n - 1))$,
  and $k\ \text{mod}\ 2^n = k\, \&amp;\, (2^n - 1)$ and $k\ \text{div}\ 2^n = k \gg n$.
  Therefore, we can reduce $k$ modulo $2^n - 1$ using only bitwise operations, addition, and
  bit shifts. 
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> cong_mersenne_number_int<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">k</span> <span class="main">::</span> <span class="quoted">int</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">k</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span> <span class="main">+</span> <span class="free">k</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">k</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">k</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cong_add cong_mult cong_refl<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cong_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_sym add_ac<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We encapsulate a single reduction step in the following operation. Note, however,
  that the result is not, in general, the same as $k\ \text{mod}\ (2^n - 1)$. Multiple 
  reductions might be required in order to reduce it below $2^n$, and a multiple of $2 ^ n - 1$
  can be reduced to $2 ^ n - 1$, which is invariant to further reduction steps.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mersenne_mod</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> nat <span class="main">⇒</span> int"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mersenne_mod</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mersenne_mod_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"mersenne_mod <span class="free">k</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="free">k</span> <span class="keyword1">AND</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">&lt;&lt;</span> <span class="free">n</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">k</span> <span class="main">&gt;&gt;</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mersenne_mod_def shiftr_int_def shiftl_int_def AND_mod<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> cong_mersenne_mod<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>mersenne_mod <span class="free">k</span> <span class="free">n</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mersenne_mod_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cong_mersenne_number_int<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mersenne_mod_nonneg <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span> mersenne_mod <span class="free">k</span> <span class="free">n</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mersenne_mod_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> add_nonneg_nonneg<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pos_imp_zdiv_nonneg_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mersenne_mod_less<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≥</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"mersenne_mod <span class="free">k</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mersenne_mod <span class="free">k</span> <span class="free">n</span> <span class="main">=</span> <span class="free">k</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span> <span class="main">+</span> <span class="free">k</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mersenne_mod_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span> <span class="main">+</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">k</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span> <span class="main">+</span> <span class="free">k</span> <span class="keyword1">mod</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> add_mono<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">k</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> mult.commute<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">m</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> power_add<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mersenne_mod_less'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="numeral">5</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"mersenne_mod <span class="free">k</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span> <span class="main">+</span> <span class="numeral">5</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mersenne_mod <span class="free">k</span> <span class="free">n</span> <span class="main">=</span> <span class="free">k</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span> <span class="main">+</span> <span class="free">k</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mersenne_mod_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span> <span class="main">+</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">k</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span> <span class="main">+</span> <span class="free">k</span> <span class="keyword1">mod</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> add_mono<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">k</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> mult.commute<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">5</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span> <span class="main">≤</span> <span class="numeral">5</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  It turns out that for our use case, a single reduction is not enough to reduce
  the number in question enough (or at least I was unable to prove that it is). We
  therefore perform two reduction steps, which is enough to guarantee that our numbers
  are below $2^n + 4$ before and after every step in the Lucas--Lehmer sequence.

  Whether one or two reductions are performed is not very important anyway, since the
  dominant step is the squaring anyway.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mersenne_mod2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> nat <span class="main">⇒</span> int"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mersenne_mod2</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> mersenne_mod <span class="main">(</span>mersenne_mod <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cong_mersenne_mod2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>mersenne_mod2 <span class="free">k</span> <span class="free">n</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mersenne_mod2_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cong_trans<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> cong_mersenne_mod<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mersenne_mod2_nonneg <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span> mersenne_mod2 <span class="free">k</span> <span class="free">n</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mersenne_mod2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> mersenne_mod2_less<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"mersenne_mod2 <span class="free">k</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span> <span class="main">+</span> <span class="numeral">5</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> <span class="numeral">3</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span> <span class="main">::</span> int<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> power_increasing<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span> <span class="main">≥</span> <span class="main">(</span><span class="numeral">8</span> <span class="main">::</span> int<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mersenne_mod <span class="free">k</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mersenne_mod_less<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">5</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_add<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mersenne_mod <span class="main">(</span>mersenne_mod <span class="free">k</span> <span class="free">n</span><span class="main">)</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">n</span> <span class="main">+</span> <span class="numeral">5</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mersenne_mod_less'<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mersenne_mod2_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Since we subtract 2 at one point, the intermediate results can become negative. This
  is not a problem since our reduction modulo $2 ^ p - 1$ happens to make them positive again
  immediately.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> mersenne_mod_nonneg_strong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">-</span><span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"mersenne_mod <span class="free">a</span> <span class="free">p</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eucl_rel_int <span class="free">a</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">,</span> <span class="free">a</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eucl_rel_int_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> <span class="free">a</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> div_int_unique mod_int_unique<span class="main">)</span> 
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"mersenne_mod <span class="free">a</span> <span class="free">p</span> <span class="main">=</span> <span class="free">a</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mersenne_mod_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> mersenne_mod2_nonneg_strong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">-</span><span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"mersenne_mod2 <span class="free">a</span> <span class="free">p</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mersenne_mod2_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mersenne_mod_nonneg<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> mersenne_mod_nonneg_strong<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Efficient code for the Lucas--Lehmer sequence›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">gen_lucas_lehmer_sequence''</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> int <span class="main">⇒</span> nat <span class="main">⇒</span> int"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gen_lucas_lehmer_sequence''</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">0</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">gen_lucas_lehmer_sequence''</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span>
     <span class="free">gen_lucas_lehmer_sequence''</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span>mersenne_mod2 <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gen_lucas_lehmer_sequence''_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">=</span> <span class="free">a'</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">[</span>gen_lucas_lehmer_sequence'' <span class="free">p</span> <span class="free">a</span> <span class="free">n</span> <span class="main">=</span> gen_lucas_lehmer_sequence <span class="free">a'</span> <span class="free">n</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">a'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span>mersenne_mod2 <span class="main">(</span><span class="skolem">a</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cong_mersenne_mod2<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">=</span> <span class="skolem">a'</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cong_pow cong_diff Suc.prems cong_refl<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span>gen_lucas_lehmer_sequence'' <span class="free">p</span> <span class="main">(</span>mersenne_mod2 <span class="main">(</span><span class="skolem">a</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">n</span> <span class="main">=</span>
                 gen_lucas_lehmer_sequence <span class="main">(</span><span class="skolem">a'</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">n</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Suc.IH<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> gen_lucas_lehmer_sequence.simps <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gen_lucas_lehmer_sequence_Suc'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> gen_lucas_lehmer_sequence''_bounds<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">+</span> <span class="numeral">5</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&gt;</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"gen_lucas_lehmer_sequence'' <span class="free">p</span> <span class="free">a</span> <span class="free">n</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">+</span> <span class="numeral">5</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Suc.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">&lt;</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">+</span> <span class="numeral">5</span><span class="main">)</span> <span class="main">^</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> power_strict_mono Suc.prems<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="free">p</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">^</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> power_increasing<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">3</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">::</span> int"</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">&gt;</span> <span class="numeral">2</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> power_mono<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">p</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> power_mult mult_ac<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">&gt;</span> <span class="numeral">2</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span><span class="main">)</span> <span class="main">≥</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="numeral">3</span> <span class="main">::</span> int<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> power_increasing<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">-</span><span class="numeral">2</span> <span class="main">::</span> int<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="numeral">2</span> <span class="main">≤</span> <span class="skolem">a</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">-</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mersenne_mod2 <span class="main">(</span><span class="skolem">a</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">p</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mersenne_mod2_nonneg_strong<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gen_lucas_lehmer_sequence'' <span class="free">p</span> <span class="main">(</span>mersenne_mod2 <span class="main">(</span><span class="skolem">a</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">n</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">+</span> <span class="numeral">5</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">&gt;</span> <span class="numeral">2</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Suc.IH mersenne_mod2_less<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Code for the Lucas--Lehmer test›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword">del</span><span class="main">]</span> <span class="main">=</span> lucas_lehmer_test_code_arithmetic

<span class="keyword1"><span class="command">lemma</span></span> lucas_lehmer_test_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lucas_lehmer_test <span class="free">p</span> <span class="main">=</span>
     <span class="main">(</span><span class="numeral">2</span> <span class="main">&lt;</span> <span class="free">p</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">x</span> <span class="main">=</span> gen_lucas_lehmer_sequence'' <span class="free">p</span> <span class="numeral">4</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">in</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">&lt;&lt;</span> <span class="free">p</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lucas_lehmer_test_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> conj_cong<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&gt;</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> gen_lucas_lehmer_sequence'' <span class="free">p</span> <span class="numeral">4</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">&gt;</span> <span class="numeral">2</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> <span class="numeral">3</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">::</span> int<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> power_increasing<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">≥</span> <span class="main">(</span><span class="numeral">8</span> <span class="main">::</span> int<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> bounds<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">+</span> <span class="numeral">5</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> x_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">&gt;</span> <span class="numeral">2</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> gen_lucas_lehmer_sequence''_bounds<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">dvd</span> gen_lucas_lehmer_sequence <span class="numeral">4</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">⟷</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">dvd</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> x_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cong_dvd_iff cong_sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> gen_lucas_lehmer_sequence''_correct<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">dvd</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bounds <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">≥</span> <span class="numeral">8</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> k zero_le_mult_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">+</span> <span class="numeral">5</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bounds <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">≥</span> <span class="numeral">8</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">k</span> <span class="main">&lt;</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> k <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="numeral">2</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> mult_less_cancel_left<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">k</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> k <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span> <span class="keyword1">dvd</span> gen_lucas_lehmer_sequence <span class="numeral">4</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                <span class="main">(</span><span class="main">(</span><span class="keyword1">let</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">x</span> <span class="keyword1">in</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">&lt;&lt;</span> <span class="free">p</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> shiftl_int_def Let_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Examples›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Note that for some reason, the clever bit-arithmetic version of the Lucas--Lehmer test is 
  actually much slower than the one using integer arithmetic when using PolyML, and even more so 
  when using the built-in evaluator in Isabelle (which also uses PolyML with a slightly different 
  setup).

  I do not quite know why this is the case, but it is likely because of inefficient implementations
  of bit arithmetic operations in PolyML and/or the code generator setup for it.

  When running with GHC, the bit-arithmetic version is <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">∗</span></span>‹much›</span></span> faster.
›</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"filter mersenne_prime <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="numeral">100</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"prime <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="numeral">521</span> <span class="main">-</span> <span class="main">1</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> lucas_lehmer_correct'<span class="main">)</span> <span class="operator">eval</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"prime <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="numeral">4253</span> <span class="main">-</span> <span class="main">1</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> lucas_lehmer_correct'<span class="main">)</span> <span class="operator">eval</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div>