<div id="Error_Syntax">
<div class="head">
<h1>Theory Error_Syntax</h1>
</div>
<pre class="source"><span class="comment1">(* Title:    Error_Syntax  
   Author:   Christian Sternagel
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Try-Catch and Error-Update Notation for Arbitrary Types›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Error_Syntax
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../../HOL/HOL/Main.html">Main</a>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Adhoc_Overloading.html">HOL-Library.Adhoc_Overloading</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">consts</span></span>
  catch <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'c</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span><span class="keyword1">try</span><span class="keyword3">(</span><span class="keyword3">/ </span>_<span class="keyword3">)</span><span class="keyword3">/ </span><span class="keyword1">catch</span><span class="keyword3">(</span><span class="keyword3">/ </span>_<span class="keyword3">)</span><span class="keyword3">)</span>"</span> <span class="main">[</span>12<span class="main">,</span> 12<span class="main">]</span> 13<span class="main">)</span>
  update_error <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'d</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">&lt;+?</span>"</span> 61<span class="main">)</span>

<span class="keyword1"><span class="command">syntax</span></span>
  <span class="quoted">"_replace_error"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">&lt;?</span>"</span> 61<span class="main">)</span>

<span class="keyword1"><span class="command">translations</span></span>
  <span class="quoted">"<span class="free">m</span> <span class="main">&lt;?</span> <span class="free">e</span>"</span> <span class="main">⇀</span> <span class="quoted">"<span class="free">m</span> <span class="main">&lt;+?</span> <span class="main">(</span><span class="main">λ</span><span class="main">_</span><span class="main">.</span> <span class="free">e</span><span class="main">)</span>"</span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="Error_Monad">
<div class="head">
<h1>Theory Error_Monad</h1>
</div>
<pre class="source"><span class="comment1">(* Title:     Error_Monad
   Author:    Christian Sternagel
   Author:    René Thiemann
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The Sum Type as Error Monad›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Error_Monad
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Monad_Syntax.html">HOL-Library.Monad_Syntax</a>"</span>
  <a href="Error_Syntax.html">Error_Syntax</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Make monad syntax (including do-notation) available for the sum type.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bind</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'e</span> <span class="main">+</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">+</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">+</span> <span class="tfree">'b</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bind</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="keyword1">of</span> Inr <span class="bound">x</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="main">|</span> Inl <span class="bound">e</span> <span class="main">⇒</span> Inl <span class="bound">e</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">adhoc_overloading</span></span>
  Monad_Syntax.bind <span class="quoted">bind</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">return</span> <span class="main">≡</span> Inr"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">error</span> <span class="main">≡</span> Inl"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">run</span> <span class="main">≡</span> projr"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Monad Laws›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> return_bind <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>return <span class="free">x</span> <span class="main">⤜</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bind_return <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m</span> <span class="main">⤜</span> return<span class="main">)</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> error_bind <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>error <span class="free">e</span> <span class="main">⤜</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> error <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bind_assoc <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">m</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">m</span> <span class="main">⤜</span> <span class="free">f</span><span class="main">)</span> <span class="main">⤜</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">m</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">⤜</span> <span class="free">g</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bind_cong <span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">m1</span> <span class="free">m2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'e</span> <span class="main">+</span> <span class="tfree">'a</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f1</span> <span class="free">f2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">+</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m1</span> <span class="main">=</span> <span class="free">m2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="free">m2</span> <span class="main">=</span> Inr <span class="bound">y</span> <span class="main">⟹</span> <span class="free">f1</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">f2</span> <span class="bound">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m1</span> <span class="main">⤜</span> <span class="free">f1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">m2</span> <span class="main">⤜</span> <span class="free">f2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">m1</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bind_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">catch_error</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'e</span> <span class="main">+</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span> <span class="main">⇒</span> <span class="tfree">'f</span> <span class="main">+</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'f</span> <span class="main">+</span> <span class="tfree">'a</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  catch_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">catch_error</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="keyword1">of</span> Inl <span class="bound">e</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">e</span> <span class="main">|</span> Inr <span class="bound">x</span> <span class="main">⇒</span> Inr <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">adhoc_overloading</span></span>
  Error_Syntax.catch <span class="quoted">catch_error</span>

<span class="keyword1"><span class="command">lemma</span></span> catch_splits<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="keyword1">try</span> <span class="free">m</span> <span class="keyword1">catch</span> <span class="free">f</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">e</span><span class="main">.</span> <span class="free">m</span> <span class="main">=</span> Inl <span class="bound">e</span> <span class="main">⟶</span> <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">m</span> <span class="main">=</span> Inr <span class="bound">x</span> <span class="main">⟶</span> <span class="free">P</span> <span class="main">(</span>Inr <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="keyword1">try</span> <span class="free">m</span> <span class="keyword1">catch</span> <span class="free">f</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">¬</span> <span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound">e</span><span class="main">.</span> <span class="free">m</span> <span class="main">=</span> Inl <span class="bound">e</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">m</span> <span class="main">=</span> Inr <span class="bound">x</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">P</span> <span class="main">(</span>Inr <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">m</span></span></span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> catch_def<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">update_error</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'e</span> <span class="main">+</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span> <span class="main">⇒</span> <span class="tfree">'f</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'f</span> <span class="main">+</span> <span class="tfree">'a</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">update_error</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="keyword1">try</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="keyword1">catch</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> error <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">adhoc_overloading</span></span>
  Error_Syntax.update_error <span class="quoted">update_error</span>

<span class="keyword1"><span class="command">lemma</span></span> catch_return <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">try</span> return <span class="free">x</span> <span class="keyword1">catch</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> return <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> catch_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> catch_error <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">try</span> error <span class="free">e</span> <span class="keyword1">catch</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="free">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> catch_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> update_error_return <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m</span> <span class="main">&lt;+?</span> <span class="free">c</span> <span class="main">=</span> return <span class="free">x</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">m</span> <span class="main">=</span> return <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">isOK</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="keyword1">of</span> Inl <span class="bound">e</span> <span class="main">⇒</span> False <span class="main">|</span> Inr <span class="bound">x</span> <span class="main">⇒</span> True<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> isOK_E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"isOK <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">x</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> return <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> isOK_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> isOK_I <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> return <span class="free">x</span> <span class="main">⟹</span> isOK <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> isOK_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> isOK_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"isOK <span class="free">m</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">m</span> <span class="main">=</span> return <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> isOK_error <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"isOK <span class="main">(</span>error <span class="free">x</span><span class="main">)</span> <span class="main">=</span> False"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> isOK_bind <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"isOK <span class="main">(</span><span class="free">m</span> <span class="main">⤜</span> <span class="free">f</span><span class="main">)</span> <span class="main">⟷</span> isOK <span class="free">m</span> <span class="main">∧</span> isOK <span class="main">(</span><span class="free">f</span> <span class="main">(</span>run <span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> isOK_update_error <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"isOK <span class="main">(</span><span class="free">m</span> <span class="main">&lt;+?</span> <span class="free">f</span><span class="main">)</span> <span class="main">⟷</span> isOK <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> isOK_case_prod <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"isOK <span class="main">(</span><span class="keyword1">case</span> <span class="free">lr</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">P</span> <span class="bound">l</span> <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">lr</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">⇒</span> isOK <span class="main">(</span><span class="free">P</span> <span class="bound">l</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod.case_distrib<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> isOK_case_option <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"isOK <span class="main">(</span><span class="keyword1">case</span> <span class="free">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="free">P</span> <span class="main">|</span> Some <span class="bound">v</span> <span class="main">⇒</span> <span class="free">Q</span> <span class="bound">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> isOK <span class="free">P</span> <span class="main">|</span> Some <span class="bound">v</span> <span class="main">⇒</span> isOK <span class="main">(</span><span class="free">Q</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>        

<span class="keyword1"><span class="command">lemma</span></span> isOK_Let <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"isOK <span class="main">(</span>Let <span class="free">s</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> isOK <span class="main">(</span><span class="free">f</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> run_bind <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"isOK <span class="free">m</span> <span class="main">⟹</span> run <span class="main">(</span><span class="free">m</span> <span class="main">⤜</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> run <span class="main">(</span><span class="free">f</span> <span class="main">(</span>run <span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> run_catch <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"isOK <span class="free">m</span> <span class="main">⟹</span> run <span class="main">(</span><span class="keyword1">try</span> <span class="free">m</span> <span class="keyword1">catch</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> run <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">foldM</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">+</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> list <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">+</span> <span class="tfree">'a</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">foldM</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">[]</span> <span class="main">=</span> return <span class="free"><span class="bound"><span class="entity">d</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">foldM</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span> <span class="bound">y</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">;</span> <span class="free">foldM</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">y</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">forallM_index_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">+</span> unit<span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> nat<span class="main">)</span> <span class="main">×</span> <span class="tfree">'e</span><span class="main">)</span> <span class="main">+</span> unit"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">forallM_index_aux</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">[]</span> <span class="main">=</span> return <span class="main">()</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">forallM_index_aux</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;+?</span> Pair <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="free">forallM_index_aux</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> isOK_forallM_index_aux <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"isOK <span class="main">(</span>forallM_index_aux <span class="free">P</span> <span class="free">n</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">xs</span><span class="main">.</span> isOK <span class="main">(</span><span class="free">P</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">.</span> isOK <span class="main">(</span><span class="free">P</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span>
    <span class="main">(</span>isOK <span class="main">(</span><span class="free">P</span> <span class="skolem">x</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="skolem">xs</span><span class="main">.</span> isOK <span class="main">(</span><span class="free">P</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Cons <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span>"</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">forallM_index</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">+</span> unit<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> nat<span class="main">)</span> <span class="main">×</span> <span class="tfree">'e</span><span class="main">)</span> <span class="main">+</span> unit"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">forallM_index</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> forallM_index_aux <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> isOK_forallM_index <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"isOK <span class="main">(</span>forallM_index <span class="free">P</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">xs</span><span class="main">.</span> isOK <span class="main">(</span><span class="free">P</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> forallM_index_def isOK_forallM_index_aux <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> forallM_index <span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">+</span> unit"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="free">c</span> <span class="bound">x</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">d</span> <span class="bound">x</span> <span class="bound">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"forallM_index <span class="free">c</span> <span class="free">xs</span> <span class="main">=</span> forallM_index <span class="free">d</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"forallM_index_aux <span class="free">c</span> <span class="skolem">n</span> <span class="free">xs</span> <span class="main">=</span> forallM_index_aux <span class="free">d</span> <span class="skolem">n</span> <span class="free">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span> <span class="operator">simp_all</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> forallM_index_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">hide_const</span></span> forallM_index_aux

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Check whether <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">f</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> succeeds for all elements of a given list. In case it doesn't,
  return the first offending element together with the produced error.
›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">forallM</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">+</span> unit<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">*</span> <span class="tfree">'e</span><span class="main">)</span> <span class="main">+</span> unit"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">forallM</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">[]</span> <span class="main">=</span> return <span class="main">()</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">forallM</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;+?</span> Pair <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⪢</span> <span class="free">forallM</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> isOK_forallM <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"isOK <span class="main">(</span>forallM <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> isOK <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Check whether <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">f</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> succeeds for at least one element of a given list.
  In case it doesn't, return the list of produced errors.
›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">existsM</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">+</span> unit<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'e</span> list <span class="main">+</span> unit"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">existsM</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">[]</span> <span class="main">=</span> error <span class="main">[]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">existsM</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">try</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">catch</span> <span class="main">(</span><span class="main">λ</span><span class="bound">e</span><span class="main">.</span> <span class="free">existsM</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">&lt;+?</span> Cons <span class="bound">e</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> isOK_existsM <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"isOK <span class="main">(</span>existsM <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">xs</span><span class="main">.</span> isOK <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inl <span class="skolem">e</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> catch_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> is_OK_if_return <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"isOK <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="keyword1">then</span> return <span class="free">x</span> <span class="keyword1">else</span> <span class="free">m</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">b</span> <span class="main">∨</span> isOK <span class="free">m</span>"</span></span>
  <span class="quoted"><span class="quoted">"isOK <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="free">m</span> <span class="keyword1">else</span> return <span class="free">x</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">¬</span> <span class="free">b</span> <span class="main">∨</span> isOK <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> isOK_if_error <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"isOK <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="keyword1">then</span> error <span class="free">e</span> <span class="keyword1">else</span> <span class="free">m</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">¬</span> <span class="free">b</span> <span class="main">∧</span> isOK <span class="free">m</span>"</span></span>
  <span class="quoted"><span class="quoted">"isOK <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="free">m</span> <span class="keyword1">else</span> error <span class="free">e</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">b</span> <span class="main">∧</span> isOK <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> isOK_if<span class="main">:</span>
  <span class="quoted"><span class="quoted">"isOK <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="free">x</span> <span class="keyword1">else</span> <span class="free">y</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">b</span> <span class="main">∧</span> isOK <span class="free">x</span> <span class="main">∨</span> <span class="main">¬</span> <span class="free">b</span> <span class="main">∧</span> isOK <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">sequence</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span> <span class="main">+</span> <span class="tfree">'a</span><span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">+</span> <span class="tfree">'a</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sequence</span> <span class="main">[]</span> <span class="main">=</span> Inr <span class="main">[]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">sequence</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ms</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">x</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">;</span>
    <span class="bound">xs</span> <span class="main">←</span> <span class="free">sequence</span> <span class="free"><span class="bound"><span class="entity">ms</span></span></span><span class="main">;</span>
    return <span class="main">(</span><span class="bound">x</span> <span class="main">#</span> <span class="bound">xs</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Monadic Map for Error Monad›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mapM</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">+</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">+</span> <span class="tfree">'b</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mapM</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">[]</span> <span class="main">=</span> return <span class="main">[]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">mapM</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">y</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">;</span>
    <span class="bound">ys</span> <span class="main">←</span> <span class="free">mapM</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">;</span>
    Inr <span class="main">(</span><span class="bound">y</span> <span class="main">#</span> <span class="bound">ys</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mapM_error<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">e</span><span class="main">.</span> mapM <span class="free">f</span> <span class="free">xs</span> <span class="main">=</span> error <span class="bound">e</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">xs</span><span class="main">.</span> <span class="main">∃</span><span class="bound">e</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> error <span class="bound">e</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"mapM <span class="free">f</span> <span class="skolem">xs</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> mapM_return<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mapM <span class="free">f</span> <span class="free">xs</span> <span class="main">=</span> return <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">=</span> map <span class="main">(</span>run <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="free">xs</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">xs</span><span class="main">.</span> <span class="main">∀</span><span class="bound">e</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≠</span> error <span class="bound">e</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">ys</span><span class="main">)</span>   
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"mapM <span class="free">f</span> <span class="skolem">xs</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> mapM_return_idx<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"mapM <span class="free">f</span> <span class="free">xs</span> <span class="main">=</span> Inr <span class="free">ys</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> Inr <span class="bound">y</span> <span class="main">∧</span> <span class="free">ys</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="bound">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> ** <span class="main">=</span> mapM_return <span class="main">[</span><span class="operator">OF</span> *<span class="main">,</span> <span class="operator">unfolded</span> set_conv_nth<span class="main">]</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">e</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">≠</span> Inl <span class="bound">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> Inr <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> Inr <span class="skolem">y</span> <span class="main">∧</span> <span class="free">ys</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ** <span class="main">[</span><span class="operator">THEN</span> conjunct1<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mapM_cong <span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">ys</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mapM <span class="free">f</span> <span class="free">xs</span> <span class="main">=</span> mapM <span class="free">g</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> bindE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">⤜</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> return <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">y</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> return <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">y</span> <span class="main">=</span> return <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> then_return_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">⪢</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> return <span class="free">f</span> <span class="main">⟷</span> isOK <span class="free">p</span> <span class="main">∧</span> <span class="free">q</span> <span class="main">=</span> return <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">choice</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span> <span class="main">+</span> <span class="tfree">'a</span><span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'e</span> list <span class="main">+</span> <span class="tfree">'a</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">choice</span> <span class="main">[]</span> <span class="main">=</span> error <span class="main">[]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">choice</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">try</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">catch</span> <span class="main">(</span><span class="main">λ</span><span class="bound">e</span><span class="main">.</span> <span class="free">choice</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">&lt;+?</span> Cons <span class="bound">e</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> choice.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword">del</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> isOK_mapM<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"isOK <span class="main">(</span>mapM <span class="free">f</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟶</span> isOK <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> run <span class="main">(</span>mapM <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> run <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms mapM_return<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> isOK_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">firstM</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">firstM</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">[]</span> <span class="main">=</span> error <span class="main">[]</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">firstM</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">try</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⪢</span> return <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">catch</span> <span class="main">(</span><span class="main">λ</span><span class="bound">e</span><span class="main">.</span> <span class="free">firstM</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">&lt;+?</span> Cons <span class="bound">e</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> firstM<span class="main">:</span>
  <span class="quoted"><span class="quoted">"isOK <span class="main">(</span>firstM <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">xs</span><span class="main">.</span> isOK <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> catch_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> firstM_return<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"firstM <span class="free">f</span> <span class="free">xs</span> <span class="main">=</span> return <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"isOK <span class="main">(</span><span class="free">f</span> <span class="free">y</span><span class="main">)</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> catch_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>


<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="Check_Monad">
<div class="head">
<h1>Theory Check_Monad</h1>
</div>
<pre class="source"><span class="comment1">(* Title:     Check_Monad
   Author:    Christian Sternagel
   Author:    René Thiemann
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹A Special Error Monad for Certification with Informative Error Messages›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Check_Monad
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Error_Monad.html">Error_Monad</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A check is either successful or fails with some error.›</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span>
  <span class="tfree">'e</span> check <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'e</span> <span class="main">+</span> unit"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">succeed</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'e</span> check"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">succeed</span> <span class="main">≡</span> return <span class="main">()</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">check</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">⇒</span> <span class="tfree">'e</span> check"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">check</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> succeed <span class="keyword1">else</span> error <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> isOK_check <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"isOK <span class="main">(</span>check <span class="free">b</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> check_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> isOK_check_catch <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"isOK <span class="main">(</span><span class="keyword1">try</span> check <span class="free">b</span> <span class="free">e</span> <span class="keyword1">catch</span> <span class="free">f</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">b</span> <span class="main">∨</span> isOK <span class="main">(</span><span class="free">f</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> catch_def check_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">check_return</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> check <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'b</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">check_return</span> <span class="free"><span class="bound"><span class="entity">chk</span></span></span> <span class="free"><span class="bound"><span class="entity">res</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">chk</span></span></span> <span class="main">⪢</span> return <span class="free"><span class="bound"><span class="entity">res</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> check_return <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"check_return <span class="free">chk</span> <span class="free">res</span> <span class="main">=</span> return <span class="free">res'</span> <span class="main">⟷</span> isOK <span class="free">chk</span> <span class="main">∧</span> <span class="free">res'</span> <span class="main">=</span> <span class="free">res</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> check_return_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">chk</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"check_return <span class="free">chk</span> <span class="free">res</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">chk</span> <span class="keyword1">of</span> Inr <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> Inr <span class="free">res</span> <span class="main">|</span> Inl <span class="bound">e</span> <span class="main">⇒</span> Inl <span class="bound">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> check_return_def bind_def <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">check_allm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'e</span> check<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'e</span> check"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">check_allm</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> forallM <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">&lt;+?</span> snd"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">check_exm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'e</span> check<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span> list <span class="main">⇒</span> <span class="tfree">'e</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'e</span> check"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">check_exm</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">fld</span></span></span> <span class="main">≡</span> existsM <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">&lt;+?</span> <span class="free"><span class="bound"><span class="entity">fld</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> isOK_check_allm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"isOK <span class="main">(</span>check_allm <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> isOK <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">check_allm_index</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'e</span> check<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'e</span> check"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">check_allm_index</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> forallM_index <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">&lt;+?</span> snd"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">check_all</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> check"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">check_all</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> check_allm <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="keyword1">then</span> succeed <span class="keyword1">else</span> error <span class="bound">x</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">check_all_index</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> nat <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> nat<span class="main">)</span> check"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">check_all_index</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> check_allm_index <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="bound">i</span> <span class="keyword1">then</span> succeed <span class="keyword1">else</span> error <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> isOK_check_all_index <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"isOK <span class="main">(</span>check_all_index <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">xs</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following version allows to modify the index during the check.›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">check_allm_gen_index</span> <span class="main">::</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> nat <span class="main">⇒</span> nat<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'e</span> check<span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'e</span> check"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">check_allm_gen_index</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> snd <span class="main">(</span>foldl <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">x</span> <span class="bound">i</span><span class="main">,</span> <span class="bound">m</span> <span class="main">⪢</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> succeed<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> foldl_error<span class="main">:</span>
  <span class="quoted"><span class="quoted">"snd <span class="main">(</span>foldl <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="bound">x</span> <span class="main">.</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x</span> <span class="bound">i</span><span class="main">,</span> <span class="bound">m</span> <span class="main">⪢</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> error <span class="free">e</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> error <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> isOK_check_allm_gen_index <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"isOK <span class="main">(</span>check_allm_gen_index <span class="free">g</span> <span class="free">f</span> <span class="free">n</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">xs</span><span class="main">.</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> isOK <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"isOK <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span> <span class="skolem">n</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> isOK <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> True Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> check_allm_gen_index_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> isOK_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span> <span class="skolem">n</span> <span class="main">=</span> error <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span> <span class="skolem">n</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> foldl_error <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">g</span></span> <span class="quoted"><span class="free">f</span></span> <span class="main">_</span> <span class="quoted"><span class="skolem">e</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> check_allm_gen_index_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> check_allm_gen_index <span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'e</span> check"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="free">g</span> <span class="bound">x</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">g'</span> <span class="bound">x</span> <span class="bound">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">f'</span> <span class="bound">x</span> <span class="bound">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"check_allm_gen_index <span class="free">g</span> <span class="free">f</span> <span class="free">n</span> <span class="free">xs</span> <span class="main">=</span> check_allm_gen_index <span class="free">g'</span> <span class="free">f'</span> <span class="free">n</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="skolem">m</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"foldl <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x</span> <span class="bound">i</span><span class="main">,</span> <span class="bound">m</span> <span class="main">⪢</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">m</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span>
      foldl <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">g'</span> <span class="bound">x</span> <span class="bound">i</span><span class="main">,</span> <span class="bound">m</span> <span class="main">⪢</span> <span class="free">f'</span> <span class="bound">x</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">m</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">m</span></span><span class="main">)</span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> check_allm_gen_index_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">check_subseteq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> check"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">check_subseteq</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> check_all <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> isOK_check_subseteq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"isOK <span class="main">(</span>check_subseteq <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⟷</span> set <span class="free">xs</span> <span class="main">⊆</span> set <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> check_subseteq_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">check_same_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> check"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">check_same_set</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> <span class="main">(</span>check_subseteq <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">⪢</span> check_subseteq <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> isOK_check_same_set <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"isOK <span class="main">(</span>check_same_set <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⟷</span> set <span class="free">xs</span> <span class="main">=</span> set <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> check_same_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">check_disjoint</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> check"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">check_disjoint</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> check_all <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> set <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> isOK_check_disjoint <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"isOK <span class="main">(</span>check_disjoint <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⟷</span> set <span class="free">xs</span> <span class="main">∩</span> set <span class="free">ys</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> check_disjoint_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">check_all_combinations</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> check<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'b</span> check"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">check_all_combinations</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> check_allm <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> check_allm <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> isOK_check_all_combinations <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"isOK <span class="main">(</span>check_all_combinations <span class="free">c</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> isOK <span class="main">(</span><span class="free">c</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> check_all_combinations_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">check_pairwise</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> check<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'b</span> check"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">check_pairwise</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">[]</span> <span class="main">=</span> succeed"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">check_pairwise</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>check_allm <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">⪢</span> <span class="free">check_pairwise</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pairwise_aux<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span>length <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="bound">j</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>
     <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span>length <span class="free">xs</span><span class="main">.</span> <span class="free">P</span> <span class="free">x</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span>length <span class="free">xs</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="bound">j</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?C</span> <span class="main">=</span> <span class="main">(</span><span class="var">?A</span> <span class="main">∧</span> <span class="var">?B</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> iffI conjI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">∧</span> <span class="var">?B</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?C</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> isOK_check_pairwise <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"isOK <span class="main">(</span>check_pairwise <span class="free">c</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span>length <span class="free">xs</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="bound">j</span><span class="main">.</span> isOK <span class="main">(</span><span class="free">c</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"isOK <span class="main">(</span>check_allm <span class="main">(</span><span class="free">c</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span>length <span class="skolem">xs</span><span class="main">.</span> isOK <span class="main">(</span><span class="free">c</span> <span class="skolem">x</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> all_set_conv_all_nth <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">y</span><span class="main">.</span> isOK <span class="main">(</span><span class="free">c</span> <span class="skolem">x</span> <span class="bound">y</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"isOK <span class="main">(</span>check_pairwise <span class="free">c</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span>length <span class="skolem">xs</span><span class="main">.</span> isOK <span class="main">(</span><span class="free">c</span> <span class="skolem">x</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span>length <span class="skolem">xs</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="bound">j</span><span class="main">.</span> isOK <span class="main">(</span><span class="free">c</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> pairwise_aux <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> isOK <span class="main">(</span><span class="free">c</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">check_exists</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> list<span class="main">)</span> check"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">check_exists</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> check_exm <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="keyword1">then</span> succeed <span class="keyword1">else</span> error <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> concat"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> isOK_choice <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"isOK <span class="main">(</span>choice <span class="main">[]</span><span class="main">)</span> <span class="main">⟷</span> False"</span></span>
  <span class="quoted"><span class="quoted">"isOK <span class="main">(</span>choice <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> isOK <span class="free">x</span> <span class="main">∨</span> isOK <span class="main">(</span>choice <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> choice.simps isOK_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">or_ok</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> check <span class="main">⇒</span> <span class="tfree">'a</span> check <span class="main">⇒</span> <span class="tfree">'a</span> check"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">or_ok</span> <span class="main">(</span>Inl <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">or_ok</span> <span class="main">(</span>Inr <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> Inr <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> or_is_or<span class="main">:</span> <span class="quoted"><span class="quoted">"isOK <span class="main">(</span>or_ok <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> isOK <span class="free">a</span> <span class="main">∨</span> isOK <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> or_ok.elims <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="Strict_Sum">
<div class="head">
<h1>Theory Strict_Sum</h1>
</div>
<pre class="source"><span class="comment1">(* Title:     Xml
   Author:    Christian Sternagel
   Author:    René Thiemann
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹A Sum Type with Bottom Element›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Strict_Sum
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Monad_Syntax.html">HOL-Library.Monad_Syntax</a>"</span>
  <a href="Error_Syntax.html">Error_Syntax</a>
  <a href="../Partial_Function_MR/Partial_Function_MR.html">Partial_Function_MR.Partial_Function_MR</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span>dead <span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> sum_bot <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">+<span class="hidden">⇩</span><sub>⊥</sub></span>"</span> 10<span class="main">)</span> <span class="main">=</span> Bottom <span class="main">|</span> Left <span class="tfree"><span class="quoted"><span class="tfree">'e</span></span></span> <span class="main">|</span> Right <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">for</span></span> map<span class="main">:</span> sum_bot_map


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Setup for Partial Functions›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">sum_bot_ord</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'e</span> <span class="main">+<span class="hidden">⇩</span><sub>⊥</sub></span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">+<span class="hidden">⇩</span><sub>⊥</sub></span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sum_bot_ord</span> <span class="main">≡</span> flat_ord Bottom"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> sum_bot<span class="main">:</span>
  partial_function_definitions <span class="quoted">sum_bot_ord</span> <span class="quoted"><span class="quoted">"flat_lub Bottom"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> flat_interpretation<span class="main">)</span>

<span class="keyword1"><span class="command">declaration</span></span> <span class="quoted">‹
<span class="entity">Partial_Function.init</span>
  <span class="inner_quoted">"sum_bot"</span>
  <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">sum_bot.fixp_fun</span><span class="antiquote">}</span></span>
  <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">sum_bot.mono_body</span><span class="antiquote">}</span></span>
  <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> sum_bot.fixp_rule_uc<span class="antiquote">}</span></span></span>
  <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> sum_bot.fixp_induct_uc<span class="antiquote">}</span></span></span>
  NONE
›</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Monad Setup›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">bind</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'e</span> <span class="main">+<span class="hidden">⇩</span><sub>⊥</sub></span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span> <span class="main">+<span class="hidden">⇩</span><sub>⊥</sub></span> <span class="tfree">'b</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">+<span class="hidden">⇩</span><sub>⊥</sub></span> <span class="tfree">'b</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bind</span> Bottom <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Bottom"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">bind</span> <span class="main">(</span>Left <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Left <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">bind</span> <span class="main">(</span>Right <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bind_cong <span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">ys</span> <span class="main">=</span> Right <span class="bound">x</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bind <span class="free">xs</span> <span class="free">f</span> <span class="main">=</span> bind <span class="free">ys</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">mono_sum_bot</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span> <span class="main">+<span class="hidden">⇩</span><sub>⊥</sub></span> <span class="tfree">'b</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'f</span> <span class="main">+<span class="hidden">⇩</span><sub>⊥</sub></span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mono_sum_bot</span> <span class="main">≡</span> monotone <span class="main">(</span>fun_ord sum_bot_ord<span class="main">)</span> sum_bot_ord"</span></span>

<span class="comment1">(* TODO: perhaps use Partial_Function.bind_mono to proof this result immediately *)</span>
<span class="keyword1"><span class="command">lemma</span></span> bind_mono <span class="main">[</span><span class="operator">partial_function_mono</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mf<span class="main">:</span> <span class="quoted"><span class="quoted">"mono_sum_bot <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> mg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> mono_sum_bot <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="free">C</span> <span class="bound">y</span> <span class="bound">f</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mono_sum_bot <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> bind <span class="main">(</span><span class="free">B</span> <span class="bound">f</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">C</span> <span class="bound">y</span> <span class="bound">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> monotoneI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="skolem">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">+<span class="hidden">⇩</span><sub>⊥</sub></span> <span class="tfree">'c</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> fg<span class="main">:</span> <span class="quoted"><span class="quoted">"fun_ord sum_bot_ord <span class="skolem">f</span> <span class="skolem">g</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> mf <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_bot_ord <span class="main">(</span><span class="free">B</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">(</span><span class="free">B</span> <span class="skolem">g</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> monotoneD <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">f</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">g</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_bot_ord <span class="main">(</span>bind <span class="main">(</span><span class="free">B</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">C</span> <span class="bound">y</span> <span class="skolem">f</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>bind <span class="main">(</span><span class="free">B</span> <span class="skolem">g</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">C</span> <span class="bound">y</span> <span class="skolem">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> flat_ord_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> mg <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y'</span><span class="main">.</span> sum_bot_ord <span class="main">(</span><span class="free">C</span> <span class="bound">y'</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">(</span><span class="free">C</span> <span class="bound">y'</span> <span class="skolem">g</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> monotoneD<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> fg<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_bot_ord <span class="main">(</span>bind <span class="main">(</span><span class="free">B</span> <span class="skolem">g</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y'</span><span class="main">.</span> <span class="free">C</span> <span class="bound">y'</span> <span class="skolem">f</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>bind <span class="main">(</span><span class="free">B</span> <span class="skolem">g</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y'</span><span class="main">.</span> <span class="free">C</span> <span class="bound">y'</span> <span class="skolem">g</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> flat_ord_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="skolem">g</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="main">(</span>sum_bot.leq_trans<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sum_bot_ord <span class="main">(</span>bind <span class="main">(</span><span class="free">B</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">C</span> <span class="bound">y</span> <span class="skolem">f</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>bind <span class="main">(</span><span class="free">B</span> <span class="skolem">g</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y'</span><span class="main">.</span> <span class="free">C</span> <span class="bound">y'</span> <span class="skolem">g</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">adhoc_overloading</span></span>
  Monad_Syntax.bind <span class="quoted">bind</span>

<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> bind

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">catch_error</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'e</span> <span class="main">+<span class="hidden">⇩</span><sub>⊥</sub></span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'f</span> <span class="main">+<span class="hidden">⇩</span><sub>⊥</sub></span> <span class="tfree">'a</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'f</span> <span class="main">+<span class="hidden">⇩</span><sub>⊥</sub></span> <span class="tfree">'a</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">catch_error</span> Bottom <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Bottom "</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">catch_error</span> <span class="main">(</span>Left <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">catch_error</span> <span class="main">(</span>Right <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Right <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>

<span class="keyword1"><span class="command">adhoc_overloading</span></span>
  Error_Syntax.catch <span class="quoted">catch_error</span>

<span class="keyword1"><span class="command">lemma</span></span> catch_mono <span class="main">[</span><span class="operator">partial_function_mono</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mf<span class="main">:</span> <span class="quoted"><span class="quoted">"mono_sum_bot <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> mg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> mono_sum_bot <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="free">C</span> <span class="bound">y</span> <span class="bound">f</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mono_sum_bot <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="keyword1">try</span> <span class="main">(</span><span class="free">B</span> <span class="bound">f</span><span class="main">)</span> <span class="keyword1">catch</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">C</span> <span class="bound">y</span> <span class="bound">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> monotoneI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="skolem">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">+<span class="hidden">⇩</span><sub>⊥</sub></span> <span class="tfree">'c</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> fg<span class="main">:</span> <span class="quoted"><span class="quoted">"fun_ord sum_bot_ord <span class="skolem">f</span> <span class="skolem">g</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> mf <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_bot_ord <span class="main">(</span><span class="free">B</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">(</span><span class="free">B</span> <span class="skolem">g</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> monotoneD <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">f</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">g</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_bot_ord <span class="main">(</span><span class="keyword1">try</span> <span class="main">(</span><span class="free">B</span> <span class="skolem">f</span><span class="main">)</span> <span class="keyword1">catch</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">C</span> <span class="bound">y</span> <span class="skolem">f</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">try</span> <span class="main">(</span><span class="free">B</span> <span class="skolem">g</span><span class="main">)</span> <span class="keyword1">catch</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">C</span> <span class="bound">y</span> <span class="skolem">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> flat_ord_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> mg
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y'</span><span class="main">.</span> sum_bot_ord <span class="main">(</span><span class="free">C</span> <span class="bound">y'</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">(</span><span class="free">C</span> <span class="bound">y'</span> <span class="skolem">g</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> monotoneD<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> fg<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_bot_ord <span class="main">(</span><span class="keyword1">try</span> <span class="main">(</span><span class="free">B</span> <span class="skolem">g</span><span class="main">)</span> <span class="keyword1">catch</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y'</span><span class="main">.</span> <span class="free">C</span> <span class="bound">y'</span> <span class="skolem">f</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">try</span> <span class="main">(</span><span class="free">B</span> <span class="skolem">g</span><span class="main">)</span> <span class="keyword1">catch</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y'</span><span class="main">.</span> <span class="free">C</span> <span class="bound">y'</span> <span class="skolem">g</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> flat_ord_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="skolem">g</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="main">(</span>sum_bot.leq_trans<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sum_bot_ord <span class="main">(</span><span class="keyword1">try</span> <span class="main">(</span><span class="free">B</span> <span class="skolem">f</span><span class="main">)</span> <span class="keyword1">catch</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">C</span> <span class="bound">y</span> <span class="skolem">f</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">try</span> <span class="main">(</span><span class="free">B</span> <span class="skolem">g</span><span class="main">)</span> <span class="keyword1">catch</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y'</span><span class="main">.</span> <span class="free">C</span> <span class="bound">y'</span> <span class="skolem">g</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">error</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'e</span> <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">+<span class="hidden">⇩</span><sub>⊥</sub></span> <span class="tfree">'a</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">error</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> Left <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">return</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">+<span class="hidden">⇩</span><sub>⊥</sub></span> <span class="tfree">'a</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">return</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> Right <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">map_sum_bot</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span> <span class="main">+<span class="hidden">⇩</span><sub>⊥</sub></span> <span class="tfree">'b</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">+<span class="hidden">⇩</span><sub>⊥</sub></span> <span class="tfree">'b</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">map_sum_bot</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">[]</span> <span class="main">=</span> return <span class="main">[]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">map_sum_bot</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">y</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">;</span>
    <span class="bound">ys</span> <span class="main">←</span> <span class="free">map_sum_bot</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">;</span>
    return <span class="main">(</span><span class="bound">y</span> <span class="main">#</span> <span class="bound">ys</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_sum_bot_cong <span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">ys</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map_sum_bot <span class="free">f</span> <span class="free">xs</span> <span class="main">=</span> map_sum_bot <span class="free">g</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> sum_bot_const_mono <span class="main">=</span>
  sum_bot.const_mono <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"fun_ord sum_bot_ord"</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> map_sum_bot_mono <span class="main">[</span><span class="operator">partial_function_mono</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">C</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span> <span class="main">+<span class="hidden">⇩</span><sub>⊥</sub></span> <span class="tfree">'c</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">+<span class="hidden">⇩</span><sub>⊥</sub></span> <span class="tfree">'d</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="free">B</span> <span class="main">⟹</span> mono_sum_bot <span class="main">(</span><span class="free">C</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mono_sum_bot <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> map_sum_bot <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="free">C</span> <span class="bound">y</span> <span class="bound">f</span><span class="main">)</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">B</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">partial_function_mono</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">update_error</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'e</span> <span class="main">+<span class="hidden">⇩</span><sub>⊥</sub></span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span> <span class="main">⇒</span> <span class="tfree">'f</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'f</span> <span class="main">+<span class="hidden">⇩</span><sub>⊥</sub></span> <span class="tfree">'a</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">update_error</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="keyword1">try</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">catch</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">e</span><span class="main">.</span> error <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">adhoc_overloading</span></span>
  Error_Syntax.update_error <span class="quoted">update_error</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">sumbot</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'e</span> <span class="main">+</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">+<span class="hidden">⇩</span><sub>⊥</sub></span> <span class="tfree">'a</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sumbot</span> <span class="main">(</span>Inl <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> Left <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">sumbot</span> <span class="main">(</span>Inr <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> Right <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">code_datatype</span></span> <span class="quoted">sumbot</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"bind <span class="main">(</span>sumbot <span class="free">a</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">a</span> <span class="keyword1">of</span> Inl <span class="bound">b</span> <span class="main">⇒</span> sumbot <span class="main">(</span>Inl <span class="bound">b</span><span class="main">)</span> <span class="main">|</span> Inr <span class="bound">a</span> <span class="main">⇒</span> <span class="free">f</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">try</span> <span class="main">(</span>sumbot <span class="free">a</span><span class="main">)</span> <span class="keyword1">catch</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">a</span> <span class="keyword1">of</span> Inl <span class="bound">b</span> <span class="main">⇒</span> <span class="free">f</span> <span class="bound">b</span> <span class="main">|</span> Inr <span class="bound">a</span> <span class="main">⇒</span> sumbot <span class="main">(</span>Inr <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Right <span class="free">x</span> <span class="main">=</span> sumbot <span class="main">(</span>Inr <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Left <span class="free">x</span> <span class="main">=</span> sumbot <span class="main">(</span>Inl <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"return <span class="free">x</span> <span class="main">=</span> sumbot <span class="main">(</span>Inr <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"error <span class="free">x</span> <span class="main">=</span> sumbot <span class="main">(</span>Inl <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"case_sum_bot <span class="free">f</span> <span class="free">g</span> <span class="free">h</span> <span class="main">(</span>sumbot <span class="free">p</span><span class="main">)</span> <span class="main">=</span> case_sum <span class="free">g</span> <span class="free">h</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Connection to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">theory</span></span> <a href="../Partial_Function_MR/Partial_Function_MR.html"></a><a href="../Partial_Function_MR/Partial_Function_MR.html">Partial_Function_MR.Partial_Function_MR</a><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sum_bot_map_mono <span class="main">[</span><span class="operator">partial_function_mono</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mf<span class="main">:</span> <span class="quoted"><span class="quoted">"mono_sum_bot <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mono_sum_bot <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> sum_bot_map <span class="free">h</span> <span class="main">(</span><span class="free">B</span> <span class="bound">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> monotoneI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="skolem">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">+<span class="hidden">⇩</span><sub>⊥</sub></span> <span class="tfree">'c</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> fg<span class="main">:</span> <span class="quoted"><span class="quoted">"fun_ord sum_bot_ord <span class="skolem">f</span> <span class="skolem">g</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> mf <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_bot_ord <span class="main">(</span><span class="free">B</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">(</span><span class="free">B</span> <span class="skolem">g</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> monotoneD <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">f</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">g</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sum_bot_ord <span class="main">(</span>sum_bot_map <span class="free">h</span> <span class="main">(</span><span class="free">B</span> <span class="skolem">f</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>sum_bot_map <span class="free">h</span> <span class="main">(</span><span class="free">B</span> <span class="skolem">g</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> flat_ord_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>    
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">declaration</span></span> <span class="quoted">‹
<span class="entity">Partial_Function_MR.init</span> 
  <span class="inner_quoted">"sum_bot"</span> 
  <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">mt</span><span class="main">,</span> <span class="entity">t_to_ss</span><span class="main">,</span> <span class="entity">mtT</span><span class="main">,</span> <span class="entity">msT</span><span class="main">,</span> <span class="entity">t_to_sTs</span><span class="main">)</span> <span class="main">=&gt;</span>
      list_comb <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> sum_bot_map<span class="antiquote">}</span></span><span class="main">,</span> <span class="entity">t_to_sTs</span> ---&gt; <span class="entity">mtT</span> --&gt; <span class="entity">msT</span><span class="main">)</span><span class="main">,</span> <span class="entity">t_to_ss</span><span class="main">)</span> $ <span class="entity">mt</span><span class="main">)</span>
  <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">commonTs</span><span class="main">,</span> <span class="entity">argTs</span><span class="main">)</span> <span class="main">=&gt;</span> Type <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">type_name</span> sum_bot<span class="antiquote">}</span></span><span class="main">,</span> <span class="entity">commonTs</span> @ <span class="entity">argTs</span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">mT</span> <span class="main">=&gt;</span> Term.dest_Type <span class="entity">mT</span> |&gt; <span class="main">#</span><span class="inner_numeral">2</span> |&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">[</span><span class="entity">err</span><span class="main">,</span> <span class="entity">res</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="main">[</span><span class="entity">err</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span><span class="entity">res</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
  <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> sum_bot.map_comp<span class="antiquote">}</span></span></span> 
  <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> sum_bot.map_ident<span class="antiquote">}</span></span></span>
›</span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="Parser_Monad">
<div class="head">
<h1>Theory Parser_Monad</h1>
</div>
<pre class="source"><span class="comment1">(* Title:     Parser_Monad
   Author:    Christian Sternagel
   Author:    René Thiemann
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Monadic Parser Combinators›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Parser_Monad
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Error_Monad.html">Error_Monad</a>
  <a href="../Show/Show.html">Show.Show</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(*It might be nice to be able to enter things like CHR ''\t'', ... directly.*)</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">tab</span> <span class="main">≡</span> <span class="keyword1">CHR</span> <span class="numeral">0x09</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">carriage_return</span> <span class="main">≡</span> <span class="keyword1">CHR</span> <span class="numeral">0x0D</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">wspace</span> <span class="main">≡</span> <span class="main">[</span><span class="keyword1">CHR</span> <span class="inner_quoted">'' ''</span><span class="main">,</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''⏎''</span><span class="main">,</span> tab<span class="main">,</span> carriage_return<span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">trim</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> string"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">trim</span> <span class="main">=</span> dropWhile <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> set wspace<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> trim<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">w</span><span class="main">.</span> <span class="free">s</span> <span class="main">=</span> <span class="bound">w</span> <span class="main">@</span> trim <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> trim_def<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> takeWhile_dropWhile_id<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A parser takes a list of tokes and returns either an error message or
  a result together with the remaining tokens.
›</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span>
  <span class="main">(</span><span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> gen_parser <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> list <span class="main">⇒</span> string <span class="main">+</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'t</span> list<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  <span class="tfree">'a</span> parser <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>char<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> gen_parser"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Monad-Setup for Parsers›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">return</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> gen_parser"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">return</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ts</span><span class="main">.</span> Error_Monad.return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="bound">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">error</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> gen_parser"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">error</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> Error_Monad.error <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bind</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> gen_parser <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> gen_parser<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> gen_parser"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bind</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">ts'</span><span class="main">)</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="bound">ts'</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">adhoc_overloading</span></span>
  Monad_Syntax.bind <span class="quoted">bind</span>

<span class="keyword1"><span class="command">lemma</span></span> bind_cong <span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">m1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> gen_parser"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m1</span> <span class="free">ts2</span> <span class="main">=</span> <span class="free">m2</span> <span class="free">ts2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">y</span> <span class="bound">ts</span><span class="main">.</span> <span class="free">m2</span> <span class="free">ts2</span> <span class="main">=</span> Inr <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">ts</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">f1</span> <span class="bound">y</span> <span class="bound">ts</span> <span class="main">=</span> <span class="free">f2</span> <span class="bound">y</span> <span class="bound">ts</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ts1</span> <span class="main">=</span> <span class="free">ts2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">m1</span> <span class="main">⤜</span> <span class="free">f1</span><span class="main">)</span> <span class="free">ts1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">m2</span> <span class="main">⤜</span> <span class="free">f2</span><span class="main">)</span> <span class="free">ts2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> bind_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">m1</span> <span class="free">ts1</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">update_tokens</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'t</span> list <span class="main">⇒</span> <span class="tfree">'t</span> list<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'t</span> list<span class="main">)</span> gen_parser"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">update_tokens</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span> Error_Monad.return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">get_tokens</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'t</span> list<span class="main">)</span> gen_parser"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">get_tokens</span> <span class="main">=</span> update_tokens <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">set_tokens</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'t</span><span class="main">,</span> unit<span class="main">)</span> gen_parser"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">set_tokens</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span> update_tokens <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">⪢</span> return <span class="main">()</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">err_expecting</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'t</span><span class="main">::</span>show<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> gen_parser"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">err_expecting</span> <span class="free"><span class="bound"><span class="entity">msg</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span> Error_Monad.error
    <span class="main">(</span><span class="inner_quoted">''expecting ''</span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">msg</span></span></span> <span class="main">@</span> <span class="inner_quoted">'', but found: ''</span> <span class="main">@</span> shows_quote <span class="main">(</span>shows <span class="main">(</span>take <span class="numeral">30</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">[]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">eoi</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'t</span> <span class="main">::</span> show<span class="main">,</span> unit<span class="main">)</span> gen_parser"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eoi</span> <span class="main">[]</span> <span class="main">=</span> Error_Monad.return <span class="main">(</span><span class="main">()</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">eoi</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span> err_expecting <span class="inner_quoted">''end of input''</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">exactly_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> string <span class="main">⇒</span> string <span class="main">⇒</span> string parser"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">exactly_aux</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> <span class="free">exactly_aux</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span>
    <span class="keyword1">else</span> err_expecting <span class="main">(</span><span class="inner_quoted">''\"''</span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">@</span> <span class="inner_quoted">''\"''</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">exactly_aux</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> Error_Monad.return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> trim <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">exactly_aux</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">[]</span> <span class="main">=</span> err_expecting <span class="main">(</span><span class="inner_quoted">''\"''</span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">@</span> <span class="inner_quoted">''\"''</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">oneof_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string list <span class="main">⇒</span> string list <span class="main">⇒</span> string parser"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">oneof_aux</span> <span class="free"><span class="bound"><span class="entity">allowed</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> map snd <span class="main">(</span>zip <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span> Error_Monad.return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> trim <span class="main">(</span>List.drop <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="free">oneof_aux</span> <span class="free"><span class="bound"><span class="entity">allowed</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">oneof_aux</span> <span class="free"><span class="bound"><span class="entity">allowed</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span> err_expecting <span class="main">(</span><span class="inner_quoted">''one of ''</span> <span class="main">@</span> shows_list <span class="free"><span class="bound"><span class="entity">allowed</span></span></span> <span class="main">[]</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_parser</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> parser <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_parser</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">r</span> <span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">s</span> <span class="main">=</span> Inr <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">⟶</span> length <span class="bound">s</span> <span class="main">≥</span> length <span class="bound">r</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_parserI <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">r</span> <span class="bound">x</span><span class="main">.</span> <span class="free">p</span> <span class="bound">s</span> <span class="main">=</span> Inr <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">⟹</span> length <span class="bound">s</span> <span class="main">≥</span> length <span class="bound">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_parser <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> is_parser_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> is_parserE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_parser <span class="free">p</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">s</span> <span class="bound">r</span> <span class="bound">x</span><span class="main">.</span> <span class="free">p</span> <span class="bound">s</span> <span class="main">=</span> Inr <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">⟹</span> length <span class="bound">s</span> <span class="main">≥</span> length <span class="bound">r</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_parser_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_parser_length<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_parser <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="free">s</span> <span class="main">=</span> Inr <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="free">s</span> <span class="main">≥</span> length <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A \emph{consuming parser} (cparser for short) consumes at least one token of input.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_cparser</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> parser <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_cparser</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">r</span> <span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">s</span> <span class="main">=</span> Inr <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">⟶</span> length <span class="bound">s</span> <span class="main">&gt;</span> length <span class="bound">r</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_cparserI <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">r</span> <span class="bound">x</span><span class="main">.</span> <span class="free">p</span> <span class="bound">s</span> <span class="main">=</span> Inr <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">⟹</span> length <span class="bound">s</span> <span class="main">&gt;</span> length <span class="bound">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_cparser <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> is_cparser_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> is_cparserE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_cparser <span class="free">p</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">s</span> <span class="bound">r</span> <span class="bound">x</span><span class="main">.</span> <span class="free">p</span> <span class="bound">s</span> <span class="main">=</span> Inr <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">⟹</span> length <span class="bound">s</span> <span class="main">&gt;</span> length <span class="bound">r</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_cparser_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_cparser_length<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_cparser <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="free">s</span> <span class="main">=</span> Inr <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="free">s</span> <span class="main">&gt;</span> length <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> is_parser_bind <span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"is_parser <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> is_parser <span class="main">(</span><span class="free">q</span> <span class="bound">x</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_parser <span class="main">(</span><span class="free">p</span> <span class="main">⤜</span> <span class="free">q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">r</span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">⤜</span> <span class="free">q</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> Inr <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">t</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="skolem">s</span> <span class="main">=</span> Inr <span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="skolem">y</span> <span class="skolem">t</span> <span class="main">=</span> Inr <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> bind_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="skolem">s</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">r</span> <span class="main">≤</span> length <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> q <span class="keyword2"><span class="keyword">and</span></span> Q <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_parser_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> length <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p <span class="keyword2"><span class="keyword">and</span></span> P <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_parser_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">r</span> <span class="main">≤</span> length <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">oneof</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string list <span class="main">⇒</span> string parser"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">oneof</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> oneof_aux <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> oneof_result<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"oneof <span class="free">xs</span> <span class="free">s</span> <span class="main">=</span> Inr <span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">w</span><span class="main">.</span> <span class="free">s</span> <span class="main">=</span> <span class="free">y</span> <span class="main">@</span> <span class="bound">w</span> <span class="main">@</span> <span class="free">r</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ys</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"oneof_aux <span class="skolem">ys</span> <span class="free">xs</span> <span class="free">s</span> <span class="main">=</span> Inr <span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="free">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">w</span><span class="main">.</span> <span class="free">s</span> <span class="main">=</span> <span class="free">y</span> <span class="main">@</span> <span class="bound">w</span> <span class="main">@</span> <span class="free">r</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> err_expecting_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">z</span> <span class="skolem">zs</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"map snd <span class="main">(</span>zip <span class="skolem">z</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">z</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">hence</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="skolem">z</span> <span class="main">@</span> drop <span class="main">(</span>length <span class="skolem">z</span><span class="main">)</span> <span class="free">s</span>"</span></span>          
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">z</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">zz</span><span class="main">)</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">from</span></span> trim<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span>length <span class="skolem">z</span><span class="main">)</span> <span class="free">s</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span>length <span class="skolem">z</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> <span class="skolem">w</span> <span class="main">@</span> trim <span class="main">(</span>drop <span class="main">(</span>length <span class="skolem">z</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">with</span></span> s <span class="keyword1"><span class="command">have</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="skolem">z</span> <span class="main">@</span> <span class="skolem">w</span> <span class="main">@</span> trim <span class="main">(</span>drop <span class="main">(</span>length <span class="skolem">z</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> True Cons<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> yz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="skolem">z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> trim <span class="main">(</span>drop <span class="main">(</span>length <span class="free">y</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> yz r<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> s<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>  
  <span class="keyword1"><span class="command">from</span></span> this <span class="main">[</span><span class="operator">OF</span> assms <span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> oneof_def<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">exactly</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> string parser"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">exactly</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> exactly_aux <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> exactly_result<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"exactly <span class="free">x</span> <span class="free">s</span> <span class="main">=</span> Inr <span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">w</span><span class="main">.</span> <span class="free">s</span> <span class="main">=</span> <span class="free">x</span> <span class="main">@</span> <span class="bound">w</span> <span class="main">@</span> <span class="free">r</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"exactly_aux <span class="skolem">a</span> <span class="skolem">b</span> <span class="free">x</span> <span class="free">s</span> <span class="main">=</span> Inr <span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="free">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">w</span><span class="main">.</span> <span class="free">s</span> <span class="main">=</span> <span class="free">x</span> <span class="main">@</span> <span class="bound">w</span> <span class="main">@</span> <span class="free">r</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil 
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> trim<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">c</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> xs <span class="main">=</span> this
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> Nil
        <span class="keyword1"><span class="command">with</span></span> xs <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> err_expecting_def<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">d</span> <span class="skolem">ss</span><span class="main">)</span>
        <span class="keyword1"><span class="command">note</span></span> xs <span class="main">=</span> xs<span class="main">[</span><span class="operator">unfolded</span> Cons<span class="main">]</span>
        <span class="keyword1"><span class="command">from</span></span> xs<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"exactly_aux <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">xs</span> <span class="skolem">ss</span> <span class="main">=</span> Inr <span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">c</span> <span class="main">=</span> <span class="skolem">d</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="skolem">d</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> err_expecting_def<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"exactly_aux <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">xs</span> <span class="skolem">ss</span> <span class="main">=</span> Inr <span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> xs<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> res<span class="main">]</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> Cons c <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">OF</span> assms <span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> exactly_def<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">hide_const</span></span> oneof_aux exactly_aux
 
<span class="keyword1"><span class="command">lemma</span></span> oneof_length<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"oneof <span class="free">xs</span> <span class="free">s</span> <span class="main">=</span> Inr <span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="free">s</span> <span class="main">≥</span> length <span class="free">y</span> <span class="main">+</span> length <span class="free">r</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> oneof_result <span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="free">y</span> <span class="main">@</span> <span class="skolem">w</span> <span class="main">@</span> <span class="free">r</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_parser_oneof <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_parser <span class="main">(</span>oneof <span class="free">ts</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">r</span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"oneof <span class="free">ts</span> <span class="skolem">s</span> <span class="main">=</span> Inr <span class="main">(</span><span class="skolem">x</span> <span class="main">,</span><span class="skolem">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> oneof_length <span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" length <span class="skolem">s</span> <span class="main">≥</span> length <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_cparser_oneof <span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">ts</span><span class="main">.</span> length <span class="bound">x</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_cparser <span class="main">(</span>oneof <span class="free">ts</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">r</span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"oneof <span class="free">ts</span> <span class="skolem">s</span> <span class="main">=</span> Inr <span class="main">(</span><span class="skolem">x</span> <span class="main">,</span><span class="skolem">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> oneof_length <span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> assms
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" length <span class="skolem">s</span> <span class="main">&gt;</span> length <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> exactly_length<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"exactly <span class="free">x</span> <span class="free">s</span> <span class="main">=</span> Inr <span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="free">s</span> <span class="main">≥</span> length <span class="free">x</span> <span class="main">+</span> length <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> exactly_result <span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="free">x</span> <span class="main">@</span> <span class="skolem">w</span> <span class="main">@</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_parser_exactly <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_parser <span class="main">(</span>exactly <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">r</span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"exactly <span class="free">xs</span> <span class="skolem">s</span> <span class="main">=</span> Inr <span class="main">(</span><span class="skolem">x</span> <span class="main">,</span><span class="skolem">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> exactly_length <span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">s</span> <span class="main">≥</span> length <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_cparser_exactly <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_cparser <span class="main">(</span>exactly <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">r</span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"exactly <span class="free">xs</span> <span class="skolem">s</span> <span class="main">=</span> Inr <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> exactly_length <span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">s</span> <span class="main">&gt;</span> length <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">many</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>char <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>char list<span class="main">)</span> parser"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">many</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="main">(</span><span class="bound">rs</span><span class="main">,</span> <span class="bound">ts'</span><span class="main">)</span> <span class="main">←</span> <span class="free">many</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">;</span>
      Error_Monad.return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">#</span> <span class="bound">rs</span><span class="main">,</span> <span class="bound">ts'</span><span class="main">)</span>
    <span class="main">}</span> <span class="keyword1">else</span> Error_Monad.return <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">many</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">[]</span> <span class="main">=</span> Error_Monad.return <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_parser_many <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_parser <span class="main">(</span>many <span class="free">P</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">r</span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"many <span class="free">P</span> <span class="skolem">s</span> <span class="main">=</span> Inr <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">r</span> <span class="main">≤</span> length <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">t</span> <span class="skolem">ts</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">t</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"many <span class="free">P</span> <span class="skolem">ts</span>"</span></span><span class="main">)</span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">manyof</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"char list <span class="main">⇒</span> <span class="main">(</span>char list<span class="main">)</span> parser"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">manyof</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">=</span> many <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_parser_manyof <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_parser <span class="main">(</span>manyof <span class="free">cs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> manyof_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">spaces</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"unit parser"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">spaces</span> <span class="main">=</span> manyof wspace <span class="main">⪢</span> return <span class="main">()</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_parser_return <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_parser <span class="main">(</span>return <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_parser_def return_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_parser_error <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_parser <span class="main">(</span>error <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_parser_def error_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_parser_If <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_parser <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"is_parser <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_parser <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="free">p</span> <span class="keyword1">else</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> is_parser_Let <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_parser <span class="main">(</span><span class="free">f</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_parser <span class="main">(</span><span class="keyword1">let</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">y</span> <span class="keyword1">in</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> is_parser_spaces <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_parser spaces"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> spaces_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">scan_upto</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"string <span class="main">⇒</span> string parser"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">scan_upto</span> <span class="free"><span class="bound"><span class="entity">end</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> map snd <span class="main">(</span>zip <span class="free"><span class="bound"><span class="entity">end</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">end</span></span></span> <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span>
       Error_Monad.return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">end</span></span></span><span class="main">,</span> List.drop <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">end</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="main">(</span><span class="bound">res</span><span class="main">,</span> <span class="bound">ts'</span><span class="main">)</span> <span class="main">←</span> <span class="free">scan_upto</span> <span class="free"><span class="bound"><span class="entity">end</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">;</span>
      Error_Monad.return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">#</span> <span class="bound">res</span><span class="main">,</span> <span class="bound">ts'</span><span class="main">)</span>
    <span class="main">}</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">scan_upto</span> <span class="free"><span class="bound"><span class="entity">end</span></span></span> <span class="main">[]</span> <span class="main">=</span> Error_Monad.error <span class="main">(</span><span class="inner_quoted">''did not find end-marker ''</span> <span class="main">@</span> shows_quote <span class="main">(</span>shows <span class="free"><span class="bound"><span class="entity">end</span></span></span><span class="main">)</span> <span class="main">[]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> scan_upto_length<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"scan_upto <span class="free">end</span> <span class="free">s</span> <span class="main">=</span> Inr <span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="free">s</span> <span class="main">≥</span> length <span class="free">end</span> <span class="main">+</span> length <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">t</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"map snd <span class="main">(</span>zip <span class="free">end</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">#</span> <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">end</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tss</span></span> <span class="keyword2"><span class="keyword">where</span></span> tss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tss</span> <span class="main">=</span> <span class="skolem">t</span> <span class="main">#</span> <span class="skolem">ts</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> map<span class="main">:</span> <span class="quoted"><span class="quoted">"map snd <span class="main">(</span>zip <span class="free">end</span> <span class="skolem">tss</span><span class="main">)</span> <span class="main">=</span> <span class="free">end</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> map <span class="keyword1"><span class="command">have</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">tss</span> <span class="main">≥</span> length <span class="free">end</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">end</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">tss</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">e</span> <span class="skolem">en</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">tss</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> True tss Cons<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="free">end</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> List.drop <span class="main">(</span>length <span class="free">end</span><span class="main">)</span> <span class="skolem">tss</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> tss<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> y r<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> len<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">res</span></span> <span class="skolem"><span class="skolem">ts'</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"scan_upto <span class="free">end</span> <span class="skolem">ts</span> <span class="main">=</span> Inr <span class="main">(</span><span class="skolem">res</span><span class="main">,</span><span class="skolem">ts'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"scan_upto <span class="free">end</span> <span class="skolem">ts</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> Cons<span class="main">(</span>2<span class="main">)</span> False this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> is_parser_scan_upto <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_parser <span class="main">(</span>scan_upto <span class="free">end</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_parser_def <span class="keyword1"><span class="command">using</span></span> scan_upto_length <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">end</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> is_cparser_scan_upto <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_cparser <span class="main">(</span>scan_upto <span class="main">(</span><span class="free">e</span> <span class="main">#</span> <span class="free">end</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_cparser_def <span class="keyword1"><span class="command">using</span></span> scan_upto_length <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">#</span> <span class="free">end</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="Misc">
<div class="head">
<h1>Theory Misc</h1>
</div>
<pre class="source"><span class="comment1">(* Title:     Parser_Monad
   Author:    Christian Sternagel
   Author:    René Thiemann
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹More material on parsing›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Misc
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">span</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">×</span> <span class="tfree">'a</span> list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">span</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">(</span>takeWhile <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> dropWhile <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> span_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"span <span class="free">P</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"span <span class="free">P</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free">P</span> <span class="free">x</span> <span class="keyword1">then</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">zs</span><span class="main">)</span> <span class="main">=</span> span <span class="free">P</span> <span class="free">xs</span> <span class="keyword1">in</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="bound">ys</span><span class="main">,</span> <span class="bound">zs</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">splitter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"char list <span class="main">⇒</span> string <span class="main">⇒</span> string <span class="main">×</span> string"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">splitter</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> span <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>