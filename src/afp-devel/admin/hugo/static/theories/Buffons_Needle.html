<div id="Buffons_Needle">
<div class="head">
<h1>Theory Buffons_Needle</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:    Buffons_Needle.thy
  Author:  Manuel Eberl &lt;eberlm@in.tum.de&gt;

  A formal solution of Buffon's needle problem.
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Buffon's Needle Problem›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Buffons_Needle
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../../HOL/HOL-Probability/Probability.html">HOL-Probability.Probability</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary material›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sin_le_zero'<span class="main">:</span> <span class="quoted"><span class="quoted">"sin <span class="free">x</span> <span class="main">≤</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="main">-</span>pi"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">x</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> minus_le_iff neg_0_le_iff_le sin_ge_zero sin_minus that<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> that<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Problem definition›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Consider a needle of length $l$ whose centre has the $x$-coordinate $x$. The following then
  defines the set of all $x$-coordinates that the needle covers 
  (i.e. the projection of the needle onto the $x$-axis.)
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">needle</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> real <span class="main">⇒</span> real set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">needle</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> closed_segment <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> sin <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> sin <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Buffon's Needle problem is then this: Assuming the needle's $x$ position is chosen uniformly
  at random in a strip of width $d$ centred at the origin, what is the probability that the 
  needle crosses at least one of the left/right boundaries of that strip (located at 
  $x = \pm\frac{1}{2}d$)?
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">buffon</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> bool measure"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">buffon</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> 
     <span class="keyword1">do</span> <span class="main">{</span>
       <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">←</span> uniform_measure lborel <span class="main">(</span><span class="main">{</span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">/</span><span class="numeral">2</span><span class="main">..</span><span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">/</span><span class="numeral">2</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">-</span>pi<span class="main">..</span>pi<span class="main">}</span><span class="main">)</span><span class="main">;</span>
       return <span class="main">(</span>count_space UNIV<span class="main">)</span> <span class="main">(</span>needle <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="bound">x</span> <span class="bound">φ</span> <span class="main">∩</span> <span class="main">{</span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">/</span><span class="numeral">2</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">/</span><span class="numeral">2</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>
     <span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Derivation of the solution›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following form is a bit easier to handle.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> buffon_altdef<span class="main">:</span>
  <span class="quoted"><span class="quoted">"buffon <span class="free">l</span> <span class="free">d</span> <span class="main">=</span>
     <span class="keyword1">do</span> <span class="main">{</span>
       <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">←</span> uniform_measure lborel <span class="main">(</span><span class="main">{</span><span class="main">-</span><span class="free">d</span><span class="main">/</span><span class="numeral">2</span><span class="main">..</span><span class="free">d</span><span class="main">/</span><span class="numeral">2</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">-</span>pi<span class="main">..</span>pi<span class="main">}</span><span class="main">)</span><span class="main">;</span>
       return <span class="main">(</span>count_space UNIV<span class="main">)</span> 
         <span class="main">(</span><span class="keyword1">let</span> <span class="bound">a</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">-</span> <span class="free">l</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> sin <span class="bound">φ</span><span class="main">;</span> <span class="bound">b</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">l</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> sin <span class="bound">φ</span>
          <span class="keyword1">in</span>  min <span class="bound">a</span> <span class="bound">b</span> <span class="main">+</span> <span class="free">d</span><span class="main">/</span><span class="numeral">2</span> <span class="main">≤</span> <span class="main">0</span> <span class="main">∧</span> max <span class="bound">a</span> <span class="bound">b</span> <span class="main">+</span> <span class="free">d</span><span class="main">/</span><span class="numeral">2</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">∨</span> min <span class="bound">a</span> <span class="bound">b</span> <span class="main">-</span> <span class="free">d</span><span class="main">/</span><span class="numeral">2</span> <span class="main">≤</span> <span class="main">0</span> <span class="main">∧</span> max <span class="bound">a</span> <span class="bound">b</span> <span class="main">-</span> <span class="free">d</span><span class="main">/</span><span class="numeral">2</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span>
     <span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> buffon_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">d</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">φ</span><span class="main">)</span><span class="main">.</span> needle <span class="free">l</span> <span class="bound">x</span> <span class="bound">φ</span> <span class="main">∩</span> <span class="main">{</span><span class="main">-</span><span class="free">d</span><span class="main">/</span><span class="numeral">2</span><span class="main">,</span> <span class="free">d</span><span class="main">/</span><span class="numeral">2</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">φ</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">let</span> <span class="bound">a</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">-</span> <span class="free">l</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> sin <span class="bound">φ</span><span class="main">;</span> <span class="bound">b</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">l</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> sin <span class="bound">φ</span>
                 <span class="keyword1">in</span>  <span class="main">-</span><span class="free">d</span><span class="main">/</span><span class="numeral">2</span> <span class="main">≥</span> min <span class="bound">a</span> <span class="bound">b</span> <span class="main">∧</span> <span class="main">-</span><span class="free">d</span><span class="main">/</span><span class="numeral">2</span> <span class="main">≤</span> max <span class="bound">a</span> <span class="bound">b</span> <span class="main">∨</span> min <span class="bound">a</span> <span class="bound">b</span> <span class="main">≤</span> <span class="free">d</span><span class="main">/</span><span class="numeral">2</span> <span class="main">∧</span> max <span class="bound">a</span> <span class="bound">b</span> <span class="main">≥</span> <span class="free">d</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> needle_def Let_def closed_segment_eq_real_ivl min_def max_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> 
      <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">φ</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">let</span> <span class="bound">a</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">-</span> <span class="free">l</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> sin <span class="bound">φ</span><span class="main">;</span> <span class="bound">b</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">l</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> sin <span class="bound">φ</span>
               <span class="keyword1">in</span>  min <span class="bound">a</span> <span class="bound">b</span> <span class="main">+</span> <span class="free">d</span><span class="main">/</span><span class="numeral">2</span> <span class="main">≤</span> <span class="main">0</span> <span class="main">∧</span> max <span class="bound">a</span> <span class="bound">b</span> <span class="main">+</span> <span class="free">d</span><span class="main">/</span><span class="numeral">2</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">∨</span> min <span class="bound">a</span> <span class="bound">b</span> <span class="main">-</span> <span class="free">d</span><span class="main">/</span><span class="numeral">2</span> <span class="main">≤</span> <span class="main">0</span> <span class="main">∧</span> max <span class="bound">a</span> <span class="bound">b</span> <span class="main">-</span> <span class="free">d</span><span class="main">/</span><span class="numeral">2</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">φ</span><span class="main">)</span><span class="main">.</span> return <span class="main">(</span>count_space UNIV<span class="main">)</span> <span class="main">(</span>needle <span class="free">l</span> <span class="bound">x</span> <span class="bound">φ</span> <span class="main">∩</span> <span class="main">{</span><span class="main">-</span> <span class="free">d</span><span class="main">/</span><span class="numeral">2</span><span class="main">,</span> <span class="free">d</span><span class="main">/</span><span class="numeral">2</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                  <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">φ</span><span class="main">)</span><span class="main">.</span> return <span class="main">(</span>count_space UNIV<span class="main">)</span> 
                    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">a</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">-</span> <span class="free">l</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> sin <span class="bound">φ</span><span class="main">;</span> <span class="bound">b</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">l</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> sin <span class="bound">φ</span>
                     <span class="keyword1">in</span>  min <span class="bound">a</span> <span class="bound">b</span> <span class="main">+</span> <span class="free">d</span><span class="main">/</span><span class="numeral">2</span> <span class="main">≤</span> <span class="main">0</span> <span class="main">∧</span> max <span class="bound">a</span> <span class="bound">b</span> <span class="main">+</span> <span class="free">d</span><span class="main">/</span><span class="numeral">2</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">∨</span> min <span class="bound">a</span> <span class="bound">b</span> <span class="main">-</span> <span class="free">d</span><span class="main">/</span><span class="numeral">2</span> <span class="main">≤</span> <span class="main">0</span> <span class="main">∧</span> max <span class="bound">a</span> <span class="bound">b</span> <span class="main">-</span> <span class="free">d</span><span class="main">/</span><span class="numeral">2</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_unfold fun_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>
    
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  It is obvious that the problem boils down to determining the measure of the following set:
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">buffon_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> <span class="main">(</span>real <span class="main">×</span> real<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">buffon_set</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound"><span class="bound">x</span></span><span class="main">,</span><span class="bound"><span class="bound">φ</span></span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">/</span><span class="numeral">2</span><span class="main">..</span><span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">/</span><span class="numeral">2</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">-</span>pi<span class="main">..</span>pi<span class="main">}</span><span class="main">.</span> abs <span class="bound">x</span> <span class="main">≥</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">-</span> abs <span class="main">(</span>sin <span class="bound">φ</span><span class="main">)</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">/</span> <span class="numeral">2</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  By using the symmetry inherent in the problem, we can reduce the problem to the following 
  set, which corresponds to one quadrant of the original set:
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">buffon_set'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> <span class="main">(</span>real <span class="main">×</span> real<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">buffon_set'</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound"><span class="bound">x</span></span><span class="main">,</span><span class="bound"><span class="bound">φ</span></span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">/</span><span class="numeral">2</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span>pi<span class="main">}</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≥</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">-</span> sin <span class="bound">φ</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">/</span> <span class="numeral">2</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> closed_buffon_set <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">,</span> <span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"closed <span class="main">(</span>buffon_set <span class="free">l</span> <span class="free">d</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"buffon_set <span class="free">l</span> <span class="free">d</span> <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="main">-</span><span class="free">d</span><span class="main">/</span><span class="numeral">2</span><span class="main">..</span><span class="free">d</span><span class="main">/</span><span class="numeral">2</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">-</span>pi<span class="main">..</span>pi<span class="main">}</span><span class="main">)</span> <span class="main">∩</span> 
          <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> abs <span class="main">(</span>fst <span class="bound">z</span><span class="main">)</span> <span class="main">+</span> abs <span class="main">(</span>sin <span class="main">(</span>snd <span class="bound">z</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">l</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">-</span> <span class="free">d</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">-`</span> <span class="main">{</span><span class="main">0</span><span class="main">..}</span>"</span></span> 
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?A</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> buffon_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed <span class="main">…</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> closed_Int closed_vimage closed_Times<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> closed_buffon_set' <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">,</span> <span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"closed <span class="main">(</span>buffon_set' <span class="free">l</span> <span class="free">d</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"buffon_set' <span class="free">l</span> <span class="free">d</span> <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">d</span><span class="main">/</span><span class="numeral">2</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span>pi<span class="main">}</span><span class="main">)</span> <span class="main">∩</span> 
          <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> fst <span class="bound">z</span> <span class="main">+</span> sin <span class="main">(</span>snd <span class="bound">z</span><span class="main">)</span> <span class="main">*</span> <span class="free">l</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">-</span> <span class="free">d</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">-`</span> <span class="main">{</span><span class="main">0</span><span class="main">..}</span>"</span></span> 
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?A</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> buffon_set'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed <span class="main">…</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> closed_Int closed_vimage closed_Times<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> measurable_buffon_set <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"buffon_set <span class="free">l</span> <span class="free">d</span> <span class="main">∈</span> sets borel"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>

<span class="keyword1"><span class="command">lemma</span></span> measurable_buffon_set' <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"buffon_set' <span class="free">l</span> <span class="free">d</span> <span class="main">∈</span> sets borel"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>


<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">d</span> <span class="free">l</span> <span class="main">::</span> <span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> buffon_altdef'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"buffon <span class="free">l</span> <span class="free">d</span> <span class="main">=</span> distr <span class="main">(</span>uniform_measure lborel <span class="main">(</span><span class="main">{</span><span class="main">-</span><span class="free">d</span><span class="main">/</span><span class="numeral">2</span><span class="main">..</span><span class="free">d</span><span class="main">/</span><span class="numeral">2</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">-</span>pi<span class="main">..</span>pi<span class="main">}</span><span class="main">)</span><span class="main">)</span>
                  <span class="main">(</span>count_space UNIV<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈</span> buffon_set <span class="free">l</span> <span class="free">d</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">φ</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">let</span> <span class="bound">a</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">-</span> <span class="free">l</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> sin <span class="bound">φ</span><span class="main">;</span> <span class="bound">b</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">l</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> sin <span class="bound">φ</span>
                    <span class="keyword1">in</span>  min <span class="bound">a</span> <span class="bound">b</span> <span class="main">+</span> <span class="free">d</span><span class="main">/</span><span class="numeral">2</span> <span class="main">≤</span> <span class="main">0</span> <span class="main">∧</span> max <span class="bound">a</span> <span class="bound">b</span> <span class="main">+</span> <span class="free">d</span><span class="main">/</span><span class="numeral">2</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">∨</span> min <span class="bound">a</span> <span class="bound">b</span> <span class="main">-</span> <span class="free">d</span><span class="main">/</span><span class="numeral">2</span> <span class="main">≤</span> <span class="main">0</span> <span class="main">∧</span> max <span class="bound">a</span> <span class="bound">b</span> <span class="main">-</span> <span class="free">d</span><span class="main">/</span><span class="numeral">2</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"buffon <span class="free">l</span> <span class="free">d</span> <span class="main">=</span> 
          uniform_measure lborel <span class="main">(</span><span class="main">{</span><span class="main">-</span> <span class="free">d</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">..</span><span class="free">d</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">-</span>pi<span class="main">..</span>pi<span class="main">}</span><span class="main">)</span> <span class="main">⤜</span>
          <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> return <span class="main">(</span>count_space UNIV<span class="main">)</span> <span class="main">(</span><span class="var">?P</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> buffon_altdef case_prod_unfold <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> uniform_measure lborel <span class="main">(</span><span class="main">{</span><span class="main">-</span> <span class="free">d</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">..</span><span class="free">d</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">-</span>pi<span class="main">..</span>pi<span class="main">}</span><span class="main">)</span> <span class="main">⤜</span>
          <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> return <span class="main">(</span>count_space UNIV<span class="main">)</span> <span class="main">(</span><span class="bound">z</span> <span class="main">∈</span> buffon_set <span class="free">l</span> <span class="free">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> bind_cong_AE AE_uniform_measureI AE_I2 impI refl return_measurable<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> return <span class="main">(</span>count_space UNIV<span class="main">)</span> <span class="main">(</span><span class="var">?P</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span>
             <span class="main">∈</span> uniform_measure lborel <span class="main">(</span><span class="main">{</span><span class="main">-</span> <span class="free">d</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">..</span><span class="free">d</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">-</span> pi<span class="main">..</span>pi<span class="main">}</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span>
                 subprob_algebra <span class="main">(</span>count_space UNIV<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Let_def case_prod_unfold lborel_prod <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> return <span class="main">(</span>count_space UNIV<span class="main">)</span> <span class="main">(</span><span class="bound">z</span> <span class="main">∈</span> buffon_set <span class="free">l</span> <span class="free">d</span><span class="main">)</span><span class="main">)</span>
            <span class="main">∈</span> uniform_measure lborel <span class="main">(</span><span class="main">{</span><span class="main">-</span> <span class="free">d</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">..</span><span class="free">d</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">-</span> pi<span class="main">..</span>pi<span class="main">}</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>M</sub></span>
                subprob_algebra <span class="main">(</span>count_space UNIV<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">z</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">z</span> <span class="main">⟷</span> <span class="skolem">z</span> <span class="main">∈</span> buffon_set <span class="free">l</span> <span class="free">d</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"snd <span class="skolem">z</span> <span class="main">≥</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> 4 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">z</span> <span class="main">-</span> <span class="free">l</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> sin <span class="main">(</span>snd <span class="skolem">z</span><span class="main">)</span> <span class="main">≤</span> fst <span class="skolem">z</span> <span class="main">+</span> <span class="free">l</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> sin <span class="main">(</span>snd <span class="skolem">z</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sin_ge_zero<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> True <span class="keyword2"><span class="keyword">and</span></span> 4 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sin <span class="main">(</span>snd <span class="skolem">z</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sin_ge_zero<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 4 True <span class="keyword1"><span class="command">unfolding</span></span> buffon_set_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> Let_def min_def max_def case_prod_unfold abs_if<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> 4 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">z</span> <span class="main">-</span> <span class="free">l</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> sin <span class="main">(</span>snd <span class="skolem">z</span><span class="main">)</span> <span class="main">≥</span> fst <span class="skolem">z</span> <span class="main">+</span> <span class="free">l</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> sin <span class="main">(</span>snd <span class="skolem">z</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sin_le_zero' mult_nonneg_nonpos<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> False <span class="keyword2"><span class="keyword">and</span></span> 4 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sin <span class="main">(</span>snd <span class="skolem">z</span><span class="main">)</span> <span class="main">≤</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sin_le_zero'<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword2"><span class="keyword">and</span></span> False
        <span class="keyword1"><span class="command">unfolding</span></span> buffon_set_def <span class="keyword1"><span class="command">using</span></span> l d
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> Let_def min_def max_def case_prod_unfold abs_if<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> <span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> borel_prod <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> distr <span class="main">(</span>uniform_measure lborel <span class="main">(</span><span class="main">{</span><span class="main">-</span><span class="free">d</span><span class="main">/</span><span class="numeral">2</span><span class="main">..</span><span class="free">d</span><span class="main">/</span><span class="numeral">2</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">-</span>pi<span class="main">..</span>pi<span class="main">}</span><span class="main">)</span><span class="main">)</span> 
                    <span class="main">(</span>count_space UNIV<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈</span> buffon_set <span class="free">l</span> <span class="free">d</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bind_return_distr'<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> buffon_prob_aux<span class="main">:</span>
  <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>buffon <span class="free">l</span> <span class="free">d</span><span class="main">)</span> <span class="main">{</span>True<span class="main">}</span> <span class="main">=</span> emeasure lborel <span class="main">(</span>buffon_set <span class="free">l</span> <span class="free">d</span><span class="main">)</span> <span class="main">/</span> ennreal <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">d</span> <span class="main">*</span> pi<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">×</span> <span class="skolem">B</span> <span class="main">∈</span> sets borel"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> sets borel"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∈</span> sets borel"</span></span> 
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real set"</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> borel_prod <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>buffon <span class="free">l</span> <span class="free">d</span><span class="main">)</span> <span class="main">{</span>True<span class="main">}</span> <span class="main">=</span> 
          emeasure <span class="main">(</span>uniform_measure lborel <span class="main">(</span><span class="main">{</span><span class="main">-</span> <span class="main">(</span><span class="free">d</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span><span class="main">..</span><span class="free">d</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">-</span>pi<span class="main">..</span>pi<span class="main">}</span><span class="main">)</span><span class="main">)</span>
          <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈</span> buffon_set <span class="free">l</span> <span class="free">d</span><span class="main">)</span> <span class="main">-`</span> <span class="main">{</span>True<span class="main">}</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> emeasure <span class="var">?M</span> <span class="main">_</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> buffon_altdef' emeasure_distr<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈</span> buffon_set <span class="free">l</span> <span class="free">d</span><span class="main">)</span> <span class="main">-`</span> <span class="main">{</span>True<span class="main">}</span> <span class="main">=</span> buffon_set <span class="free">l</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"buffon_set <span class="free">l</span> <span class="free">d</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">-</span><span class="free">d</span><span class="main">/</span><span class="numeral">2</span><span class="main">..</span><span class="free">d</span><span class="main">/</span><span class="numeral">2</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">-</span>pi<span class="main">..</span>pi<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> l d <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> buffon_set_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="var">?M</span> <span class="main">(</span>buffon_set <span class="free">l</span> <span class="free">d</span><span class="main">)</span> <span class="main">=</span> 
           emeasure lborel <span class="main">(</span>buffon_set <span class="free">l</span> <span class="free">d</span><span class="main">)</span> <span class="main">/</span> emeasure lborel <span class="main">(</span><span class="main">{</span><span class="main">-</span> <span class="main">(</span><span class="free">d</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span><span class="main">..</span><span class="free">d</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">-</span>pi<span class="main">..</span>pi<span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> emeasure_uniform_measure<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Int_absorb1<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure lborel <span class="main">(</span><span class="main">{</span><span class="main">-</span> <span class="main">(</span><span class="free">d</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span><span class="main">..</span><span class="free">d</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">-</span>pi<span class="main">..</span>pi<span class="main">}</span><span class="main">)</span> <span class="main">=</span> ennreal <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> pi <span class="main">*</span> <span class="free">d</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> d <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lborel_prod <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> lborel.emeasure_pair_measure_Times
                          ennreal_mult <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_ac<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> emeasure_buffon_set_conv_buffon_set'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"emeasure lborel <span class="main">(</span>buffon_set <span class="free">l</span> <span class="free">d</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">4</span> <span class="main">*</span> emeasure lborel <span class="main">(</span>buffon_set' <span class="free">l</span> <span class="free">d</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> distr_lborel <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"distr <span class="skolem">M</span> lborel <span class="skolem">f</span> <span class="main">=</span> distr <span class="skolem">M</span> borel <span class="skolem">f</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">M</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> distr_cong<span class="main">)</span> <span class="operator">simp_all</span>
    
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> buffon_set' <span class="free">l</span> <span class="free">d</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span>fst <span class="bound">x</span><span class="main">,</span> snd <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">-`</span> <span class="skolem">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">,</span> <span class="main">-</span>snd <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">-`</span> <span class="skolem">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span>fst <span class="bound">x</span><span class="main">,</span> <span class="main">-</span>snd <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">-`</span> <span class="skolem">A</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> meas <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span>
     <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">::</span>real <span class="main">×</span> real<span class="main">.</span> <span class="main">(</span><span class="main">-</span>fst <span class="bound">x</span><span class="main">,</span> snd <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> borel_measurable borel"</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">::</span>real <span class="main">×</span> real<span class="main">.</span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">,</span> <span class="main">-</span>snd <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> borel_measurable borel"</span></span>
     <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">::</span>real <span class="main">×</span> real<span class="main">.</span> <span class="main">(</span><span class="main">-</span>fst <span class="bound">x</span><span class="main">,</span> <span class="main">-</span>snd <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> borel_measurable borel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> borel_prod <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>
  <span class="keyword1"><span class="command">have</span></span> meas' <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> sets borel"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∈</span> sets borel"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">∈</span> sets borel"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">∈</span> sets borel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> A_def B_def C_def D_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> measurable_buffon_set' measurable_sets_borel meas<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"buffon_set <span class="free">l</span> <span class="free">d</span> <span class="main">=</span> <span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span> <span class="main">∪</span> <span class="skolem">C</span> <span class="main">∪</span> <span class="skolem">D</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">z</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">z</span> <span class="main">≥</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"snd <span class="skolem">z</span> <span class="main">≥</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">z</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">z</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> buffon_set_def buffon_set'_def sin_ge_zero A_def<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>   
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span>fst <span class="skolem">z</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">z</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="skolem">B</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> buffon_set_def buffon_set'_def sin_ge_zero A_def B_def<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>    
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">z</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span>snd <span class="skolem">z</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="skolem">C</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> buffon_set_def buffon_set'_def sin_le_zero' A_def C_def<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>   
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span>fst <span class="skolem">z</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span>snd <span class="skolem">z</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="skolem">D</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> buffon_set_def buffon_set'_def sin_le_zero' A_def D_def<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> buffon_set_def buffon_set'_def sin_ge_zero sin_le_zero'  A_def B_def C_def D_def<span class="main">)</span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∩</span> <span class="skolem">B</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="main">×</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..</span>pi<span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">φ</span><span class="main">.</span> sin <span class="bound">φ</span> <span class="main">*</span> <span class="free">l</span> <span class="main">-</span> <span class="free">d</span> <span class="main">≥</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> d l <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> buffon_set'_def  A_def B_def C_def D_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure lborel <span class="main">…</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lborel_prod <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> lborel.emeasure_pair_measure_Times<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> AB<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span> <span class="main">∩</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> null_sets lborel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lborel_prod <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> null_sets_def<span class="main">)</span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">∩</span> <span class="skolem">D</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="main">×</span> <span class="main">(</span><span class="main">{</span><span class="main">-</span>pi<span class="main">..</span><span class="main">0</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">φ</span><span class="main">.</span> <span class="main">-</span>sin <span class="bound">φ</span> <span class="main">*</span> <span class="free">l</span> <span class="main">-</span> <span class="free">d</span> <span class="main">≥</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> d l <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> buffon_set'_def  A_def B_def C_def D_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure lborel <span class="main">…</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lborel_prod <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> lborel.emeasure_pair_measure_Times<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> CD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C</span> <span class="main">∩</span> <span class="skolem">D</span><span class="main">)</span> <span class="main">∈</span> null_sets lborel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lborel_prod <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> null_sets_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∩</span> <span class="skolem">D</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∩</span> <span class="skolem">C</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> d l 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> buffon_set'_def A_def D_def B_def C_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∩</span> <span class="skolem">C</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="free">d</span><span class="main">/</span><span class="numeral">2</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∩</span> <span class="skolem">D</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="main">-</span><span class="free">d</span><span class="main">/</span><span class="numeral">2</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> d l <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> case_prod_unfold buffon_set'_def A_def B_def C_def D_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> AD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∩</span> <span class="skolem">D</span> <span class="main">∈</span> null_sets lborel"</span></span> <span class="keyword2"><span class="keyword">and</span></span> BC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∩</span> <span class="skolem">C</span> <span class="main">∈</span> null_sets lborel"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    AC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∩</span> <span class="skolem">C</span> <span class="main">∈</span> null_sets lborel"</span></span> <span class="keyword2"><span class="keyword">and</span></span> BD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∩</span> <span class="skolem">D</span> <span class="main">∈</span> null_sets lborel"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">note</span></span> *
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure lborel <span class="main">(</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span> <span class="main">∪</span> <span class="skolem">C</span> <span class="main">∪</span> <span class="skolem">D</span><span class="main">)</span> <span class="main">=</span> emeasure lborel <span class="main">(</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span> <span class="main">∪</span> <span class="skolem">C</span><span class="main">)</span> <span class="main">+</span> emeasure lborel <span class="skolem">D</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> AB AC AD BC BD CD <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> emeasure_Un'<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Int_Un_distrib2<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure lborel <span class="main">(</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span> <span class="main">∪</span> <span class="skolem">C</span><span class="main">)</span> <span class="main">=</span> emeasure lborel <span class="main">(</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">+</span> emeasure lborel <span class="skolem">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> AB AC BC <span class="keyword1"><span class="command">using</span></span> AB AC AD BC BD CD <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> emeasure_Un'<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Int_Un_distrib2<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure lborel <span class="main">(</span><span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">=</span> emeasure lborel <span class="skolem">A</span> <span class="main">+</span> emeasure lborel <span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> AB <span class="keyword1"><span class="command">using</span></span> AB AC AD BC BD CD <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> emeasure_Un'<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Int_Un_distrib2<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure lborel <span class="skolem">B</span> <span class="main">=</span> emeasure <span class="main">(</span>distr lborel lborel <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">A</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> emeasure <span class="var">?M</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> B_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> emeasure_distr<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">=</span> lborel"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lborel_prod <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> pair_measure_distr <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sigma_finite_lborel lborel_distr_uminus<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure lborel <span class="skolem">C</span> <span class="main">=</span> emeasure <span class="main">(</span>distr lborel lborel <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="main">-</span><span class="bound">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">A</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> emeasure <span class="var">?M</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> C_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> emeasure_distr<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">=</span> lborel"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lborel_prod <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> pair_measure_distr <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sigma_finite_lborel lborel_distr_uminus<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure lborel <span class="skolem">D</span> <span class="main">=</span> emeasure <span class="main">(</span>distr lborel lborel <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span><span class="bound">x</span><span class="main">,</span> <span class="main">-</span><span class="bound">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">A</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> emeasure <span class="var">?M</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> D_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> emeasure_distr<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">=</span> lborel"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lborel_prod <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> pair_measure_distr <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sigma_finite_lborel lborel_distr_uminus<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure lborel <span class="main">(</span>buffon_set <span class="free">l</span> <span class="free">d</span><span class="main">)</span> <span class="main">=</span> 
                  of_nat <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> emeasure lborel <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> of_nat_Suc ring_distribs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"of_nat <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">4</span> <span class="main">::</span> ennreal<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> A_def <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  It only remains now to compute the measure of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> buffon_set'<span class="antiquote"><span class="antiquote">}</span></span></span></span>. We first reduce this
  problem to a relatively simple integral:
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> emeasure_buffon_set'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"emeasure lborel <span class="main">(</span>buffon_set' <span class="free">l</span> <span class="free">d</span><span class="main">)</span> <span class="main">=</span> 
     ennreal <span class="main">(</span>integral <span class="main">{</span><span class="main">0</span><span class="main">..</span>pi<span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> min <span class="main">(</span><span class="free">d</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">(</span>sin <span class="bound">x</span> <span class="main">*</span> <span class="free">l</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"emeasure lborel <span class="var">?A</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure lborel <span class="var">?A</span> <span class="main">=</span> nn_integral lborel <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> indicator <span class="var">?A</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_indicator <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lborel <span class="main">::</span> <span class="main">(</span>real <span class="main">×</span> real<span class="main">)</span> measure<span class="main">)</span> <span class="main">=</span> lborel <span class="keyword1">⨂<span class="hidden">⇩</span><sub>M</sub></span> lborel"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> lborel_prod<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nn_integral <span class="main">…</span> <span class="main">(</span>indicator <span class="var">?A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">φ</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> indicator <span class="var">?A</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">∂</span>lborel <span class="main">∂</span>lborel<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> lborel_pair.nn_integral_snd <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lborel_prod borel_prod<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">φ</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">x</span><span class="main">.</span> indicator <span class="main">{</span><span class="main">0</span><span class="main">..</span>pi<span class="main">}</span> <span class="bound">φ</span> <span class="main">*</span> indicator <span class="main">{</span>max <span class="main">0</span> <span class="main">(</span><span class="free">d</span><span class="main">/</span><span class="numeral">2</span> <span class="main">-</span> sin <span class="bound">φ</span> <span class="main">*</span> <span class="free">l</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">..</span> <span class="free">d</span><span class="main">/</span><span class="numeral">2</span><span class="main">}</span> <span class="bound">x</span> <span class="main">∂</span>lborel <span class="main">∂</span>lborel<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> d l <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indicator_def <span class="dynamic"><span class="dynamic">field_simps</span></span> buffon_set'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">φ</span><span class="main">.</span> indicator <span class="main">{</span><span class="main">0</span><span class="main">..</span>pi<span class="main">}</span> <span class="bound">φ</span> <span class="main">*</span> emeasure lborel <span class="main">{</span>max <span class="main">0</span> <span class="main">(</span><span class="free">d</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">-</span> sin <span class="bound">φ</span> <span class="main">*</span> <span class="free">l</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span><span class="main">..</span><span class="free">d</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">}</span> <span class="main">∂</span>lborel"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> nn_integral_cmult<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">φ</span><span class="main">.</span> ennreal <span class="main">(</span>indicator <span class="main">{</span><span class="main">0</span><span class="main">..</span>pi<span class="main">}</span> <span class="bound">φ</span> <span class="main">*</span> min <span class="main">(</span><span class="free">d</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">(</span>sin <span class="bound">φ</span> <span class="main">*</span> <span class="free">l</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span>lborel"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?I</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> d l <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nn_integral_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indicator_def sin_ge_zero max_def min_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"integrable lborel <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> <span class="main">(</span><span class="free">d</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> indicator <span class="main">{</span><span class="main">0</span><span class="main">..</span>pi<span class="main">}</span> <span class="bound">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> int<span class="main">:</span> <span class="quoted"><span class="quoted">"integrable lborel <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> indicator <span class="main">{</span><span class="main">0</span><span class="main">..</span>pi<span class="main">}</span> <span class="bound">φ</span> <span class="main">*</span> min <span class="main">(</span><span class="free">d</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">(</span>sin <span class="bound">φ</span> <span class="main">*</span> <span class="free">l</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Bochner_Integration.integrable_bound<span class="main">)</span>
       <span class="main">(</span><span class="operator">insert</span> l d<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> AE_I2 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indicator_def min_def sin_ge_zero<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?I</span> <span class="main">=</span> set_lebesgue_integral lborel <span class="main">{</span><span class="main">0</span><span class="main">..</span>pi<span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> min <span class="main">(</span><span class="free">d</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">(</span>sin <span class="bound">φ</span> <span class="main">*</span> <span class="free">l</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> nn_integral_eq_integral<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
       <span class="main">(</span><span class="operator">insert</span> d l<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> AE_I2 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sin_ge_zero min_def indicator_def set_lebesgue_integral_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> ennreal <span class="main">(</span>integral <span class="main">{</span><span class="main">0</span><span class="main">..</span>pi<span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> min <span class="main">(</span><span class="free">d</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">(</span>sin <span class="bound">x</span> <span class="main">*</span> <span class="free">l</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> ennreal <span class="var">?I</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> int <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> set_borel_integral_eq_integral<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_integrable_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lborel_prod<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now have to distinguish two cases: The first and easier one is that where the length 
  of the needle, $l$, is less than or equal to the strip width, $d$:
›</span></span>
<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> l_le_d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≤</span> <span class="free">d</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> emeasure_buffon_set'_short<span class="main">:</span> <span class="quoted"><span class="quoted">"emeasure lborel <span class="main">(</span>buffon_set' <span class="free">l</span> <span class="free">d</span><span class="main">)</span> <span class="main">=</span> ennreal <span class="free">l</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure lborel <span class="main">(</span>buffon_set' <span class="free">l</span> <span class="free">d</span><span class="main">)</span> <span class="main">=</span>
          ennreal <span class="main">(</span>integral <span class="main">{</span><span class="main">0</span><span class="main">..</span>pi<span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> min <span class="main">(</span><span class="free">d</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">(</span>sin <span class="bound">x</span> <span class="main">*</span> <span class="free">l</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> ennreal <span class="var">?I</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> emeasure_buffon_set'<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"sin <span class="skolem">φ</span> <span class="main">*</span> <span class="free">l</span> <span class="main">≤</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">≤</span> pi"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">φ</span>
    <span class="keyword1"><span class="command">using</span></span> mult_mono<span class="main">[</span><span class="operator">OF</span> l_le_d sin_le_one _ sin_ge_zero<span class="main">]</span> that d <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?I</span> <span class="main">=</span> integral <span class="main">{</span><span class="main">0</span><span class="main">..</span>pi<span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">l</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> sin <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> l d l_le_d  
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> integral_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> * <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> min_def sin_ge_zero<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">l</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> integral <span class="main">{</span><span class="main">0</span><span class="main">..</span>pi<span class="main">}</span> sin"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sin <span class="keyword1">has_integral</span> <span class="main">(</span><span class="main">-</span>cos pi <span class="main">-</span> <span class="main">(</span><span class="main">-</span> cos <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span>pi<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> fundamental_theorem_of_calculus<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> has_field_derivative_iff_has_vector_derivative <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"integral <span class="main">{</span><span class="main">0</span><span class="main">..</span>pi<span class="main">}</span> sin <span class="main">=</span> <span class="main">-</span>cos pi <span class="main">-</span> <span class="main">(</span><span class="main">-</span>cos <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> has_integral_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lborel_prod<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> emeasure_buffon_set_short<span class="main">:</span> <span class="quoted"><span class="quoted">"emeasure lborel <span class="main">(</span>buffon_set <span class="free">l</span> <span class="free">d</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">4</span> <span class="main">*</span> ennreal <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> emeasure_buffon_set_conv_buffon_set' emeasure_buffon_set'_short l_le_d<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> buffon_short<span class="main">:</span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>buffon <span class="free">l</span> <span class="free">d</span><span class="main">)</span> <span class="main">{</span>True<span class="main">}</span> <span class="main">=</span> ennreal <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">l</span> <span class="main">/</span> <span class="main">(</span><span class="free">d</span> <span class="main">*</span> pi<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>buffon <span class="free">l</span> <span class="free">d</span><span class="main">)</span> <span class="main">{</span>True<span class="main">}</span> <span class="main">=</span> ennreal <span class="main">(</span><span class="numeral">4</span> <span class="main">*</span> <span class="free">l</span><span class="main">)</span> <span class="main">/</span> ennreal <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">d</span> <span class="main">*</span> pi<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> d l <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> buffon_prob_aux<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> emeasure_buffon_set_short ennreal_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> ennreal <span class="main">(</span><span class="numeral">4</span> <span class="main">*</span> <span class="free">l</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">d</span> <span class="main">*</span> pi<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> d l <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> divide_ennreal<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">4</span> <span class="main">*</span> <span class="free">l</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">d</span> <span class="main">*</span> pi<span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">l</span> <span class="main">/</span> <span class="main">(</span><span class="free">d</span> <span class="main">*</span> pi<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The other case where the needle is at least as long as the strip width is more complicated:
›</span></span>
<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> l_ge_d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≥</span> <span class="free">d</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> emeasure_buffon_set'_long<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"emeasure lborel <span class="main">(</span>buffon_set' <span class="free">l</span> <span class="free">d</span><span class="main">)</span> <span class="main">=</span>
     ennreal <span class="main">(</span><span class="free">l</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> sqrt <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="free">d</span> <span class="main">/</span> <span class="free">l</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> arccos <span class="main">(</span><span class="free">d</span> <span class="main">/</span> <span class="free">l</span><span class="main">)</span> <span class="main">*</span> <span class="free">d</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">φ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ'</span> <span class="main">=</span> arcsin <span class="main">(</span><span class="free">d</span> <span class="main">/</span> <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> φ'_nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ'</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> φ'_def <span class="keyword1"><span class="command">using</span></span> d l l_ge_d arcsin_le_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span><span class="main">/</span><span class="free">l</span>"</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> φ'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> φ'_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ'</span> <span class="main">≤</span> pi <span class="main">/</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> φ'_def <span class="keyword1"><span class="command">using</span></span> arcsin_bounded<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">d</span><span class="main">/</span><span class="free">l</span>"</span></span><span class="main">]</span> d l l_ge_d
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ge_phi'<span class="main">:</span> <span class="quoted"><span class="quoted">"sin <span class="skolem">φ</span> <span class="main">≥</span> <span class="free">d</span> <span class="main">/</span> <span class="free">l</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">≥</span> <span class="skolem">φ'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">≤</span> pi <span class="main">/</span> <span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">φ</span>
    <span class="keyword1"><span class="command">using</span></span> arcsin_le_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">/</span> <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span>"</span></span><span class="main">]</span> d l_ge_d that φ'_nonneg <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> φ'_def <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> le_phi'<span class="main">:</span> <span class="quoted"><span class="quoted">"sin <span class="skolem">φ</span> <span class="main">≤</span> <span class="free">d</span> <span class="main">/</span> <span class="free">l</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">≤</span> <span class="skolem">φ'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">φ</span>
    <span class="keyword1"><span class="command">using</span></span> le_arcsin_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">/</span> <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span>"</span></span><span class="main">]</span> d l_ge_d that φ'_le <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> φ'_def <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> min <span class="main">(</span><span class="free">d</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">(</span>sin <span class="bound">x</span> <span class="main">*</span> <span class="free">l</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure lborel <span class="main">(</span>buffon_set' <span class="free">l</span> <span class="free">d</span><span class="main">)</span> <span class="main">=</span> ennreal <span class="main">(</span>integral <span class="main">{</span><span class="main">0</span><span class="main">..</span>pi<span class="main">}</span> <span class="var">?f</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> ennreal <span class="var">?I</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> emeasure_buffon_set'<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?I</span> <span class="main">=</span> integral <span class="main">{</span><span class="main">0</span><span class="main">..</span>pi<span class="main">/</span><span class="numeral">2</span><span class="main">}</span> <span class="var">?f</span> <span class="main">+</span> integral <span class="main">{</span>pi<span class="main">/</span><span class="numeral">2</span><span class="main">..</span>pi<span class="main">}</span> <span class="var">?f</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Henstock_Kurzweil_Integration.integral_combine <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> integrable_continuous_real <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"integral <span class="main">{</span>pi<span class="main">/</span><span class="numeral">2</span><span class="main">..</span>pi<span class="main">}</span> <span class="var">?f</span> <span class="main">=</span> integral <span class="main">{</span><span class="main">-</span>pi<span class="main">/</span><span class="numeral">2</span><span class="main">..</span><span class="main">0</span><span class="main">}</span> <span class="main">(</span><span class="var">?f</span> <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> <span class="bound">φ</span> <span class="main">+</span> pi<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> integral_shift<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> integral <span class="main">{</span><span class="main">-</span><span class="main">(</span>pi<span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">..</span><span class="main">-</span><span class="main">0</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> min <span class="main">(</span><span class="free">d</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">(</span>sin <span class="main">(</span><span class="main">-</span><span class="bound">x</span><span class="main">)</span> <span class="main">*</span> <span class="free">l</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> integral <span class="main">{</span><span class="main">0</span><span class="main">..</span>pi<span class="main">/</span><span class="numeral">2</span><span class="main">}</span> <span class="var">?f</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?I</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Henstock_Kurzweil_Integration.integral_reflect_real<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">+</span> <span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?I</span> <span class="main">=</span> integral <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">φ'</span><span class="main">}</span> <span class="var">?f</span> <span class="main">+</span> integral <span class="main">{</span><span class="skolem">φ'</span><span class="main">..</span>pi<span class="main">/</span><span class="numeral">2</span><span class="main">}</span> <span class="var">?f</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> l d l_ge_d φ'_nonneg φ'_le
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Henstock_Kurzweil_Integration.integral_combine <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> integrable_continuous_real <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"integral <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">φ'</span><span class="main">}</span> <span class="var">?f</span> <span class="main">=</span> integral <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">φ'</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">l</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> sin <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> l <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> integral_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> min_def <span class="dynamic"><span class="dynamic">field_simps</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> le_phi'<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">l</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> sin <span class="bound">x</span><span class="main">)</span> <span class="keyword1">has_integral</span> <span class="main">(</span><span class="main">-</span> <span class="main">(</span><span class="free">l</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> cos <span class="skolem">φ'</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">-</span> <span class="main">(</span><span class="free">l</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> cos <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">φ'</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> φ'_nonneg
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> fundamental_theorem_of_calculus<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> has_field_derivative_iff_has_vector_derivative <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"integral <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">φ'</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">l</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">*</span> sin <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> cos <span class="skolem">φ'</span><span class="main">)</span> <span class="main">*</span> <span class="free">l</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> has_integral_iff <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"integral <span class="main">{</span><span class="skolem">φ'</span><span class="main">..</span>pi<span class="main">/</span><span class="numeral">2</span><span class="main">}</span> <span class="var">?f</span> <span class="main">=</span> integral <span class="main">{</span><span class="skolem">φ'</span><span class="main">..</span>pi<span class="main">/</span><span class="numeral">2</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">d</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> l <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> integral_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> min_def <span class="dynamic"><span class="dynamic">field_simps</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> ge_phi'<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> arccos <span class="main">(</span><span class="free">d</span> <span class="main">/</span> <span class="free">l</span><span class="main">)</span> <span class="main">*</span> <span class="free">d</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> φ'_le d l l_ge_d 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> arccos_arcsin_eq<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> φ'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cos <span class="skolem">φ'</span> <span class="main">=</span> sqrt <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="free">d</span> <span class="main">/</span> <span class="free">l</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> φ'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cos_arcsin<span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> d l l_ge_d<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> sqrt <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="free">d</span> <span class="main">/</span> <span class="free">l</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">l</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">+</span> arccos <span class="main">(</span><span class="free">d</span> <span class="main">/</span> <span class="free">l</span><span class="main">)</span> <span class="main">*</span> <span class="free">d</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> 
               <span class="free">l</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> sqrt <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="free">d</span> <span class="main">/</span> <span class="free">l</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> arccos <span class="main">(</span><span class="free">d</span> <span class="main">/</span> <span class="free">l</span><span class="main">)</span> <span class="main">*</span> <span class="free">d</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> d l <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> emeasure_buffon_set_long<span class="main">:</span> <span class="quoted"><span class="quoted">"emeasure lborel <span class="main">(</span>buffon_set <span class="free">l</span> <span class="free">d</span><span class="main">)</span> <span class="main">=</span> 
        <span class="numeral">4</span> <span class="main">*</span> ennreal <span class="main">(</span><span class="free">l</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> sqrt <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="free">d</span> <span class="main">/</span> <span class="free">l</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> arccos <span class="main">(</span><span class="free">d</span> <span class="main">/</span> <span class="free">l</span><span class="main">)</span> <span class="main">*</span> <span class="free">d</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> emeasure_buffon_set_conv_buffon_set' emeasure_buffon_set'_long l_ge_d<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> buffon_long<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>buffon <span class="free">l</span> <span class="free">d</span><span class="main">)</span> <span class="main">{</span>True<span class="main">}</span> <span class="main">=</span> 
     ennreal <span class="main">(</span><span class="numeral">2</span> <span class="main">/</span> pi <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">l</span> <span class="main">/</span> <span class="free">d</span><span class="main">)</span> <span class="main">-</span> sqrt <span class="main">(</span><span class="main">(</span><span class="free">l</span> <span class="main">/</span> <span class="free">d</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> arccos <span class="main">(</span><span class="free">d</span> <span class="main">/</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">*</span> sqrt <span class="main">(</span><span class="main">(</span><span class="free">l</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="free">d</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">/</span> <span class="free">l</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">+</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">l</span> <span class="main">+</span> <span class="free">d</span> <span class="main">*</span> arccos <span class="main">(</span><span class="free">d</span> <span class="main">/</span> <span class="free">l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> d l_ge_d <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> add_mono mult_nonneg_nonneg arccos_lbound<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>buffon <span class="free">l</span> <span class="free">d</span><span class="main">)</span> <span class="main">{</span>True<span class="main">}</span> <span class="main">=</span> 
          ennreal <span class="main">(</span><span class="numeral">4</span> <span class="main">*</span> <span class="main">(</span><span class="free">l</span> <span class="main">-</span> <span class="free">l</span> <span class="main">*</span> sqrt <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="free">d</span> <span class="main">/</span> <span class="free">l</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">+</span> arccos <span class="main">(</span><span class="free">d</span> <span class="main">/</span> <span class="free">l</span><span class="main">)</span> <span class="main">*</span> <span class="free">d</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> ennreal <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">d</span> <span class="main">*</span> pi<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> d l l_ge_d * <span class="keyword1"><span class="command">unfolding</span></span> buffon_prob_aux emeasure_buffon_set_long ennreal_numeral <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ennreal_mult <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> add_nonneg_nonneg mult_nonneg_nonneg <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> ennreal <span class="main">(</span><span class="main">(</span><span class="numeral">4</span> <span class="main">*</span> <span class="main">(</span><span class="free">l</span> <span class="main">-</span> <span class="free">l</span> <span class="main">*</span> sqrt <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="free">d</span> <span class="main">/</span> <span class="free">l</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">+</span> arccos <span class="main">(</span><span class="free">d</span> <span class="main">/</span> <span class="free">l</span><span class="main">)</span> <span class="main">*</span> <span class="free">d</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">d</span> <span class="main">*</span> pi<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> d l * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> divide_ennreal<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">4</span> <span class="main">*</span> <span class="main">(</span><span class="free">l</span> <span class="main">-</span> <span class="free">l</span> <span class="main">*</span> sqrt <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="free">d</span> <span class="main">/</span> <span class="free">l</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">+</span> arccos <span class="main">(</span><span class="free">d</span> <span class="main">/</span> <span class="free">l</span><span class="main">)</span> <span class="main">*</span> <span class="free">d</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">d</span> <span class="main">*</span> pi<span class="main">)</span> <span class="main">=</span>
               <span class="numeral">2</span> <span class="main">/</span> pi <span class="main">*</span> <span class="main">(</span><span class="free">l</span> <span class="main">/</span> <span class="free">d</span> <span class="main">-</span> <span class="free">l</span> <span class="main">/</span> <span class="free">d</span> <span class="main">*</span> sqrt <span class="main">(</span><span class="main">(</span><span class="free">d</span> <span class="main">/</span> <span class="free">l</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">l</span> <span class="main">/</span> <span class="free">d</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> arccos <span class="main">(</span><span class="free">d</span> <span class="main">/</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> d l <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">/</span> <span class="free">d</span> <span class="main">*</span> sqrt <span class="main">(</span><span class="main">(</span><span class="free">d</span> <span class="main">/</span> <span class="free">l</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">l</span> <span class="main">/</span> <span class="free">d</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> sqrt <span class="main">(</span><span class="main">(</span><span class="free">l</span> <span class="main">/</span> <span class="free">d</span><span class="main">)</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> d l l_ge_d <span class="keyword1"><span class="command">unfolding</span></span> real_sqrt_mult real_sqrt_abs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>