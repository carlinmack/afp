<div id="Basic">
<div class="head">
<h1>Theory Basic</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Basics›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Basic
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Miscellaneous›</span></span>

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">const</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="main">λ</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> map_prod.id map_prod.comp<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1" id="Basic-prod_UNIV"><span class="command">lemma</span></span> prod_UNIV<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">×</span> <span class="free">B</span> <span class="main">=</span> UNIV <span class="main">⟷</span> <span class="free">A</span> <span class="main">=</span> UNIV <span class="main">∧</span> <span class="free">B</span> <span class="main">=</span> UNIV"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="Basic-prod_singleton"><span class="command">lemma</span></span> prod_singleton<span class="main">:</span>
    <span class="quoted"><span class="quoted">"fst <span class="main">`</span> <span class="free">A</span> <span class="main">=</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">=</span> fst <span class="main">`</span> <span class="free">A</span> <span class="main">×</span> snd <span class="main">`</span> <span class="free">A</span>"</span></span>
    <span class="quoted"><span class="quoted">"snd <span class="main">`</span> <span class="free">A</span> <span class="main">=</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">=</span> fst <span class="main">`</span> <span class="free">A</span> <span class="main">×</span> snd <span class="main">`</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1" id="Basic-infinite_subset"><span class="command">lemma</span></span> infinite_subset<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"infinite <span class="free">A</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span> <span class="main">⟹</span> infinite <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> infinite_super <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1" id="Basic-finite_subset"><span class="command">lemma</span></span> finite_subset<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span> <span class="main">⟹</span> finite <span class="free">B</span> <span class="main">⟹</span> finite <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>

  <span class="keyword1"><span class="command">declare</span></span> infinite_coinduct<span class="main">[</span><span class="operator">case_names</span> infinite<span class="main">,</span> <span class="operator">coinduct</span> <span class="quasi_keyword">pred</span><span class="main"><span class="main">:</span></span> infinite<span class="main">]</span>
  <span class="keyword1" id="Basic-infinite_psubset_coinduct"><span class="command">lemma</span></span> infinite_psubset_coinduct<span class="main">[</span><span class="operator">case_names</span> infinite<span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">A</span><span class="main">.</span> <span class="free">R</span> <span class="bound">A</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound"><span class="bound">B</span></span> <span class="main">⊂</span> <span class="bound">A</span><span class="main">.</span> <span class="free">R</span> <span class="bound">B</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"infinite <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_psubset_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="comment1">(* TODO: why are there two copies of this theorem? *)</span>
  <span class="keyword1"><span class="command">thm</span></span> inj_on_subset subset_inj_on

  <span class="keyword1" id="Basic-inj_inj_on"><span class="command">lemma</span></span> inj_inj_on<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inj <span class="free">f</span> <span class="main">⟹</span> inj_on <span class="free">f</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inj_on_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Sequence">
<div class="head">
<h1>Theory Sequence</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Finite and Infinite Sequences›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Sequence
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="Basic.html">Basic</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Stream.html">HOL-Library.Stream</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Monad_Syntax.html">HOL-Library.Monad_Syntax</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹List Basics›</span></span>

  <span class="keyword1"><span class="command">declare</span></span> upt_Suc<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
  <span class="keyword1"><span class="command">declare</span></span> last.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
  <span class="keyword1"><span class="command">declare</span></span> butlast.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword">del</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">declare</span></span> Cons_nth_drop_Suc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  <span class="keyword1"><span class="command">declare</span></span> list.pred_True<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

  <span class="keyword1" id="Sequence-list_pred_cases"><span class="command">lemma</span></span> list_pred_cases<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all <span class="free">P</span> <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="main">(</span>nil<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span> <span class="main">(</span>cons<span class="main">)</span> <span class="free">y</span> <span class="free">ys</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"list_all <span class="free">P</span> <span class="free">ys</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1" id="Sequence-lists_iff_set"><span class="command">lemma</span></span> lists_iff_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> lists <span class="free">A</span> <span class="main">⟷</span> set <span class="free">w</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Sequence-fold_const"><span class="command">lemma</span></span> fold_const<span class="main">:</span> <span class="quoted"><span class="quoted">"fold const <span class="free">xs</span> <span class="free">a</span> <span class="main">=</span> last <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> last.simps<span class="main">)</span>

  <span class="keyword1" id="Sequence-take_Suc"><span class="command">lemma</span></span> take_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="main">[]</span> <span class="keyword1">else</span> hd <span class="free">xs</span> <span class="main">#</span> take <span class="free">n</span> <span class="main">(</span>tl <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_Suc<span class="main">)</span>

  <span class="keyword1" id="Sequence-bind_map"><span class="command">lemma</span></span> bind_map<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="free">f</span> <span class="free">xs</span> <span class="main">⤜</span> <span class="free">g</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">⤜</span> <span class="free">g</span> <span class="main">∘</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> List.bind_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1" id="Sequence-ball_bind"><span class="command">lemma</span></span> ball_bind<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Ball <span class="main">(</span>set <span class="main">(</span><span class="free">xs</span> <span class="main">⤜</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="free">P</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> set_list_bind <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1" id="Sequence-bex_bind"><span class="command">lemma</span></span> bex_bind<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Bex <span class="main">(</span>set <span class="main">(</span><span class="free">xs</span> <span class="main">⤜</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="free">P</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> set_list_bind <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1" id="Sequence-list_choice"><span class="command">lemma</span></span> list_choice<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="free">xs</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">ys</span><span class="main">.</span> list_all2 <span class="free">P</span> <span class="free">xs</span> <span class="bound">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all2_Cons1<span class="main">)</span>

  <span class="keyword1" id="Sequence-listset_member"><span class="command">lemma</span></span> listset_member<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">∈</span> listset <span class="free">XS</span> <span class="main">⟷</span> list_all2 <span class="main">(∈)</span> <span class="free">ys</span> <span class="free">XS</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">XS</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_Cons_def list_all2_Cons2<span class="main">)</span>
  <span class="keyword1" id="Sequence-listset_empty"><span class="command">lemma</span></span> listset_empty<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"listset <span class="free">XS</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟷</span> <span class="main">¬</span> list_all <span class="main">(</span><span class="main">λ</span> <span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span> <span class="free">XS</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">XS</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_Cons_def<span class="main">)</span>
  <span class="keyword1" id="Sequence-listset_finite"><span class="command">lemma</span></span> listset_finite<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span> <span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span> <span class="free">XS</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>listset <span class="free">XS</span><span class="main">)</span> <span class="main">⟷</span> list_all finite <span class="free">XS</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">XS</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">A</span> <span class="skolem">XS</span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> finite_image_iff finite_cartesian_product_iff
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"listset <span class="main">(</span><span class="skolem">A</span> <span class="main">#</span> <span class="skolem">XS</span><span class="main">)</span> <span class="main">=</span> case_prod Cons <span class="main">`</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">×</span> listset <span class="skolem">XS</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_Cons_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">…</span> <span class="main">⟷</span> finite <span class="main">(</span><span class="skolem">A</span> <span class="main">×</span> listset <span class="skolem">XS</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> finite <span class="skolem">A</span> <span class="main">∧</span> finite <span class="main">(</span>listset <span class="skolem">XS</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>listset <span class="skolem">XS</span><span class="main">)</span> <span class="main">⟷</span> list_all finite <span class="skolem">XS</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">A</span> <span class="main">∧</span> <span class="main">…</span> <span class="main">⟷</span> list_all finite <span class="main">(</span><span class="skolem">A</span> <span class="main">#</span> <span class="skolem">XS</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="Sequence-listset_finite'"><span class="command">lemma</span></span> listset_finite'<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all finite <span class="free">XS</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>listset <span class="free">XS</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> infinite_imp_nonempty assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1" id="Sequence-listset_card"><span class="command">lemma</span></span> listset_card<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>listset <span class="free">XS</span><span class="main">)</span> <span class="main">=</span> prod_list <span class="main">(</span>map card <span class="free">XS</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">XS</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">A</span> <span class="skolem">XS</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"inj <span class="main">(</span>case_prod Cons<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> inj_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"listset <span class="main">(</span><span class="skolem">A</span> <span class="main">#</span> <span class="skolem">XS</span><span class="main">)</span> <span class="main">=</span> case_prod Cons <span class="main">`</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">×</span> listset <span class="skolem">XS</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_Cons_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">…</span> <span class="main">=</span> card <span class="main">(</span><span class="skolem">A</span> <span class="main">×</span> listset <span class="skolem">XS</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> card_image 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> card <span class="skolem">A</span> <span class="main">*</span> card <span class="main">(</span>listset <span class="skolem">XS</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> card_cartesian_product <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>listset <span class="skolem">XS</span><span class="main">)</span> <span class="main">=</span> prod_list <span class="main">(</span>map card <span class="skolem">XS</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">A</span> <span class="main">*</span> <span class="main">…</span> <span class="main">=</span> prod_list <span class="main">(</span>map card <span class="main">(</span><span class="skolem">A</span> <span class="main">#</span> <span class="skolem">XS</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Stream Basics›</span></span>

  <span class="keyword1"><span class="command">declare</span></span> stream.map_id<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  <span class="keyword1"><span class="command">declare</span></span> stream.set_map<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  <span class="keyword1"><span class="command">declare</span></span> stream.set_sel<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main">!</span></span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span>
  <span class="keyword1"><span class="command">declare</span></span> stream.pred_True<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  <span class="keyword1"><span class="command">declare</span></span> stream.pred_map<span class="main">[</span><span class="operator">iff</span><span class="main">]</span>
  <span class="keyword1"><span class="command">declare</span></span> stream.rel_map<span class="main">[</span><span class="operator">iff</span><span class="main">]</span>
  <span class="keyword1"><span class="command">declare</span></span> shift_simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword">del</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">declare</span></span> stake_sdrop<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  <span class="keyword1"><span class="command">declare</span></span> stake_siterate<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
  <span class="keyword1"><span class="command">declare</span></span> sdrop_snth<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

  <span class="keyword1" id="Sequence-stream_pred_cases"><span class="command">lemma</span></span> stream_pred_cases<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="free">P</span> <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="main">(</span>scons<span class="main">)</span> <span class="free">y</span> <span class="free">ys</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="free">y</span> <span class="main">##</span> <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="free">P</span> <span class="free">ys</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1" id="Sequence-stream_rel_coinduct"><span class="command">lemma</span></span> stream_rel_coinduct<span class="main">[</span><span class="operator">case_names</span> stream_rel<span class="main">,</span> <span class="operator">coinduct</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">pred</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">:</span></span></span></span> stream_all2<span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">u</span> <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="bound">u</span> <span class="bound">b</span> <span class="bound">v</span><span class="main">.</span> <span class="free">R</span> <span class="main">(</span><span class="bound">a</span> <span class="main">##</span> <span class="bound">u</span><span class="main">)</span> <span class="main">(</span><span class="bound">b</span> <span class="main">##</span> <span class="bound">v</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">u</span> <span class="bound">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"stream_all2 <span class="free">P</span> <span class="free">u</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduct</span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> stream.collapse<span class="main">)</span>
  <span class="keyword1" id="Sequence-stream_rel_coinduct_shift"><span class="command">lemma</span></span> stream_rel_coinduct_shift<span class="main">[</span><span class="operator">case_names</span> stream_rel<span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">u</span> <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="free">R</span> <span class="bound">u</span> <span class="bound">v</span> <span class="main">⟹</span>
      <span class="main">∃</span> <span class="bound">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="bound">u</span> <span class="main">=</span> <span class="bound">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@-</span> <span class="bound">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">=</span> <span class="bound">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@-</span> <span class="bound">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> <span class="bound">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="bound">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> list_all2 <span class="free">P</span> <span class="bound">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"stream_all2 <span class="free">P</span> <span class="free">u</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="free">u</span> <span class="main">=</span> <span class="bound">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@-</span> <span class="bound">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> <span class="free">v</span> <span class="main">=</span> <span class="bound">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@-</span> <span class="bound">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> list_all2 <span class="free">P</span> <span class="bound">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduct</span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> list.rel_cases<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Sequence-stream_pred_coinduct"><span class="command">lemma</span></span> stream_pred_coinduct<span class="main">[</span><span class="operator">case_names</span> stream_pred<span class="main">,</span> <span class="operator">coinduct</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">pred</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">:</span></span></span></span> pred_stream<span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="bound">w</span><span class="main">.</span> <span class="free">R</span> <span class="main">(</span><span class="bound">a</span> <span class="main">##</span> <span class="bound">w</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">a</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="free">P</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> stream.pred_rel eq_onp_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1" id="Sequence-stream_pred_coinduct_shift"><span class="command">lemma</span></span> stream_pred_coinduct_shift<span class="main">[</span><span class="operator">case_names</span> stream_pred<span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">w</span><span class="main">.</span> <span class="free">R</span> <span class="bound">w</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">w</span> <span class="main">=</span> <span class="bound">u</span> <span class="main">@-</span> <span class="bound">v</span> <span class="main">∧</span> <span class="bound">u</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> list_all <span class="free">P</span> <span class="bound">u</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="free">P</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="free">w</span> <span class="main">=</span> <span class="bound">u</span> <span class="main">@-</span> <span class="bound">v</span> <span class="main">∧</span> list_all <span class="free">P</span> <span class="bound">u</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">v</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list_all_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> shift.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduct</span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> list_pred_cases<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="Sequence-stream_pred_flat_coinduct"><span class="command">lemma</span></span> stream_pred_flat_coinduct<span class="main">[</span><span class="operator">case_names</span> stream_pred<span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">ws</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">w</span> <span class="bound">ws</span><span class="main">.</span> <span class="free">R</span> <span class="main">(</span><span class="bound">w</span> <span class="main">##</span> <span class="bound">ws</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">w</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> list_all <span class="free">P</span> <span class="bound">w</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">ws</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="free">P</span> <span class="main">(</span>flat <span class="free">ws</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ws</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> stream_pred_coinduct_shift<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> stream.exhaust flat_Stream<span class="main">)</span>

  <span class="keyword1"><span class="command">lemmas</span></span> stream_eq_coinduct<span class="main">[</span><span class="operator">case_names</span> stream_eq<span class="main">,</span> <span class="operator">coinduct</span> <span class="quasi_keyword">pred</span><span class="main"><span class="main">:</span></span> HOL.eq<span class="main">]</span> <span class="main">=</span>
    stream_rel_coinduct<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?P</span> <span class="main"><span class="main">=</span></span> <span class="quoted">HOL.eq</span><span class="main">,</span> <span class="operator">unfolded</span> stream.rel_eq<span class="main">]</span>
  <span class="keyword1"><span class="command">lemmas</span></span> stream_eq_coinduct_shift<span class="main">[</span><span class="operator">case_names</span> stream_eq<span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">]</span> <span class="main">=</span>
    stream_rel_coinduct_shift<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?P</span> <span class="main"><span class="main">=</span></span> <span class="quoted">HOL.eq</span><span class="main">,</span> <span class="operator">unfolded</span> stream.rel_eq list.rel_eq<span class="main">]</span>

  <span class="keyword1" id="Sequence-stream_pred_shift"><span class="command">lemma</span></span> stream_pred_shift<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pred_stream <span class="free">P</span> <span class="main">(</span><span class="free">u</span> <span class="main">@-</span> <span class="free">v</span><span class="main">)</span> <span class="main">⟷</span> list_all <span class="free">P</span> <span class="free">u</span> <span class="main">∧</span> pred_stream <span class="free">P</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">u</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1" id="Sequence-stream_rel_shift"><span class="command">lemma</span></span> stream_rel_shift<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> length <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"stream_all2 <span class="free">P</span> <span class="main">(</span><span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@-</span> <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@-</span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">⟷</span> list_all2 <span class="free">P</span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> stream_all2 <span class="free">P</span> <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1" id="Sequence-sset_subset_stream_pred"><span class="command">lemma</span></span> sset_subset_stream_pred<span class="main">:</span> <span class="quoted"><span class="quoted">"sset <span class="free">w</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">⟷</span> pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span><span class="main">)</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> stream.pred_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Sequence-eq_scons"><span class="command">lemma</span></span> eq_scons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="free">a</span> <span class="main">##</span> <span class="free">v</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">=</span> shd <span class="free">w</span> <span class="main">∧</span> <span class="free">v</span> <span class="main">=</span> stl <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="Sequence-scons_eq"><span class="command">lemma</span></span> scons_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">##</span> <span class="free">v</span> <span class="main">=</span> <span class="free">w</span> <span class="main">⟷</span> shd <span class="free">w</span> <span class="main">=</span> <span class="free">a</span> <span class="main">∧</span> stl <span class="free">w</span> <span class="main">=</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="Sequence-eq_shift"><span class="command">lemma</span></span> eq_shift<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="free">u</span> <span class="main">@-</span> <span class="free">v</span> <span class="main">⟷</span> stake <span class="main">(</span>length <span class="free">u</span><span class="main">)</span> <span class="free">w</span> <span class="main">=</span> <span class="free">u</span> <span class="main">∧</span> sdrop <span class="main">(</span>length <span class="free">u</span><span class="main">)</span> <span class="free">w</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">u</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1" id="Sequence-shift_eq"><span class="command">lemma</span></span> shift_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">@-</span> <span class="free">v</span> <span class="main">=</span> <span class="free">w</span> <span class="main">⟷</span> <span class="free">u</span> <span class="main">=</span> stake <span class="main">(</span>length <span class="free">u</span><span class="main">)</span> <span class="free">w</span> <span class="main">∧</span> <span class="free">v</span> <span class="main">=</span> sdrop <span class="main">(</span>length <span class="free">u</span><span class="main">)</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">u</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1" id="Sequence-scons_eq_shift"><span class="command">lemma</span></span> scons_eq_shift<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">##</span> <span class="free">w</span> <span class="main">=</span> <span class="free">u</span> <span class="main">@-</span> <span class="free">v</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">[]</span> <span class="main">=</span> <span class="free">u</span> <span class="main">∧</span> <span class="free">a</span> <span class="main">##</span> <span class="free">w</span> <span class="main">=</span> <span class="free">v</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">u'</span><span class="main">.</span> <span class="free">a</span> <span class="main">#</span> <span class="bound">u'</span> <span class="main">=</span> <span class="free">u</span> <span class="main">∧</span> <span class="free">w</span> <span class="main">=</span> <span class="bound">u'</span> <span class="main">@-</span> <span class="free">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">u</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1" id="Sequence-shift_eq_scons"><span class="command">lemma</span></span> shift_eq_scons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">@-</span> <span class="free">v</span> <span class="main">=</span> <span class="free">a</span> <span class="main">##</span> <span class="free">w</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">u</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">v</span> <span class="main">=</span> <span class="free">a</span> <span class="main">##</span> <span class="free">w</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">u'</span><span class="main">.</span> <span class="free">u</span> <span class="main">=</span> <span class="free">a</span> <span class="main">#</span> <span class="bound">u'</span> <span class="main">∧</span> <span class="bound">u'</span> <span class="main">@-</span> <span class="free">v</span> <span class="main">=</span> <span class="free">w</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">u</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1" id="Sequence-stream_all2_sset1"><span class="command">lemma</span></span> stream_all2_sset1<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"stream_all2 <span class="free">P</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> sset <span class="free">xs</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">y</span> <span class="main">∈</span> sset <span class="free">ys</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">y</span> <span class="main">∈</span> <span class="skolem">S</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"sset <span class="free">ys</span> <span class="main">⊆</span> <span class="skolem">S</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">S</span>
      <span class="keyword1"><span class="command">using</span></span> assms that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> stream.rel_cases<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> stream.pred_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="Sequence-stream_all2_sset2"><span class="command">lemma</span></span> stream_all2_sset2<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"stream_all2 <span class="free">P</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">y</span> <span class="main">∈</span> sset <span class="free">ys</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">x</span> <span class="main">∈</span> sset <span class="free">xs</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">y</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">S</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="free">ys</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"sset <span class="free">xs</span> <span class="main">⊆</span> <span class="skolem">S</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">S</span>
      <span class="keyword1"><span class="command">using</span></span> assms that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> stream.rel_cases<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> stream.pred_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Sequence-smap_eq_scons"><span class="command">lemma</span></span> smap_eq_scons<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"smap <span class="free">f</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">y</span> <span class="main">##</span> <span class="free">ys</span> <span class="main">⟷</span> <span class="free">f</span> <span class="main">(</span>shd <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">y</span> <span class="main">∧</span> smap <span class="free">f</span> <span class="main">(</span>stl <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">ys</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> smap_ctr <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1" id="Sequence-scons_eq_smap"><span class="command">lemma</span></span> scons_eq_smap<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">##</span> <span class="free">ys</span> <span class="main">=</span> smap <span class="free">f</span> <span class="free">xs</span> <span class="main">⟷</span> <span class="free">y</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>shd <span class="free">xs</span><span class="main">)</span> <span class="main">∧</span> <span class="free">ys</span> <span class="main">=</span> smap <span class="free">f</span> <span class="main">(</span>stl <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> smap_ctr <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1" id="Sequence-smap_eq_shift"><span class="command">lemma</span></span> smap_eq_shift<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"smap <span class="free">f</span> <span class="free">w</span> <span class="main">=</span> <span class="free">u</span> <span class="main">@-</span> <span class="free">v</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">w<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="free">w</span> <span class="main">=</span> <span class="bound">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@-</span> <span class="bound">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> map <span class="free">f</span> <span class="bound">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">u</span> <span class="main">∧</span> smap <span class="free">f</span> <span class="bound">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sdrop_smap eq_shift stake_sdrop stake_smap <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1" id="Sequence-shift_eq_smap"><span class="command">lemma</span></span> shift_eq_smap<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">@-</span> <span class="free">v</span> <span class="main">=</span> smap <span class="free">f</span> <span class="free">w</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">w<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="free">w</span> <span class="main">=</span> <span class="bound">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@-</span> <span class="bound">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> <span class="free">u</span> <span class="main">=</span> map <span class="free">f</span> <span class="bound">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="free">v</span> <span class="main">=</span> smap <span class="free">f</span> <span class="bound">w<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sdrop_smap eq_shift stake_sdrop stake_smap <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword1" id="Sequence-szip_eq_scons"><span class="command">lemma</span></span> szip_eq_scons<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"szip <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span> <span class="free">z</span> <span class="main">##</span> <span class="free">zs</span> <span class="main">⟷</span> <span class="main">(</span>shd <span class="free">xs</span><span class="main">,</span> shd <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> <span class="free">z</span> <span class="main">∧</span> szip <span class="main">(</span>stl <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>stl <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> <span class="free">zs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> szip.ctr stream.inject <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1" id="Sequence-scons_eq_szip"><span class="command">lemma</span></span> scons_eq_szip<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">##</span> <span class="free">zs</span> <span class="main">=</span> szip <span class="free">xs</span> <span class="free">ys</span> <span class="main">⟷</span> <span class="free">z</span> <span class="main">=</span> <span class="main">(</span>shd <span class="free">xs</span><span class="main">,</span> shd <span class="free">ys</span><span class="main">)</span> <span class="main">∧</span> <span class="free">zs</span> <span class="main">=</span> szip <span class="main">(</span>stl <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>stl <span class="free">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> szip.ctr stream.inject <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword1" id="Sequence-siterate_eq_scons"><span class="command">lemma</span></span> siterate_eq_scons<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"siterate <span class="free">f</span> <span class="free">s</span> <span class="main">=</span> <span class="free">a</span> <span class="main">##</span> <span class="free">w</span> <span class="main">⟷</span> <span class="free">s</span> <span class="main">=</span> <span class="free">a</span> <span class="main">∧</span> siterate <span class="free">f</span> <span class="main">(</span><span class="free">f</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> siterate.ctr stream.inject <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1" id="Sequence-scons_eq_siterate"><span class="command">lemma</span></span> scons_eq_siterate<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">##</span> <span class="free">w</span> <span class="main">=</span> siterate <span class="free">f</span> <span class="free">s</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">=</span> <span class="free">s</span> <span class="main">∧</span> <span class="free">w</span> <span class="main">=</span> siterate <span class="free">f</span> <span class="main">(</span><span class="free">f</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> siterate.ctr stream.inject <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword1" id="Sequence-snth_0"><span class="command">lemma</span></span> snth_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="main">##</span> <span class="free">w</span><span class="main">)</span> <span class="main">!!</span> <span class="main">0</span> <span class="main">=</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1" id="Sequence-eqI_snth"><span class="command">lemma</span></span> eqI_snth<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="free">u</span> <span class="main">!!</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">v</span> <span class="main">!!</span> <span class="bound">i</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> stream.sel snth.simps<span class="main">)</span>

  <span class="keyword1" id="Sequence-stream_pred_snth"><span class="command">lemma</span></span> stream_pred_snth<span class="main">:</span> <span class="quoted"><span class="quoted">"pred_stream <span class="free">P</span> <span class="free">w</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">w</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> stream.pred_set sset_range <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1" id="Sequence-stream_rel_snth"><span class="command">lemma</span></span> stream_rel_snth<span class="main">:</span> <span class="quoted"><span class="quoted">"stream_all2 <span class="free">P</span> <span class="free">u</span> <span class="free">v</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">u</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">v</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="free">u</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="free">v</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"stream_all2 <span class="free">P</span> <span class="free">u</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> stream.rel_cases<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"stream_all2 <span class="free">P</span> <span class="free">u</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">u</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">v</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduct</span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> snth_0 snth_Stream<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Sequence-stream_rel_pred_szip"><span class="command">lemma</span></span> stream_rel_pred_szip<span class="main">:</span> <span class="quoted"><span class="quoted">"stream_all2 <span class="free">P</span> <span class="free">u</span> <span class="free">v</span> <span class="main">⟷</span> pred_stream <span class="main">(</span>case_prod <span class="free">P</span><span class="main">)</span> <span class="main">(</span>szip <span class="free">u</span> <span class="free">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> stream_pred_snth stream_rel_snth <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1" id="Sequence-sconst_eq"><span class="command">lemma</span></span> sconst_eq<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sconst <span class="free">x</span> <span class="main">=</span> sconst <span class="free">y</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> siterate.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1" id="Sequence-stream_pred__sconst"><span class="command">lemma</span></span> stream_pred__sconst<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pred_stream <span class="free">P</span> <span class="main">(</span>sconst <span class="free">x</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">P</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> stream_pred_snth <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1" id="Sequence-stream_rel_sconst"><span class="command">lemma</span></span> stream_rel_sconst<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"stream_all2 <span class="free">P</span> <span class="main">(</span>sconst <span class="free">x</span><span class="main">)</span> <span class="main">(</span>sconst <span class="free">y</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">P</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> stream_rel_snth <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1" id="Sequence-set_sset_stake"><span class="command">lemma</span></span> set_sset_stake<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>stake <span class="free">n</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⊆</span> sset <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sset_shift stake_sdrop sup_ge1<span class="main">)</span>
  <span class="keyword1" id="Sequence-sset_sdrop"><span class="command">lemma</span></span> sset_sdrop<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sset <span class="main">(</span>sdrop <span class="free">n</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⊆</span> sset <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sset_shift stake_sdrop sup_ge2<span class="main">)</span>

  <span class="keyword1" id="Sequence-set_stake_snth"><span class="command">lemma</span></span> set_stake_snth<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span>stake <span class="free">n</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">.</span> <span class="free">xs</span> <span class="main">!!</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> in_set_conv_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="comment1">(* TODO: these should be generated by the transfer option on the primcorec definitions *)</span>
  <span class="comment1">(* TODO: transfer_prover cannot handle corecursive definitions due to the λ(s1, s2). undefined
    abortion term that is never used *)</span>
  <span class="keyword1" id="Sequence-szip_transfer"><span class="command">lemma</span></span> szip_transfer<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>stream_all2 <span class="free">A</span> <span class="main">===&gt;</span> stream_all2 <span class="free">B</span> <span class="main">===&gt;</span> stream_all2 <span class="main">(</span>rel_prod <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> szip szip"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> rel_funI<span class="main"><span class="keyword3">,</span></span> <span class="operator">coinduction</span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> stream.rel_cases<span class="main">)</span>
  <span class="keyword1" id="Sequence-siterate_transfer"><span class="command">lemma</span></span> siterate_transfer<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">A</span> <span class="main">===&gt;</span> <span class="free">A</span><span class="main">)</span> <span class="main">===&gt;</span> <span class="free">A</span> <span class="main">===&gt;</span> stream_all2 <span class="free">A</span><span class="main">)</span> siterate siterate"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> rel_funI<span class="main"><span class="keyword3">,</span></span> <span class="operator">coinduction</span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> rel_funD<span class="main">)</span>

  <span class="keyword1" id="Sequence-split_stream_first"><span class="command">lemma</span></span> split_stream_first<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∩</span> sset <span class="free">xs</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">ys</span> <span class="free">a</span> <span class="free">zs</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">@-</span> <span class="free">a</span> <span class="main">##</span> <span class="free">zs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∩</span> set <span class="free">ys</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span> <span class="free">xs</span> <span class="main">!!</span> <span class="bound">n</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!!</span> <span class="skolem">n</span> <span class="main">∉</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> <span class="var">?n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> not_less_Least<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> stake <span class="var">?n</span> <span class="free">xs</span> <span class="main">@-</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!!</span> <span class="var">?n</span><span class="main">)</span> <span class="main">##</span> sdrop <span class="main">(</span>Suc <span class="var">?n</span><span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> id_stake_snth_sdrop <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∩</span> set <span class="main">(</span>stake <span class="var">?n</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> disjoint_iff_not_equal set_stake_snth<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!!</span> <span class="var">?n</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> sset_range <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> LeastI<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="Sequence-split_stream_first'"><span class="command">lemma</span></span> split_stream_first'<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> sset <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">ys</span> <span class="free">zs</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">@-</span> <span class="free">x</span> <span class="main">##</span> <span class="free">zs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span> <span class="free">xs</span> <span class="main">!!</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!!</span> <span class="var">?n</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> sset_range <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> LeastI<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!!</span> <span class="skolem">n</span> <span class="main">≠</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> <span class="var">?n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> not_less_Least<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> stake <span class="var">?n</span> <span class="free">xs</span> <span class="main">@-</span> <span class="free">x</span> <span class="main">##</span> sdrop <span class="main">(</span>Suc <span class="var">?n</span><span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> id_stake_snth_sdrop<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set <span class="main">(</span>stake <span class="var">?n</span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> set_stake_snth<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Sequence-streams_UNIV"><span class="command">lemma</span></span> streams_UNIV<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"streams <span class="free">A</span> <span class="main">=</span> UNIV <span class="main">⟷</span> <span class="free">A</span> <span class="main">=</span> UNIV"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> UNIV <span class="main">⟹</span> streams <span class="free">A</span> <span class="main">=</span> UNIV"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"streams <span class="free">A</span> <span class="main">=</span> UNIV"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> streams <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">w</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sset <span class="skolem">w</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">w</span> <span class="keyword1"><span class="command">unfolding</span></span> streams_iff_sset <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sset <span class="main">(</span>sconst <span class="skolem">a</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> UNIV"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="Sequence-streams_int"><span class="command">lemma</span></span> streams_int<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"streams <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> streams <span class="free">A</span> <span class="main">∩</span> streams <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> streams_iff_sset<span class="main">)</span>
  <span class="keyword1" id="Sequence-streams_Int"><span class="command">lemma</span></span> streams_Int<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"streams <span class="main">(</span><span class="main">⋂</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋂</span> <span class="main">(</span>streams <span class="main">`</span> <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> streams_iff_sset<span class="main">)</span>

  <span class="keyword1" id="Sequence-pred_list_listsp"><span class="command">lemma</span></span> pred_list_listsp<span class="main">[</span><span class="operator">pred_set_conv</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">=</span> listsp"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> list.pred_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="Sequence-pred_stream_streamsp"><span class="command">lemma</span></span> pred_stream_streamsp<span class="main">[</span><span class="operator">pred_set_conv</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pred_stream <span class="main">=</span> streamsp"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> stream.pred_set streams_iff_sset<span class="main">[</span><span class="operator">to_pred</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The scan Function›</span></span>

  <span class="keyword1"><span class="command">primrec</span></span> <span class="main">(</span>transfer<span class="main">)</span> <span class="entity">scan</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">scan</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">scan</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free">scan</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="Sequence-scan_append"><span class="command">lemma</span></span> scan_append<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"scan <span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> scan <span class="free">f</span> <span class="free">xs</span> <span class="free">a</span> <span class="main">@</span> scan <span class="free">f</span> <span class="free">ys</span> <span class="main">(</span>fold <span class="free">f</span> <span class="free">xs</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1" id="Sequence-scan_eq_nil"><span class="command">lemma</span></span> scan_eq_nil<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"scan <span class="free">f</span> <span class="free">xs</span> <span class="free">a</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟷</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1" id="Sequence-scan_eq_cons"><span class="command">lemma</span></span> scan_eq_cons<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"scan <span class="free">f</span> <span class="free">xs</span> <span class="free">a</span> <span class="main">=</span> <span class="free">b</span> <span class="main">#</span> <span class="free">w</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">y</span> <span class="bound">ys</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">#</span> <span class="bound">ys</span> <span class="main">∧</span> <span class="free">f</span> <span class="bound">y</span> <span class="free">a</span> <span class="main">=</span> <span class="free">b</span> <span class="main">∧</span> scan <span class="free">f</span> <span class="bound">ys</span> <span class="main">(</span><span class="free">f</span> <span class="bound">y</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">w</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1" id="Sequence-scan_eq_append"><span class="command">lemma</span></span> scan_eq_append<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"scan <span class="free">f</span> <span class="free">xs</span> <span class="free">a</span> <span class="main">=</span> <span class="free">u</span> <span class="main">@</span> <span class="free">v</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">ys</span> <span class="bound">zs</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">ys</span> <span class="main">@</span> <span class="bound">zs</span> <span class="main">∧</span> scan <span class="free">f</span> <span class="bound">ys</span> <span class="free">a</span> <span class="main">=</span> <span class="free">u</span> <span class="main">∧</span> scan <span class="free">f</span> <span class="bound">zs</span> <span class="main">(</span>fold <span class="free">f</span> <span class="bound">ys</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">u</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> append_Cons fold_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

  <span class="keyword1" id="Sequence-scan_length"><span class="command">lemma</span></span> scan_length<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>scan <span class="free">f</span> <span class="free">xs</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="comment1">(* TODO: figure out how this is used, should it be a simp rule? or flipped? also target_alt_def *)</span>
  <span class="keyword1" id="Sequence-scan_last"><span class="command">lemma</span></span> scan_last<span class="main">:</span> <span class="quoted"><span class="quoted">"last <span class="main">(</span><span class="free">a</span> <span class="main">#</span> scan <span class="free">f</span> <span class="free">xs</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> fold <span class="free">f</span> <span class="free">xs</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> last.simps<span class="main">)</span>
  <span class="keyword1" id="Sequence-scan_butlast"><span class="command">lemma</span></span> scan_butlast<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"scan <span class="free">f</span> <span class="main">(</span>butlast <span class="free">xs</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> butlast <span class="main">(</span>scan <span class="free">f</span> <span class="free">xs</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> butlast.simps<span class="main">)</span>

  <span class="keyword1" id="Sequence-scan_const"><span class="command">lemma</span></span> scan_const<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"scan const <span class="free">xs</span> <span class="free">a</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1" id="Sequence-scan_nth"><span class="command">lemma</span></span> scan_nth<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="main">(</span>scan <span class="free">f</span> <span class="free">xs</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"scan <span class="free">f</span> <span class="free">xs</span> <span class="free">a</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> fold <span class="free">f</span> <span class="main">(</span>take <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_Suc neq_Nil_conv<span class="main">)</span>
  <span class="keyword1" id="Sequence-scan_map"><span class="command">lemma</span></span> scan_map<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"scan <span class="free">f</span> <span class="main">(</span>map <span class="free">g</span> <span class="free">xs</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> scan <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="free">g</span><span class="main">)</span> <span class="free">xs</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1" id="Sequence-scan_take"><span class="command">lemma</span></span> scan_take<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="free">k</span> <span class="main">(</span>scan <span class="free">f</span> <span class="free">xs</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> scan <span class="free">f</span> <span class="main">(</span>take <span class="free">k</span> <span class="free">xs</span><span class="main">)</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_Suc neq_Nil_conv<span class="main">)</span>
  <span class="keyword1" id="Sequence-scan_drop"><span class="command">lemma</span></span> scan_drop<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"drop <span class="free">k</span> <span class="main">(</span>scan <span class="free">f</span> <span class="free">xs</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> scan <span class="free">f</span> <span class="main">(</span>drop <span class="free">k</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>fold <span class="free">f</span> <span class="main">(</span>take <span class="free">k</span> <span class="free">xs</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_Suc neq_Nil_conv<span class="main">)</span>

  <span class="keyword1"><span class="command">primcorec</span></span> <span class="main">(</span>transfer<span class="main">)</span> <span class="entity">sscan</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> stream <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> stream"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">sscan</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>shd <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">##</span> <span class="free">sscan</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>stl <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>shd <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="Sequence-sscan_scons"><span class="command">lemma</span></span> sscan_scons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sscan <span class="free">f</span> <span class="main">(</span><span class="free">x</span> <span class="main">##</span> <span class="free">xs</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x</span> <span class="free">a</span> <span class="main">##</span> sscan <span class="free">f</span> <span class="free">xs</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stream.expand<span class="main">)</span>
  <span class="keyword1" id="Sequence-sscan_shift"><span class="command">lemma</span></span> sscan_shift<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sscan <span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@-</span> <span class="free">ys</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> scan <span class="free">f</span> <span class="free">xs</span> <span class="free">a</span> <span class="main">@-</span> sscan <span class="free">f</span> <span class="free">ys</span> <span class="main">(</span>fold <span class="free">f</span> <span class="free">xs</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1" id="Sequence-sscan_eq_scons"><span class="command">lemma</span></span> sscan_eq_scons<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"sscan <span class="free">f</span> <span class="free">xs</span> <span class="free">a</span> <span class="main">=</span> <span class="free">b</span> <span class="main">##</span> <span class="free">w</span> <span class="main">⟷</span> <span class="free">f</span> <span class="main">(</span>shd <span class="free">xs</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> <span class="free">b</span> <span class="main">∧</span> sscan <span class="free">f</span> <span class="main">(</span>stl <span class="free">xs</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>shd <span class="free">xs</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sscan.ctr stream.inject <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1" id="Sequence-scons_eq_sscan"><span class="command">lemma</span></span> scons_eq_sscan<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">##</span> <span class="free">w</span> <span class="main">=</span> sscan <span class="free">f</span> <span class="free">xs</span> <span class="free">a</span> <span class="main">⟷</span> <span class="free">b</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>shd <span class="free">xs</span><span class="main">)</span> <span class="free">a</span> <span class="main">∧</span> <span class="free">w</span> <span class="main">=</span> sscan <span class="free">f</span> <span class="main">(</span>stl <span class="free">xs</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>shd <span class="free">xs</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sscan.ctr stream.inject <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword1" id="Sequence-sscan_const"><span class="command">lemma</span></span> sscan_const<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sscan const <span class="free">xs</span> <span class="free">a</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1" id="Sequence-sscan_snth"><span class="command">lemma</span></span> sscan_snth<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sscan <span class="free">f</span> <span class="free">xs</span> <span class="free">a</span> <span class="main">!!</span> <span class="free">i</span> <span class="main">=</span> fold <span class="free">f</span> <span class="main">(</span>stake <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1" id="Sequence-sscan_scons_snth"><span class="command">lemma</span></span> sscan_scons_snth<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="main">##</span> sscan <span class="free">f</span> <span class="free">xs</span> <span class="free">a</span><span class="main">)</span> <span class="main">!!</span> <span class="free">i</span> <span class="main">=</span> fold <span class="free">f</span> <span class="main">(</span>stake <span class="free">i</span> <span class="free">xs</span><span class="main">)</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1" id="Sequence-sscan_smap"><span class="command">lemma</span></span> sscan_smap<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sscan <span class="free">f</span> <span class="main">(</span>smap <span class="free">g</span> <span class="free">xs</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> sscan <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="free">g</span><span class="main">)</span> <span class="free">xs</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1" id="Sequence-sscan_stake"><span class="command">lemma</span></span> sscan_stake<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"stake <span class="free">k</span> <span class="main">(</span>sscan <span class="free">f</span> <span class="free">xs</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> scan <span class="free">f</span> <span class="main">(</span>stake <span class="free">k</span> <span class="free">xs</span><span class="main">)</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1" id="Sequence-sscan_sdrop"><span class="command">lemma</span></span> sscan_sdrop<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sdrop <span class="free">k</span> <span class="main">(</span>sscan <span class="free">f</span> <span class="free">xs</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> sscan <span class="free">f</span> <span class="main">(</span>sdrop <span class="free">k</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>fold <span class="free">f</span> <span class="main">(</span>stake <span class="free">k</span> <span class="free">xs</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Transposing Streams›</span></span>

  <span class="keyword1"><span class="command">primcorec</span></span> <span class="main">(</span>transfer<span class="main">)</span> <span class="entity">stranspose</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> stream list <span class="main">⇒</span> <span class="tfree">'a</span> list stream"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">stranspose</span> <span class="free"><span class="bound"><span class="entity">ws</span></span></span> <span class="main">=</span> map shd <span class="free"><span class="bound"><span class="entity">ws</span></span></span> <span class="main">##</span> <span class="free">stranspose</span> <span class="main">(</span>map stl <span class="free"><span class="bound"><span class="entity">ws</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="Sequence-stranspose_eq_scons"><span class="command">lemma</span></span> stranspose_eq_scons<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"stranspose <span class="free">ws</span> <span class="main">=</span> <span class="free">a</span> <span class="main">##</span> <span class="free">w</span> <span class="main">⟷</span> map shd <span class="free">ws</span> <span class="main">=</span> <span class="free">a</span> <span class="main">∧</span> stranspose <span class="main">(</span>map stl <span class="free">ws</span><span class="main">)</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> stranspose.ctr stream.inject <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1" id="Sequence-scons_eq_stranspose"><span class="command">lemma</span></span> scons_eq_stranspose<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">##</span> <span class="free">w</span> <span class="main">=</span> stranspose <span class="free">ws</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">=</span> map shd <span class="free">ws</span> <span class="main">∧</span> <span class="free">w</span> <span class="main">=</span> stranspose <span class="main">(</span>map stl <span class="free">ws</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> stranspose.ctr stream.inject <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword1" id="Sequence-stranspose_nil"><span class="command">lemma</span></span> stranspose_nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"stranspose <span class="main">[]</span> <span class="main">=</span> sconst <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">coinduction</span> <span class="operator">auto</span>
  <span class="keyword1" id="Sequence-stranspose_cons"><span class="command">lemma</span></span> stranspose_cons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"stranspose <span class="main">(</span><span class="free">w</span> <span class="main">#</span> <span class="free">ws</span><span class="main">)</span> <span class="main">=</span> smap2 Cons <span class="free">w</span> <span class="main">(</span>stranspose <span class="free">ws</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">ws</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> list.simps<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> smap2.simps stranspose.simps stream.sel<span class="main">)</span>

  <span class="keyword1" id="Sequence-snth_stranspose"><span class="command">lemma</span></span> snth_stranspose<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"stranspose <span class="free">ws</span> <span class="main">!!</span> <span class="free">k</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span> <span class="bound">w</span><span class="main">.</span> <span class="bound">w</span> <span class="main">!!</span> <span class="free">k</span><span class="main">)</span> <span class="free">ws</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ws</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1" id="Sequence-stranspose_nth"><span class="command">lemma</span></span> stranspose_nth<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> length <span class="free">ws</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"smap <span class="main">(</span><span class="main">λ</span> <span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>stranspose <span class="free">ws</span><span class="main">)</span> <span class="main">=</span> <span class="free">ws</span> <span class="main">!</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> eqI_snth<span class="main">)</span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Distinct Streams›</span></span>

  <span class="keyword1"><span class="command">coinductive</span></span> <span class="entity">sdistinct</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> stream <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    scons<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∉</span> sset <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">⟹</span> <span class="free">sdistinct</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">⟹</span> <span class="free">sdistinct</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">##</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="Sequence-sdistinct_scons_elim"><span class="command">lemma</span></span> sdistinct_scons_elim<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sdistinct <span class="main">(</span><span class="free">x</span> <span class="main">##</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> sset <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"sdistinct <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> sdistinct.cases<span class="main">)</span>

  <span class="keyword1" id="Sequence-sdistinct_coinduct"><span class="command">lemma</span></span> sdistinct_coinduct<span class="main">[</span><span class="operator">case_names</span> sdistinct<span class="main">,</span> <span class="operator">coinduct</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">pred</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">:</span></span></span></span> sdistinct<span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">xs</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="bound">x</span> <span class="main">##</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∉</span> sset <span class="bound">xs</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sdistinct <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> stream.collapse sdistinct.coinduct assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword1" id="Sequence-sdistinct_shift"><span class="command">lemma</span></span> sdistinct_shift<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"sdistinct <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">∩</span> sset <span class="free">ys</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sdistinct <span class="main">(</span><span class="free">xs</span> <span class="main">@-</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1" id="Sequence-sdistinct_shift_elim"><span class="command">lemma</span></span> sdistinct_shift_elim<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sdistinct <span class="main">(</span><span class="free">xs</span> <span class="main">@-</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"sdistinct <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">∩</span> sset <span class="free">ys</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1" id="Sequence-sdistinct_infinite_sset"><span class="command">lemma</span></span> sdistinct_infinite_sset<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sdistinct <span class="free">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>sset <span class="free">w</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> sdistinct.cases<span class="main">)</span>

  <span class="keyword1" id="Sequence-not_sdistinct_decomp"><span class="command">lemma</span></span> not_sdistinct_decomp<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> sdistinct <span class="free">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">u</span> <span class="free">v</span> <span class="free">a</span> <span class="free">w'</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="free">u</span> <span class="main">@-</span> <span class="free">a</span> <span class="main">##</span> <span class="free">v</span> <span class="main">@-</span> <span class="free">a</span> <span class="main">##</span> <span class="free">w'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">thesis</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">@-</span> <span class="skolem">a</span> <span class="main">##</span> <span class="skolem">v</span> <span class="main">@-</span> <span class="skolem">a</span> <span class="main">##</span> <span class="skolem">w'</span> <span class="main">⟹</span> <span class="free">thesis</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">u</span> <span class="skolem">a</span> <span class="skolem">v</span> <span class="skolem">w'</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">u</span> <span class="bound">v</span> <span class="bound">a</span> <span class="bound">w'</span><span class="main">.</span> <span class="free">w</span> <span class="main">≠</span> <span class="bound">u</span> <span class="main">@-</span> <span class="bound">a</span> <span class="main">##</span> <span class="bound">v</span> <span class="main">@-</span> <span class="bound">a</span> <span class="main">##</span> <span class="bound">w'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"sdistinct <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduct</span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> id_stake_snth_sdrop imageE shift.simps sset_range<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Sorted Streams›</span></span>

  <span class="keyword1"><span class="command">coinductive</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> order<span class="main">)</span> <span class="entity">sascending</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> stream <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⟹</span> <span class="free">sascending</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">##</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">sascending</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">##</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">##</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">coinductive</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> order<span class="main">)</span> <span class="entity">sdescending</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> stream <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≥</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⟹</span> <span class="free">sdescending</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">##</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">sdescending</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">##</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">##</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="Sequence-sdescending_coinduct"><span class="command">lemma</span></span> sdescending_coinduct<span class="main">[</span><span class="operator">case_names</span> sdescending<span class="main">,</span> <span class="operator">coinduct</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">pred</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">:</span></span></span></span> sdescending<span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">w</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="bound">a</span> <span class="main">##</span> <span class="bound">b</span> <span class="main">##</span> <span class="bound">w</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">≥</span> <span class="bound">b</span> <span class="main">∧</span> <span class="free">P</span> <span class="main">(</span><span class="bound">b</span> <span class="main">##</span> <span class="bound">w</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sdescending <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> stream.collapse sdescending.coinduct assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span><span class="main">)</span>

  <span class="keyword1" id="Sequence-sdescending_scons"><span class="command">lemma</span></span> sdescending_scons<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sdescending <span class="main">(</span><span class="free">a</span> <span class="main">##</span> <span class="free">w</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sdescending <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> sdescending.cases<span class="main">)</span>
  <span class="keyword1" id="Sequence-sdescending_sappend"><span class="command">lemma</span></span> sdescending_sappend<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sdescending <span class="main">(</span><span class="free">u</span> <span class="main">@-</span> <span class="free">v</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"sdescending <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">u</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> sdescending.cases<span class="main">)</span>
  <span class="keyword1" id="Sequence-sdescending_sdrop"><span class="command">lemma</span></span> sdescending_sdrop<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sdescending <span class="free">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sdescending <span class="main">(</span>sdrop <span class="free">k</span> <span class="free">w</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sdescending_sappend stake_sdrop<span class="main">)</span>

  <span class="keyword1" id="Sequence-sdescending_sset_scons"><span class="command">lemma</span></span> sdescending_sset_scons<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sdescending <span class="main">(</span><span class="free">a</span> <span class="main">##</span> <span class="free">w</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> sset <span class="free">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≥</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">b</span><span class="main">.</span> <span class="free">a</span> <span class="main">≥</span> <span class="bound">b</span><span class="main">)</span> <span class="skolem">w</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"sdescending <span class="skolem">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≥</span> shd <span class="skolem">w</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">w</span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">w</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> sdescending.cases<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> stream.pred_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="Sequence-sdescending_sset_sappend"><span class="command">lemma</span></span> sdescending_sset_sappend<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sdescending <span class="main">(</span><span class="free">u</span> <span class="main">@-</span> <span class="free">v</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> set <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> sset <span class="free">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≥</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">u</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> sdescending.cases <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sdescending_sset_scons<span class="main">)</span>

  <span class="keyword1" id="Sequence-sdescending_snth_antimono"><span class="command">lemma</span></span> sdescending_snth_antimono<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sdescending <span class="free">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"antimono <span class="main">(</span>snth <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> antimono_iff_le_Suc
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sdescending <span class="main">(</span>sdrop <span class="skolem">k</span> <span class="free">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sdescending_sdrop assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"sdrop <span class="skolem">k</span> <span class="free">w</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">##</span> <span class="skolem">b</span> <span class="main">##</span> <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≥</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">!!</span> <span class="skolem">k</span> <span class="main">≥</span> <span class="free">w</span> <span class="main">!!</span> Suc <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sdrop_simps stream.sel<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Sequence-sdescending_stuck"><span class="command">lemma</span></span> sdescending_stuck<span class="main">:</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">w</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> wellorder stream"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sdescending <span class="free">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">u</span> <span class="free">a</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="free">u</span> <span class="main">@-</span> sconst <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"shd <span class="free">w</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> less
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> sconst <span class="main">(</span>shd <span class="skolem">w</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> shift_replicate_sconst less<span class="main">(</span>2<span class="main">)</span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">@-</span> <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"shd <span class="skolem">w</span> <span class="main">≠</span> shd <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> empty_iff eqI_snth insert_iff sdrop_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> shift.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> snth_sset sset_sconst stake_sdrop<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"shd <span class="skolem">w</span> <span class="main">≥</span> shd <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sdescending_sset_sappend less<span class="main">(</span>3<span class="main">)</span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> hd_in_set shd_sset shift_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"shd <span class="skolem">w</span> <span class="main">&gt;</span> shd <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>3<span class="main">)</span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="skolem">s</span> <span class="main">@-</span> sconst <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sdescending_sappend less<span class="main">(</span>1<span class="main">,</span> 3<span class="main">)</span> 1<span class="main">(</span>1<span class="main">)</span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">@-</span> sconst <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 1<span class="main">(</span>1<span class="main">)</span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> less<span class="main">(</span>2<span class="main">)</span> 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Sequence_LTL">
<div class="head">
<h1>Theory Sequence_LTL</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Linear Temporal Logic on Streams›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Sequence_LTL
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="Sequence.html">Sequence</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Linear_Temporal_Logic_on_Streams.html">HOL-Library.Linear_Temporal_Logic_on_Streams</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Basics›</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Avoid destroying the constant <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> holds<span class="antiquote"><span class="antiquote">}</span></span></span></span> prematurely.›</span></span>
  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span></span><span class="main">]</span> <span class="main">=</span> holds.simps holds_eq1 holds_eq2 not_holds_eq

  <span class="comment1">(* TODO: these cannot be applied successively to simplify infs due to introduction of ∘
    avoid or add extra simplification rules for infs *)</span>
  <span class="keyword1" id="Sequence_LTL-ev_smap"><span class="command">lemma</span></span> ev_smap<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ev <span class="free">P</span> <span class="main">(</span>smap <span class="free">f</span> <span class="free">w</span><span class="main">)</span> <span class="main">⟷</span> ev <span class="main">(</span><span class="free">P</span> <span class="main">∘</span> smap <span class="free">f</span><span class="main">)</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ev_smap <span class="keyword1"><span class="command">unfolding</span></span> comp_apply <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1" id="Sequence_LTL-alw_smap"><span class="command">lemma</span></span> alw_smap<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="free">P</span> <span class="main">(</span>smap <span class="free">f</span> <span class="free">w</span><span class="main">)</span> <span class="main">⟷</span> alw <span class="main">(</span><span class="free">P</span> <span class="main">∘</span> smap <span class="free">f</span><span class="main">)</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> alw_smap <span class="keyword1"><span class="command">unfolding</span></span> comp_apply <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1" id="Sequence_LTL-holds_smap"><span class="command">lemma</span></span> holds_smap<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"holds <span class="free">P</span> <span class="main">(</span>smap <span class="free">f</span> <span class="free">w</span><span class="main">)</span> <span class="main">⟷</span> holds <span class="main">(</span><span class="free">P</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> holds.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">iff</span><span class="main">]</span> <span class="main">=</span> ev_sconst alw_sconst hld_smap'

  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">iff</span><span class="main">]</span> <span class="main">=</span> alw_ev_stl
  <span class="keyword1" id="Sequence_LTL-alw_ev_sdrop"><span class="command">lemma</span></span> alw_ev_sdrop<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>ev <span class="free">P</span><span class="main">)</span> <span class="main">(</span>sdrop <span class="free">n</span> <span class="free">w</span><span class="main">)</span> <span class="main">⟷</span> alw <span class="main">(</span>ev <span class="free">P</span><span class="main">)</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> alw_ev_sdrop alw_sdrop <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1" id="Sequence_LTL-alw_ev_scons"><span class="command">lemma</span></span> alw_ev_scons<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>ev <span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span> <span class="main">##</span> <span class="free">w</span><span class="main">)</span> <span class="main">⟷</span> alw <span class="main">(</span>ev <span class="free">P</span><span class="main">)</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alw_ev_stl stream.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1" id="Sequence_LTL-alw_ev_shift"><span class="command">lemma</span></span> alw_ev_shift<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>ev <span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="free">u</span> <span class="main">@-</span> <span class="free">v</span><span class="main">)</span> <span class="main">⟷</span> alw <span class="main">(</span>ev <span class="free">P</span><span class="main">)</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">u</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">,</span> <span class="operator">iff</span><span class="main">]</span> <span class="main">=</span> ev_alw_stl
  <span class="keyword1" id="Sequence_LTL-ev_alw_sdrop"><span class="command">lemma</span></span> ev_alw_sdrop<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ev <span class="main">(</span>alw <span class="free">P</span><span class="main">)</span> <span class="main">(</span>sdrop <span class="free">n</span> <span class="free">w</span><span class="main">)</span> <span class="main">⟷</span> ev <span class="main">(</span>alw <span class="free">P</span><span class="main">)</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> alwD alw_alw alw_sdrop ev_alw_imp_alw_ev not_ev_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1" id="Sequence_LTL-ev_alw_scons"><span class="command">lemma</span></span> ev_alw_scons<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ev <span class="main">(</span>alw <span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span> <span class="main">##</span> <span class="free">w</span><span class="main">)</span> <span class="main">⟷</span> ev <span class="main">(</span>alw <span class="free">P</span><span class="main">)</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ev_alw_stl stream.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1" id="Sequence_LTL-ev_alw_shift"><span class="command">lemma</span></span> ev_alw_shift<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ev <span class="main">(</span>alw <span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="free">u</span> <span class="main">@-</span> <span class="free">v</span><span class="main">)</span> <span class="main">⟷</span> ev <span class="main">(</span>alw <span class="free">P</span><span class="main">)</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">u</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1" id="Sequence_LTL-holds_sconst"><span class="command">lemma</span></span> holds_sconst<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"holds <span class="free">P</span> <span class="main">(</span>sconst <span class="free">a</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">P</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> holds.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1" id="Sequence_LTL-HLD_sconst"><span class="command">lemma</span></span> HLD_sconst<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"HLD <span class="free">A</span> <span class="main">(</span>sconst <span class="free">a</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> HLD_def holds.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1" id="Sequence_LTL-ev_alt_def"><span class="command">lemma</span></span> ev_alt_def<span class="main">:</span> <span class="quoted"><span class="quoted">"ev <span class="free">φ</span> <span class="free">w</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="free">w</span> <span class="main">=</span> <span class="bound">u</span> <span class="main">@-</span> <span class="bound">v</span> <span class="main">∧</span> <span class="free">φ</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ev.base ev_shift ev_imp_shift <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1" id="Sequence_LTL-ev_stl_alt_def"><span class="command">lemma</span></span> ev_stl_alt_def<span class="main">:</span> <span class="quoted"><span class="quoted">"ev <span class="free">φ</span> <span class="main">(</span>stl <span class="free">w</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="free">w</span> <span class="main">=</span> <span class="bound">u</span> <span class="main">@-</span> <span class="bound">v</span> <span class="main">∧</span> <span class="bound">u</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">φ</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ev_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> scons_eq<span class="main">)</span>

  <span class="keyword1" id="Sequence_LTL-ev_HLD_sset"><span class="command">lemma</span></span> ev_HLD_sset<span class="main">:</span> <span class="quoted"><span class="quoted">"ev <span class="main">(</span>HLD <span class="free">A</span><span class="main">)</span> <span class="free">w</span> <span class="main">⟷</span> sset <span class="free">w</span> <span class="main">∩</span> <span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> HLD_def ev_holds_sset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Sequence_LTL-alw_ev_coinduct"><span class="command">lemma</span></span> alw_ev_coinduct<span class="main">[</span><span class="operator">case_names</span> alw_ev<span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">w</span><span class="main">.</span> <span class="free">R</span> <span class="bound">w</span> <span class="main">⟹</span> ev <span class="free">φ</span> <span class="bound">w</span> <span class="main">∧</span> ev <span class="free">R</span> <span class="main">(</span>stl <span class="bound">w</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"alw <span class="main">(</span>ev <span class="free">φ</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ev <span class="free">R</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduct</span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> alw_sdrop not_ev_iff sdrop_stl sdrop_wait<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Infinite Occurrence›</span></span>

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">infs</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">≡</span> alw <span class="main">(</span>ev <span class="main">(</span>holds <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span>"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">fins</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">≡</span> <span class="main">¬</span> infs <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span>"</span></span>

  <span class="keyword1" id="Sequence_LTL-infs_suffix"><span class="command">lemma</span></span> infs_suffix<span class="main">:</span> <span class="quoted"><span class="quoted">"infs <span class="free">P</span> <span class="free">w</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="free">w</span> <span class="main">=</span> <span class="bound">u</span> <span class="main">@-</span> <span class="bound">v</span> <span class="main">⟶</span> Bex <span class="main">(</span>sset <span class="bound">v</span><span class="main">)</span> <span class="free">P</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> alwD alw_iff_sdrop alw_shift ev_holds_sset stake_sdrop <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1" id="Sequence_LTL-infs_snth"><span class="command">lemma</span></span> infs_snth<span class="main">:</span> <span class="quoted"><span class="quoted">"infs <span class="free">P</span> <span class="free">w</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">n</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">k</span></span> <span class="main">≥</span> <span class="bound">n</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">w</span> <span class="main">!!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> alw_iff_sdrop ev_iff_sdrop holds.simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> le_add1 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> le_Suc_ex<span class="main">)</span>
  <span class="keyword1" id="Sequence_LTL-infs_infm"><span class="command">lemma</span></span> infs_infm<span class="main">:</span> <span class="quoted"><span class="quoted">"infs <span class="free">P</span> <span class="free">w</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃<span class="hidden">⇩</span><sub>∞</sub></span> <span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">w</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> infs_snth INFM_nat_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>

  <span class="keyword1" id="Sequence_LTL-infs_coinduct"><span class="command">lemma</span></span> infs_coinduct<span class="main">[</span><span class="operator">case_names</span> infs<span class="main">,</span> <span class="operator">coinduct</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">pred</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">:</span></span></span></span> infs<span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">w</span><span class="main">.</span> <span class="free">R</span> <span class="bound">w</span> <span class="main">⟹</span> Bex <span class="main">(</span>sset <span class="bound">w</span><span class="main">)</span> <span class="free">P</span> <span class="main">∧</span> ev <span class="free">R</span> <span class="main">(</span>stl <span class="bound">w</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"infs <span class="free">P</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> alw_ev_coinduct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ev_holds_sset<span class="main">)</span>
  <span class="keyword1" id="Sequence_LTL-infs_coinduct_shift"><span class="command">lemma</span></span> infs_coinduct_shift<span class="main">[</span><span class="operator">case_names</span> infs<span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">w</span><span class="main">.</span> <span class="free">R</span> <span class="bound">w</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">w</span> <span class="main">=</span> <span class="bound">u</span> <span class="main">@-</span> <span class="bound">v</span> <span class="main">∧</span> Bex <span class="main">(</span>set <span class="bound">u</span><span class="main">)</span> <span class="free">P</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"infs <span class="free">P</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduct</span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ev_stl_alt_def<span class="main">)</span>
  <span class="keyword1" id="Sequence_LTL-infs_flat_coinduct"><span class="command">lemma</span></span> infs_flat_coinduct<span class="main">[</span><span class="operator">case_names</span> infs_flat<span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="free">R</span> <span class="main">(</span><span class="bound">u</span> <span class="main">##</span> <span class="bound">v</span><span class="main">)</span> <span class="main">⟹</span> Bex <span class="main">(</span>set <span class="bound">u</span><span class="main">)</span> <span class="free">P</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"infs <span class="free">P</span> <span class="main">(</span>flat <span class="free">w</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infs_coinduct_shift<span class="main">)</span>
      <span class="main">(</span><span class="operator">metis</span> empty_iff flat_Stream list.set<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> stream.exhaust<span class="main">)</span>
  <span class="keyword1" id="Sequence_LTL-infs_sscan_coinduct"><span class="command">lemma</span></span> infs_sscan_coinduct<span class="main">[</span><span class="operator">case_names</span> infs_sscan<span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">w</span> <span class="free">a</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">w</span> <span class="bound">a</span><span class="main">.</span> <span class="free">R</span> <span class="bound">w</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">a</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">w</span> <span class="main">=</span> <span class="bound">u</span> <span class="main">@-</span> <span class="bound">v</span> <span class="main">∧</span> <span class="bound">u</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">v</span> <span class="main">(</span>fold <span class="free">f</span> <span class="bound">u</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"infs <span class="free">P</span> <span class="main">(</span><span class="free">a</span> <span class="main">##</span> sscan <span class="free">f</span> <span class="free">w</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infs_coinduct_shift<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>infs <span class="skolem">w</span> <span class="skolem">a</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">@-</span> <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="skolem">v</span> <span class="main">(</span>fold <span class="free">f</span> <span class="skolem">u</span> <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> infs assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI bexI<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sscan <span class="free">f</span> <span class="skolem">w</span> <span class="skolem">a</span> <span class="main">=</span> scan <span class="free">f</span> <span class="skolem">u</span> <span class="skolem">a</span> <span class="main">@-</span> sscan <span class="free">f</span> <span class="skolem">v</span> <span class="main">(</span>fold <span class="free">f</span> <span class="skolem">u</span> <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"scan <span class="free">f</span> <span class="skolem">u</span> <span class="skolem">a</span> <span class="main">=</span> butlast <span class="main">(</span>scan <span class="free">f</span> <span class="skolem">u</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>fold <span class="free">f</span> <span class="skolem">u</span> <span class="skolem">a</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> last_ConsR scan_eq_nil scan_last snoc_eq_iff_butlast<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">##</span> <span class="main">…</span> <span class="main">@-</span> sscan <span class="free">f</span> <span class="skolem">v</span> <span class="main">(</span>fold <span class="free">f</span> <span class="skolem">u</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> butlast <span class="main">(</span>scan <span class="free">f</span> <span class="skolem">u</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">@-</span> fold <span class="free">f</span> <span class="skolem">u</span> <span class="skolem">a</span> <span class="main">##</span> sscan <span class="free">f</span> <span class="skolem">v</span> <span class="main">(</span>fold <span class="free">f</span> <span class="skolem">u</span> <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">##</span> sscan <span class="free">f</span> <span class="skolem">w</span> <span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> butlast <span class="main">(</span>scan <span class="free">f</span> <span class="skolem">u</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">@-</span> fold <span class="free">f</span> <span class="skolem">u</span> <span class="skolem">a</span> <span class="main">##</span> sscan <span class="free">f</span> <span class="skolem">v</span> <span class="main">(</span>fold <span class="free">f</span> <span class="skolem">u</span> <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> butlast <span class="main">(</span>scan <span class="free">f</span> <span class="skolem">u</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="skolem">v</span> <span class="main">(</span>fold <span class="free">f</span> <span class="skolem">u</span> <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Sequence_LTL-infs_mono"><span class="command">lemma</span></span> infs_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> sset <span class="free">w</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">a</span><span class="main">)</span> <span class="main">⟹</span> infs <span class="free">P</span> <span class="free">w</span> <span class="main">⟹</span> infs <span class="free">Q</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> infs_snth <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1" id="Sequence_LTL-infs_mono_strong"><span class="command">lemma</span></span> infs_mono_strong<span class="main">:</span> <span class="quoted"><span class="quoted">"stream_all2 <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="bound">b</span><span class="main">)</span> <span class="free">u</span> <span class="free">v</span> <span class="main">⟹</span> infs <span class="free">P</span> <span class="free">u</span> <span class="main">⟹</span> infs <span class="free">Q</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> stream_rel_snth infs_snth <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1" id="Sequence_LTL-infs_all"><span class="command">lemma</span></span> infs_all<span class="main">:</span> <span class="quoted"><span class="quoted">"Ball <span class="main">(</span>sset <span class="free">w</span><span class="main">)</span> <span class="free">P</span> <span class="main">⟹</span> infs <span class="free">P</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> infs_snth <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="Sequence_LTL-infs_any"><span class="command">lemma</span></span> infs_any<span class="main">:</span> <span class="quoted"><span class="quoted">"infs <span class="free">P</span> <span class="free">w</span> <span class="main">⟹</span> Bex <span class="main">(</span>sset <span class="free">w</span><span class="main">)</span> <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ev_holds_sset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Sequence_LTL-infs_bot"><span class="command">lemma</span></span> infs_bot<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"infs bot <span class="free">w</span> <span class="main">⟷</span> False"</span></span> <span class="keyword1"><span class="command">using</span></span> infs_any <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="Sequence_LTL-infs_top"><span class="command">lemma</span></span> infs_top<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"infs top <span class="free">w</span> <span class="main">⟷</span> True"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> infs_all<span class="main">)</span>
  <span class="keyword1" id="Sequence_LTL-infs_disj"><span class="command">lemma</span></span> infs_disj<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="main">∨</span> <span class="free">Q</span> <span class="bound">a</span><span class="main">)</span> <span class="free">w</span> <span class="main">⟷</span> infs <span class="free">P</span> <span class="free">w</span> <span class="main">∨</span> infs <span class="free">Q</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> infs_snth <span class="keyword1"><span class="command">using</span></span> le_trans le_cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1" id="Sequence_LTL-infs_bex"><span class="command">lemma</span></span> infs_bex<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">a</span><span class="main">)</span> <span class="free">w</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> infs <span class="main">(</span><span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms infs_any <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="operator">auto</span>
  <span class="keyword1" id="Sequence_LTL-infs_bex_le_nat"><span class="command">lemma</span></span> infs_bex_le_nat<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">k</span></span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">::</span> nat<span class="main">.</span> <span class="free">P</span> <span class="bound">k</span> <span class="bound">a</span><span class="main">)</span> <span class="free">w</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound"><span class="bound">k</span></span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">.</span> infs <span class="main">(</span><span class="free">P</span> <span class="bound">k</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">k</span></span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">.</span> <span class="free">P</span> <span class="bound">k</span> <span class="bound">a</span><span class="main">)</span> <span class="free">w</span> <span class="main">⟷</span> infs <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="free">P</span> <span class="bound">k</span> <span class="bound">a</span><span class="main">)</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">}</span><span class="main">.</span> infs <span class="main">(</span><span class="free">P</span> <span class="bound">k</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound"><span class="bound">k</span></span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">.</span> infs <span class="main">(</span><span class="free">P</span> <span class="bound">k</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Sequence_LTL-infs_cycle"><span class="command">lemma</span></span> infs_cycle<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"infs <span class="free">P</span> <span class="main">(</span>cycle <span class="free">w</span><span class="main">)</span> <span class="main">⟷</span> Bex <span class="main">(</span>set <span class="free">w</span><span class="main">)</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"infs <span class="free">P</span> <span class="main">(</span>cycle <span class="free">w</span><span class="main">)</span> <span class="main">⟹</span> Bex <span class="main">(</span>set <span class="free">w</span><span class="main">)</span> <span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ev_holds_sset <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> alwD<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Bex <span class="main">(</span>set <span class="free">w</span><span class="main">)</span> <span class="free">P</span> <span class="main">⟹</span> infs <span class="free">P</span> <span class="main">(</span>cycle <span class="free">w</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infs_coinduct_shift<span class="main">)</span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> cycle_decomp<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Sequence_Zip">
<div class="head">
<h1>Theory Sequence_Zip</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Zipping Sequences›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Sequence_Zip
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Sequence_LTL.html">Sequence_LTL</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Zipping Lists›</span></span>

  <span class="keyword1"><span class="command">notation</span></span> zip <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">||</span>"</span> 51<span class="main">)</span>

  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> zip_map_fst_snd

  <span class="keyword1" id="Sequence_Zip-split_zip"><span class="command">lemma</span></span> split_zip<span class="main">[</span><span class="operator">no_atp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">PROP</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> length <span class="bound">y</span> <span class="main">=</span> length <span class="bound">z</span> <span class="main">⟹</span> <span class="keyword1">PROP</span> <span class="free">P</span> <span class="main">(</span><span class="bound">y</span> <span class="main">||</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="skolem">z</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">PROP</span> <span class="free">P</span> <span class="bound">x</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">PROP</span> <span class="free">P</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">||</span> <span class="skolem">z</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> list"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> length <span class="bound">y</span> <span class="main">=</span> length <span class="bound">z</span> <span class="main">⟹</span> <span class="keyword1">PROP</span> <span class="free">P</span> <span class="main">(</span><span class="bound">y</span> <span class="main">||</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>map fst <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>map snd <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">PROP</span> <span class="free">P</span> <span class="main">(</span>map fst <span class="skolem">x</span> <span class="main">||</span> map snd <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">PROP</span> <span class="free">P</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="Sequence_Zip-split_zip_all"><span class="command">lemma</span></span> split_zip_all<span class="main">[</span><span class="operator">no_atp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> length <span class="bound">y</span> <span class="main">=</span> length <span class="bound">z</span> <span class="main">⟶</span> <span class="free">P</span> <span class="main">(</span><span class="bound">y</span> <span class="main">||</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> split_zip<span class="main">)</span>
  <span class="keyword1" id="Sequence_Zip-split_zip_ex"><span class="command">lemma</span></span> split_zip_ex<span class="main">[</span><span class="operator">no_atp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span> <span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> length <span class="bound">y</span> <span class="main">=</span> length <span class="bound">z</span> <span class="main">∧</span> <span class="free">P</span> <span class="main">(</span><span class="bound">y</span> <span class="main">||</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> split_zip<span class="main">)</span>

  <span class="keyword1" id="Sequence_Zip-zip_eq"><span class="command">lemma</span></span> zip_eq<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">u</span> <span class="main">=</span> length <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">r</span> <span class="main">=</span> length <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">||</span> <span class="free">v</span> <span class="main">=</span> <span class="free">r</span> <span class="main">||</span> <span class="free">s</span> <span class="main">⟷</span> <span class="free">u</span> <span class="main">=</span> <span class="free">r</span> <span class="main">∧</span> <span class="free">v</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms zip_eq_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword1" id="Sequence_Zip-list_rel_pred_zip"><span class="command">lemma</span></span> list_rel_pred_zip<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">P</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">⟷</span> length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span> <span class="main">∧</span> list_all <span class="main">(</span>case_prod <span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">||</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> list_all2_conv_all_nth list_all_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Sequence_Zip-list_choice_zip"><span class="command">lemma</span></span> list_choice_zip<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="free">xs</span> <span class="main">⟷</span>
    <span class="main">(</span><span class="main">∃</span> <span class="bound">ys</span><span class="main">.</span> length <span class="bound">ys</span> <span class="main">=</span> length <span class="free">xs</span> <span class="main">∧</span> list_all <span class="main">(</span>case_prod <span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">||</span> <span class="bound">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> list_choice list_rel_pred_zip <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1" id="Sequence_Zip-list_choice_pair"><span class="command">lemma</span></span> list_choice_pair<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span> <span class="bound">xy</span><span class="main">.</span> case_prod <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">z</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">)</span> <span class="bound">xy</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">||</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⟷</span>
    <span class="main">(</span><span class="main">∃</span> <span class="bound">zs</span><span class="main">.</span> length <span class="bound">zs</span> <span class="main">=</span> min <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>length <span class="free">ys</span><span class="main">)</span> <span class="main">∧</span> list_all <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">||</span> <span class="free">ys</span> <span class="main">||</span> <span class="bound">zs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">xy</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">xy</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">xs</span> <span class="main">||</span> <span class="free">ys</span><span class="main">)</span> <span class="main">||</span> <span class="skolem">zs</span><span class="main">)</span> <span class="main">⟷</span>
      list_all <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">||</span> <span class="free">ys</span> <span class="main">||</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">zs</span>
      <span class="keyword1"><span class="command">unfolding</span></span> zip_assoc list.pred_map <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list.pred_cong<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">z</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">xy</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">z</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">xy</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> list_choice_zip 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Sequence_Zip-list_rel_zip"><span class="command">lemma</span></span> list_rel_zip<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">u</span> <span class="main">=</span> length <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">r</span> <span class="main">=</span> length <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span>rel_prod <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="free">u</span> <span class="main">||</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="free">r</span> <span class="main">||</span> <span class="free">s</span><span class="main">)</span> <span class="main">⟷</span> list_all2 <span class="free">A</span> <span class="free">u</span> <span class="free">r</span> <span class="main">∧</span> list_all2 <span class="free">B</span> <span class="free">v</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span>rel_prod <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="free">u</span> <span class="main">||</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="free">r</span> <span class="main">||</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">A</span> <span class="main">(</span>map fst <span class="main">(</span><span class="free">u</span> <span class="main">||</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map fst <span class="main">(</span><span class="free">r</span> <span class="main">||</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer_prover</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">A</span> <span class="free">u</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">B</span> <span class="main">(</span>map snd <span class="main">(</span><span class="free">u</span> <span class="main">||</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map snd <span class="main">(</span><span class="free">r</span> <span class="main">||</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer_prover</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">B</span> <span class="free">v</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">A</span> <span class="free">u</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">B</span> <span class="free">v</span> <span class="free">s</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span>rel_prod <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="free">u</span> <span class="main">||</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="free">r</span> <span class="main">||</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer_prover</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Sequence_Zip-zip_last"><span class="command">lemma</span></span> zip_last<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">||</span> <span class="free">ys</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"last <span class="main">(</span><span class="free">xs</span> <span class="main">||</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>last <span class="free">xs</span><span class="main">,</span> last <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"last <span class="main">(</span><span class="free">xs</span> <span class="main">||</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">xs</span> <span class="main">||</span> <span class="free">ys</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span>length <span class="main">(</span><span class="free">xs</span> <span class="main">||</span> <span class="free">ys</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> last_conv_nth assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="main">(</span>length <span class="main">(</span><span class="free">xs</span> <span class="main">||</span> <span class="free">ys</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">,</span> <span class="free">ys</span> <span class="main">!</span> <span class="main">(</span>length <span class="main">(</span><span class="free">xs</span> <span class="main">||</span> <span class="free">ys</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="main">(</span>length <span class="free">xs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">,</span> <span class="free">ys</span> <span class="main">!</span> <span class="main">(</span>length <span class="free">ys</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>last <span class="free">xs</span><span class="main">,</span> last <span class="free">ys</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> last_conv_nth 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Zipping Streams›</span></span>

  <span class="keyword1"><span class="command">notation</span></span> szip <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">|||</span>"</span> 51<span class="main">)</span>

  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> szip_unfold

  <span class="keyword1" id="Sequence_Zip-smap_szip_same"><span class="command">lemma</span></span> smap_szip_same<span class="main">:</span> <span class="quoted"><span class="quoted">"smap <span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">|||</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> smap <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1" id="Sequence_Zip-szip_smap"><span class="command">lemma</span></span> szip_smap<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"smap fst <span class="free">zs</span> <span class="main">|||</span> smap snd <span class="free">zs</span> <span class="main">=</span> <span class="free">zs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">zs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1" id="Sequence_Zip-szip_smap_fst"><span class="command">lemma</span></span> szip_smap_fst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"smap fst <span class="main">(</span><span class="free">xs</span> <span class="main">|||</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1" id="Sequence_Zip-szip_smap_snd"><span class="command">lemma</span></span> szip_smap_snd<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"smap snd <span class="main">(</span><span class="free">xs</span> <span class="main">|||</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> <span class="free">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1" id="Sequence_Zip-szip_smap_both"><span class="command">lemma</span></span> szip_smap_both<span class="main">:</span> <span class="quoted"><span class="quoted">"smap <span class="free">f</span> <span class="free">xs</span> <span class="main">|||</span> smap <span class="free">g</span> <span class="free">ys</span> <span class="main">=</span> smap <span class="main">(</span>map_prod <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">|||</span> <span class="free">ys</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1" id="Sequence_Zip-szip_smap_left"><span class="command">lemma</span></span> szip_smap_left<span class="main">:</span> <span class="quoted"><span class="quoted">"smap <span class="free">f</span> <span class="free">xs</span> <span class="main">|||</span> <span class="free">ys</span> <span class="main">=</span> smap <span class="main">(</span>apfst <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">|||</span> <span class="free">ys</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1" id="Sequence_Zip-szip_smap_right"><span class="command">lemma</span></span> szip_smap_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">|||</span> smap <span class="free">f</span> <span class="free">ys</span> <span class="main">=</span> smap <span class="main">(</span>apsnd <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">|||</span> <span class="free">ys</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">lemmas</span></span> szip_smap_fold <span class="main">=</span> szip_smap_both szip_smap_left szip_smap_right

  <span class="keyword1" id="Sequence_Zip-szip_sconst_smap_fst"><span class="command">lemma</span></span> szip_sconst_smap_fst<span class="main">:</span> <span class="quoted"><span class="quoted">"sconst <span class="free">a</span> <span class="main">|||</span> <span class="free">xs</span> <span class="main">=</span> smap <span class="main">(</span>Pair <span class="free">a</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1" id="Sequence_Zip-szip_sconst_smap_snd"><span class="command">lemma</span></span> szip_sconst_smap_snd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">|||</span> sconst <span class="free">a</span> <span class="main">=</span> smap <span class="main">(</span>prod.swap <span class="main">∘</span> Pair <span class="free">a</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1" id="Sequence_Zip-split_szip"><span class="command">lemma</span></span> split_szip<span class="main">[</span><span class="operator">no_atp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">PROP</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋀</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="keyword1">PROP</span> <span class="free">P</span> <span class="main">(</span><span class="bound">y</span> <span class="main">|||</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="skolem">z</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">PROP</span> <span class="free">P</span> <span class="bound">x</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">PROP</span> <span class="free">P</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">|||</span> <span class="skolem">z</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="keyword1">PROP</span> <span class="free">P</span> <span class="main">(</span><span class="bound">y</span> <span class="main">|||</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">PROP</span> <span class="free">P</span> <span class="main">(</span>smap fst <span class="skolem">x</span> <span class="main">|||</span> smap snd <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">PROP</span> <span class="free">P</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="Sequence_Zip-split_szip_all"><span class="command">lemma</span></span> split_szip_all<span class="main">[</span><span class="operator">no_atp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="bound">y</span> <span class="main">|||</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> split_szip<span class="main">)</span>
  <span class="keyword1" id="Sequence_Zip-split_szip_ex"><span class="command">lemma</span></span> split_szip_ex<span class="main">[</span><span class="operator">no_atp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span> <span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="bound">y</span> <span class="main">|||</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> split_szip<span class="main">)</span>

  <span class="keyword1" id="Sequence_Zip-szip_eq"><span class="command">lemma</span></span> szip_eq<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">|||</span> <span class="free">v</span> <span class="main">=</span> <span class="free">r</span> <span class="main">|||</span> <span class="free">s</span> <span class="main">⟷</span> <span class="free">u</span> <span class="main">=</span> <span class="free">r</span> <span class="main">∧</span> <span class="free">v</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> szip_smap_fst szip_smap_snd <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword1" id="Sequence_Zip-stream_rel_szip"><span class="command">lemma</span></span> stream_rel_szip<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"stream_all2 <span class="main">(</span>rel_prod <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="free">u</span> <span class="main">|||</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="free">r</span> <span class="main">|||</span> <span class="free">s</span><span class="main">)</span> <span class="main">⟷</span> stream_all2 <span class="free">A</span> <span class="free">u</span> <span class="free">r</span> <span class="main">∧</span> stream_all2 <span class="free">B</span> <span class="free">v</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"stream_all2 <span class="main">(</span>rel_prod <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="free">u</span> <span class="main">|||</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="free">r</span> <span class="main">|||</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"stream_all2 <span class="free">A</span> <span class="main">(</span>smap fst <span class="main">(</span><span class="free">u</span> <span class="main">|||</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>smap fst <span class="main">(</span><span class="free">r</span> <span class="main">|||</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer_prover</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"stream_all2 <span class="free">A</span> <span class="free">u</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"stream_all2 <span class="free">B</span> <span class="main">(</span>smap snd <span class="main">(</span><span class="free">u</span> <span class="main">|||</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>smap snd <span class="main">(</span><span class="free">r</span> <span class="main">|||</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer_prover</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"stream_all2 <span class="free">B</span> <span class="free">v</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"stream_all2 <span class="free">A</span> <span class="free">u</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"stream_all2 <span class="free">B</span> <span class="free">v</span> <span class="free">s</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"stream_all2 <span class="main">(</span>rel_prod <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="free">u</span> <span class="main">|||</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="free">r</span> <span class="main">|||</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer_prover</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Sequence_Zip-szip_shift"><span class="command">lemma</span></span> szip_shift<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">u</span> <span class="main">=</span> length <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">@-</span> <span class="free">v</span> <span class="main">|||</span> <span class="free">s</span> <span class="main">@-</span> <span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="free">u</span> <span class="main">||</span> <span class="free">s</span><span class="main">)</span> <span class="main">@-</span> <span class="main">(</span><span class="free">v</span> <span class="main">|||</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_shift stake_shift sdrop_shift<span class="main">)</span>

  <span class="keyword1" id="Sequence_Zip-szip_sset_fst"><span class="command">lemma</span></span> szip_sset_fst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">`</span> sset <span class="main">(</span><span class="free">u</span> <span class="main">|||</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> sset <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> stream.set_map szip_smap_fst<span class="main">)</span>
  <span class="keyword1" id="Sequence_Zip-szip_sset_snd"><span class="command">lemma</span></span> szip_sset_snd<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">`</span> sset <span class="main">(</span><span class="free">u</span> <span class="main">|||</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> sset <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> stream.set_map szip_smap_snd<span class="main">)</span>
  <span class="keyword1" id="Sequence_Zip-szip_sset_elim"><span class="command">lemma</span></span> szip_sset_elim<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> sset <span class="main">(</span><span class="free">u</span> <span class="main">|||</span> <span class="free">v</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> sset <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> sset <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> image_eqI fst_conv snd_conv szip_sset_fst szip_sset_snd<span class="main">)</span>
  <span class="keyword1" id="Sequence_Zip-szip_sset"><span class="command">lemma</span></span> szip_sset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sset <span class="main">(</span><span class="free">u</span> <span class="main">|||</span> <span class="free">v</span><span class="main">)</span> <span class="main">⊆</span> sset <span class="free">u</span> <span class="main">×</span> sset <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Sequence_Zip-sset_szip_finite"><span class="command">lemma</span></span> sset_szip_finite<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>sset <span class="main">(</span><span class="free">u</span> <span class="main">|||</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> finite <span class="main">(</span>sset <span class="free">u</span><span class="main">)</span> <span class="main">∧</span> finite <span class="main">(</span>sset <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>sset <span class="main">(</span><span class="free">u</span> <span class="main">|||</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>fst <span class="main">`</span> sset <span class="main">(</span><span class="free">u</span> <span class="main">|||</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>snd <span class="main">`</span> sset <span class="main">(</span><span class="free">u</span> <span class="main">|||</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>sset <span class="free">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>sset <span class="free">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>sset <span class="free">u</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>sset <span class="free">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sset <span class="main">(</span><span class="free">u</span> <span class="main">|||</span> <span class="free">v</span><span class="main">)</span> <span class="main">⊆</span> sset <span class="free">u</span> <span class="main">×</span> sset <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>sset <span class="main">(</span><span class="free">u</span> <span class="main">|||</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Sequence_Zip-infs_szip_fst"><span class="command">lemma</span></span> infs_szip_fst<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span><span class="free">P</span> <span class="main">∘</span> fst<span class="main">)</span> <span class="main">(</span><span class="free">u</span> <span class="main">|||</span> <span class="free">v</span><span class="main">)</span> <span class="main">⟷</span> infs <span class="free">P</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span><span class="free">P</span> <span class="main">∘</span> fst<span class="main">)</span> <span class="main">(</span><span class="free">u</span> <span class="main">|||</span> <span class="free">v</span><span class="main">)</span> <span class="main">⟷</span> infs <span class="free">P</span> <span class="main">(</span>smap fst <span class="main">(</span><span class="free">u</span> <span class="main">|||</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> szip_smap_fst<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> infs <span class="free">P</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="Sequence_Zip-infs_szip_snd"><span class="command">lemma</span></span> infs_szip_snd<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span><span class="free">P</span> <span class="main">∘</span> snd<span class="main">)</span> <span class="main">(</span><span class="free">u</span> <span class="main">|||</span> <span class="free">v</span><span class="main">)</span> <span class="main">⟷</span> infs <span class="free">P</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span><span class="free">P</span> <span class="main">∘</span> snd<span class="main">)</span> <span class="main">(</span><span class="free">u</span> <span class="main">|||</span> <span class="free">v</span><span class="main">)</span> <span class="main">⟷</span> infs <span class="free">P</span> <span class="main">(</span>smap snd <span class="main">(</span><span class="free">u</span> <span class="main">|||</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> szip_smap_snd<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> infs <span class="free">P</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Maps">
<div class="head">
<h1>Theory Maps</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Maps›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Maps
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Sequence_Zip.html">Sequence_Zip</a>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Basics›</span></span>

  <span class="keyword1" id="Maps-fun_upd_None"><span class="command">lemma</span></span> fun_upd_None<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∉</span> dom <span class="free">f</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="free">p</span> <span class="main">:=</span> None<span class="main">)</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="comment1">(* TODO: this is a strictly stronger version of finite_set_of_finite_maps, move to library *)</span>
  <span class="keyword1" id="Maps-finite_set_of_finite_maps'"><span class="command">lemma</span></span> finite_set_of_finite_maps'<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">B</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">m</span><span class="main">.</span> dom <span class="bound">m</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">∧</span> ran <span class="bound">m</span> <span class="main">⊆</span> <span class="free">B</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">m</span><span class="main">.</span> dom <span class="bound">m</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">∧</span> ran <span class="bound">m</span> <span class="main">⊆</span> <span class="free">B</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">𝒜</span> <span class="main">∈</span> Pow <span class="free">A</span><span class="main">.</span> <span class="main">{</span><span class="bound">m</span><span class="main">.</span> dom <span class="bound">m</span> <span class="main">=</span> <span class="bound">𝒜</span> <span class="main">∧</span> ran <span class="bound">m</span> <span class="main">⊆</span> <span class="free">B</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> finite_subset assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_set_of_finite_maps<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Maps-fold_map_of"><span class="command">lemma</span></span> fold_map_of<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fold <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">,</span> <span class="bound">m</span> <span class="main">(</span><span class="bound">x</span> <span class="main">↦</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="free">k</span> <span class="main">+</span> length <span class="free">xs</span><span class="main">,</span> <span class="free">m</span> <span class="main">++</span> map_of <span class="main">(</span><span class="free">xs</span> <span class="main">||</span> <span class="main">[</span><span class="free">k</span> <span class="main">..&lt;</span> <span class="free">k</span> <span class="main">+</span> length <span class="free">xs</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fold <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">,</span> <span class="bound">m</span> <span class="main">(</span><span class="bound">x</span> <span class="main">↦</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">k</span><span class="main">,</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span>Suc <span class="skolem">k</span> <span class="main">+</span> length <span class="skolem">xs</span><span class="main">,</span> <span class="main">(</span><span class="skolem">m</span> <span class="main">++</span> map_of <span class="main">(</span><span class="skolem">xs</span> <span class="main">||</span> <span class="main">[</span>Suc <span class="skolem">k</span> <span class="main">..&lt;</span> Suc <span class="skolem">k</span> <span class="main">+</span> length <span class="skolem">xs</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_add_upd_left<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> length <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">,</span> <span class="skolem">m</span> <span class="main">++</span> map_of <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">||</span> <span class="main">[</span><span class="skolem">k</span> <span class="main">..&lt;</span> <span class="skolem">k</span> <span class="main">+</span> length <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> upt_rec<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Expanding set functions to sets of functions›</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">expand</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">expand</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">g</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">g</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">}</span>"</span></span>

  <span class="keyword1" id="Maps-expand_update"><span class="command">lemma</span></span> expand_update<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"expand <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> expand <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> expand_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> equalityI subsetI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">g</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">g</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">g</span> <span class="bound">y</span> <span class="main">∈</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">y</span><span class="main">.</span> <span class="free">x</span> <span class="main">≠</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="skolem">g</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">f</span> <span class="bound">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">f</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound">g</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">g</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">f</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> UN_I image_eqI<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">g</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">g</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">f</span> <span class="bound">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">=</span> <span class="skolem">g</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="skolem">y</span><span class="main">,</span> <span class="free">x</span> <span class="main">:=</span> <span class="skolem">g</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">g</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound">g</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">g</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">f</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">g</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">g</span> <span class="bound">y</span> <span class="main">∈</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="bound">y</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Expanding set maps into sets of maps›</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">expand_map</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇀</span> <span class="tfree">'b</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇀</span> <span class="tfree">'b</span><span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">expand_map</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> expand <span class="main">(</span>case_option <span class="main">{</span>None<span class="main">}</span> <span class="main">(</span>image Some<span class="main">)</span> <span class="main">∘</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="Maps-expand_map_alt_def"><span class="command">lemma</span></span> expand_map_alt_def<span class="main">:</span> <span class="quoted"><span class="quoted">"expand_map <span class="free">f</span> <span class="main">=</span>
    <span class="main">{</span><span class="bound">g</span><span class="main">.</span> dom <span class="bound">g</span> <span class="main">=</span> dom <span class="free">f</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="bound">S</span> <span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">S</span> <span class="main">⟶</span> <span class="bound">g</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">y</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">∈</span> <span class="bound">S</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> expand_map_def expand_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span> <span class="main">(</span><span class="operator">force</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

  <span class="keyword1" id="Maps-expand_map_dom"><span class="command">lemma</span></span> expand_map_dom<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> expand_map <span class="free">f</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dom <span class="free">g</span> <span class="main">=</span> dom <span class="free">f</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> expand_map_def expand_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

  <span class="keyword1" id="Maps-expand_map_empty"><span class="command">lemma</span></span> expand_map_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"expand_map Map.empty <span class="main">=</span> <span class="main">{</span>Map.empty<span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> expand_map_def expand_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="Maps-expand_map_update"><span class="command">lemma</span></span> expand_map_update<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"expand_map <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">x</span> <span class="main">↦</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">(</span><span class="free">x</span> <span class="main">↦</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> expand_map <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"case_option <span class="main">{</span>None<span class="main">}</span> <span class="main">(</span>image Some<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="var">?m</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="main">{</span>None<span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"expand_map <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> Some <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> expand_map <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> None<span class="main">,</span> <span class="free">x</span> <span class="main">:=</span> Some <span class="free">S</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> expand <span class="main">(</span><span class="main">(</span><span class="var">?m</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="main">{</span>None<span class="main">}</span><span class="main">,</span> <span class="free">x</span> <span class="main">:=</span> <span class="var">?m</span> <span class="main">(</span>Some <span class="free">S</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> expand_map_def fun_upd_comp <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">y</span> <span class="main">∈</span> <span class="var">?m</span> <span class="main">(</span>Some <span class="free">S</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> expand <span class="main">(</span><span class="main">(</span><span class="var">?m</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="main">{</span>None<span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> expand_update 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">(</span><span class="free">x</span> <span class="main">↦</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> expand_map <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">x</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> expand_map_def fun_upd_comp <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Acceptance">
<div class="head">
<h1>Theory Acceptance</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Acceptance
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Sequence_LTL.html">Sequence_LTL</a>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> pred <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> rabin <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> pred <span class="main">×</span> <span class="tfree">'a</span> pred"</span></span>
  <span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> gen <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">rabin</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rabin <span class="main">⇒</span> <span class="tfree">'a</span> stream pred"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">rabin</span> <span class="main">≡</span> <span class="main">λ</span> <span class="main">(</span><span class="bound">I</span><span class="main">,</span> <span class="bound">F</span><span class="main">)</span> <span class="bound">w</span><span class="main">.</span> infs <span class="bound">I</span> <span class="bound">w</span> <span class="main">∧</span> fins <span class="bound">F</span> <span class="bound">w</span>"</span></span>

  <span class="keyword1" id="Acceptance-rabin"><span class="command">lemma</span></span> rabin<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">IF</span> <span class="main">=</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="free">F</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"infs <span class="free">I</span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"fins <span class="free">F</span> <span class="free">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rabin <span class="free">IF</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> rabin_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="Acceptance-rabin_elim"><span class="command">lemma</span></span> rabin_elim<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rabin <span class="free">IF</span> <span class="free">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">I</span> <span class="free">F</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">IF</span> <span class="main">=</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="free">F</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"infs <span class="free">I</span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"fins <span class="free">F</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> rabin_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">gen</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> pred<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> gen <span class="main">⇒</span> <span class="tfree">'b</span> pred<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">gen</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">c</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span>"</span></span>

  <span class="keyword1" id="Acceptance-gen"><span class="command">lemma</span></span> gen<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> set <span class="free">cs</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">c</span> <span class="free">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gen <span class="free">P</span> <span class="free">cs</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> gen_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="Acceptance-gen_elim"><span class="command">lemma</span></span> gen_elim<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"gen <span class="free">P</span> <span class="free">cs</span> <span class="free">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> set <span class="free">cs</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">c</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> gen_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">cogen</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> pred<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> gen <span class="main">⇒</span> <span class="tfree">'b</span> pred<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">cogen</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">≡</span> <span class="main">∃</span> <span class="bound">c</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">c</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span>"</span></span>

  <span class="keyword1" id="Acceptance-cogen"><span class="command">lemma</span></span> cogen<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> set <span class="free">cs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">c</span> <span class="free">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cogen <span class="free">P</span> <span class="free">cs</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> cogen_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="Acceptance-cogen_elim"><span class="command">lemma</span></span> cogen_elim<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cogen <span class="free">P</span> <span class="free">cs</span> <span class="free">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">c</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> set <span class="free">cs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">c</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> cogen_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Acceptance-cogen_alt_def"><span class="command">lemma</span></span> cogen_alt_def<span class="main">:</span> <span class="quoted"><span class="quoted">"cogen <span class="free">P</span> <span class="free">cs</span> <span class="free">w</span> <span class="main">⟷</span> <span class="main">¬</span> gen <span class="main">(</span><span class="main">λ</span> <span class="bound">c</span> <span class="bound">w</span><span class="main">.</span> Not <span class="main">(</span><span class="free">P</span> <span class="bound">c</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span> <span class="free">cs</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Degeneralization">
<div class="head">
<h1>Theory Degeneralization</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Degeneralization
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Acceptance.html">Acceptance</a>
  <a href="Sequence_Zip.html">Sequence_Zip</a>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> degen <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">×</span> nat"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">degen</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> pred gen <span class="main">⇒</span> <span class="tfree">'a</span> degen pred"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">degen</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">≡</span> <span class="main">λ</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">k</span><span class="main">)</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≥</span> length <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">∨</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="bound">a</span>"</span></span>

  <span class="keyword1" id="Degeneralization-degen_simps"><span class="command">lemma</span></span> degen_simps<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"degen <span class="free">cs</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">k</span> <span class="main">≥</span> length <span class="free">cs</span> <span class="main">∨</span> <span class="main">(</span><span class="free">cs</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> degen_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">count</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> pred gen <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">count</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">≡</span>
      <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">cs</span></span></span>
      <span class="keyword1">then</span> <span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">then</span> Suc <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">mod</span> length <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">else</span> <span class="main">0</span>"</span></span>

  <span class="keyword1" id="Degeneralization-count_empty"><span class="command">lemma</span></span> count_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="main">[]</span> <span class="free">a</span> <span class="free">k</span> <span class="main">=</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> count_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1" id="Degeneralization-count_nonempty"><span class="command">lemma</span></span> count_nonempty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> count <span class="free">cs</span> <span class="free">a</span> <span class="free">k</span> <span class="main">&lt;</span> length <span class="free">cs</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> count_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1" id="Degeneralization-count_constant_1"><span class="command">lemma</span></span> count_constant_1<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> length <span class="free">cs</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="free">w</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="main">(</span><span class="free">cs</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> <span class="bound">a</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fold <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="free">w</span> <span class="free">k</span> <span class="main">=</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> count_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1" id="Degeneralization-count_constant_2"><span class="command">lemma</span></span> count_constant_2<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> length <span class="free">cs</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">w</span> <span class="main">||</span> <span class="free">k</span> <span class="main">#</span> scan <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="free">w</span> <span class="free">k</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">¬</span> degen <span class="free">cs</span> <span class="bound">a</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fold <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="free">w</span> <span class="free">k</span> <span class="main">=</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> count_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1" id="Degeneralization-count_step"><span class="command">lemma</span></span> count_step<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> length <span class="free">cs</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cs</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> <span class="free">a</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"count <span class="free">cs</span> <span class="free">a</span> <span class="free">k</span> <span class="main">=</span> Suc <span class="free">k</span> <span class="keyword1">mod</span> length <span class="free">cs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> count_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1" id="Degeneralization-degen_skip_condition"><span class="command">lemma</span></span> degen_skip_condition<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> length <span class="free">cs</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span>degen <span class="free">cs</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> <span class="free">k</span> <span class="main">##</span> sscan <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="free">w</span> <span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">u</span> <span class="free">a</span> <span class="free">v</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="free">u</span> <span class="main">@-</span> <span class="free">a</span> <span class="main">##</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"fold <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="free">u</span> <span class="free">k</span> <span class="main">=</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cs</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"Collect <span class="main">(</span>degen <span class="free">cs</span><span class="main">)</span> <span class="main">∩</span> sset <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> <span class="free">k</span> <span class="main">##</span> sscan <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="free">w</span> <span class="free">k</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> infs_any assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">|||</span> <span class="free">k</span> <span class="main">##</span> sscan <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="free">w</span> <span class="free">k</span> <span class="main">=</span> <span class="skolem">ys</span> <span class="main">@-</span> <span class="skolem">x</span> <span class="main">##</span> <span class="skolem">zs</span>"</span></span>
      <span class="quoted"><span class="quoted">"Collect <span class="main">(</span>degen <span class="free">cs</span><span class="main">)</span> <span class="main">∩</span> set <span class="skolem">ys</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> Collect <span class="main">(</span>degen <span class="free">cs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> split_stream_first 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">≡</span> stake <span class="main">(</span>length <span class="skolem">ys</span><span class="main">)</span> <span class="free">w</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≡</span> <span class="free">w</span> <span class="main">!!</span> length <span class="skolem">ys</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">≡</span> sdrop <span class="main">(</span>Suc <span class="main">(</span>length <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> stake <span class="main">(</span>length <span class="skolem">ys</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> <span class="free">k</span> <span class="main">##</span> sscan <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="free">w</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> shift_eq 2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> stake <span class="main">(</span>length <span class="skolem">ys</span><span class="main">)</span> <span class="free">w</span> <span class="main">||</span> stake <span class="main">(</span>length <span class="skolem">ys</span><span class="main">)</span> <span class="main">(</span><span class="free">k</span> <span class="main">##</span> sscan <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="free">w</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> take <span class="main">(</span>length <span class="skolem">ys</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">||</span> take <span class="main">(</span>length <span class="skolem">ys</span><span class="main">)</span> <span class="main">(</span><span class="free">k</span> <span class="main">#</span> scan <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="skolem">u</span> <span class="free">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> u_def
      <span class="keyword1"><span class="command">using</span></span> append_eq_conv_conj length_stake length_zip stream.sel
      <span class="keyword1"><span class="command">using</span></span> sscan_stake stake.simps<span class="main">(</span>2<span class="main">)</span> stake_Suc stake_szip take_stake
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> take <span class="main">(</span>length <span class="skolem">ys</span><span class="main">)</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">||</span> <span class="free">k</span> <span class="main">#</span> scan <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="skolem">u</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> take_zip <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">||</span> <span class="free">k</span> <span class="main">#</span> scan <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="skolem">u</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> u_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">||</span> <span class="free">k</span> <span class="main">#</span> scan <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="skolem">u</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> <span class="free">k</span> <span class="main">##</span> sscan <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="free">w</span> <span class="free">k</span><span class="main">)</span> <span class="main">!!</span> length <span class="skolem">ys</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="free">w</span> <span class="main">!!</span> length <span class="skolem">ys</span><span class="main">,</span> <span class="main">(</span><span class="free">k</span> <span class="main">##</span> sscan <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="free">w</span> <span class="free">k</span><span class="main">)</span> <span class="main">!!</span> length <span class="skolem">ys</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> fold <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="skolem">u</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> u_def a_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> fold <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="skolem">u</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"fold <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="skolem">u</span> <span class="free">k</span> <span class="main">=</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> count_constant_2 assms<span class="main">(</span>1<span class="main">)</span> 2<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">@-</span> <span class="skolem">a</span> <span class="main">##</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> u_def a_def v_def <span class="keyword1"><span class="command">using</span></span> id_stake_snth_sdrop <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fold <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="skolem">u</span> <span class="free">k</span> <span class="main">=</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cs</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> 2<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> 4 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="Degeneralization-degen_skip_arbitrary"><span class="command">lemma</span></span> degen_skip_arbitrary<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> length <span class="free">cs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">&lt;</span> length <span class="free">cs</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span>degen <span class="free">cs</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> <span class="free">k</span> <span class="main">##</span> sscan <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="free">w</span> <span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">u</span> <span class="free">v</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="free">u</span> <span class="main">@-</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"fold <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="free">u</span> <span class="free">k</span> <span class="main">=</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"nat <span class="main">(</span><span class="main">(</span>int <span class="free">l</span> <span class="main">-</span> int <span class="free">k</span><span class="main">)</span> <span class="keyword1">mod</span> length <span class="free">cs</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">thesis</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>0<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">cs</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>int <span class="skolem">l</span> <span class="main">-</span> int <span class="free">k</span><span class="main">)</span> <span class="keyword1">mod</span> length <span class="free">cs</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0<span class="main">(</span>1<span class="main">)</span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> antisym<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"int <span class="skolem">l</span> <span class="keyword1">mod</span> length <span class="free">cs</span> <span class="main">=</span> int <span class="free">k</span> <span class="keyword1">mod</span> length <span class="free">cs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mod_eq_dvd_iff 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0<span class="main">(</span>3<span class="main">,</span> 4<span class="main">)</span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> 0<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">@-</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fold <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="main">[]</span> <span class="free">k</span> <span class="main">=</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">cs</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">=</span> nat <span class="main">(</span><span class="main">(</span>int <span class="skolem">l</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">mod</span> length <span class="free">cs</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">@-</span> <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="quoted">"fold <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="skolem">u</span> <span class="free">k</span> <span class="main">=</span> <span class="skolem">l'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Suc<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span> <span class="main">&lt;</span> length <span class="free">cs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nat_less_iff Suc<span class="main">(</span>2<span class="main">)</span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> nat <span class="main">(</span>int <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"int <span class="skolem">n</span> <span class="main">=</span> <span class="main">(</span>int <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">mod</span> length <span class="free">cs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>int <span class="skolem">l</span> <span class="main">-</span> int <span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">mod</span> length <span class="free">cs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">mod_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>int <span class="skolem">l</span> <span class="main">-</span> <span class="main">1</span> <span class="main">-</span> int <span class="free">k</span><span class="main">)</span> <span class="keyword1">mod</span> length <span class="free">cs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>int <span class="skolem">l'</span> <span class="main">-</span> int <span class="free">k</span><span class="main">)</span> <span class="keyword1">mod</span> length <span class="free">cs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l'_def 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">mod_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> nat <span class="main">(</span><span class="main">(</span>int <span class="skolem">l'</span> <span class="main">-</span> int <span class="free">k</span><span class="main">)</span> <span class="keyword1">mod</span> length <span class="free">cs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> length <span class="free">cs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">&lt;</span> length <span class="free">cs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nat_less_iff l'_def 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span>degen <span class="free">cs</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> <span class="free">k</span> <span class="main">##</span> sscan <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="free">w</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">&lt;</span> length <span class="free">cs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nat_less_iff l'_def 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">|||</span> <span class="skolem">l'</span> <span class="main">##</span> sscan <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="skolem">v</span> <span class="skolem">l'</span> <span class="main">=</span> sdrop <span class="main">(</span>length <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> <span class="free">k</span> <span class="main">##</span> sscan <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="free">w</span> <span class="free">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 2 eq_scons eq_shift
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sdrop.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> sdrop_simps sdrop_szip sscan_scons_snth sscan_sdrop stream.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span>degen <span class="free">cs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">v</span> <span class="main">|||</span> <span class="skolem">l'</span> <span class="main">##</span> sscan <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="skolem">v</span> <span class="skolem">l'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">vu</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">vv</span></span> <span class="keyword2"><span class="keyword">where</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="skolem">vu</span> <span class="main">@-</span> <span class="skolem">a</span> <span class="main">##</span> <span class="skolem">vv</span>"</span></span> <span class="quoted"><span class="quoted">"fold <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="skolem">vu</span> <span class="skolem">l'</span> <span class="main">=</span> <span class="skolem">l'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cs</span> <span class="main">!</span> <span class="skolem">l'</span><span class="main">)</span> <span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> degen_skip_condition 3 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> nat <span class="main">(</span>int <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"int <span class="skolem">l</span> <span class="main">=</span> int <span class="skolem">l</span> <span class="keyword1">mod</span> length <span class="free">cs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> int <span class="main">(</span>Suc <span class="skolem">l'</span><span class="main">)</span> <span class="keyword1">mod</span> length <span class="free">cs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l'_def 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">mod_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 7<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> Suc <span class="skolem">l'</span> <span class="keyword1">mod</span> length <span class="free">cs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nat_mod_as_int <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Suc<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="skolem">vu</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">@-</span> <span class="skolem">vv</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 2<span class="main">(</span>1<span class="main">)</span> 6<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fold <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="skolem">vu</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>2<span class="main">)</span> 3 6<span class="main">(</span>2<span class="main">,</span> 3<span class="main">)</span> 7 count_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="Degeneralization-degen_skip_arbitrary_condition"><span class="command">lemma</span></span> degen_skip_arbitrary_condition<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">&lt;</span> length <span class="free">cs</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span>degen <span class="free">cs</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> <span class="free">k</span> <span class="main">##</span> sscan <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="free">w</span> <span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">u</span> <span class="free">a</span> <span class="free">v</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="free">u</span> <span class="main">@-</span> <span class="free">a</span> <span class="main">##</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"fold <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="free">u</span> <span class="free">k</span> <span class="main">=</span> <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cs</span> <span class="main">!</span> <span class="free">l</span><span class="main">)</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="free">cs</span> <span class="main">(</span>shd <span class="free">w</span><span class="main">)</span> <span class="free">k</span> <span class="main">&lt;</span> length <span class="free">cs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span>degen <span class="free">cs</span><span class="main">)</span> <span class="main">(</span>stl <span class="free">w</span> <span class="main">|||</span> count <span class="free">cs</span> <span class="main">(</span>shd <span class="free">w</span><span class="main">)</span> <span class="free">k</span> <span class="main">##</span> sscan <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="main">(</span>stl <span class="free">w</span><span class="main">)</span> <span class="main">(</span>count <span class="free">cs</span> <span class="main">(</span>shd <span class="free">w</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> alw.cases sscan.code stream.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> szip.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"stl <span class="free">w</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">@-</span> <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="quoted">"fold <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="skolem">u</span> <span class="main">(</span>count <span class="free">cs</span> <span class="main">(</span>shd <span class="free">w</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">l</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> degen_skip_arbitrary 1 assms<span class="main">(</span>1<span class="main">)</span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">|||</span> <span class="free">l</span> <span class="main">##</span> sscan <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="skolem">v</span> <span class="free">l</span> <span class="main">=</span>
      sdrop <span class="main">(</span>length <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span>stl <span class="free">w</span> <span class="main">|||</span> count <span class="free">cs</span> <span class="main">(</span>shd <span class="free">w</span><span class="main">)</span> <span class="free">k</span> <span class="main">##</span> sscan <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="main">(</span>stl <span class="free">w</span><span class="main">)</span> <span class="main">(</span>count <span class="free">cs</span> <span class="main">(</span>shd <span class="free">w</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 3 eq_scons eq_shift
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sdrop.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> sdrop_simps sdrop_szip sscan_scons_snth sscan_sdrop stream.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span>degen <span class="free">cs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">v</span> <span class="main">|||</span> <span class="free">l</span> <span class="main">##</span> sscan <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="skolem">v</span> <span class="free">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">unfolding</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">vu</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">vv</span></span> <span class="keyword2"><span class="keyword">where</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="skolem">vu</span> <span class="main">@-</span> <span class="skolem">a</span> <span class="main">##</span> <span class="skolem">vv</span>"</span></span> <span class="quoted"><span class="quoted">"fold <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="skolem">vu</span> <span class="free">l</span> <span class="main">=</span> <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cs</span> <span class="main">!</span> <span class="free">l</span><span class="main">)</span> <span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> degen_skip_condition assms<span class="main">(</span>1<span class="main">)</span> 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="main">(</span>shd <span class="free">w</span> <span class="main">#</span> <span class="skolem">u</span> <span class="main">@</span> <span class="skolem">vu</span><span class="main">)</span> <span class="main">@-</span> <span class="skolem">a</span> <span class="main">##</span> <span class="skolem">vv</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>1<span class="main">)</span> 6<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_scons<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fold <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="main">(</span>shd <span class="free">w</span> <span class="main">#</span> <span class="skolem">u</span> <span class="main">@</span> <span class="skolem">vu</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>2<span class="main">)</span> 6<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cs</span> <span class="main">!</span> <span class="free">l</span><span class="main">)</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 6<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="Degeneralization-gen_degen_step"><span class="command">lemma</span></span> gen_degen_step<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"gen infs <span class="free">cs</span> <span class="free">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">u</span> <span class="free">a</span> <span class="free">v</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="free">u</span> <span class="main">@-</span> <span class="free">a</span> <span class="main">##</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"degen <span class="free">cs</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> fold <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="free">u</span> <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> length <span class="free">cs</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span><span class="free">cs</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="free">cs</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> <span class="bound">a</span><span class="main">}</span> <span class="main">∩</span> sset <span class="free">w</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> infs_any 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">@-</span> <span class="skolem">a</span> <span class="main">##</span> <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="free">cs</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> <span class="bound">a</span><span class="main">}</span> <span class="main">∩</span> set <span class="skolem">u</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="free">cs</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> <span class="bound">a</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> split_stream_first 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"fold <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="skolem">u</span> <span class="free">k</span> <span class="main">=</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> count_constant_1 True 3<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>1<span class="main">,</span> 3<span class="main">)</span> 4 that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">@-</span> shd <span class="free">w</span> <span class="main">##</span> stl <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"degen <span class="free">cs</span> <span class="main">(</span>shd <span class="free">w</span><span class="main">,</span> fold <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="main">[]</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Degeneralization-degen_infs"><span class="command">lemma</span></span> degen_infs<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span>degen <span class="free">cs</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> <span class="free">k</span> <span class="main">##</span> sscan <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="free">w</span> <span class="free">k</span><span class="main">)</span> <span class="main">⟷</span> gen infs <span class="free">cs</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"gen infs <span class="free">cs</span> <span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span>degen <span class="free">cs</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> <span class="free">k</span> <span class="main">##</span> sscan <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="free">w</span> <span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> set <span class="free">cs</span>"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="free">cs</span> <span class="main">!</span> <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">&lt;</span> length <span class="free">cs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> in_set_conv_nth 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"infs <span class="skolem">c</span> <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> 2<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infs_coinduct_shift<span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>infs <span class="skolem">w</span> <span class="skolem">k</span><span class="main">)</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">@-</span> <span class="skolem">a</span> <span class="main">##</span> <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cs</span> <span class="main">!</span> <span class="skolem">l</span><span class="main">)</span> <span class="skolem">a</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> degen_skip_arbitrary_condition 2<span class="main">(</span>2<span class="main">)</span> infs <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?k</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fold <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="skolem">u</span> <span class="skolem">k</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fold <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="skolem">k</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">##</span> <span class="skolem">v</span> <span class="main">|||</span> <span class="var">?k</span> <span class="main">##</span> sscan <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">##</span> <span class="skolem">v</span><span class="main">)</span> <span class="var">?k</span> <span class="main">=</span>
          sdrop <span class="main">(</span>length <span class="skolem">u</span><span class="main">)</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">k</span> <span class="main">##</span> sscan <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="skolem">w</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>1<span class="main">)</span> eq_shift scons_eq
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sdrop_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> sdrop_stl sdrop_szip sscan_scons_snth sscan_sdrop stream.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span>degen <span class="free">cs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">##</span> <span class="skolem">v</span> <span class="main">|||</span> <span class="var">?k</span> <span class="main">##</span> sscan <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">##</span> <span class="skolem">v</span><span class="main">)</span> <span class="var">?k</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> infs <span class="keyword1"><span class="command">unfolding</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI bexI<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">@-</span> <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cs</span> <span class="main">!</span> <span class="skolem">l</span><span class="main">)</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span>degen <span class="free">cs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">v</span> <span class="main">|||</span> <span class="var">?l</span> <span class="main">##</span> sscan <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="skolem">v</span> <span class="var">?l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span>degen <span class="free">cs</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> <span class="free">k</span> <span class="main">##</span> sscan <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="free">w</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"gen infs <span class="free">cs</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infs_coinduct_shift<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>infs <span class="skolem">w</span> <span class="skolem">k</span><span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">@-</span> <span class="skolem">a</span> <span class="main">##</span> <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="quoted">"degen <span class="free">cs</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> fold <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="skolem">u</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> gen_degen_step infs <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?u</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">||</span> <span class="skolem">k</span> <span class="main">#</span> scan <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="skolem">u</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fold <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI bexI<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">k</span> <span class="main">##</span> sscan <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="skolem">w</span> <span class="skolem">k</span> <span class="main">=</span>
          <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">@-</span> <span class="skolem">v</span> <span class="main">|||</span> <span class="skolem">k</span> <span class="main">##</span> scan <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="skolem">u</span> <span class="skolem">k</span> <span class="main">@-</span> <span class="var">?l</span> <span class="main">##</span> sscan <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="skolem">v</span> <span class="var">?l</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> 1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?u</span> <span class="main">@-</span> <span class="main">(</span><span class="skolem">v</span> <span class="main">|||</span> <span class="var">?l</span> <span class="main">##</span> sscan <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="skolem">v</span> <span class="var">?l</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_Cons length_append_singleton scan_length shift.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> szip_shift<span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">k</span> <span class="main">##</span> sscan <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="skolem">w</span> <span class="skolem">k</span> <span class="main">=</span> <span class="var">?u</span> <span class="main">@-</span> <span class="main">(</span><span class="skolem">v</span> <span class="main">|||</span> <span class="var">?l</span> <span class="main">##</span> sscan <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="skolem">v</span> <span class="var">?l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"degen <span class="free">cs</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> fold <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="skolem">u</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> fold <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="skolem">u</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>last <span class="main">(</span><span class="skolem">u</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> last <span class="main">(</span><span class="skolem">k</span> <span class="main">#</span> scan <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="skolem">u</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> scan_last <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> last <span class="var">?u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zip_eq_Nil_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">∈</span> set <span class="var">?u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> last_in_set <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zip_eq_Nil_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> fold <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="skolem">u</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">∈</span> set <span class="var">?u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">|||</span> <span class="var">?l</span> <span class="main">##</span> sscan <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="skolem">v</span> <span class="var">?l</span> <span class="main">=</span> <span class="skolem">v</span> <span class="main">|||</span> <span class="var">?l</span> <span class="main">##</span> sscan <span class="main">(</span>count <span class="free">cs</span><span class="main">)</span> <span class="skolem">v</span> <span class="var">?l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"gen infs <span class="free">cs</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> infs <span class="keyword1"><span class="command">unfolding</span></span> 1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Transition_System">
<div class="head">
<h1>Theory Transition_System</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Transition Systems›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Transition_System
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Sequence.html">../Basic/Sequence</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Universal Transition Systems›</span></span>

  <span class="keyword1"><span class="command">locale</span></span> transition_system_universal <span class="main">=</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">execute</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'transition</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span>"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">target</span> <span class="main">≡</span> fold <span class="free">execute</span>"</span></span>
    <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">states</span> <span class="main">≡</span> scan <span class="free">execute</span>"</span></span>
    <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">trace</span> <span class="main">≡</span> sscan <span class="free">execute</span>"</span></span>

    <span class="keyword1" id="Transition_System-target_alt_def"><span class="command">lemma</span></span> target_alt_def<span class="main">:</span> <span class="quoted"><span class="quoted">"target <span class="free">r</span> <span class="free">p</span> <span class="main">=</span> last <span class="main">(</span><span class="free">p</span> <span class="main">#</span> states <span class="free">r</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> scan_last <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Transition Systems›</span></span>

  <span class="keyword1"><span class="command">locale</span></span> transition_system <span class="main">=</span>
    transition_system_universal <span class="quoted"><span class="free">execute</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">execute</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'transition</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span>"</span></span>
    <span class="main">+</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">enabled</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'transition</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">successors</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="free">execute</span> <span class="bound">a</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">|</span><span class="bound">a</span><span class="main">.</span> <span class="free">enabled</span> <span class="bound">a</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">}</span>"</span></span>

    <span class="keyword1"><span class="command">inductive</span></span> <span class="entity">path</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'transition</span> list <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      nil<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">path</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span> <span class="main">|</span>
      cons<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">enabled</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">⟹</span> <span class="free">path</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="free">execute</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">path</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>

    <span class="keyword1"><span class="command">inductive_cases</span></span> path_cons_elim<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">r</span><span class="main">)</span> <span class="free">p</span>"</span></span>

    <span class="keyword1" id="Transition_System-path_append"><span class="command">lemma</span></span> path_append<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"path <span class="free">r</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"path <span class="free">s</span> <span class="main">(</span>target <span class="free">r</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"path <span class="main">(</span><span class="free">r</span> <span class="main">@</span> <span class="free">s</span><span class="main">)</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1" id="Transition_System-path_append_elim"><span class="command">lemma</span></span> path_append_elim<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"path <span class="main">(</span><span class="free">r</span> <span class="main">@</span> <span class="free">s</span><span class="main">)</span> <span class="free">p</span>"</span></span>
      <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"path <span class="free">r</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"path <span class="free">s</span> <span class="main">(</span>target <span class="free">r</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

    <span class="keyword1"><span class="command">coinductive</span></span> <span class="entity">run</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'transition</span> stream <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      scons<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">enabled</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">⟹</span> <span class="free">run</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="free">execute</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">run</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">##</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>

    <span class="keyword1"><span class="command">inductive_cases</span></span> run_scons_elim<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"run <span class="main">(</span><span class="free">a</span> <span class="main">##</span> <span class="free">r</span><span class="main">)</span> <span class="free">p</span>"</span></span>

    <span class="keyword1" id="Transition_System-run_shift"><span class="command">lemma</span></span> run_shift<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"path <span class="free">r</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"run <span class="free">s</span> <span class="main">(</span>target <span class="free">r</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"run <span class="main">(</span><span class="free">r</span> <span class="main">@-</span> <span class="free">s</span><span class="main">)</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1" id="Transition_System-run_shift_elim"><span class="command">lemma</span></span> run_shift_elim<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"run <span class="main">(</span><span class="free">r</span> <span class="main">@-</span> <span class="free">s</span><span class="main">)</span> <span class="free">p</span>"</span></span>
      <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"path <span class="free">r</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"run <span class="free">s</span> <span class="main">(</span>target <span class="free">r</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

    <span class="keyword1" id="Transition_System-run_coinduct"><span class="command">lemma</span></span> run_coinduct<span class="main">[</span><span class="operator">case_names</span> run<span class="main">,</span> <span class="operator">coinduct</span> <span class="quasi_keyword"><span class="quasi_keyword">pred</span></span><span class="main"><span class="main"><span class="main">:</span></span></span> run<span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">r</span> <span class="free">p</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> <span class="free">R</span> <span class="main">(</span><span class="bound">a</span> <span class="main">##</span> <span class="bound">r</span><span class="main">)</span> <span class="bound">p</span> <span class="main">⟹</span> <span class="free">enabled</span> <span class="bound">a</span> <span class="bound">p</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">r</span> <span class="main">(</span><span class="free">execute</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"run <span class="free">r</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> stream.collapse run.coinduct assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1" id="Transition_System-run_coinduct_shift"><span class="command">lemma</span></span> run_coinduct_shift<span class="main">[</span><span class="operator">case_names</span> run<span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">r</span> <span class="free">p</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> <span class="free">R</span> <span class="bound">r</span> <span class="bound">p</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">r</span> <span class="main">=</span> <span class="bound">s</span> <span class="main">@-</span> <span class="bound">t</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> path <span class="bound">s</span> <span class="bound">p</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">t</span> <span class="main">(</span>target <span class="bound">s</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"run <span class="free">r</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="free">r</span> <span class="main">=</span> <span class="bound">s</span> <span class="main">@-</span> <span class="bound">t</span> <span class="main">∧</span> path <span class="bound">s</span> <span class="free">p</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">t</span> <span class="main">(</span>target <span class="bound">s</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduct</span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> path.cases<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1" id="Transition_System-run_flat_coinduct"><span class="command">lemma</span></span> run_flat_coinduct<span class="main">[</span><span class="operator">case_names</span> run<span class="main">,</span> <span class="operator">consumes</span> 1<span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free">rs</span> <span class="free">p</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">r</span> <span class="bound">rs</span> <span class="bound">p</span><span class="main">.</span> <span class="free">R</span> <span class="main">(</span><span class="bound">r</span> <span class="main">##</span> <span class="bound">rs</span><span class="main">)</span> <span class="bound">p</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> path <span class="bound">r</span> <span class="bound">p</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">rs</span> <span class="main">(</span>target <span class="bound">r</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"run <span class="main">(</span>flat <span class="free">rs</span><span class="main">)</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">rs</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> run_coinduct_shift<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>run <span class="skolem">rs</span> <span class="skolem">p</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> stream.exhaust flat_Stream<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">reachable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> set"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">p</span> <span class="keyword2"><span class="keyword">where</span></span>
      reflexive<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="free">reachable</span> <span class="free">p</span>"</span></span> <span class="main">|</span>
      execute<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">∈</span> <span class="free">reachable</span> <span class="free">p</span> <span class="main">⟹</span> <span class="free">enabled</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">⟹</span> <span class="free">execute</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">∈</span> <span class="free">reachable</span> <span class="free">p</span>"</span></span>

    <span class="keyword1"><span class="command">inductive_cases</span></span> reachable_elim<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> reachable <span class="free">p</span>"</span></span>

    <span class="keyword1" id="Transition_System-reachable_execute'"><span class="command">lemma</span></span> reachable_execute'<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">enabled</span> <span class="free">a</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> reachable <span class="main">(</span><span class="free">execute</span> <span class="free">a</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> reachable <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span> 1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="operator">auto</span>
    <span class="keyword1" id="Transition_System-reachable_elim'"><span class="command">lemma</span></span> reachable_elim'<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> reachable <span class="free">p</span>"</span></span>
      <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="free">p</span>"</span></span> <span class="main">|</span> <span class="free">a</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">enabled</span> <span class="free">a</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> reachable <span class="main">(</span><span class="free">execute</span> <span class="free">a</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="operator">auto</span>

    <span class="keyword1" id="Transition_System-reachable_target"><span class="command">lemma</span></span> reachable_target<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> reachable <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"path <span class="free">r</span> <span class="free">q</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"target <span class="free">r</span> <span class="free">q</span> <span class="main">∈</span> reachable <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">q</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1" id="Transition_System-reachable_target_elim"><span class="command">lemma</span></span> reachable_target_elim<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> reachable <span class="free">p</span>"</span></span>
      <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">r</span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"path <span class="free">r</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> target <span class="free">r</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>

    <span class="keyword1" id="Transition_System-reachable_alt_def"><span class="command">lemma</span></span> reachable_alt_def<span class="main">:</span> <span class="quoted"><span class="quoted">"reachable <span class="free">p</span> <span class="main">=</span> <span class="main">{</span>target <span class="bound">r</span> <span class="free">p</span> <span class="main">|</span><span class="bound">r</span><span class="main">.</span> path <span class="bound">r</span> <span class="free">p</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1" id="Transition_System-reachable_trans"><span class="command">lemma</span></span> reachable_trans<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> reachable <span class="free">p</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">∈</span> reachable <span class="free">q</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">∈</span> reachable <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1" id="Transition_System-reachable_successors"><span class="command">lemma</span></span> reachable_successors<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"successors <span class="free">p</span> <span class="main">⊆</span> reachable <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1" id="Transition_System-reachable_step"><span class="command">lemma</span></span> reachable_step<span class="main">:</span> <span class="quoted"><span class="quoted">"reachable <span class="free">p</span> <span class="main">=</span> insert <span class="free">p</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>reachable <span class="main">`</span> successors <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Transition Systems with Initial States›</span></span>

  <span class="keyword1"><span class="command">locale</span></span> transition_system_initial <span class="main">=</span>
    transition_system <span class="quoted"><span class="free">execute</span></span> <span class="quoted"><span class="free">enabled</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">execute</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'transition</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">enabled</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'transition</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span>
    <span class="main">+</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">initial</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">nodes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      initial<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">initial</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∈</span> <span class="free">nodes</span>"</span></span> <span class="main">|</span>
      execute<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∈</span> <span class="free">nodes</span> <span class="main">⟹</span> <span class="free">enabled</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">⟹</span> <span class="free">execute</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∈</span> <span class="free">nodes</span>"</span></span>

    <span class="keyword1" id="Transition_System-nodes_target"><span class="command">lemma</span></span> nodes_target<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> nodes"</span></span> <span class="quoted"><span class="quoted">"path <span class="free">r</span> <span class="free">p</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"target <span class="free">r</span> <span class="free">p</span> <span class="main">∈</span> nodes"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1" id="Transition_System-nodes_target_elim"><span class="command">lemma</span></span> nodes_target_elim<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> nodes"</span></span>
      <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">r</span> <span class="free">p</span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">initial</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"path <span class="free">r</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> target <span class="free">r</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>

    <span class="keyword1" id="Transition_System-nodes_alt_def"><span class="command">lemma</span></span> nodes_alt_def<span class="main">:</span> <span class="quoted"><span class="quoted">"nodes <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span>reachable <span class="main">`</span> Collect <span class="free">initial</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1" id="Transition_System-nodes_trans"><span class="command">lemma</span></span> nodes_trans<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> nodes <span class="main">⟹</span> <span class="free">q</span> <span class="main">∈</span> reachable <span class="free">p</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">∈</span> nodes"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Transition_System_Extra">
<div class="head">
<h1>Theory Transition_System_Extra</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Additional Theorems for Transition Systems›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Transition_System_Extra
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="Sequence_LTL.html">../Basic/Sequence_LTL</a>"</span>
  <span class="quoted">"<a href="Transition_System.html">Transition_System</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">context</span></span> transition_system
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">enableds</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free">enabled</span> <span class="bound">a</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">paths</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">r</span><span class="main">.</span> path <span class="bound">r</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">runs</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">r</span><span class="main">.</span> run <span class="bound">r</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">}</span>"</span></span>

    <span class="keyword1" id="Transition_System_Extra-stake_run"><span class="command">lemma</span></span> stake_run<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> path <span class="main">(</span>stake <span class="bound">k</span> <span class="free">r</span><span class="main">)</span> <span class="free">p</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"run <span class="free">r</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> path.cases<span class="main">)</span>
    <span class="keyword1" id="Transition_System_Extra-snth_run"><span class="command">lemma</span></span> snth_run<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> <span class="free">enabled</span> <span class="main">(</span><span class="free">r</span> <span class="main">!!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span>target <span class="main">(</span>stake <span class="bound">k</span> <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"run <span class="free">r</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> stream.sel fold_simps snth.simps stake.simps<span class="main">)</span>

    <span class="keyword1" id="Transition_System_Extra-run_stake"><span class="command">lemma</span></span> run_stake<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"run <span class="free">r</span> <span class="free">p</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"path <span class="main">(</span>stake <span class="free">k</span> <span class="free">r</span><span class="main">)</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> run_shift_elim stake_sdrop<span class="main">)</span>
    <span class="keyword1" id="Transition_System_Extra-run_sdrop"><span class="command">lemma</span></span> run_sdrop<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"run <span class="free">r</span> <span class="free">p</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"run <span class="main">(</span>sdrop <span class="free">k</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span>target <span class="main">(</span>stake <span class="free">k</span> <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> run_shift_elim stake_sdrop<span class="main">)</span>
    <span class="keyword1" id="Transition_System_Extra-run_snth"><span class="command">lemma</span></span> run_snth<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"run <span class="free">r</span> <span class="free">p</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">enabled</span> <span class="main">(</span><span class="free">r</span> <span class="main">!!</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>target <span class="main">(</span>stake <span class="free">k</span> <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> stream.collapse sdrop_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> run_scons_elim run_sdrop<span class="main">)</span>

    <span class="keyword1" id="Transition_System_Extra-run_alt_def_snth"><span class="command">lemma</span></span> run_alt_def_snth<span class="main">:</span> <span class="quoted"><span class="quoted">"run <span class="free">r</span> <span class="free">p</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">k</span><span class="main">.</span> <span class="free">enabled</span> <span class="main">(</span><span class="free">r</span> <span class="main">!!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span>target <span class="main">(</span>stake <span class="bound">k</span> <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> snth_run run_snth <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1" id="Transition_System_Extra-reachable_states"><span class="command">lemma</span></span> reachable_states<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> reachable <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"path <span class="free">r</span> <span class="free">q</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>states <span class="free">r</span> <span class="free">q</span><span class="main">)</span> <span class="main">⊆</span> reachable <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">q</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1" id="Transition_System_Extra-reachable_trace"><span class="command">lemma</span></span> reachable_trace<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> reachable <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"run <span class="free">r</span> <span class="free">q</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sset <span class="main">(</span>trace <span class="free">r</span> <span class="free">q</span><span class="main">)</span> <span class="main">⊆</span> reachable <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> sset_subset_stream_pred
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">q</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> run.cases<span class="main">)</span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">context</span></span> transition_system_initial
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1" id="Transition_System_Extra-nodes_states"><span class="command">lemma</span></span> nodes_states<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> nodes"</span></span> <span class="quoted"><span class="quoted">"path <span class="free">r</span> <span class="free">p</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>states <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">⊆</span> nodes"</span></span>
      <span class="keyword1"><span class="command">using</span></span> reachable_states assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1" id="Transition_System_Extra-nodes_trace"><span class="command">lemma</span></span> nodes_trace<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> nodes"</span></span> <span class="quoted"><span class="quoted">"run <span class="free">r</span> <span class="free">p</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sset <span class="main">(</span>trace <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="main">⊆</span> nodes"</span></span>
      <span class="keyword1"><span class="command">using</span></span> reachable_trace assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Transition_System_Construction">
<div class="head">
<h1>Theory Transition_System_Construction</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Constructing Paths and Runs in Transition Systems›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Transition_System_Construction
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="Sequence_LTL.html">../Basic/Sequence_LTL</a>"</span>
  <span class="quoted">"<a href="Transition_System.html">Transition_System</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">context</span></span> transition_system
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1" id="Transition_System_Construction-invariant_run"><span class="command">lemma</span></span> invariant_run<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">p</span><span class="main">.</span> <span class="free">P</span> <span class="bound">p</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">a</span><span class="main">.</span> <span class="free">enabled</span> <span class="bound">a</span> <span class="bound">p</span> <span class="main">∧</span> <span class="free">P</span> <span class="main">(</span><span class="free">execute</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">)</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">p</span> <span class="bound">a</span>"</span></span>
      <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">r</span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"run <span class="free">r</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="free">P</span> <span class="main">(</span><span class="free">p</span> <span class="main">##</span> trace <span class="free">r</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"stream_all2 <span class="free">Q</span> <span class="main">(</span><span class="free">p</span> <span class="main">##</span> trace <span class="free">r</span> <span class="free">p</span><span class="main">)</span> <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">enabled</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">p</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="free">execute</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">p</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="free">execute</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">p</span><span class="main">)</span> <span class="bound">p</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> smap <span class="skolem">f</span> <span class="main">(</span>siterate <span class="var">?g</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"run <span class="main">(</span><span class="var">?r</span> <span class="free">p</span><span class="main">)</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="free">P</span> <span class="main">(</span><span class="free">p</span> <span class="main">##</span> trace <span class="main">(</span><span class="var">?r</span> <span class="free">p</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"stream_all2 <span class="free">Q</span> <span class="main">(</span><span class="free">p</span> <span class="main">##</span> trace <span class="main">(</span><span class="var">?r</span> <span class="free">p</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="var">?r</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1" id="Transition_System_Construction-recurring_condition"><span class="command">lemma</span></span> recurring_condition<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">p</span><span class="main">.</span> <span class="free">P</span> <span class="bound">p</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> path <span class="bound">r</span> <span class="bound">p</span> <span class="main">∧</span> <span class="free">P</span> <span class="main">(</span>target <span class="bound">r</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">r</span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"run <span class="free">r</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"infs <span class="free">P</span> <span class="main">(</span><span class="free">p</span> <span class="main">##</span> trace <span class="free">r</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">p</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"path <span class="main">(</span><span class="skolem">f</span> <span class="skolem">p</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>target <span class="main">(</span><span class="skolem">f</span> <span class="skolem">p</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> target <span class="main">(</span><span class="skolem">f</span> <span class="bound">p</span><span class="main">)</span> <span class="bound">p</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> flat <span class="main">(</span>smap <span class="skolem">f</span> <span class="main">(</span>siterate <span class="var">?g</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="skolem">p</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">p</span> <span class="main">@-</span> <span class="var">?r</span> <span class="main">(</span><span class="var">?g</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span> <span class="keyword1"><span class="command">using</span></span> that 1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> flat_unfold<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"run <span class="main">(</span><span class="var">?r</span> <span class="free">p</span><span class="main">)</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> run_coinduct_shift<span class="main">)</span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"infs <span class="free">P</span> <span class="main">(</span><span class="free">p</span> <span class="main">##</span> trace <span class="main">(</span><span class="var">?r</span> <span class="free">p</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infs_sscan_coinduct<span class="main">)</span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Transition_System_Construction-invariant_run_index"><span class="command">lemma</span></span> invariant_run_index<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">n</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span> <span class="bound">p</span><span class="main">.</span> <span class="free">P</span> <span class="bound">n</span> <span class="bound">p</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">a</span><span class="main">.</span> <span class="free">enabled</span> <span class="bound">a</span> <span class="bound">p</span> <span class="main">∧</span> <span class="free">P</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="free">execute</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">)</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">n</span> <span class="bound">p</span> <span class="bound">a</span>"</span></span>
      <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">r</span>
      <span class="keyword2"><span class="keyword">where</span></span>
        <span class="quoted"><span class="quoted">"run <span class="free">r</span> <span class="free">p</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>target <span class="main">(</span>stake <span class="bound">i</span> <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="free">Q</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>target <span class="main">(</span>stake <span class="bound">i</span> <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">r</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≡</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"case_prod <span class="free">P</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> s_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span>
        <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span> <span class="bound">p</span><span class="main">.</span> <span class="free">P</span> <span class="bound">n</span> <span class="bound">p</span> <span class="main">⟹</span> <span class="free">enabled</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">n</span> <span class="bound">p</span><span class="main">)</span> <span class="bound">p</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span> <span class="bound">p</span><span class="main">.</span> <span class="free">P</span> <span class="bound">n</span> <span class="bound">p</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="free">execute</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">n</span> <span class="bound">p</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span> <span class="bound">p</span><span class="main">.</span> <span class="free">P</span> <span class="bound">n</span> <span class="bound">p</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">n</span> <span class="bound">p</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">n</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">≡</span> <span class="main">λ</span> <span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">,</span> <span class="free">execute</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">n</span> <span class="bound">p</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span>"</span></span>

      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"smap <span class="main">(</span>case_prod <span class="skolem">f</span><span class="main">)</span> <span class="main">(</span>siterate <span class="skolem">g</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>

      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"run <span class="var">?r</span> <span class="main">(</span>snd <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 2<span class="main">(</span>1<span class="main">,</span> 2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> g_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"case_prod <span class="free">P</span> <span class="main">(</span>compow <span class="skolem">k</span> <span class="skolem">g</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span> <span class="keyword1"><span class="command">using</span></span> 1 2<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> g_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"case_prod <span class="free">Q</span> <span class="main">(</span>compow <span class="skolem">k</span> <span class="skolem">g</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span><span class="var">?r</span> <span class="main">!!</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>3<span class="main">)</span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"compow <span class="skolem">k</span> <span class="skolem">g</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">,</span> target <span class="main">(</span>stake <span class="skolem">k</span> <span class="var">?r</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
        <span class="keyword1"><span class="command">unfolding</span></span> s_def g_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stake_Suc <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> stake.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that 3 4 5 <span class="keyword1"><span class="command">unfolding</span></span> s_def 6 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Transition_System_Construction-koenig"><span class="command">lemma</span></span> koenig<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>reachable <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> reachable <span class="free">p</span> <span class="main">⟹</span> finite <span class="main">(</span>successors <span class="bound">q</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">r</span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"run <span class="free">r</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> invariant_run<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?P</span> <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span> <span class="bound"><span class="bound">q</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">q</span></span> <span class="main"><span class="main">∈</span></span> reachable <span class="free"><span class="free">p</span></span> <span class="main"><span class="main">∧</span></span> infinite <span class="main"><span class="main">(</span></span>reachable <span class="bound"><span class="bound">q</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> reachable <span class="free">p</span> <span class="main">∧</span> infinite <span class="main">(</span>reachable <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> reachable <span class="free">p</span> <span class="main">∧</span> infinite <span class="main">(</span>reachable <span class="skolem">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>successors <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>insert <span class="skolem">q</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span>reachable <span class="main">`</span> <span class="main">(</span>successors <span class="skolem">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reachable_step 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> successors <span class="skolem">q</span>"</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>reachable <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">a</span><span class="main">.</span> <span class="free">enabled</span> <span class="bound">a</span> <span class="skolem">q</span> <span class="main">∧</span> <span class="main">(</span><span class="free">execute</span> <span class="bound">a</span> <span class="skolem">q</span> <span class="main">∈</span> reachable <span class="free">p</span> <span class="main">∧</span> infinite <span class="main">(</span>reachable <span class="main">(</span><span class="free">execute</span> <span class="bound">a</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> True"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 1 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Deterministic">
<div class="head">
<h1>Theory Deterministic</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Deterministic Automata›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Deterministic
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="Transition_System.html">../Transition_Systems/Transition_System</a>"</span>
  <span class="quoted">"<a href="Transition_System_Extra.html">../Transition_Systems/Transition_System_Extra</a>"</span>
  <span class="quoted">"<a href="Transition_System_Construction.html">../Transition_Systems/Transition_System_Construction</a>"</span>
  <span class="quoted">"<a href="Degeneralization.html">../Basic/Degeneralization</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">locale</span></span> automaton <span class="main">=</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">automaton</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> set <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'condition</span> <span class="main">⇒</span> <span class="tfree">'automaton</span>"</span></span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">alphabet</span> <span class="free">initial</span> <span class="free">transition</span> <span class="free">condition</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> automaton<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">automaton</span> <span class="main">(</span><span class="free">alphabet</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">initial</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">transition</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">condition</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> alphabet<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">alphabet</span> <span class="main">(</span><span class="free">automaton</span> <span class="free">a</span> <span class="free">i</span> <span class="free">t</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> initial<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">initial</span> <span class="main">(</span><span class="free">automaton</span> <span class="free">a</span> <span class="free">i</span> <span class="free">t</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> transition<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">transition</span> <span class="main">(</span><span class="free">automaton</span> <span class="free">a</span> <span class="free">i</span> <span class="free">t</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> condition<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">condition</span> <span class="main">(</span><span class="free">automaton</span> <span class="free">a</span> <span class="free">i</span> <span class="free">t</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="comment1">(* TODO: is there a way to use defines without renaming the constants? *)</span>
    <span class="keyword1"><span class="command">sublocale</span></span> transition_system_initial
      <span class="quoted"><span class="quoted">"<span class="free">transition</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">alphabet</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">=</span> <span class="free">initial</span> <span class="free">A</span>"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="free">A</span>
      <span class="keyword2"><span class="keyword">defines</span></span> path' <span class="main">=</span> <span class="quoted">path</span> <span class="keyword2"><span class="keyword">and</span></span> run' <span class="main">=</span> <span class="quoted">run</span> <span class="keyword2"><span class="keyword">and</span></span> reachable' <span class="main">=</span> <span class="quoted">reachable</span> <span class="keyword2"><span class="keyword">and</span></span> nodes' <span class="main">=</span> <span class="quoted">nodes</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>

    <span class="keyword1" id="Deterministic-path_alt_def"><span class="command">lemma</span></span> path_alt_def<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="free">A</span> <span class="free">w</span> <span class="free">p</span> <span class="main">⟷</span> <span class="free">w</span> <span class="main">∈</span> lists <span class="main">(</span><span class="free">alphabet</span> <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> lists <span class="main">(</span><span class="free">alphabet</span> <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"path <span class="free">A</span> <span class="free">w</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"path <span class="free">A</span> <span class="free">w</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> lists <span class="main">(</span><span class="free">alphabet</span> <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1" id="Deterministic-run_alt_def"><span class="command">lemma</span></span> run_alt_def<span class="main">:</span> <span class="quoted"><span class="quoted">"run <span class="free">A</span> <span class="free">w</span> <span class="free">p</span> <span class="main">⟷</span> <span class="free">w</span> <span class="main">∈</span> streams <span class="main">(</span><span class="free">alphabet</span> <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> streams <span class="main">(</span><span class="free">alphabet</span> <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"run <span class="free">A</span> <span class="free">w</span> <span class="free">p</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> run.cases<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"run <span class="free">A</span> <span class="free">w</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> streams <span class="main">(</span><span class="free">alphabet</span> <span class="free">A</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> streams.cases<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">locale</span></span> automaton_path <span class="main">=</span>
    automaton <span class="quoted"><span class="free">automaton</span></span> <span class="quoted"><span class="free">alphabet</span></span> <span class="quoted"><span class="free">initial</span></span> <span class="quoted"><span class="free">transition</span></span> <span class="quoted"><span class="free">condition</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">automaton</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> set <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'condition</span> <span class="main">⇒</span> <span class="tfree">'automaton</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">alphabet</span> <span class="free">initial</span> <span class="free">transition</span> <span class="free">condition</span>
    <span class="main">+</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">test</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'condition</span> <span class="main">⇒</span> <span class="tfree">'label</span> list <span class="main">⇒</span> <span class="tfree">'state</span> list <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1"><span class="command">definition</span></span> <span class="entity">language</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'automaton</span> <span class="main">⇒</span> <span class="tfree">'label</span> list set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">language</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">w</span><span class="main">.</span> path <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">w</span> <span class="main">(</span><span class="free">initial</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="free">test</span> <span class="main">(</span><span class="free">condition</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="bound">w</span> <span class="main">(</span>states <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">w</span> <span class="main">(</span><span class="free">initial</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">initial</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">}</span>"</span></span>

    <span class="keyword1" id="Deterministic-language"><span class="command">lemma</span></span> language<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"path <span class="free">A</span> <span class="free">w</span> <span class="main">(</span><span class="free">initial</span> <span class="free">A</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">test</span> <span class="main">(</span><span class="free">condition</span> <span class="free">A</span><span class="main">)</span> <span class="free">w</span> <span class="main">(</span>states <span class="free">A</span> <span class="free">w</span> <span class="main">(</span><span class="free">initial</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">initial</span> <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> language <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> language_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1" id="Deterministic-language_elim"><span class="command">lemma</span></span> language_elim<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> language <span class="free">A</span>"</span></span>
      <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"path <span class="free">A</span> <span class="free">w</span> <span class="main">(</span><span class="free">initial</span> <span class="free">A</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">test</span> <span class="main">(</span><span class="free">condition</span> <span class="free">A</span><span class="main">)</span> <span class="free">w</span> <span class="main">(</span>states <span class="free">A</span> <span class="free">w</span> <span class="main">(</span><span class="free">initial</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">initial</span> <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> language_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1" id="Deterministic-language_alphabet"><span class="command">lemma</span></span> language_alphabet<span class="main">:</span> <span class="quoted"><span class="quoted">"language <span class="free">A</span> <span class="main">⊆</span> lists <span class="main">(</span><span class="free">alphabet</span> <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> path_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">locale</span></span> automaton_run <span class="main">=</span>
    automaton <span class="quoted"><span class="free">automaton</span></span> <span class="quoted"><span class="free">alphabet</span></span> <span class="quoted"><span class="free">initial</span></span> <span class="quoted"><span class="free">transition</span></span> <span class="quoted"><span class="free">condition</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">automaton</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> set <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'condition</span> <span class="main">⇒</span> <span class="tfree">'automaton</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">alphabet</span> <span class="free">initial</span> <span class="free">transition</span> <span class="free">condition</span>
    <span class="main">+</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">test</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'condition</span> <span class="main">⇒</span> <span class="tfree">'label</span> stream <span class="main">⇒</span> <span class="tfree">'state</span> stream <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1"><span class="command">definition</span></span> <span class="entity">language</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'automaton</span> <span class="main">⇒</span> <span class="tfree">'label</span> stream set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">language</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">w</span><span class="main">.</span> run <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">w</span> <span class="main">(</span><span class="free">initial</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="free">test</span> <span class="main">(</span><span class="free">condition</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="bound">w</span> <span class="main">(</span>trace <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">w</span> <span class="main">(</span><span class="free">initial</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">initial</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">}</span>"</span></span>

    <span class="keyword1" id="Deterministic-language"><span class="command">lemma</span></span> language<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"run <span class="free">A</span> <span class="free">w</span> <span class="main">(</span><span class="free">initial</span> <span class="free">A</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">test</span> <span class="main">(</span><span class="free">condition</span> <span class="free">A</span><span class="main">)</span> <span class="free">w</span> <span class="main">(</span>trace <span class="free">A</span> <span class="free">w</span> <span class="main">(</span><span class="free">initial</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">initial</span> <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> language <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> language_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1" id="Deterministic-language_elim"><span class="command">lemma</span></span> language_elim<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> language <span class="free">A</span>"</span></span>
      <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"run <span class="free">A</span> <span class="free">w</span> <span class="main">(</span><span class="free">initial</span> <span class="free">A</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">test</span> <span class="main">(</span><span class="free">condition</span> <span class="free">A</span><span class="main">)</span> <span class="free">w</span> <span class="main">(</span>trace <span class="free">A</span> <span class="free">w</span> <span class="main">(</span><span class="free">initial</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">initial</span> <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> language_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1" id="Deterministic-language_alphabet"><span class="command">lemma</span></span> language_alphabet<span class="main">:</span> <span class="quoted"><span class="quoted">"language <span class="free">A</span> <span class="main">⊆</span> streams <span class="main">(</span><span class="free">alphabet</span> <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> run_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">locale</span></span> automaton_degeneralization <span class="main">=</span>
    a<span class="main">:</span> automaton <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="main">+</span>
    b<span class="main">:</span> automaton <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> set <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'item</span> pred gen <span class="main">⇒</span> <span class="tfree">'automaton<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> set <span class="main">⇒</span> <span class="tfree">'state</span> degen <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state</span> degen <span class="main">⇒</span> <span class="tfree">'state</span> degen<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'item_degen</span> pred <span class="main">⇒</span> <span class="tfree">'automaton<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span>
    <span class="main">+</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">item</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">×</span> <span class="tfree">'label</span> <span class="main">×</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'item</span>"</span></span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">translate</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'item_degen</span> <span class="main">⇒</span> <span class="tfree">'item</span> degen"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1"><span class="command">definition</span></span> <span class="entity">degeneralize</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'automaton<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⇒</span> <span class="tfree">'automaton<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">degeneralize</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span>
        <span class="main">(</span><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>
        <span class="main">(</span><span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>
        <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">k</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">a</span> <span class="bound">p</span><span class="main">,</span> count <span class="main">(</span><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">item</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">a</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span>degen <span class="main">(</span><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">∘</span> <span class="free">translate</span><span class="main">)</span>"</span></span>

    <span class="keyword1" id="Deterministic-degeneralize_simps"><span class="command">lemma</span></span> degeneralize_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span>degeneralize <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span>degeneralize <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span>degeneralize <span class="free">A</span><span class="main">)</span> <span class="free">a</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">(</span><span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span> <span class="free">a</span> <span class="free">p</span><span class="main">,</span> count <span class="main">(</span><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">item</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">a</span><span class="main">,</span> <span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span> <span class="free">a</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span>degeneralize <span class="free">A</span><span class="main">)</span> <span class="main">=</span> degen <span class="main">(</span><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span><span class="main">)</span> <span class="main">∘</span> <span class="free">translate</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> degeneralize_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1" id="Deterministic-degeneralize_target"><span class="command">lemma</span></span> degeneralize_target<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"b.target <span class="main">(</span>degeneralize <span class="free">A</span><span class="main">)</span> <span class="free">w</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span>a.target <span class="free">A</span> <span class="free">w</span> <span class="free">p</span><span class="main">,</span> fold <span class="main">(</span>count <span class="main">(</span><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span><span class="main">)</span> <span class="main">∘</span> <span class="free">item</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> a.states <span class="free">A</span> <span class="free">w</span> <span class="free">p</span> <span class="main">||</span> <span class="free">w</span> <span class="main">||</span> a.states <span class="free">A</span> <span class="free">w</span> <span class="free">p</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1" id="Deterministic-degeneralize_states"><span class="command">lemma</span></span> degeneralize_states<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"b.states <span class="main">(</span>degeneralize <span class="free">A</span><span class="main">)</span> <span class="free">w</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span>
      a.states <span class="free">A</span> <span class="free">w</span> <span class="free">p</span> <span class="main">||</span> scan <span class="main">(</span>count <span class="main">(</span><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span><span class="main">)</span> <span class="main">∘</span> <span class="free">item</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> a.states <span class="free">A</span> <span class="free">w</span> <span class="free">p</span> <span class="main">||</span> <span class="free">w</span> <span class="main">||</span> a.states <span class="free">A</span> <span class="free">w</span> <span class="free">p</span><span class="main">)</span> <span class="free">k</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1" id="Deterministic-degeneralize_trace"><span class="command">lemma</span></span> degeneralize_trace<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"b.trace <span class="main">(</span>degeneralize <span class="free">A</span><span class="main">)</span> <span class="free">w</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span>
      a.trace <span class="free">A</span> <span class="free">w</span> <span class="free">p</span> <span class="main">|||</span> sscan <span class="main">(</span>count <span class="main">(</span><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span><span class="main">)</span> <span class="main">∘</span> <span class="free">item</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">##</span> a.trace <span class="free">A</span> <span class="free">w</span> <span class="free">p</span> <span class="main">|||</span> <span class="free">w</span> <span class="main">|||</span> a.trace <span class="free">A</span> <span class="free">w</span> <span class="free">p</span><span class="main">)</span> <span class="free">k</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> sscan.code<span class="main">)</span>

    <span class="keyword1" id="Deterministic-degeneralize_path"><span class="command">lemma</span></span> degeneralize_path<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"b.path <span class="main">(</span>degeneralize <span class="free">A</span><span class="main">)</span> <span class="free">w</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span> <span class="main">⟷</span> a.path <span class="free">A</span> <span class="free">w</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> a.path_alt_def b.path_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1" id="Deterministic-degeneralize_run"><span class="command">lemma</span></span> degeneralize_run<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"b.run <span class="main">(</span>degeneralize <span class="free">A</span><span class="main">)</span> <span class="free">w</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span> <span class="main">⟷</span> a.run <span class="free">A</span> <span class="free">w</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> a.run_alt_def b.run_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1" id="Deterministic-degeneralize_reachable_fst"><span class="command">lemma</span></span> degeneralize_reachable_fst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">`</span> b.reachable <span class="main">(</span>degeneralize <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> a.reachable <span class="free">A</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> a.reachable_alt_def b.reachable_alt_def image_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1" id="Deterministic-degeneralize_reachable_snd_empty"><span class="command">lemma</span></span> degeneralize_reachable_snd_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">`</span> b.reachable <span class="main">(</span>degeneralize <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">k</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">ql</span> <span class="main">=</span> <span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ql</span> <span class="main">∈</span> b.reachable <span class="main">(</span>degeneralize <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ql</span>
        <span class="keyword1"><span class="command">using</span></span> that assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1" id="Deterministic-degeneralize_reachable_empty"><span class="command">lemma</span></span> degeneralize_reachable_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"b.reachable <span class="main">(</span>degeneralize <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> a.reachable <span class="free">A</span> <span class="free">p</span> <span class="main">×</span> <span class="main">{</span><span class="free">k</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> degeneralize_reachable_fst degeneralize_reachable_snd_empty assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod_singleton<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1" id="Deterministic-degeneralize_reachable_snd"><span class="command">lemma</span></span> degeneralize_reachable_snd<span class="main">:</span>
      <span class="quoted"><span class="quoted">"snd <span class="main">`</span> b.reachable <span class="main">(</span>degeneralize <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span> <span class="main">⊆</span> insert <span class="free">k</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> length <span class="main">(</span><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1" id="Deterministic-degeneralize_reachable"><span class="command">lemma</span></span> degeneralize_reachable<span class="main">:</span>
      <span class="quoted"><span class="quoted">"b.reachable <span class="main">(</span>degeneralize <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span> <span class="main">⊆</span> a.reachable <span class="free">A</span> <span class="free">p</span> <span class="main">×</span> insert <span class="free">k</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> length <span class="main">(</span><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 0 3<span class="main">)</span>

    <span class="keyword1" id="Deterministic-degeneralize_nodes_fst"><span class="command">lemma</span></span> degeneralize_nodes_fst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">`</span> b.nodes <span class="main">(</span>degeneralize <span class="free">A</span><span class="main">)</span> <span class="main">=</span> a.nodes <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> a.nodes_alt_def b.nodes_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1" id="Deterministic-degeneralize_nodes_snd_empty"><span class="command">lemma</span></span> degeneralize_nodes_snd_empty<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">`</span> b.nodes <span class="main">(</span>degeneralize <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> b.nodes_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1" id="Deterministic-degeneralize_nodes_empty"><span class="command">lemma</span></span> degeneralize_nodes_empty<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"b.nodes <span class="main">(</span>degeneralize <span class="free">A</span><span class="main">)</span> <span class="main">=</span> a.nodes <span class="free">A</span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> b.nodes_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1" id="Deterministic-degeneralize_nodes_snd"><span class="command">lemma</span></span> degeneralize_nodes_snd<span class="main">:</span>
      <span class="quoted"><span class="quoted">"snd <span class="main">`</span> b.nodes <span class="main">(</span>degeneralize <span class="free">A</span><span class="main">)</span> <span class="main">⊆</span> insert <span class="main">0</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> length <span class="main">(</span><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> degeneralize_reachable_snd <span class="keyword1"><span class="command">unfolding</span></span> b.nodes_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1" id="Deterministic-degeneralize_nodes"><span class="command">lemma</span></span> degeneralize_nodes<span class="main">:</span>
      <span class="quoted"><span class="quoted">"b.nodes <span class="main">(</span>degeneralize <span class="free">A</span><span class="main">)</span> <span class="main">⊆</span> a.nodes <span class="free">A</span> <span class="main">×</span> insert <span class="main">0</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> length <span class="main">(</span><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> degeneralize_reachable <span class="keyword1"><span class="command">unfolding</span></span> a.nodes_alt_def b.nodes_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
    <span class="keyword1" id="Deterministic-degeneralize_nodes_finite"><span class="command">lemma</span></span> degeneralize_nodes_finite<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>b.nodes <span class="main">(</span>degeneralize <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> finite <span class="main">(</span>a.nodes <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>a.nodes <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>b.nodes <span class="main">(</span>degeneralize <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> degeneralize_nodes_fst<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>b.nodes <span class="main">(</span>degeneralize <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>a.nodes <span class="free">A</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> finite_subset degeneralize_nodes that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1" id="Deterministic-degeneralize_nodes_card"><span class="command">lemma</span></span> degeneralize_nodes_card<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>b.nodes <span class="main">(</span>degeneralize <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span>
      max <span class="main">1</span> <span class="main">(</span>length <span class="main">(</span><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> card <span class="main">(</span>a.nodes <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>a.nodes <span class="free">A</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>b.nodes <span class="main">(</span>degeneralize <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span>a.nodes <span class="free">A</span> <span class="main">×</span> insert <span class="main">0</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> length <span class="main">(</span><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> degeneralize_nodes True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> card_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> card <span class="main">(</span>insert <span class="main">0</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> length <span class="main">(</span><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">*</span> card <span class="main">(</span>a.nodes <span class="free">A</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> card_cartesian_product <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>insert <span class="main">0</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> length <span class="main">(</span><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> max <span class="main">1</span> <span class="main">(</span>length <span class="main">(</span><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_insert_if Suc_leI max_absorb2<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>a.nodes <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>b.nodes <span class="main">(</span>degeneralize <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">locale</span></span> automaton_degeneralization_run <span class="main">=</span>
    automaton_degeneralization
      <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span></span>
      <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span></span>
      <span class="quoted"><span class="free">item</span></span> <span class="quoted"><span class="free">translate</span></span> <span class="main">+</span>
    a<span class="main">:</span> automaton_run <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">test<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="main">+</span>
    b<span class="main">:</span> automaton_run <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">test<span class="hidden">⇩</span><sub>2</sub></span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">test<span class="hidden">⇩</span><sub>1</sub></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">test<span class="hidden">⇩</span><sub>2</sub></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">item</span> <span class="free">translate</span>
    <span class="main">+</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> test<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">test<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span>degen <span class="free">cs</span> <span class="main">∘</span> <span class="free">translate</span><span class="main">)</span> <span class="free">w</span>
      <span class="main">(</span><span class="free">r</span> <span class="main">|||</span> sscan <span class="main">(</span>count <span class="free">cs</span> <span class="main">∘</span> <span class="free">item</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">##</span> <span class="free">r</span> <span class="main">|||</span> <span class="free">w</span> <span class="main">|||</span> <span class="free">r</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">test<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">cs</span> <span class="free">w</span> <span class="free">r</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1" id="Deterministic-degeneralize_language"><span class="command">lemma</span></span> degeneralize_language<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"b.language <span class="main">(</span>degeneralize <span class="free">A</span><span class="main">)</span> <span class="main">=</span> a.language <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">locale</span></span> automaton_product <span class="main">=</span>
    a<span class="main">:</span> automaton <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="main">+</span>
    b<span class="main">:</span> automaton <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="main">+</span>
    c<span class="main">:</span> automaton <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>3</sub></span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> set <span class="main">⇒</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⇒</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⇒</span> <span class="tfree">'automaton<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> set <span class="main">⇒</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⇒</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'condition<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⇒</span> <span class="tfree">'automaton<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> set <span class="main">⇒</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">×</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">×</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⇒</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">×</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'condition<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">⇒</span> <span class="tfree">'automaton<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>3</sub></span>
    <span class="main">+</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">condition</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⇒</span> <span class="tfree">'condition<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⇒</span> <span class="tfree">'condition<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1"><span class="command">definition</span></span> <span class="entity">product</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'automaton<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⇒</span> <span class="tfree">'automaton<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⇒</span> <span class="tfree">'automaton<span class="hidden">⇩</span><sub>3</sub></span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">product</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> <span class="free">automaton<span class="hidden">⇩</span><sub>3</sub></span>
        <span class="main">(</span><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∩</span> <span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span>
        <span class="main">(</span><span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span>
        <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">a</span> <span class="bound">p</span><span class="main">,</span> <span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="bound">a</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span><span class="free">condition</span> <span class="main">(</span><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

    <span class="keyword1" id="Deterministic-product_simps"><span class="command">lemma</span></span> product_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="free">alphabet<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">(</span>product <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span> <span class="main">∩</span> <span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">initial<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">(</span>product <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span><span class="main">,</span> <span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">transition<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">(</span>product <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="free">a</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span> <span class="free">a</span> <span class="free">p</span><span class="main">,</span> <span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B</span> <span class="free">a</span> <span class="free">q</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">condition<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">(</span>product <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="free">condition</span> <span class="main">(</span><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> product_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1" id="Deterministic-product_target"><span class="command">lemma</span></span> product_target<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"c.target <span class="main">(</span>product <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="free">w</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>a.target <span class="free">A</span> <span class="free">w</span> <span class="free">p</span><span class="main">,</span> b.target <span class="free">B</span> <span class="free">w</span> <span class="free">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">q</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1" id="Deterministic-product_states"><span class="command">lemma</span></span> product_states<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"c.states <span class="main">(</span>product <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="free">w</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> a.states <span class="free">A</span> <span class="free">w</span> <span class="free">p</span> <span class="main">||</span> b.states <span class="free">B</span> <span class="free">w</span> <span class="free">q</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">q</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1" id="Deterministic-product_trace"><span class="command">lemma</span></span> product_trace<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"c.trace <span class="main">(</span>product <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="free">w</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> a.trace <span class="free">A</span> <span class="free">w</span> <span class="free">p</span> <span class="main">|||</span> b.trace <span class="free">B</span> <span class="free">w</span> <span class="free">q</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">q</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

    <span class="keyword1" id="Deterministic-product_path"><span class="command">lemma</span></span> product_path<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"c.path <span class="main">(</span>product <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="free">w</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span> <span class="main">⟷</span> a.path <span class="free">A</span> <span class="free">w</span> <span class="free">p</span> <span class="main">∧</span> b.path <span class="free">B</span> <span class="free">w</span> <span class="free">q</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> a.path_alt_def b.path_alt_def c.path_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1" id="Deterministic-product_run"><span class="command">lemma</span></span> product_run<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"c.run <span class="main">(</span>product <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="free">w</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span> <span class="main">⟷</span> a.run <span class="free">A</span> <span class="free">w</span> <span class="free">p</span> <span class="main">∧</span> b.run <span class="free">B</span> <span class="free">w</span> <span class="free">q</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> a.run_alt_def b.run_alt_def c.run_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1" id="Deterministic-product_reachable"><span class="command">lemma</span></span> product_reachable<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"c.reachable <span class="main">(</span>product <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span> <span class="main">⊆</span> a.reachable <span class="free">A</span> <span class="free">p</span> <span class="main">×</span> b.reachable <span class="free">B</span> <span class="free">q</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> c.reachable_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1" id="Deterministic-product_nodes"><span class="command">lemma</span></span> product_nodes<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"c.nodes <span class="main">(</span>product <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">⊆</span> a.nodes <span class="free">A</span> <span class="main">×</span> b.nodes <span class="free">B</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> a.nodes_alt_def b.nodes_alt_def c.nodes_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1" id="Deterministic-product_reachable_fst"><span class="command">lemma</span></span> product_reachable_fst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span> <span class="main">⊆</span> <span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">`</span> c.reachable <span class="main">(</span>product <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> a.reachable <span class="free">A</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">unfolding</span></span> a.reachable_alt_def a.path_alt_def
      <span class="keyword1"><span class="command">unfolding</span></span> b.reachable_alt_def b.path_alt_def
      <span class="keyword1"><span class="command">unfolding</span></span> c.reachable_alt_def c.path_alt_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="operator">force</span>
    <span class="keyword1" id="Deterministic-product_reachable_snd"><span class="command">lemma</span></span> product_reachable_snd<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span> <span class="main">⊇</span> <span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">`</span> c.reachable <span class="main">(</span>product <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> b.reachable <span class="free">B</span> <span class="free">q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">unfolding</span></span> a.reachable_alt_def a.path_alt_def
      <span class="keyword1"><span class="command">unfolding</span></span> b.reachable_alt_def b.path_alt_def
      <span class="keyword1"><span class="command">unfolding</span></span> c.reachable_alt_def c.path_alt_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="operator">force</span>
    <span class="keyword1" id="Deterministic-product_nodes_fst"><span class="command">lemma</span></span> product_nodes_fst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span> <span class="main">⊆</span> <span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">`</span> c.nodes <span class="main">(</span>product <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> a.nodes <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms product_reachable_fst
      <span class="keyword1"><span class="command">unfolding</span></span> a.nodes_alt_def b.nodes_alt_def c.nodes_alt_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1" id="Deterministic-product_nodes_snd"><span class="command">lemma</span></span> product_nodes_snd<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span> <span class="main">⊇</span> <span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">`</span> c.nodes <span class="main">(</span>product <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> b.nodes <span class="free">B</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms product_reachable_snd
      <span class="keyword1"><span class="command">unfolding</span></span> a.nodes_alt_def b.nodes_alt_def c.nodes_alt_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

    <span class="keyword1" id="Deterministic-product_nodes_finite"><span class="command">lemma</span></span> product_nodes_finite<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>a.nodes <span class="free">A</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>b.nodes <span class="free">B</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>c.nodes <span class="main">(</span>product <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"c.nodes <span class="main">(</span>product <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">⊆</span> a.nodes <span class="free">A</span> <span class="main">×</span> b.nodes <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> product_nodes <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>a.nodes <span class="free">A</span> <span class="main">×</span> b.nodes <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1" id="Deterministic-product_nodes_finite_strong"><span class="command">lemma</span></span> product_nodes_finite_strong<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span> <span class="main">=</span> <span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>c.nodes <span class="main">(</span>product <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> finite <span class="main">(</span>a.nodes <span class="free">A</span><span class="main">)</span> <span class="main">∧</span> finite <span class="main">(</span>b.nodes <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>a.nodes <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>c.nodes <span class="main">(</span>product <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> product_nodes_fst assms that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_imageI equalityD1<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>b.nodes <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>c.nodes <span class="main">(</span>product <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> product_nodes_snd assms that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_imageI equalityD2<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>c.nodes <span class="main">(</span>product <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>a.nodes <span class="free">A</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>b.nodes <span class="free">B</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1" id="Deterministic-product_nodes_card"><span class="command">lemma</span></span> product_nodes_card<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>a.nodes <span class="free">A</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>b.nodes <span class="free">B</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>c.nodes <span class="main">(</span>product <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span>a.nodes <span class="free">A</span><span class="main">)</span> <span class="main">*</span> card <span class="main">(</span>b.nodes <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>c.nodes <span class="main">(</span>product <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span>a.nodes <span class="free">A</span> <span class="main">×</span> b.nodes <span class="free">B</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> card_mono<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>a.nodes <span class="free">A</span> <span class="main">×</span> b.nodes <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"c.nodes <span class="main">(</span>product <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">⊆</span> a.nodes <span class="free">A</span> <span class="main">×</span> b.nodes <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> product_nodes <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> card <span class="main">(</span>a.nodes <span class="free">A</span><span class="main">)</span> <span class="main">*</span> card <span class="main">(</span>b.nodes <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> card_cartesian_product <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1" id="Deterministic-product_nodes_card_strong"><span class="command">lemma</span></span> product_nodes_card_strong<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span> <span class="main">=</span> <span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>c.nodes <span class="main">(</span>product <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span>a.nodes <span class="free">A</span><span class="main">)</span> <span class="main">*</span> card <span class="main">(</span>b.nodes <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>a.nodes <span class="free">A</span><span class="main">)</span> <span class="main">∧</span> finite <span class="main">(</span>b.nodes <span class="free">B</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>c.nodes <span class="main">(</span>product <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>a.nodes <span class="free">A</span><span class="main">)</span> <span class="main">*</span> card <span class="main">(</span>b.nodes <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">locale</span></span> automaton_intersection_path <span class="main">=</span>
    automaton_product
      <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span></span>
      <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span></span>
      <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>3</sub></span></span>
      <span class="quoted"><span class="free">condition</span></span> <span class="main">+</span>
    a<span class="main">:</span> automaton_path <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">test<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="main">+</span>
    b<span class="main">:</span> automaton_path <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">test<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="main">+</span>
    c<span class="main">:</span> automaton_path <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">test<span class="hidden">⇩</span><sub>3</sub></span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">test<span class="hidden">⇩</span><sub>1</sub></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">test<span class="hidden">⇩</span><sub>2</sub></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">test<span class="hidden">⇩</span><sub>3</sub></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">condition</span>
    <span class="main">+</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> test<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">r</span> <span class="main">=</span> length <span class="free">s</span> <span class="main">⟹</span>
      <span class="free">test<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">(</span><span class="free">condition</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">w</span> <span class="main">(</span><span class="free">r</span> <span class="main">||</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">test<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">w</span> <span class="free">r</span> <span class="free">p</span> <span class="main">∧</span> <span class="free">test<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">w</span> <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1" id="Deterministic-product_language"><span class="command">lemma</span></span> product_language<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"c.language <span class="main">(</span>product <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> a.language <span class="free">A</span> <span class="main">∩</span> b.language <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">locale</span></span> automaton_union_path <span class="main">=</span>
    automaton_product
      <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span></span>
      <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span></span>
      <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>3</sub></span></span>
      <span class="quoted"><span class="free">condition</span></span> <span class="main">+</span>
    a<span class="main">:</span> automaton_path <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">test<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="main">+</span>
    b<span class="main">:</span> automaton_path <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">test<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="main">+</span>
    c<span class="main">:</span> automaton_path <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">test<span class="hidden">⇩</span><sub>3</sub></span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">test<span class="hidden">⇩</span><sub>1</sub></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">test<span class="hidden">⇩</span><sub>2</sub></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">test<span class="hidden">⇩</span><sub>3</sub></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">condition</span>
    <span class="main">+</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> test<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">r</span> <span class="main">=</span> length <span class="free">s</span> <span class="main">⟹</span>
      <span class="free">test<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">(</span><span class="free">condition</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">w</span> <span class="main">(</span><span class="free">r</span> <span class="main">||</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">test<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">w</span> <span class="free">r</span> <span class="free">p</span> <span class="main">∨</span> <span class="free">test<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">w</span> <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1" id="Deterministic-product_language"><span class="command">lemma</span></span> product_language<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span> <span class="main">=</span> <span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"c.language <span class="main">(</span>product <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> a.language <span class="free">A</span> <span class="main">∪</span> b.language <span class="free">B</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> a.path_alt_def b.path_alt_def<span class="main">)</span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">locale</span></span> automaton_intersection_run <span class="main">=</span>
    automaton_product
      <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span></span>
      <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span></span>
      <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>3</sub></span></span>
      <span class="quoted"><span class="free">condition</span></span> <span class="main">+</span>
    a<span class="main">:</span> automaton_run <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">test<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="main">+</span>
    b<span class="main">:</span> automaton_run <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">test<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="main">+</span>
    c<span class="main">:</span> automaton_run <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">test<span class="hidden">⇩</span><sub>3</sub></span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">test<span class="hidden">⇩</span><sub>1</sub></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">test<span class="hidden">⇩</span><sub>2</sub></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">test<span class="hidden">⇩</span><sub>3</sub></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">condition</span>
    <span class="main">+</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> test<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">test<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">(</span><span class="free">condition</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">w</span> <span class="main">(</span><span class="free">r</span> <span class="main">|||</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">test<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">w</span> <span class="free">r</span> <span class="free">p</span> <span class="main">∧</span> <span class="free">test<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">w</span> <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1" id="Deterministic-product_language"><span class="command">lemma</span></span> product_language<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"c.language <span class="main">(</span>product <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> a.language <span class="free">A</span> <span class="main">∩</span> b.language <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">locale</span></span> automaton_union_run <span class="main">=</span>
    automaton_product
      <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span></span>
      <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span></span>
      <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>3</sub></span></span>
      <span class="quoted"><span class="free">condition</span></span> <span class="main">+</span>
    a<span class="main">:</span> automaton_run <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">test<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="main">+</span>
    b<span class="main">:</span> automaton_run <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">test<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="main">+</span>
    c<span class="main">:</span> automaton_run <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">test<span class="hidden">⇩</span><sub>3</sub></span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">test<span class="hidden">⇩</span><sub>1</sub></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">test<span class="hidden">⇩</span><sub>2</sub></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">test<span class="hidden">⇩</span><sub>3</sub></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">condition</span>
    <span class="main">+</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> test<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">test<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">(</span><span class="free">condition</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">w</span> <span class="main">(</span><span class="free">r</span> <span class="main">|||</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">test<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">w</span> <span class="free">r</span> <span class="free">p</span> <span class="main">∨</span> <span class="free">test<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">w</span> <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1" id="Deterministic-product_language"><span class="command">lemma</span></span> product_language<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span> <span class="main">=</span> <span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"c.language <span class="main">(</span>product <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> a.language <span class="free">A</span> <span class="main">∪</span> b.language <span class="free">B</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> a.run_alt_def b.run_alt_def<span class="main">)</span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="comment1">(* TODO: complete this in analogy to the pair case *)</span>
  <span class="keyword1"><span class="command">locale</span></span> automaton_product_list <span class="main">=</span>
    a<span class="main">:</span> automaton <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="main">+</span>
    b<span class="main">:</span> automaton <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> set <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⇒</span> <span class="tfree">'automaton<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> set <span class="main">⇒</span> <span class="tfree">'state</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state</span> list <span class="main">⇒</span> <span class="tfree">'state</span> list<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'condition<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⇒</span> <span class="tfree">'automaton<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span>
    <span class="main">+</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">condition</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'condition<span class="hidden">⇩</span><sub>1</sub></span> list <span class="main">⇒</span> <span class="tfree">'condition<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1"><span class="command">definition</span></span> <span class="entity">product</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'automaton<span class="hidden">⇩</span><sub>1</sub></span> list <span class="main">⇒</span> <span class="tfree">'automaton<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">product</span> <span class="free"><span class="bound"><span class="entity">AA</span></span></span> <span class="main">≡</span> <span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span>
        <span class="main">(</span><span class="main">⋂</span> <span class="main">(</span><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">`</span> set <span class="free"><span class="bound"><span class="entity">AA</span></span></span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span>map <span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span> <span class="free"><span class="bound"><span class="entity">AA</span></span></span><span class="main">)</span>
        <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="bound">ps</span><span class="main">.</span> map2 <span class="main">(</span><span class="main">λ</span> <span class="bound">A</span> <span class="bound">p</span><span class="main">.</span> <span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">A</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">AA</span></span></span> <span class="bound">ps</span><span class="main">)</span>
        <span class="main">(</span><span class="free">condition</span> <span class="main">(</span>map <span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free"><span class="bound"><span class="entity">AA</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

    <span class="keyword1" id="Deterministic-product_simps"><span class="command">lemma</span></span> product_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span>product <span class="free">AA</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋂</span> <span class="main">(</span><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">`</span> set <span class="free">AA</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span>product <span class="free">AA</span><span class="main">)</span> <span class="main">=</span> map <span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">AA</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span>product <span class="free">AA</span><span class="main">)</span> <span class="free">a</span> <span class="free">ps</span> <span class="main">=</span> map2 <span class="main">(</span><span class="main">λ</span> <span class="bound">A</span> <span class="bound">p</span><span class="main">.</span> <span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">A</span> <span class="free">a</span> <span class="bound">p</span><span class="main">)</span> <span class="free">AA</span> <span class="free">ps</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span>product <span class="free">AA</span><span class="main">)</span> <span class="main">=</span> <span class="free">condition</span> <span class="main">(</span>map <span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">AA</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> product_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="comment1">(* TODO: get rid of indices, express this using stranspose and listset *)</span>
    <span class="keyword1" id="Deterministic-product_trace_smap"><span class="command">lemma</span></span> product_trace_smap<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ps</span> <span class="main">=</span> length <span class="free">AA</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> length <span class="free">AA</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"smap <span class="main">(</span><span class="main">λ</span> <span class="bound">ps</span><span class="main">.</span> <span class="bound">ps</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>b.trace <span class="main">(</span>product <span class="free">AA</span><span class="main">)</span> <span class="free">w</span> <span class="free">ps</span><span class="main">)</span> <span class="main">=</span> a.trace <span class="main">(</span><span class="free">AA</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> <span class="free">w</span> <span class="main">(</span><span class="free">ps</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">ps</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span><span class="main">)</span>

    <span class="keyword1" id="Deterministic-product_nodes"><span class="command">lemma</span></span> product_nodes<span class="main">:</span> <span class="quoted"><span class="quoted">"b.nodes <span class="main">(</span>product <span class="free">AA</span><span class="main">)</span> <span class="main">⊆</span> listset <span class="main">(</span>map a.nodes <span class="free">AA</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ps</span> <span class="main">∈</span> listset <span class="main">(</span>map a.nodes <span class="free">AA</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ps</span> <span class="main">∈</span> b.nodes <span class="main">(</span>product <span class="free">AA</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ps</span>
        <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> listset_member list_all2_conv_all_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Deterministic-product_nodes_finite"><span class="command">lemma</span></span> product_nodes_finite<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>finite <span class="main">∘</span> a.nodes<span class="main">)</span> <span class="free">AA</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>b.nodes <span class="main">(</span>product <span class="free">AA</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> list.pred_map product_nodes assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
    <span class="keyword1" id="Deterministic-product_nodes_card"><span class="command">lemma</span></span> product_nodes_card<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>finite <span class="main">∘</span> a.nodes<span class="main">)</span> <span class="free">AA</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>b.nodes <span class="main">(</span>product <span class="free">AA</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> prod_list <span class="main">(</span>map <span class="main">(</span>card <span class="main">∘</span> a.nodes<span class="main">)</span> <span class="free">AA</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>b.nodes <span class="main">(</span>product <span class="free">AA</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span>listset <span class="main">(</span>map a.nodes <span class="free">AA</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> list.pred_map product_nodes assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> card_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> prod_list <span class="main">(</span>map <span class="main">(</span>card <span class="main">∘</span> a.nodes<span class="main">)</span> <span class="free">AA</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">locale</span></span> automaton_intersection_list_run <span class="main">=</span>
    automaton_product_list
      <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span></span>
      <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span></span>
      <span class="quoted"><span class="free">condition</span></span> <span class="main">+</span>
    a<span class="main">:</span> automaton_run <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">test<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="main">+</span>
    b<span class="main">:</span> automaton_run <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">test<span class="hidden">⇩</span><sub>2</sub></span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">test<span class="hidden">⇩</span><sub>1</sub></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">test<span class="hidden">⇩</span><sub>2</sub></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">condition</span>
    <span class="main">+</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> test<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">test<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="free">condition</span> <span class="free">cs</span><span class="main">)</span> <span class="free">w</span> <span class="free">rs</span> <span class="free">ps</span> <span class="main">⟷</span>
      <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">k</span></span> <span class="main">&lt;</span> length <span class="free">cs</span><span class="main">.</span> <span class="free">test<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="free">cs</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="free">w</span> <span class="main">(</span>smap <span class="main">(</span><span class="main">λ</span> <span class="bound">ps</span><span class="main">.</span> <span class="bound">ps</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="free">rs</span><span class="main">)</span> <span class="main">(</span><span class="free">ps</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1" id="Deterministic-product_language"><span class="command">lemma</span></span> product_language<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"b.language <span class="main">(</span>product <span class="free">AA</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋂</span> <span class="main">(</span>a.language <span class="main">`</span> set <span class="free">AA</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> a.language_def b.language_def
      <span class="keyword1"><span class="command">unfolding</span></span> a.run_alt_def b.run_alt_def streams_iff_sset
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_conv_nth product_trace_smap<span class="main">)</span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">locale</span></span> automaton_union_list_run <span class="main">=</span>
    automaton_product_list
      <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span></span>
      <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span></span>
      <span class="quoted"><span class="free">condition</span></span> <span class="main">+</span>
    a<span class="main">:</span> automaton_run <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">test<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="main">+</span>
    b<span class="main">:</span> automaton_run <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">test<span class="hidden">⇩</span><sub>2</sub></span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">test<span class="hidden">⇩</span><sub>1</sub></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">test<span class="hidden">⇩</span><sub>2</sub></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">condition</span>
    <span class="main">+</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> test<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">test<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="free">condition</span> <span class="free">cs</span><span class="main">)</span> <span class="free">w</span> <span class="free">rs</span> <span class="free">ps</span> <span class="main">⟷</span>
      <span class="main">(</span><span class="main">∃</span> <span class="bound"><span class="bound">k</span></span> <span class="main">&lt;</span> length <span class="free">cs</span><span class="main">.</span> <span class="free">test<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="free">cs</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="free">w</span> <span class="main">(</span>smap <span class="main">(</span><span class="main">λ</span> <span class="bound">ps</span><span class="main">.</span> <span class="bound">ps</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="free">rs</span><span class="main">)</span> <span class="main">(</span><span class="free">ps</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1" id="Deterministic-product_language"><span class="command">lemma</span></span> product_language<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋂</span> <span class="main">(</span><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">`</span> set <span class="free">AA</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">`</span> set <span class="free">AA</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"b.language <span class="main">(</span>product <span class="free">AA</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span>a.language <span class="main">`</span> set <span class="free">AA</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">unfolding</span></span> a.language_def b.language_def
      <span class="keyword1"><span class="command">unfolding</span></span> a.run_alt_def b.run_alt_def streams_iff_sset
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_conv_nth product_trace_smap<span class="main">)</span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">locale</span></span> automaton_complement <span class="main">=</span>
    a<span class="main">:</span> automaton <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="main">+</span>
    b<span class="main">:</span> automaton <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> set <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⇒</span> <span class="tfree">'automaton<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> set <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'condition<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⇒</span> <span class="tfree">'automaton<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span>
    <span class="main">+</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">condition</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⇒</span> <span class="tfree">'condition<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1"><span class="command">definition</span></span> <span class="entity">complement</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'automaton<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⇒</span> <span class="tfree">'automaton<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">complement</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">condition</span> <span class="main">(</span><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

    <span class="keyword1" id="Deterministic-combine_simps"><span class="command">lemma</span></span> combine_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span>complement <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span>complement <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span>complement <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span>complement <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="free">condition</span> <span class="main">(</span><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> complement_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">locale</span></span> automaton_complement_path <span class="main">=</span>
    automaton_complement
      <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span></span>
      <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span></span>
      <span class="quoted"><span class="free">condition</span></span> <span class="main">+</span>
    a<span class="main">:</span> automaton_path <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">test<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="main">+</span>
    b<span class="main">:</span> automaton_path <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">test<span class="hidden">⇩</span><sub>2</sub></span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">test<span class="hidden">⇩</span><sub>1</sub></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">test<span class="hidden">⇩</span><sub>2</sub></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">condition</span>
    <span class="main">+</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> test<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">test<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="free">condition</span> <span class="free">c</span><span class="main">)</span> <span class="free">w</span> <span class="free">r</span> <span class="free">p</span> <span class="main">⟷</span> <span class="main">¬</span> <span class="free">test<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c</span> <span class="free">w</span> <span class="free">r</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1" id="Deterministic-complement_language"><span class="command">lemma</span></span> complement_language<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"b.language <span class="main">(</span>complement <span class="free">A</span><span class="main">)</span> <span class="main">=</span> lists <span class="main">(</span><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span><span class="main">)</span> <span class="main">-</span> a.language <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> a.language_def b.language_def a.path_alt_def b.path_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">locale</span></span> automaton_complement_run <span class="main">=</span>
    automaton_complement
      <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span></span>
      <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span></span>
      <span class="quoted"><span class="free">condition</span></span> <span class="main">+</span>
    a<span class="main">:</span> automaton_run <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">test<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="main">+</span>
    b<span class="main">:</span> automaton_run <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">test<span class="hidden">⇩</span><sub>2</sub></span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">test<span class="hidden">⇩</span><sub>1</sub></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">test<span class="hidden">⇩</span><sub>2</sub></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">condition</span>
    <span class="main">+</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> test<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">test<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="free">condition</span> <span class="free">c</span><span class="main">)</span> <span class="free">w</span> <span class="free">r</span> <span class="free">p</span> <span class="main">⟷</span> <span class="main">¬</span> <span class="free">test<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c</span> <span class="free">w</span> <span class="free">r</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1" id="Deterministic-complement_language"><span class="command">lemma</span></span> complement_language<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"b.language <span class="main">(</span>complement <span class="free">A</span><span class="main">)</span> <span class="main">=</span> streams <span class="main">(</span><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span><span class="main">)</span> <span class="main">-</span> a.language <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> a.language_def b.language_def a.run_alt_def b.run_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="DFA">
<div class="head">
<h1>Theory DFA</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Deterministic Finite Automata›</span></span>

<span class="keyword1"><span class="command">theory</span></span> DFA
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Deterministic.html">../Deterministic</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> dfa <span class="main">=</span> dfa
    <span class="main">(</span><span class="free"><span class="entity">alphabet</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> set"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">initial</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span>"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">transition</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span>"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">accepting</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> pred"</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">global_interpretation</span></span> dfa<span class="main">:</span> automaton <span class="quoted">dfa</span> <span class="quoted">alphabet</span> <span class="quoted">initial</span> <span class="quoted">transition</span> <span class="quoted">accepting</span>
    <span class="keyword2"><span class="keyword">defines</span></span> path <span class="main">=</span> <span class="quoted">dfa.path</span> <span class="keyword2"><span class="keyword">and</span></span> run <span class="main">=</span> <span class="quoted">dfa.run</span> <span class="keyword2"><span class="keyword">and</span></span> reachable <span class="main">=</span> <span class="quoted">dfa.reachable</span> <span class="keyword2"><span class="keyword">and</span></span> nodes <span class="main">=</span> <span class="quoted">dfa.nodes</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">global_interpretation</span></span> dfa<span class="main">:</span> automaton_path <span class="quoted">dfa</span> <span class="quoted">alphabet</span> <span class="quoted">initial</span> <span class="quoted">transition</span> <span class="quoted">accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">P</span> <span class="main">(</span>last <span class="main">(</span><span class="bound">p</span> <span class="main">#</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">defines</span></span> language <span class="main">=</span> <span class="quoted">dfa.language</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span>

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">target</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">target</span> <span class="main">≡</span> dfa.target"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">states</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">states</span> <span class="main">≡</span> dfa.states"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">trace</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">trace</span> <span class="main">≡</span> dfa.trace"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">successors</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">successors</span> <span class="main">≡</span> dfa.successors <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'label</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">global_interpretation</span></span> intersection<span class="main">:</span> automaton_intersection_path
    <span class="quoted">dfa</span> <span class="quoted">alphabet</span> <span class="quoted">initial</span> <span class="quoted">transition</span> <span class="quoted">accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">P</span> <span class="main">(</span>last <span class="main">(</span><span class="bound">p</span> <span class="main">#</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted">dfa</span> <span class="quoted">alphabet</span> <span class="quoted">initial</span> <span class="quoted">transition</span> <span class="quoted">accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">P</span> <span class="main">(</span>last <span class="main">(</span><span class="bound">p</span> <span class="main">#</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted">dfa</span> <span class="quoted">alphabet</span> <span class="quoted">initial</span> <span class="quoted">transition</span> <span class="quoted">accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">P</span> <span class="main">(</span>last <span class="main">(</span><span class="bound">p</span> <span class="main">#</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">.</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">p</span> <span class="main">∧</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">defines</span></span> intersect <span class="main">=</span> <span class="quoted">intersection.product</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zip_eq_Nil_iff<span class="main">)</span>

  <span class="keyword1"><span class="command">global_interpretation</span></span> union<span class="main">:</span> automaton_union_path
    <span class="quoted">dfa</span> <span class="quoted">alphabet</span> <span class="quoted">initial</span> <span class="quoted">transition</span> <span class="quoted">accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">P</span> <span class="main">(</span>last <span class="main">(</span><span class="bound">p</span> <span class="main">#</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted">dfa</span> <span class="quoted">alphabet</span> <span class="quoted">initial</span> <span class="quoted">transition</span> <span class="quoted">accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">P</span> <span class="main">(</span>last <span class="main">(</span><span class="bound">p</span> <span class="main">#</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted">dfa</span> <span class="quoted">alphabet</span> <span class="quoted">initial</span> <span class="quoted">transition</span> <span class="quoted">accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">P</span> <span class="main">(</span>last <span class="main">(</span><span class="bound">p</span> <span class="main">#</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">.</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">p</span> <span class="main">∨</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">defines</span></span> union <span class="main">=</span> <span class="quoted">union.product</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zip_eq_Nil_iff<span class="main">)</span>

  <span class="keyword1"><span class="command">global_interpretation</span></span> complement<span class="main">:</span> automaton_complement_path
    <span class="quoted">dfa</span> <span class="quoted">alphabet</span> <span class="quoted">initial</span> <span class="quoted">transition</span> <span class="quoted">accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">P</span> <span class="main">(</span>last <span class="main">(</span><span class="bound">p</span> <span class="main">#</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted">dfa</span> <span class="quoted">alphabet</span> <span class="quoted">initial</span> <span class="quoted">transition</span> <span class="quoted">accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">P</span> <span class="main">(</span>last <span class="main">(</span><span class="bound">p</span> <span class="main">#</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">c</span> <span class="bound">p</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">c</span> <span class="bound">p</span>"</span></span>
    <span class="keyword2"><span class="keyword">defines</span></span> complement <span class="main">=</span> <span class="quoted">complement.complement</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Nondeterministic">
<div class="head">
<h1>Theory Nondeterministic</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Nondeterministic Automata›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Nondeterministic
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="Transition_System.html">../Transition_Systems/Transition_System</a>"</span>
  <span class="quoted">"<a href="Transition_System_Extra.html">../Transition_Systems/Transition_System_Extra</a>"</span>
  <span class="quoted">"<a href="Transition_System_Construction.html">../Transition_Systems/Transition_System_Construction</a>"</span>
  <span class="quoted">"<a href="Degeneralization.html">../Basic/Degeneralization</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">locale</span></span> automaton <span class="main">=</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">automaton</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> set <span class="main">⇒</span> <span class="tfree">'state</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'condition</span> <span class="main">⇒</span> <span class="tfree">'automaton</span>"</span></span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">alphabet</span> <span class="free">initial</span> <span class="free">transition</span> <span class="free">condition</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> automaton<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">automaton</span> <span class="main">(</span><span class="free">alphabet</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">initial</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">transition</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">condition</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> alphabet<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">alphabet</span> <span class="main">(</span><span class="free">automaton</span> <span class="free">a</span> <span class="free">i</span> <span class="free">t</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> initial<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">initial</span> <span class="main">(</span><span class="free">automaton</span> <span class="free">a</span> <span class="free">i</span> <span class="free">t</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> transition<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">transition</span> <span class="main">(</span><span class="free">automaton</span> <span class="free">a</span> <span class="free">i</span> <span class="free">t</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> condition<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">condition</span> <span class="main">(</span><span class="free">automaton</span> <span class="free">a</span> <span class="free">i</span> <span class="free">t</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1"><span class="command">sublocale</span></span> transition_system_initial
      <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">.</span> snd <span class="bound">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">.</span> fst <span class="bound">a</span> <span class="main">∈</span> <span class="free">alphabet</span> <span class="free">A</span> <span class="main">∧</span> snd <span class="bound">a</span> <span class="main">∈</span> <span class="free">transition</span> <span class="free">A</span> <span class="main">(</span>fst <span class="bound">a</span><span class="main">)</span> <span class="bound">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free">initial</span> <span class="free">A</span>"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="free">A</span>
      <span class="keyword2"><span class="keyword">defines</span></span> path' <span class="main">=</span> <span class="quoted">path</span> <span class="keyword2"><span class="keyword">and</span></span> run' <span class="main">=</span> <span class="quoted">run</span> <span class="keyword2"><span class="keyword">and</span></span> reachable' <span class="main">=</span> <span class="quoted">reachable</span> <span class="keyword2"><span class="keyword">and</span></span> nodes' <span class="main">=</span> <span class="quoted">nodes</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>

    <span class="keyword1" id="Nondeterministic-states_alt_def"><span class="command">lemma</span></span> states_alt_def<span class="main">:</span> <span class="quoted"><span class="quoted">"states <span class="free">r</span> <span class="free">p</span> <span class="main">=</span> map snd <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1" id="Nondeterministic-trace_alt_def"><span class="command">lemma</span></span> trace_alt_def<span class="main">:</span> <span class="quoted"><span class="quoted">"trace <span class="free">r</span> <span class="free">p</span> <span class="main">=</span> smap snd <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

    <span class="keyword1" id="Nondeterministic-successors_alt_def"><span class="command">lemma</span></span> successors_alt_def<span class="main">:</span> <span class="quoted"><span class="quoted">"successors <span class="free">A</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">alphabet</span> <span class="free">A</span><span class="main">.</span> <span class="free">transition</span> <span class="free">A</span> <span class="bound">a</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1" id="Nondeterministic-reachable_transition"><span class="command">lemma</span></span> reachable_transition<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="free">alphabet</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> reachable <span class="free">A</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> <span class="free">transition</span> <span class="free">A</span> <span class="free">a</span> <span class="free">q</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> reachable <span class="free">A</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> reachable.execute assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1" id="Nondeterministic-nodes_transition"><span class="command">lemma</span></span> nodes_transition<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="free">alphabet</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> nodes <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> <span class="free">transition</span> <span class="free">A</span> <span class="free">a</span> <span class="free">p</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> nodes <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> nodes.execute assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

    <span class="keyword1" id="Nondeterministic-path_alphabet"><span class="command">lemma</span></span> path_alphabet<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">r</span> <span class="main">=</span> length <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"path <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">||</span> <span class="free">r</span><span class="main">)</span> <span class="free">p</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> lists <span class="main">(</span><span class="free">alphabet</span> <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1" id="Nondeterministic-run_alphabet"><span class="command">lemma</span></span> run_alphabet<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"run <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> <span class="free">r</span><span class="main">)</span> <span class="free">p</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> streams <span class="main">(</span><span class="free">alphabet</span> <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> run.cases stream.map szip_smap szip_smap_fst<span class="main">)</span>

    <span class="keyword1"><span class="command">definition</span></span> <span class="entity">restrict</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'automaton</span> <span class="main">⇒</span> <span class="tfree">'automaton</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">restrict</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="free">automaton</span>
        <span class="main">(</span><span class="free">alphabet</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>
        <span class="main">(</span><span class="free">initial</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>
        <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">alphabet</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">then</span> <span class="free">transition</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">a</span> <span class="bound">p</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>
        <span class="main">(</span><span class="free">condition</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>

    <span class="keyword1" id="Nondeterministic-restrict_simps"><span class="command">lemma</span></span> restrict_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="free">alphabet</span> <span class="main">(</span>restrict <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="free">alphabet</span> <span class="free">A</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">initial</span> <span class="main">(</span>restrict <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="free">initial</span> <span class="free">A</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">transition</span> <span class="main">(</span>restrict <span class="free">A</span><span class="main">)</span> <span class="free">a</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">a</span> <span class="main">∈</span> <span class="free">alphabet</span> <span class="free">A</span> <span class="keyword1">then</span> <span class="free">transition</span> <span class="free">A</span> <span class="free">a</span> <span class="free">p</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">condition</span> <span class="main">(</span>restrict <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="free">condition</span> <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> restrict_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1" id="Nondeterministic-restrict_path"><span class="command">lemma</span></span> restrict_path<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="main">(</span>restrict <span class="free">A</span><span class="main">)</span> <span class="main">=</span> path <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> ext iffI<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"path <span class="free">A</span> <span class="skolem">wr</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"path <span class="main">(</span>restrict <span class="free">A</span><span class="main">)</span> <span class="skolem">wr</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">wr</span> <span class="skolem">p</span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"path <span class="main">(</span>restrict <span class="free">A</span><span class="main">)</span> <span class="skolem">wr</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"path <span class="free">A</span> <span class="skolem">wr</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">wr</span> <span class="skolem">p</span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1" id="Nondeterministic-restrict_run"><span class="command">lemma</span></span> restrict_run<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"run <span class="main">(</span>restrict <span class="free">A</span><span class="main">)</span> <span class="main">=</span> run <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> ext iffI<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"run <span class="free">A</span> <span class="skolem">wr</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"run <span class="main">(</span>restrict <span class="free">A</span><span class="main">)</span> <span class="skolem">wr</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">wr</span> <span class="skolem">p</span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">coinduct</span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"run <span class="main">(</span>restrict <span class="free">A</span><span class="main">)</span> <span class="skolem">wr</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"run <span class="free">A</span> <span class="skolem">wr</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">wr</span> <span class="skolem">p</span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">coinduct</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">locale</span></span> automaton_path <span class="main">=</span>
    automaton <span class="quoted"><span class="free">automaton</span></span> <span class="quoted"><span class="free">alphabet</span></span> <span class="quoted"><span class="free">initial</span></span> <span class="quoted"><span class="free">transition</span></span> <span class="quoted"><span class="free">condition</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">automaton</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> set <span class="main">⇒</span> <span class="tfree">'state</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'condition</span> <span class="main">⇒</span> <span class="tfree">'automaton</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">alphabet</span> <span class="free">initial</span> <span class="free">transition</span> <span class="free">condition</span>
    <span class="main">+</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">test</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'condition</span> <span class="main">⇒</span> <span class="tfree">'label</span> list <span class="main">⇒</span> <span class="tfree">'state</span> list <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1"><span class="command">definition</span></span> <span class="entity">language</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'automaton</span> <span class="main">⇒</span> <span class="tfree">'label</span> list set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">language</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">w</span> <span class="main">|</span><span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> length <span class="bound">r</span> <span class="main">=</span> length <span class="bound">w</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free">initial</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∧</span> path <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span><span class="bound">w</span> <span class="main">||</span> <span class="bound">r</span><span class="main">)</span> <span class="bound">p</span> <span class="main">∧</span> <span class="free">test</span> <span class="main">(</span><span class="free">condition</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">}</span>"</span></span>

    <span class="keyword1" id="Nondeterministic-language"><span class="command">lemma</span></span> language<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">r</span> <span class="main">=</span> length <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="free">initial</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"path <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">||</span> <span class="free">r</span><span class="main">)</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">test</span> <span class="main">(</span><span class="free">condition</span> <span class="free">A</span><span class="main">)</span> <span class="free">w</span> <span class="free">r</span> <span class="free">p</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> language <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> language_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1" id="Nondeterministic-language_elim"><span class="command">lemma</span></span> language_elim<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> language <span class="free">A</span>"</span></span>
      <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">r</span> <span class="free">p</span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"length <span class="free">r</span> <span class="main">=</span> length <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="free">initial</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"path <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">||</span> <span class="free">r</span><span class="main">)</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">test</span> <span class="main">(</span><span class="free">condition</span> <span class="free">A</span><span class="main">)</span> <span class="free">w</span> <span class="free">r</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> language_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1" id="Nondeterministic-language_alphabet"><span class="command">lemma</span></span> language_alphabet<span class="main">:</span> <span class="quoted"><span class="quoted">"language <span class="free">A</span> <span class="main">⊆</span> lists <span class="main">(</span><span class="free">alphabet</span> <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> path_alphabet<span class="main">)</span>

    <span class="keyword1" id="Nondeterministic-restrict_language"><span class="command">lemma</span></span> restrict_language<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"language <span class="main">(</span>restrict <span class="free">A</span><span class="main">)</span> <span class="main">=</span> language <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">locale</span></span> automaton_run <span class="main">=</span>
    automaton <span class="quoted"><span class="free">automaton</span></span> <span class="quoted"><span class="free">alphabet</span></span> <span class="quoted"><span class="free">initial</span></span> <span class="quoted"><span class="free">transition</span></span> <span class="quoted"><span class="free">condition</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">automaton</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> set <span class="main">⇒</span> <span class="tfree">'state</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'condition</span> <span class="main">⇒</span> <span class="tfree">'automaton</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">alphabet</span> <span class="free">initial</span> <span class="free">transition</span> <span class="free">condition</span>
    <span class="main">+</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">test</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'condition</span> <span class="main">⇒</span> <span class="tfree">'label</span> stream <span class="main">⇒</span> <span class="tfree">'state</span> stream <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1"><span class="command">definition</span></span> <span class="entity">language</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'automaton</span> <span class="main">⇒</span> <span class="tfree">'label</span> stream set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">language</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">w</span> <span class="main">|</span><span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free">initial</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∧</span> run <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span><span class="bound">w</span> <span class="main">|||</span> <span class="bound">r</span><span class="main">)</span> <span class="bound">p</span> <span class="main">∧</span> <span class="free">test</span> <span class="main">(</span><span class="free">condition</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">}</span>"</span></span>

    <span class="keyword1" id="Nondeterministic-language"><span class="command">lemma</span></span> language<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="free">initial</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"run <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> <span class="free">r</span><span class="main">)</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">test</span> <span class="main">(</span><span class="free">condition</span> <span class="free">A</span><span class="main">)</span> <span class="free">w</span> <span class="free">r</span> <span class="free">p</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> language <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> language_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1" id="Nondeterministic-language_elim"><span class="command">lemma</span></span> language_elim<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> language <span class="free">A</span>"</span></span>
      <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">r</span> <span class="free">p</span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∈</span> <span class="free">initial</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"run <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> <span class="free">r</span><span class="main">)</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">test</span> <span class="main">(</span><span class="free">condition</span> <span class="free">A</span><span class="main">)</span> <span class="free">w</span> <span class="free">r</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> language_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1" id="Nondeterministic-language_alphabet"><span class="command">lemma</span></span> language_alphabet<span class="main">:</span> <span class="quoted"><span class="quoted">"language <span class="free">A</span> <span class="main">⊆</span> streams <span class="main">(</span><span class="free">alphabet</span> <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> run_alphabet<span class="main">)</span>

    <span class="keyword1" id="Nondeterministic-restrict_language"><span class="command">lemma</span></span> restrict_language<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"language <span class="main">(</span>restrict <span class="free">A</span><span class="main">)</span> <span class="main">=</span> language <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">locale</span></span> automaton_degeneralization <span class="main">=</span>
    a<span class="main">:</span> automaton <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="main">+</span>
    b<span class="main">:</span> automaton <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> set <span class="main">⇒</span> <span class="tfree">'state</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'item</span> pred gen <span class="main">⇒</span> <span class="tfree">'automaton<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> set <span class="main">⇒</span> <span class="tfree">'state</span> degen set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state</span> degen <span class="main">⇒</span> <span class="tfree">'state</span> degen set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'item_degen</span> pred <span class="main">⇒</span> <span class="tfree">'automaton<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span>
    <span class="main">+</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">item</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">×</span> <span class="tfree">'label</span> <span class="main">×</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'item</span>"</span></span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">translate</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'item_degen</span> <span class="main">⇒</span> <span class="tfree">'item</span> degen"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1"><span class="command">definition</span></span> <span class="entity">degeneralize</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'automaton<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⇒</span> <span class="tfree">'automaton<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">degeneralize</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span>
        <span class="main">(</span><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>
        <span class="main">(</span><span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span>
        <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">k</span><span class="main">)</span><span class="main">.</span> <span class="main">{</span><span class="main">(</span><span class="bound">q</span><span class="main">,</span> count <span class="main">(</span><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">item</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="bound">k</span><span class="main">)</span> <span class="main">|</span><span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> <span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">a</span> <span class="bound">p</span><span class="main">}</span><span class="main">)</span>
        <span class="main">(</span>degen <span class="main">(</span><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">∘</span> <span class="free">translate</span><span class="main">)</span>"</span></span>

    <span class="keyword1" id="Nondeterministic-degeneralize_simps"><span class="command">lemma</span></span> degeneralize_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span>degeneralize <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span>degeneralize <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span>degeneralize <span class="free">A</span><span class="main">)</span> <span class="free">a</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">{</span><span class="main">(</span><span class="bound">q</span><span class="main">,</span> count <span class="main">(</span><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">item</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">a</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span> <span class="main">|</span><span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> <span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span> <span class="free">a</span> <span class="free">p</span><span class="main">}</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span>degeneralize <span class="free">A</span><span class="main">)</span> <span class="main">=</span> degen <span class="main">(</span><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span><span class="main">)</span> <span class="main">∘</span> <span class="free">translate</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> degeneralize_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1" id="Nondeterministic-run_degeneralize"><span class="command">lemma</span></span> run_degeneralize<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"a.run <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> <span class="free">r</span><span class="main">)</span> <span class="free">p</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"b.run <span class="main">(</span>degeneralize <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> <span class="free">r</span> <span class="main">|||</span> sscan <span class="main">(</span>count <span class="main">(</span><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span><span class="main">)</span> <span class="main">∘</span> <span class="free">item</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">##</span> <span class="free">r</span> <span class="main">|||</span> <span class="free">w</span> <span class="main">|||</span> <span class="free">r</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> a.run.cases<span class="main">)</span>
    <span class="keyword1" id="Nondeterministic-degeneralize_run"><span class="command">lemma</span></span> degeneralize_run<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"b.run <span class="main">(</span>degeneralize <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> <span class="free">rs</span><span class="main">)</span> <span class="free">pk</span>"</span></span>
      <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">r</span> <span class="free">s</span> <span class="free">p</span> <span class="free">k</span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">=</span> <span class="free">r</span> <span class="main">|||</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">pk</span> <span class="main">=</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"a.run <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> <span class="free">r</span><span class="main">)</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> sscan <span class="main">(</span>count <span class="main">(</span><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span><span class="main">)</span> <span class="main">∘</span> <span class="free">item</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">##</span> <span class="free">r</span> <span class="main">|||</span> <span class="free">w</span> <span class="main">|||</span> <span class="free">r</span><span class="main">)</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">=</span> <span class="skolem">r</span> <span class="main">|||</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">pk</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> szip_smap surjective_pairing <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">=</span> <span class="skolem">r</span> <span class="main">|||</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">pk</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"a.run <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">p</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="skolem">r</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> b.run.cases<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> sscan <span class="main">(</span>count <span class="main">(</span><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span><span class="main">)</span> <span class="main">∘</span> <span class="free">item</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">##</span> <span class="skolem">r</span> <span class="main">|||</span> <span class="free">w</span> <span class="main">|||</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">k</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="skolem">r</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">erule</span> b.run.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Nondeterministic-degeneralize_nodes"><span class="command">lemma</span></span> degeneralize_nodes<span class="main">:</span>
      <span class="quoted"><span class="quoted">"b.nodes <span class="main">(</span>degeneralize <span class="free">A</span><span class="main">)</span> <span class="main">⊆</span> a.nodes <span class="free">A</span> <span class="main">×</span> insert <span class="main">0</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> length <span class="main">(</span><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">pk</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pk</span> <span class="main">∈</span> b.nodes <span class="main">(</span>degeneralize <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pk</span> <span class="main">∈</span> a.nodes <span class="free">A</span> <span class="main">×</span> insert <span class="main">0</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> length <span class="main">(</span><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span><span class="main">)</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1" id="Nondeterministic-nodes_degeneralize"><span class="command">lemma</span></span> nodes_degeneralize<span class="main">:</span> <span class="quoted"><span class="quoted">"a.nodes <span class="free">A</span> <span class="main">⊆</span> fst <span class="main">`</span> b.nodes <span class="main">(</span>degeneralize <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> a.nodes <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> fst <span class="main">`</span> b.nodes <span class="main">(</span>degeneralize <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>initial <span class="skolem">p</span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">∈</span> b.nodes <span class="main">(</span>degeneralize <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> initial <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> image_iff fst_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>execute <span class="skolem">p</span> <span class="skolem">aq</span><span class="main">)</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">∈</span> b.nodes <span class="main">(</span>degeneralize <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> execute<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>snd <span class="skolem">aq</span><span class="main">,</span> count <span class="main">(</span><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">item</span> <span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">aq</span><span class="main">)</span><span class="main">)</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">∈</span> b.nodes <span class="main">(</span>degeneralize <span class="free">A</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> execute<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> image_iff snd_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Nondeterministic-degeneralize_nodes_finite"><span class="command">lemma</span></span> degeneralize_nodes_finite<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>b.nodes <span class="main">(</span>degeneralize <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> finite <span class="main">(</span>a.nodes <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>a.nodes <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>b.nodes <span class="main">(</span>degeneralize <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> finite_subset nodes_degeneralize that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>b.nodes <span class="main">(</span>degeneralize <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>a.nodes <span class="free">A</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> finite_subset degeneralize_nodes that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">locale</span></span> automaton_degeneralization_run <span class="main">=</span>
    automaton_degeneralization
      <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span></span>
      <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span></span>
      <span class="quoted"><span class="free">item</span></span> <span class="quoted"><span class="free">translate</span></span> <span class="main">+</span>
    a<span class="main">:</span> automaton_run <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">test<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="main">+</span>
    b<span class="main">:</span> automaton_run <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">test<span class="hidden">⇩</span><sub>2</sub></span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">test<span class="hidden">⇩</span><sub>1</sub></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">test<span class="hidden">⇩</span><sub>2</sub></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">item</span> <span class="free">translate</span>
    <span class="main">+</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> test<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">test<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span>degen <span class="free">cs</span> <span class="main">∘</span> <span class="free">translate</span><span class="main">)</span> <span class="free">w</span>
      <span class="main">(</span><span class="free">r</span> <span class="main">|||</span> sscan <span class="main">(</span>count <span class="free">cs</span> <span class="main">∘</span> <span class="free">item</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">##</span> <span class="free">r</span> <span class="main">|||</span> <span class="free">w</span> <span class="main">|||</span> <span class="free">r</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">test<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">cs</span> <span class="free">w</span> <span class="free">r</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1" id="Nondeterministic-degeneralize_language"><span class="command">lemma</span></span> degeneralize_language<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"b.language <span class="main">(</span>degeneralize <span class="free">A</span><span class="main">)</span> <span class="main">=</span> a.language <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> a.language_def b.language_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> run_degeneralize <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> degeneralize_run<span class="main">)</span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">locale</span></span> automaton_product <span class="main">=</span>
    a<span class="main">:</span> automaton <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="main">+</span>
    b<span class="main">:</span> automaton <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="main">+</span>
    c<span class="main">:</span> automaton <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>3</sub></span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> set <span class="main">⇒</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>1</sub></span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⇒</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>1</sub></span> set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⇒</span> <span class="tfree">'automaton<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> set <span class="main">⇒</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>2</sub></span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⇒</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>2</sub></span> set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'condition<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⇒</span> <span class="tfree">'automaton<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'state<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">×</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">×</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'state<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">×</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'condition<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">⇒</span> <span class="tfree">'automaton<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>3</sub></span>
    <span class="main">+</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">condition</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⇒</span> <span class="tfree">'condition<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⇒</span> <span class="tfree">'condition<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1"><span class="command">definition</span></span> <span class="entity">product</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'automaton<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⇒</span> <span class="tfree">'automaton<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⇒</span> <span class="tfree">'automaton<span class="hidden">⇩</span><sub>3</sub></span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">product</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> <span class="free">automaton<span class="hidden">⇩</span><sub>3</sub></span>
        <span class="main">(</span><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∩</span> <span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span>
        <span class="main">(</span><span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">×</span> <span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span>
        <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">.</span> <span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">a</span> <span class="bound">p</span> <span class="main">×</span> <span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="bound">a</span> <span class="bound">q</span><span class="main">)</span>
        <span class="main">(</span><span class="free">condition</span> <span class="main">(</span><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

    <span class="keyword1" id="Nondeterministic-product_simps"><span class="command">lemma</span></span> product_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="free">alphabet<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">(</span>product <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span> <span class="main">∩</span> <span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">initial<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">(</span>product <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span> <span class="main">×</span> <span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">transition<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">(</span>product <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="free">a</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span> <span class="free">a</span> <span class="free">p</span> <span class="main">×</span> <span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B</span> <span class="free">a</span> <span class="free">q</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">condition<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">(</span>product <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="free">condition</span> <span class="main">(</span><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> product_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1" id="Nondeterministic-product_target"><span class="command">lemma</span></span> product_target<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">w</span> <span class="main">=</span> length <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">r</span> <span class="main">=</span> length <span class="free">s</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"c.target <span class="main">(</span><span class="free">w</span> <span class="main">||</span> <span class="free">r</span> <span class="main">||</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>a.target <span class="main">(</span><span class="free">w</span> <span class="main">||</span> <span class="free">r</span><span class="main">)</span> <span class="free">p</span><span class="main">,</span> b.target <span class="main">(</span><span class="free">w</span> <span class="main">||</span> <span class="free">s</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct3<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

    <span class="keyword1" id="Nondeterministic-product_path"><span class="command">lemma</span></span> product_path<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">w</span> <span class="main">=</span> length <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">r</span> <span class="main">=</span> length <span class="free">s</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"c.path <span class="main">(</span>product <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">||</span> <span class="free">r</span> <span class="main">||</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span> <span class="main">⟷</span>
        a.path <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">||</span> <span class="free">r</span><span class="main">)</span> <span class="free">p</span> <span class="main">∧</span> b.path <span class="free">B</span> <span class="main">(</span><span class="free">w</span> <span class="main">||</span> <span class="free">s</span><span class="main">)</span> <span class="free">q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct3<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1" id="Nondeterministic-product_run"><span class="command">lemma</span></span> product_run<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"c.run <span class="main">(</span>product <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> <span class="free">r</span> <span class="main">|||</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span> <span class="main">⟷</span>
      a.run <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> <span class="free">r</span><span class="main">)</span> <span class="free">p</span> <span class="main">∧</span> b.run <span class="free">B</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> <span class="free">s</span><span class="main">)</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"a.run <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> <span class="free">r</span><span class="main">)</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"c.run <span class="main">(</span>product <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> <span class="free">r</span> <span class="main">|||</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">q</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> c.run.cases<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"b.run <span class="free">B</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> <span class="free">s</span><span class="main">)</span> <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"c.run <span class="main">(</span>product <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> <span class="free">r</span> <span class="main">|||</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">q</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> c.run.cases<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"c.run <span class="main">(</span>product <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> <span class="free">r</span> <span class="main">|||</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"a.run <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> <span class="free">r</span><span class="main">)</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"b.run <span class="free">B</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> <span class="free">s</span><span class="main">)</span> <span class="free">q</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">q</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> a.run.cases b.run.cases<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Nondeterministic-product_nodes"><span class="command">lemma</span></span> product_nodes<span class="main">:</span> <span class="quoted"><span class="quoted">"c.nodes <span class="main">(</span>product <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">⊆</span> a.nodes <span class="free">A</span> <span class="main">×</span> b.nodes <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">pq</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pq</span> <span class="main">∈</span> c.nodes <span class="main">(</span>product <span class="free">A</span> <span class="free">B</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pq</span> <span class="main">∈</span> a.nodes <span class="free">A</span> <span class="main">×</span> b.nodes <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Nondeterministic-product_nodes_finite"><span class="command">lemma</span></span> product_nodes_finite<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>a.nodes <span class="free">A</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>b.nodes <span class="free">B</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>c.nodes <span class="main">(</span>product <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> finite_subset product_nodes assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">locale</span></span> automaton_intersection_path <span class="main">=</span>
    automaton_product
      <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span></span>
      <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span></span>
      <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>3</sub></span></span>
      <span class="quoted"><span class="free">condition</span></span> <span class="main">+</span>
    a<span class="main">:</span> automaton_path <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">test<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="main">+</span>
    b<span class="main">:</span> automaton_path <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">test<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="main">+</span>
    c<span class="main">:</span> automaton_path <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">test<span class="hidden">⇩</span><sub>3</sub></span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">test<span class="hidden">⇩</span><sub>1</sub></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">test<span class="hidden">⇩</span><sub>2</sub></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">test<span class="hidden">⇩</span><sub>3</sub></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">condition</span>
    <span class="main">+</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> test<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">r</span> <span class="main">=</span> length <span class="free">w</span> <span class="main">⟹</span> length <span class="free">s</span> <span class="main">=</span> length <span class="free">w</span> <span class="main">⟹</span>
      <span class="free">test<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">(</span><span class="free">condition</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">w</span> <span class="main">(</span><span class="free">r</span> <span class="main">||</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">test<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">w</span> <span class="free">r</span> <span class="free">p</span> <span class="main">∧</span> <span class="free">test<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">w</span> <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1" id="Nondeterministic-product_language"><span class="command">lemma</span></span> product_language<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"c.language <span class="main">(</span>product <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> a.language <span class="free">A</span> <span class="main">∩</span> b.language <span class="free">B</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> a.language_def b.language_def c.language_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> split_zip<span class="main">)</span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">locale</span></span> automaton_intersection_run <span class="main">=</span>
    automaton_product
      <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span></span>
      <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span></span>
      <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>3</sub></span></span>
      <span class="quoted"><span class="free">condition</span></span> <span class="main">+</span>
    a<span class="main">:</span> automaton_run <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">test<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="main">+</span>
    b<span class="main">:</span> automaton_run <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">test<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="main">+</span>
    c<span class="main">:</span> automaton_run <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">test<span class="hidden">⇩</span><sub>3</sub></span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">test<span class="hidden">⇩</span><sub>1</sub></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">test<span class="hidden">⇩</span><sub>2</sub></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">test<span class="hidden">⇩</span><sub>3</sub></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">condition</span>
    <span class="main">+</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> test<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">test<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">(</span><span class="free">condition</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">w</span> <span class="main">(</span><span class="free">r</span> <span class="main">|||</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">test<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">w</span> <span class="free">r</span> <span class="free">p</span> <span class="main">∧</span> <span class="free">test<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">w</span> <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1" id="Nondeterministic-product_language"><span class="command">lemma</span></span> product_language<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"c.language <span class="main">(</span>product <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> a.language <span class="free">A</span> <span class="main">∩</span> b.language <span class="free">B</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> a.language_def b.language_def c.language_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> split_szip<span class="main">)</span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">locale</span></span> automaton_sum <span class="main">=</span>
    a<span class="main">:</span> automaton <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="main">+</span>
    b<span class="main">:</span> automaton <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="main">+</span>
    c<span class="main">:</span> automaton <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>3</sub></span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> set <span class="main">⇒</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>1</sub></span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⇒</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>1</sub></span> set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⇒</span> <span class="tfree">'automaton<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> set <span class="main">⇒</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>2</sub></span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⇒</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>2</sub></span> set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'condition<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⇒</span> <span class="tfree">'automaton<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'state<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">+</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">+</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'state<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">+</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'condition<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">⇒</span> <span class="tfree">'automaton<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>3</sub></span>
    <span class="main">+</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">condition</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⇒</span> <span class="tfree">'condition<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⇒</span> <span class="tfree">'condition<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1"><span class="command">definition</span></span> <span class="entity">sum</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'automaton<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⇒</span> <span class="tfree">'automaton<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⇒</span> <span class="tfree">'automaton<span class="hidden">⇩</span><sub>3</sub></span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">sum</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> <span class="free">automaton<span class="hidden">⇩</span><sub>3</sub></span>
        <span class="main">(</span><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∪</span> <span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span>
        <span class="main">(</span><span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">&lt;+&gt;</span> <span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span>
        <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span><span class="main">.</span> <span class="main">λ</span> Inl <span class="bound">p</span> <span class="main">⇒</span> Inl <span class="main">`</span> <span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">a</span> <span class="bound">p</span> <span class="main">|</span> Inr <span class="bound">q</span> <span class="main">⇒</span> Inr <span class="main">`</span> <span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="bound">a</span> <span class="bound">q</span><span class="main">)</span>
        <span class="main">(</span><span class="free">condition</span> <span class="main">(</span><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

    <span class="keyword1" id="Nondeterministic-sum_simps"><span class="command">lemma</span></span> sum_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="free">alphabet<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">(</span>sum <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span> <span class="main">∪</span> <span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">initial<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">(</span>sum <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span> <span class="main">&lt;+&gt;</span> <span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">transition<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">(</span>sum <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="free">a</span> <span class="main">(</span>Inl <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Inl <span class="main">`</span> <span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span> <span class="free">a</span> <span class="free">p</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">transition<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">(</span>sum <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="free">a</span> <span class="main">(</span>Inr <span class="free">q</span><span class="main">)</span> <span class="main">=</span> Inr <span class="main">`</span> <span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B</span> <span class="free">a</span> <span class="free">q</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">condition<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">(</span>sum <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="free">condition</span> <span class="main">(</span><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> sum_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1" id="Nondeterministic-path_sum_a"><span class="command">lemma</span></span> path_sum_a<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">r</span> <span class="main">=</span> length <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"a.path <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">||</span> <span class="free">r</span><span class="main">)</span> <span class="free">p</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"c.path <span class="main">(</span>sum <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">||</span> map Inl <span class="free">r</span><span class="main">)</span> <span class="main">(</span>Inl <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1" id="Nondeterministic-path_sum_b"><span class="command">lemma</span></span> path_sum_b<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">s</span> <span class="main">=</span> length <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"b.path <span class="free">B</span> <span class="main">(</span><span class="free">w</span> <span class="main">||</span> <span class="free">s</span><span class="main">)</span> <span class="free">q</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"c.path <span class="main">(</span>sum <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">||</span> map Inr <span class="free">s</span><span class="main">)</span> <span class="main">(</span>Inr <span class="free">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1" id="Nondeterministic-sum_path"><span class="command">lemma</span></span> sum_path<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span> <span class="main">=</span> <span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">rs</span> <span class="main">=</span> length <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"c.path <span class="main">(</span>sum <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">||</span> <span class="free">rs</span><span class="main">)</span> <span class="free">pq</span>"</span></span>
      <span class="keyword2"><span class="keyword">obtains</span></span>
        <span class="main">(</span>a<span class="main">)</span> <span class="free">r</span> <span class="free">p</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">=</span> map Inl <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">pq</span> <span class="main">=</span> Inl <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"a.path <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">||</span> <span class="free">r</span><span class="main">)</span> <span class="free">p</span>"</span></span> <span class="main">|</span>
        <span class="main">(</span>b<span class="main">)</span> <span class="free">s</span> <span class="free">q</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">=</span> map Inr <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">pq</span> <span class="main">=</span> Inr <span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"b.path <span class="free">B</span> <span class="main">(</span><span class="free">w</span> <span class="main">||</span> <span class="free">s</span><span class="main">)</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">pq</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inl <span class="skolem">p</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">=</span> map Inl <span class="main">(</span>map projl <span class="free">rs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span> 3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> Inl <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">p</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"a.path <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">||</span> map projl <span class="free">rs</span><span class="main">)</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span> 1<span class="main">,</span> 3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> Inl <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">p</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> a 1 Inl 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inr <span class="skolem">q</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">=</span> map Inr <span class="main">(</span>map projr <span class="free">rs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span> 3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> Inr <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">q</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"b.path <span class="free">B</span> <span class="main">(</span><span class="free">w</span> <span class="main">||</span> map projr <span class="free">rs</span><span class="main">)</span> <span class="skolem">q</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span> 1<span class="main">,</span> 3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> Inr <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">q</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> b 1 Inr 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Nondeterministic-run_sum_a"><span class="command">lemma</span></span> run_sum_a<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"a.run <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> <span class="free">r</span><span class="main">)</span> <span class="free">p</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"c.run <span class="main">(</span>sum <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> smap Inl <span class="free">r</span><span class="main">)</span> <span class="main">(</span>Inl <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> a.run.cases<span class="main">)</span>
    <span class="keyword1" id="Nondeterministic-run_sum_b"><span class="command">lemma</span></span> run_sum_b<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"b.run <span class="free">B</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> <span class="free">s</span><span class="main">)</span> <span class="free">q</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"c.run <span class="main">(</span>sum <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> smap Inr <span class="free">s</span><span class="main">)</span> <span class="main">(</span>Inr <span class="free">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">q</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> b.run.cases<span class="main">)</span>
    <span class="keyword1" id="Nondeterministic-sum_run"><span class="command">lemma</span></span> sum_run<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span> <span class="main">=</span> <span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"c.run <span class="main">(</span>sum <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> <span class="free">rs</span><span class="main">)</span> <span class="free">pq</span>"</span></span>
      <span class="keyword2"><span class="keyword">obtains</span></span>
        <span class="main">(</span>a<span class="main">)</span> <span class="free">r</span> <span class="free">p</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">=</span> smap Inl <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">pq</span> <span class="main">=</span> Inl <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"a.run <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> <span class="free">r</span><span class="main">)</span> <span class="free">p</span>"</span></span> <span class="main">|</span>
        <span class="main">(</span>b<span class="main">)</span> <span class="free">s</span> <span class="free">q</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">=</span> smap Inr <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">pq</span> <span class="main">=</span> Inr <span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"b.run <span class="free">B</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> <span class="free">s</span><span class="main">)</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">pq</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inl <span class="skolem">p</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">=</span> smap Inl <span class="main">(</span>smap projl <span class="free">rs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> Inl <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">rs</span></span> <span class="quoted"><span class="skolem">p</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> c.run.cases<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"a.run <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> smap projl <span class="free">rs</span><span class="main">)</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> Inl <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">rs</span></span> <span class="quoted"><span class="skolem">p</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> c.run.cases<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> a 1 Inl 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inr <span class="skolem">q</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rs</span> <span class="main">=</span> smap Inr <span class="main">(</span>smap projr <span class="free">rs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> Inr <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">rs</span></span> <span class="quoted"><span class="skolem">q</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> c.run.cases<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"b.run <span class="free">B</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> smap projr <span class="free">rs</span><span class="main">)</span> <span class="skolem">q</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> Inr <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">rs</span></span> <span class="quoted"><span class="skolem">q</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> c.run.cases<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> b 1 Inr 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Nondeterministic-sum_nodes"><span class="command">lemma</span></span> sum_nodes<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span> <span class="main">=</span> <span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"c.nodes <span class="main">(</span>sum <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">⊆</span> a.nodes <span class="free">A</span> <span class="main">&lt;+&gt;</span> b.nodes <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">pq</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pq</span> <span class="main">∈</span> c.nodes <span class="main">(</span>sum <span class="free">A</span> <span class="free">B</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pq</span> <span class="main">∈</span> a.nodes <span class="free">A</span> <span class="main">&lt;+&gt;</span> b.nodes <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 0 3<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Nondeterministic-sum_nodes_finite"><span class="command">lemma</span></span> sum_nodes_finite<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span> <span class="main">=</span> <span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>a.nodes <span class="free">A</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>b.nodes <span class="free">B</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>c.nodes <span class="main">(</span>sum <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> finite_subset sum_nodes assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_Plus<span class="main">)</span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">locale</span></span> automaton_union_path <span class="main">=</span>
    automaton_sum
      <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span></span>
      <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span></span>
      <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>3</sub></span></span>
      <span class="quoted"><span class="free">condition</span></span> <span class="main">+</span>
    a<span class="main">:</span> automaton_path <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">test<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="main">+</span>
    b<span class="main">:</span> automaton_path <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">test<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="main">+</span>
    c<span class="main">:</span> automaton_path <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">test<span class="hidden">⇩</span><sub>3</sub></span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">test<span class="hidden">⇩</span><sub>1</sub></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">test<span class="hidden">⇩</span><sub>2</sub></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">test<span class="hidden">⇩</span><sub>3</sub></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">condition</span>
    <span class="main">+</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> test<span class="hidden">⇩</span><sub>1</sub><span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">r</span> <span class="main">=</span> length <span class="free">w</span> <span class="main">⟹</span> <span class="free">test<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">(</span><span class="free">condition</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">w</span> <span class="main">(</span>map Inl <span class="free">r</span><span class="main">)</span> <span class="main">(</span>Inl <span class="free">p</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">test<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">w</span> <span class="free">r</span> <span class="free">p</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> test<span class="hidden">⇩</span><sub>2</sub><span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">s</span> <span class="main">=</span> length <span class="free">w</span> <span class="main">⟹</span> <span class="free">test<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">(</span><span class="free">condition</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">w</span> <span class="main">(</span>map Inr <span class="free">s</span><span class="main">)</span> <span class="main">(</span>Inr <span class="free">q</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">test<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">w</span> <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1" id="Nondeterministic-sum_language"><span class="command">lemma</span></span> sum_language<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span> <span class="main">=</span> <span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"c.language <span class="main">(</span>sum <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> a.language <span class="free">A</span> <span class="main">∪</span> b.language <span class="free">B</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> a.language_def b.language_def c.language_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> path_sum_a path_sum_b <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_path<span class="main">)</span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">locale</span></span> automaton_union_run <span class="main">=</span>
    automaton_sum
      <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span></span>
      <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span></span>
      <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>3</sub></span></span>
      <span class="quoted"><span class="free">condition</span></span> <span class="main">+</span>
    a<span class="main">:</span> automaton_run <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">test<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="main">+</span>
    b<span class="main">:</span> automaton_run <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">test<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="main">+</span>
    c<span class="main">:</span> automaton_run <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="quoted"><span class="free">test<span class="hidden">⇩</span><sub>3</sub></span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">test<span class="hidden">⇩</span><sub>1</sub></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">test<span class="hidden">⇩</span><sub>2</sub></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">test<span class="hidden">⇩</span><sub>3</sub></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">condition</span>
    <span class="main">+</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> test<span class="hidden">⇩</span><sub>1</sub><span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">test<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">(</span><span class="free">condition</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">w</span> <span class="main">(</span>smap Inl <span class="free">r</span><span class="main">)</span> <span class="main">(</span>Inl <span class="free">p</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">test<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">w</span> <span class="free">r</span> <span class="free">p</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> test<span class="hidden">⇩</span><sub>2</sub><span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">test<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">(</span><span class="free">condition</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">w</span> <span class="main">(</span>smap Inr <span class="free">s</span><span class="main">)</span> <span class="main">(</span>Inr <span class="free">q</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">test<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">w</span> <span class="free">s</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1" id="Nondeterministic-sum_language"><span class="command">lemma</span></span> sum_language<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">A</span> <span class="main">=</span> <span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">B</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"c.language <span class="main">(</span>sum <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> a.language <span class="free">A</span> <span class="main">∪</span> b.language <span class="free">B</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> a.language_def b.language_def c.language_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> run_sum_a run_sum_b <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_run<span class="main">)</span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">locale</span></span> automaton_product_list <span class="main">=</span>
    a<span class="main">:</span> automaton <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="main">+</span>
    b<span class="main">:</span> automaton <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> set <span class="main">⇒</span> <span class="tfree">'state</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⇒</span> <span class="tfree">'automaton<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> set <span class="main">⇒</span> <span class="tfree">'state</span> list set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state</span> list <span class="main">⇒</span> <span class="tfree">'state</span> list set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'condition<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⇒</span> <span class="tfree">'automaton<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span>
    <span class="main">+</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">condition</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'condition<span class="hidden">⇩</span><sub>1</sub></span> list <span class="main">⇒</span> <span class="tfree">'condition<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1"><span class="command">definition</span></span> <span class="entity">product</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'automaton<span class="hidden">⇩</span><sub>1</sub></span> list <span class="main">⇒</span> <span class="tfree">'automaton<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">product</span> <span class="free"><span class="bound"><span class="entity">AA</span></span></span> <span class="main">≡</span> <span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span>
        <span class="main">(</span><span class="main">⋂</span> <span class="main">(</span><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">`</span> set <span class="free"><span class="bound"><span class="entity">AA</span></span></span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span>listset <span class="main">(</span>map <span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span> <span class="free"><span class="bound"><span class="entity">AA</span></span></span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="bound">ps</span><span class="main">.</span> listset <span class="main">(</span>map2 <span class="main">(</span><span class="main">λ</span> <span class="bound">A</span> <span class="bound">p</span><span class="main">.</span> <span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">A</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">AA</span></span></span> <span class="bound">ps</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span><span class="free">condition</span> <span class="main">(</span>map <span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free"><span class="bound"><span class="entity">AA</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

    <span class="keyword1" id="Nondeterministic-product_simps"><span class="command">lemma</span></span> product_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span>product <span class="free">AA</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋂</span> <span class="main">(</span><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">`</span> set <span class="free">AA</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span>product <span class="free">AA</span><span class="main">)</span> <span class="main">=</span> listset <span class="main">(</span>map <span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">AA</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span>product <span class="free">AA</span><span class="main">)</span> <span class="free">a</span> <span class="free">ps</span> <span class="main">=</span> listset <span class="main">(</span>map2 <span class="main">(</span><span class="main">λ</span> <span class="bound">A</span> <span class="bound">p</span><span class="main">.</span> <span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">A</span> <span class="free">a</span> <span class="bound">p</span><span class="main">)</span> <span class="free">AA</span> <span class="free">ps</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span>product <span class="free">AA</span><span class="main">)</span> <span class="main">=</span> <span class="free">condition</span> <span class="main">(</span>map <span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">AA</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> product_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1" id="Nondeterministic-product_run_length"><span class="command">lemma</span></span> product_run_length<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ps</span> <span class="main">=</span> length <span class="free">AA</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"b.run <span class="main">(</span>product <span class="free">AA</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> <span class="free">r</span><span class="main">)</span> <span class="free">ps</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">qs</span> <span class="main">∈</span> sset <span class="free">r</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="free">qs</span> <span class="main">=</span> length <span class="free">AA</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span><span class="main">λ</span> <span class="bound">qs</span><span class="main">.</span> length <span class="bound">qs</span> <span class="main">=</span> length <span class="free">AA</span><span class="main">)</span> <span class="free">r</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span> 2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">ps</span></span><span class="main">)</span>
          <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> b.run.cases <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> listset_member list_all2_conv_all_nth<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> stream.pred_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1" id="Nondeterministic-product_run_stranspose"><span class="command">lemma</span></span> product_run_stranspose<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ps</span> <span class="main">=</span> length <span class="free">AA</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"b.run <span class="main">(</span>product <span class="free">AA</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> <span class="free">r</span><span class="main">)</span> <span class="free">ps</span>"</span></span>
      <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">rs</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> stranspose <span class="free">rs</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">rs</span> <span class="main">=</span> length <span class="free">AA</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rs</span> <span class="main">≡</span> map <span class="main">(</span><span class="main">λ</span> <span class="bound">k</span><span class="main">.</span> smap <span class="main">(</span><span class="main">λ</span> <span class="bound">ps</span><span class="main">.</span> <span class="bound">ps</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="free">r</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> length <span class="free">AA</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">qs</span> <span class="main">=</span> length <span class="free">AA</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">qs</span> <span class="main">∈</span> sset <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">qs</span> <span class="keyword1"><span class="command">using</span></span> product_run_length assms that <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> stranspose <span class="skolem">rs</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> rs_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> nth_equalityI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> comp_def<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">rs</span> <span class="main">=</span> length <span class="free">AA</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> rs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Nondeterministic-run_product"><span class="command">lemma</span></span> run_product<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">rs</span> <span class="main">=</span> length <span class="free">AA</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ps</span> <span class="main">=</span> length <span class="free">AA</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> length <span class="free">AA</span> <span class="main">⟹</span> a.run <span class="main">(</span><span class="free">AA</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> <span class="free">rs</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span><span class="free">ps</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"b.run <span class="main">(</span>product <span class="free">AA</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> stranspose <span class="free">rs</span><span class="main">)</span> <span class="free">ps</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">rs</span></span> <span class="quoted"><span class="free">ps</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>run <span class="skolem">ap</span> <span class="skolem">r</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI exI<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">ap</span> <span class="main">∈</span> <span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span>product <span class="free">AA</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> run <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> a.run.cases <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_conv_nth<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">ap</span> <span class="main">∈</span> <span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span>product <span class="free">AA</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">ap</span><span class="main">)</span> <span class="skolem">ps</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> run <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> a.run.cases <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> listset_member list_all2_conv_all_nth<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">k</span></span> <span class="main">&lt;</span> length <span class="free">AA</span><span class="main">.</span> a.run' <span class="main">(</span><span class="free">AA</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span>stl <span class="skolem">w</span> <span class="main">|||</span> map stl <span class="skolem">rs</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span>map shd <span class="skolem">rs</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> run <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> a.run.cases<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1" id="Nondeterministic-product_run"><span class="command">lemma</span></span> product_run<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">rs</span> <span class="main">=</span> length <span class="free">AA</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ps</span> <span class="main">=</span> length <span class="free">AA</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"b.run <span class="main">(</span>product <span class="free">AA</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> stranspose <span class="free">rs</span><span class="main">)</span> <span class="free">ps</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> length <span class="free">AA</span> <span class="main">⟹</span> a.run <span class="main">(</span><span class="free">AA</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> <span class="free">rs</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span><span class="free">ps</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">rs</span></span> <span class="quoted"><span class="free">ps</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>run <span class="skolem">ap</span> <span class="skolem">wr</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">ap</span> <span class="main">∈</span> <span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="free">AA</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> run <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> b.run.cases<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">ap</span> <span class="main">∈</span> <span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="free">AA</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">ap</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ps</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> run <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> b.run.cases <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> listset_member list_all2_conv_all_nth<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"b.run' <span class="main">(</span>product <span class="free">AA</span><span class="main">)</span> <span class="main">(</span>stl <span class="skolem">w</span> <span class="main">|||</span> stranspose <span class="main">(</span>map stl <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>shd <span class="main">(</span>stranspose <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> run <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> b.run.cases<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Nondeterministic-product_nodes"><span class="command">lemma</span></span> product_nodes<span class="main">:</span> <span class="quoted"><span class="quoted">"b.nodes <span class="main">(</span>product <span class="free">AA</span><span class="main">)</span> <span class="main">⊆</span> listset <span class="main">(</span>map a.nodes <span class="free">AA</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ps</span> <span class="main">∈</span> listset <span class="main">(</span>map a.nodes <span class="free">AA</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ps</span> <span class="main">∈</span> b.nodes <span class="main">(</span>product <span class="free">AA</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ps</span>
        <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> listset_member list_all2_conv_all_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Nondeterministic-product_nodes_finite"><span class="command">lemma</span></span> product_nodes_finite<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>finite <span class="main">∘</span> a.nodes<span class="main">)</span> <span class="free">AA</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>b.nodes <span class="main">(</span>product <span class="free">AA</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> list.pred_map product_nodes assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
    <span class="keyword1" id="Nondeterministic-product_nodes_card"><span class="command">lemma</span></span> product_nodes_card<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>finite <span class="main">∘</span> a.nodes<span class="main">)</span> <span class="free">AA</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>b.nodes <span class="main">(</span>product <span class="free">AA</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> prod_list <span class="main">(</span>map <span class="main">(</span>card <span class="main">∘</span> a.nodes<span class="main">)</span> <span class="free">AA</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>b.nodes <span class="main">(</span>product <span class="free">AA</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span>listset <span class="main">(</span>map a.nodes <span class="free">AA</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> list.pred_map product_nodes assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> card_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> prod_list <span class="main">(</span>map <span class="main">(</span>card <span class="main">∘</span> a.nodes<span class="main">)</span> <span class="free">AA</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">locale</span></span> automaton_intersection_list_run <span class="main">=</span>
    automaton_product_list
      <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span></span>
      <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span></span>
      <span class="quoted"><span class="free">condition</span></span> <span class="main">+</span>
    a<span class="main">:</span> automaton_run <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">test<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="main">+</span>
    b<span class="main">:</span> automaton_run <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">test<span class="hidden">⇩</span><sub>2</sub></span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">test<span class="hidden">⇩</span><sub>1</sub></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">test<span class="hidden">⇩</span><sub>2</sub></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">condition</span>
    <span class="main">+</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> test<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">rs</span> <span class="main">=</span> length <span class="free">cs</span> <span class="main">⟹</span> length <span class="free">ps</span> <span class="main">=</span> length <span class="free">cs</span> <span class="main">⟹</span>
      <span class="free">test<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="free">condition</span> <span class="free">cs</span><span class="main">)</span> <span class="free">w</span> <span class="main">(</span>stranspose <span class="free">rs</span><span class="main">)</span> <span class="free">ps</span> <span class="main">⟷</span> list_all <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="free">test<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">c</span> <span class="free">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free">cs</span> <span class="main">||</span> <span class="free">rs</span> <span class="main">||</span> <span class="free">ps</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1" id="Nondeterministic-product_language"><span class="command">lemma</span></span> product_language<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"b.language <span class="main">(</span>product <span class="free">AA</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋂</span> <span class="main">(</span>a.language <span class="main">`</span> set <span class="free">AA</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="skolem">w</span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> b.language <span class="main">(</span>product <span class="free">AA</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> set <span class="free">AA</span>"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">ps</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span>
        <span class="quoted"><span class="quoted">"<span class="skolem">ps</span> <span class="main">∈</span> <span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span>product <span class="free">AA</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"b.run <span class="main">(</span>product <span class="free">AA</span><span class="main">)</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">ps</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="free">test<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span>product <span class="free">AA</span><span class="main">)</span><span class="main">)</span> <span class="skolem">w</span> <span class="skolem">r</span> <span class="skolem">ps</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ps</span> <span class="main">=</span> length <span class="free">AA</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> listset_member list_all2_conv_all_nth<span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> stranspose <span class="skolem">rs</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">rs</span> <span class="main">=</span> length <span class="free">AA</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> product_run_stranspose 3 2<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="free">AA</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="free">AA</span> <span class="main">!</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> set_conv_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> a.language <span class="skolem">A</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ps</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">∈</span> <span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>1<span class="main">)</span> 5 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> listset_member list_all2_conv_all_nth<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"a.run <span class="skolem">A</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">rs</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ps</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>2<span class="main">)</span> 3 4 5 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> product_run<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">test<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">A</span><span class="main">)</span> <span class="skolem">w</span> <span class="main">(</span><span class="skolem">rs</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ps</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>3<span class="main">)</span> 3 4 5 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_length<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> <span class="main">⋂</span> <span class="main">(</span>a.language <span class="main">`</span> set <span class="free">AA</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">A</span> <span class="main">∈</span> set <span class="free">AA</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">A</span> <span class="main">∧</span> a.run <span class="bound">A</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">|||</span> <span class="bound">r</span><span class="main">)</span> <span class="bound">p</span> <span class="main">∧</span> <span class="free">test<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">A</span><span class="main">)</span> <span class="skolem">w</span> <span class="bound">r</span> <span class="bound">p</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="skolem"><span class="skolem">ps</span></span> <span class="keyword2"><span class="keyword">where</span></span> 3<span class="main">:</span>
        <span class="quoted"><span class="quoted">"length <span class="skolem">rs</span> <span class="main">=</span> length <span class="free">AA</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ps</span> <span class="main">=</span> length <span class="free">AA</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> length <span class="free">AA</span> <span class="main">⟹</span> <span class="skolem">ps</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">∈</span> <span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="free">AA</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> length <span class="free">AA</span> <span class="main">⟹</span> a.run <span class="main">(</span><span class="free">AA</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">rs</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ps</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> length <span class="free">AA</span> <span class="main">⟹</span> <span class="free">test<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="free">AA</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="skolem">w</span> <span class="main">(</span><span class="skolem">rs</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ps</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 2
        <span class="keyword1"><span class="command">unfolding</span></span> Ball_set list_choice_zip list_choice_pair
        <span class="keyword1"><span class="command">unfolding</span></span> list.pred_set set_conv_nth
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> b.language <span class="main">(</span>product <span class="free">AA</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ps</span> <span class="main">∈</span> <span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span>product <span class="free">AA</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> listset_member list_all2_conv_all_nth<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"b.run <span class="main">(</span>product <span class="free">AA</span><span class="main">)</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">|||</span> stranspose <span class="skolem">rs</span><span class="main">)</span> <span class="skolem">ps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> run_product<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">test<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span>product <span class="free">AA</span><span class="main">)</span><span class="main">)</span> <span class="skolem">w</span> <span class="main">(</span>stranspose <span class="skolem">rs</span><span class="main">)</span> <span class="skolem">ps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_length<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">locale</span></span> automaton_sum_list <span class="main">=</span>
    a<span class="main">:</span> automaton <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="main">+</span>
    b<span class="main">:</span> automaton <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> set <span class="main">⇒</span> <span class="tfree">'state</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⇒</span> <span class="tfree">'automaton<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> set <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> <span class="tfree">'state</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'label</span> <span class="main">⇒</span> nat <span class="main">×</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> <span class="tfree">'state</span><span class="main">)</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'condition<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⇒</span> <span class="tfree">'automaton<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span>
    <span class="main">+</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">condition</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'condition<span class="hidden">⇩</span><sub>1</sub></span> list <span class="main">⇒</span> <span class="tfree">'condition<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1"><span class="command">definition</span></span> <span class="entity">sum</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'automaton<span class="hidden">⇩</span><sub>1</sub></span> list <span class="main">⇒</span> <span class="tfree">'automaton<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">sum</span> <span class="free"><span class="bound"><span class="entity">AA</span></span></span> <span class="main">≡</span> <span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span>
        <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">`</span> set <span class="free"><span class="bound"><span class="entity">AA</span></span></span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span><span class="main">⋃</span> <span class="bound">k</span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">AA</span></span></span><span class="main">.</span> <span class="main">{</span><span class="bound">k</span><span class="main">}</span> <span class="main">×</span> <span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">AA</span></span></span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="main">{</span><span class="bound">k</span><span class="main">}</span> <span class="main">×</span> <span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">AA</span></span></span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">)</span>
        <span class="main">(</span><span class="free">condition</span> <span class="main">(</span>map <span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free"><span class="bound"><span class="entity">AA</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

    <span class="keyword1" id="Nondeterministic-sum_simps"><span class="command">lemma</span></span> sum_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span>sum <span class="free">AA</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">`</span> set <span class="free">AA</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span>sum <span class="free">AA</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">k</span> <span class="main">&lt;</span> length <span class="free">AA</span><span class="main">.</span> <span class="main">{</span><span class="bound">k</span><span class="main">}</span> <span class="main">×</span> <span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="free">AA</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span>sum <span class="free">AA</span><span class="main">)</span> <span class="free">a</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">k</span><span class="main">}</span> <span class="main">×</span> <span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="free">AA</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> <span class="free">a</span> <span class="free">p</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span>sum <span class="free">AA</span><span class="main">)</span> <span class="main">=</span> <span class="free">condition</span> <span class="main">(</span>map <span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">AA</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> sum_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1" id="Nondeterministic-run_sum"><span class="command">lemma</span></span> run_sum<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋂</span> <span class="main">(</span><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">`</span> set <span class="free">AA</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">`</span> set <span class="free">AA</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> set <span class="free">AA</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"a.run <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> <span class="free">s</span><span class="main">)</span> <span class="free">p</span>"</span></span>
      <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">k</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> length <span class="free">AA</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="free">AA</span> <span class="main">!</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"b.run <span class="main">(</span>sum <span class="free">AA</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> sconst <span class="free">k</span> <span class="main">|||</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="free">AA</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="free">AA</span> <span class="main">!</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> set_conv_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="free">AA</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="free">AA</span> <span class="main">!</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"b.run <span class="main">(</span>sum <span class="free">AA</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> sconst <span class="skolem">k</span> <span class="main">|||</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="skolem">k</span><span class="main">,</span> <span class="free">p</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assms 1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> a.run.cases<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1" id="Nondeterministic-sum_run"><span class="command">lemma</span></span> sum_run<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋂</span> <span class="main">(</span><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">`</span> set <span class="free">AA</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">`</span> set <span class="free">AA</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> length <span class="free">AA</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"b.run <span class="main">(</span>sum <span class="free">AA</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">s</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> sconst <span class="free">k</span> <span class="main">|||</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"a.run <span class="main">(</span><span class="free">AA</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> <span class="free">s</span><span class="main">)</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> sconst <span class="free">k</span> <span class="main">|||</span> smap snd <span class="free">r</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> b.run.cases<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"a.run <span class="main">(</span><span class="free">AA</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> smap snd <span class="free">r</span><span class="main">)</span> <span class="free">p</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> b.run.cases<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Nondeterministic-sum_nodes"><span class="command">lemma</span></span> sum_nodes<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋂</span> <span class="main">(</span><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">`</span> set <span class="free">AA</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">`</span> set <span class="free">AA</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"b.nodes <span class="main">(</span>sum <span class="free">AA</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">k</span> <span class="main">&lt;</span> length <span class="free">AA</span><span class="main">.</span> <span class="main">{</span><span class="bound">k</span><span class="main">}</span> <span class="main">×</span> a.nodes <span class="main">(</span><span class="free">AA</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">kp</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">k</span> <span class="main">&lt;</span> length <span class="free">AA</span><span class="main">.</span> <span class="main">{</span><span class="bound">k</span><span class="main">}</span> <span class="main">×</span> a.nodes <span class="main">(</span><span class="free">AA</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">kp</span> <span class="main">∈</span> b.nodes <span class="main">(</span>sum <span class="free">AA</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">kp</span>
        <span class="keyword1"><span class="command">using</span></span> that assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 0 4<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Nondeterministic-sum_nodes_finite"><span class="command">lemma</span></span> sum_nodes_finite<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋂</span> <span class="main">(</span><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">`</span> set <span class="free">AA</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">`</span> set <span class="free">AA</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>finite <span class="main">∘</span> a.nodes<span class="main">)</span> <span class="free">AA</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>b.nodes <span class="main">(</span>sum <span class="free">AA</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"b.nodes <span class="main">(</span>sum <span class="free">AA</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">k</span> <span class="main">&lt;</span> length <span class="free">AA</span><span class="main">.</span> <span class="main">{</span><span class="bound">k</span><span class="main">}</span> <span class="main">×</span> a.nodes <span class="main">(</span><span class="free">AA</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> sum_nodes assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">⋃</span> <span class="bound">k</span> <span class="main">&lt;</span> length <span class="free">AA</span><span class="main">.</span> <span class="main">{</span><span class="bound">k</span><span class="main">}</span> <span class="main">×</span> a.nodes' <span class="main">(</span><span class="free">AA</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> list_all_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">locale</span></span> automaton_union_list_run <span class="main">=</span>
    automaton_sum_list
      <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span></span>
      <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span></span>
      <span class="quoted"><span class="free">condition</span></span> <span class="main">+</span>
    a<span class="main">:</span> automaton_run <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">test<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="main">+</span>
    b<span class="main">:</span> automaton_run <span class="quoted"><span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">test<span class="hidden">⇩</span><sub>2</sub></span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">test<span class="hidden">⇩</span><sub>1</sub></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">automaton<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">alphabet<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">initial<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">transition<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">condition<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">test<span class="hidden">⇩</span><sub>2</sub></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">condition</span>
    <span class="main">+</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> test<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> length <span class="free">cs</span> <span class="main">⟹</span> <span class="free">test<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="free">condition</span> <span class="free">cs</span><span class="main">)</span> <span class="free">w</span> <span class="main">(</span>sconst <span class="free">k</span> <span class="main">|||</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">p</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">test<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="free">cs</span> <span class="main">!</span> <span class="free">k</span><span class="main">)</span> <span class="free">w</span> <span class="free">r</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1" id="Nondeterministic-sum_language"><span class="command">lemma</span></span> sum_language<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋂</span> <span class="main">(</span><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">`</span> set <span class="free">AA</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span><span class="free">alphabet<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">`</span> set <span class="free">AA</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"b.language <span class="main">(</span>sum <span class="free">AA</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span>a.language <span class="main">`</span> set <span class="free">AA</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"b.language <span class="main">(</span>sum <span class="free">AA</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">⋃</span> <span class="main">(</span>a.language <span class="main">`</span> set <span class="free">AA</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> a.language_def b.language_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> sum_run<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>a.language <span class="main">`</span> set <span class="free">AA</span><span class="main">)</span> <span class="main">⊆</span> b.language <span class="main">(</span>sum <span class="free">AA</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> a.language_def b.language_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> run_sum<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="NFA">
<div class="head">
<h1>Theory NFA</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Nondeterministic Finite Automata›</span></span>

<span class="keyword1"><span class="command">theory</span></span> NFA
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Nondeterministic.html">../Nondeterministic</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> nfa <span class="main">=</span> nfa
    <span class="main">(</span><span class="free"><span class="entity">alphabet</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> set"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">initial</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> set"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">transition</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> set"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">accepting</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> pred"</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">global_interpretation</span></span> nfa<span class="main">:</span> automaton <span class="quoted">nfa</span> <span class="quoted">alphabet</span> <span class="quoted">initial</span> <span class="quoted">transition</span> <span class="quoted">accepting</span>
    <span class="keyword2"><span class="keyword">defines</span></span> path <span class="main">=</span> <span class="quoted">nfa.path</span> <span class="keyword2"><span class="keyword">and</span></span> run <span class="main">=</span> <span class="quoted">nfa.run</span> <span class="keyword2"><span class="keyword">and</span></span> reachable <span class="main">=</span> <span class="quoted">nfa.reachable</span> <span class="keyword2"><span class="keyword">and</span></span> nodes <span class="main">=</span> <span class="quoted">nfa.nodes</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">global_interpretation</span></span> nfa<span class="main">:</span> automaton_path <span class="quoted">nfa</span> <span class="quoted">alphabet</span> <span class="quoted">initial</span> <span class="quoted">transition</span> <span class="quoted">accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">P</span> <span class="main">(</span>last <span class="main">(</span><span class="bound">p</span> <span class="main">#</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">defines</span></span> language <span class="main">=</span> <span class="quoted">nfa.language</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span>

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">target</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">target</span> <span class="main">≡</span> nfa.target"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">states</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">states</span> <span class="main">≡</span> nfa.states"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">trace</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">trace</span> <span class="main">≡</span> nfa.trace"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">successors</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">successors</span> <span class="main">≡</span> nfa.successors <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'label</span><span class="main">)</span>"</span></span>

  <span class="comment1">(* TODO: going from target to last requires states as intermediate step, used in other places too *)</span>
  <span class="keyword1"><span class="command">global_interpretation</span></span> nfa<span class="main">:</span> automaton_intersection_path
    <span class="quoted">nfa</span> <span class="quoted">alphabet</span> <span class="quoted">initial</span> <span class="quoted">transition</span> <span class="quoted">accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">P</span> <span class="main">(</span>last <span class="main">(</span><span class="bound">p</span> <span class="main">#</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted">nfa</span> <span class="quoted">alphabet</span> <span class="quoted">initial</span> <span class="quoted">transition</span> <span class="quoted">accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">P</span> <span class="main">(</span>last <span class="main">(</span><span class="bound">p</span> <span class="main">#</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted">nfa</span> <span class="quoted">alphabet</span> <span class="quoted">initial</span> <span class="quoted">transition</span> <span class="quoted">accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">P</span> <span class="main">(</span>last <span class="main">(</span><span class="bound">p</span> <span class="main">#</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">.</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">p</span> <span class="main">∧</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">defines</span></span> intersect <span class="main">=</span> <span class="quoted">nfa.product</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zip_eq_Nil_iff<span class="main">)</span>

  <span class="keyword1"><span class="command">global_interpretation</span></span> nfa<span class="main">:</span> automaton_union_path
    <span class="quoted">nfa</span> <span class="quoted">alphabet</span> <span class="quoted">initial</span> <span class="quoted">transition</span> <span class="quoted">accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">P</span> <span class="main">(</span>last <span class="main">(</span><span class="bound">p</span> <span class="main">#</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted">nfa</span> <span class="quoted">alphabet</span> <span class="quoted">initial</span> <span class="quoted">transition</span> <span class="quoted">accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">P</span> <span class="main">(</span>last <span class="main">(</span><span class="bound">p</span> <span class="main">#</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted">nfa</span> <span class="quoted">alphabet</span> <span class="quoted">initial</span> <span class="quoted">transition</span> <span class="quoted">accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">P</span> <span class="main">(</span>last <span class="main">(</span><span class="bound">p</span> <span class="main">#</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted">case_sum</span>
    <span class="keyword2"><span class="keyword">defines</span></span> union <span class="main">=</span> <span class="quoted">nfa.sum</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> last_map<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="DBA">
<div class="head">
<h1>Theory DBA</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Deterministic Büchi Automata›</span></span>

<span class="keyword1"><span class="command">theory</span></span> DBA
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Deterministic.html">../Deterministic</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> dba <span class="main">=</span> dba
    <span class="main">(</span><span class="free"><span class="entity">alphabet</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> set"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">initial</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span>"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">transition</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span>"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">accepting</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> pred"</span></span><span class="main">)</span>

  <span class="comment1">(* TODO: if we interpret everything at once, some abbreviations don't get folded back
    see DBA_Combine.intersection_list.combine_finite *)</span>
  <span class="keyword1"><span class="command">global_interpretation</span></span> dba<span class="main">:</span> automaton <span class="quoted">dba</span> <span class="quoted">alphabet</span> <span class="quoted">initial</span> <span class="quoted">transition</span> <span class="quoted">accepting</span>
    <span class="keyword2"><span class="keyword">defines</span></span> path <span class="main">=</span> <span class="quoted">dba.path</span> <span class="keyword2"><span class="keyword">and</span></span> run <span class="main">=</span> <span class="quoted">dba.run</span> <span class="keyword2"><span class="keyword">and</span></span> reachable <span class="main">=</span> <span class="quoted">dba.reachable</span> <span class="keyword2"><span class="keyword">and</span></span> nodes <span class="main">=</span> <span class="quoted">dba.nodes</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">global_interpretation</span></span> dba<span class="main">:</span> automaton_run <span class="quoted">dba</span> <span class="quoted">alphabet</span> <span class="quoted">initial</span> <span class="quoted">transition</span> <span class="quoted">accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> infs <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">defines</span></span> language <span class="main">=</span> <span class="quoted">dba.language</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span>

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">target</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">target</span> <span class="main">≡</span> dba.target"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">states</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">states</span> <span class="main">≡</span> dba.states"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">trace</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">trace</span> <span class="main">≡</span> dba.trace"</span></span>
  <span class="comment1">(* TODO: why does this happen? if I can fix it here, why can't the interpretation do it?
    same happens with reachable, requiring the use of defines directives *)</span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">successors</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">successors</span> <span class="main">≡</span> dba.successors <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'label</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="DGBA">
<div class="head">
<h1>Theory DGBA</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Deterministic Generalized Büchi Automata›</span></span>

<span class="keyword1"><span class="command">theory</span></span> DGBA
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Deterministic.html">../Deterministic</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> dgba <span class="main">=</span> dgba
    <span class="main">(</span><span class="free"><span class="entity">alphabet</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> set"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">initial</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span>"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">transition</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span>"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">accepting</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> pred gen"</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">global_interpretation</span></span> dgba<span class="main">:</span> automaton <span class="quoted">dgba</span> <span class="quoted">alphabet</span> <span class="quoted">initial</span> <span class="quoted">transition</span> <span class="quoted">accepting</span>
    <span class="keyword2"><span class="keyword">defines</span></span> path <span class="main">=</span> <span class="quoted">dgba.path</span> <span class="keyword2"><span class="keyword">and</span></span> run <span class="main">=</span> <span class="quoted">dgba.run</span> <span class="keyword2"><span class="keyword">and</span></span> reachable <span class="main">=</span> <span class="quoted">dgba.reachable</span> <span class="keyword2"><span class="keyword">and</span></span> nodes <span class="main">=</span> <span class="quoted">dgba.nodes</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">global_interpretation</span></span> dgba<span class="main">:</span> automaton_run <span class="quoted">dgba</span> <span class="quoted">alphabet</span> <span class="quoted">initial</span> <span class="quoted">transition</span> <span class="quoted">accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> gen infs <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">defines</span></span> language <span class="main">=</span> <span class="quoted">dgba.language</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span>

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">target</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">target</span> <span class="main">≡</span> dgba.target"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">states</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">states</span> <span class="main">≡</span> dgba.states"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">trace</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">trace</span> <span class="main">≡</span> dgba.trace"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">successors</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">successors</span> <span class="main">≡</span> dgba.successors <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'label</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="DBA_Combine">
<div class="head">
<h1>Theory DBA_Combine</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Deterministic Büchi Automata Combinations›</span></span>

<span class="keyword1"><span class="command">theory</span></span> DBA_Combine
<span class="keyword2"><span class="keyword">imports</span></span> <a href="DBA.html">DBA</a> <a href="DGBA.html">DGBA</a>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">global_interpretation</span></span> degeneralization<span class="main">:</span> automaton_degeneralization_run
    <span class="quoted">dgba</span> <span class="quoted">dgba.alphabet</span> <span class="quoted">dgba.initial</span> <span class="quoted">dgba.transition</span> <span class="quoted">dgba.accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> gen infs <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted">dba</span> <span class="quoted">dba.alphabet</span> <span class="quoted">dba.initial</span> <span class="quoted">dba.transition</span> <span class="quoted">dba.accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> infs <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted">fst</span> <span class="quoted">id</span>
    <span class="keyword2"><span class="keyword">defines</span></span> degeneralize <span class="main">=</span> <span class="quoted">degeneralization.degeneralize</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> sscan_smap<span class="main">)</span>

  <span class="keyword1"><span class="command">lemmas</span></span> degeneralize_language<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> degeneralization.degeneralize_language<span class="main">[</span><span class="operator">folded</span> DBA.language_def<span class="main">]</span>
  <span class="keyword1"><span class="command">lemmas</span></span> degeneralize_nodes_finite<span class="main">[</span><span class="operator">iff</span><span class="main">]</span> <span class="main">=</span> degeneralization.degeneralize_nodes_finite<span class="main">[</span><span class="operator">folded</span> DBA.nodes_def<span class="main">]</span>
  <span class="keyword1"><span class="command">lemmas</span></span> degeneralize_nodes_card <span class="main">=</span> degeneralization.degeneralize_nodes_card<span class="main">[</span><span class="operator">folded</span> DBA.nodes_def<span class="main">]</span>

  <span class="keyword1"><span class="command">global_interpretation</span></span> intersection<span class="main">:</span> automaton_intersection_run
    <span class="quoted">dba.dba</span> <span class="quoted">dba.alphabet</span> <span class="quoted">dba.initial</span> <span class="quoted">dba.transition</span> <span class="quoted">dba.accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> infs <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted">dba.dba</span> <span class="quoted">dba.alphabet</span> <span class="quoted">dba.initial</span> <span class="quoted">dba.transition</span> <span class="quoted">dba.accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> infs <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted">dgba.dgba</span> <span class="quoted">dgba.alphabet</span> <span class="quoted">dgba.initial</span> <span class="quoted">dgba.transition</span> <span class="quoted">dgba.accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> gen infs <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="main">[</span><span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∘</span> fst<span class="main">,</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∘</span> snd<span class="main">]</span>"</span></span>
    <span class="keyword2"><span class="keyword">defines</span></span> intersect' <span class="main">=</span> <span class="quoted">intersection.product</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">lemmas</span></span> intersect'_language<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> intersection.product_language<span class="main">[</span><span class="operator">folded</span> DGBA.language_def<span class="main">]</span>
  <span class="keyword1"><span class="command">lemmas</span></span> intersect'_nodes_finite <span class="main">=</span> intersection.product_nodes_finite<span class="main">[</span><span class="operator">folded</span> DGBA.nodes_def<span class="main">]</span>
  <span class="keyword1"><span class="command">lemmas</span></span> intersect'_nodes_card <span class="main">=</span> intersection.product_nodes_card<span class="main">[</span><span class="operator">folded</span> DGBA.nodes_def<span class="main">]</span>

  <span class="keyword1"><span class="command">global_interpretation</span></span> union<span class="main">:</span> automaton_union_run
    <span class="quoted">dba.dba</span> <span class="quoted">dba.alphabet</span> <span class="quoted">dba.initial</span> <span class="quoted">dba.transition</span> <span class="quoted">dba.accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> infs <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted">dba.dba</span> <span class="quoted">dba.alphabet</span> <span class="quoted">dba.initial</span> <span class="quoted">dba.transition</span> <span class="quoted">dba.accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> infs <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted">dba.dba</span> <span class="quoted">dba.alphabet</span> <span class="quoted">dba.initial</span> <span class="quoted">dba.transition</span> <span class="quoted">dba.accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> infs <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">pq</span><span class="main">.</span> <span class="main">(</span><span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∘</span> fst<span class="main">)</span> <span class="bound">pq</span> <span class="main">∨</span> <span class="main">(</span><span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∘</span> snd<span class="main">)</span> <span class="bound">pq</span>"</span></span>
    <span class="keyword2"><span class="keyword">defines</span></span> union <span class="main">=</span> <span class="quoted">union.product</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> comp_apply<span class="main">)</span>

  <span class="keyword1"><span class="command">lemmas</span></span> union_language <span class="main">=</span> union.product_language
  <span class="keyword1"><span class="command">lemmas</span></span> union_nodes_finite <span class="main">=</span> union.product_nodes_finite
  <span class="keyword1"><span class="command">lemmas</span></span> union_nodes_card <span class="main">=</span> union.product_nodes_card

  <span class="keyword1"><span class="command">global_interpretation</span></span> intersection_list<span class="main">:</span> automaton_intersection_list_run
    <span class="quoted">dba.dba</span> <span class="quoted">dba.alphabet</span> <span class="quoted">dba.initial</span> <span class="quoted">dba.transition</span> <span class="quoted">dba.accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> infs <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted">dgba.dgba</span> <span class="quoted">dgba.alphabet</span> <span class="quoted">dgba.initial</span> <span class="quoted">dgba.transition</span> <span class="quoted">dgba.accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> gen infs <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">cs</span><span class="main">.</span> map <span class="main">(</span><span class="main">λ</span> <span class="bound">k</span> <span class="bound">pp</span><span class="main">.</span> <span class="main">(</span><span class="bound">cs</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span><span class="bound">pp</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> length <span class="bound">cs</span><span class="main">]</span>"</span></span>
    <span class="keyword2"><span class="keyword">defines</span></span> intersect_list' <span class="main">=</span> <span class="quoted">intersection_list.product</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gen_def comp_def<span class="main">)</span>

  <span class="keyword1"><span class="command">lemmas</span></span> intersect_list'_language<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> intersection_list.product_language<span class="main">[</span><span class="operator">folded</span> DGBA.language_def<span class="main">]</span>
  <span class="keyword1"><span class="command">lemmas</span></span> intersect_list'_nodes_finite <span class="main">=</span> intersection_list.product_nodes_finite<span class="main">[</span><span class="operator">folded</span> DGBA.nodes_def<span class="main">]</span>
  <span class="keyword1"><span class="command">lemmas</span></span> intersect_list'_nodes_card <span class="main">=</span> intersection_list.product_nodes_card<span class="main">[</span><span class="operator">folded</span> DGBA.nodes_def<span class="main">]</span>

  <span class="keyword1"><span class="command">global_interpretation</span></span> union_list<span class="main">:</span> automaton_union_list_run
    <span class="quoted">dba.dba</span> <span class="quoted">dba.alphabet</span> <span class="quoted">dba.initial</span> <span class="quoted">dba.transition</span> <span class="quoted">dba.accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> infs <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted">dba.dba</span> <span class="quoted">dba.alphabet</span> <span class="quoted">dba.initial</span> <span class="quoted">dba.transition</span> <span class="quoted">dba.accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> infs <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">cs</span> <span class="bound">pp</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">k</span></span> <span class="main">&lt;</span> length <span class="bound">cs</span><span class="main">.</span> <span class="main">(</span><span class="bound">cs</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span><span class="bound">pp</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">defines</span></span> union_list <span class="main">=</span> <span class="quoted">union_list.product</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_def<span class="main">)</span>

  <span class="keyword1"><span class="command">lemmas</span></span> union_list_language <span class="main">=</span> union_list.product_language
  <span class="keyword1"><span class="command">lemmas</span></span> union_list_nodes_finite <span class="main">=</span> union_list.product_nodes_finite
  <span class="keyword1"><span class="command">lemmas</span></span> union_list_nodes_card <span class="main">=</span> union_list.product_nodes_card

  <span class="comment1">(* TODO: these compound definitions are annoying, can we move those into Deterministic theory *)</span>

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">intersect</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">intersect</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> degeneralize <span class="main">(</span>intersect' <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="DBA_Combine-intersect_language"><span class="command">lemma</span></span> intersect_language<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"DBA.language <span class="main">(</span>intersect <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> DBA.language <span class="free">A</span> <span class="main">∩</span> DBA.language <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1" id="DBA_Combine-intersect_nodes_finite"><span class="command">lemma</span></span> intersect_nodes_finite<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>DBA.nodes <span class="free">A</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>DBA.nodes <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>DBA.nodes <span class="main">(</span>intersect <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> intersect'_nodes_finite assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1" id="DBA_Combine-intersect_nodes_card"><span class="command">lemma</span></span> intersect_nodes_card<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>DBA.nodes <span class="free">A</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>DBA.nodes <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>DBA.nodes <span class="main">(</span>intersect <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> card <span class="main">(</span>DBA.nodes <span class="free">A</span><span class="main">)</span> <span class="main">*</span> card <span class="main">(</span>DBA.nodes <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>DBA.nodes <span class="main">(</span>intersect <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span>
      max <span class="main">1</span> <span class="main">(</span>length <span class="main">(</span>dgba.accepting <span class="main">(</span>intersect' <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> card <span class="main">(</span>DGBA.nodes <span class="main">(</span>intersect' <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> degeneralize_nodes_card <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>dgba.accepting <span class="main">(</span>intersect' <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>DGBA.nodes <span class="main">(</span>intersect' <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span>DBA.nodes <span class="free">A</span><span class="main">)</span> <span class="main">*</span> card <span class="main">(</span>DBA.nodes <span class="free">B</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> intersect'_nodes_card assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">intersect_list</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">intersect_list</span> <span class="free"><span class="bound"><span class="entity">AA</span></span></span> <span class="main">≡</span> degeneralize <span class="main">(</span>intersect_list' <span class="free"><span class="bound"><span class="entity">AA</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="DBA_Combine-intersect_list_language"><span class="command">lemma</span></span> intersect_list_language<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"DBA.language <span class="main">(</span>intersect_list <span class="free">AA</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋂</span> <span class="main">(</span>DBA.language <span class="main">`</span> set <span class="free">AA</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1" id="DBA_Combine-intersect_list_nodes_finite"><span class="command">lemma</span></span> intersect_list_nodes_finite<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>finite <span class="main">∘</span> DBA.nodes<span class="main">)</span> <span class="free">AA</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>DBA.nodes <span class="main">(</span>intersect_list <span class="free">AA</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> intersect_list'_nodes_finite assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1" id="DBA_Combine-intersect_list_nodes_card"><span class="command">lemma</span></span> intersect_list_nodes_card<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>finite <span class="main">∘</span> DBA.nodes<span class="main">)</span> <span class="free">AA</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>DBA.nodes <span class="main">(</span>intersect_list <span class="free">AA</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> max <span class="main">1</span> <span class="main">(</span>length <span class="free">AA</span><span class="main">)</span> <span class="main">*</span> prod_list <span class="main">(</span>map <span class="main">(</span>card <span class="main">∘</span> DBA.nodes<span class="main">)</span> <span class="free">AA</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>DBA.nodes <span class="main">(</span>intersect_list <span class="free">AA</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span>
      max <span class="main">1</span> <span class="main">(</span>length <span class="main">(</span>dgba.accepting <span class="main">(</span>intersect_list' <span class="free">AA</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> card <span class="main">(</span>DGBA.nodes <span class="main">(</span>intersect_list' <span class="free">AA</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> degeneralize_nodes_card <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>dgba.accepting <span class="main">(</span>intersect_list' <span class="free">AA</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="free">AA</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>DGBA.nodes <span class="main">(</span>intersect_list' <span class="free">AA</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> prod_list <span class="main">(</span>map <span class="main">(</span>card <span class="main">∘</span> DBA.nodes<span class="main">)</span> <span class="free">AA</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> intersect_list'_nodes_card assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="DBTA">
<div class="head">
<h1>Theory DBTA</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Deterministic Büchi Transition Automata›</span></span>

<span class="keyword1"><span class="command">theory</span></span> DBTA
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Deterministic.html">../Deterministic</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> dbta <span class="main">=</span> dbta
    <span class="main">(</span><span class="free"><span class="entity">alphabet</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> set"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">initial</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span>"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">transition</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span>"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">accepting</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'state</span> <span class="main">×</span> <span class="tfree">'label</span> <span class="main">×</span> <span class="tfree">'state</span><span class="main">)</span> pred"</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">global_interpretation</span></span> dbta<span class="main">:</span> automaton <span class="quoted">dbta</span> <span class="quoted">alphabet</span> <span class="quoted">initial</span> <span class="quoted">transition</span> <span class="quoted">accepting</span>
    <span class="keyword2"><span class="keyword">defines</span></span> path <span class="main">=</span> <span class="quoted">dbta.path</span> <span class="keyword2"><span class="keyword">and</span></span> run <span class="main">=</span> <span class="quoted">dbta.run</span> <span class="keyword2"><span class="keyword">and</span></span> reachable <span class="main">=</span> <span class="quoted">dbta.reachable</span> <span class="keyword2"><span class="keyword">and</span></span> nodes <span class="main">=</span> <span class="quoted">dbta.nodes</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">global_interpretation</span></span> dbta<span class="main">:</span> automaton_run <span class="quoted">dbta</span> <span class="quoted">alphabet</span> <span class="quoted">initial</span> <span class="quoted">transition</span> <span class="quoted">accepting</span>
    <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> infs <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span> <span class="main">|||</span> <span class="bound">w</span> <span class="main">|||</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">defines</span></span> language <span class="main">=</span> <span class="quoted">dbta.language</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span>

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">target</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">target</span> <span class="main">≡</span> dbta.target"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">states</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">states</span> <span class="main">≡</span> dbta.states"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">trace</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">trace</span> <span class="main">≡</span> dbta.trace"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">successors</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">successors</span> <span class="main">≡</span> dbta.successors <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'label</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="DGBTA">
<div class="head">
<h1>Theory DGBTA</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Deterministic Generalized Büchi Transition Automata›</span></span>

<span class="keyword1"><span class="command">theory</span></span> DGBTA
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Deterministic.html">../Deterministic</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> dgbta <span class="main">=</span> dgbta
    <span class="main">(</span><span class="free"><span class="entity">alphabet</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> set"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">initial</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span>"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">transition</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span>"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">accepting</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'state</span> <span class="main">×</span> <span class="tfree">'label</span> <span class="main">×</span> <span class="tfree">'state</span><span class="main">)</span> pred gen"</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">global_interpretation</span></span> dgbta<span class="main">:</span> automaton <span class="quoted">dgbta</span> <span class="quoted">alphabet</span> <span class="quoted">initial</span> <span class="quoted">transition</span> <span class="quoted">accepting</span>
    <span class="keyword2"><span class="keyword">defines</span></span> path <span class="main">=</span> <span class="quoted">dgbta.path</span> <span class="keyword2"><span class="keyword">and</span></span> run <span class="main">=</span> <span class="quoted">dgbta.run</span> <span class="keyword2"><span class="keyword">and</span></span> reachable <span class="main">=</span> <span class="quoted">dgbta.reachable</span> <span class="keyword2"><span class="keyword">and</span></span> nodes <span class="main">=</span> <span class="quoted">dgbta.nodes</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">global_interpretation</span></span> dgbta<span class="main">:</span> automaton_run <span class="quoted">dgbta</span> <span class="quoted">alphabet</span> <span class="quoted">initial</span> <span class="quoted">transition</span> <span class="quoted">accepting</span>
    <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> gen infs <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span> <span class="main">|||</span> <span class="bound">w</span> <span class="main">|||</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">defines</span></span> language <span class="main">=</span> <span class="quoted">dgbta.language</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span>

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">target</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">target</span> <span class="main">≡</span> dgbta.target"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">states</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">states</span> <span class="main">≡</span> dgbta.states"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">trace</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">trace</span> <span class="main">≡</span> dgbta.trace"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">successors</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">successors</span> <span class="main">≡</span> dgbta.successors <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'label</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="DBTA_Combine">
<div class="head">
<h1>Theory DBTA_Combine</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Deterministic Büchi Transition Automata Combinations›</span></span>

<span class="keyword1"><span class="command">theory</span></span> DBTA_Combine
<span class="keyword2"><span class="keyword">imports</span></span> <a href="DBTA.html">DBTA</a> <a href="DGBTA.html">DGBTA</a>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="comment1">(* TODO: exact copy-paste from NBTA, abstract *)</span>
  <span class="keyword1"><span class="command">global_interpretation</span></span> degeneralization<span class="main">:</span> automaton_degeneralization_run
    <span class="quoted">dgbta</span> <span class="quoted">dgbta.alphabet</span> <span class="quoted">dgbta.initial</span> <span class="quoted">dgbta.transition</span> <span class="quoted">dgbta.accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> gen infs <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span> <span class="main">|||</span> <span class="bound">w</span> <span class="main">|||</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted">dbta</span> <span class="quoted">dbta.alphabet</span> <span class="quoted">dbta.initial</span> <span class="quoted">dbta.transition</span> <span class="quoted">dbta.accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> infs <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span> <span class="main">|||</span> <span class="bound">w</span> <span class="main">|||</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted">id</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="main">(</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">k</span><span class="main">)</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">,</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">defines</span></span> degeneralize <span class="main">=</span> <span class="quoted">degeneralization.degeneralize</span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> stream"</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> stream"</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">cs</span> <span class="skolem">p</span> <span class="skolem">k</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="main">(</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">k</span><span class="main">)</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">,</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sscan <span class="main">(</span>count <span class="skolem">cs</span> <span class="main">∘</span> id<span class="main">)</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">##</span> <span class="skolem">r</span> <span class="main">|||</span> <span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span>degen <span class="skolem">cs</span> <span class="main">∘</span> <span class="var">?f</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">##</span> <span class="main">(</span><span class="skolem">r</span> <span class="main">|||</span> <span class="var">?s</span><span class="main">)</span> <span class="main">|||</span> <span class="skolem">w</span> <span class="main">|||</span> <span class="main">(</span><span class="skolem">r</span> <span class="main">|||</span> <span class="var">?s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span>
      infs <span class="main">(</span>degen <span class="skolem">cs</span><span class="main">)</span> <span class="main">(</span>smap <span class="var">?f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">##</span> <span class="main">(</span><span class="skolem">r</span> <span class="main">|||</span> <span class="var">?s</span><span class="main">)</span> <span class="main">|||</span> <span class="skolem">w</span> <span class="main">|||</span> <span class="main">(</span><span class="skolem">r</span> <span class="main">|||</span> <span class="var">?s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"smap <span class="var">?f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">##</span> <span class="main">(</span><span class="skolem">r</span> <span class="main">|||</span> <span class="var">?s</span><span class="main">)</span> <span class="main">|||</span> <span class="skolem">w</span> <span class="main">|||</span> <span class="main">(</span><span class="skolem">r</span> <span class="main">|||</span> <span class="var">?s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">##</span> <span class="skolem">r</span> <span class="main">|||</span> <span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">|||</span> <span class="skolem">k</span> <span class="main">##</span> <span class="var">?s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="skolem">r</span></span> <span class="quoted"><span class="skolem">w</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eq_scons <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> szip_unfold sscan_scons<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">##</span> <span class="skolem">r</span> <span class="main">|||</span> <span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">|||</span> <span class="skolem">k</span> <span class="main">##</span> sscan <span class="main">(</span>count <span class="skolem">cs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">##</span> <span class="skolem">r</span> <span class="main">|||</span> <span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span>degen <span class="skolem">cs</span><span class="main">)</span> <span class="main">…</span> <span class="main">=</span> gen infs <span class="skolem">cs</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">##</span> <span class="skolem">r</span> <span class="main">|||</span> <span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> degen_infs <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span>degen <span class="skolem">cs</span> <span class="main">∘</span> <span class="var">?f</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">##</span> <span class="main">(</span><span class="skolem">r</span> <span class="main">|||</span> <span class="var">?s</span><span class="main">)</span> <span class="main">|||</span> <span class="skolem">w</span> <span class="main">|||</span> <span class="main">(</span><span class="skolem">r</span> <span class="main">|||</span> <span class="var">?s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span>
      gen infs <span class="skolem">cs</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">##</span> <span class="skolem">r</span> <span class="main">|||</span> <span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemmas</span></span> degeneralize_language<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> degeneralization.degeneralize_language<span class="main">[</span><span class="operator">folded</span> DBTA.language_def<span class="main">]</span>
  <span class="keyword1"><span class="command">lemmas</span></span> degeneralize_nodes_finite<span class="main">[</span><span class="operator">iff</span><span class="main">]</span> <span class="main">=</span> degeneralization.degeneralize_nodes_finite<span class="main">[</span><span class="operator">folded</span> DBTA.nodes_def<span class="main">]</span>
  <span class="keyword1"><span class="command">lemmas</span></span> degeneralize_nodes_card <span class="main">=</span> degeneralization.degeneralize_nodes_card<span class="main">[</span><span class="operator">folded</span> DBTA.nodes_def<span class="main">]</span>

  <span class="keyword1"><span class="command">global_interpretation</span></span> intersection<span class="main">:</span> automaton_intersection_run
    <span class="quoted">dbta.dbta</span> <span class="quoted">dbta.alphabet</span> <span class="quoted">dbta.initial</span> <span class="quoted">dbta.transition</span> <span class="quoted">dbta.accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> infs <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span> <span class="main">|||</span> <span class="bound">w</span> <span class="main">|||</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted">dbta.dbta</span> <span class="quoted">dbta.alphabet</span> <span class="quoted">dbta.initial</span> <span class="quoted">dbta.transition</span> <span class="quoted">dbta.accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> infs <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span> <span class="main">|||</span> <span class="bound">w</span> <span class="main">|||</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted">dgbta.dgbta</span> <span class="quoted">dgbta.alphabet</span> <span class="quoted">dgbta.initial</span> <span class="quoted">dgbta.transition</span> <span class="quoted">dgbta.accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> gen infs <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span> <span class="main">|||</span> <span class="bound">w</span> <span class="main">|||</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="main">[</span><span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="main">(</span><span class="bound">q<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">q<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">q<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="main">(</span><span class="bound">q<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">q<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">q<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span><span class="main">]</span>"</span></span>
    <span class="keyword2"><span class="keyword">defines</span></span> intersect' <span class="main">=</span> <span class="quoted">intersection.product</span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> stream"</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> stream"</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span> stream"</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">p</span> <span class="skolem">q</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?tfst</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="main">(</span><span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="main">(</span><span class="bound">q<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">q<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">q<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?tsnd</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="main">(</span><span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="main">(</span><span class="bound">q<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">q<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">q<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gen infs <span class="main">[</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∘</span> <span class="var">?tfst</span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∘</span> <span class="var">?tsnd</span><span class="main">]</span> <span class="main">(</span><span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">##</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">|||</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">|||</span> <span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">u</span> <span class="main">|||</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">⟷</span>
      infs <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span>smap <span class="var">?tfst</span> <span class="main">(</span><span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">##</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">|||</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">|||</span> <span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">u</span> <span class="main">|||</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
      infs <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span>smap <span class="var">?tsnd</span> <span class="main">(</span><span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">##</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">|||</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">|||</span> <span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">u</span> <span class="main">|||</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> gen_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"smap <span class="var">?tfst</span> <span class="main">(</span><span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">##</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">|||</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">|||</span> <span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">u</span> <span class="main">|||</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">##</span> <span class="skolem">u</span> <span class="main">|||</span> <span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">q</span></span> <span class="quoted"><span class="skolem">u</span></span> <span class="quoted"><span class="skolem">v</span></span> <span class="quoted"><span class="skolem">w</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> szip_unfold<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> stream.collapse<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"smap <span class="var">?tsnd</span> <span class="main">(</span><span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">##</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">|||</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">|||</span> <span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">u</span> <span class="main">|||</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">q</span> <span class="main">##</span> <span class="skolem">v</span> <span class="main">|||</span> <span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">q</span></span> <span class="quoted"><span class="skolem">u</span></span> <span class="quoted"><span class="skolem">v</span></span> <span class="quoted"><span class="skolem">w</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> szip_unfold<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> stream.collapse<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"gen infs <span class="main">[</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∘</span> <span class="var">?tfst</span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∘</span> <span class="var">?tsnd</span><span class="main">]</span> <span class="main">(</span><span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">##</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">|||</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">|||</span> <span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">u</span> <span class="main">|||</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">⟷</span>
      infs <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="skolem">p</span> <span class="main">##</span> <span class="skolem">u</span> <span class="main">|||</span> <span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∧</span> infs <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">q</span> <span class="main">##</span> <span class="skolem">v</span> <span class="main">|||</span> <span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemmas</span></span> intersect'_language<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> intersection.product_language<span class="main">[</span><span class="operator">folded</span> DGBTA.language_def<span class="main">]</span>
  <span class="keyword1"><span class="command">lemmas</span></span> intersect'_nodes_finite <span class="main">=</span> intersection.product_nodes_finite<span class="main">[</span><span class="operator">folded</span> DGBTA.nodes_def<span class="main">]</span>
  <span class="keyword1"><span class="command">lemmas</span></span> intersect'_nodes_card <span class="main">=</span> intersection.product_nodes_card<span class="main">[</span><span class="operator">folded</span> DGBTA.nodes_def<span class="main">]</span>

  <span class="keyword1"><span class="command">global_interpretation</span></span> union<span class="main">:</span> automaton_union_run
    <span class="quoted">dbta.dbta</span> <span class="quoted">dbta.alphabet</span> <span class="quoted">dbta.initial</span> <span class="quoted">dbta.transition</span> <span class="quoted">dbta.accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> infs <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span> <span class="main">|||</span> <span class="bound">w</span> <span class="main">|||</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted">dbta.dbta</span> <span class="quoted">dbta.alphabet</span> <span class="quoted">dbta.initial</span> <span class="quoted">dbta.transition</span> <span class="quoted">dbta.accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> infs <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span> <span class="main">|||</span> <span class="bound">w</span> <span class="main">|||</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted">dbta.dbta</span> <span class="quoted">dbta.alphabet</span> <span class="quoted">dbta.initial</span> <span class="quoted">dbta.transition</span> <span class="quoted">dbta.accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> infs <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span> <span class="main">|||</span> <span class="bound">w</span> <span class="main">|||</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">pq</span><span class="main">.</span> <span class="main">(</span><span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="main">(</span><span class="bound">q<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">q<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">q<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">pq</span> <span class="main">∨</span> <span class="main">(</span><span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="main">(</span><span class="bound">q<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">q<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">q<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">pq</span>"</span></span>
    <span class="keyword2"><span class="keyword">defines</span></span> union <span class="main">=</span> <span class="quoted">union.product</span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> stream"</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> stream"</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span> stream"</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">p</span> <span class="skolem">q</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?tfst</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="main">(</span><span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="main">(</span><span class="bound">q<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">q<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">q<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?tsnd</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="main">(</span><span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="main">(</span><span class="bound">q<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">q<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">q<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span><span class="main">λ</span> <span class="bound">pq</span><span class="main">.</span> <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">q<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">q<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">q<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">pq</span> <span class="main">∨</span>
       <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">q<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">q<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">q<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">pq</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">##</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">|||</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">|||</span> <span class="skolem">w</span> <span class="main">|||</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">|||</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span>  <span class="main">⟷</span>
      infs <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span>smap <span class="var">?tfst</span> <span class="main">(</span><span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">##</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">|||</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">|||</span> <span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">u</span> <span class="main">|||</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
      infs <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span>smap <span class="var">?tsnd</span> <span class="main">(</span><span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">##</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">|||</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">|||</span> <span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">u</span> <span class="main">|||</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"smap <span class="var">?tfst</span> <span class="main">(</span><span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">##</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">|||</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">|||</span> <span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">u</span> <span class="main">|||</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">##</span> <span class="skolem">u</span> <span class="main">|||</span> <span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">q</span></span> <span class="quoted"><span class="skolem">u</span></span> <span class="quoted"><span class="skolem">v</span></span> <span class="quoted"><span class="skolem">w</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> szip_unfold<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> stream.collapse<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"smap <span class="var">?tsnd</span> <span class="main">(</span><span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">##</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">|||</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">|||</span> <span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">u</span> <span class="main">|||</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">q</span> <span class="main">##</span> <span class="skolem">v</span> <span class="main">|||</span> <span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">q</span></span> <span class="quoted"><span class="skolem">u</span></span> <span class="quoted"><span class="skolem">v</span></span> <span class="quoted"><span class="skolem">w</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> szip_unfold<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> stream.collapse<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span><span class="main">λ</span> <span class="bound">pq</span><span class="main">.</span> <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">q<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">q<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">q<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">pq</span> <span class="main">∨</span>
       <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">q<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">q<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">q<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">pq</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">##</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">|||</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">|||</span> <span class="skolem">w</span> <span class="main">|||</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">|||</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span>
      infs <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="skolem">p</span> <span class="main">##</span> <span class="skolem">u</span> <span class="main">|||</span> <span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∨</span> infs <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">q</span> <span class="main">##</span> <span class="skolem">v</span> <span class="main">|||</span> <span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemmas</span></span> union_language <span class="main">=</span> union.product_language
  <span class="keyword1"><span class="command">lemmas</span></span> union_nodes_finite <span class="main">=</span> union.product_nodes_finite
  <span class="keyword1"><span class="command">lemmas</span></span> union_nodes_card <span class="main">=</span> union.product_nodes_card

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">intersect</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">intersect</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> degeneralize <span class="main">(</span>intersect' <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="DBTA_Combine-intersect_language"><span class="command">lemma</span></span> intersect_language<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"DBTA.language <span class="main">(</span>intersect <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> DBTA.language <span class="free">A</span> <span class="main">∩</span> DBTA.language <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1" id="DBTA_Combine-intersect_nodes_finite"><span class="command">lemma</span></span> intersect_nodes_finite<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>DBTA.nodes <span class="free">A</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>DBTA.nodes <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>DBTA.nodes <span class="main">(</span>intersect <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> intersect'_nodes_finite assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1" id="DBTA_Combine-intersect_nodes_card"><span class="command">lemma</span></span> intersect_nodes_card<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>DBTA.nodes <span class="free">A</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>DBTA.nodes <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>DBTA.nodes <span class="main">(</span>intersect <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> card <span class="main">(</span>DBTA.nodes <span class="free">A</span><span class="main">)</span> <span class="main">*</span> card <span class="main">(</span>DBTA.nodes <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>DBTA.nodes <span class="main">(</span>intersect <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span>
      max <span class="main">1</span> <span class="main">(</span>length <span class="main">(</span>dgbta.accepting <span class="main">(</span>intersect' <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> card <span class="main">(</span>DGBTA.nodes <span class="main">(</span>intersect' <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> degeneralize_nodes_card <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>dgbta.accepting <span class="main">(</span>intersect' <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>DGBTA.nodes <span class="main">(</span>intersect' <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span>DBTA.nodes <span class="free">A</span><span class="main">)</span> <span class="main">*</span> card <span class="main">(</span>DBTA.nodes <span class="free">B</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> intersect'_nodes_card assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="DCA">
<div class="head">
<h1>Theory DCA</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Deterministic Co-Büchi Automata›</span></span>

<span class="keyword1"><span class="command">theory</span></span> DCA
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Deterministic.html">../Deterministic</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> dca <span class="main">=</span> dca
    <span class="main">(</span><span class="free"><span class="entity">alphabet</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> set"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">initial</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span>"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">transition</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span>"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">rejecting</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">global_interpretation</span></span> dca<span class="main">:</span> automaton <span class="quoted">dca</span> <span class="quoted">alphabet</span> <span class="quoted">initial</span> <span class="quoted">transition</span> <span class="quoted">rejecting</span>
    <span class="keyword2"><span class="keyword">defines</span></span> path <span class="main">=</span> <span class="quoted">dca.path</span> <span class="keyword2"><span class="keyword">and</span></span> run <span class="main">=</span> <span class="quoted">dca.run</span> <span class="keyword2"><span class="keyword">and</span></span> reachable <span class="main">=</span> <span class="quoted">dca.reachable</span> <span class="keyword2"><span class="keyword">and</span></span> nodes <span class="main">=</span> <span class="quoted">dca.nodes</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">global_interpretation</span></span> dca<span class="main">:</span> automaton_run <span class="quoted">dca</span> <span class="quoted">alphabet</span> <span class="quoted">initial</span> <span class="quoted">transition</span> <span class="quoted">rejecting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> fins <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">defines</span></span> language <span class="main">=</span> <span class="quoted">dca.language</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span>

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">target</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">target</span> <span class="main">≡</span> dca.target"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">states</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">states</span> <span class="main">≡</span> dca.states"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">trace</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">trace</span> <span class="main">≡</span> dca.trace"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">successors</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">successors</span> <span class="main">≡</span> dca.successors <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'label</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="DGCA">
<div class="head">
<h1>Theory DGCA</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Deterministic Co-Generalized Co-Büchi Automata›</span></span>

<span class="keyword1"><span class="command">theory</span></span> DGCA
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Deterministic.html">../Deterministic</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> dgca <span class="main">=</span> dgca
    <span class="main">(</span><span class="free"><span class="entity">alphabet</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> set"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">initial</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span>"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">transition</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span>"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">rejecting</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> pred gen"</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">global_interpretation</span></span> dgca<span class="main">:</span> automaton <span class="quoted">dgca</span> <span class="quoted">alphabet</span> <span class="quoted">initial</span> <span class="quoted">transition</span> <span class="quoted">rejecting</span>
    <span class="keyword2"><span class="keyword">defines</span></span> path <span class="main">=</span> <span class="quoted">dgca.path</span> <span class="keyword2"><span class="keyword">and</span></span> run <span class="main">=</span> <span class="quoted">dgca.run</span> <span class="keyword2"><span class="keyword">and</span></span> reachable <span class="main">=</span> <span class="quoted">dgca.reachable</span> <span class="keyword2"><span class="keyword">and</span></span> nodes <span class="main">=</span> <span class="quoted">dgca.nodes</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">global_interpretation</span></span> dgca<span class="main">:</span> automaton_run <span class="quoted">dgca</span> <span class="quoted">alphabet</span> <span class="quoted">initial</span> <span class="quoted">transition</span> <span class="quoted">rejecting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> cogen fins <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">defines</span></span> language <span class="main">=</span> <span class="quoted">dgca.language</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span>

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">target</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">target</span> <span class="main">≡</span> dgca.target"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">states</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">states</span> <span class="main">≡</span> dgca.states"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">trace</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">trace</span> <span class="main">≡</span> dgca.trace"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">successors</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">successors</span> <span class="main">≡</span> dgca.successors <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'label</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="DCA_Combine">
<div class="head">
<h1>Theory DCA_Combine</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Deterministic Co-Büchi Automata Combinations›</span></span>

<span class="keyword1"><span class="command">theory</span></span> DCA_Combine
<span class="keyword2"><span class="keyword">imports</span></span> <a href="DCA.html">DCA</a> <a href="DGCA.html">DGCA</a>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">global_interpretation</span></span> degeneralization<span class="main">:</span> automaton_degeneralization_run
    <span class="quoted">dgca</span> <span class="quoted">dgca.alphabet</span> <span class="quoted">dgca.initial</span> <span class="quoted">dgca.transition</span> <span class="quoted">dgca.rejecting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> cogen fins <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted">dca</span> <span class="quoted">dca.alphabet</span> <span class="quoted">dca.initial</span> <span class="quoted">dca.transition</span> <span class="quoted">dca.rejecting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> fins <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted">fst</span> <span class="quoted">id</span>
    <span class="keyword2"><span class="keyword">defines</span></span> degeneralize <span class="main">=</span> <span class="quoted">degeneralization.degeneralize</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> sscan_smap<span class="main">)</span>

  <span class="keyword1"><span class="command">lemmas</span></span> degeneralize_language<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> degeneralization.degeneralize_language<span class="main">[</span><span class="operator">folded</span> DCA.language_def<span class="main">]</span>
  <span class="keyword1"><span class="command">lemmas</span></span> degeneralize_nodes_finite<span class="main">[</span><span class="operator">iff</span><span class="main">]</span> <span class="main">=</span> degeneralization.degeneralize_nodes_finite<span class="main">[</span><span class="operator">folded</span> DCA.nodes_def<span class="main">]</span>
  <span class="keyword1"><span class="command">lemmas</span></span> degeneralize_nodes_card <span class="main">=</span> degeneralization.degeneralize_nodes_card<span class="main">[</span><span class="operator">folded</span> DCA.nodes_def<span class="main">]</span>

  <span class="keyword1"><span class="command">global_interpretation</span></span> intersection<span class="main">:</span> automaton_intersection_run
    <span class="quoted">dca.dca</span> <span class="quoted">dca.alphabet</span> <span class="quoted">dca.initial</span> <span class="quoted">dca.transition</span> <span class="quoted">dca.rejecting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> fins <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted">dca.dca</span> <span class="quoted">dca.alphabet</span> <span class="quoted">dca.initial</span> <span class="quoted">dca.transition</span> <span class="quoted">dca.rejecting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> fins <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted">dca.dca</span> <span class="quoted">dca.alphabet</span> <span class="quoted">dca.initial</span> <span class="quoted">dca.transition</span> <span class="quoted">dca.rejecting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> fins <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">pq</span><span class="main">.</span> <span class="main">(</span><span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∘</span> fst<span class="main">)</span> <span class="bound">pq</span> <span class="main">∨</span> <span class="main">(</span><span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∘</span> snd<span class="main">)</span> <span class="bound">pq</span>"</span></span>
    <span class="keyword2"><span class="keyword">defines</span></span> intersect <span class="main">=</span> <span class="quoted">intersection.product</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> comp_apply<span class="main">)</span>

  <span class="keyword1"><span class="command">lemmas</span></span> intersect_language <span class="main">=</span> intersection.product_language
  <span class="keyword1"><span class="command">lemmas</span></span> intersect_nodes_finite <span class="main">=</span> intersection.product_nodes_finite
  <span class="keyword1"><span class="command">lemmas</span></span> intersect_nodes_card <span class="main">=</span> intersection.product_nodes_card

  <span class="keyword1"><span class="command">global_interpretation</span></span> union<span class="main">:</span> automaton_union_run
    <span class="quoted">dca.dca</span> <span class="quoted">dca.alphabet</span> <span class="quoted">dca.initial</span> <span class="quoted">dca.transition</span> <span class="quoted">dca.rejecting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> fins <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted">dca.dca</span> <span class="quoted">dca.alphabet</span> <span class="quoted">dca.initial</span> <span class="quoted">dca.transition</span> <span class="quoted">dca.rejecting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> fins <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted">dgca.dgca</span> <span class="quoted">dgca.alphabet</span> <span class="quoted">dgca.initial</span> <span class="quoted">dgca.transition</span> <span class="quoted">dgca.rejecting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> cogen fins <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="main">[</span><span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∘</span> fst<span class="main">,</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∘</span> snd<span class="main">]</span>"</span></span>
    <span class="keyword2"><span class="keyword">defines</span></span> union' <span class="main">=</span> <span class="quoted">union.product</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">lemmas</span></span> union'_language<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> union.product_language<span class="main">[</span><span class="operator">folded</span> DGCA.language_def<span class="main">]</span>
  <span class="keyword1"><span class="command">lemmas</span></span> union'_nodes_finite <span class="main">=</span> union.product_nodes_finite<span class="main">[</span><span class="operator">folded</span> DGCA.nodes_def<span class="main">]</span>
  <span class="keyword1"><span class="command">lemmas</span></span> union'_nodes_card <span class="main">=</span> union.product_nodes_card<span class="main">[</span><span class="operator">folded</span> DGCA.nodes_def<span class="main">]</span>

  <span class="keyword1"><span class="command">global_interpretation</span></span> intersection_list<span class="main">:</span> automaton_intersection_list_run
    <span class="quoted">dca.dca</span> <span class="quoted">dca.alphabet</span> <span class="quoted">dca.initial</span> <span class="quoted">dca.transition</span> <span class="quoted">dca.rejecting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> fins <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted">dca.dca</span> <span class="quoted">dca.alphabet</span> <span class="quoted">dca.initial</span> <span class="quoted">dca.transition</span> <span class="quoted">dca.rejecting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> fins <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">cs</span> <span class="bound">pp</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">k</span></span> <span class="main">&lt;</span> length <span class="bound">cs</span><span class="main">.</span> <span class="main">(</span><span class="bound">cs</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span><span class="bound">pp</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">defines</span></span> intersect_list <span class="main">=</span> <span class="quoted">intersection_list.product</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_def<span class="main">)</span>

  <span class="keyword1"><span class="command">lemmas</span></span> intersect_list_language <span class="main">=</span> intersection_list.product_language
  <span class="keyword1"><span class="command">lemmas</span></span> intersect_list_nodes_finite <span class="main">=</span> intersection_list.product_nodes_finite
  <span class="keyword1"><span class="command">lemmas</span></span> intersect_list_nodes_card <span class="main">=</span> intersection_list.product_nodes_card

  <span class="keyword1"><span class="command">global_interpretation</span></span> union_list<span class="main">:</span> automaton_union_list_run
    <span class="quoted">dca.dca</span> <span class="quoted">dca.alphabet</span> <span class="quoted">dca.initial</span> <span class="quoted">dca.transition</span> <span class="quoted">dca.rejecting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> fins <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted">dgca.dgca</span> <span class="quoted">dgca.alphabet</span> <span class="quoted">dgca.initial</span> <span class="quoted">dgca.transition</span> <span class="quoted">dgca.rejecting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> cogen fins <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">cs</span><span class="main">.</span> map <span class="main">(</span><span class="main">λ</span> <span class="bound">k</span> <span class="bound">pp</span><span class="main">.</span> <span class="main">(</span><span class="bound">cs</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span><span class="bound">pp</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> length <span class="bound">cs</span><span class="main">]</span>"</span></span>
    <span class="keyword2"><span class="keyword">defines</span></span> union_list' <span class="main">=</span> <span class="quoted">union_list.product</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cogen_def comp_def<span class="main">)</span>

  <span class="keyword1"><span class="command">lemmas</span></span> union_list'_language<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> union_list.product_language<span class="main">[</span><span class="operator">folded</span> DGCA.language_def<span class="main">]</span>
  <span class="keyword1"><span class="command">lemmas</span></span> union_list'_nodes_finite <span class="main">=</span> union_list.product_nodes_finite<span class="main">[</span><span class="operator">folded</span> DGCA.nodes_def<span class="main">]</span>
  <span class="keyword1"><span class="command">lemmas</span></span> union_list'_nodes_card <span class="main">=</span> union_list.product_nodes_card<span class="main">[</span><span class="operator">folded</span> DGCA.nodes_def<span class="main">]</span>

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">union</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">union</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> degeneralize <span class="main">(</span>union' <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="DCA_Combine-union_language"><span class="command">lemma</span></span> union_language<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dca.alphabet <span class="free">A</span> <span class="main">=</span> dca.alphabet <span class="free">B</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"DCA.language <span class="main">(</span>union <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> DCA.language <span class="free">A</span> <span class="main">∪</span> DCA.language <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1" id="DCA_Combine-union_nodes_finite"><span class="command">lemma</span></span> union_nodes_finite<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>DCA.nodes <span class="free">A</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>DCA.nodes <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>DCA.nodes <span class="main">(</span>union <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> union'_nodes_finite assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1" id="DCA_Combine-union_nodes_card"><span class="command">lemma</span></span> union_nodes_card<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>DCA.nodes <span class="free">A</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>DCA.nodes <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>DCA.nodes <span class="main">(</span>union <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> card <span class="main">(</span>DCA.nodes <span class="free">A</span><span class="main">)</span> <span class="main">*</span> card <span class="main">(</span>DCA.nodes <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>DCA.nodes <span class="main">(</span>union <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span>
      max <span class="main">1</span> <span class="main">(</span>length <span class="main">(</span>dgca.rejecting <span class="main">(</span>union' <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> card <span class="main">(</span>DGCA.nodes <span class="main">(</span>union' <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> degeneralize_nodes_card <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>dgca.rejecting <span class="main">(</span>union' <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>DGCA.nodes <span class="main">(</span>union' <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span>DCA.nodes <span class="free">A</span><span class="main">)</span> <span class="main">*</span> card <span class="main">(</span>DCA.nodes <span class="free">B</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> union'_nodes_card assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">union_list</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">union_list</span> <span class="free"><span class="bound"><span class="entity">AA</span></span></span> <span class="main">≡</span> degeneralize <span class="main">(</span>union_list' <span class="free"><span class="bound"><span class="entity">AA</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="DCA_Combine-union_list_language"><span class="command">lemma</span></span> union_list_language<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋂</span> <span class="main">(</span>dca.alphabet <span class="main">`</span> set <span class="free">AA</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span>dca.alphabet <span class="main">`</span> set <span class="free">AA</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"DCA.language <span class="main">(</span>union_list <span class="free">AA</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span>DCA.language <span class="main">`</span> set <span class="free">AA</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1" id="DCA_Combine-union_list_nodes_finite"><span class="command">lemma</span></span> union_list_nodes_finite<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>finite <span class="main">∘</span> DCA.nodes<span class="main">)</span> <span class="free">AA</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>DCA.nodes <span class="main">(</span>union_list <span class="free">AA</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> union_list'_nodes_finite assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1" id="DCA_Combine-union_list_nodes_card"><span class="command">lemma</span></span> union_list_nodes_card<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>finite <span class="main">∘</span> DCA.nodes<span class="main">)</span> <span class="free">AA</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>DCA.nodes <span class="main">(</span>union_list <span class="free">AA</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> max <span class="main">1</span> <span class="main">(</span>length <span class="free">AA</span><span class="main">)</span> <span class="main">*</span> prod_list <span class="main">(</span>map <span class="main">(</span>card <span class="main">∘</span> DCA.nodes<span class="main">)</span> <span class="free">AA</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>DCA.nodes <span class="main">(</span>union_list <span class="free">AA</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span>
      max <span class="main">1</span> <span class="main">(</span>length <span class="main">(</span>dgca.rejecting <span class="main">(</span>union_list' <span class="free">AA</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> card <span class="main">(</span>DGCA.nodes <span class="main">(</span>union_list' <span class="free">AA</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> degeneralize_nodes_card <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>dgca.rejecting <span class="main">(</span>union_list' <span class="free">AA</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="free">AA</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>DGCA.nodes <span class="main">(</span>union_list' <span class="free">AA</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> prod_list <span class="main">(</span>map <span class="main">(</span>card <span class="main">∘</span> DCA.nodes<span class="main">)</span> <span class="free">AA</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> union_list'_nodes_card assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="DRA">
<div class="head">
<h1>Theory DRA</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Deterministic Rabin Automata›</span></span>

<span class="keyword1"><span class="command">theory</span></span> DRA
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Deterministic.html">../Deterministic</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> dra <span class="main">=</span> dra
    <span class="main">(</span><span class="free"><span class="entity">alphabet</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> set"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">initial</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span>"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">transition</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span>"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">condition</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> rabin gen"</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">global_interpretation</span></span> dra<span class="main">:</span> automaton <span class="quoted">dra</span> <span class="quoted">alphabet</span> <span class="quoted">initial</span> <span class="quoted">transition</span> <span class="quoted">condition</span>
    <span class="keyword2"><span class="keyword">defines</span></span> path <span class="main">=</span> <span class="quoted">dra.path</span> <span class="keyword2"><span class="keyword">and</span></span> run <span class="main">=</span> <span class="quoted">dra.run</span> <span class="keyword2"><span class="keyword">and</span></span> reachable <span class="main">=</span> <span class="quoted">dra.reachable</span> <span class="keyword2"><span class="keyword">and</span></span> nodes <span class="main">=</span> <span class="quoted">dra.nodes</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">global_interpretation</span></span> dra<span class="main">:</span> automaton_run <span class="quoted">dra</span> <span class="quoted">alphabet</span> <span class="quoted">initial</span> <span class="quoted">transition</span> <span class="quoted">condition</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> cogen rabin <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">defines</span></span> language <span class="main">=</span> <span class="quoted">dra.language</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span>

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">target</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">target</span> <span class="main">≡</span> dra.target"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">states</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">states</span> <span class="main">≡</span> dra.states"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">trace</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">trace</span> <span class="main">≡</span> dra.trace"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">successors</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">successors</span> <span class="main">≡</span> dra.successors <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'label</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="DRA_Combine">
<div class="head">
<h1>Theory DRA_Combine</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Deterministic Rabin Automata Combinations›</span></span>

<span class="keyword1"><span class="command">theory</span></span> DRA_Combine
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="DRA.html">DRA</a>"</span> <span class="quoted">"<a href="DBA.html">../DBA/DBA</a>"</span> <span class="quoted">"<a href="DCA.html">../DCA/DCA</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">global_interpretation</span></span> intersection_bc<span class="main">:</span> automaton_intersection_run
    <span class="quoted">dba.dba</span> <span class="quoted">dba.alphabet</span> <span class="quoted">dba.initial</span> <span class="quoted">dba.transition</span> <span class="quoted">dba.accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> infs <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted">dca.dca</span> <span class="quoted">dca.alphabet</span> <span class="quoted">dca.initial</span> <span class="quoted">dca.transition</span> <span class="quoted">dca.rejecting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> fins <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted">dra.dra</span> <span class="quoted">dra.alphabet</span> <span class="quoted">dra.initial</span> <span class="quoted">dra.transition</span> <span class="quoted">dra.condition</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> cogen rabin <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="main">[</span><span class="main">(</span><span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∘</span> fst<span class="main">,</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∘</span> snd<span class="main">)</span><span class="main">]</span>"</span></span>
    <span class="keyword2"><span class="keyword">defines</span></span> intersect_bc <span class="main">=</span> <span class="quoted">intersection_bc.product</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cogen_def rabin_def<span class="main">)</span>

  <span class="comment1">(* TODO: why are only the constants of the first interpretation folded back correctly? *)</span>
  <span class="keyword1"><span class="command">lemmas</span></span> intersect_bc_language<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> intersection_bc.product_language<span class="main">[</span><span class="operator">folded</span> DCA.language_def DRA.language_def<span class="main">]</span>
  <span class="keyword1"><span class="command">lemmas</span></span> intersect_bc_nodes_finite <span class="main">=</span> intersection_bc.product_nodes_finite<span class="main">[</span><span class="operator">folded</span> DCA.nodes_def DRA.nodes_def<span class="main">]</span>
  <span class="keyword1"><span class="command">lemmas</span></span> intersect_bc_nodes_card <span class="main">=</span> intersection_bc.product_nodes_card<span class="main">[</span><span class="operator">folded</span> DCA.nodes_def DRA.nodes_def<span class="main">]</span>

  <span class="comment1">(* TODO: are there some statements about the rabin constant hidden in here?
    same for gen/cogen, also in other combinations, shouldn't have to unfold those *)</span>
  <span class="keyword1"><span class="command">global_interpretation</span></span> union_list<span class="main">:</span> automaton_union_list_run
    <span class="quoted">dra.dra</span> <span class="quoted">dra.alphabet</span> <span class="quoted">dra.initial</span> <span class="quoted">dra.transition</span> <span class="quoted">dra.condition</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> cogen rabin <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted">dra.dra</span> <span class="quoted">dra.alphabet</span> <span class="quoted">dra.initial</span> <span class="quoted">dra.transition</span> <span class="quoted">dra.condition</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> cogen rabin <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">cs</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span> <span class="bound">k</span> <span class="main">←</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> length <span class="bound">cs</span><span class="main">]</span><span class="main">;</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">g</span><span class="main">)</span> <span class="main">←</span> <span class="bound">cs</span> <span class="main">!</span> <span class="bound">k</span><span class="main">;</span> <span class="main">[</span><span class="main">(</span><span class="main">λ</span> <span class="bound">pp</span><span class="main">.</span> <span class="bound">f</span> <span class="main">(</span><span class="bound">pp</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">,</span> <span class="main">λ</span> <span class="bound">pp</span><span class="main">.</span> <span class="bound">g</span> <span class="main">(</span><span class="bound">pp</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">defines</span></span> union_list <span class="main">=</span> <span class="quoted">union_list.product</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cogen_def rabin_def comp_def split_beta<span class="main">)</span>

  <span class="keyword1"><span class="command">lemmas</span></span> union_list_language <span class="main">=</span> union_list.product_language
  <span class="keyword1"><span class="command">lemmas</span></span> union_list_nodes_finite <span class="main">=</span> union_list.product_nodes_finite
  <span class="keyword1"><span class="command">lemmas</span></span> union_list_nodes_card <span class="main">=</span> union_list.product_nodes_card

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Refine">
<div class="head">
<h1>Theory Refine</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Relations and Refinement›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Refine
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../Automatic_Refinement/Automatic_Refinement.html">Automatic_Refinement.Automatic_Refinement</a>"</span>
  <span class="comment1">(* TODO Peter: list_set_rel is defined in Refine_Monadic.Refine_Foreach,
    but it should probably be somewhere in Automatic_Refinement as it has nothing to do
    with the nondeterminism monad *)</span>
  <span class="quoted">"<a href="../Refine_Monadic/Refine_Foreach.html">Refine_Monadic.Refine_Foreach</a>"</span>
  <span class="quoted">"<a href="Sequence_LTL.html">Sequence_LTL</a>"</span>
  <span class="quoted">"<a href="Maps.html">Maps</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="comment1">(* TODO Peter:
    - there is some infrastructure for converting between predicates and sets using
      the constants rel2p and p2rel
    - however, HOL already has the pred_set_conv attributes
    - with some additional setup connecting the refinement framework relators to their
      lifting/transfer counterparts, the attribute to_set can be used to instantly convert
      lifting/transfer rules to set-based relation format
    - examples can be found throughout this theory (look for the to_set attribute)
  *)</span>
  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Predicate to Set Conversion Setup›</span></span>

  <span class="comment1">(* TODO Peter: it would be nice if there were corresponding constants for all the relation predicates
    in Transfer.thy (left_total, left_unique, right_total, right_unique, bi_total, bi_unique *)</span>
  <span class="keyword1" id="Refine-right_unique_pred_set_conv"><span class="command">lemma</span></span> right_unique_pred_set_conv<span class="main">[</span><span class="operator">pred_set_conv</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"right_unique <span class="main">=</span> single_valuedp"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> right_unique_def single_valuedp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="Refine-bi_unique_pred_set_conv"><span class="command">lemma</span></span> bi_unique_pred_set_conv<span class="main">[</span><span class="operator">pred_set_conv</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bi_unique <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">)</span> <span class="main">⟷</span> bijective <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> bi_unique_def bijective_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹useful for unfolding equality constants in theorems about predicates›</span></span>
  <span class="keyword1" id="Refine-pred_Id"><span class="command">lemma</span></span> pred_Id<span class="main">:</span> <span class="quoted"><span class="quoted">"HOL.eq <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> Id<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1" id="Refine-pred_bool_Id"><span class="command">lemma</span></span> pred_bool_Id<span class="main">:</span> <span class="quoted"><span class="quoted">"HOL.eq <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>Id <span class="main">::</span> bool rel<span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1" id="Refine-pred_nat_Id"><span class="command">lemma</span></span> pred_nat_Id<span class="main">:</span> <span class="quoted"><span class="quoted">"HOL.eq <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>Id <span class="main">::</span> nat rel<span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1" id="Refine-pred_set_Id"><span class="command">lemma</span></span> pred_set_Id<span class="main">:</span> <span class="quoted"><span class="quoted">"HOL.eq <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>Id <span class="main">::</span> <span class="tfree">'a</span> set rel<span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1" id="Refine-pred_list_Id"><span class="command">lemma</span></span> pred_list_Id<span class="main">:</span> <span class="quoted"><span class="quoted">"HOL.eq <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>Id <span class="main">::</span> <span class="tfree">'a</span> list rel<span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1" id="Refine-pred_stream_Id"><span class="command">lemma</span></span> pred_stream_Id<span class="main">:</span> <span class="quoted"><span class="quoted">"HOL.eq <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>Id <span class="main">::</span> <span class="tfree">'a</span> stream rel<span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1" id="Refine-eq_onp_Id_on_eq"><span class="command">lemma</span></span> eq_onp_Id_on_eq<span class="main">[</span><span class="operator">pred_set_conv</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eq_onp <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> Id_on <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> eq_onp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="Refine-rel_fun_fun_rel_eq"><span class="command">lemma</span></span> rel_fun_fun_rel_eq<span class="main">[</span><span class="operator">pred_set_conv</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"rel_fun <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">f</span> <span class="bound">g</span><span class="main">.</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">g</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">→</span> <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_fun_def fun_rel_def<span class="main">)</span>
  <span class="keyword1" id="Refine-rel_prod_prod_rel_eq"><span class="command">lemma</span></span> rel_prod_prod_rel_eq<span class="main">[</span><span class="operator">pred_set_conv</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"rel_prod <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">f</span> <span class="bound">g</span><span class="main">.</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">g</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prod_rel_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> rel_prod.cases<span class="main">)</span>
  <span class="keyword1" id="Refine-rel_sum_sum_rel_eq"><span class="command">lemma</span></span> rel_sum_sum_rel_eq<span class="main">[</span><span class="operator">pred_set_conv</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"rel_sum <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">f</span> <span class="bound">g</span><span class="main">.</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">g</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">⟩</span> sum_rel<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sum_rel_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> rel_sum.cases<span class="main">)</span>
  <span class="keyword1" id="Refine-rel_set_set_rel_eq"><span class="command">lemma</span></span> rel_set_set_rel_eq<span class="main">[</span><span class="operator">pred_set_conv</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"rel_set <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">f</span> <span class="bound">g</span><span class="main">.</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">g</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> set_rel<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rel_set_def set_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1" id="Refine-rel_option_option_rel_eq"><span class="command">lemma</span></span> rel_option_option_rel_eq<span class="main">[</span><span class="operator">pred_set_conv</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"rel_option <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">f</span> <span class="bound">g</span><span class="main">.</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">g</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> option_rel<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> option_rel_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> option.rel_cases<span class="main">)</span>

  <span class="comment1">(* TODO Peter: pred_set_conv examples *)</span>
  <span class="keyword1"><span class="command">thm</span></span> image_transfer image_transfer<span class="main">[</span><span class="operator">to_set</span><span class="main">]</span>
  <span class="keyword1"><span class="command">thm</span></span> fun_upd_transfer fun_upd_transfer<span class="main">[</span><span class="operator">to_set</span><span class="main">]</span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Relation Composition›</span></span>

  <span class="keyword1" id="Refine-relcomp_trans_1"><span class="command">lemma</span></span> relcomp_trans_1<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">g</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">g</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">O</span> <span class="free">A<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> relcompI assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1" id="Refine-relcomp_trans_2"><span class="command">lemma</span></span> relcomp_trans_2<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">g</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">→</span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">g</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">→</span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">O</span> <span class="free">A<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">→</span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">O</span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">note</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> assms<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span>
      fun_rel_comp_dist
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="Refine-relcomp_trans_3"><span class="command">lemma</span></span> relcomp_trans_3<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">g</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">→</span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">→</span> <span class="free">C<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">g</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">→</span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">→</span> <span class="free">C<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">O</span> <span class="free">A<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">→</span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">O</span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">→</span> <span class="free">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">O</span> <span class="free">C<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">note</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> assms<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span>
      fun_rel_mono<span class="main">[</span><span class="operator">OF</span> order_refl
      fun_rel_comp_dist<span class="main">]</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="Refine-relcomp_trans_4"><span class="command">lemma</span></span> relcomp_trans_4<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">g</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">→</span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">→</span> <span class="free">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">→</span> <span class="free">D<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">g</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">→</span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">→</span> <span class="free">C<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">→</span> <span class="free">D<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">O</span> <span class="free">A<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">→</span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">O</span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">→</span> <span class="free">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">O</span> <span class="free">C<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">→</span> <span class="free">D<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">O</span> <span class="free">D<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">note</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> assms<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span>
      fun_rel_mono<span class="main">[</span><span class="operator">OF</span> order_refl
      fun_rel_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> order_refl
      fun_rel_comp_dist<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="Refine-relcomp_trans_5"><span class="command">lemma</span></span> relcomp_trans_5<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">g</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">→</span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">→</span> <span class="free">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">→</span> <span class="free">D<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">→</span> <span class="free">E<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">g</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">→</span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">→</span> <span class="free">C<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">→</span> <span class="free">D<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">→</span> <span class="free">E<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">h</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">O</span> <span class="free">A<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">→</span> <span class="free">B<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">O</span> <span class="free">B<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">→</span> <span class="free">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">O</span> <span class="free">C<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">→</span> <span class="free">D<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">O</span> <span class="free">D<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">→</span> <span class="free">E<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">O</span> <span class="free">E<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">note</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> assms<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span>
      fun_rel_mono<span class="main">[</span><span class="operator">OF</span> order_refl
      fun_rel_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> order_refl
      fun_rel_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> order_refl
      fun_rel_comp_dist<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Relation Basics›</span></span>

  <span class="comment1">(* TODO Peter: these were copied from Sepref_HOL_Bindings, they should probably be part of
    $AFP/Automatic_Refinement *)</span>
  <span class="keyword1" id="Refine-inv_fun_rel_eq"><span class="command">lemma</span></span> inv_fun_rel_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">→</span><span class="free">B</span><span class="main">)</span><span class="main">¯</span> <span class="main">=</span> <span class="free">A</span><span class="main">¯</span><span class="main">→</span><span class="free">B</span><span class="main">¯</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fun_relD<span class="main">)</span>
  <span class="keyword1" id="Refine-inv_option_rel_eq"><span class="command">lemma</span></span> inv_option_rel_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span><span class="free">K</span><span class="main">⟩</span>option_rel<span class="main">)</span><span class="main">¯</span> <span class="main">=</span> <span class="main">⟨</span><span class="free">K</span><span class="main">¯</span><span class="main">⟩</span>option_rel"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> option_rel_def<span class="main">)</span>
  <span class="keyword1" id="Refine-inv_prod_rel_eq"><span class="command">lemma</span></span> inv_prod_rel_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">Q</span><span class="main">)</span><span class="main">¯</span> <span class="main">=</span> <span class="free">P</span><span class="main">¯</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">Q</span><span class="main">¯</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1" id="Refine-inv_sum_rel_eq"><span class="command">lemma</span></span> inv_sum_rel_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span><span class="free">P</span><span class="main">,</span><span class="free">Q</span><span class="main">⟩</span>sum_rel<span class="main">)</span><span class="main">¯</span> <span class="main">=</span> <span class="main">⟨</span><span class="free">P</span><span class="main">¯</span><span class="main">,</span><span class="free">Q</span><span class="main">¯</span><span class="main">⟩</span>sum_rel"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sum_rel_def<span class="main">)</span>
  <span class="keyword1" id="Refine-set_rel_converse"><span class="command">lemma</span></span> set_rel_converse<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> set_rel<span class="main">)</span><span class="main">¯</span> <span class="main">=</span> <span class="main">⟨</span><span class="free">A</span><span class="main">¯</span><span class="main">⟩</span> set_rel"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> set_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Refine-build_rel_domain"><span class="command">lemma</span></span> build_rel_domain<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Domain <span class="main">(</span>br <span class="free">α</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> Collect <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> build_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="Refine-build_rel_range"><span class="command">lemma</span></span> build_rel_range<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Range <span class="main">(</span>br <span class="free">α</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> <span class="free">α</span> <span class="main">`</span> Collect <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> build_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="Refine-build_rel_image"><span class="command">lemma</span></span> build_rel_image<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"br <span class="free">α</span> <span class="free">I</span> <span class="main">``</span> <span class="free">A</span> <span class="main">=</span> <span class="free">α</span> <span class="main">`</span> <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> Collect <span class="free">I</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> build_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Refine-prod_rel_domain"><span class="command">lemma</span></span> prod_rel_domain<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Domain <span class="main">(</span><span class="free">A</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> Domain <span class="free">A</span> <span class="main">×</span> Domain <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> prod_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="Refine-prod_rel_range"><span class="command">lemma</span></span> prod_rel_range<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Range <span class="main">(</span><span class="free">A</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> Range <span class="free">A</span> <span class="main">×</span> Range <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> prod_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Refine-member_Id_on"><span class="command">lemma</span></span> member_Id_on<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> Id_on <span class="free">A</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Id_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="Refine-bijective_Id_on"><span class="command">lemma</span></span> bijective_Id_on<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bijective <span class="main">(</span>Id_on <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> bijective_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="Refine-relcomp_Id_on"><span class="command">lemma</span></span> relcomp_Id_on<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Id_on <span class="free">A</span> <span class="keyword1">O</span> Id_on <span class="free">B</span> <span class="main">=</span> Id_on <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Refine-prod_rel_Id_on"><span class="command">lemma</span></span> prod_rel_Id_on<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Id_on <span class="free">A</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> Id_on <span class="free">B</span> <span class="main">=</span> Id_on <span class="main">(</span><span class="free">A</span> <span class="main">×</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="Refine-set_rel_Id_on"><span class="command">lemma</span></span> set_rel_Id_on<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Id_on <span class="free">S</span><span class="main">⟩</span> set_rel <span class="main">=</span> Id_on <span class="main">(</span>Pow <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> set_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Parametricity›</span></span>

  <span class="keyword1"><span class="command">lemmas</span></span> basic_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span> <span class="main">=</span>
    option.rel_transfer<span class="main">[</span><span class="operator">unfolded</span> pred_bool_Id<span class="main">,</span> <span class="operator">to_set</span><span class="main">]</span>
    All_transfer<span class="main">[</span><span class="operator">unfolded</span> pred_bool_Id<span class="main">,</span> <span class="operator">to_set</span><span class="main">]</span>
    Ex_transfer<span class="main">[</span><span class="operator">unfolded</span> pred_bool_Id<span class="main">,</span> <span class="operator">to_set</span><span class="main">]</span>
    Union_transfer<span class="main">[</span><span class="operator">to_set</span><span class="main">]</span>
    image_transfer<span class="main">[</span><span class="operator">to_set</span><span class="main">]</span>
    Image_parametric<span class="main">[</span><span class="operator">to_set</span><span class="main">]</span>

  <span class="keyword1" id="Refine-Sigma_param"><span class="command">lemma</span></span> Sigma_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Sigma<span class="main">,</span> Sigma<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> set_rel <span class="main">→</span> <span class="main">(</span><span class="free">A</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">B</span><span class="main">⟩</span> set_rel<span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">A</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">B</span><span class="main">⟩</span> set_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Sigma_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
  <span class="comment1">(* TODO: Lifting_Set.filter_transfer is too weak *)</span>
  <span class="keyword1" id="Refine-set_filter_param"><span class="command">lemma</span></span> set_filter_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>Set.filter<span class="main">,</span> Set.filter<span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">A</span> <span class="main">→</span> bool_rel<span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> set_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> set_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Set.filter_def fun_rel_def set_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1" id="Refine-is_singleton_param"><span class="command">lemma</span></span> is_singleton_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bijective <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>is_singleton<span class="main">,</span> is_singleton<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> set_rel <span class="main">→</span> bool_rel"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> is_singleton_def set_rel_def bijective_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1" id="Refine-the_elem_param"><span class="command">lemma</span></span> the_elem_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_singleton <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"is_singleton <span class="free">T</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">S</span><span class="main">,</span> <span class="free">T</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> set_rel"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>the_elem <span class="free">S</span><span class="main">,</span> the_elem <span class="free">T</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> set_rel_def is_singleton_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lists›</span></span>

  <span class="keyword1" id="Refine-list_all2_list_rel_conv"><span class="command">lemma</span></span> list_all2_list_rel_conv<span class="main">[</span><span class="operator">pred_set_conv</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span> list_rel<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> list_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">lemmas</span></span> list_rel_single_valued<span class="main">[</span><span class="operator">iff</span><span class="main">]</span> <span class="main">=</span> list_rel_sv_iff

  <span class="keyword1"><span class="command">lemmas</span></span> list_rel_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span>
    list.rel_eq_onp<span class="main">[</span><span class="operator">to_set</span><span class="main">]</span>
    list.rel_conversep<span class="main">[</span><span class="operator">to_set</span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
    list.rel_compp<span class="main">[</span><span class="operator">to_set</span><span class="main">]</span>

  <span class="keyword1"><span class="command">lemmas</span></span> list_rel_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span> <span class="main">=</span>
    list.set_transfer<span class="main">[</span><span class="operator">to_set</span><span class="main">]</span>
    list.pred_transfer<span class="main">[</span><span class="operator">unfolded</span> pred_bool_Id<span class="main">,</span> <span class="operator">to_set</span><span class="main">,</span> <span class="operator">folded</span> pred_list_listsp<span class="main">]</span>
    list.rel_transfer<span class="main">[</span><span class="operator">unfolded</span> pred_bool_Id<span class="main">,</span> <span class="operator">to_set</span><span class="main">]</span>

  <span class="keyword1"><span class="command">lemmas</span></span> null_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span> <span class="main">=</span> null_transfer<span class="main">[</span><span class="operator">unfolded</span> pred_bool_Id<span class="main">,</span> <span class="operator">to_set</span><span class="main">]</span>

  <span class="comment1">(* TODO Peter: param_set is too restrictive *)</span>
  <span class="keyword1"><span class="command">thm</span></span> param_set list.set_transfer<span class="main">[</span><span class="operator">to_set</span><span class="main">]</span>

  <span class="keyword1"><span class="command">lemmas</span></span> scan_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span> <span class="main">=</span> scan.transfer<span class="main">[</span><span class="operator">to_set</span><span class="main">]</span>
  <span class="keyword1" id="Refine-bind_param"><span class="command">lemma</span></span> bind_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>List.bind<span class="main">,</span> List.bind<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> list_rel <span class="main">→</span> <span class="main">(</span><span class="free">A</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">B</span><span class="main">⟩</span> list_rel<span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">B</span><span class="main">⟩</span> list_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> List.bind_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>

  <span class="keyword1" id="Refine-set_id_param"><span class="command">lemma</span></span> set_id_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>set<span class="main">,</span> id<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> list_set_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> set_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> list_set_rel_def relcomp_unfold in_br_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="operator">parametricity</span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Streams›</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">stream_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> stream <span class="main">×</span> <span class="tfree">'b</span> stream<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="main">[</span><span class="operator">to_relAPP</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">stream_rel</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> stream_all2 <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span>

  <span class="keyword1" id="Refine-stream_all2_stream_rel_conv"><span class="command">lemma</span></span> stream_all2_stream_rel_conv<span class="main">[</span><span class="operator">pred_set_conv</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"stream_all2 <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span> stream_rel<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> stream_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">lemmas</span></span> stream_rel_coinduct'<span class="main">[</span><span class="operator">case_names</span> stream_rel<span class="main">,</span> <span class="operator">coinduct</span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> stream_rel<span class="main">]</span> <span class="main">=</span>
    stream_rel_coinduct<span class="main">[</span><span class="operator">to_set</span><span class="main">]</span>

  <span class="keyword1"><span class="command">lemmas</span></span> stream_rel_intros <span class="main">=</span> stream.rel_intros<span class="main">[</span><span class="operator">to_set</span><span class="main">]</span>
  <span class="keyword1"><span class="command">lemmas</span></span> stream_rel_cases <span class="main">=</span> stream.rel_cases<span class="main">[</span><span class="operator">to_set</span><span class="main">]</span>
  <span class="keyword1"><span class="command">lemmas</span></span> stream_rel_inject<span class="main">[</span><span class="operator">iff</span><span class="main">]</span> <span class="main">=</span> stream.rel_inject<span class="main">[</span><span class="operator">to_set</span><span class="main">]</span>

  <span class="comment1">(* TODO: why is stream.right_unique_rel not generated as an iff rule? *)</span>
  <span class="keyword1" id="Refine-stream_rel_single_valued"><span class="command">lemma</span></span> stream_rel_single_valued<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"single_valued <span class="main">(</span><span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> stream_rel<span class="main">)</span> <span class="main">⟷</span> single_valued <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"single_valued <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"single_valued <span class="main">(</span><span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> stream_rel<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> single_valuedI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sconst <span class="skolem">x</span><span class="main">,</span> sconst <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> stream_rel"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sconst <span class="skolem">x</span><span class="main">,</span> sconst <span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> stream_rel"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> stream_rel_sconst<span class="main">[</span><span class="operator">to_set</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sconst <span class="skolem">y</span> <span class="main">=</span> sconst <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> single_valuedD that <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"single_valued <span class="free">A</span> <span class="main">⟹</span> single_valued <span class="main">(</span><span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> stream_rel<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> stream.right_unique_rel<span class="main">[</span><span class="operator">to_set</span><span class="main">,</span> <span class="operator">to_set</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemmas</span></span> stream_rel_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span>
    stream.rel_eq<span class="main">[</span><span class="operator">unfolded</span> pred_Id<span class="main">,</span> <span class="operator">THEN</span> IdD<span class="main">,</span> <span class="operator">to_set</span><span class="main">]</span>
    stream.rel_eq_onp<span class="main">[</span><span class="operator">to_set</span><span class="main">]</span>
    stream.rel_conversep<span class="main">[</span><span class="operator">to_set</span><span class="main">]</span>
    stream.rel_compp<span class="main">[</span><span class="operator">to_set</span><span class="main">]</span>

  <span class="keyword1"><span class="command">lemmas</span></span> stream_rel_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span> <span class="main">=</span>
    stream.ctr_transfer<span class="main">[</span><span class="operator">to_set</span><span class="main">]</span>
    stream.sel_transfer<span class="main">[</span><span class="operator">to_set</span><span class="main">]</span>
    stream.pred_transfer<span class="main">[</span><span class="operator">unfolded</span> pred_bool_Id<span class="main">,</span> <span class="operator">to_set</span><span class="main">,</span> <span class="operator">folded</span> pred_stream_streamsp<span class="main">]</span>
    stream.rel_transfer<span class="main">[</span><span class="operator">unfolded</span> pred_bool_Id<span class="main">,</span> <span class="operator">to_set</span><span class="main">]</span>
    stream.map_transfer<span class="main">[</span><span class="operator">to_set</span><span class="main">]</span>
    stream.set_transfer<span class="main">[</span><span class="operator">to_set</span><span class="main">]</span>
    stream.case_transfer<span class="main">[</span><span class="operator">to_set</span><span class="main">]</span>
    stream.corec_transfer<span class="main">[</span><span class="operator">unfolded</span> pred_bool_Id<span class="main">,</span> <span class="operator">to_set</span><span class="main">]</span>

  <span class="comment1">(* TODO: why is this not generated by the datatype package when stream.Domainp_rel is? *)</span>
  <span class="keyword1" id="Refine-stream_Rangep_rel"><span class="command">lemma</span></span> stream_Rangep_rel<span class="main">:</span> <span class="quoted"><span class="quoted">"Rangep <span class="main">(</span>stream_all2 <span class="free">R</span><span class="main">)</span> <span class="main">=</span> pred_stream <span class="main">(</span>Rangep <span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span>Rangep <span class="free">R</span><span class="main">)</span> <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"stream_all2 <span class="free">R</span> <span class="skolem">u</span> <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">u</span> <span class="skolem">v</span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">u</span></span> <span class="quoted"><span class="skolem">v</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> stream.rel_cases<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"stream_all2 <span class="free">R</span> <span class="main">(</span>smap <span class="main">(</span><span class="main">λ</span> <span class="bound">y</span><span class="main">.</span> <span class="keyword1">SOME</span> <span class="bound">x</span><span class="main">.</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"pred_stream <span class="main">(</span>Rangep <span class="free">R</span><span class="main">)</span> <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">v</span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">v</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> someI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemmas</span></span> stream_rel_domain<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> stream.Domainp_rel<span class="main">[</span><span class="operator">to_set</span><span class="main">]</span>
  <span class="keyword1"><span class="command">lemmas</span></span> stream_rel_range<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> stream_Rangep_rel<span class="main">[</span><span class="operator">to_set</span><span class="main">]</span>

  <span class="keyword1" id="Refine-stream_param"><span class="command">lemma</span></span> stream_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span>HOL.eq<span class="main">,</span> HOL.eq<span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">→</span> <span class="free">R</span> <span class="main">→</span> bool_rel"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>HOL.eq<span class="main">,</span> HOL.eq<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span> stream_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span> stream_rel <span class="main">→</span> bool_rel"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>stream_all2 HOL.eq<span class="main">,</span> stream_all2 HOL.eq<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span> stream_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span> stream_rel <span class="main">→</span> bool_rel"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> stream.rel_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemmas</span></span> szip_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span> <span class="main">=</span> szip_transfer<span class="main">[</span><span class="operator">to_set</span><span class="main">]</span>
  <span class="keyword1"><span class="command">lemmas</span></span> siterate_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span> <span class="main">=</span> siterate_transfer<span class="main">[</span><span class="operator">to_set</span><span class="main">]</span>
  <span class="keyword1"><span class="command">lemmas</span></span> sscan_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span> <span class="main">=</span> sscan.transfer<span class="main">[</span><span class="operator">to_set</span><span class="main">]</span>

  <span class="keyword1" id="Refine-streams_param"><span class="command">lemma</span></span> streams_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>streams<span class="main">,</span> streams<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> set_rel <span class="main">→</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> stream_rel<span class="main">⟩</span> set_rel"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> fun_relI set_relI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">S</span> <span class="skolem">T</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">S</span><span class="main">,</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> set_rel"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">S</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">T</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> set_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">`</span> <span class="skolem">S</span> <span class="main">⊆</span> <span class="skolem">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>id<span class="main">,</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">∈</span> Id_on <span class="skolem">S</span> <span class="main">→</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="skolem">T</span> <span class="main">⟹</span> <span class="skolem">g</span> <span class="bound">y</span> <span class="main">∈</span> <span class="skolem">S</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">g</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> set_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">`</span> <span class="skolem">T</span> <span class="main">⊆</span> <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">g</span><span class="main">,</span> id<span class="main">)</span> <span class="main">∈</span> Id_on <span class="skolem">T</span> <span class="main">→</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">v</span> <span class="main">∈</span> streams <span class="skolem">T</span><span class="main">.</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> stream_rel"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> streams <span class="skolem">S</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">u</span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"smap <span class="skolem">f</span> <span class="skolem">u</span> <span class="main">∈</span> streams <span class="skolem">T</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> smap_streams 3 that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>smap id <span class="skolem">u</span><span class="main">,</span> smap <span class="skolem">f</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> stream_rel"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 that <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span> smap <span class="skolem">f</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> stream_rel"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">u</span> <span class="main">∈</span> streams <span class="skolem">S</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> stream_rel"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> streams <span class="skolem">T</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">v</span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"smap <span class="skolem">g</span> <span class="skolem">v</span> <span class="main">∈</span> streams <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> smap_streams 5 that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>smap <span class="skolem">g</span> <span class="skolem">v</span><span class="main">,</span> smap id <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> stream_rel"</span></span> <span class="keyword1"><span class="command">using</span></span> 5 that <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>smap <span class="skolem">g</span> <span class="skolem">v</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> stream_rel"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Refine-holds_param"><span class="command">lemma</span></span> holds_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>holds<span class="main">,</span> holds<span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">A</span> <span class="main">→</span> bool_rel<span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> stream_rel <span class="main">→</span> bool_rel<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> holds.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
  <span class="keyword1" id="Refine-HLD_param"><span class="command">lemma</span></span> HLD_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"single_valued <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"single_valued <span class="main">(</span><span class="free">A</span><span class="main">¯</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>HLD<span class="main">,</span> HLD<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> set_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> stream_rel <span class="main">→</span> bool_rel"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> HLD_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
  <span class="keyword1" id="Refine-ev_param"><span class="command">lemma</span></span> ev_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ev<span class="main">,</span> ev<span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> stream_rel <span class="main">→</span> bool_rel<span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> stream_rel <span class="main">→</span> bool_rel<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="skolem">Q</span> <span class="skolem">u</span> <span class="skolem">v</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">P</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> stream_rel <span class="main">→</span> bool_rel"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> stream_rel"</span></span>
    <span class="keyword1"><span class="command">note</span></span> 2 <span class="main">=</span> 1<span class="main">[</span><span class="operator">param_fo</span><span class="main">]</span> stream_rel_param<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">param_fo</span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ev <span class="skolem">Q</span> <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"ev <span class="skolem">P</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">v</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ev <span class="skolem">P</span> <span class="skolem">u</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"ev <span class="skolem">Q</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="Refine-alw_param"><span class="command">lemma</span></span> alw_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>alw<span class="main">,</span> alw<span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> stream_rel <span class="main">→</span> bool_rel<span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> stream_rel <span class="main">→</span> bool_rel<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="skolem">Q</span> <span class="skolem">u</span> <span class="skolem">v</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">P</span><span class="main">,</span> <span class="skolem">Q</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> stream_rel <span class="main">→</span> bool_rel"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> stream_rel"</span></span>
    <span class="keyword1"><span class="command">note</span></span> 2 <span class="main">=</span> 1<span class="main">[</span><span class="operator">param_fo</span><span class="main">]</span> stream_rel_param<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">param_fo</span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"alw <span class="skolem">Q</span> <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"alw <span class="skolem">P</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">u</span></span> <span class="quoted"><span class="skolem">v</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"alw <span class="skolem">P</span> <span class="skolem">u</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"alw <span class="skolem">Q</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">u</span></span> <span class="quoted"><span class="skolem">v</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Functional Relations›</span></span>

  <span class="keyword1" id="Refine-br_set_rel"><span class="command">lemma</span></span> br_set_rel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>br <span class="free">f</span> <span class="free">P</span><span class="main">⟩</span> set_rel <span class="main">=</span> br <span class="main">(</span>image <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">A</span><span class="main">.</span> Ball <span class="bound">A</span> <span class="free">P</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> br_set_rel_alt <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> build_rel_def<span class="main">)</span>

  <span class="keyword1" id="Refine-br_list_rel"><span class="command">lemma</span></span> br_list_rel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>br <span class="free">f</span> <span class="free">P</span><span class="main">⟩</span> list_rel <span class="main">=</span> br <span class="main">(</span>map <span class="free">f</span><span class="main">)</span> <span class="main">(</span>list_all <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="skolem">v</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> br <span class="main">(</span>map <span class="free">f</span><span class="main">)</span> <span class="main">(</span>list_all <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>br <span class="free">f</span> <span class="free">P</span><span class="main">⟩</span> list_rel"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> build_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>br <span class="free">f</span> <span class="free">P</span><span class="main">⟩</span> list_rel"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> br <span class="main">(</span>map <span class="free">f</span><span class="main">)</span> <span class="main">(</span>list_all <span class="free">P</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> build_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">u</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">v</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Refine-br_list_set_rel"><span class="command">lemma</span></span> br_list_set_rel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>br <span class="free">f</span> <span class="free">P</span><span class="main">⟩</span> list_set_rel <span class="main">=</span> br <span class="main">(</span>set <span class="main">∘</span> map <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> list_all <span class="free">P</span> <span class="bound">s</span> <span class="main">∧</span> distinct <span class="main">(</span>map <span class="free">f</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> list_set_rel_def br_list_rel
    <span class="keyword1"><span class="command">unfolding</span></span> br_chain
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>

  <span class="keyword1" id="Refine-br_fun_rel1"><span class="command">lemma</span></span> br_fun_rel1<span class="main">:</span> <span class="quoted"><span class="quoted">"Id <span class="main">→</span> br <span class="free">f</span> <span class="free">P</span> <span class="main">=</span> br <span class="main">(</span>comp <span class="free">f</span><span class="main">)</span> <span class="main">(</span>All <span class="main">∘</span> comp <span class="free">P</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> fun_rel_def Ball_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> build_rel_def<span class="main">)</span>

  <span class="comment1">(* notes *)</span>

  <span class="comment1">(* TODO Peter: the way ∘∘ and ∘∘∘ are declared, a lot of unexpected abbreviation folding takes place *)</span>
  <span class="keyword1"><span class="command">term</span></span> <span class="quoted"><span class="quoted">"set <span class="main">∘</span> map <span class="free">f</span> <span class="main">∘</span> map <span class="free">g</span> <span class="main">∘</span> map <span class="free">h</span>"</span></span>
  <span class="comment1">(* in large expressions, this can introduce unneccessary paretheses and in general, makes
    things very hard to read *)</span>
  <span class="comment1">(* it is even possible for other abbreviations to be torn apart by this *)</span>
  <span class="keyword1"><span class="command">term</span></span> <span class="quoted"><span class="quoted">"set <span class="main">∘</span> sort"</span></span>
  <span class="comment1">(* I think that there were even cases where eta-expanded terms were torn apart, but I
    do not have an example at the moment *)</span>

  <span class="comment1">(* the following abbreviations work better, a term can only be abbreviated by comp_n if
    it contains the constant comp at least n times, thus they should only be folded back if
    the original term really had the right degree of "point-free-ness" *)</span>
  <span class="comment1">(*
  abbreviation comp_2 (infixl "∘∘" 55) where "f ∘∘ g ≡ comp (comp f) g"
  abbreviation comp_3 (infixl "∘∘∘" 55) where "f ∘∘∘ g ≡ comp (comp (comp f)) g"
  abbreviation comp_4 (infixl "∘∘∘∘" 55) where "f ∘∘∘∘ g ≡ comp (comp (comp (comp f))) g"
  abbreviation comp_5 (infixl "∘∘∘∘∘" 55) where "f ∘∘∘∘∘ g ≡ comp (comp (comp (comp (comp f)))) g"
  *)</span>
  <span class="comment1">(* since the root of the right hand side term is not a lambda abstraction, this
    abbreviation should also not be able to introduce any parentheses *)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Acceptance_Refine">
<div class="head">
<h1>Theory Acceptance_Refine</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Acceptance_Refine
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Acceptance.html">Acceptance</a>"</span> <span class="quoted">"<a href="Refine.html">Refine</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">pred_rel</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">→</span> bool_rel"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">rabin_rel</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> pred_rel <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> pred_rel <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

  <span class="keyword1" id="Acceptance_Refine-rabin_param"><span class="command">lemma</span></span> rabin_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rabin<span class="main">,</span> rabin<span class="main">)</span> <span class="main">∈</span> rabin_rel <span class="free">A</span> <span class="main">→</span> pred_rel <span class="main">(</span><span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> stream_rel<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rabin_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
  <span class="keyword1" id="Acceptance_Refine-gen_param"><span class="command">lemma</span></span> gen_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>gen<span class="main">,</span> gen<span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">A</span> <span class="main">→</span> pred_rel <span class="free">B</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> list_rel <span class="main">→</span> pred_rel <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> gen_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
  <span class="keyword1" id="Acceptance_Refine-cogen_param"><span class="command">lemma</span></span> cogen_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>cogen<span class="main">,</span> cogen<span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">A</span> <span class="main">→</span> pred_rel <span class="free">B</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> list_rel <span class="main">→</span> pred_rel <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> cogen_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Transition_System_Refine">
<div class="head">
<h1>Theory Transition_System_Refine</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Refinement for Transition Systems›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Transition_System_Refine
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="Transition_System.html">Transition_System</a>"</span>
  <span class="quoted">"<a href="Transition_System_Extra.html">Transition_System_Extra</a>"</span>
  <span class="quoted">"<a href="Refine.html">../Basic/Refine</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1" id="Transition_System_Refine-path_param"><span class="command">lemma</span></span> path_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>transition_system.path<span class="main">,</span> transition_system.path<span class="main">)</span> <span class="main">∈</span>
    <span class="main">(</span><span class="free">T</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> <span class="free">S</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">T</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> bool_rel<span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">T</span><span class="main">⟩</span> list_rel <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> bool_rel"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">exa</span> <span class="skolem">exb</span> <span class="skolem">ena</span> <span class="skolem">enb</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">exa</span><span class="main">,</span> <span class="skolem">exb</span><span class="main">)</span> <span class="main">∈</span> <span class="free">T</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ena</span><span class="main">,</span> <span class="skolem">enb</span><span class="main">)</span> <span class="main">∈</span> <span class="free">T</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> bool_rel"</span></span>
    <span class="keyword1"><span class="command">interpret</span></span> A<span class="main">:</span> transition_system <span class="quoted"><span class="skolem">exa</span></span> <span class="quoted"><span class="skolem">ena</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">interpret</span></span> B<span class="main">:</span> transition_system <span class="quoted"><span class="skolem">exb</span></span> <span class="quoted"><span class="skolem">enb</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>A.path <span class="main">[]</span> <span class="skolem">p</span><span class="main">,</span> B.path <span class="main">[]</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">∈</span> bool_rel"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>A.path <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">p</span><span class="main">,</span> B.path <span class="main">(</span><span class="skolem">b</span> <span class="main">#</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">∈</span> bool_rel"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ena</span> <span class="skolem">a</span> <span class="skolem">p</span><span class="main">,</span> <span class="skolem">enb</span> <span class="skolem">b</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">∈</span> bool_rel"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>A.path <span class="skolem">r</span> <span class="main">(</span><span class="skolem">exa</span> <span class="skolem">a</span> <span class="skolem">p</span><span class="main">)</span><span class="main">,</span> B.path <span class="skolem">s</span> <span class="main">(</span><span class="skolem">exb</span> <span class="skolem">b</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> bool_rel"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">r</span> <span class="skolem">p</span> <span class="skolem">b</span> <span class="skolem">s</span> <span class="skolem">q</span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>A.path<span class="main">,</span> B.path<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">T</span><span class="main">⟩</span> list_rel <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> bool_rel"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> fun_relI<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>A.path <span class="skolem">r</span> <span class="skolem">p</span><span class="main">,</span> B.path <span class="skolem">s</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">∈</span> bool_rel"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">T</span><span class="main">⟩</span> list_rel"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">p</span> <span class="skolem">q</span>
        <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">q</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">parametricity</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="Transition_System_Refine-run_param"><span class="command">lemma</span></span> run_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>transition_system.run<span class="main">,</span> transition_system.run<span class="main">)</span> <span class="main">∈</span>
    <span class="main">(</span><span class="free">T</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> <span class="free">S</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">T</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> bool_rel<span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">T</span><span class="main">⟩</span> stream_rel <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> bool_rel"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">exa</span> <span class="skolem">exb</span> <span class="skolem">ena</span> <span class="skolem">enb</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">exa</span><span class="main">,</span> <span class="skolem">exb</span><span class="main">)</span> <span class="main">∈</span> <span class="free">T</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ena</span><span class="main">,</span> <span class="skolem">enb</span><span class="main">)</span> <span class="main">∈</span> <span class="free">T</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> bool_rel"</span></span>
    <span class="keyword1"><span class="command">interpret</span></span> A<span class="main">:</span> transition_system <span class="quoted"><span class="skolem">exa</span></span> <span class="quoted"><span class="skolem">ena</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">interpret</span></span> B<span class="main">:</span> transition_system <span class="quoted"><span class="skolem">exb</span></span> <span class="quoted"><span class="skolem">enb</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>A.run<span class="main">,</span> B.run<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">T</span><span class="main">⟩</span> stream_rel <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> bool_rel"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"B.run <span class="skolem">s</span> <span class="skolem">q</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">T</span><span class="main">⟩</span> stream_rel"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"A.run <span class="skolem">r</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">p</span> <span class="skolem">q</span>
        <span class="keyword1"><span class="command">using</span></span> 1<span class="main">[</span><span class="operator">param_fo</span><span class="main">]</span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">r</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">q</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> stream_rel_cases<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"A.run <span class="skolem">r</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">T</span><span class="main">⟩</span> stream_rel"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"B.run <span class="skolem">s</span> <span class="skolem">q</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">p</span> <span class="skolem">q</span>
        <span class="keyword1"><span class="command">using</span></span> 1<span class="main">[</span><span class="operator">param_fo</span><span class="main">]</span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">r</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">q</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> stream_rel_cases<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Transition_System_Refine-paths_param"><span class="command">lemma</span></span> paths_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">exa</span><span class="main">,</span> <span class="free">exb</span><span class="main">)</span> <span class="main">∈</span> <span class="free">T</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> <span class="free">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>transition_system.enableds <span class="free">ena</span><span class="main">,</span> transition_system.enableds <span class="free">enb</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">T</span><span class="main">⟩</span> set_rel"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>transition_system.paths <span class="free">exa</span> <span class="free">ena</span><span class="main">,</span> transition_system.paths <span class="free">exb</span> <span class="free">enb</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">→</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">T</span><span class="main">⟩</span> list_rel<span class="main">⟩</span> set_rel"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">note</span></span> assms <span class="main">=</span> assms<span class="main">[</span><span class="operator">param_fo</span><span class="main">,</span> <span class="operator">unfolded</span> transition_system.enableds_def<span class="main">]</span>
    <span class="keyword1"><span class="command">interpret</span></span> A<span class="main">:</span> transition_system <span class="quoted"><span class="free">exa</span></span> <span class="quoted"><span class="free">ena</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">interpret</span></span> B<span class="main">:</span> transition_system <span class="quoted"><span class="free">exb</span></span> <span class="quoted"><span class="free">enb</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">T</span><span class="main">⟩</span> list_rel <span class="main">∧</span> B.path <span class="bound">s</span> <span class="skolem">q</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"A.path <span class="skolem">r</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span>
    <span class="keyword1"><span class="command">using</span></span> that<span class="main">(</span>2<span class="main">,</span> 1<span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">q</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>nil <span class="skolem">p</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cons <span class="skolem">a</span> <span class="skolem">p</span> <span class="skolem">r</span><span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">enb</span> <span class="skolem">b</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> cons<span class="main">(</span>1<span class="main">,</span> 4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> set_relE1<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">exa</span> <span class="skolem">a</span> <span class="skolem">p</span><span class="main">,</span> <span class="free">exb</span> <span class="skolem">b</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cons<span class="main">(</span>4<span class="main">)</span> 1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">T</span><span class="main">⟩</span> list_rel"</span></span> <span class="quoted"><span class="quoted">"B.path <span class="skolem">s</span> <span class="main">(</span><span class="free">exb</span> <span class="skolem">b</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cons<span class="main">(</span>3<span class="main">)</span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">T</span><span class="main">⟩</span> list_rel <span class="main">∧</span> A.path <span class="bound">r</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"B.path <span class="skolem">s</span> <span class="skolem">q</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">s</span>
    <span class="keyword1"><span class="command">using</span></span> that<span class="main">(</span>2<span class="main">,</span> 1<span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">p</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>nil <span class="skolem">q</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cons <span class="skolem">b</span> <span class="skolem">q</span> <span class="skolem">s</span><span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ena</span> <span class="skolem">a</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> cons<span class="main">(</span>1<span class="main">,</span> 4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> set_relE2<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">exa</span> <span class="skolem">a</span> <span class="skolem">p</span><span class="main">,</span> <span class="free">exb</span> <span class="skolem">b</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cons<span class="main">(</span>4<span class="main">)</span> 1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">T</span><span class="main">⟩</span> list_rel"</span></span> <span class="quoted"><span class="quoted">"A.path <span class="skolem">r</span> <span class="main">(</span><span class="free">exa</span> <span class="skolem">a</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cons<span class="main">(</span>3<span class="main">)</span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> transition_system.paths_def set_rel_def <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="Transition_System_Refine-runs_param"><span class="command">lemma</span></span> runs_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">exa</span><span class="main">,</span> <span class="free">exb</span><span class="main">)</span> <span class="main">∈</span> <span class="free">T</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> <span class="free">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>transition_system.enableds <span class="free">ena</span><span class="main">,</span> transition_system.enableds <span class="free">enb</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">T</span><span class="main">⟩</span> set_rel"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>transition_system.runs <span class="free">exa</span> <span class="free">ena</span><span class="main">,</span> transition_system.runs <span class="free">exb</span> <span class="free">enb</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">→</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">T</span><span class="main">⟩</span> stream_rel<span class="main">⟩</span> set_rel"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">note</span></span> assms <span class="main">=</span> assms<span class="main">[</span><span class="operator">param_fo</span><span class="main">,</span> <span class="operator">unfolded</span> transition_system.enableds_def<span class="main">]</span>
    <span class="keyword1"><span class="command">interpret</span></span> A<span class="main">:</span> transition_system <span class="quoted"><span class="free">exa</span></span> <span class="quoted"><span class="free">ena</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">interpret</span></span> B<span class="main">:</span> transition_system <span class="quoted"><span class="free">exb</span></span> <span class="quoted"><span class="free">enb</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">T</span><span class="main">⟩</span> stream_rel <span class="main">∧</span> B.run <span class="bound">s</span> <span class="skolem">q</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"A.run <span class="skolem">r</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">≡</span> <span class="main">λ</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">∧</span> A.run <span class="bound">r</span> <span class="bound">p</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">≡</span> <span class="main">λ</span> <span class="main">(</span><span class="bound">p</span> <span class="main">::</span> <span class="tfree">'b</span><span class="main">,</span> <span class="bound">q</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="bound">a</span><span class="main">.</span> <span class="main">(</span>shd <span class="bound">r</span><span class="main">,</span> <span class="bound">a</span><span class="main">)</span> <span class="main">∈</span> <span class="free">T</span> <span class="main">∧</span> <span class="free">enb</span> <span class="bound">a</span> <span class="bound">q</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> P_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">a</span><span class="main">.</span> <span class="skolem">Q</span> <span class="skolem">x</span> <span class="bound">a</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> that <span class="keyword1"><span class="command">unfolding</span></span> P_def Q_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> set_relE1 A.run.cases<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="skolem">Q</span> <span class="bound">x</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">≡</span> <span class="main">λ</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">exa</span> <span class="main">(</span>shd <span class="bound">r</span><span class="main">)</span> <span class="bound">p</span><span class="main">,</span> <span class="free">exb</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="bound">q</span><span class="main">,</span> stl <span class="bound">r</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">(</span><span class="skolem">g</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> 2 that <span class="keyword1"><span class="command">unfolding</span></span> P_def Q_def g_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> A.run.cases<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">r</span><span class="main">,</span> smap <span class="skolem">f</span> <span class="main">(</span>siterate <span class="skolem">g</span> <span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">T</span><span class="main">⟩</span> stream_rel"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 1 2 3 <span class="keyword1"><span class="command">unfolding</span></span> Q_def g_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">q</span></span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"B.run <span class="main">(</span>smap <span class="skolem">f</span> <span class="main">(</span>siterate <span class="skolem">g</span> <span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">q</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 1 2 3 <span class="keyword1"><span class="command">unfolding</span></span> Q_def g_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">q</span></span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">T</span><span class="main">⟩</span> stream_rel <span class="main">∧</span> A.run <span class="bound">r</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"B.run <span class="skolem">s</span> <span class="skolem">q</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">s</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">≡</span> <span class="main">λ</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">∧</span> B.run <span class="bound">s</span> <span class="bound">q</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">≡</span> <span class="main">λ</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span> <span class="main">::</span> <span class="tfree">'d</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> shd <span class="bound">s</span><span class="main">)</span> <span class="main">∈</span> <span class="free">T</span> <span class="main">∧</span> <span class="free">ena</span> <span class="bound">b</span> <span class="bound">p</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> P_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">a</span><span class="main">.</span> <span class="skolem">Q</span> <span class="skolem">x</span> <span class="bound">a</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> that <span class="keyword1"><span class="command">unfolding</span></span> P_def Q_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> set_relE2 B.run.cases<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="skolem">Q</span> <span class="bound">x</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">≡</span> <span class="main">λ</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">exa</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="bound">p</span><span class="main">,</span> <span class="free">exb</span> <span class="main">(</span>shd <span class="bound">s</span><span class="main">)</span> <span class="bound">q</span><span class="main">,</span> stl <span class="bound">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">(</span><span class="skolem">g</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> 2 that <span class="keyword1"><span class="command">unfolding</span></span> P_def Q_def g_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> B.run.cases<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>smap <span class="skolem">f</span> <span class="main">(</span>siterate <span class="skolem">g</span> <span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">T</span><span class="main">⟩</span> stream_rel"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 1 2 3 <span class="keyword1"><span class="command">unfolding</span></span> Q_def g_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">q</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"A.run <span class="main">(</span>smap <span class="skolem">f</span> <span class="main">(</span>siterate <span class="skolem">g</span> <span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 1 2 3 <span class="keyword1"><span class="command">unfolding</span></span> Q_def g_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">q</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> transition_system.runs_def set_rel_def <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="DRA_Refine">
<div class="head">
<h1>Theory DRA_Refine</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Relations on Deterministic Rabin Automata›</span></span>

<span class="keyword1"><span class="command">theory</span></span> DRA_Refine
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="DRA.html">DRA</a>"</span>
  <span class="quoted">"<a href="Acceptance_Refine.html">../../Basic/Acceptance_Refine</a>"</span>
  <span class="quoted">"<a href="Transition_System_Refine.html">../../Transition_Systems/Transition_System_Refine</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">dra_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">×</span> <span class="tfree">'label<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'state<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">×</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> set <span class="main">⇒</span>
    <span class="main">(</span><span class="main">(</span><span class="tfree">'label<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> dra <span class="main">×</span> <span class="main">(</span><span class="tfree">'label<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> dra<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="main">[</span><span class="operator">to_relAPP</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">dra_rel</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">.</span>
      <span class="main">(</span>alphabet <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> alphabet <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">⟩</span> set_rel <span class="main">∧</span>
      <span class="main">(</span>initial <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> initial <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">∧</span>
      <span class="main">(</span>transition <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> transition <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">∧</span>
      <span class="main">(</span>condition <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> condition <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>rabin_rel <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">⟩</span> list_rel<span class="main">}</span>"</span></span>

  <span class="keyword1" id="DRA_Refine-dra_param"><span class="command">lemma</span></span> dra_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>dra<span class="main">,</span> dra<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">⟩</span> set_rel <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> <span class="main">(</span><span class="free">L</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> <span class="free">S</span><span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span>rabin_rel <span class="free">S</span><span class="main">⟩</span> list_rel <span class="main">→</span>
      <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> dra_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>alphabet<span class="main">,</span> alphabet<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> dra_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">L</span><span class="main">⟩</span> set_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>initial<span class="main">,</span> initial<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> dra_rel <span class="main">→</span> <span class="free">S</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>transition<span class="main">,</span> transition<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> dra_rel <span class="main">→</span> <span class="free">L</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> <span class="free">S</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>condition<span class="main">,</span> condition<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> dra_rel <span class="main">→</span> <span class="main">⟨</span>rabin_rel <span class="free">S</span><span class="main">⟩</span> list_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> dra_rel_def fun_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="DRA_Refine-dra_rel_id"><span class="command">lemma</span></span> dra_rel_id<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Id<span class="main">,</span> Id<span class="main">⟩</span> dra_rel <span class="main">=</span> Id"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dra_rel_def <span class="keyword1"><span class="command">using</span></span> dra.expand <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="DRA_Refine-dra_rel_comp"><span class="command">lemma</span></span> dra_rel_comp<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">S<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> dra_rel"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">B</span><span class="main">,</span> <span class="free">C</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> dra_rel"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">C</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">O</span> <span class="free">L<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">O</span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> dra_rel"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>condition <span class="free">A</span><span class="main">,</span> condition <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>rabin_rel <span class="free">S<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> list_rel"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>condition <span class="free">B</span><span class="main">,</span> condition <span class="free">C</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>rabin_rel <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> list_rel"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>condition <span class="free">A</span><span class="main">,</span> condition <span class="free">C</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>rabin_rel <span class="free">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">O</span> rabin_rel <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> list_rel"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"rabin_rel <span class="free">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">O</span> rabin_rel <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⊆</span> rabin_rel <span class="main">(</span><span class="free">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">O</span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_rel_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>condition <span class="free">A</span><span class="main">,</span> condition <span class="free">C</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>rabin_rel <span class="main">(</span><span class="free">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">O</span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">⟩</span> list_rel"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 list_rel_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>transition <span class="free">A</span><span class="main">,</span> transition <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> <span class="free">L<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">→</span> <span class="free">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">→</span> <span class="free">S<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>transition <span class="free">B</span><span class="main">,</span> transition <span class="free">C</span><span class="main">)</span> <span class="main">∈</span> <span class="free">L<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">→</span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">→</span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>transition <span class="free">A</span><span class="main">,</span> transition <span class="free">C</span><span class="main">)</span> <span class="main">∈</span> <span class="free">L<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">O</span> <span class="free">L<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">→</span> <span class="free">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">O</span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">→</span> <span class="free">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">O</span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> dra_rel_def mem_Collect_eq prod.case set_rel_compp
      <span class="keyword1"><span class="command">using</span></span> 3 4
      <span class="keyword1"><span class="command">using</span></span> dra_param<span class="main">(</span>2 - 5<span class="main">)</span><span class="main">[</span><span class="operator">THEN</span> fun_relD<span class="main">,</span> <span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> dra_param<span class="main">(</span>2 - 5<span class="main">)</span><span class="main">[</span><span class="operator">THEN</span> fun_relD<span class="main">,</span> <span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="DRA_Refine-dra_rel_converse"><span class="command">lemma</span></span> dra_rel_converse<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> dra_rel<span class="main">)</span><span class="main">¯</span> <span class="main">=</span> <span class="main">⟨</span><span class="free">L</span><span class="main">¯</span><span class="main">,</span> <span class="free">S</span><span class="main">¯</span><span class="main">⟩</span> dra_rel"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">L</span><span class="main">⟩</span> set_rel <span class="main">=</span> <span class="main">(</span><span class="main">⟨</span><span class="free">L</span><span class="main">¯</span><span class="main">⟩</span> set_rel<span class="main">)</span><span class="main">¯</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> set_rel <span class="main">=</span> <span class="main">(</span><span class="main">⟨</span><span class="free">S</span><span class="main">¯</span><span class="main">⟩</span> set_rel<span class="main">)</span><span class="main">¯</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> <span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="free">L</span><span class="main">¯</span> <span class="main">→</span> <span class="free">S</span><span class="main">¯</span> <span class="main">→</span> <span class="free">S</span><span class="main">¯</span><span class="main">)</span><span class="main">¯</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>rabin_rel <span class="free">S</span><span class="main">⟩</span> list_rel <span class="main">=</span> <span class="main">(</span><span class="main">⟨</span>rabin_rel <span class="main">(</span><span class="free">S</span><span class="main">¯</span><span class="main">)</span><span class="main">⟩</span> list_rel<span class="main">)</span><span class="main">¯</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> dra_rel_def <span class="keyword1"><span class="command">unfolding</span></span> 3 <span class="keyword1"><span class="command">unfolding</span></span> 1 2 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="DRA_Refine-dra_rel_eq"><span class="command">lemma</span></span> dra_rel_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id_on <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span><span class="main">,</span> Id_on <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span><span class="main">⟩</span> dra_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> dra_rel_def prod_rel_def <span class="keyword1"><span class="command">using</span></span> list_all2_same<span class="main">[</span><span class="operator">to_set</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="DRA_Refine-enableds_param"><span class="command">lemma</span></span> enableds_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>dra.enableds<span class="main">,</span> dra.enableds<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> dra_rel <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">L</span><span class="main">⟩</span> set_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> dra.enableds_def Collect_mem_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
  <span class="keyword1" id="DRA_Refine-paths_param"><span class="command">lemma</span></span> paths_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>dra.paths<span class="main">,</span> dra.paths<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> dra_rel <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">L</span><span class="main">⟩</span> list_rel<span class="main">⟩</span> set_rel"</span></span>
    <span class="keyword1"><span class="command">using</span></span> enableds_param<span class="main">[</span><span class="operator">param_fo</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
  <span class="keyword1" id="DRA_Refine-runs_param"><span class="command">lemma</span></span> runs_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>dra.runs<span class="main">,</span> dra.runs<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> dra_rel <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">L</span><span class="main">⟩</span> stream_rel<span class="main">⟩</span> set_rel"</span></span>
    <span class="keyword1"><span class="command">using</span></span> enableds_param<span class="main">[</span><span class="operator">param_fo</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>

  <span class="keyword1" id="DRA_Refine-reachable_param"><span class="command">lemma</span></span> reachable_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>reachable<span class="main">,</span> reachable<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> dra_rel <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> set_rel"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"reachable <span class="skolem">A</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">w</span><span class="main">.</span> target <span class="skolem">A</span> <span class="bound">w</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">`</span> dra.paths <span class="skolem">A</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> dra"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">p</span>
      <span class="keyword1"><span class="command">unfolding</span></span> dra.reachable_alt_def dra.paths_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> 1 <span class="keyword1"><span class="command">using</span></span> enableds_param<span class="main">[</span><span class="operator">param_fo</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="DRA_Refine-nodes_param"><span class="command">lemma</span></span> nodes_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nodes<span class="main">,</span> nodes<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> dra_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> set_rel"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"nodes <span class="skolem">A</span> <span class="main">=</span> reachable <span class="skolem">A</span> <span class="main">(</span>initial <span class="skolem">A</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> dra"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> dra.nodes_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="DRA_Refine-language_param"><span class="command">lemma</span></span> language_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>language<span class="main">,</span> language<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> dra_rel <span class="main">→</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">L</span><span class="main">⟩</span> stream_rel<span class="main">⟩</span> set_rel"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"language <span class="skolem">A</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">w</span> <span class="main">∈</span> dra.runs <span class="skolem">A</span> <span class="main">(</span>initial <span class="skolem">A</span><span class="main">)</span><span class="main">.</span>
      <span class="keyword1">if</span> cogen rabin <span class="main">(</span>condition <span class="skolem">A</span><span class="main">)</span> <span class="main">(</span>initial <span class="skolem">A</span> <span class="main">##</span> trace <span class="skolem">A</span> <span class="bound">w</span> <span class="main">(</span>initial <span class="skolem">A</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">{</span><span class="bound">w</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> dra"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> dra.language_def dra.runs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> 1 <span class="keyword1"><span class="command">using</span></span> enableds_param<span class="main">[</span><span class="operator">param_fo</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Implement">
<div class="head">
<h1>Theory Implement</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Implementation›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Implement
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Monad_Syntax.html">HOL-Library.Monad_Syntax</a>"</span>
  <span class="quoted">"<a href="../Collections/Refine_Dflt.html">Collections.Refine_Dflt</a>"</span>
  <span class="quoted">"<a href="Refine.html">Refine</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Syntax›</span></span>

  <span class="comment1">(* TODO: this syntax has unnecessarily high inner binding strength, requiring extra parentheses
    the regular let syntax correctly uses inner binding strength 0: ("(2_ =/ _)" 10) *)</span>
  <span class="keyword1"><span class="command">no_syntax</span></span> <span class="quoted">"_do_let"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>pttrn<span class="main">,</span> <span class="tfree">'a</span><span class="main">]</span> <span class="main">⇒</span> do_bind"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(2</span><span class="keyword1">let</span> _ <span class="keyword1">=</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>1000<span class="main">,</span> 13<span class="main">]</span> 13<span class="main">)</span>
  <span class="keyword1"><span class="command">syntax</span></span> <span class="quoted">"_do_let"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>pttrn<span class="main">,</span> <span class="tfree">'a</span><span class="main">]</span> <span class="main">⇒</span> do_bind"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(2</span><span class="keyword1">let</span> _ <span class="keyword1">=</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> 13<span class="main">)</span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Monadic Refinement›</span></span>

  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">refine</span><span class="main">]</span> <span class="main">=</span> plain_nres_relI

  <span class="keyword1" id="Implement-vcg0"><span class="command">lemma</span></span> vcg0<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">g</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id<span class="main">⟩</span> nres_rel"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">≤</span> <span class="free">h</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">≤</span> <span class="free">h</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> order_trans nres_relD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">[</span></span><span class="operator">param_fo</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">THEN</span> refine_IdD<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1" id="Implement-vcg1"><span class="command">lemma</span></span> vcg1<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">g</span><span class="main">)</span> <span class="main">∈</span> Id <span class="main">→</span> <span class="main">⟨</span>Id<span class="main">⟩</span> nres_rel"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">h</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">h</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> order_trans nres_relD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">[</span></span><span class="operator">param_fo</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> IdI<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">THEN</span> refine_IdD<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1" id="Implement-vcg2"><span class="command">lemma</span></span> vcg2<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">g</span><span class="main">)</span> <span class="main">∈</span> Id <span class="main">→</span> Id <span class="main">→</span> <span class="main">⟨</span>Id<span class="main">⟩</span> nres_rel"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">x</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">h</span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">x</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">h</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> order_trans nres_relD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">[</span></span><span class="operator">param_fo</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> IdI IdI<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">THEN</span> refine_IdD<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>

  <span class="keyword1" id="Implement-RETURN_nres_relD"><span class="command">lemma</span></span> RETURN_nres_relD<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>RETURN <span class="free">x</span><span class="main">,</span> RETURN <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> nres_rel"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> nres_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1" id="Implement-FOREACH_rule_insert"><span class="command">lemma</span></span> FOREACH_rule_insert<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">{}</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="free">S</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">T</span> <span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">T</span> <span class="main">⊆</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">I</span> <span class="bound">T</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∉</span> <span class="bound">T</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">s</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="free">I</span> <span class="main">(</span>insert <span class="bound">x</span> <span class="bound">T</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FOREACH <span class="free">S</span> <span class="free">f</span> <span class="free">s</span> <span class="main">≤</span> SPEC <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> FOREACH_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">T</span> <span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="bound">T</span><span class="main">)</span> <span class="bound">s</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="free">S</span><span class="main">)</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">{}</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">s</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="skolem">T</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span> <span class="skolem">s</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="free">I</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert <span class="skolem">x</span> <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">=</span> <span class="free">S</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">T</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">,</span> 2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> it_step_insert_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span> <span class="skolem">s</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="free">I</span> <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">T</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="Implement-FOREACH_rule_map"><span class="command">lemma</span></span> FOREACH_rule_map<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="free">g</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> Map.empty <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="free">g</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">h</span> <span class="bound">k</span> <span class="bound">v</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">h</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">g</span> <span class="main">⟹</span> <span class="free">I</span> <span class="bound">h</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">g</span> <span class="bound">k</span> <span class="main">=</span> Some <span class="bound">v</span> <span class="main">⟹</span> <span class="bound">k</span> <span class="main">∉</span> dom <span class="bound">h</span> <span class="main">⟹</span>
      <span class="free">f</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="bound">s</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="free">I</span> <span class="main">(</span><span class="bound">h</span> <span class="main">(</span><span class="bound">k</span> <span class="main">↦</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FOREACH <span class="main">(</span>map_to_set <span class="free">g</span><span class="main">)</span> <span class="free">f</span> <span class="free">s</span> <span class="main">≤</span> SPEC <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> FOREACH_rule_insert<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">H</span> <span class="bound">s</span><span class="main">.</span> <span class="free">I</span> <span class="main">(</span>set_to_map <span class="bound">H</span><span class="main">)</span> <span class="bound">s</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>map_to_set <span class="free">g</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> finite_map_to_set <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">(</span>set_to_map <span class="main">{}</span><span class="main">)</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">(</span>set_to_map <span class="main">(</span>map_to_set <span class="free">g</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> that <span class="keyword1"><span class="command">unfolding</span></span> map_to_set_inverse <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">H</span> <span class="skolem">x</span> <span class="skolem">s</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">⊆</span> map_to_set <span class="free">g</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">(</span>set_to_map <span class="skolem">H</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> map_to_set <span class="free">g</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">H</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">k</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on fst <span class="skolem">H</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inj_on_fst_map_to_set inj_on_subset 1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span> <span class="skolem">s</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">k</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="free">I</span> <span class="main">(</span>set_to_map <span class="skolem">H</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">↦</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set_to_map <span class="skolem">H</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">g</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">)</span> 3
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inj_on_fst_map_to_set map_leI map_to_set_inverse set_to_map_simp subset_eq<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">(</span>set_to_map <span class="skolem">H</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="skolem">k</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> 2 map_to_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∉</span> dom <span class="main">(</span>set_to_map <span class="skolem">H</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">,</span> 3<span class="main">,</span> 4<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> 2 set_to_map_dom
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv inj_on_fst_map_to_set inj_on_image_mem_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_to_map <span class="skolem">H</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">↦</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> set_to_map <span class="skolem">H</span> <span class="main">(</span>fst <span class="skolem">x</span> <span class="main">↦</span> snd <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> set_to_map <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">H</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">,</span> 3<span class="main">,</span> 4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inj_on_fst_map_to_set inj_on_image_mem_iff set_to_map_insert<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span> <span class="skolem">s</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="free">I</span> <span class="main">(</span>set_to_map <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">H</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="Implement-FOREACH_rule_insert_eq"><span class="command">lemma</span></span> FOREACH_rule_insert_eq<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">{}</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="free">S</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">T</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">T</span> <span class="main">⊆</span> <span class="free">S</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∉</span> <span class="bound">T</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">(</span><span class="free">X</span> <span class="bound">T</span><span class="main">)</span> <span class="main">≤</span> SPEC <span class="main">(</span>HOL.eq <span class="main">(</span><span class="free">X</span> <span class="main">(</span>insert <span class="bound">x</span> <span class="bound">T</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FOREACH <span class="free">S</span> <span class="free">f</span> <span class="free">s</span> <span class="main">≤</span> SPEC <span class="main">(</span>HOL.eq <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> FOREACH_rule_insert<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"HOL.eq <span class="main">∘</span> <span class="free">X</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1" id="Implement-FOREACH_rule_map_eq"><span class="command">lemma</span></span> FOREACH_rule_map_eq<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="free">g</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> Map.empty <span class="main">=</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="free">g</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">h</span> <span class="bound">k</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">h</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">g</span> <span class="main">⟹</span> <span class="free">g</span> <span class="bound">k</span> <span class="main">=</span> Some <span class="bound">v</span> <span class="main">⟹</span> <span class="bound">k</span> <span class="main">∉</span> dom <span class="bound">h</span> <span class="main">⟹</span>
      <span class="free">f</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">(</span><span class="free">X</span> <span class="bound">h</span><span class="main">)</span> <span class="main">≤</span> SPEC <span class="main">(</span>HOL.eq <span class="main">(</span><span class="free">X</span> <span class="main">(</span><span class="bound">h</span> <span class="main">(</span><span class="bound">k</span> <span class="main">↦</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FOREACH <span class="main">(</span>map_to_set <span class="free">g</span><span class="main">)</span> <span class="free">f</span> <span class="free">s</span> <span class="main">≤</span> SPEC <span class="main">(</span>HOL.eq <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> FOREACH_rule_map<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"HOL.eq <span class="main">∘</span> <span class="free">X</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1" id="Implement-FOREACH_rule_map_map"><span class="command">lemma</span></span> FOREACH_rule_map_map<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>FOREACH <span class="main">(</span>map_to_set <span class="free">m</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="free">F</span> <span class="bound">k</span> <span class="main">(</span><span class="free">f</span> <span class="bound">k</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
    FOREACH <span class="main">(</span>map_to_set <span class="main">(</span><span class="main">λ</span> <span class="bound">k</span><span class="main">.</span> map_option <span class="main">(</span><span class="free">f</span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span><span class="free">m</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="free">F</span> <span class="bound">k</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> Id <span class="main">→</span> <span class="main">⟨</span>Id<span class="main">⟩</span> nres_rel"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">refine_vcg</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="free">f</span> <span class="bound">k</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map_to_set <span class="free">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> map_to_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"map_to_set <span class="main">(</span><span class="main">λ</span> <span class="bound">k</span><span class="main">.</span> map_option <span class="main">(</span><span class="free">f</span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span><span class="free">m</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="free">f</span> <span class="bound">k</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> map_to_set <span class="free">m</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> map_to_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Implementations for Sets Represented by Lists›</span></span>

  <span class="keyword1" id="Implement-list_set_rel_Id_on"><span class="command">lemma</span></span> list_set_rel_Id_on<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Id_on <span class="free">A</span><span class="main">⟩</span> list_set_rel <span class="main">=</span> <span class="main">⟨</span>Id<span class="main">⟩</span> list_set_rel <span class="main">∩</span> UNIV <span class="main">×</span> Pow <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> list_set_rel_def relcomp_unfold in_br_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Implement-list_set_card"><span class="command">lemma</span></span> list_set_card<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>length<span class="main">,</span> card<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> list_set_rel <span class="main">→</span> nat_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> list_set_rel_def relcomp_unfold in_br_conv
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> distinct_card list_rel_imp_same_length<span class="main">)</span>
  <span class="keyword1" id="Implement-list_set_insert"><span class="command">lemma</span></span> list_set_insert<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> <span class="free">Y</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> list_set_rel"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">,</span> insert <span class="free">y</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> list_set_rel"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> list_set_rel_def relcomp_unfold in_br_conv
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> refine_list<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">param_fo</span><span class="main"><span class="main">]</span></span> distinct.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> list.simps<span class="main"><span class="main">(</span></span>15<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1" id="Implement-list_set_union"><span class="command">lemma</span></span> list_set_union<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∩</span> <span class="free">Y</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> list_set_rel"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> list_set_rel"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">,</span> <span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> list_set_rel"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> list_set_rel_def relcomp_unfold in_br_conv
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="main">(</span><span class="operator">meson</span> param_append<span class="main"><span class="main">[</span></span><span class="operator">param_fo</span><span class="main"><span class="main">]</span></span> distinct_append set_union_code<span class="main">)</span>
  <span class="keyword1" id="Implement-list_set_Union"><span class="command">lemma</span></span> list_set_Union<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">X</span> <span class="bound">Y</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="bound">Y</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="bound">X</span> <span class="main">≠</span> <span class="bound">Y</span> <span class="main">⟹</span> <span class="bound">X</span> <span class="main">∩</span> <span class="bound">Y</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> list_set_rel<span class="main">⟩</span> list_set_rel"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>concat <span class="free">xs</span><span class="main">,</span> Union <span class="free">S</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> list_set_rel"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">note</span></span> distinct_map<span class="main">[</span><span class="operator">iff</span><span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="skolem">zs</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> list_set_rel<span class="main">⟩</span> list_rel"</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">=</span> set <span class="skolem">zs</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">zs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> list_set_rel_def relcomp_unfold in_br_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> list_rel<span class="main">⟩</span> list_rel"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">=</span> map set <span class="skolem">ys</span>"</span></span> <span class="quoted"><span class="quoted">"list_all distinct <span class="skolem">ys</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> list_set_rel_def list_rel_compp
      <span class="keyword1"><span class="command">unfolding</span></span> relcomp_unfold mem_Collect_eq prod.case
      <span class="keyword1"><span class="command">unfolding</span></span> br_list_rel in_br_conv
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 20<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">a</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">b</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">a</span> <span class="main">≠</span> set <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> set <span class="skolem">ys</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> set <span class="skolem">ys</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≠</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
      <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>3<span class="main">)</span> that <span class="keyword1"><span class="command">unfolding</span></span> 1<span class="main">(</span>2<span class="main">)</span> 2<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> inj_onD<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">a</span> <span class="main">∩</span> set <span class="skolem">b</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> set <span class="skolem">ys</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> set <span class="skolem">ys</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≠</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> 20 that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"Union <span class="free">S</span> <span class="main">=</span> set <span class="main">(</span>concat <span class="skolem">ys</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 1<span class="main">(</span>2<span class="main">)</span> 2<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>concat <span class="skolem">ys</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>3<span class="main">)</span> 2<span class="main">(</span>2<span class="main">,</span> 3<span class="main">)</span> 3 <span class="keyword1"><span class="command">unfolding</span></span> list.pred_set <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> distinct_concat<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>concat <span class="free">xs</span><span class="main">,</span> concat <span class="skolem">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> list_rel"</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> list_set_rel_def relcomp_unfold in_br_conv <span class="keyword1"><span class="command">using</span></span> 4 5 6 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="Implement-list_set_image"><span class="command">lemma</span></span> list_set_image<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">g</span> <span class="free">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">g</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">→</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> list_set_rel"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">,</span> <span class="free">g</span> <span class="main">`</span> <span class="free">S</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">B</span><span class="main">⟩</span> list_set_rel"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> list_set_rel_def relcomp_unfold in_br_conv
    <span class="keyword1"><span class="command">using</span></span> param_map<span class="main">[</span><span class="operator">param_fo</span><span class="main">]</span> distinct_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1" id="Implement-list_set_bind"><span class="command">lemma</span></span> list_set_bind<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">∩</span> <span class="free">g</span> <span class="bound">y</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> list_set_rel"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">g</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">B</span><span class="main">⟩</span> list_set_rel"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">⤜</span> <span class="free">f</span><span class="main">,</span> <span class="free">S</span> <span class="main">⤜</span> <span class="free">g</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">B</span><span class="main">⟩</span> list_set_rel"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">param</span><span class="main">]</span> <span class="main">=</span> list_set_autoref_filter list_set_autoref_isEmpty
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span>Not <span class="main">∘</span> is_Nil <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"op_set_filter <span class="main">(</span>Not <span class="main">∘</span> op_set_isEmpty <span class="main">∘</span> <span class="free">g</span><span class="main">)</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">g</span> <span class="var">?S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> inj_onI<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">⤜</span> <span class="free">f</span> <span class="main">=</span> concat <span class="main">(</span>map <span class="free">f</span> <span class="var">?xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.split<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">…</span><span class="main">,</span> <span class="main">⋃</span> <span class="main">(</span><span class="free">g</span> <span class="main">`</span> <span class="var">?S</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">B</span><span class="main">⟩</span> list_set_rel"</span></span> <span class="keyword1"><span class="command">using</span></span> assms 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span><span class="free">g</span> <span class="main">`</span> <span class="var">?S</span><span class="main">)</span> <span class="main">=</span> <span class="free">S</span> <span class="main">⤜</span> <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Autoref Setup›</span></span>

  <span class="comment1">(* TODO: inline this? *)</span>
  <span class="keyword1" id="Implement-dflt_ahm_rel_finite_nat"><span class="command">lemma</span></span> dflt_ahm_rel_finite_nat<span class="main">:</span> <span class="quoted"><span class="quoted">"finite_map_rel <span class="main">(</span><span class="main">⟨</span>nat_rel<span class="main">,</span> <span class="free">V</span><span class="main">⟩</span> dflt_ahm_rel<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">tagged_solver</span>

  <span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1"><span class="command">interpretation</span></span> autoref_syn <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">autoref_op_pat</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Some <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">|`</span> <span class="free">X</span> <span class="main">≡</span> <span class="keyword1">OP</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">f</span> <span class="bound">X</span><span class="main">.</span> <span class="main">(</span>Some <span class="main">∘</span> <span class="bound">f</span><span class="main">)</span> <span class="main">|`</span> <span class="bound">X</span><span class="main">)</span> <span class="free">f</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">autoref_op_pat</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span><span class="free">m</span> <span class="main">`</span> <span class="free">S</span><span class="main">)</span> <span class="main">≡</span> <span class="keyword1">OP</span> <span class="main">(</span><span class="main">λ</span><span class="bound">S</span> <span class="bound">m</span><span class="main">.</span> <span class="main">⋃</span><span class="main">(</span><span class="bound">m</span> <span class="main">`</span> <span class="bound">S</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">definition</span></span> <span class="entity">gen_UNION</span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">gen_UNION</span> <span class="free"><span class="bound"><span class="entity">tol</span></span></span> <span class="free"><span class="bound"><span class="entity">emp</span></span></span> <span class="free"><span class="bound"><span class="entity">un</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> fold <span class="main">(</span><span class="free"><span class="bound"><span class="entity">un</span></span></span> <span class="main">∘</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">tol</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">emp</span></span></span>"</span></span>

    <span class="keyword1" id="Implement-gen_UNION"><span class="command">lemma</span></span> gen_UNION<span class="main">[</span><span class="operator">autoref_rules_raw</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted">PRIO_TAG_GEN_ALGO</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> to_list<span class="main">:</span> <span class="quoted"><span class="quoted">"SIDE_GEN_ALGO <span class="main">(</span>is_set_to_list <span class="free">A</span> <span class="free">Rs1</span> <span class="free">tol</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> empty<span class="main">:</span> <span class="quoted"><span class="quoted">"GEN_OP <span class="free">emp</span> <span class="main">{}</span> <span class="main">(</span><span class="main">⟨</span><span class="free">B</span><span class="main">⟩</span> <span class="free">Rs3</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> union<span class="main">:</span> <span class="quoted"><span class="quoted">"GEN_OP <span class="free">un</span> union <span class="main">(</span><span class="main">⟨</span><span class="free">B</span><span class="main">⟩</span> <span class="free">Rs2</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">B</span><span class="main">⟩</span> <span class="free">Rs3</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">B</span><span class="main">⟩</span> <span class="free">Rs3</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>gen_UNION <span class="free">tol</span> <span class="free">emp</span> <span class="free">un</span><span class="main">,</span> <span class="main">λ</span><span class="bound">A</span> <span class="bound">f</span><span class="main">.</span> <span class="main">⋃</span> <span class="main">(</span><span class="bound">f</span> <span class="main">`</span> <span class="bound">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> <span class="free">Rs1</span> <span class="main">→</span> <span class="main">(</span><span class="free">A</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">B</span><span class="main">⟩</span> <span class="free">Rs2</span><span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">B</span><span class="main">⟩</span> <span class="free">Rs3</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> fun_relI<span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">unfolded</span> <span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic">autoref_tag_defs</span></span></span></span><span class="main">,</span> <span class="operator">param</span><span class="main">]</span> <span class="main">=</span> empty union
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="skolem">g</span> <span class="skolem">T</span> <span class="skolem">S</span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">T</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> <span class="free">Rs1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">g</span><span class="main">,</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">B</span><span class="main">⟩</span> <span class="free">Rs2</span>"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tsl'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        <span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">tol</span> <span class="skolem">T</span><span class="main">,</span> <span class="skolem">tsl'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> list_rel"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> IT'<span class="main">:</span> <span class="quoted"><span class="quoted">"RETURN <span class="skolem">tsl'</span> <span class="main">≤</span> it_to_sorted_list <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="skolem">S</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> to_list<span class="main">[</span><span class="operator">unfolded</span> <span class="dynamic"><span class="dynamic">autoref_tag_defs</span></span> is_set_to_list_def<span class="main">]</span> 1<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> is_set_to_sorted_listE<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> IT' <span class="keyword1"><span class="command">have</span></span> 10<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> set <span class="skolem">tsl'</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">tsl'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> it_to_sorted_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gen_UNION <span class="free">tol</span> <span class="free">emp</span> <span class="free">un</span> <span class="skolem">T</span> <span class="skolem">g</span> <span class="main">=</span> fold <span class="main">(</span><span class="free">un</span> <span class="main">∘</span> <span class="skolem">g</span><span class="main">)</span> <span class="main">(</span><span class="free">tol</span> <span class="skolem">T</span><span class="main">)</span> <span class="free">emp</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> gen_UNION_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">…</span><span class="main">,</span> fold <span class="main">(</span>union <span class="main">∘</span> <span class="skolem">f</span><span class="main">)</span> <span class="skolem">tsl'</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">B</span><span class="main">⟩</span> <span class="free">Rs3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fold <span class="main">(</span>union <span class="main">∘</span> <span class="skolem">f</span><span class="main">)</span> <span class="skolem">tsl'</span> <span class="skolem">X</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">∪</span> <span class="skolem">X</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">X</span>
        <span class="keyword1"><span class="command">unfolding</span></span> 10<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">tsl'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">X</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{}</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>gen_UNION <span class="free">tol</span> <span class="free">emp</span> <span class="free">un</span> <span class="skolem">T</span> <span class="skolem">g</span><span class="main">,</span> <span class="main">⋃</span><span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">B</span><span class="main">⟩</span> <span class="free">Rs3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">definition</span></span> <span class="entity">gen_Image</span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">gen_Image</span> <span class="free"><span class="bound"><span class="entity">tol1</span></span></span> <span class="free"><span class="bound"><span class="entity">mem2</span></span></span> <span class="free"><span class="bound"><span class="entity">emp3</span></span></span> <span class="free"><span class="bound"><span class="entity">ins3</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">≡</span> fold
        <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">mem2</span></span></span> <span class="bound">a</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">ins3</span></span></span> <span class="bound">b</span> <span class="keyword1">else</span> id<span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">tol1</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">emp3</span></span></span>"</span></span>

    <span class="keyword1" id="Implement-gen_Image"><span class="command">lemma</span></span> gen_Image<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted">PRIO_TAG_GEN_ALGO</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> to_list<span class="main">:</span> <span class="quoted"><span class="quoted">"SIDE_GEN_ALGO <span class="main">(</span>is_set_to_list <span class="main">(</span><span class="free">A</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">B</span><span class="main">)</span> <span class="free">Rs1</span> <span class="free">tol1</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> member<span class="main">:</span> <span class="quoted"><span class="quoted">"GEN_OP <span class="free">mem2</span> <span class="main">(∈)</span> <span class="main">(</span><span class="free">A</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> <span class="free">Rs2</span> <span class="main">→</span> bool_rel<span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> empty<span class="main">:</span> <span class="quoted"><span class="quoted">"GEN_OP <span class="free">emp3</span> <span class="main">{}</span> <span class="main">(</span><span class="main">⟨</span><span class="free">B</span><span class="main">⟩</span> <span class="free">Rs3</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> insert<span class="main">:</span> <span class="quoted"><span class="quoted">"GEN_OP <span class="free">ins3</span> Set.insert <span class="main">(</span><span class="free">B</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">B</span><span class="main">⟩</span> <span class="free">Rs3</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">B</span><span class="main">⟩</span> <span class="free">Rs3</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>gen_Image <span class="free">tol1</span> <span class="free">mem2</span> <span class="free">emp3</span> <span class="free">ins3</span><span class="main">,</span> Image<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">B</span><span class="main">⟩</span> <span class="free">Rs1</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> <span class="free">Rs2</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">B</span><span class="main">⟩</span> <span class="free">Rs3</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> fun_relI<span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">unfolded</span> <span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic">autoref_tag_defs</span></span></span></span></span></span><span class="main">,</span> <span class="operator">param</span><span class="main">]</span> <span class="main">=</span> member empty insert
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">T</span> <span class="skolem">S</span> <span class="skolem">X</span> <span class="skolem">Y</span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">T</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">B</span><span class="main">⟩</span> <span class="free">Rs1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Y</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> <span class="free">Rs2</span>"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tsl'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        <span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">tol1</span> <span class="skolem">T</span><span class="main">,</span> <span class="skolem">tsl'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">B</span><span class="main">⟩</span> list_rel"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> IT'<span class="main">:</span> <span class="quoted"><span class="quoted">"RETURN <span class="skolem">tsl'</span> <span class="main">≤</span> it_to_sorted_list <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="skolem">S</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> to_list<span class="main">[</span><span class="operator">unfolded</span> <span class="dynamic"><span class="dynamic">autoref_tag_defs</span></span> is_set_to_list_def<span class="main">]</span> 1<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> is_set_to_sorted_listE<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> IT' <span class="keyword1"><span class="command">have</span></span> 10<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> set <span class="skolem">tsl'</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">tsl'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> it_to_sorted_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gen_Image <span class="free">tol1</span> <span class="free">mem2</span> <span class="free">emp3</span> <span class="free">ins3</span> <span class="skolem">T</span> <span class="skolem">Y</span> <span class="main">=</span>
        fold <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">mem2</span> <span class="bound">a</span> <span class="skolem">Y</span> <span class="keyword1">then</span> <span class="free">ins3</span> <span class="bound">b</span> <span class="keyword1">else</span> id<span class="main">)</span> <span class="main">(</span><span class="free">tol1</span> <span class="skolem">T</span><span class="main">)</span> <span class="free">emp3</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> gen_Image_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">…</span><span class="main">,</span> fold <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">∈</span> <span class="skolem">X</span> <span class="keyword1">then</span> Set.insert <span class="bound">b</span> <span class="keyword1">else</span> id<span class="main">)</span> <span class="skolem">tsl'</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">B</span><span class="main">⟩</span> <span class="free">Rs3</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fold <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">∈</span> <span class="skolem">X</span> <span class="keyword1">then</span> Set.insert <span class="bound">b</span> <span class="keyword1">else</span> id<span class="main">)</span> <span class="skolem">tsl'</span> <span class="skolem">M</span> <span class="main">=</span> <span class="skolem">S</span> <span class="main">``</span> <span class="skolem">X</span> <span class="main">∪</span> <span class="skolem">M</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">M</span>
        <span class="keyword1"><span class="command">unfolding</span></span> 10<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">tsl'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">M</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">``</span> <span class="skolem">X</span> <span class="main">∪</span> <span class="main">{}</span> <span class="main">=</span> <span class="skolem">S</span> <span class="main">``</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>gen_Image <span class="free">tol1</span> <span class="free">mem2</span> <span class="free">emp3</span> <span class="free">ins3</span> <span class="skolem">T</span> <span class="skolem">Y</span><span class="main">,</span> <span class="skolem">S</span> <span class="main">``</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">B</span><span class="main">⟩</span> <span class="free">Rs3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Implement-list_set_union_autoref"><span class="command">lemma</span></span> list_set_union_autoref<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"PRIO_TAG_OPTIMIZATION"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SIDE_PRECOND_OPT <span class="main">(</span><span class="free">a'</span> <span class="main">∩</span> <span class="free">b'</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">a'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span> list_set_rel"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">b'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span> list_set_rel"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="main">@</span> <span class="free">b</span><span class="main">,</span>
        <span class="main">(</span><span class="keyword1">OP</span> union <span class="main">:::</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span> list_set_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span> list_set_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span> list_set_rel<span class="main">)</span> <span class="main">$</span> <span class="free">a'</span> <span class="main">$</span> <span class="free">b'</span><span class="main">)</span> <span class="main">∈</span>
        <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span> list_set_rel"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms list_set_union <span class="keyword1"><span class="command">unfolding</span></span> <span class="dynamic"><span class="dynamic">autoref_tag_defs</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1" id="Implement-list_set_image_autoref"><span class="command">lemma</span></span> list_set_image_autoref<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"PRIO_TAG_OPTIMIZATION"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> INJ<span class="main">:</span> <span class="quoted"><span class="quoted">"SIDE_PRECOND_OPT <span class="main">(</span>inj_on <span class="free">f</span> <span class="free">s</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">xi</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">xi</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Ra</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">fi</span> <span class="bound">xi</span><span class="main">,</span> <span class="free">f</span> <span class="main">$</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Rb</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> LP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">s</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">Ra</span><span class="main">⟩</span>list_set_rel"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="free">fi</span> <span class="free">l</span><span class="main">,</span>
        <span class="main">(</span><span class="keyword1">OP</span> image <span class="main">:::</span> <span class="main">(</span><span class="free">Ra</span> <span class="main">→</span> <span class="free">Rb</span><span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Ra</span><span class="main">⟩</span> list_set_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">Rb</span><span class="main">⟩</span> list_set_rel<span class="main">)</span> <span class="main">$</span> <span class="free">f</span> <span class="main">$</span> <span class="free">s</span><span class="main">)</span> <span class="main">∈</span>
        <span class="main">⟨</span><span class="free">Rb</span><span class="main">⟩</span> list_set_rel"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> LP <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="skolem">l'</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">Ra</span><span class="main">⟩</span>list_rel"</span></span> <span class="keyword2"><span class="keyword">and</span></span> L'S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l'</span><span class="main">,</span><span class="free">s</span><span class="main">)</span><span class="main">∈</span>br set distinct"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> list_set_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> set <span class="skolem">l'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> L'S <span class="keyword1"><span class="command">unfolding</span></span> in_br_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="free">fi</span> <span class="free">l</span><span class="main">,</span> map <span class="free">f</span> <span class="skolem">l'</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">Rb</span><span class="main">⟩</span>list_rel"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 1 L'S assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> 2 in_br_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> INJ L'S <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="free">f</span> <span class="skolem">l'</span><span class="main">,</span><span class="free">f</span><span class="main">`</span><span class="free">s</span><span class="main">)</span><span class="main">∈</span>br set distinct"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">l'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> br_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> injD<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="main">(</span>relcompI<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="dynamic"><span class="dynamic">autoref_tag_defs</span></span> list_set_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1" id="Implement-list_set_UNION_autoref"><span class="command">lemma</span></span> list_set_UNION_autoref<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"PRIO_TAG_OPTIMIZATION"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SIDE_PRECOND_OPT <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">∩</span> <span class="free">g</span> <span class="bound">y</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">S</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> list_set_rel"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">g</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">B</span><span class="main">⟩</span> list_set_rel"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span> <span class="main">⤜</span> <span class="free">f</span><span class="main">,</span>
        <span class="main">(</span><span class="keyword1">OP</span> <span class="main">(</span><span class="main">λ</span><span class="bound">A</span> <span class="bound">f</span><span class="main">.</span> <span class="main">⋃</span> <span class="main">(</span><span class="bound">f</span> <span class="main">`</span> <span class="bound">A</span><span class="main">)</span><span class="main">)</span> <span class="main">:::</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> list_set_rel <span class="main">→</span> <span class="main">(</span><span class="free">A</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">B</span><span class="main">⟩</span> list_set_rel<span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">B</span><span class="main">⟩</span> list_set_rel<span class="main">)</span> <span class="main">$</span> <span class="free">S</span> <span class="main">$</span> <span class="free">g</span><span class="main">)</span> <span class="main">∈</span>
        <span class="main">⟨</span><span class="free">B</span><span class="main">⟩</span> list_set_rel"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms list_set_bind <span class="keyword1"><span class="command">unfolding</span></span> bind_UNION <span class="dynamic"><span class="dynamic">autoref_tag_defs</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

    <span class="keyword1"><span class="command">definition</span></span> <span class="entity">gen_equals</span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">gen_equals</span> <span class="free"><span class="bound"><span class="entity">ball</span></span></span> <span class="free"><span class="bound"><span class="entity">lu</span></span></span> <span class="free"><span class="bound"><span class="entity">eq</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">≡</span>
        <span class="free"><span class="bound"><span class="entity">ball</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> rel_option <span class="free"><span class="bound"><span class="entity">eq</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">lu</span></span></span> <span class="bound">k</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
        <span class="free"><span class="bound"><span class="entity">ball</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> rel_option <span class="free"><span class="bound"><span class="entity">eq</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">lu</span></span></span> <span class="bound">k</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">v</span><span class="main">)</span><span class="main">)</span>"</span></span>

    <span class="keyword1" id="Implement-gen_equals"><span class="command">lemma</span></span> gen_equals<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted">PRIO_TAG_GEN_ALGO</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> BALL<span class="main">:</span> <span class="quoted"><span class="quoted">"GEN_OP <span class="free">ball</span> op_map_ball <span class="main">(</span><span class="main">⟨</span><span class="free">Rk</span><span class="main">,</span> <span class="free">Rv</span><span class="main">⟩</span> <span class="free">Rm</span> <span class="main">→</span> <span class="main">(</span><span class="free">Rk</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">Rv</span> <span class="main">→</span> bool_rel<span class="main">)</span> <span class="main">→</span> bool_rel<span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> LU<span class="main">:</span> <span class="quoted"><span class="quoted">"GEN_OP <span class="free">lu</span> op_map_lookup <span class="main">(</span><span class="free">Rk</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Rk</span><span class="main">,</span> <span class="free">Rv</span><span class="main">⟩</span> <span class="free">Rm</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Rv</span><span class="main">⟩</span> option_rel<span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> EQ<span class="main">:</span> <span class="quoted"><span class="quoted">"GEN_OP <span class="free">eq</span> HOL.eq <span class="main">(</span><span class="free">Rv</span> <span class="main">→</span> <span class="free">Rv</span> <span class="main">→</span> bool_rel<span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>gen_equals <span class="free">ball</span> <span class="free">lu</span> <span class="free">eq</span><span class="main">,</span> HOL.eq<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">Rk</span><span class="main">,</span> <span class="free">Rv</span><span class="main">⟩</span> <span class="free">Rm</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Rk</span><span class="main">,</span> <span class="free">Rv</span><span class="main">⟩</span> <span class="free">Rm</span> <span class="main">→</span> bool_rel"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> fun_relI<span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">unfolded</span> <span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic">autoref_tag_defs</span></span></span></span></span></span><span class="main">,</span> <span class="operator">param</span><span class="main">]</span> <span class="main">=</span> BALL LU EQ
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">fi</span> <span class="skolem">f</span> <span class="skolem">gi</span> <span class="skolem">g</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">fi</span><span class="main">,</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">Rk</span><span class="main">,</span> <span class="free">Rv</span><span class="main">⟩</span> <span class="free">Rm</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">gi</span><span class="main">,</span> <span class="skolem">g</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">Rk</span><span class="main">,</span> <span class="free">Rv</span><span class="main">⟩</span> <span class="free">Rm</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gen_equals <span class="free">ball</span> <span class="free">lu</span> <span class="free">eq</span> <span class="skolem">fi</span> <span class="skolem">gi</span> <span class="main">⟷</span> <span class="free">ball</span> <span class="skolem">fi</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> rel_option <span class="free">eq</span> <span class="main">(</span><span class="free">lu</span> <span class="bound">k</span> <span class="skolem">gi</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
        <span class="free">ball</span> <span class="skolem">gi</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> rel_option <span class="free">eq</span> <span class="main">(</span><span class="free">lu</span> <span class="bound">k</span> <span class="skolem">fi</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> gen_equals_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ball</span> <span class="skolem">fi</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> rel_option <span class="free">eq</span> <span class="main">(</span><span class="free">lu</span> <span class="bound">k</span> <span class="skolem">gi</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span>
        op_map_ball <span class="skolem">f</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> rel_option HOL.eq <span class="main">(</span>op_map_lookup <span class="bound">k</span> <span class="skolem">g</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> IdD<span class="main">)</span> <span class="main">(</span><span class="operator">parametricity</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ball</span> <span class="skolem">gi</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> rel_option <span class="free">eq</span> <span class="main">(</span><span class="free">lu</span> <span class="bound">k</span> <span class="skolem">fi</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span>
        op_map_ball <span class="skolem">g</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> rel_option HOL.eq <span class="main">(</span>op_map_lookup <span class="bound">k</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> IdD<span class="main">)</span> <span class="main">(</span><span class="operator">parametricity</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"op_map_ball <span class="skolem">f</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> rel_option HOL.eq <span class="main">(</span>op_map_lookup <span class="bound">k</span> <span class="skolem">g</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
        op_map_ball <span class="skolem">g</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> rel_option HOL.eq <span class="main">(</span>op_map_lookup <span class="bound">k</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span>
        <span class="main">(</span><span class="main">∀</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">a</span> <span class="main">=</span> Some <span class="bound">b</span> <span class="main">⟷</span> <span class="skolem">g</span> <span class="bound">a</span> <span class="main">=</span> Some <span class="bound">b</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> op_map_ball_def map_to_set_def option.rel_eq op_map_lookup_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">a</span> <span class="main">=</span> Some <span class="bound">b</span> <span class="main">⟷</span> <span class="skolem">g</span> <span class="bound">a</span> <span class="main">=</span> Some <span class="bound">b</span><span class="main">)</span> <span class="main">⟷</span> <span class="skolem">f</span> <span class="main">=</span> <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> option.exhaust ext <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>gen_equals <span class="free">ball</span> <span class="free">lu</span> <span class="free">eq</span> <span class="skolem">fi</span> <span class="skolem">gi</span><span class="main">,</span> <span class="skolem">f</span> <span class="main">=</span> <span class="skolem">g</span><span class="main">)</span> <span class="main">∈</span> bool_rel"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="comment1">(* TODO: why don't we just SPEC a list and then use map_of ∘ enumerate, all of this
      could be done right in the implementation so we don't need a generic algorithm *)</span>
    <span class="comment1">(* TODO: generic algorithms should really be generic, this is sort of specialized,
      replace with do { xs ← op_set_to_list S; RETURN (map_of (xs || [0 ..&lt; length xs])) } *)</span>
    <span class="keyword1"><span class="command">definition</span></span> <span class="entity">op_set_enumerate</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇀</span> nat<span class="main">)</span> nres"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">op_set_enumerate</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> SPEC <span class="main">(</span><span class="main">λ</span> <span class="bound">f</span><span class="main">.</span> dom <span class="bound">f</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">∧</span> inj_on <span class="bound">f</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">autoref_itype</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"op_set_enumerate <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">A</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_set <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">A</span><span class="main">,</span> i_nat<span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_map<span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_nres"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">autoref_hom</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"CONSTRAINT op_set_enumerate <span class="main">(</span><span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> <span class="free">Rs</span> <span class="main">→</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">A</span><span class="main">,</span> nat_rel<span class="main">⟩</span> <span class="free">Rm</span><span class="main">⟩</span> nres_rel<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">definition</span></span> <span class="entity">gen_enumerate</span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">gen_enumerate</span> <span class="free"><span class="bound"><span class="entity">tol</span></span></span> <span class="free"><span class="bound"><span class="entity">upd</span></span></span> <span class="free"><span class="bound"><span class="entity">emp</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> snd <span class="main">(</span>fold <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">upd</span></span></span> <span class="bound">x</span> <span class="bound">k</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">tol</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">emp</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

    <span class="keyword1" id="Implement-gen_enumerate"><span class="command">lemma</span></span> gen_enumerate<span class="main">[</span><span class="operator">autoref_rules_raw</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted">PRIO_TAG_GEN_ALGO</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> to_list<span class="main">:</span> <span class="quoted"><span class="quoted">"SIDE_GEN_ALGO <span class="main">(</span>is_set_to_list <span class="free">A</span> <span class="free">Rs</span> <span class="free">tol</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> empty<span class="main">:</span> <span class="quoted"><span class="quoted">"GEN_OP <span class="free">emp</span> op_map_empty <span class="main">(</span><span class="main">⟨</span><span class="free">A</span><span class="main">,</span> nat_rel<span class="main">⟩</span> <span class="free">Rm</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> update<span class="main">:</span> <span class="quoted"><span class="quoted">"GEN_OP <span class="free">upd</span> op_map_update <span class="main">(</span><span class="free">A</span> <span class="main">→</span> nat_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">A</span><span class="main">,</span> nat_rel<span class="main">⟩</span> <span class="free">Rm</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">A</span><span class="main">,</span> nat_rel<span class="main">⟩</span> <span class="free">Rm</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="bound">S</span><span class="main">.</span> RETURN <span class="main">(</span>gen_enumerate <span class="free">tol</span> <span class="free">upd</span> <span class="free">emp</span> <span class="bound">S</span><span class="main">)</span><span class="main">,</span> op_set_enumerate<span class="main">)</span> <span class="main">∈</span>
        <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> <span class="free">Rs</span> <span class="main">→</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">A</span><span class="main">,</span> nat_rel<span class="main">⟩</span> <span class="free">Rm</span><span class="main">⟩</span> nres_rel"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">unfolded</span> <span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic">autoref_tag_defs</span></span></span></span><span class="main">,</span> <span class="operator">param</span><span class="main">]</span> <span class="main">=</span> empty update
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">T</span> <span class="skolem">S</span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">T</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> <span class="free">Rs</span>"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tsl'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        <span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">tol</span> <span class="skolem">T</span><span class="main">,</span> <span class="skolem">tsl'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span>list_rel"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> IT'<span class="main">:</span> <span class="quoted"><span class="quoted">"RETURN <span class="skolem">tsl'</span> <span class="main">≤</span> it_to_sorted_list <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="skolem">S</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> to_list<span class="main">[</span><span class="operator">unfolded</span> <span class="dynamic"><span class="dynamic">autoref_tag_defs</span></span> is_set_to_list_def<span class="main">]</span> 1
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> is_set_to_sorted_listE<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> IT' <span class="keyword1"><span class="command">have</span></span> 10<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> set <span class="skolem">tsl'</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">tsl'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> it_to_sorted_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span>snd <span class="main">(</span>fold <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">,</span> <span class="bound">m</span> <span class="main">(</span><span class="bound">x</span> <span class="main">↦</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">tsl'</span> <span class="main">(</span><span class="skolem">k</span><span class="main">,</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dom <span class="skolem">m</span> <span class="main">∪</span> set <span class="skolem">tsl'</span>"</span></span>
        <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span> <span class="skolem">m</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">tsl'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="skolem">m</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span>snd <span class="main">(</span>fold <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">,</span> <span class="bound">m</span> <span class="main">(</span><span class="bound">x</span> <span class="main">↦</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">tsl'</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> Map.empty<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">tsl'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 10<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> inj_onI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fold_map_of<span class="main">)</span>
          <span class="main">(</span><span class="operator">metis</span> diff_zero distinct_Ex1 distinct_upt length_upt map_of_zip_nth option.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"RETURN <span class="main">(</span>snd <span class="main">(</span>fold <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">,</span> op_map_update <span class="bound">x</span> <span class="bound">k</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="skolem">tsl'</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> op_map_empty<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>RETURN <span class="main">(</span>gen_enumerate <span class="free">tol</span> <span class="free">upd</span> <span class="free">emp</span> <span class="skolem">T</span><span class="main">)</span><span class="main">,</span> <span class="var">?f</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">A</span><span class="main">,</span> nat_rel<span class="main">⟩</span> <span class="free">Rm</span><span class="main">⟩</span> nres_rel"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> gen_enumerate_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?f</span><span class="main">,</span> op_set_enumerate <span class="skolem">S</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id<span class="main">⟩</span> nres_rel"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> op_set_enumerate_def <span class="keyword1"><span class="command">using</span></span> 2 3 10 <span class="keyword1"><span class="command">by</span></span> <span class="operator">refine_vcg</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>RETURN <span class="main">(</span>gen_enumerate <span class="free">tol</span> <span class="free">upd</span> <span class="free">emp</span> <span class="skolem">T</span><span class="main">)</span><span class="main">,</span> op_set_enumerate <span class="skolem">S</span><span class="main">)</span> <span class="main">∈</span>
        <span class="main">⟨</span><span class="main">⟨</span><span class="free">A</span><span class="main">,</span> nat_rel<span class="main">⟩</span> <span class="free">Rm</span><span class="main">⟩</span> nres_rel"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> nres_rel_comp <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Implement-gen_enumerate_it_to_list"><span class="command">lemma</span></span> gen_enumerate_it_to_list<span class="main">[</span><span class="operator">refine_transfer_post_simp</span><span class="main">]</span><span class="main">:</span>
      <span class="quoted"><span class="quoted">"gen_enumerate <span class="main">(</span>it_to_list <span class="free">it</span><span class="main">)</span> <span class="main">=</span>
       <span class="main">(</span><span class="main">λ</span> <span class="bound">upd</span> <span class="bound">emp</span> <span class="bound">S</span><span class="main">.</span> snd <span class="main">(</span>foldli <span class="main">(</span>it_to_list <span class="free">it</span> <span class="bound">S</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span>
      <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">s</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">,</span> <span class="bound">upd</span> <span class="bound">x</span> <span class="bound">k</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="bound">emp</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> gen_enumerate_def
      <span class="keyword1"><span class="command">unfolding</span></span> foldl_conv_fold<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> foldli_foldl<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>

    <span class="keyword1"><span class="command">definition</span></span> <span class="entity">gen_build</span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">gen_build</span> <span class="free"><span class="bound"><span class="entity">tol</span></span></span> <span class="free"><span class="bound"><span class="entity">upd</span></span></span> <span class="free"><span class="bound"><span class="entity">emp</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">≡</span> fold <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">upd</span></span></span> <span class="bound">x</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">tol</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">emp</span></span></span>"</span></span>

    <span class="keyword1" id="Implement-gen_build"><span class="command">lemma</span></span> gen_build<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted">PRIO_TAG_GEN_ALGO</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> to_list<span class="main">:</span> <span class="quoted"><span class="quoted">"SIDE_GEN_ALGO <span class="main">(</span>is_set_to_list <span class="free">A</span> <span class="free">Rs</span> <span class="free">tol</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> empty<span class="main">:</span> <span class="quoted"><span class="quoted">"GEN_OP <span class="free">emp</span> op_map_empty <span class="main">(</span><span class="main">⟨</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">⟩</span> <span class="free">Rm</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> update<span class="main">:</span> <span class="quoted"><span class="quoted">"GEN_OP <span class="free">upd</span> op_map_update <span class="main">(</span><span class="free">A</span> <span class="main">→</span> <span class="free">B</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">⟩</span> <span class="free">Rm</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">⟩</span> <span class="free">Rm</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="bound">f</span> <span class="bound">X</span><span class="main">.</span> gen_build <span class="free">tol</span> <span class="free">upd</span> <span class="free">emp</span> <span class="bound">f</span> <span class="bound">X</span><span class="main">,</span> <span class="main">λ</span> <span class="bound">f</span> <span class="bound">X</span><span class="main">.</span> <span class="main">(</span>Some <span class="main">∘</span> <span class="bound">f</span><span class="main">)</span> <span class="main">|`</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span>
        <span class="main">(</span><span class="free">A</span> <span class="main">→</span> <span class="free">B</span><span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> <span class="free">Rs</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">⟩</span> <span class="free">Rm</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> fun_relI<span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">unfolded</span> <span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic">autoref_tag_defs</span></span></span></span><span class="main">,</span> <span class="operator">param</span><span class="main">]</span> <span class="main">=</span> empty update
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="skolem">g</span> <span class="skolem">T</span> <span class="skolem">S</span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">g</span><span class="main">,</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">→</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">T</span><span class="main">,</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> <span class="free">Rs</span>"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tsl'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        <span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">tol</span> <span class="skolem">T</span><span class="main">,</span> <span class="skolem">tsl'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span>list_rel"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> IT'<span class="main">:</span> <span class="quoted"><span class="quoted">"RETURN <span class="skolem">tsl'</span> <span class="main">≤</span> it_to_sorted_list <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="skolem">S</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> to_list<span class="main">[</span><span class="operator">unfolded</span> <span class="dynamic"><span class="dynamic">autoref_tag_defs</span></span> is_set_to_list_def<span class="main">]</span> 1<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> is_set_to_sorted_listE<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> IT' <span class="keyword1"><span class="command">have</span></span> 10<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> set <span class="skolem">tsl'</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">tsl'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> it_to_sorted_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gen_build <span class="free">tol</span> <span class="free">upd</span> <span class="free">emp</span> <span class="skolem">g</span> <span class="skolem">T</span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="free">upd</span> <span class="bound">x</span> <span class="main">(</span><span class="skolem">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">tol</span> <span class="skolem">T</span><span class="main">)</span> <span class="free">emp</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> gen_build_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">…</span><span class="main">,</span> fold <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> op_map_update <span class="bound">x</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">tsl'</span> op_map_empty<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">⟩</span> <span class="free">Rm</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fold <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> op_map_update <span class="bound">x</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">tsl'</span> <span class="skolem">m</span> <span class="main">=</span> <span class="skolem">m</span> <span class="main">++</span> <span class="main">(</span>Some <span class="main">∘</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">|`</span> <span class="skolem">S</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">m</span>
        <span class="keyword1"><span class="command">unfolding</span></span> 10 op_map_update_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">tsl'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">m</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restrict_map_insert<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"op_map_empty <span class="main">++</span> <span class="main">(</span>Some <span class="main">∘</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">|`</span> <span class="skolem">S</span> <span class="main">=</span> <span class="main">(</span>Some <span class="main">∘</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">|`</span> <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>gen_build <span class="free">tol</span> <span class="free">upd</span> <span class="free">emp</span> <span class="skolem">g</span> <span class="skolem">T</span><span class="main">,</span> <span class="main">(</span>Some <span class="main">∘</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">|`</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">⟩</span> <span class="free">Rm</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">to_list</span> <span class="free"><span class="bound"><span class="entity">it</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">it</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> top Cons Nil"</span></span>

    <span class="keyword1" id="Implement-map2set_to_list"><span class="command">lemma</span></span> map2set_to_list<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"GEN_ALGO_tag <span class="main">(</span>is_map_to_list <span class="free">Rk</span> unit_rel <span class="free">R</span> <span class="free">it</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_set_to_list <span class="free">Rk</span> <span class="main">(</span>map2set_rel <span class="free">R</span><span class="main">)</span> <span class="main">(</span>to_list <span class="main">(</span>map_iterator_dom <span class="main">∘</span> <span class="main">(</span>foldli <span class="main">∘</span> <span class="free">it</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_set_to_list_def is_set_to_sorted_list_def
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="skolem">g</span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="skolem">g</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">Rk</span><span class="main">⟩</span> map2set_rel <span class="free">R</span>"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>it_to_list <span class="main">(</span>map_iterator_dom <span class="main">∘</span> <span class="main">(</span>foldli <span class="main">∘</span> <span class="free">it</span><span class="main">)</span><span class="main">)</span> <span class="skolem">f</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">Rk</span><span class="main">⟩</span> list_rel"</span></span>
        <span class="quoted"><span class="quoted">"RETURN <span class="skolem">xs</span> <span class="main">≤</span> it_to_sorted_list <span class="main">(</span><span class="main">λ</span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="skolem">g</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> map2set_to_list<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> 1
        <span class="keyword1"><span class="command">unfolding</span></span> is_set_to_list_def is_set_to_sorted_list_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"map_iterator_dom <span class="main">(</span>foldli <span class="skolem">xs</span><span class="main">)</span> top <span class="main">(#)</span> <span class="skolem">a</span> <span class="main">=</span>
        rev <span class="main">(</span>map_iterator_dom <span class="main">(</span>foldli <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span> <span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>rev <span class="skolem">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'k</span> <span class="main">×</span> unit<span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">a</span>
          <span class="keyword1"><span class="command">unfolding</span></span> map_iterator_dom_def set_iterator_image_def set_iterator_image_filter_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">xs</span><span class="main">.</span> <span class="main">(</span>to_list <span class="main">(</span>map_iterator_dom <span class="main">∘</span> <span class="main">(</span>foldli <span class="main">∘</span> <span class="free">it</span><span class="main">)</span><span class="main">)</span> <span class="skolem">f</span><span class="main">,</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">Rk</span><span class="main">⟩</span> list_rel <span class="main">∧</span>
        RETURN <span class="bound">xs</span> <span class="main">≤</span> it_to_sorted_list <span class="main">(</span><span class="main">λ</span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="skolem">g</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"to_list <span class="main">(</span>map_iterator_dom <span class="main">∘</span> <span class="main">(</span>foldli <span class="main">∘</span> <span class="free">it</span><span class="main">)</span><span class="main">)</span> <span class="skolem">f</span> <span class="main">=</span>
          rev <span class="main">(</span>it_to_list <span class="main">(</span>map_iterator_dom <span class="main">∘</span> <span class="main">(</span>foldli <span class="main">∘</span> <span class="free">it</span><span class="main">)</span><span class="main">)</span> <span class="skolem">f</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> to_list_def it_to_list_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 3<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rev <span class="main">(</span>it_to_list <span class="main">(</span>map_iterator_dom <span class="main">∘</span> <span class="main">(</span>foldli <span class="main">∘</span> <span class="free">it</span><span class="main">)</span><span class="main">)</span> <span class="skolem">f</span><span class="main">)</span><span class="main">,</span> rev <span class="skolem">xs</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">Rk</span><span class="main">⟩</span> list_rel"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>to_list <span class="main">(</span>map_iterator_dom <span class="main">∘</span> <span class="main">(</span>foldli <span class="main">∘</span> <span class="free">it</span><span class="main">)</span><span class="main">)</span> <span class="skolem">f</span><span class="main">,</span> rev <span class="skolem">xs</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">Rk</span><span class="main">⟩</span> list_rel"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"RETURN <span class="main">(</span>rev <span class="skolem">xs</span><span class="main">)</span> <span class="main">≤</span> it_to_sorted_list <span class="main">(</span><span class="main">λ</span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="skolem">g</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> it_to_sorted_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Implement-CAST_to_list"><span class="command">lemma</span></span> CAST_to_list<span class="main">[</span><span class="operator">autoref_rules_raw</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted">PRIO_TAG_GEN_ALGO</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SIDE_GEN_ALGO <span class="main">(</span>is_set_to_list <span class="free">A</span> <span class="free">Rs</span> <span class="free">tol</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">tol</span><span class="main">,</span> CAST<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> <span class="free">Rs</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> list_set_rel"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="dynamic"><span class="dynamic">autoref_tag_defs</span></span> is_set_to_list_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> it_to_sorted_list_def list_set_rel_def in_br_conv <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> is_set_to_sorted_listE<span class="main">)</span>

    <span class="comment1">(* TODO: do we really need stronger versions of all these small lemmata? *)</span>
    <span class="keyword1" id="Implement-param_foldli"><span class="command">lemma</span></span> param_foldli<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">ys</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">Ra</span><span class="main">⟩</span> list_rel"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="free">d</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Rs</span> <span class="main">→</span> bool_rel"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Ra</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="free">ys</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">,</span> <span class="free">g</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Rs</span> <span class="main">→</span> <span class="free">Rs</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Rs</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>foldli <span class="free">xs</span> <span class="free">c</span> <span class="free">f</span> <span class="free">a</span><span class="main">,</span> foldli <span class="free">ys</span> <span class="free">d</span> <span class="free">g</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Rs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">xs</span> <span class="skolem">ys</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="skolem">a</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">have</span></span> 10<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span> <span class="skolem">a</span><span class="main">,</span> <span class="free">d</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> bool_rel"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
        <span class="keyword1"><span class="command">have</span></span> 20<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 10 True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> 30<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>foldli <span class="skolem">xs</span> <span class="free">c</span> <span class="free">f</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span> <span class="skolem">a</span><span class="main">)</span><span class="main">,</span> foldli <span class="skolem">ys</span> <span class="free">d</span> <span class="free">g</span> <span class="main">(</span><span class="free">g</span> <span class="skolem">y</span> <span class="skolem">b</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Rs</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> 2 2<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">THEN</span> fun_relD<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> True 20 30 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">have</span></span> 10<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span> <span class="skolem">a</span><span class="main">,</span> <span class="free">d</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> bool_rel"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
        <span class="keyword1"><span class="command">have</span></span> 20<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">d</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 10 False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> foldli.simps <span class="keyword1"><span class="command">using</span></span> False 20 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1" id="Implement-det_fold_sorted_set"><span class="command">lemma</span></span> det_fold_sorted_set<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"det_fold_set <span class="free">ordR</span> <span class="free">c'</span> <span class="free">f'</span> <span class="free">σ'</span> <span class="free">result</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"is_set_to_sorted_list <span class="free">ordR</span> <span class="free">Rk</span> <span class="free">Rs</span> <span class="free">tsl</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> SREF<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">s'</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">Rk</span><span class="main">⟩</span><span class="free">Rs</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span><span class="free">Rσ</span><span class="main">→</span>Id"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Rk</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">s'</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">,</span><span class="free">f'</span> <span class="bound">y</span><span class="main">)</span><span class="main">∈</span><span class="free">Rσ</span> <span class="main">→</span> <span class="free">Rσ</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ</span><span class="main">,</span><span class="free">σ'</span><span class="main">)</span><span class="main">∈</span><span class="free">Rσ</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>foldli <span class="main">(</span><span class="free">tsl</span> <span class="free">s</span><span class="main">)</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ</span><span class="main">,</span> <span class="free">result</span> <span class="free">s'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Rσ</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tsl'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        n<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">tsl</span> <span class="free">s</span><span class="main">,</span><span class="skolem">tsl'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">Rk</span><span class="main">⟩</span>list_rel"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> IT<span class="main">:</span> <span class="quoted"><span class="quoted">"RETURN <span class="skolem">tsl'</span> <span class="main">≤</span> it_to_sorted_list <span class="free">ordR</span> <span class="free">s'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 2 SREF
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> is_set_to_sorted_listE<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> IT <span class="keyword1"><span class="command">have</span></span> suen<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="main">=</span> set <span class="skolem">tsl'</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> it_to_sorted_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>foldli <span class="main">(</span><span class="free">tsl</span> <span class="free">s</span><span class="main">)</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ</span><span class="main">,</span> foldli <span class="skolem">tsl'</span> <span class="free">c'</span> <span class="free">f'</span> <span class="free">σ'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Rσ</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">,</span> 5<span class="main">,</span> 6<span class="main">)</span> n <span class="keyword1"><span class="command">unfolding</span></span> suen
        <span class="keyword1"><span class="command">using</span></span> param_foldli<span class="main">[</span><span class="operator">OF</span> n assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"foldli <span class="skolem">tsl'</span> <span class="free">c'</span> <span class="free">f'</span> <span class="free">σ'</span> <span class="main">=</span> <span class="free">result</span> <span class="free">s'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 1 IT
        <span class="keyword1"><span class="command">unfolding</span></span> det_fold_set_def it_to_sorted_list_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1" id="Implement-det_fold_set"><span class="command">lemma</span></span> det_fold_set<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"det_fold_set <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="free">c'</span> <span class="free">f'</span> <span class="free">σ'</span> <span class="free">result</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_set_to_list <span class="free">Rk</span> <span class="free">Rs</span> <span class="free">tsl</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">s'</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">Rk</span><span class="main">⟩</span><span class="free">Rs</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">c'</span><span class="main">)</span><span class="main">∈</span><span class="free">Rσ</span><span class="main">→</span>Id"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Rk</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">s'</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">,</span> <span class="free">f'</span> <span class="bound">y</span><span class="main">)</span><span class="main">∈</span><span class="free">Rσ</span> <span class="main">→</span> <span class="free">Rσ</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">σ</span><span class="main">,</span><span class="free">σ'</span><span class="main">)</span><span class="main">∈</span><span class="free">Rσ</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>foldli <span class="main">(</span><span class="free">tsl</span> <span class="free">s</span><span class="main">)</span> <span class="free">c</span> <span class="free">f</span> <span class="free">σ</span><span class="main">,</span> <span class="free">result</span> <span class="free">s'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Rσ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> is_set_to_list_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> det_fold_sorted_set<span class="main">)</span>
    <span class="keyword1" id="Implement-gen_image"><span class="command">lemma</span></span> gen_image<span class="main">[</span><span class="operator">autoref_rules_raw</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted">PRIO_TAG_GEN_ALGO</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> IT<span class="main">:</span> <span class="quoted"><span class="quoted">"SIDE_GEN_ALGO <span class="main">(</span>is_set_to_list <span class="free">Rk</span> <span class="free">Rs1</span> <span class="free">it1</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> INS<span class="main">:</span> <span class="quoted"><span class="quoted">"GEN_OP <span class="free">ins2</span> Set.insert <span class="main">(</span><span class="free">Rk'</span><span class="main">→</span><span class="main">⟨</span><span class="free">Rk'</span><span class="main">⟩</span><span class="free">Rs2</span><span class="main">→</span><span class="main">⟨</span><span class="free">Rk'</span><span class="main">⟩</span><span class="free">Rs2</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> EMPTY<span class="main">:</span> <span class="quoted"><span class="quoted">"GEN_OP <span class="free">empty2</span> <span class="main">{}</span> <span class="main">(</span><span class="main">⟨</span><span class="free">Rk'</span><span class="main">⟩</span><span class="free">Rs2</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">xi</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">xi</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Rk</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">fi</span> <span class="bound">xi</span><span class="main">,</span> <span class="free">f</span> <span class="main">$</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Rk'</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">Rk</span><span class="main">⟩</span><span class="free">Rs1</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>gen_image <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> foldli <span class="main">(</span><span class="free">it1</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">empty2</span> <span class="free">ins2</span> <span class="free">fi</span> <span class="free">l</span><span class="main">,</span>
        <span class="main">(</span><span class="keyword1">OP</span> image <span class="main">:::</span> <span class="main">(</span><span class="free">Rk</span><span class="main">→</span><span class="free">Rk'</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="main">⟨</span><span class="free">Rk</span><span class="main">⟩</span><span class="free">Rs1</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="main">⟨</span><span class="free">Rk'</span><span class="main">⟩</span><span class="free">Rs2</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="free">f</span> <span class="main">$</span> <span class="free">s</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⟨</span><span class="free">Rk'</span><span class="main">⟩</span><span class="free">Rs2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">unfolded</span> <span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic">autoref_tag_defs</span></span></span></span><span class="main">,</span> <span class="operator">param</span><span class="main">]</span> <span class="main">=</span> INS EMPTY
      <span class="keyword1"><span class="command">note</span></span> 1 <span class="main">=</span> det_fold_set<span class="main">[</span><span class="operator">OF</span> foldli_image IT<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> <span class="dynamic"><span class="dynamic">autoref_tag_defs</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms 1 <span class="keyword1"><span class="command">unfolding</span></span> gen_image_def <span class="dynamic"><span class="dynamic">autoref_tag_defs</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="DRA_Implement">
<div class="head">
<h1>Theory DRA_Implement</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Implementation of Deterministic Rabin Automata›</span></span>

<span class="keyword1"><span class="command">theory</span></span> DRA_Implement
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="DRA_Refine.html">DRA_Refine</a>"</span>
  <span class="quoted">"<a href="Implement.html">../../Basic/Implement</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> drai <span class="main">=</span> drai
    <span class="main">(</span><span class="free"><span class="entity">alphabeti</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> list"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">initiali</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span>"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">transitioni</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span>"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">conditioni</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> rabin gen"</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">drai_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">×</span> <span class="tfree">'label<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'state<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">×</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> set <span class="main">⇒</span>
    <span class="main">(</span><span class="main">(</span><span class="tfree">'label<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> drai <span class="main">×</span> <span class="main">(</span><span class="tfree">'label<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> drai<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="main">[</span><span class="operator">to_relAPP</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">drai_rel</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">.</span>
      <span class="main">(</span>alphabeti <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> alphabeti <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">⟩</span> list_rel <span class="main">∧</span>
      <span class="main">(</span>initiali <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> initiali <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">∧</span>
      <span class="main">(</span>transitioni <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> transitioni <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">∧</span>
      <span class="main">(</span>conditioni <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> conditioni <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>rabin_rel <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">⟩</span> list_rel<span class="main">}</span>"</span></span>

  <span class="keyword1" id="DRA_Implement-drai_param"><span class="command">lemma</span></span> drai_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>drai<span class="main">,</span> drai<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">⟩</span> list_rel <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> <span class="main">(</span><span class="free">L</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> <span class="free">S</span><span class="main">)</span> <span class="main">→</span>
      <span class="main">⟨</span>rabin_rel <span class="free">S</span><span class="main">⟩</span> list_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> drai_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>alphabeti<span class="main">,</span> alphabeti<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> drai_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">L</span><span class="main">⟩</span> list_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>initiali<span class="main">,</span> initiali<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> drai_rel <span class="main">→</span> <span class="free">S</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>transitioni<span class="main">,</span> transitioni<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> drai_rel <span class="main">→</span> <span class="free">L</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> <span class="free">S</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>conditioni<span class="main">,</span> conditioni<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> drai_rel <span class="main">→</span> <span class="main">⟨</span>rabin_rel <span class="free">S</span><span class="main">⟩</span> list_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> drai_rel_def fun_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">drai_dra_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">×</span> <span class="tfree">'label<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'state<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">×</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> set <span class="main">⇒</span>
    <span class="main">(</span><span class="main">(</span><span class="tfree">'label<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> drai <span class="main">×</span> <span class="main">(</span><span class="tfree">'label<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> dra<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="main">[</span><span class="operator">to_relAPP</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">drai_dra_rel</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">.</span>
      <span class="main">(</span>alphabeti <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> alphabet <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">⟩</span> list_set_rel <span class="main">∧</span>
      <span class="main">(</span>initiali <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> initial <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">∧</span>
      <span class="main">(</span>transitioni <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> transition <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">∧</span>
      <span class="main">(</span>conditioni <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> condition <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>rabin_rel <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">⟩</span> list_rel<span class="main">}</span>"</span></span>

  <span class="keyword1" id="DRA_Implement-drai_dra_param"><span class="command">lemma</span></span> drai_dra_param<span class="main">[</span><span class="operator">param</span><span class="main">,</span> <span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>drai<span class="main">,</span> dra<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">⟩</span> list_set_rel <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> <span class="main">(</span><span class="free">L</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> <span class="free">S</span><span class="main">)</span> <span class="main">→</span>
      <span class="main">⟨</span>rabin_rel <span class="free">S</span><span class="main">⟩</span> list_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> drai_dra_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>alphabeti<span class="main">,</span> alphabet<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> drai_dra_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">L</span><span class="main">⟩</span> list_set_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>initiali<span class="main">,</span> initial<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> drai_dra_rel <span class="main">→</span> <span class="free">S</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>transitioni<span class="main">,</span> transition<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> drai_dra_rel <span class="main">→</span> <span class="free">L</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> <span class="free">S</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>conditioni<span class="main">,</span> condition<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> drai_dra_rel <span class="main">→</span> <span class="main">⟨</span>rabin_rel <span class="free">S</span><span class="main">⟩</span> list_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> drai_dra_rel_def fun_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">drai_dra</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> drai <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> dra"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">drai_dra</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> dra <span class="main">(</span>set <span class="main">(</span>alphabeti <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>initiali <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span>transitioni <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span>conditioni <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">drai_invar</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> drai <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">drai_invar</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> distinct <span class="main">(</span>alphabeti <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="DRA_Implement-drai_dra_id_param"><span class="command">lemma</span></span> drai_dra_id_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>drai_dra<span class="main">,</span> id<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> drai_dra_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> dra_rel"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Ai</span> <span class="skolem">A</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Ai</span><span class="main">,</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> drai_dra_rel"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"drai_dra <span class="skolem">Ai</span> <span class="main">=</span> dra <span class="main">(</span>set <span class="main">(</span>alphabeti <span class="skolem">Ai</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>initiali <span class="skolem">Ai</span><span class="main">)</span> <span class="main">(</span>transitioni <span class="skolem">Ai</span><span class="main">)</span> <span class="main">(</span>conditioni <span class="skolem">Ai</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> drai_dra_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"id <span class="skolem">A</span> <span class="main">=</span> dra <span class="main">(</span>id <span class="main">(</span>alphabet <span class="skolem">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>initial <span class="skolem">A</span><span class="main">)</span> <span class="main">(</span>transition <span class="skolem">A</span><span class="main">)</span> <span class="main">(</span>condition <span class="skolem">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>drai_dra <span class="skolem">Ai</span><span class="main">,</span> id <span class="skolem">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> dra_rel"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 2 3 <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="DRA_Implement-drai_dra_br"><span class="command">lemma</span></span> drai_dra_br<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Id<span class="main">,</span> Id<span class="main">⟩</span> drai_dra_rel <span class="main">=</span> br drai_dra drai_invar"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id<span class="main">,</span> Id<span class="main">⟩</span> drai_dra_rel"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> br drai_dra drai_invar"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">A</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> dra"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> drai_dra_rel_def drai_dra_def drai_invar_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_br_conv list_set_rel_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> br drai_dra drai_invar"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id<span class="main">,</span> Id<span class="main">⟩</span> drai_dra_rel"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">A</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> dra"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>drai_dra <span class="skolem">A</span><span class="main">,</span> id <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id<span class="main">,</span> Id<span class="main">⟩</span> dra_rel"</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"drai_invar <span class="skolem">A</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> drai_dra_param<span class="main">(</span>2 - 5<span class="main">)</span><span class="main">[</span><span class="operator">param_fo</span><span class="main">,</span> <span class="operator">OF</span> that<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_br_conv list_set_rel_def drai_invar_def<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="keyword1"><span class="command">unfolding</span></span> in_br_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="DRA_Nodes">
<div class="head">
<h1>Theory DRA_Nodes</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Exploration of Deterministic Rabin Automata›</span></span>

<span class="keyword1"><span class="command">theory</span></span> DRA_Nodes
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../DFS_Framework/Reachable_Nodes.html">DFS_Framework.Reachable_Nodes</a>
  <a href="DRA_Implement.html">DRA_Implement</a>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">dra_G</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> dra <span class="main">⇒</span> <span class="tfree">'state</span> graph_rec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">dra_G</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">⦇</span> g_V <span class="main">=</span> UNIV<span class="main">,</span> g_E <span class="main">=</span> E_of_succ <span class="main">(</span>successors <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">,</span> g_V0 <span class="main">=</span> <span class="main">{</span>initial <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">}</span> <span class="main">⦈</span>"</span></span>

  <span class="keyword1" id="DRA_Nodes-dra_G_graph"><span class="command">lemma</span></span> dra_G_graph<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"graph <span class="main">(</span>dra_G <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dra_G_def graph_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1" id="DRA_Nodes-dra_G_reachable_nodes"><span class="command">lemma</span></span> dra_G_reachable_nodes<span class="main">:</span> <span class="quoted"><span class="quoted">"op_reachable <span class="main">(</span>dra_G <span class="free">A</span><span class="main">)</span> <span class="main">=</span> nodes <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> op_reachable_def dra_G_def graph_rec.simps E_of_succ_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> nodes <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>initial <span class="free">A</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> successors <span class="free">A</span> <span class="bound">u</span><span class="main">}</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>initial <span class="free">A</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> successors <span class="free">A</span> <span class="bound">u</span><span class="main">}</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> nodes <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rtrancl_into_rtrancl<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1"><span class="command">interpretation</span></span> autoref_syn <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>

    <span class="keyword1" id="DRA_Nodes-dra_G_ahs"><span class="command">lemma</span></span> dra_G_ahs<span class="main">:</span> <span class="quoted"><span class="quoted">"dra_G <span class="free">A</span> <span class="main">=</span> <span class="main">⦇</span> g_V <span class="main">=</span> UNIV<span class="main">,</span> g_E <span class="main">=</span> E_of_succ <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> CAST
      <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="bound">a</span><span class="main">.</span> transition <span class="free">A</span> <span class="bound">a</span> <span class="bound">p</span> <span class="main">:::</span> <span class="free">S</span><span class="main">)</span> <span class="main">`</span> alphabet <span class="free">A</span> <span class="main">:::</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> ahs_rel <span class="free">bhc</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> g_V0 <span class="main">=</span> <span class="main">{</span>initial <span class="free">A</span><span class="main">}</span> <span class="main">⦈</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> dra_G_def CAST_def id_apply E_of_succ_def <span class="dynamic"><span class="dynamic">autoref_tag_defs</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">schematic_goal</span></span> drai_Gi<span class="main">:</span>
      <span class="keyword2"><span class="keyword">notes</span></span> map2set_to_list<span class="main">[</span><span class="operator">autoref_ga_rules</span><span class="main">]</span>
      <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'statei</span> <span class="main">×</span> <span class="tfree">'state</span><span class="main">)</span> set"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_ga_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_bounded_hashcode <span class="free">S</span> <span class="free">seq</span> <span class="free">bhc</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_ga_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_valid_def_hm_size <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'statei</span><span class="main">)</span> <span class="free">hms</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">seq</span><span class="main">,</span> HOL.eq<span class="main">)</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> bool_rel"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ai</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> drai_dra_rel"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?f</span> <span class="main">::</span> <span class="tvar">?'a</span><span class="main">,</span> RETURN <span class="main">(</span>dra_G <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> dra_G_ahs<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> bhc <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">bhc</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">autoref_monadic</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">plain</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">drai_Gi</span> <span class="keyword2"><span class="keyword">uses</span></span> drai_Gi
    <span class="comment1">(* TODO: why are term local.drai_Gi and term BA_Nodes.drai_Gi not the same *)</span>
    <span class="keyword1" id="DRA_Nodes-drai_Gi_refine"><span class="command">lemma</span></span> drai_Gi_refine<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'statei</span> <span class="main">×</span> <span class="tfree">'state</span><span class="main">)</span> set"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SIDE_GEN_ALGO <span class="main">(</span>is_bounded_hashcode <span class="free">S</span> <span class="free">seq</span> <span class="free">bhc</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SIDE_GEN_ALGO <span class="main">(</span>is_valid_def_hm_size <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'statei</span><span class="main">)</span> <span class="free">hms</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"GEN_OP <span class="free">seq</span> HOL.eq <span class="main">(</span><span class="free">S</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> bool_rel<span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>DRA_Nodes.drai_Gi <span class="free">seq</span> <span class="free">bhc</span> <span class="free">hms</span><span class="main">,</span> dra_G<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> drai_dra_rel <span class="main">→</span> <span class="main">⟨</span>unit_rel<span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> g_impl_rel_ext"</span></span>
      <span class="keyword1"><span class="command">using</span></span> drai_Gi.refine<span class="main">[</span><span class="operator">THEN</span> RETURN_nres_relD<span class="main">]</span> assms <span class="keyword1"><span class="command">unfolding</span></span> <span class="dynamic"><span class="dynamic">autoref_tag_defs</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">schematic_goal</span></span> dra_nodes<span class="main">:</span>
      <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'statei</span> <span class="main">×</span> <span class="tfree">'state</span><span class="main">)</span> set"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span>g_E <span class="main">(</span>dra_G <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> g_V0 <span class="main">(</span>dra_G <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_ga_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_bounded_hashcode <span class="free">S</span> <span class="free">seq</span> <span class="free">bhc</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_ga_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_valid_def_hm_size <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'statei</span><span class="main">)</span> <span class="free">hms</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">seq</span><span class="main">,</span> HOL.eq<span class="main">)</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> bool_rel"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ai</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> drai_dra_rel"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?f</span> <span class="main">::</span> <span class="tvar">?'a</span><span class="main">,</span> op_reachable <span class="main">(</span>dra_G <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">autoref</span>
    <span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">dra_nodes</span> <span class="keyword2"><span class="keyword">uses</span></span> dra_nodes
    <span class="keyword1" id="DRA_Nodes-dra_nodes_refine"><span class="command">lemma</span></span> dra_nodes_refine<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'statei</span> <span class="main">×</span> <span class="tfree">'state</span><span class="main">)</span> set"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SIDE_PRECOND <span class="main">(</span>finite <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SIDE_GEN_ALGO <span class="main">(</span>is_bounded_hashcode <span class="free">S</span> <span class="free">seq</span> <span class="free">bhc</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SIDE_GEN_ALGO <span class="main">(</span>is_valid_def_hm_size <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'statei</span><span class="main">)</span> <span class="free">hms</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"GEN_OP <span class="free">seq</span> HOL.eq <span class="main">(</span><span class="free">S</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> bool_rel<span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ai</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> drai_dra_rel"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>DRA_Nodes.dra_nodes <span class="free">seq</span> <span class="free">bhc</span> <span class="free">hms</span> <span class="free">Ai</span><span class="main">,</span>
        <span class="main">(</span><span class="keyword1">OP</span> nodes <span class="main">:::</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> drai_dra_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> ahs_rel <span class="free">bhc</span><span class="main">)</span> <span class="main">$</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> ahs_rel <span class="free">bhc</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span>g_E <span class="main">(</span>dra_G <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> g_V0 <span class="main">(</span>dra_G <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="dynamic"><span class="dynamic">autoref_tag_defs</span></span> dra_G_reachable_nodes<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> dra_nodes.refine assms
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="dynamic"><span class="dynamic">autoref_tag_defs</span></span> dra_G_reachable_nodes<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="DRA_Explicit">
<div class="head">
<h1>Theory DRA_Explicit</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Explicit Deterministic Rabin Automata›</span></span>

<span class="keyword1"><span class="command">theory</span></span> DRA_Explicit
<span class="keyword2"><span class="keyword">imports</span></span> <a href="DRA_Nodes.html">DRA_Nodes</a>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> drae <span class="main">=</span> drae
    <span class="main">(</span><span class="free"><span class="entity">alphabete</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> set"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">initiale</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span>"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">transitione</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'state</span> <span class="main">×</span> <span class="tfree">'label</span> <span class="main">×</span> <span class="tfree">'state</span><span class="main">)</span> set"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">conditione</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'state</span> set <span class="main">×</span> <span class="tfree">'state</span> set<span class="main">)</span> list"</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">drae_rel</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="main">[</span><span class="operator">to_relAPP</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">drae_rel</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">.</span>
      <span class="main">(</span>alphabete <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> alphabete <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">⟩</span> set_rel <span class="main">∧</span>
      <span class="main">(</span>initiale <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> initiale <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">∧</span>
      <span class="main">(</span>transitione <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> transitione <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">⟩</span> set_rel <span class="main">∧</span>
      <span class="main">(</span>conditione <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> conditione <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">⟩</span> set_rel <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">⟩</span> set_rel<span class="main">⟩</span> list_rel<span class="main">}</span>"</span></span>

  <span class="keyword1" id="DRA_Explicit-drae_param"><span class="command">lemma</span></span> drae_param<span class="main">[</span><span class="operator">param</span><span class="main">,</span> <span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>drae<span class="main">,</span> drae<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">⟩</span> set_rel <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">L</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">S</span><span class="main">⟩</span> set_rel <span class="main">→</span>
      <span class="main">⟨</span><span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> set_rel <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> set_rel<span class="main">⟩</span> list_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> drae_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>alphabete<span class="main">,</span> alphabete<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> drae_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">L</span><span class="main">⟩</span> set_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>initiale<span class="main">,</span> initiale<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> drae_rel <span class="main">→</span> <span class="free">S</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>transitione<span class="main">,</span> transitione<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> drae_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">L</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">S</span><span class="main">⟩</span> set_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>conditione<span class="main">,</span> conditione<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> drae_rel <span class="main">→</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> set_rel <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> set_rel<span class="main">⟩</span> list_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> drae_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="DRA_Explicit-drae_rel_id"><span class="command">lemma</span></span> drae_rel_id<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Id<span class="main">,</span> Id<span class="main">⟩</span> drae_rel <span class="main">=</span> Id"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> drae_rel_def <span class="keyword1"><span class="command">using</span></span> drae.expand <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="DRA_Explicit-drae_rel_comp"><span class="command">lemma</span></span> drae_rel_comp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">L<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">O</span> <span class="free">L<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">O</span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> drae_rel <span class="main">=</span> <span class="main">⟨</span><span class="free">L<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">S<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> drae_rel <span class="keyword1">O</span> <span class="main">⟨</span><span class="free">L<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> drae_rel"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="skolem">B</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">O</span> <span class="free">L<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">O</span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> drae_rel"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span>alphabete <span class="skolem">A</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> set_rel"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> alphabete <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> set_rel"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span>initiale <span class="skolem">A</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b</span><span class="main">,</span> initiale <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span>transitione <span class="skolem">A</span><span class="main">,</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">L<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">S<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> set_rel"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">,</span> transitione <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">S<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">L<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> set_rel"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span>conditione <span class="skolem">A</span><span class="main">,</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">S<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> set_rel <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">⟨</span><span class="free">S<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> set_rel<span class="main">⟩</span> list_rel"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">d</span><span class="main">,</span> conditione <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">S<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> set_rel <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">⟨</span><span class="free">S<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> set_rel<span class="main">⟩</span> list_rel"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> drae_rel_def prod_rel_compp set_rel_compp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">S<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> drae_rel <span class="keyword1">O</span> <span class="main">⟨</span><span class="free">L<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> drae_rel"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> drae <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">S<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> drae_rel"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">unfolding</span></span> drae_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>drae <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span> <span class="skolem">d</span><span class="main">,</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> drae_rel"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">unfolding</span></span> drae_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">C</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">O</span> <span class="free">L<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">O</span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> drae_rel"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">S<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> drae_rel"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">B</span><span class="main">,</span> <span class="skolem">C</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> drae_rel"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">C</span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> drae_rel_def prod_rel_compp set_rel_compp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="comment1">(* TODO: why do we need all this setup? can't i_of_rel do the trick? *)</span>
  <span class="keyword1"><span class="command">consts</span></span> i_drae_scheme <span class="main">::</span> <span class="quoted"><span class="quoted">"interface <span class="main">⇒</span> interface <span class="main">⇒</span> interface"</span></span>

  <span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1"><span class="command">interpretation</span></span> autoref_syn <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>

    <span class="keyword1" id="DRA_Explicit-drae_scheme_itype"><span class="command">lemma</span></span> drae_scheme_itype<span class="main">[</span><span class="operator">autoref_itype</span><span class="main">]</span><span class="main">:</span>
      <span class="quoted"><span class="quoted">"drae <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">L</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_set <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">S</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">S</span><span class="main">,</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_prod<span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_prod<span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_set <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span>
        <span class="main">⟨</span><span class="main">⟨</span><span class="main">⟨</span><span class="free">S</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_set<span class="main">,</span> <span class="main">⟨</span><span class="free">S</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_set<span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_prod<span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_list <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_drae_scheme"</span></span>
      <span class="quoted"><span class="quoted">"alphabete <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_drae_scheme <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">L</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_set"</span></span>
      <span class="quoted"><span class="quoted">"initiale <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_drae_scheme <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">S</span>"</span></span>
      <span class="quoted"><span class="quoted">"transitione <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_drae_scheme <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">S</span><span class="main">,</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_prod<span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_prod<span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_set"</span></span>
      <span class="quoted"><span class="quoted">"conditione <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_drae_scheme <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="main">⟨</span><span class="main">⟨</span><span class="free">S</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_set<span class="main">,</span> <span class="main">⟨</span><span class="free">S</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_set<span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_prod<span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_list"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> draei <span class="main">=</span> draei
    <span class="main">(</span><span class="free"><span class="entity">alphabetei</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> list"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">initialei</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span>"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">transitionei</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'state</span> <span class="main">×</span> <span class="tfree">'label</span> <span class="main">×</span> <span class="tfree">'state</span><span class="main">)</span> list"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">conditionei</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'state</span> list <span class="main">×</span> <span class="tfree">'state</span> list<span class="main">)</span> list"</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">draei_rel</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="main">[</span><span class="operator">to_relAPP</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">draei_rel</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">.</span>
      <span class="main">(</span>alphabetei <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> alphabetei <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">⟩</span> list_rel <span class="main">∧</span>
      <span class="main">(</span>initialei <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> initialei <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">∧</span>
      <span class="main">(</span>transitionei <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> transitionei <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">⟩</span> list_rel <span class="main">∧</span>
      <span class="main">(</span>conditionei <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> conditionei <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">⟩</span> list_rel <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">⟩</span> list_rel<span class="main">⟩</span> list_rel<span class="main">}</span>"</span></span>

  <span class="keyword1" id="DRA_Explicit-draei_param"><span class="command">lemma</span></span> draei_param<span class="main">[</span><span class="operator">param</span><span class="main">,</span> <span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>draei<span class="main">,</span> draei<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">⟩</span> list_rel <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">L</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">S</span><span class="main">⟩</span> list_rel <span class="main">→</span>
      <span class="main">⟨</span><span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> list_rel <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> list_rel<span class="main">⟩</span> list_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> draei_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>alphabetei<span class="main">,</span> alphabetei<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> draei_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">L</span><span class="main">⟩</span> list_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>initialei<span class="main">,</span> initialei<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> draei_rel <span class="main">→</span> <span class="free">S</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>transitionei<span class="main">,</span> transitionei<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> draei_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">L</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">S</span><span class="main">⟩</span> list_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>conditionei<span class="main">,</span> conditionei<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> draei_rel <span class="main">→</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> list_rel <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> list_rel<span class="main">⟩</span> list_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> draei_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">draei_drae_rel</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="main">[</span><span class="operator">to_relAPP</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">draei_drae_rel</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">.</span>
      <span class="main">(</span>alphabetei <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> alphabete <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">⟩</span> list_set_rel <span class="main">∧</span>
      <span class="main">(</span>initialei <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> initiale <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">∧</span>
      <span class="main">(</span>transitionei <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> transitione <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">⟩</span> list_set_rel <span class="main">∧</span>
      <span class="main">(</span>conditionei <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> conditione <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">⟩</span> list_set_rel <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">⟩</span> list_set_rel<span class="main">⟩</span> list_rel<span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rel_intf</span><span class="main">]</span> <span class="main">=</span> REL_INTFI<span class="main">[</span><span class="operator">of</span> <span class="quoted">draei_drae_rel</span> <span class="quoted">i_drae_scheme</span><span class="main">]</span>

  <span class="keyword1" id="DRA_Explicit-draei_drae_param"><span class="command">lemma</span></span> draei_drae_param<span class="main">[</span><span class="operator">param</span><span class="main">,</span> <span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>draei<span class="main">,</span> drae<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">⟩</span> list_set_rel <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">L</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">S</span><span class="main">⟩</span> list_set_rel <span class="main">→</span>
      <span class="main">⟨</span><span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> list_set_rel <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> list_set_rel<span class="main">⟩</span> list_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> draei_drae_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>alphabetei<span class="main">,</span> alphabete<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> draei_drae_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">L</span><span class="main">⟩</span> list_set_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>initialei<span class="main">,</span> initiale<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> draei_drae_rel <span class="main">→</span> <span class="free">S</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>transitionei<span class="main">,</span> transitione<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> draei_drae_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">L</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">S</span><span class="main">⟩</span> list_set_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>conditionei<span class="main">,</span> conditione<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> draei_drae_rel <span class="main">→</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> list_set_rel <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> list_set_rel<span class="main">⟩</span> list_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> draei_drae_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">draei_drae</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">draei_drae</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> drae <span class="main">(</span>set <span class="main">(</span>alphabetei <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>initialei <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>
      <span class="main">(</span>set <span class="main">(</span>transitionei <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>map_prod set set<span class="main">)</span> <span class="main">(</span>conditionei <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="DRA_Explicit-draei_drae_id_param"><span class="command">lemma</span></span> draei_drae_id_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>draei_drae<span class="main">,</span> id<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> draei_drae_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> drae_rel"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Ai</span> <span class="skolem">A</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Ai</span><span class="main">,</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> draei_drae_rel"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"draei_drae <span class="skolem">Ai</span> <span class="main">=</span> drae <span class="main">(</span>set <span class="main">(</span>alphabetei <span class="skolem">Ai</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>initialei <span class="skolem">Ai</span><span class="main">)</span>
      <span class="main">(</span>set <span class="main">(</span>transitionei <span class="skolem">Ai</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>map_prod set set<span class="main">)</span> <span class="main">(</span>conditionei <span class="skolem">Ai</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> draei_drae_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"id <span class="skolem">A</span> <span class="main">=</span> drae <span class="main">(</span>id <span class="main">(</span>alphabete <span class="skolem">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>initiale <span class="skolem">A</span><span class="main">)</span>
      <span class="main">(</span>id <span class="main">(</span>transitione <span class="skolem">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>map_prod id id<span class="main">)</span> <span class="main">(</span>conditione <span class="skolem">A</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>draei_drae <span class="skolem">Ai</span><span class="main">,</span> id <span class="skolem">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> drae_rel"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 2 3 <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">transitions</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">⋃</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">.</span> <span class="main">⋃</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">.</span> <span class="main">{</span><span class="bound">p</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">a</span> <span class="bound">p</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">succs</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> the_elem <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">``</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">``</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">}</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">wft</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> set <span class="main">⇒</span> <span class="tfree">'state</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'state</span> <span class="main">×</span> <span class="tfree">'label</span> <span class="main">×</span> <span class="tfree">'state</span><span class="main">)</span> set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">wft</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">.</span> <span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">.</span> is_singleton <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">``</span> <span class="main">{</span><span class="bound">p</span><span class="main">}</span><span class="main">)</span> <span class="main">``</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="DRA_Explicit-wft_param"><span class="command">lemma</span></span> wft_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bijective <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"bijective <span class="free">L</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>wft<span class="main">,</span> wft<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">⟩</span> set_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> set_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">L</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">S</span><span class="main">⟩</span> set_rel <span class="main">→</span> bool_rel"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> wft_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>

  <span class="keyword1" id="DRA_Explicit-wft_transitions"><span class="command">lemma</span></span> wft_transitions<span class="main">:</span> <span class="quoted"><span class="quoted">"wft <span class="free">L</span> <span class="free">S</span> <span class="main">(</span>transitions <span class="free">L</span> <span class="free">S</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> wft_def is_singleton_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">dra_drae</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">dra_drae</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> drae <span class="main">(</span>alphabet <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span>initial <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> 
    <span class="main">(</span>transitions <span class="main">(</span>alphabet <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span>nodes <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span>transition <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">P</span><span class="main">,</span> <span class="bound">Q</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>Set.filter <span class="bound">P</span> <span class="main">(</span>nodes <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">,</span> Set.filter <span class="bound">Q</span> <span class="main">(</span>nodes <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>condition <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">drae_dra</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">drae_dra</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> dra <span class="main">(</span>alphabete <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span>initiale <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>
    <span class="main">(</span>succs <span class="main">(</span>transitione <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">I</span><span class="main">,</span> <span class="bound">F</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="bound">I</span><span class="main">,</span> <span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="bound">F</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>conditione <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="DRA_Explicit-set_rel_Domain_Range"><span class="command">lemma</span></span> set_rel_Domain_Range<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Domain <span class="free">A</span><span class="main">,</span> Range <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> set_rel"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> set_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="DRA_Explicit-dra_drae_param"><span class="command">lemma</span></span> dra_drae_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>dra_drae<span class="main">,</span> dra_drae<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> dra_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> drae_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> dra_drae_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
  <span class="keyword1" id="DRA_Explicit-drae_dra_param"><span class="command">lemma</span></span> drae_dra_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bijective <span class="free">L</span>"</span></span> <span class="quoted"><span class="quoted">"bijective <span class="free">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wft <span class="main">(</span>Range <span class="free">L</span><span class="main">)</span> <span class="main">(</span>Range <span class="free">S</span><span class="main">)</span> <span class="main">(</span>transitione <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> drae_rel"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>drae_dra <span class="free">A</span><span class="main">,</span> drae_dra <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> dra_rel"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>wft <span class="main">(</span>Domain <span class="free">L</span><span class="main">)</span> <span class="main">(</span>Domain <span class="free">S</span><span class="main">)</span> <span class="main">(</span>transitione <span class="free">A</span><span class="main">)</span><span class="main">,</span> wft <span class="main">(</span>Range <span class="free">L</span><span class="main">)</span> <span class="main">(</span>Range <span class="free">S</span><span class="main">)</span> <span class="main">(</span>transitione <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> bool_rel"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span> 2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"wft <span class="main">(</span>Domain <span class="free">L</span><span class="main">)</span> <span class="main">(</span>Domain <span class="free">S</span><span class="main">)</span> <span class="main">(</span>transitione <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1 - 3<span class="main">)</span> 2 assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> bijective_alt<span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> drae_dra_def wft_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="DRA_Explicit-succs_transitions_param"><span class="command">lemma</span></span> succs_transitions_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>succs <span class="main">∘</span> transitions <span class="free">L</span> <span class="free">S</span><span class="main">,</span> id<span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>Id_on <span class="free">L</span> <span class="main">→</span> Id_on <span class="free">S</span> <span class="main">→</span> Id_on <span class="free">S</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span>Id_on <span class="free">L</span> <span class="main">→</span> Id_on <span class="free">S</span> <span class="main">→</span> Id_on <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="skolem">g</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="skolem">g</span><span class="main">)</span> <span class="main">∈</span> Id_on <span class="free">L</span> <span class="main">→</span> Id_on <span class="free">S</span> <span class="main">→</span> Id_on <span class="free">S</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>succs <span class="main">∘</span> transitions <span class="free">L</span> <span class="free">S</span><span class="main">)</span> <span class="skolem">f</span><span class="main">,</span> id <span class="skolem">g</span><span class="main">)</span> <span class="main">∈</span> Id_on <span class="free">L</span> <span class="main">→</span> Id_on <span class="free">S</span> <span class="main">→</span> Id_on <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">p</span>
      <span class="keyword3"><span class="command">assume</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="free">L</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>succs <span class="main">∘</span> transitions <span class="free">L</span> <span class="free">S</span><span class="main">)</span> <span class="skolem">f</span> <span class="skolem">a</span> <span class="skolem">p</span> <span class="main">=</span> succs <span class="main">(</span>transitions <span class="free">L</span> <span class="free">S</span> <span class="skolem">f</span><span class="main">)</span> <span class="skolem">a</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>transitions <span class="free">L</span> <span class="free">S</span> <span class="skolem">f</span> <span class="main">``</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span><span class="main">)</span> <span class="main">``</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">f</span> <span class="skolem">a</span> <span class="skolem">p</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the_elem <span class="main">…</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">a</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">…</span><span class="main">,</span> <span class="skolem">g</span> <span class="skolem">a</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∈</span> Id_on <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>succs <span class="main">∘</span> transitions <span class="free">L</span> <span class="free">S</span><span class="main">)</span> <span class="skolem">f</span> <span class="skolem">a</span> <span class="skolem">p</span> <span class="main">=</span> id <span class="skolem">g</span> <span class="skolem">a</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"id <span class="skolem">g</span> <span class="skolem">a</span> <span class="skolem">p</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">[</span><span class="operator">param_fo</span><span class="main">]</span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="DRA_Explicit-drae_dra_dra_drae_param"><span class="command">lemma</span></span> drae_dra_dra_drae_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>drae_dra <span class="main">∘</span> dra_drae<span class="main">)</span> <span class="free">A</span><span class="main">,</span> id <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id_on <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span><span class="main">,</span> Id_on <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span><span class="main">⟩</span> dra_rel"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">P</span><span class="main">,</span> <span class="bound">Q</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> Set.filter <span class="bound">P</span> <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span><span class="main">,</span> <span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> Set.filter <span class="bound">Q</span> <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> id<span class="main">)</span> <span class="main">∈</span>
      pred_rel <span class="main">(</span>Id_on <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> pred_rel <span class="main">(</span>Id_on <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">→</span> rabin_rel <span class="main">(</span>Id_on <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> fun_rel_def Id_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>drae_dra <span class="main">∘</span> dra_drae<span class="main">)</span> <span class="free">A</span> <span class="main">=</span> dra <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span> <span class="main">(</span>initial <span class="free">A</span><span class="main">)</span>
      <span class="main">(</span><span class="main">(</span>succs <span class="main">∘</span> transitions <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span> <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>transition <span class="free">A</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">P</span><span class="main">,</span> <span class="bound">Q</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> Set.filter <span class="bound">P</span> <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span><span class="main">,</span> <span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> Set.filter <span class="bound">Q</span> <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>condition <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> drae_dra_def dra_drae_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">…</span><span class="main">,</span> dra <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span> <span class="main">(</span>initial <span class="free">A</span><span class="main">)</span> <span class="main">(</span>id <span class="main">(</span>transition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map id <span class="main">(</span>condition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span>
      <span class="main">⟨</span>Id_on <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span><span class="main">,</span> Id_on <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span><span class="main">⟩</span> dra_rel"</span></span> <span class="keyword1"><span class="command">using</span></span> dra_rel_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dra <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span> <span class="main">(</span>initial <span class="free">A</span><span class="main">)</span> <span class="main">(</span>id <span class="main">(</span>transition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map id <span class="main">(</span>condition <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> id <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">draei_dra_rel</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="main">[</span><span class="operator">to_relAPP</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">draei_dra_rel</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">Ae</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>drae_dra <span class="main">(</span>draei_drae <span class="bound">Ae</span><span class="main">)</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">⟩</span> dra_rel<span class="main">}</span>"</span></span>
  <span class="keyword1" id="DRA_Explicit-draei_dra_id"><span class="command">lemma</span></span> draei_dra_id<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>drae_dra <span class="main">∘</span> draei_drae<span class="main">,</span> id<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> draei_dra_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> dra_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> draei_dra_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(*
  schematic_goal drae_dra_impl: "(?f, drae_dra) ∈ ⟨Id, Id⟩ draei_drae_rel → ⟨Id, Id⟩ drai_dra_rel"
    unfolding drae_dra_def by (autoref (trace))
  concrete_definition drae_dra_impl uses drae_dra_impl
*)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="DRA_Translate">
<div class="head">
<h1>Theory DRA_Translate</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Explore and Enumerate Nodes of Deterministic Rabin Automata›</span></span>

<span class="keyword1"><span class="command">theory</span></span> DRA_Translate
<span class="keyword2"><span class="keyword">imports</span></span> <a href="DRA_Explicit.html">DRA_Explicit</a>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Syntax›</span></span>

  <span class="comment1">(* TODO: this syntax has unnecessarily high inner binding strength, requiring extra parentheses
    the regular let syntax correctly uses inner binding strength 0: ("(2_ =/ _)" 10) *)</span>
  <span class="keyword1"><span class="command">no_syntax</span></span> <span class="quoted">"_do_let"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>pttrn<span class="main">,</span> <span class="tfree">'a</span><span class="main">]</span> <span class="main">⇒</span> do_bind"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(2</span><span class="keyword1">let</span> _ <span class="keyword1">=</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>1000<span class="main">,</span> 13<span class="main">]</span> 13<span class="main">)</span>
  <span class="keyword1"><span class="command">syntax</span></span> <span class="quoted">"_do_let"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>pttrn<span class="main">,</span> <span class="tfree">'a</span><span class="main">]</span> <span class="main">⇒</span> do_bind"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(2</span><span class="keyword1">let</span> _ <span class="keyword1">=</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> 13<span class="main">)</span>

  <span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Image on Explicit Automata›</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">drae_image</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">drae_image</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> drae <span class="main">(</span>alphabete <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>initiale <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">p</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> transitione <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>map_prod <span class="main">(</span>image <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">(</span>image <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>conditione <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="DRA_Translate-drae_image_param"><span class="command">lemma</span></span> drae_image_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>drae_image<span class="main">,</span> drae_image<span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">S</span> <span class="main">→</span> <span class="free">T</span><span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> drae_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">T</span><span class="main">⟩</span> drae_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> drae_image_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>

  <span class="keyword1" id="DRA_Translate-drae_image_id"><span class="command">lemma</span></span> drae_image_id<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"drae_image id <span class="main">=</span> id"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> drae_image_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="DRA_Translate-drae_image_dra_drae"><span class="command">lemma</span></span> drae_image_dra_drae<span class="main">:</span> <span class="quoted"><span class="quoted">"drae_image <span class="free">f</span> <span class="main">(</span>dra_drae <span class="free">A</span><span class="main">)</span> <span class="main">=</span> drae
    <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>initial <span class="free">A</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span><span class="main">⋃</span> <span class="bound">p</span> <span class="main">∈</span> nodes <span class="free">A</span><span class="main">.</span> <span class="main">⋃</span> <span class="bound">a</span> <span class="main">∈</span> alphabet <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="bound">p</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span> <span class="main">×</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span>transition <span class="free">A</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">}</span><span class="main">)</span>
    <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">P</span><span class="main">,</span> <span class="bound">Q</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> nodes <span class="free">A</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">p</span><span class="main">}</span><span class="main">,</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> nodes <span class="free">A</span><span class="main">.</span> <span class="bound">Q</span> <span class="bound">p</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>condition <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> dra_drae_def drae_image_def drae.simps Set.filter_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Exploration and Translation›</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">trans_spec</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">trans_spec</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">⋃</span> <span class="bound">p</span> <span class="main">∈</span> nodes <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> <span class="main">⋃</span> <span class="bound">a</span> <span class="main">∈</span> alphabet <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">`</span> <span class="main">{</span><span class="bound">p</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span> <span class="main">×</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">`</span> <span class="main">{</span>transition <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">a</span> <span class="bound">p</span><span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">trans_algo</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">trans_algo</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span>
      FOREACH <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span> <span class="bound">T</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
        ASSERT <span class="main">(</span><span class="bound">p</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span><span class="main">;</span>
        FOREACH <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="bound">T</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
          ASSERT <span class="main">(</span><span class="bound">a</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">)</span><span class="main">;</span>
          <span class="keyword1">let</span> <span class="bound">q</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="bound">a</span> <span class="bound">p</span><span class="main">;</span>
          ASSERT <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">p</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">q</span><span class="main">)</span> <span class="main">∉</span> <span class="bound">T</span><span class="main">)</span><span class="main">;</span>
          RETURN <span class="main">(</span>insert <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">p</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">q</span><span class="main">)</span> <span class="bound">T</span><span class="main">)</span> <span class="main">}</span>
        <span class="main">)</span> <span class="bound">T</span> <span class="main">}</span>
      <span class="main">)</span> <span class="main">{}</span>"</span></span>

  <span class="keyword1" id="DRA_Translate-trans_algo_refine"><span class="command">lemma</span></span> trans_algo_refine<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">=</span> nodes <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">=</span> alphabet <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">=</span> transition <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>trans_algo <span class="free">N</span> <span class="free">L</span> <span class="free">S</span> <span class="free">f</span><span class="main">,</span> SPEC <span class="main">(</span>HOL.eq <span class="main">(</span>trans_spec <span class="free">A</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id<span class="main">⟩</span> nres_rel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> trans_algo_def trans_spec_def assms<span class="main">(</span>4-6<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">refine_vcg</span> FOREACH_rule_insert_eq<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span> <span class="bound">p</span> <span class="main">∈</span> nodes <span class="free">A</span><span class="main">.</span> <span class="main">⋃</span> <span class="bound">a</span> <span class="main">∈</span> alphabet <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="bound">p</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span> <span class="main">×</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span>transition <span class="free">A</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="main">⋃</span> <span class="bound">p</span> <span class="main">∈</span> nodes <span class="free">A</span><span class="main">.</span> <span class="main">⋃</span> <span class="bound">a</span> <span class="main">∈</span> alphabet <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="bound">p</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span> <span class="main">×</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span>transition <span class="free">A</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">{}</span><span class="main">.</span> <span class="main">⋃</span> <span class="bound">a</span> <span class="main">∈</span> alphabet <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="bound">p</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span> <span class="main">×</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span>transition <span class="free">A</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">T</span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">⊆</span> nodes <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> nodes <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">T</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span> <span class="bound">a</span> <span class="main">∈</span> <span class="main">{}</span><span class="main">.</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span> <span class="main">×</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span>transition <span class="free">A</span> <span class="bound">a</span> <span class="skolem">x</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span>
      <span class="main">(</span><span class="main">⋃</span> <span class="bound">p</span> <span class="main">∈</span> <span class="skolem">T</span><span class="main">.</span> <span class="main">⋃</span> <span class="bound">a</span> <span class="main">∈</span> alphabet <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="bound">p</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span> <span class="main">×</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span>transition <span class="free">A</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="main">⋃</span> <span class="bound">p</span> <span class="main">∈</span> <span class="skolem">T</span><span class="main">.</span> <span class="main">⋃</span> <span class="bound">a</span> <span class="main">∈</span> alphabet <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="bound">p</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span> <span class="main">×</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span>transition <span class="free">A</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span> <span class="bound">a</span> <span class="main">∈</span> alphabet <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span> <span class="main">×</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span>transition <span class="free">A</span> <span class="bound">a</span> <span class="skolem">x</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span>
      <span class="main">(</span><span class="main">⋃</span> <span class="bound">p</span> <span class="main">∈</span> <span class="skolem">T</span><span class="main">.</span> <span class="main">⋃</span> <span class="bound">a</span> <span class="main">∈</span> alphabet <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="bound">p</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span> <span class="main">×</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span>transition <span class="free">A</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="main">⋃</span> <span class="bound">p</span> <span class="main">∈</span> insert <span class="skolem">x</span> <span class="skolem">T</span><span class="main">.</span> <span class="main">⋃</span> <span class="bound">a</span> <span class="main">∈</span> alphabet <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="bound">p</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span> <span class="main">×</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span>transition <span class="free">A</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Ta</span> <span class="skolem">xa</span>
    <span class="keyword3"><span class="command">assume</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Ta</span> <span class="main">⊆</span> alphabet <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">∈</span> alphabet <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">∉</span> <span class="skolem">Ta</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">xa</span><span class="main">,</span> <span class="free">f</span> <span class="main">(</span>transition <span class="free">A</span> <span class="skolem">xa</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">a</span> <span class="main">∈</span> <span class="skolem">Ta</span><span class="main">.</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span> <span class="main">×</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span>transition <span class="free">A</span> <span class="bound">a</span> <span class="skolem">x</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span>
      <span class="main">(</span><span class="main">⋃</span> <span class="bound">p</span> <span class="main">∈</span> <span class="skolem">T</span><span class="main">.</span> <span class="main">⋃</span> <span class="bound">a</span> <span class="main">∈</span> alphabet <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="bound">p</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span> <span class="main">×</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span>transition <span class="free">A</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 2<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> inj_onD<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span> <span class="bound">a</span> <span class="main">∈</span> insert <span class="skolem">xa</span> <span class="skolem">Ta</span><span class="main">.</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span> <span class="main">×</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span>transition <span class="free">A</span> <span class="bound">a</span> <span class="skolem">x</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span>
      <span class="main">(</span><span class="main">⋃</span> <span class="bound">p</span> <span class="main">∈</span> <span class="skolem">T</span><span class="main">.</span> <span class="main">⋃</span> <span class="bound">a</span> <span class="main">∈</span> alphabet <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="bound">p</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span> <span class="main">×</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span>transition <span class="free">A</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
      insert <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">xa</span><span class="main">,</span> <span class="free">f</span> <span class="main">(</span>transition <span class="free">A</span> <span class="skolem">xa</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">⋃</span> <span class="bound">a</span> <span class="main">∈</span> <span class="skolem">Ta</span><span class="main">.</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span> <span class="main">×</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span>transition <span class="free">A</span> <span class="bound">a</span> <span class="skolem">x</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span>
      <span class="main">(</span><span class="main">⋃</span> <span class="bound">p</span> <span class="main">∈</span> <span class="skolem">T</span><span class="main">.</span> <span class="main">⋃</span> <span class="bound">a</span> <span class="main">∈</span> alphabet <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="bound">p</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span> <span class="main">×</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span>transition <span class="free">A</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">to_draei</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'state</span><span class="main">,</span> <span class="tfree">'label</span><span class="main">)</span> dra <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'state</span><span class="main">,</span> <span class="tfree">'label</span><span class="main">)</span> dra"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">to_draei</span> <span class="main">≡</span> id"</span></span>

  <span class="comment1">(* TODO: make separate implementations for "dra_drae" and "op_set_enumerate ⤜ drae_image" *)</span>
  <span class="keyword1"><span class="command">schematic_goal</span></span> to_draei_impl<span class="main">:</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'statei</span> <span class="main">×</span> <span class="tfree">'state</span><span class="main">)</span> set"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_ga_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_bounded_hashcode <span class="free">S</span> <span class="free">seq</span> <span class="free">bhc</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_ga_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_valid_def_hm_size <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'statei</span><span class="main">)</span> <span class="free">hms</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">seq</span><span class="main">,</span> HOL.eq<span class="main">)</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> bool_rel"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ai</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> drai_dra_rel"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?f</span> <span class="main">::</span> <span class="tvar">?'a</span><span class="main">,</span> <span class="keyword1">do</span> <span class="main">{</span>
        <span class="keyword1">let</span> <span class="bound">N</span> <span class="main">=</span> nodes <span class="free">A</span><span class="main">;</span>
        <span class="bound">f</span> <span class="main">←</span> op_set_enumerate <span class="bound">N</span><span class="main">;</span>
        ASSERT <span class="main">(</span>dom <span class="bound">f</span> <span class="main">=</span> <span class="bound">N</span><span class="main">)</span><span class="main">;</span>
        ASSERT <span class="main">(</span><span class="bound">f</span> <span class="main">(</span>initial <span class="free">A</span><span class="main">)</span> <span class="main">≠</span> None<span class="main">)</span><span class="main">;</span>
        ASSERT <span class="main">(</span><span class="main">∀</span> <span class="bound">a</span> <span class="main">∈</span> alphabet <span class="free">A</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> dom <span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">(</span>transition <span class="free">A</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">)</span> <span class="main">≠</span> None<span class="main">)</span><span class="main">;</span>
        <span class="bound">T</span> <span class="main">←</span> trans_algo <span class="bound">N</span> <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span> <span class="main">(</span>transition <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> the <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
        RETURN <span class="main">(</span>drae <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> the <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>initial <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="bound">T</span>
          <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">P</span><span class="main">,</span> <span class="bound">Q</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> the <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> <span class="bound">N</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">p</span><span class="main">}</span><span class="main">,</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> the <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> <span class="bound">N</span><span class="main">.</span> <span class="bound">Q</span> <span class="bound">p</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>condition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">}</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> trans_algo_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">autoref_monadic</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">plain</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">to_draei_impl</span> <span class="keyword2"><span class="keyword">uses</span></span> to_draei_impl
  <span class="keyword1" id="DRA_Translate-to_draei_impl_refine''"><span class="command">lemma</span></span> to_draei_impl_refine''<span class="main">:</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'statei</span> <span class="main">×</span> <span class="tfree">'state</span><span class="main">)</span> set"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_bounded_hashcode <span class="free">S</span> <span class="free">seq</span> <span class="free">bhc</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_valid_def_hm_size <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'statei</span><span class="main">)</span> <span class="free">hms</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">seq</span><span class="main">,</span> HOL.eq<span class="main">)</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> bool_rel"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ai</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> drai_dra_rel"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>RETURN <span class="main">(</span>to_draei_impl <span class="free">seq</span> <span class="free">bhc</span> <span class="free">hms</span> <span class="free">Ai</span><span class="main">)</span><span class="main">,</span> <span class="keyword1">do</span> <span class="main">{</span>
        <span class="bound">f</span> <span class="main">←</span> op_set_enumerate <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span><span class="main">;</span>
        RETURN <span class="main">(</span>drae_image <span class="main">(</span>the <span class="main">∘</span> <span class="bound">f</span><span class="main">)</span> <span class="main">(</span>dra_drae <span class="free">A</span><span class="main">)</span><span class="main">)</span>
      <span class="main">}</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">L</span><span class="main">,</span> nat_rel<span class="main">⟩</span> draei_drae_rel<span class="main">⟩</span> nres_rel"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> drai_dra_param<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">param_fo</span><span class="main">,</span> <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span> list_set_rel_finite
      <span class="keyword1"><span class="command">unfolding</span></span> finite_set_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> to_draei_impl.refine<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">do</span> <span class="main">{</span>
        <span class="keyword1">let</span> <span class="bound">N</span> <span class="main">=</span> nodes <span class="free">A</span><span class="main">;</span>
        <span class="bound">f</span> <span class="main">←</span> op_set_enumerate <span class="bound">N</span><span class="main">;</span>
        ASSERT <span class="main">(</span>dom <span class="bound">f</span> <span class="main">=</span> <span class="bound">N</span><span class="main">)</span><span class="main">;</span>
        ASSERT <span class="main">(</span><span class="bound">f</span> <span class="main">(</span>initial <span class="free">A</span><span class="main">)</span> <span class="main">≠</span> None<span class="main">)</span><span class="main">;</span>
        ASSERT <span class="main">(</span><span class="main">∀</span> <span class="bound">a</span> <span class="main">∈</span> alphabet <span class="free">A</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> dom <span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">(</span>transition <span class="free">A</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">)</span> <span class="main">≠</span> None<span class="main">)</span><span class="main">;</span>
        <span class="bound">T</span> <span class="main">←</span> trans_algo <span class="bound">N</span> <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span> <span class="main">(</span>transition <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> the <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
        RETURN <span class="main">(</span>drae <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> the <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>initial <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="bound">T</span>
          <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">P</span><span class="main">,</span> <span class="bound">Q</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> the <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> <span class="bound">N</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">p</span><span class="main">}</span><span class="main">,</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> the <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> <span class="bound">N</span><span class="main">.</span> <span class="bound">Q</span> <span class="bound">p</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>condition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">}</span><span class="main">,</span> <span class="keyword1">do</span> <span class="main">{</span>
        <span class="bound">f</span> <span class="main">←</span> op_set_enumerate <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span><span class="main">;</span>
        <span class="bound">T</span> <span class="main">←</span> SPEC <span class="main">(</span>HOL.eq <span class="main">(</span>trans_spec <span class="free">A</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> the <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
        RETURN <span class="main">(</span>drae <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> the <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>initial <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="bound">T</span>
          <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">P</span><span class="main">,</span> <span class="bound">Q</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> the <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> nodes <span class="free">A</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">p</span><span class="main">}</span><span class="main">,</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> the <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> nodes <span class="free">A</span><span class="main">.</span> <span class="bound">Q</span> <span class="bound">p</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>condition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">}</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id<span class="main">⟩</span> nres_rel"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Let_def comp_apply op_set_enumerate_def <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> 1
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">refine_vcg</span> vcg0<span class="main"><span class="main">[</span></span><span class="operator">OF</span> trans_algo_refine<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> inj_on_map_the<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> comp_apply<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">do</span> <span class="main">{</span>
        <span class="bound">f</span> <span class="main">←</span> op_set_enumerate <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span><span class="main">;</span>
        <span class="bound">T</span> <span class="main">←</span> SPEC <span class="main">(</span>HOL.eq <span class="main">(</span>trans_spec <span class="free">A</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> the <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
        RETURN <span class="main">(</span>drae <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> the <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>initial <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="bound">T</span>
          <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">P</span><span class="main">,</span> <span class="bound">Q</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> the <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> nodes <span class="free">A</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">p</span><span class="main">}</span><span class="main">,</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> the <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> nodes <span class="free">A</span><span class="main">.</span> <span class="bound">Q</span> <span class="bound">p</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>condition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">}</span><span class="main">,</span>  <span class="keyword1">do</span> <span class="main">{</span>
        <span class="bound">f</span> <span class="main">←</span> op_set_enumerate <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span><span class="main">;</span>
        RETURN <span class="main">(</span>drae_image <span class="main">(</span>the <span class="main">∘</span> <span class="bound">f</span><span class="main">)</span> <span class="main">(</span>dra_drae <span class="free">A</span><span class="main">)</span><span class="main">)</span>
      <span class="main">}</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id<span class="main">⟩</span> nres_rel"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> trans_spec_def drae_image_dra_drae <span class="keyword1"><span class="command">by</span></span> <span class="operator">refine_vcg</span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> nres_rel_comp <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="comment1">(* TODO: generalize L *)</span>
  <span class="keyword1"><span class="command">context</span></span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Ai</span> <span class="free">A</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">seq</span> <span class="free">bhc</span> <span class="free">hms</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'statei</span> <span class="main">×</span> <span class="tfree">'state</span><span class="main">)</span> set"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"is_bounded_hashcode <span class="free">S</span> <span class="free">seq</span> <span class="free">bhc</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"is_valid_def_hm_size <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'statei</span><span class="main">)</span> <span class="free">hms</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">seq</span><span class="main">,</span> HOL.eq<span class="main">)</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> bool_rel"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ai</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id<span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> drai_dra_rel"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1"><span class="command">definition</span></span> <span class="entity">f'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">f'</span> <span class="main">≡</span> <span class="keyword1">SOME</span> <span class="bound">f'</span><span class="main">.</span>
      <span class="main">(</span>to_draei_impl <span class="free">seq</span> <span class="free">bhc</span> <span class="free">hms</span> <span class="free">Ai</span><span class="main">,</span> drae_image <span class="main">(</span>the <span class="main">∘</span> <span class="bound">f'</span><span class="main">)</span> <span class="main">(</span>dra_drae <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id<span class="main">,</span> nat_rel<span class="main">⟩</span> draei_drae_rel <span class="main">∧</span>
      dom <span class="bound">f'</span> <span class="main">=</span> nodes <span class="free">A</span> <span class="main">∧</span> inj_on <span class="bound">f'</span> <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span>"</span></span>

    <span class="keyword1" id="DRA_Translate-1"><span class="command">lemma</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">f'</span><span class="main">.</span> <span class="main">(</span>to_draei_impl <span class="free">seq</span> <span class="free">bhc</span> <span class="free">hms</span> <span class="free">Ai</span><span class="main">,</span> drae_image <span class="main">(</span>the <span class="main">∘</span> <span class="bound">f'</span><span class="main">)</span> <span class="main">(</span>dra_drae <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span>
      <span class="main">⟨</span>Id<span class="main">,</span> nat_rel<span class="main">⟩</span> draei_drae_rel <span class="main">∧</span> dom <span class="bound">f'</span> <span class="main">=</span> nodes <span class="free">A</span> <span class="main">∧</span> inj_on <span class="bound">f'</span> <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> to_draei_impl_refine''<span class="main">[</span>
        <span class="operator">OF</span> a b c d e<span class="main">,</span>
        <span class="operator">unfolded</span> op_set_enumerate_def bind_RES_RETURN_eq<span class="main">,</span>
        <span class="operator">THEN</span> nres_relD<span class="main">,</span>
        <span class="operator">THEN</span> RETURN_ref_SPECD<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

    <span class="keyword1" id="DRA_Translate-f'_refine"><span class="command">lemma</span></span> f'_refine<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>to_draei_impl <span class="free">seq</span> <span class="free">bhc</span> <span class="free">hms</span> <span class="free">Ai</span><span class="main">,</span> drae_image <span class="main">(</span>the <span class="main">∘</span> f'<span class="main">)</span> <span class="main">(</span>dra_drae <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span>
      <span class="main">⟨</span>Id<span class="main">,</span> nat_rel<span class="main">⟩</span> draei_drae_rel"</span></span> <span class="keyword1"><span class="command">using</span></span> someI_ex<span class="main">[</span><span class="operator">OF</span> 1<span class="main">,</span> <span class="operator">folded</span> f'_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1" id="DRA_Translate-f'_dom"><span class="command">lemma</span></span> f'_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"dom f' <span class="main">=</span> nodes <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> someI_ex<span class="main">[</span><span class="operator">OF</span> 1<span class="main">,</span> <span class="operator">folded</span> f'_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1" id="DRA_Translate-f'_inj"><span class="command">lemma</span></span> f'_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on f' <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> someI_ex<span class="main">[</span><span class="operator">OF</span> 1<span class="main">,</span> <span class="operator">folded</span> f'_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">definition</span></span> <span class="entity">f</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≡</span> the <span class="main">∘</span> f'"</span></span>
    <span class="keyword1"><span class="command">definition</span></span> <span class="entity">g</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">=</span> inv_into <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span> f"</span></span>
    <span class="keyword1" id="DRA_Translate-inj_f"><span class="command">lemma</span></span> inj_f<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on f <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> f'_inj f'_dom <span class="keyword1"><span class="command">unfolding</span></span> f_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_map_the<span class="main">)</span>
    <span class="keyword1" id="DRA_Translate-inj_g"><span class="command">lemma</span></span> inj_g<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on g <span class="main">(</span>f <span class="main">`</span> nodes <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> g_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_inv_into<span class="main">)</span>

    <span class="keyword1"><span class="command">definition</span></span> <span class="entity">rel</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">rel</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span>f <span class="bound">p</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span> <span class="main">|</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> nodes <span class="free">A</span><span class="main">}</span>"</span></span>
    <span class="keyword1" id="DRA_Translate-rel_alt_def"><span class="command">lemma</span></span> rel_alt_def<span class="main">:</span> <span class="quoted"><span class="quoted">"rel <span class="main">=</span> <span class="main">(</span>br f <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> nodes <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">¯</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> rel_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_br_conv<span class="main">)</span>
    <span class="keyword1" id="DRA_Translate-rel_inv_def"><span class="command">lemma</span></span> rel_inv_def<span class="main">:</span> <span class="quoted"><span class="quoted">"rel <span class="main">=</span> br g <span class="main">(</span><span class="main">λ</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">∈</span> f <span class="main">`</span> nodes <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> rel_alt_def g_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_br_conv<span class="main">)</span>
    <span class="keyword1" id="DRA_Translate-rel_domain"><span class="command">lemma</span></span> rel_domain<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Domain rel <span class="main">=</span> f <span class="main">`</span> nodes <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1" id="DRA_Translate-rel_range"><span class="command">lemma</span></span> rel_range<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Range rel <span class="main">=</span> nodes <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bijective rel"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> rel_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bijective_alt<span class="main">)</span>
    <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Id_on <span class="main">(</span>f <span class="main">`</span> nodes <span class="free">A</span><span class="main">)</span> <span class="keyword1">O</span> rel <span class="main">=</span> rel"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rel <span class="keyword1">O</span> Id_on <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span> <span class="main">=</span> rel"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>f<span class="main">,</span> f<span class="main">)</span> <span class="main">∈</span> Id_on <span class="main">(</span>Range rel<span class="main">)</span> <span class="main">→</span> Id_on <span class="main">(</span>Domain rel<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> rel_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>g<span class="main">,</span> g<span class="main">)</span> <span class="main">∈</span> Id_on <span class="main">(</span>Domain rel<span class="main">)</span> <span class="main">→</span> Id_on <span class="main">(</span>Range rel<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> rel_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>id<span class="main">,</span> f<span class="main">)</span> <span class="main">∈</span> rel <span class="main">→</span> Id_on <span class="main">(</span>Domain rel<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> rel_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_br_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>f<span class="main">,</span> id<span class="main">)</span> <span class="main">∈</span> Id_on <span class="main">(</span>Range rel<span class="main">)</span> <span class="main">→</span> rel"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> rel_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_br_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>id<span class="main">,</span> g<span class="main">)</span> <span class="main">∈</span> Id_on <span class="main">(</span>Domain rel<span class="main">)</span> <span class="main">→</span> rel"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> rel_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_br_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>g<span class="main">,</span> id<span class="main">)</span> <span class="main">∈</span> rel <span class="main">→</span> Id_on <span class="main">(</span>Range rel<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> rel_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_br_conv<span class="main">)</span>

    <span class="keyword1" id="DRA_Translate-to_draei_impl_refine'"><span class="command">lemma</span></span> to_draei_impl_refine'<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span>to_draei_impl <span class="free">seq</span> <span class="free">bhc</span> <span class="free">hms</span> <span class="free">Ai</span><span class="main">,</span> to_draei <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id_on <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span><span class="main">,</span> rel<span class="main">⟩</span> draei_dra_rel"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>draei_drae <span class="main">(</span>to_draei_impl <span class="free">seq</span> <span class="free">bhc</span> <span class="free">hms</span> <span class="free">Ai</span><span class="main">)</span><span class="main">,</span> id <span class="main">(</span>drae_image f <span class="main">(</span>dra_drae <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span>
        <span class="main">⟨</span>Id<span class="main">,</span> nat_rel<span class="main">⟩</span> drae_rel"</span></span> <span class="keyword1"><span class="command">using</span></span> f'_refine<span class="main">[</span><span class="operator">folded</span> f_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>draei_drae <span class="main">(</span>to_draei_impl <span class="free">seq</span> <span class="free">bhc</span> <span class="free">hms</span> <span class="free">Ai</span><span class="main">)</span><span class="main">,</span> id <span class="main">(</span>drae_image f <span class="main">(</span>dra_drae <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span>
        <span class="main">⟨</span>Id_on <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span><span class="main">,</span> Id_on <span class="main">(</span>f <span class="main">`</span> nodes <span class="free">A</span><span class="main">)</span><span class="main">⟩</span> drae_rel"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> drae_rel_def dra_drae_def drae_image_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"wft <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span> <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span> <span class="main">(</span>transitione <span class="main">(</span>dra_drae <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> wft_transitions <span class="keyword1"><span class="command">unfolding</span></span> dra_drae_def drae.sel <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>wft <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span> <span class="main">(</span>f <span class="main">`</span> nodes <span class="free">A</span><span class="main">)</span> <span class="main">(</span>transitione <span class="main">(</span>drae_image f <span class="main">(</span>dra_drae <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
        wft <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span> <span class="main">(</span>id <span class="main">`</span> nodes <span class="free">A</span><span class="main">)</span> <span class="main">(</span>transitione <span class="main">(</span>drae_image id <span class="main">(</span>dra_drae <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> bool_rel"</span></span>
        <span class="keyword1"><span class="command">using</span></span> dra_rel_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"wft <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span> <span class="main">(</span>f <span class="main">`</span> nodes <span class="free">A</span><span class="main">)</span> <span class="main">(</span>transitione <span class="main">(</span>drae_image f <span class="main">(</span>dra_drae <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>drae_dra <span class="main">(</span>draei_drae <span class="main">(</span>to_draei_impl <span class="free">seq</span> <span class="free">bhc</span> <span class="free">hms</span> <span class="free">Ai</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> drae_dra <span class="main">(</span>id <span class="main">(</span>drae_image f <span class="main">(</span>dra_drae <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span>
        <span class="main">⟨</span>Id_on <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span><span class="main">,</span> Id_on <span class="main">(</span>f <span class="main">`</span> nodes <span class="free">A</span><span class="main">)</span><span class="main">⟩</span> dra_rel"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>drae_dra <span class="main">(</span>id <span class="main">(</span>drae_image f <span class="main">(</span>dra_drae <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> drae_dra <span class="main">(</span>id <span class="main">(</span>drae_image id <span class="main">(</span>dra_drae <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span>
        <span class="main">⟨</span>Id_on <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span><span class="main">,</span> rel<span class="main">⟩</span> dra_rel"</span></span> <span class="keyword1"><span class="command">using</span></span> dra_rel_eq 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"drae_dra <span class="main">(</span>id <span class="main">(</span>drae_image id <span class="main">(</span>dra_drae <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>drae_dra <span class="main">∘</span> dra_drae<span class="main">)</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">…</span><span class="main">,</span> id <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id_on <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span><span class="main">,</span> Id_on <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span><span class="main">⟩</span> dra_rel"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"id <span class="free">A</span> <span class="main">=</span> to_draei <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> to_draei_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> draei_dra_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1"><span class="command">interpretation</span></span> autoref_syn <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>

    <span class="keyword1" id="DRA_Translate-to_draei_impl_refine"><span class="command">lemma</span></span> to_draei_impl_refine<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'statei</span> <span class="main">×</span> <span class="tfree">'state</span><span class="main">)</span> set"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SIDE_PRECOND <span class="main">(</span>finite <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SIDE_GEN_ALGO <span class="main">(</span>is_bounded_hashcode <span class="free">S</span> <span class="free">seq</span> <span class="free">bhc</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SIDE_GEN_ALGO <span class="main">(</span>is_valid_def_hm_size <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'statei</span><span class="main">)</span> <span class="free">hms</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"GEN_OP <span class="free">seq</span> HOL.eq <span class="main">(</span><span class="free">S</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> bool_rel<span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ai</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id<span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> drai_dra_rel"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>to_draei_impl <span class="free">seq</span> <span class="free">bhc</span> <span class="free">hms</span> <span class="free">Ai</span><span class="main">,</span>
        <span class="main">(</span><span class="keyword1">OP</span> to_draei <span class="main">:::</span> <span class="main">⟨</span>Id<span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> drai_dra_rel <span class="main">→</span>
        <span class="main">⟨</span>Id_on <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span><span class="main">,</span> rel <span class="free">Ai</span> <span class="free">A</span> <span class="free">seq</span> <span class="free">bhc</span> <span class="free">hms</span><span class="main">⟩</span> draei_dra_rel<span class="main">)</span> <span class="main">$</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span>
        <span class="main">⟨</span>Id_on <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span><span class="main">,</span> rel <span class="free">Ai</span> <span class="free">A</span> <span class="free">seq</span> <span class="free">bhc</span> <span class="free">hms</span><span class="main">⟩</span> draei_dra_rel"</span></span>
      <span class="keyword1"><span class="command">using</span></span> to_draei_impl_refine' assms <span class="keyword1"><span class="command">unfolding</span></span> <span class="dynamic"><span class="dynamic">autoref_tag_defs</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>

  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="NBA">
<div class="head">
<h1>Theory NBA</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Nondeterministic Büchi Automata›</span></span>

<span class="keyword1"><span class="command">theory</span></span> NBA
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Nondeterministic.html">../Nondeterministic</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> nba <span class="main">=</span> nba
    <span class="main">(</span><span class="free"><span class="entity">alphabet</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> set"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">initial</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> set"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">transition</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> set"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">accepting</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> pred"</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">global_interpretation</span></span> nba<span class="main">:</span> automaton <span class="quoted">nba</span> <span class="quoted">alphabet</span> <span class="quoted">initial</span> <span class="quoted">transition</span> <span class="quoted">accepting</span>
    <span class="keyword2"><span class="keyword">defines</span></span> path <span class="main">=</span> <span class="quoted">nba.path</span> <span class="keyword2"><span class="keyword">and</span></span> run <span class="main">=</span> <span class="quoted">nba.run</span> <span class="keyword2"><span class="keyword">and</span></span> reachable <span class="main">=</span> <span class="quoted">nba.reachable</span> <span class="keyword2"><span class="keyword">and</span></span> nodes <span class="main">=</span> <span class="quoted">nba.nodes</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">global_interpretation</span></span> nba<span class="main">:</span> automaton_run <span class="quoted">nba</span> <span class="quoted">alphabet</span> <span class="quoted">initial</span> <span class="quoted">transition</span> <span class="quoted">accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> infs <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">defines</span></span> language <span class="main">=</span> <span class="quoted">nba.language</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span>

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">target</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">target</span> <span class="main">≡</span> nba.target"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">states</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">states</span> <span class="main">≡</span> nba.states"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">trace</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">trace</span> <span class="main">≡</span> nba.trace"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">successors</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">successors</span> <span class="main">≡</span> nba.successors <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'label</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">instantiation</span></span> nba <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">,</span> <span class="quoted">type</span><span class="main">)</span> <span class="quoted">order</span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">less_eq_nba</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> nba <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> nba <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> alphabet <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≤</span> alphabet <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">∧</span> initial <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≤</span> initial <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">∧</span>
        transition <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≤</span> transition <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">∧</span> accepting <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≤</span> accepting <span class="free"><span class="bound"><span class="entity">B</span></span></span>"</span></span>
    <span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">less_nba</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> nba <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> nba <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">less_nba</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span>"</span></span>

    <span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro_classes</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_eq_nba_def less_nba_def nba.expand<span class="main">)</span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1" id="NBA-nodes_mono"><span class="command">lemma</span></span> nodes_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"mono nodes"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> nba"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≤</span> <span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"alphabet <span class="skolem">A</span> <span class="main">⊆</span> alphabet <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> less_eq_nba_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"initial <span class="skolem">A</span> <span class="main">⊆</span> initial <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> less_eq_nba_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"transition <span class="skolem">A</span> <span class="skolem">a</span> <span class="skolem">p</span> <span class="main">⊆</span> transition <span class="skolem">B</span> <span class="skolem">a</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">p</span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> less_eq_nba_def le_fun_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> nodes <span class="skolem">B</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> nodes <span class="skolem">A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span> <span class="keyword1"><span class="command">using</span></span> that 2 3 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nodes <span class="skolem">A</span> <span class="main">⊆</span> nodes <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="NBA-language_mono"><span class="command">lemma</span></span> language_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"mono language"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> nba"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≤</span> <span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"alphabet <span class="skolem">A</span> <span class="main">⊆</span> alphabet <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> less_eq_nba_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"initial <span class="skolem">A</span> <span class="main">⊆</span> initial <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> less_eq_nba_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"transition <span class="skolem">A</span> <span class="skolem">a</span> <span class="skolem">p</span> <span class="main">⊆</span> transition <span class="skolem">B</span> <span class="skolem">a</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">p</span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> less_eq_nba_def le_fun_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"accepting <span class="skolem">A</span> <span class="skolem">p</span> <span class="main">⟹</span> accepting <span class="skolem">B</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> less_eq_nba_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"run <span class="skolem">B</span> <span class="skolem">wr</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"run <span class="skolem">A</span> <span class="skolem">wr</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">wr</span> <span class="skolem">p</span> <span class="keyword1"><span class="command">using</span></span> that 2 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">coinduct</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 7<span class="main">:</span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span>accepting <span class="skolem">B</span><span class="main">)</span> <span class="skolem">w</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span>accepting <span class="skolem">A</span><span class="main">)</span> <span class="skolem">w</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">w</span> <span class="keyword1"><span class="command">using</span></span> infs_mono that 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"language <span class="skolem">A</span> <span class="main">⊆</span> language <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 6 7 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="NBA-simulation_language"><span class="command">lemma</span></span> simulation_language<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"alphabet <span class="free">A</span> <span class="main">⊆</span> alphabet <span class="free">B</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> initial <span class="free">A</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">q</span> <span class="main">∈</span> initial <span class="free">B</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="bound">p</span> <span class="bound">p'</span> <span class="bound">q</span><span class="main">.</span> <span class="bound">p'</span> <span class="main">∈</span> transition <span class="free">A</span> <span class="bound">a</span> <span class="bound">p</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">q'</span> <span class="main">∈</span> transition <span class="free">B</span> <span class="bound">a</span> <span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="bound">p'</span><span class="main">,</span> <span class="bound">q'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟹</span> accepting <span class="free">A</span> <span class="bound">p</span> <span class="main">⟹</span> accepting <span class="free">B</span> <span class="bound">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"language <span class="free">A</span> <span class="main">⊆</span> language <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> language <span class="free">A</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> initial <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"run <span class="free">A</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span>accepting <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">##</span> <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="skolem">n</span> <span class="skolem">q</span> <span class="main">≡</span> <span class="main">(</span>target <span class="main">(</span>stake <span class="skolem">n</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span> <span class="skolem">q</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> initial <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> 2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ws</span></span> <span class="keyword2"><span class="keyword">where</span></span> 4<span class="main">:</span>
      <span class="quoted"><span class="quoted">"run <span class="free">B</span> <span class="skolem">ws</span> <span class="skolem">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">P</span> <span class="main">(</span><span class="main">0</span> <span class="main">+</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>target <span class="main">(</span>stake <span class="bound">i</span> <span class="skolem">ws</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> fst <span class="main">(</span><span class="skolem">ws</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">w</span> <span class="main">!!</span> <span class="main">(</span><span class="main">0</span> <span class="main">+</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> nba.invariant_run_index<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"stake <span class="skolem">k</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">@-</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">!!</span> <span class="skolem">k</span><span class="main">,</span> target <span class="main">(</span>stake <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">##</span>
        sdrop <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">r</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> id_stake_snth_sdrop snth_szip sscan_snth szip_smap_snd nba.trace_alt_def<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"run <span class="free">A</span> <span class="main">…</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">a</span><span class="main">.</span> <span class="main">(</span>fst <span class="bound">a</span> <span class="main">∈</span> alphabet <span class="free">B</span> <span class="main">∧</span> snd <span class="bound">a</span> <span class="main">∈</span> transition <span class="free">B</span> <span class="main">(</span>fst <span class="bound">a</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">∧</span>
        <span class="skolem">P</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">a</span><span class="main">)</span> <span class="main">∧</span> fst <span class="bound">a</span> <span class="main">=</span> <span class="skolem">w</span> <span class="main">!!</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="skolem">n</span> <span class="skolem">q</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span> <span class="skolem">q</span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span> 3<span class="main">)</span> that <span class="keyword1"><span class="command">unfolding</span></span> P_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">0</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> P_def <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">rule</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ws</span> <span class="main">=</span> <span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.left_neutral eqI_snth snth_smap szip_smap<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> language <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> initial <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"run <span class="free">B</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
      <span class="keyword1"><span class="command">have</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> accepting <span class="free">A</span> <span class="bound">a</span> <span class="main">⟶</span> accepting <span class="free">B</span> <span class="bound">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 7<span class="main">:</span> <span class="quoted"><span class="quoted">"stream_all2 <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">)</span> <span class="main">(</span>trace <span class="main">(</span><span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span>trace <span class="main">(</span><span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 4<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> P_def 5 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stream_rel_snth <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> stake.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 8<span class="main">:</span> <span class="quoted"><span class="quoted">"stream_all2 <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> accepting <span class="free">A</span> <span class="bound">a</span> <span class="main">⟶</span> accepting <span class="free">B</span> <span class="bound">b</span><span class="main">)</span> <span class="skolem">r</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> stream.rel_mono 6 7 <span class="keyword1"><span class="command">unfolding</span></span> nba.trace_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span>accepting <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">##</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> infs_mono_strong 8 2<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="NGBA">
<div class="head">
<h1>Theory NGBA</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Nondeterministic Generalized Büchi Automata›</span></span>

<span class="keyword1"><span class="command">theory</span></span> NGBA
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Nondeterministic.html">../Nondeterministic</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> ngba <span class="main">=</span> ngba
    <span class="main">(</span><span class="free"><span class="entity">alphabet</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> set"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">initial</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> set"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">transition</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> set"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">accepting</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> pred gen"</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">global_interpretation</span></span> ngba<span class="main">:</span> automaton <span class="quoted">ngba</span> <span class="quoted">alphabet</span> <span class="quoted">initial</span> <span class="quoted">transition</span> <span class="quoted">accepting</span>
    <span class="keyword2"><span class="keyword">defines</span></span> path <span class="main">=</span> <span class="quoted">ngba.path</span> <span class="keyword2"><span class="keyword">and</span></span> run <span class="main">=</span> <span class="quoted">ngba.run</span> <span class="keyword2"><span class="keyword">and</span></span> reachable <span class="main">=</span> <span class="quoted">ngba.reachable</span> <span class="keyword2"><span class="keyword">and</span></span> nodes <span class="main">=</span> <span class="quoted">ngba.nodes</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">global_interpretation</span></span> ngba<span class="main">:</span> automaton_run <span class="quoted">ngba</span> <span class="quoted">alphabet</span> <span class="quoted">initial</span> <span class="quoted">transition</span> <span class="quoted">accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> gen infs <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">defines</span></span> language <span class="main">=</span> <span class="quoted">ngba.language</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span>

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">target</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">target</span> <span class="main">≡</span> ngba.target"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">states</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">states</span> <span class="main">≡</span> ngba.states"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">trace</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">trace</span> <span class="main">≡</span> ngba.trace"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">successors</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">successors</span> <span class="main">≡</span> ngba.successors <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'label</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="NBA_Combine">
<div class="head">
<h1>Theory NBA_Combine</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Nondeterministic Büchi Automata Combinations›</span></span>

<span class="keyword1"><span class="command">theory</span></span> NBA_Combine
<span class="keyword2"><span class="keyword">imports</span></span> <a href="NBA.html">NBA</a> <a href="NGBA.html">NGBA</a>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">global_interpretation</span></span> degeneralization<span class="main">:</span> automaton_degeneralization_run
    <span class="quoted">ngba</span> <span class="quoted">ngba.alphabet</span> <span class="quoted">ngba.initial</span> <span class="quoted">ngba.transition</span> <span class="quoted">ngba.accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> gen infs <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted">nba</span> <span class="quoted">nba.alphabet</span> <span class="quoted">nba.initial</span> <span class="quoted">nba.transition</span> <span class="quoted">nba.accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> infs <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted">fst</span> <span class="quoted">id</span>
    <span class="keyword2"><span class="keyword">defines</span></span> degeneralize <span class="main">=</span> <span class="quoted">degeneralization.degeneralize</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> sscan_smap<span class="main">)</span>

  <span class="keyword1"><span class="command">lemmas</span></span> degeneralize_language<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> degeneralization.degeneralize_language<span class="main">[</span><span class="operator">folded</span> NBA.language_def<span class="main">]</span>
  <span class="keyword1"><span class="command">lemmas</span></span> degeneralize_nodes_finite<span class="main">[</span><span class="operator">iff</span><span class="main">]</span> <span class="main">=</span> degeneralization.degeneralize_nodes_finite<span class="main">[</span><span class="operator">folded</span> NBA.nodes_def<span class="main">]</span>

  <span class="keyword1"><span class="command">global_interpretation</span></span> intersection<span class="main">:</span> automaton_intersection_run
    <span class="quoted">nba</span> <span class="quoted">nba.alphabet</span> <span class="quoted">nba.initial</span> <span class="quoted">nba.transition</span> <span class="quoted">nba.accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> infs <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted">nba</span> <span class="quoted">nba.alphabet</span> <span class="quoted">nba.initial</span> <span class="quoted">nba.transition</span> <span class="quoted">nba.accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> infs <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted">ngba</span> <span class="quoted">ngba.alphabet</span> <span class="quoted">ngba.initial</span> <span class="quoted">ngba.transition</span> <span class="quoted">ngba.accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> gen infs <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="main">[</span><span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∘</span> fst<span class="main">,</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∘</span> snd<span class="main">]</span>"</span></span>
    <span class="keyword2"><span class="keyword">defines</span></span> intersect' <span class="main">=</span> <span class="quoted">intersection.product</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">lemmas</span></span> intersect'_language<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> intersection.product_language<span class="main">[</span><span class="operator">folded</span> NGBA.language_def<span class="main">]</span>
  <span class="keyword1"><span class="command">lemmas</span></span> intersect'_nodes_finite<span class="main">[</span><span class="operator">intro</span><span class="main">]</span> <span class="main">=</span> intersection.product_nodes_finite<span class="main">[</span><span class="operator">folded</span> NGBA.nodes_def<span class="main">]</span>

  <span class="keyword1"><span class="command">global_interpretation</span></span> union<span class="main">:</span> automaton_union_run
    <span class="quoted">nba</span> <span class="quoted">nba.alphabet</span> <span class="quoted">nba.initial</span> <span class="quoted">nba.transition</span> <span class="quoted">nba.accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> infs <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted">nba</span> <span class="quoted">nba.alphabet</span> <span class="quoted">nba.initial</span> <span class="quoted">nba.transition</span> <span class="quoted">nba.accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> infs <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted">nba</span> <span class="quoted">nba.alphabet</span> <span class="quoted">nba.initial</span> <span class="quoted">nba.transition</span> <span class="quoted">nba.accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> infs <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted">case_sum</span>
    <span class="keyword2"><span class="keyword">defines</span></span> union <span class="main">=</span> <span class="quoted">union.sum</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> comp_def<span class="main">)</span>

  <span class="keyword1"><span class="command">lemmas</span></span> union_language <span class="main">=</span> union.sum_language
  <span class="keyword1"><span class="command">lemmas</span></span> union_nodes_finite <span class="main">=</span> union.sum_nodes_finite

  <span class="keyword1"><span class="command">global_interpretation</span></span> intersection_list<span class="main">:</span> automaton_intersection_list_run
    <span class="quoted">nba</span> <span class="quoted">nba.alphabet</span> <span class="quoted">nba.initial</span> <span class="quoted">nba.transition</span> <span class="quoted">nba.accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> infs <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted">ngba</span> <span class="quoted">ngba.alphabet</span> <span class="quoted">ngba.initial</span> <span class="quoted">ngba.transition</span> <span class="quoted">ngba.accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> gen infs <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">cs</span><span class="main">.</span> map <span class="main">(</span><span class="main">λ</span> <span class="bound">k</span> <span class="bound">ps</span><span class="main">.</span> <span class="main">(</span><span class="bound">cs</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span><span class="bound">ps</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> length <span class="bound">cs</span><span class="main">]</span>"</span></span>
    <span class="keyword2"><span class="keyword">defines</span></span> intersect_list' <span class="main">=</span> <span class="quoted">intersection_list.product</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">unfold_locales</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">cs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> bool<span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">rs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> stream list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">w</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> stream"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">ps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> list"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">rs</span> <span class="main">=</span> length <span class="skolem">cs</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ps</span> <span class="main">=</span> length <span class="skolem">cs</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gen infs <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">k</span> <span class="bound">pp</span><span class="main">.</span> <span class="main">(</span><span class="skolem">cs</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span><span class="bound">pp</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> length <span class="skolem">cs</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ps</span> <span class="main">##</span> stranspose <span class="skolem">rs</span><span class="main">)</span> <span class="main">⟷</span>
      <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">k</span></span> <span class="main">&lt;</span> length <span class="skolem">cs</span><span class="main">.</span> infs <span class="main">(</span><span class="main">λ</span> <span class="bound">pp</span><span class="main">.</span> <span class="main">(</span><span class="skolem">cs</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span><span class="bound">pp</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ps</span> <span class="main">##</span> stranspose <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gen_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">k</span></span> <span class="main">&lt;</span> length <span class="skolem">cs</span><span class="main">.</span> infs <span class="main">(</span><span class="skolem">cs</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span>smap <span class="main">(</span><span class="main">λ</span> <span class="bound">pp</span><span class="main">.</span> <span class="bound">pp</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ps</span> <span class="main">##</span> stranspose <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">k</span></span> <span class="main">&lt;</span> length <span class="skolem">cs</span><span class="main">.</span> infs <span class="main">(</span><span class="skolem">cs</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span><span class="skolem">rs</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> list_all <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> infs <span class="bound">c</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cs</span> <span class="main">||</span> <span class="skolem">rs</span> <span class="main">||</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> list_all_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"gen infs <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">k</span> <span class="bound">ps</span><span class="main">.</span> <span class="main">(</span><span class="skolem">cs</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span><span class="bound">ps</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> length <span class="skolem">cs</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ps</span> <span class="main">##</span> stranspose <span class="skolem">rs</span><span class="main">)</span> <span class="main">⟷</span>
      list_all <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> infs <span class="bound">c</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cs</span> <span class="main">||</span> <span class="skolem">rs</span> <span class="main">||</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemmas</span></span> intersect_list'_language<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> intersection_list.product_language<span class="main">[</span><span class="operator">folded</span> NGBA.language_def<span class="main">]</span>
  <span class="keyword1"><span class="command">lemmas</span></span> intersect_list'_nodes_finite<span class="main">[</span><span class="operator">intro</span><span class="main">]</span> <span class="main">=</span> intersection_list.product_nodes_finite<span class="main">[</span><span class="operator">folded</span> NGBA.nodes_def<span class="main">]</span>

  <span class="keyword1"><span class="command">global_interpretation</span></span> union_list<span class="main">:</span> automaton_union_list_run
    <span class="quoted">nba</span> <span class="quoted">nba.alphabet</span> <span class="quoted">nba.initial</span> <span class="quoted">nba.transition</span> <span class="quoted">nba.accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> infs <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted">nba</span> <span class="quoted">nba.alphabet</span> <span class="quoted">nba.initial</span> <span class="quoted">nba.transition</span> <span class="quoted">nba.accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> infs <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">cs</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">cs</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="bound">p</span>"</span></span>
    <span class="keyword2"><span class="keyword">defines</span></span> union_list <span class="main">=</span> <span class="quoted">union_list.sum</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> szip_sconst_smap_fst comp_def<span class="main">)</span>

  <span class="keyword1"><span class="command">lemmas</span></span> union_list_language <span class="main">=</span> union_list.sum_language
  <span class="keyword1"><span class="command">lemmas</span></span> union_list_nodes_finite <span class="main">=</span> union_list.sum_nodes_finite

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">intersect</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">intersect</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> degeneralize <span class="main">(</span>intersect' <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="NBA_Combine-intersect_language"><span class="command">lemma</span></span> intersect_language<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"NBA.language <span class="main">(</span>intersect <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> NBA.language <span class="free">A</span> <span class="main">∩</span> NBA.language <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1" id="NBA_Combine-intersect_nodes_finite"><span class="command">lemma</span></span> intersect_nodes_finite<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>NBA.nodes <span class="free">A</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>NBA.nodes <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>NBA.nodes <span class="main">(</span>intersect <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> intersect'_nodes_finite assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">intersect_list</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">intersect_list</span> <span class="free"><span class="bound"><span class="entity">AA</span></span></span> <span class="main">≡</span> degeneralize <span class="main">(</span>intersect_list' <span class="free"><span class="bound"><span class="entity">AA</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="NBA_Combine-intersect_list_language"><span class="command">lemma</span></span> intersect_list_language<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"NBA.language <span class="main">(</span>intersect_list <span class="free">AA</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋂</span> <span class="main">(</span>NBA.language <span class="main">`</span> set <span class="free">AA</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1" id="NBA_Combine-intersect_list_nodes_finite"><span class="command">lemma</span></span> intersect_list_nodes_finite<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>finite <span class="main">∘</span> NBA.nodes<span class="main">)</span> <span class="free">AA</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>NBA.nodes <span class="main">(</span>intersect_list <span class="free">AA</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> intersect_list'_nodes_finite assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="NBA_Graphs">
<div class="head">
<h1>Theory NBA_Graphs</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Connecting Nondeterministic Büchi Automata to CAVA Automata Structures›</span></span>

<span class="keyword1"><span class="command">theory</span></span> NBA_Graphs
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="NBA.html">NBA</a>
  <a href="../CAVA_Automata/Automata_Impl.html">CAVA_Automata.Automata_Impl</a>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">no_notation</span></span> build <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">##</span>"</span> 65<span class="main">)</span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Regular Graphs›</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">nba_g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> nba <span class="main">⇒</span> <span class="tfree">'state</span> graph_rec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">nba_g</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">⦇</span> g_V <span class="main">=</span> UNIV<span class="main">,</span> g_E <span class="main">=</span> E_of_succ <span class="main">(</span>successors <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">,</span> g_V0 <span class="main">=</span> initial <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⦈</span>"</span></span>

  <span class="keyword1" id="NBA_Graphs-nba_g_graph"><span class="command">lemma</span></span> nba_g_graph<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"graph <span class="main">(</span>nba_g <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> nba_g_def graph_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1" id="NBA_Graphs-nba_g_V0"><span class="command">lemma</span></span> nba_g_V0<span class="main">:</span> <span class="quoted"><span class="quoted">"g_V0 <span class="main">(</span>nba_g <span class="free">A</span><span class="main">)</span> <span class="main">=</span> initial <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> nba_g_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1" id="NBA_Graphs-nba_g_E_rtrancl"><span class="command">lemma</span></span> nba_g_E_rtrancl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>g_E <span class="main">(</span>nba_g <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> reachable <span class="free">A</span> <span class="bound">p</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> nba_g_def graph_rec.simps E_of_succ_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> successors <span class="free">A</span> <span class="bound">p</span><span class="main">}</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> reachable <span class="free">A</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span> <span class="skolem">q</span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rtrancl_into_rtrancl<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> reachable <span class="free">A</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> successors <span class="free">A</span> <span class="bound">p</span><span class="main">}</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span> <span class="skolem">q</span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="NBA_Graphs-nba_g_rtrancl_path"><span class="command">lemma</span></span> nba_g_rtrancl_path<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>g_E <span class="main">(</span>nba_g <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> target <span class="bound">r</span> <span class="bound">p</span><span class="main">)</span> <span class="main">|</span><span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> NBA.path <span class="free">A</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> nba_g_E_rtrancl <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1" id="NBA_Graphs-nba_g_trancl_path"><span class="command">lemma</span></span> nba_g_trancl_path<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>g_E <span class="main">(</span>nba_g <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> target <span class="bound">r</span> <span class="bound">p</span><span class="main">)</span> <span class="main">|</span><span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> NBA.path <span class="free">A</span> <span class="bound">r</span> <span class="bound">p</span> <span class="main">∧</span> <span class="bound">r</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> nba_g_def graph_rec.simps E_of_succ_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> target <span class="bound">r</span> <span class="bound">p</span><span class="main">)</span> <span class="main">∧</span> NBA.path <span class="free">A</span> <span class="bound">r</span> <span class="bound">p</span> <span class="main">∧</span> <span class="bound">r</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> successors <span class="free">A</span> <span class="bound">p</span><span class="main">}</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>base <span class="skolem">y</span><span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> alphabet <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> transition <span class="free">A</span> <span class="skolem">a</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> base <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> target <span class="main">[</span><span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span><span class="main">]</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"NBA.path <span class="free">A</span> <span class="main">[</span><span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span><span class="main">]</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span><span class="main">]</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> target <span class="skolem">r</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"NBA.path <span class="free">A</span> <span class="skolem">r</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> alphabet <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> transition <span class="free">A</span> <span class="skolem">a</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> target <span class="main">(</span><span class="skolem">r</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"NBA.path <span class="free">A</span> <span class="main">(</span><span class="skolem">r</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span><span class="main">]</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span><span class="main">,</span> target <span class="skolem">r</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> successors <span class="free">A</span> <span class="bound">u</span><span class="main">}</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"NBA.path <span class="free">A</span> <span class="skolem">r</span> <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">r</span> <span class="skolem">p</span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trancl_into_trancl2<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="NBA_Graphs-nba_g_ipath_run"><span class="command">lemma</span></span> nba_g_ipath_run<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ipath <span class="main">(</span>g_E <span class="main">(</span>nba_g <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="free">r</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">w</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"run <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> smap <span class="main">(</span><span class="free">r</span> <span class="main">∘</span> Suc<span class="main">)</span> nats<span class="main">)</span> <span class="main">(</span><span class="free">r</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">a</span> <span class="main">∈</span> alphabet <span class="free">A</span><span class="main">.</span> <span class="free">r</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> transition <span class="free">A</span> <span class="bound">a</span> <span class="main">(</span><span class="free">r</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> ipath_def nba_g_def E_of_succ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">wr</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"run <span class="free">A</span> <span class="skolem">wr</span> <span class="main">(</span><span class="free">r</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> target <span class="main">(</span>stake <span class="bound">i</span> <span class="skolem">wr</span><span class="main">)</span> <span class="main">(</span><span class="free">r</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="free">r</span> <span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> nba.invariant_run_index<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">aq</span><span class="main">.</span> <span class="main">(</span>fst <span class="bound">aq</span> <span class="main">∈</span> alphabet <span class="free">A</span> <span class="main">∧</span> snd <span class="bound">aq</span> <span class="main">∈</span> transition <span class="free">A</span> <span class="main">(</span>fst <span class="bound">aq</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∧</span> snd <span class="bound">aq</span> <span class="main">=</span> <span class="free">r</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">∧</span> True"</span></span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="free">r</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">p</span> <span class="keyword1"><span class="command">using</span></span> that 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">0</span> <span class="main">=</span> <span class="free">r</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"smap <span class="main">(</span><span class="free">r</span> <span class="main">∘</span> Suc<span class="main">)</span> nats <span class="main">=</span> smap snd <span class="skolem">wr</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> eqI_snth<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"smap <span class="main">(</span><span class="free">r</span> <span class="main">∘</span> Suc<span class="main">)</span> nats <span class="main">!!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">r</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> target <span class="main">(</span>stake <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">wr</span><span class="main">)</span> <span class="main">(</span><span class="free">r</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 2<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="free">r</span> <span class="main">0</span> <span class="main">##</span> trace <span class="skolem">wr</span> <span class="main">(</span><span class="free">r</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!!</span> Suc <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> smap snd <span class="skolem">wr</span> <span class="main">!!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> nba.trace_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"smap <span class="main">(</span><span class="free">r</span> <span class="main">∘</span> Suc<span class="main">)</span> nats <span class="main">!!</span> <span class="skolem">i</span> <span class="main">=</span> smap snd <span class="skolem">wr</span> <span class="main">!!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"run <span class="free">A</span> <span class="main">(</span>smap fst <span class="skolem">wr</span> <span class="main">|||</span> smap <span class="main">(</span><span class="free">r</span> <span class="main">∘</span> Suc<span class="main">)</span> nats<span class="main">)</span> <span class="main">(</span><span class="free">r</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="NBA_Graphs-nba_g_run_ipath"><span class="command">lemma</span></span> nba_g_run_ipath<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"run <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> <span class="free">r</span><span class="main">)</span> <span class="free">p</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ipath <span class="main">(</span>g_E <span class="main">(</span>nba_g <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snth <span class="main">(</span><span class="free">p</span> <span class="main">##</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">!!</span> <span class="skolem">i</span> <span class="main">∈</span> alphabet <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">!!</span> <span class="skolem">i</span> <span class="main">∈</span> transition <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>target <span class="main">(</span>stake <span class="skolem">i</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> nba.run_snth<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">!!</span> <span class="skolem">i</span> <span class="main">∈</span> successors <span class="free">A</span> <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">##</span> <span class="free">r</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> sscan_scons_snth<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> nba.trace_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">##</span> <span class="free">r</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">,</span> <span class="main">(</span><span class="free">p</span> <span class="main">##</span> <span class="free">r</span><span class="main">)</span> <span class="main">!!</span> Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> g_E <span class="main">(</span>nba_g <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">unfolding</span></span> nba_g_def graph_rec.simps E_of_succ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Indexed Generalized Büchi Graphs›</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">nba_igbg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> nba <span class="main">⇒</span> <span class="tfree">'state</span> igb_graph_rec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">nba_igbg</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> graph_rec.extend <span class="main">(</span>nba_g <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>
      <span class="main">⦇</span> igbg_num_acc <span class="main">=</span> <span class="main">1</span><span class="main">,</span> igbg_acc <span class="main">=</span> <span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="keyword1">if</span> accepting <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">p</span> <span class="keyword1">then</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span> <span class="main">⦈</span>"</span></span>

  <span class="keyword1" id="NBA_Graphs-acc_run_language"><span class="command">lemma</span></span> acc_run_language<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"igb_graph <span class="main">(</span>nba_igbg <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Ex <span class="main">(</span>igb_graph.is_acc_run <span class="main">(</span>nba_igbg <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> language <span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">interpret</span></span> igb_graph <span class="quoted"><span class="quoted">"nba_igbg <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"V0 <span class="main">=</span> g_V0 <span class="main">(</span>nba_g <span class="free">A</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"E <span class="main">=</span> g_E <span class="main">(</span>nba_g <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"num_acc <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∈</span> acc <span class="skolem">p</span> <span class="main">⟷</span> accepting <span class="free">A</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span>
      <span class="keyword1"><span class="command">unfolding</span></span> nba_igbg_def graph_rec.defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"language <span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"Ex is_acc_run"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"is_acc_run <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> run <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">0</span> <span class="main">∈</span> V0"</span></span> <span class="quoted"><span class="quoted">"ipath E <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"is_acc <span class="skolem">r</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> is_acc_run_def graph_defs.is_run_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"run <span class="free">A</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">|||</span> smap <span class="main">(</span><span class="skolem">r</span> <span class="main">∘</span> Suc<span class="main">)</span> nats<span class="main">)</span> <span class="main">(</span><span class="skolem">r</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nba_g_ipath_run 2<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">0</span> <span class="main">##</span> smap <span class="main">(</span><span class="skolem">r</span> <span class="main">∘</span> Suc<span class="main">)</span> nats <span class="main">=</span> smap <span class="skolem">r</span> nats"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> stream.map_comp smap_siterate<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span>accepting <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="skolem">r</span> <span class="main">0</span> <span class="main">##</span> smap <span class="main">(</span><span class="skolem">r</span> <span class="main">∘</span> Suc<span class="main">)</span> nats<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> infs_infm is_acc_def 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> language <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">0</span> <span class="main">∈</span> initial <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nba_g_V0 2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"run <span class="free">A</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">|||</span> smap <span class="main">(</span><span class="skolem">r</span> <span class="main">∘</span> Suc<span class="main">)</span> nats<span class="main">)</span> <span class="main">(</span><span class="skolem">r</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span>accepting <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="skolem">r</span> <span class="main">0</span> <span class="main">##</span> smap <span class="main">(</span><span class="skolem">r</span> <span class="main">∘</span> Suc<span class="main">)</span> nats<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Ex is_acc_run"</span></span> <span class="keyword2"><span class="keyword">if</span></span> language<span class="main">:</span> <span class="quoted"><span class="quoted">"language <span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> language <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> language <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> initial <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"run <span class="free">A</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span>accepting <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">##</span> <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_acc_run <span class="main">(</span>snth <span class="main">(</span><span class="skolem">p</span> <span class="main">##</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> is_acc_run_def graph_defs.is_run_def
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span> <span class="main">##</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">!!</span> <span class="main">0</span> <span class="main">∈</span> V0"</span></span> <span class="keyword1"><span class="command">using</span></span> nba_g_V0 2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ipath E <span class="main">(</span>snth <span class="main">(</span><span class="skolem">p</span> <span class="main">##</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nba_g_run_ipath 2<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"is_acc <span class="main">(</span>snth <span class="main">(</span><span class="skolem">p</span> <span class="main">##</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> infs_infm is_acc_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="NBA_Refine">
<div class="head">
<h1>Theory NBA_Refine</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Relations on Nondeterministic Büchi Automata›</span></span>

<span class="keyword1"><span class="command">theory</span></span> NBA_Refine
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="NBA.html">NBA</a>"</span>
  <span class="quoted">"<a href="Transition_System_Refine.html">../../Transition_Systems/Transition_System_Refine</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">nba_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">×</span> <span class="tfree">'label<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'state<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">×</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> set <span class="main">⇒</span>
    <span class="main">(</span><span class="main">(</span><span class="tfree">'label<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> nba <span class="main">×</span> <span class="main">(</span><span class="tfree">'label<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> nba<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="main">[</span><span class="operator">to_relAPP</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nba_rel</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">.</span>
      <span class="main">(</span>alphabet <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> alphabet <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">⟩</span> set_rel <span class="main">∧</span>
      <span class="main">(</span>initial <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> initial <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">⟩</span> set_rel <span class="main">∧</span>
      <span class="main">(</span>transition <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> transition <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">→</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">⟩</span> set_rel <span class="main">∧</span>
      <span class="main">(</span>accepting <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> accepting <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">→</span> bool_rel<span class="main">}</span>"</span></span>

  <span class="keyword1" id="NBA_Refine-nba_param"><span class="command">lemma</span></span> nba_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>nba<span class="main">,</span> nba<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">⟩</span> set_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> set_rel <span class="main">→</span> <span class="main">(</span><span class="free">L</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> set_rel<span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">S</span> <span class="main">→</span> bool_rel<span class="main">)</span> <span class="main">→</span>
      <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nba_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>alphabet<span class="main">,</span> alphabet<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nba_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">L</span><span class="main">⟩</span> set_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>initial<span class="main">,</span> initial<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nba_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> set_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>transition<span class="main">,</span> transition<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nba_rel <span class="main">→</span> <span class="free">L</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> set_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>accepting<span class="main">,</span> accepting<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nba_rel <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> bool_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> nba_rel_def fun_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="NBA_Refine-nba_rel_id"><span class="command">lemma</span></span> nba_rel_id<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Id<span class="main">,</span> Id<span class="main">⟩</span> nba_rel <span class="main">=</span> Id"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> nba_rel_def <span class="keyword1"><span class="command">using</span></span> nba.expand <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="NBA_Refine-nba_rel_comp"><span class="command">lemma</span></span> nba_rel_comp<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">S<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> nba_rel"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">B</span><span class="main">,</span> <span class="free">C</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> nba_rel"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">C</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">O</span> <span class="free">L<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">O</span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> nba_rel"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>accepting <span class="free">A</span><span class="main">,</span> accepting <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">→</span> bool_rel"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>accepting <span class="free">B</span><span class="main">,</span> accepting <span class="free">C</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">→</span> bool_rel"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>accepting <span class="free">A</span><span class="main">,</span> accepting <span class="free">C</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">O</span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">→</span> bool_rel"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>transition <span class="free">A</span><span class="main">,</span> transition <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> <span class="free">L<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">→</span> <span class="free">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">→</span> <span class="main">⟨</span><span class="free">S<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> set_rel"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>transition <span class="free">B</span><span class="main">,</span> transition <span class="free">C</span><span class="main">)</span> <span class="main">∈</span> <span class="free">L<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">→</span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">→</span> <span class="main">⟨</span><span class="free">S<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> set_rel"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>transition <span class="free">A</span><span class="main">,</span> transition <span class="free">C</span><span class="main">)</span> <span class="main">∈</span> <span class="free">L<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">O</span> <span class="free">L<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">→</span> <span class="free">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">O</span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">→</span> <span class="main">⟨</span><span class="free">S<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> set_rel <span class="keyword1">O</span> <span class="main">⟨</span><span class="free">S<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> set_rel"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> nba_rel_def mem_Collect_eq prod.case set_rel_compp
      <span class="keyword1"><span class="command">using</span></span> 1 2
      <span class="keyword1"><span class="command">using</span></span> nba_param<span class="main">(</span>2 - 5<span class="main">)</span><span class="main">[</span><span class="operator">THEN</span> fun_relD<span class="main">,</span> <span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> nba_param<span class="main">(</span>2 - 5<span class="main">)</span><span class="main">[</span><span class="operator">THEN</span> fun_relD<span class="main">,</span> <span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="NBA_Refine-nba_rel_converse"><span class="command">lemma</span></span> nba_rel_converse<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nba_rel<span class="main">)</span><span class="main">¯</span> <span class="main">=</span> <span class="main">⟨</span><span class="free">L</span><span class="main">¯</span><span class="main">,</span> <span class="free">S</span><span class="main">¯</span><span class="main">⟩</span> nba_rel"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">L</span><span class="main">⟩</span> set_rel <span class="main">=</span> <span class="main">(</span><span class="main">⟨</span><span class="free">L</span><span class="main">¯</span><span class="main">⟩</span> set_rel<span class="main">)</span><span class="main">¯</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> set_rel <span class="main">=</span> <span class="main">(</span><span class="main">⟨</span><span class="free">S</span><span class="main">¯</span><span class="main">⟩</span> set_rel<span class="main">)</span><span class="main">¯</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> set_rel <span class="main">=</span> <span class="main">(</span><span class="free">L</span><span class="main">¯</span> <span class="main">→</span> <span class="free">S</span><span class="main">¯</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span><span class="main">¯</span><span class="main">⟩</span> set_rel<span class="main">)</span><span class="main">¯</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">→</span> bool_rel <span class="main">=</span> <span class="main">(</span><span class="free">S</span><span class="main">¯</span> <span class="main">→</span> bool_rel<span class="main">)</span><span class="main">¯</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> nba_rel_def <span class="keyword1"><span class="command">unfolding</span></span> 3 <span class="keyword1"><span class="command">unfolding</span></span> 1 2 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="NBA_Refine-nba_rel_eq"><span class="command">lemma</span></span> nba_rel_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id_on <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span><span class="main">,</span> Id_on <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span><span class="main">⟩</span> nba_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> nba_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="NBA_Refine-enableds_param"><span class="command">lemma</span></span> enableds_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nba.enableds<span class="main">,</span> nba.enableds<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nba_rel <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">L</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">S</span><span class="main">⟩</span> set_rel"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nba_param<span class="main">(</span>2<span class="main">,</span> 4<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> nba.enableds_def fun_rel_def set_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1" id="NBA_Refine-paths_param"><span class="command">lemma</span></span> paths_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nba.paths<span class="main">,</span> nba.paths<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nba_rel <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">L</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">S</span><span class="main">⟩</span> list_rel<span class="main">⟩</span> set_rel"</span></span>
    <span class="keyword1"><span class="command">using</span></span> enableds_param<span class="main">[</span><span class="operator">param_fo</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
  <span class="keyword1" id="NBA_Refine-runs_param"><span class="command">lemma</span></span> runs_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nba.runs<span class="main">,</span> nba.runs<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nba_rel <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">L</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">S</span><span class="main">⟩</span> stream_rel<span class="main">⟩</span> set_rel"</span></span>
    <span class="keyword1"><span class="command">using</span></span> enableds_param<span class="main">[</span><span class="operator">param_fo</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>

  <span class="keyword1" id="NBA_Refine-reachable_param"><span class="command">lemma</span></span> reachable_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>reachable<span class="main">,</span> reachable<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nba_rel <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> set_rel"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"reachable <span class="skolem">A</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">wr</span><span class="main">.</span> target <span class="bound">wr</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">`</span> nba.paths <span class="skolem">A</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> nba"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">p</span>
      <span class="keyword1"><span class="command">unfolding</span></span> nba.reachable_alt_def nba.paths_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> 1 <span class="keyword1"><span class="command">using</span></span> enableds_param<span class="main">[</span><span class="operator">param_fo</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="NBA_Refine-nodes_param"><span class="command">lemma</span></span> nodes_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nodes<span class="main">,</span> nodes<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nba_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> set_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> nba.nodes_alt_def Collect_mem_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>

  <span class="keyword1" id="NBA_Refine-language_param"><span class="command">lemma</span></span> language_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>language<span class="main">,</span> language<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nba_rel <span class="main">→</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">L</span><span class="main">⟩</span> stream_rel<span class="main">⟩</span> set_rel"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"language <span class="skolem">A</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">p</span> <span class="main">∈</span> initial <span class="skolem">A</span><span class="main">.</span> <span class="main">⋃</span> <span class="bound">wr</span> <span class="main">∈</span> nba.runs <span class="skolem">A</span> <span class="bound">p</span><span class="main">.</span>
      <span class="keyword1">if</span> infs <span class="main">(</span>accepting <span class="skolem">A</span><span class="main">)</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> smap snd <span class="bound">wr</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">{</span>smap fst <span class="bound">wr</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> nba"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> nba.language_def nba.runs_def image_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> split_szip_ex <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> alw_smap<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> 1 <span class="keyword1"><span class="command">using</span></span> enableds_param<span class="main">[</span><span class="operator">param_fo</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="NBA_Implement">
<div class="head">
<h1>Theory NBA_Implement</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Implementation of Nondeterministic Büchi Automata›</span></span>

<span class="keyword1"><span class="command">theory</span></span> NBA_Implement
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="NBA_Refine.html">NBA_Refine</a>"</span>
  <span class="quoted">"<a href="Implement.html">../../Basic/Implement</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">consts</span></span> i_nba_scheme <span class="main">::</span> <span class="quoted"><span class="quoted">"interface <span class="main">⇒</span> interface <span class="main">⇒</span> interface"</span></span>

  <span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1"><span class="command">interpretation</span></span> autoref_syn <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>

    <span class="keyword1" id="NBA_Implement-nba_scheme_itype"><span class="command">lemma</span></span> nba_scheme_itype<span class="main">[</span><span class="operator">autoref_itype</span><span class="main">]</span><span class="main">:</span>
      <span class="quoted"><span class="quoted">"nba <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">L</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_set <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">S</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_set <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">(</span><span class="free">L</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">S</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">S</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_set<span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">S</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_set <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span>
        <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_nba_scheme"</span></span>
      <span class="quoted"><span class="quoted">"alphabet <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_nba_scheme <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">L</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_set"</span></span>
      <span class="quoted"><span class="quoted">"initial <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_nba_scheme <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">S</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_set"</span></span>
      <span class="quoted"><span class="quoted">"transition <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_nba_scheme <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">L</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">S</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">S</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_set"</span></span>
      <span class="quoted"><span class="quoted">"accepting <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_nba_scheme <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">S</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_set"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> nbai <span class="main">=</span> nbai
    <span class="main">(</span><span class="free"><span class="entity">alphabeti</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> list"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">initiali</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> list"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">transitioni</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> list"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">acceptingi</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> <span class="main">⇒</span> bool"</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">nbai_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">×</span> <span class="tfree">'label<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'state<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">×</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> set <span class="main">⇒</span>
    <span class="main">(</span><span class="main">(</span><span class="tfree">'label<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> nbai <span class="main">×</span> <span class="main">(</span><span class="tfree">'label<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> nbai<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="main">[</span><span class="operator">to_relAPP</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nbai_rel</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">.</span>
      <span class="main">(</span>alphabeti <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> alphabeti <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">⟩</span> list_rel <span class="main">∧</span>
      <span class="main">(</span>initiali <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> initiali <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">⟩</span> list_rel <span class="main">∧</span>
      <span class="main">(</span>transitioni <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> transitioni <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">→</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">⟩</span> list_rel <span class="main">∧</span>
      <span class="main">(</span>acceptingi <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> acceptingi <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">→</span> bool_rel<span class="main">}</span>"</span></span>

  <span class="keyword1" id="NBA_Implement-nbai_param"><span class="command">lemma</span></span> nbai_param<span class="main">[</span><span class="operator">param</span><span class="main">,</span> <span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>nbai<span class="main">,</span> nbai<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">⟩</span> list_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> list_rel <span class="main">→</span> <span class="main">(</span><span class="free">L</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> list_rel<span class="main">)</span> <span class="main">→</span>
      <span class="main">(</span><span class="free">S</span> <span class="main">→</span> bool_rel<span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nbai_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>alphabeti<span class="main">,</span> alphabeti<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nbai_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">L</span><span class="main">⟩</span> list_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>initiali<span class="main">,</span> initiali<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nbai_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> list_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>transitioni<span class="main">,</span> transitioni<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nbai_rel <span class="main">→</span> <span class="free">L</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> list_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>acceptingi<span class="main">,</span> acceptingi<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nbai_rel <span class="main">→</span> <span class="main">(</span><span class="free">S</span> <span class="main">→</span> bool_rel<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> nbai_rel_def fun_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">nbai_nba_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">×</span> <span class="tfree">'label<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'state<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">×</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> set <span class="main">⇒</span>
    <span class="main">(</span><span class="main">(</span><span class="tfree">'label<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> nbai <span class="main">×</span> <span class="main">(</span><span class="tfree">'label<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> nba<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="main">[</span><span class="operator">to_relAPP</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nbai_nba_rel</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">.</span>
      <span class="main">(</span>alphabeti <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> alphabet <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">⟩</span> list_set_rel <span class="main">∧</span>
      <span class="main">(</span>initiali <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> initial <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">⟩</span> list_set_rel <span class="main">∧</span>
      <span class="main">(</span>transitioni <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> transition <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">→</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">⟩</span> list_set_rel <span class="main">∧</span>
      <span class="main">(</span>acceptingi <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> accepting <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">→</span> bool_rel<span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rel_intf</span><span class="main">]</span> <span class="main">=</span> REL_INTFI<span class="main">[</span><span class="operator">of</span> <span class="quoted">nbai_nba_rel</span> <span class="quoted">i_nba_scheme</span><span class="main">]</span>

  <span class="comment1">(* TODO: why is there a warning? *)</span>
  <span class="keyword1" id="NBA_Implement-nbai_nba_param"><span class="command">lemma</span></span> nbai_nba_param<span class="main">[</span><span class="operator">param</span><span class="main">,</span> <span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>nbai<span class="main">,</span> nba<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">⟩</span> list_set_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> list_set_rel <span class="main">→</span> <span class="main">(</span><span class="free">L</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> list_set_rel<span class="main">)</span> <span class="main">→</span>
      <span class="main">(</span><span class="free">S</span> <span class="main">→</span> bool_rel<span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nbai_nba_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>alphabeti<span class="main">,</span> alphabet<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nbai_nba_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">L</span><span class="main">⟩</span> list_set_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>initiali<span class="main">,</span> initial<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nbai_nba_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> list_set_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>transitioni<span class="main">,</span> transition<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nbai_nba_rel <span class="main">→</span> <span class="free">L</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> list_set_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>acceptingi<span class="main">,</span> accepting<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nbai_nba_rel <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> bool_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> nbai_nba_rel_def fun_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">nbai_nba</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> nbai <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> nba"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">nbai_nba</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> nba <span class="main">(</span>set <span class="main">(</span>alphabeti <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>initiali <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">.</span> set <span class="main">(</span>transitioni <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">a</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>acceptingi <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">nbai_invar</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> nbai <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">nbai_invar</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> distinct <span class="main">(</span>alphabeti <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">∧</span> distinct <span class="main">(</span>initiali <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">.</span> distinct <span class="main">(</span>transitioni <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">a</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="NBA_Implement-nbai_nba_id_param"><span class="command">lemma</span></span> nbai_nba_id_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nbai_nba<span class="main">,</span> id<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nbai_nba_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nba_rel"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Ai</span> <span class="skolem">A</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Ai</span><span class="main">,</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nbai_nba_rel"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"nbai_nba <span class="skolem">Ai</span> <span class="main">=</span> nba <span class="main">(</span>set <span class="main">(</span>alphabeti <span class="skolem">Ai</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>initiali <span class="skolem">Ai</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">.</span> set <span class="main">(</span>transitioni <span class="skolem">Ai</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>acceptingi <span class="skolem">Ai</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> nbai_nba_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"id <span class="skolem">A</span> <span class="main">=</span> nba <span class="main">(</span>id <span class="main">(</span>alphabet <span class="skolem">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>id <span class="main">(</span>initial <span class="skolem">A</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">.</span> id <span class="main">(</span>transition <span class="skolem">A</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>accepting <span class="skolem">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nbai_nba <span class="skolem">Ai</span><span class="main">,</span> id <span class="skolem">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nba_rel"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 2 3 <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="NBA_Implement-nbai_nba_br"><span class="command">lemma</span></span> nbai_nba_br<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Id<span class="main">,</span> Id<span class="main">⟩</span> nbai_nba_rel <span class="main">=</span> br nbai_nba nbai_invar"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id<span class="main">,</span> Id<span class="main">⟩</span> nbai_nba_rel"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> br nbai_nba nbai_invar"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">A</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> nba"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> nbai_nba_rel_def nbai_nba_def nbai_invar_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_br_conv list_set_rel_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> br nbai_nba nbai_invar"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id<span class="main">,</span> Id<span class="main">⟩</span> nbai_nba_rel"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">A</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> nba"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nbai_nba <span class="skolem">A</span><span class="main">,</span> id <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id<span class="main">,</span> Id<span class="main">⟩</span> nba_rel"</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"nbai_invar <span class="skolem">A</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> nbai_nba_param<span class="main">(</span>2 - 5<span class="main">)</span><span class="main">[</span><span class="operator">param_fo</span><span class="main">,</span> <span class="operator">OF</span> that<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_br_conv list_set_rel_def nbai_invar_def<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="keyword1"><span class="command">unfolding</span></span> in_br_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="NBA_Algorithms">
<div class="head">
<h1>Theory NBA_Algorithms</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Algorithms on Nondeterministic Büchi Automata›</span></span>

<span class="keyword1"><span class="command">theory</span></span> NBA_Algorithms
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="NBA_Graphs.html">NBA_Graphs</a>
  <a href="NBA_Implement.html">NBA_Implement</a>
  <a href="../DFS_Framework/Reachable_Nodes.html">DFS_Framework.Reachable_Nodes</a>
  <a href="../Gabow_SCC/Gabow_GBG_Code.html">Gabow_SCC.Gabow_GBG_Code</a>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Miscellaneous Amendments›</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> igb_fr_graph<span class="main">)</span> acc_run_lasso_prpl<span class="main">:</span> <span class="quoted"><span class="quoted">"Ex is_acc_run <span class="main">⟹</span> Ex is_lasso_prpl"</span></span>
    <span class="keyword1"><span class="command">using</span></span> accepted_lasso is_lasso_prpl_of_lasso <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> igb_fr_graph<span class="main">)</span>  lasso_prpl_acc_run_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"Ex is_lasso_prpl <span class="main">⟷</span> Ex is_acc_run"</span></span>
    <span class="keyword1"><span class="command">using</span></span> acc_run_lasso_prpl lasso_prpl_acc_run <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">autoref_rel_intf</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"REL_INTF igbg_impl_rel_ext i_igbg"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> REL_INTFI<span class="main">)</span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Operations›</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">op_language_empty</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">op_language_empty</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> language <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>

  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_op_pat</span><span class="main">]</span> <span class="main">=</span> op_language_empty_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Implementations›</span></span>

  <span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1"><span class="command">interpretation</span></span> autoref_syn <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>

    <span class="keyword1" id="NBA_Algorithms-nba_g_ahs"><span class="command">lemma</span></span> nba_g_ahs<span class="main">:</span> <span class="quoted"><span class="quoted">"nba_g <span class="free">A</span> <span class="main">=</span> <span class="main">⦇</span> g_V <span class="main">=</span> UNIV<span class="main">,</span> g_E <span class="main">=</span> E_of_succ <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> CAST
      <span class="main">(</span><span class="main">(</span><span class="main">⋃</span> <span class="bound">a</span> <span class="main">∈</span> alphabet <span class="free">A</span><span class="main">.</span> transition <span class="free">A</span> <span class="bound">a</span> <span class="bound">p</span> <span class="main">:::</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> list_set_rel<span class="main">)</span> <span class="main">:::</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> ahs_rel <span class="free">bhc</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
      g_V0 <span class="main">=</span> initial <span class="free">A</span> <span class="main">⦈</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> nba_g_def nba.successors_alt_def CAST_def id_apply <span class="dynamic"><span class="dynamic">autoref_tag_defs</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>

    <span class="keyword1"><span class="command">schematic_goal</span></span> nbai_gi<span class="main">:</span>
      <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="operator">autoref_ga_rules</span><span class="main">]</span> <span class="main">=</span> map2set_to_list
      <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'statei</span> <span class="main">×</span> <span class="tfree">'state</span><span class="main">)</span> set"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_ga_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_bounded_hashcode <span class="free">S</span> <span class="free">seq</span> <span class="free">bhc</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_ga_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_valid_def_hm_size <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'statei</span><span class="main">)</span> <span class="free">hms</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">seq</span><span class="main">,</span> HOL.eq<span class="main">)</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> bool_rel"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ai</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nbai_nba_rel"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?f</span> <span class="main">::</span> <span class="tvar">?'a</span><span class="main">,</span> RETURN <span class="main">(</span>nba_g <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> nba_g_ahs<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> bhc <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">bhc</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">autoref_monadic</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">plain</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">nbai_gi</span> <span class="keyword2"><span class="keyword">uses</span></span> nbai_gi
    <span class="keyword1" id="NBA_Algorithms-nbai_gi_refine"><span class="command">lemma</span></span> nbai_gi_refine<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'statei</span> <span class="main">×</span> <span class="tfree">'state</span><span class="main">)</span> set"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SIDE_GEN_ALGO <span class="main">(</span>is_bounded_hashcode <span class="free">S</span> <span class="free">seq</span> <span class="free">bhc</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SIDE_GEN_ALGO <span class="main">(</span>is_valid_def_hm_size <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'statei</span><span class="main">)</span> <span class="free">hms</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"GEN_OP <span class="free">seq</span> HOL.eq <span class="main">(</span><span class="free">S</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> bool_rel<span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>NBA_Algorithms.nbai_gi <span class="free">seq</span> <span class="free">bhc</span> <span class="free">hms</span><span class="main">,</span> nba_g<span class="main">)</span> <span class="main">∈</span>
        <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nbai_nba_rel <span class="main">→</span> <span class="main">⟨</span>unit_rel<span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> g_impl_rel_ext"</span></span>
      <span class="keyword1"><span class="command">using</span></span> nbai_gi.refine<span class="main">[</span><span class="operator">THEN</span> RETURN_nres_relD<span class="main">]</span> assms <span class="keyword1"><span class="command">unfolding</span></span> <span class="dynamic"><span class="dynamic">autoref_tag_defs</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">schematic_goal</span></span> nba_nodes<span class="main">:</span>
      <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'statei</span> <span class="main">×</span> <span class="tfree">'state</span><span class="main">)</span> set"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span>g_E <span class="main">(</span>nba_g <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> g_V0 <span class="main">(</span>nba_g <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_ga_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_bounded_hashcode <span class="free">S</span> <span class="free">seq</span> <span class="free">bhc</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_ga_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_valid_def_hm_size <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'statei</span><span class="main">)</span> <span class="free">hms</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">seq</span><span class="main">,</span> HOL.eq<span class="main">)</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> bool_rel"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ai</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nbai_nba_rel"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?f</span> <span class="main">::</span> <span class="tvar">?'a</span><span class="main">,</span> op_reachable <span class="main">(</span>nba_g <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">autoref</span>
    <span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">nba_nodes</span> <span class="keyword2"><span class="keyword">uses</span></span> nba_nodes
    <span class="keyword1" id="NBA_Algorithms-nba_nodes_refine"><span class="command">lemma</span></span> nba_nodes_refine<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'statei</span> <span class="main">×</span> <span class="tfree">'state</span><span class="main">)</span> set"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SIDE_PRECOND <span class="main">(</span>finite <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SIDE_GEN_ALGO <span class="main">(</span>is_bounded_hashcode <span class="free">S</span> <span class="free">seq</span> <span class="free">bhc</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SIDE_GEN_ALGO <span class="main">(</span>is_valid_def_hm_size <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'statei</span><span class="main">)</span> <span class="free">hms</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"GEN_OP <span class="free">seq</span> HOL.eq <span class="main">(</span><span class="free">S</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> bool_rel<span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ai</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nbai_nba_rel"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>NBA_Algorithms.nba_nodes <span class="free">seq</span> <span class="free">bhc</span> <span class="free">hms</span> <span class="free">Ai</span><span class="main">,</span>
        <span class="main">(</span><span class="keyword1">OP</span> nodes <span class="main">:::</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nbai_nba_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> ahs_rel <span class="free">bhc</span><span class="main">)</span> <span class="main">$</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> ahs_rel <span class="free">bhc</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"nodes <span class="free">A</span> <span class="main">=</span> op_reachable <span class="main">(</span>nba_g <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nba_g_V0 nba_g_E_rtrancl<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span>g_E <span class="main">(</span>nba_g <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> g_V0 <span class="main">(</span>nba_g <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> nba_nodes.refine assms 2 <span class="keyword1"><span class="command">unfolding</span></span> <span class="dynamic"><span class="dynamic">autoref_tag_defs</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="NBA_Algorithms-nba_igbg_ahs"><span class="command">lemma</span></span> nba_igbg_ahs<span class="main">:</span> <span class="quoted"><span class="quoted">"nba_igbg <span class="free">A</span> <span class="main">=</span> <span class="main">⦇</span> g_V <span class="main">=</span> UNIV<span class="main">,</span> g_E <span class="main">=</span> E_of_succ <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> CAST
      <span class="main">(</span><span class="main">(</span><span class="main">⋃</span> <span class="bound">a</span> <span class="main">∈</span> alphabet <span class="free">A</span><span class="main">.</span> transition <span class="free">A</span> <span class="bound">a</span> <span class="bound">p</span> <span class="main">:::</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> list_set_rel<span class="main">)</span> <span class="main">:::</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> ahs_rel <span class="free">bhc</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> g_V0 <span class="main">=</span> initial <span class="free">A</span><span class="main">,</span>
      igbg_num_acc <span class="main">=</span> <span class="main">1</span><span class="main">,</span> igbg_acc <span class="main">=</span> <span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="keyword1">if</span> accepting <span class="free">A</span> <span class="bound">p</span> <span class="keyword1">then</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span> <span class="main">⦈</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> nba_g_def nba_igbg_def nba.successors_alt_def CAST_def id_apply <span class="dynamic"><span class="dynamic">autoref_tag_defs</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> graph_rec.defs
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">schematic_goal</span></span> nbai_igbgi<span class="main">:</span>
      <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="operator">autoref_ga_rules</span><span class="main">]</span> <span class="main">=</span> map2set_to_list
      <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'statei</span> <span class="main">×</span> <span class="tfree">'state</span><span class="main">)</span> set"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_ga_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_bounded_hashcode <span class="free">S</span> <span class="free">seq</span> <span class="free">bhc</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_ga_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_valid_def_hm_size <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'statei</span><span class="main">)</span> <span class="free">hms</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">seq</span><span class="main">,</span> HOL.eq<span class="main">)</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> bool_rel"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ai</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nbai_nba_rel"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?f</span> <span class="main">::</span> <span class="tvar">?'a</span><span class="main">,</span> RETURN <span class="main">(</span>nba_igbg <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> nba_igbg_ahs<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> bhc <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">bhc</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">autoref_monadic</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">plain</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">nbai_igbgi</span> <span class="keyword2"><span class="keyword">uses</span></span> nbai_igbgi
    <span class="keyword1" id="NBA_Algorithms-nbai_igbgi_refine"><span class="command">lemma</span></span> nbai_igbgi_refine<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'statei</span> <span class="main">×</span> <span class="tfree">'state</span><span class="main">)</span> set"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SIDE_GEN_ALGO <span class="main">(</span>is_bounded_hashcode <span class="free">S</span> <span class="free">seq</span> <span class="free">bhc</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SIDE_GEN_ALGO <span class="main">(</span>is_valid_def_hm_size <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'statei</span><span class="main">)</span> <span class="free">hms</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"GEN_OP <span class="free">seq</span> HOL.eq <span class="main">(</span><span class="free">S</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> bool_rel<span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>NBA_Algorithms.nbai_igbgi <span class="free">seq</span> <span class="free">bhc</span> <span class="free">hms</span><span class="main">,</span> nba_igbg<span class="main">)</span> <span class="main">∈</span>
        <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nbai_nba_rel <span class="main">→</span> igbg_impl_rel_ext unit_rel <span class="free">S</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> nbai_igbgi.refine<span class="main">[</span><span class="operator">THEN</span> RETURN_nres_relD<span class="main">]</span> assms <span class="keyword1"><span class="command">unfolding</span></span> <span class="dynamic"><span class="dynamic">autoref_tag_defs</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">schematic_goal</span></span> nba_language_empty<span class="main">:</span>
      <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'statei</span> <span class="main">×</span> <span class="tfree">'state</span><span class="main">)</span> set"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"igb_fr_graph <span class="main">(</span>nba_igbg <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_ga_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_bounded_hashcode <span class="free">S</span> <span class="free">seq</span> <span class="free">bhs</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_ga_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_valid_def_hm_size <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'statei</span><span class="main">)</span> <span class="free">hms</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">seq</span><span class="main">,</span> HOL.eq<span class="main">)</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> bool_rel"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ai</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nbai_nba_rel"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?f</span> <span class="main">::</span> <span class="tvar">?'a</span><span class="main">,</span> <span class="keyword1">do</span> <span class="main">{</span> <span class="bound">r</span> <span class="main">←</span> op_find_lasso_spec <span class="main">(</span>nba_igbg <span class="free">A</span><span class="main">)</span><span class="main">;</span> RETURN <span class="main">(</span><span class="bound">r</span> <span class="main">=</span> None<span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">autoref_monadic</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">plain</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">nba_language_empty</span> <span class="keyword2"><span class="keyword">uses</span></span> nba_language_empty
    <span class="keyword1" id="NBA_Algorithms-nba_language_empty_refine"><span class="command">lemma</span></span> nba_language_empty_refine<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'statei</span> <span class="main">×</span> <span class="tfree">'state</span><span class="main">)</span> set"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SIDE_PRECOND <span class="main">(</span>finite <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SIDE_GEN_ALGO <span class="main">(</span>is_bounded_hashcode <span class="free">S</span> <span class="free">seq</span> <span class="free">bhc</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SIDE_GEN_ALGO <span class="main">(</span>is_valid_def_hm_size <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'statei</span><span class="main">)</span> <span class="free">hms</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"GEN_OP <span class="free">seq</span> HOL.eq <span class="main">(</span><span class="free">S</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> bool_rel<span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ai</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nbai_nba_rel"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>NBA_Algorithms.nba_language_empty <span class="free">seq</span> <span class="free">bhc</span> <span class="free">hms</span> <span class="free">Ai</span><span class="main">,</span>
        <span class="main">(</span><span class="keyword1">OP</span> op_language_empty <span class="main">:::</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nbai_nba_rel <span class="main">→</span> bool_rel<span class="main">)</span> <span class="main">$</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> bool_rel"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"nodes <span class="free">A</span> <span class="main">=</span> op_reachable <span class="main">(</span>nba_g <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nba_g_V0 nba_g_E_rtrancl<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span>g_E <span class="main">(</span>nba_g <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> g_V0 <span class="main">(</span>nba_g <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">interpret</span></span> igb_fr_graph <span class="quoted"><span class="quoted">"nba_igbg <span class="free">A</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">unfolding</span></span> nba_igbg_def nba_g_def graph_rec.defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>RETURN <span class="main">(</span>NBA_Algorithms.nba_language_empty <span class="free">seq</span> <span class="free">bhc</span> <span class="free">hms</span> <span class="free">Ai</span><span class="main">)</span><span class="main">,</span>
        <span class="keyword1">do</span> <span class="main">{</span> <span class="bound">r</span> <span class="main">←</span> find_lasso_spec<span class="main">;</span> RETURN <span class="main">(</span><span class="bound">r</span> <span class="main">=</span> None<span class="main">)</span> <span class="main">}</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>bool_rel<span class="main">⟩</span> nres_rel"</span></span>
        <span class="keyword1"><span class="command">using</span></span> nba_language_empty.refine assms igb_fr_graph_axioms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">do</span> <span class="main">{</span> <span class="bound">r</span> <span class="main">←</span> find_lasso_spec<span class="main">;</span> RETURN <span class="main">(</span><span class="bound">r</span> <span class="main">=</span> None<span class="main">)</span> <span class="main">}</span><span class="main">,</span>
        RETURN <span class="main">(</span><span class="main">¬</span> Ex is_lasso_prpl<span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>bool_rel<span class="main">⟩</span> nres_rel"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> find_lasso_spec_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">refine_vcg</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"NBA_Algorithms.nba_language_empty <span class="free">seq</span> <span class="free">bhc</span> <span class="free">hms</span> <span class="free">Ai</span> <span class="main">⟷</span> <span class="main">¬</span> Ex is_lasso_prpl"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> nres_rel_comp <span class="keyword1"><span class="command">using</span></span> RETURN_nres_relD <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="main">¬</span> Ex is_acc_run"</span></span> <span class="keyword1"><span class="command">using</span></span> lasso_prpl_acc_run_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> language <span class="free">A</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> acc_run_language is_igb_graph <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="NBA_Explicit">
<div class="head">
<h1>Theory NBA_Explicit</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Explicit Nondeterministic Büchi Automata›</span></span>

<span class="keyword1"><span class="command">theory</span></span> NBA_Explicit
<span class="keyword2"><span class="keyword">imports</span></span> <a href="NBA_Algorithms.html">NBA_Algorithms</a>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> nbae <span class="main">=</span> nbae
    <span class="main">(</span><span class="free"><span class="entity">alphabete</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> set"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">initiale</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> set"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">transitione</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'state</span> <span class="main">×</span> <span class="tfree">'label</span> <span class="main">×</span> <span class="tfree">'state</span><span class="main">)</span> set"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">acceptinge</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> set"</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">nbae_rel</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="main">[</span><span class="operator">to_relAPP</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nbae_rel</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">.</span>
      <span class="main">(</span>alphabete <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> alphabete <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">⟩</span> set_rel <span class="main">∧</span>
      <span class="main">(</span>initiale <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> initiale <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">⟩</span> set_rel <span class="main">∧</span>
      <span class="main">(</span>transitione <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> transitione <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">⟩</span> set_rel <span class="main">∧</span>
      <span class="main">(</span>acceptinge <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> acceptinge <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">⟩</span> set_rel<span class="main">}</span>"</span></span>

  <span class="keyword1" id="NBA_Explicit-nbae_param"><span class="command">lemma</span></span> nbae_param<span class="main">[</span><span class="operator">param</span><span class="main">,</span> <span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>nbae<span class="main">,</span> nbae<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">⟩</span> set_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> set_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">L</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">S</span><span class="main">⟩</span> set_rel <span class="main">→</span>
      <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> set_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nbae_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>alphabete<span class="main">,</span> alphabete<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nbae_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">L</span><span class="main">⟩</span> set_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>initiale<span class="main">,</span> initiale<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nbae_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> set_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>transitione<span class="main">,</span> transitione<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nbae_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">L</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">S</span><span class="main">⟩</span> set_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>acceptinge<span class="main">,</span> acceptinge<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nbae_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> set_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> nbae_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="NBA_Explicit-nbae_rel_id"><span class="command">lemma</span></span> nbae_rel_id<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Id<span class="main">,</span> Id<span class="main">⟩</span> nbae_rel <span class="main">=</span> Id"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> nbae_rel_def <span class="keyword1"><span class="command">using</span></span> nbae.expand <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="NBA_Explicit-nbae_rel_comp"><span class="command">lemma</span></span> nbae_rel_comp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">L<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">O</span> <span class="free">L<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">O</span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> nbae_rel <span class="main">=</span> <span class="main">⟨</span><span class="free">L<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">S<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> nbae_rel <span class="keyword1">O</span> <span class="main">⟨</span><span class="free">L<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> nbae_rel"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="skolem">B</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">O</span> <span class="free">L<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">O</span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> nbae_rel"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span>alphabete <span class="skolem">A</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> set_rel"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> alphabete <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> set_rel"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span>initiale <span class="skolem">A</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">S<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> set_rel"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b</span><span class="main">,</span> initiale <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">S<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> set_rel"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span>transitione <span class="skolem">A</span><span class="main">,</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">L<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">S<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> set_rel"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">,</span> transitione <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">S<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">L<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> set_rel"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span>acceptinge <span class="skolem">A</span><span class="main">,</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">S<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> set_rel"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">d</span><span class="main">,</span> acceptinge <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">S<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> set_rel"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> nbae_rel_def prod_rel_compp set_rel_compp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">S<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> nbae_rel <span class="keyword1">O</span> <span class="main">⟨</span><span class="free">L<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> nbae_rel"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> nbae <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">S<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> nbae_rel"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">unfolding</span></span> nbae_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nbae <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span> <span class="skolem">d</span><span class="main">,</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> nbae_rel"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">unfolding</span></span> nbae_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">C</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">O</span> <span class="free">L<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">S<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">O</span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> nbae_rel"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">S<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⟩</span> nbae_rel"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">B</span><span class="main">,</span> <span class="skolem">C</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">S<span class="hidden">⇩</span><sub>2</sub></span><span class="main">⟩</span> nbae_rel"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">C</span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> nbae_rel_def prod_rel_compp set_rel_compp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="comment1">(* TODO: why do we need all this setup? can't i_of_rel do the trick? *)</span>
  <span class="keyword1"><span class="command">consts</span></span> i_nbae_scheme <span class="main">::</span> <span class="quoted"><span class="quoted">"interface <span class="main">⇒</span> interface <span class="main">⇒</span> interface"</span></span>

  <span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1"><span class="command">interpretation</span></span> autoref_syn <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>

    <span class="keyword1" id="NBA_Explicit-nbae_scheme_itype"><span class="command">lemma</span></span> nbae_scheme_itype<span class="main">[</span><span class="operator">autoref_itype</span><span class="main">]</span><span class="main">:</span>
      <span class="quoted"><span class="quoted">"nbae <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">L</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_set <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">S</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_set <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">S</span><span class="main">,</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_prod<span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_prod<span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_set <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">S</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_set <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span>
        <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_nbae_scheme"</span></span>
      <span class="quoted"><span class="quoted">"alphabete <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_nbae_scheme <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">L</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_set"</span></span>
      <span class="quoted"><span class="quoted">"initiale <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_nbae_scheme <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">S</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_set"</span></span>
      <span class="quoted"><span class="quoted">"transitione <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_nbae_scheme <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">S</span><span class="main">,</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_prod<span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_prod<span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_set"</span></span>
      <span class="quoted"><span class="quoted">"acceptinge <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_nbae_scheme <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">S</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_set"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> nbaei <span class="main">=</span> nbaei
    <span class="main">(</span><span class="free"><span class="entity">alphabetei</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> list"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">initialei</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> list"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">transitionei</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'state</span> <span class="main">×</span> <span class="tfree">'label</span> <span class="main">×</span> <span class="tfree">'state</span><span class="main">)</span> list"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">acceptingei</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> list"</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">nbaei_rel</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="main">[</span><span class="operator">to_relAPP</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nbaei_rel</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">.</span>
      <span class="main">(</span>alphabetei <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> alphabetei <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">⟩</span> list_rel <span class="main">∧</span>
      <span class="main">(</span>initialei <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> initialei <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">⟩</span> list_rel <span class="main">∧</span>
      <span class="main">(</span>transitionei <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> transitionei <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">⟩</span> list_rel <span class="main">∧</span>
      <span class="main">(</span>acceptingei <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> acceptingei <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">⟩</span> list_rel<span class="main">}</span>"</span></span>

  <span class="keyword1" id="NBA_Explicit-nbaei_param"><span class="command">lemma</span></span> nbaei_param<span class="main">[</span><span class="operator">param</span><span class="main">,</span> <span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>nbaei<span class="main">,</span> nbaei<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">⟩</span> list_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> list_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">L</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">S</span><span class="main">⟩</span> list_rel <span class="main">→</span>
      <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> list_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nbaei_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>alphabetei<span class="main">,</span> alphabetei<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nbaei_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">L</span><span class="main">⟩</span> list_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>initialei<span class="main">,</span> initialei<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nbaei_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> list_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>transitionei<span class="main">,</span> transitionei<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nbaei_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">L</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">S</span><span class="main">⟩</span> list_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>acceptingei<span class="main">,</span> acceptingei<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nbaei_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> list_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> nbaei_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">nbaei_nbae_rel</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="main">[</span><span class="operator">to_relAPP</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nbaei_nbae_rel</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">.</span>
      <span class="main">(</span>alphabetei <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> alphabete <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">⟩</span> list_set_rel <span class="main">∧</span>
      <span class="main">(</span>initialei <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> initiale <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">⟩</span> list_set_rel <span class="main">∧</span>
      <span class="main">(</span>transitionei <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> transitione <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">⟩</span> list_set_rel <span class="main">∧</span>
      <span class="main">(</span>acceptingei <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> acceptinge <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">⟩</span> list_set_rel<span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rel_intf</span><span class="main">]</span> <span class="main">=</span> REL_INTFI<span class="main">[</span><span class="operator">of</span> <span class="quoted">nbaei_nbae_rel</span> <span class="quoted">i_nbae_scheme</span><span class="main">]</span>

  <span class="keyword1" id="NBA_Explicit-nbaei_nbae_param"><span class="command">lemma</span></span> nbaei_nbae_param<span class="main">[</span><span class="operator">param</span><span class="main">,</span> <span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>nbaei<span class="main">,</span> nbae<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">⟩</span> list_set_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> list_set_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">L</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">S</span><span class="main">⟩</span> list_set_rel <span class="main">→</span>
      <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> list_set_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nbaei_nbae_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>alphabetei<span class="main">,</span> alphabete<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nbaei_nbae_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">L</span><span class="main">⟩</span> list_set_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>initialei<span class="main">,</span> initiale<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nbaei_nbae_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> list_set_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>transitionei<span class="main">,</span> transitione<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nbaei_nbae_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">L</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">S</span><span class="main">⟩</span> list_set_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>acceptingei<span class="main">,</span> acceptinge<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nbaei_nbae_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> list_set_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> nbaei_nbae_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">nbaei_nbae</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">nbaei_nbae</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> nbae <span class="main">(</span>set <span class="main">(</span>alphabetei <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>initialei <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>set <span class="main">(</span>transitionei <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>acceptingei <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="NBA_Explicit-nbaei_nbae_id_param"><span class="command">lemma</span></span> nbaei_nbae_id_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nbaei_nbae<span class="main">,</span> id<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nbaei_nbae_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nbae_rel"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Ai</span> <span class="skolem">A</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Ai</span><span class="main">,</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nbaei_nbae_rel"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"nbaei_nbae <span class="skolem">Ai</span> <span class="main">=</span> nbae <span class="main">(</span>set <span class="main">(</span>alphabetei <span class="skolem">Ai</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>initialei <span class="skolem">Ai</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>set <span class="main">(</span>transitionei <span class="skolem">Ai</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>acceptingei <span class="skolem">Ai</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> nbaei_nbae_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"id <span class="skolem">A</span> <span class="main">=</span> nbae <span class="main">(</span>id <span class="main">(</span>alphabete <span class="skolem">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>id <span class="main">(</span>initiale <span class="skolem">A</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>id <span class="main">(</span>transitione <span class="skolem">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>id <span class="main">(</span>acceptinge <span class="skolem">A</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nbaei_nbae <span class="skolem">Ai</span><span class="main">,</span> id <span class="skolem">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nbae_rel"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 2 3 <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">transitions</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">⋃</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">.</span> <span class="main">⋃</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">.</span> <span class="main">{</span><span class="bound">p</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span> <span class="main">×</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">a</span> <span class="bound">p</span>"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">succs</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">``</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">``</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">nba_nbae</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">nba_nbae</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> nbae <span class="main">(</span>alphabet <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span>initial <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>
    <span class="main">(</span>transitions <span class="main">(</span>alphabet <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span>nodes <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span>transition <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Set.filter <span class="main">(</span>accepting <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span>nodes <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">nbae_nba</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">nbae_nba</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> nba <span class="main">(</span>alphabete <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span>initiale <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>
    <span class="main">(</span>succs <span class="main">(</span>transitione <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> acceptinge <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="NBA_Explicit-nba_nbae_param"><span class="command">lemma</span></span> nba_nbae_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nba_nbae<span class="main">,</span> nba_nbae<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nba_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nbae_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> nba_nbae_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
  <span class="keyword1" id="NBA_Explicit-nbae_nba_param"><span class="command">lemma</span></span> nbae_nba_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bijective <span class="free">L</span>"</span></span> <span class="quoted"><span class="quoted">"bijective <span class="free">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nbae_nba<span class="main">,</span> nbae_nba<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nbae_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nba_rel"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> bijective_alt<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> nbae_nba_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span> <span class="operator">auto</span>

  <span class="keyword1" id="NBA_Explicit-nbae_nba_nba_nbae_param"><span class="command">lemma</span></span> nbae_nba_nba_nbae_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>nbae_nba <span class="main">∘</span> nba_nbae<span class="main">)</span> <span class="free">A</span><span class="main">,</span> id <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id_on <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span><span class="main">,</span> Id_on <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span><span class="main">⟩</span> nba_rel"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nbae_nba <span class="main">∘</span> nba_nbae<span class="main">)</span> <span class="free">A</span> <span class="main">=</span> nba <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span> <span class="main">(</span>initial <span class="free">A</span><span class="main">)</span>
      <span class="main">(</span>succs <span class="main">(</span>transitions <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span> <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span> <span class="main">(</span>transition <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> Set.filter <span class="main">(</span>accepting <span class="free">A</span><span class="main">)</span> <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> nbae_nba_def nba_nbae_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">…</span><span class="main">,</span> nba <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span> <span class="main">(</span>initial <span class="free">A</span><span class="main">)</span> <span class="main">(</span>transition <span class="free">A</span><span class="main">)</span> <span class="main">(</span>accepting <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span>
      <span class="main">⟨</span>Id_on <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span><span class="main">,</span> Id_on <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span><span class="main">⟩</span> nba_rel"</span></span>
      <span class="keyword1"><span class="command">using</span></span> nba_rel_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"nba <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span> <span class="main">(</span>initial <span class="free">A</span><span class="main">)</span> <span class="main">(</span>transition <span class="free">A</span><span class="main">)</span> <span class="main">(</span>accepting <span class="free">A</span><span class="main">)</span> <span class="main">=</span> id <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">nbaei_nba_rel</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="main">[</span><span class="operator">to_relAPP</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nbaei_nba_rel</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">Ae</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>nbae_nba <span class="main">(</span>nbaei_nbae <span class="bound">Ae</span><span class="main">)</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">⟩</span> nba_rel<span class="main">}</span>"</span></span>
  <span class="keyword1" id="NBA_Explicit-nbaei_nba_id"><span class="command">lemma</span></span> nbaei_nba_id<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nbae_nba <span class="main">∘</span> nbaei_nbae<span class="main">,</span> id<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nbaei_nba_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nba_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> nbaei_nba_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">schematic_goal</span></span> nbae_nba_impl<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">leq</span><span class="main">,</span> HOL.eq<span class="main">)</span> <span class="main">∈</span> <span class="free">L</span> <span class="main">→</span> <span class="free">L</span> <span class="main">→</span> bool_rel"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">seq</span><span class="main">,</span> HOL.eq<span class="main">)</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> bool_rel"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?f</span><span class="main">,</span> nbae_nba<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nbaei_nbae_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nbai_nba_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> nbae_nba_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">autoref</span>
  <span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">nbae_nba_impl</span> <span class="keyword2"><span class="keyword">uses</span></span> nbae_nba_impl
  <span class="keyword1" id="NBA_Explicit-nbae_nba_impl_refine"><span class="command">lemma</span></span> nbae_nba_impl_refine<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"GEN_OP <span class="free">leq</span> HOL.eq <span class="main">(</span><span class="free">L</span> <span class="main">→</span> <span class="free">L</span> <span class="main">→</span> bool_rel<span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"GEN_OP <span class="free">seq</span> HOL.eq <span class="main">(</span><span class="free">S</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> bool_rel<span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nbae_nba_impl <span class="free">leq</span> <span class="free">seq</span><span class="main">,</span> nbae_nba<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nbaei_nbae_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nbai_nba_rel"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nbae_nba_impl.refine assms <span class="keyword1"><span class="command">unfolding</span></span> <span class="dynamic"><span class="dynamic">autoref_tag_defs</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="NBA_Translate">
<div class="head">
<h1>Theory NBA_Translate</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Explore and Enumerate Nodes of Nondeterministic Büchi Automata›</span></span>

<span class="keyword1"><span class="command">theory</span></span> NBA_Translate
<span class="keyword2"><span class="keyword">imports</span></span> <a href="NBA_Explicit.html">NBA_Explicit</a>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Syntax›</span></span>

  <span class="comment1">(* TODO: this syntax has unnecessarily high inner binding strength, requiring extra parentheses
    the regular let syntax correctly uses inner binding strength 0: ("(2_ =/ _)" 10) *)</span>
  <span class="keyword1"><span class="command">no_syntax</span></span> <span class="quoted">"_do_let"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>pttrn<span class="main">,</span> <span class="tfree">'a</span><span class="main">]</span> <span class="main">⇒</span> do_bind"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(2</span><span class="keyword1">let</span> _ <span class="keyword1">=</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>1000<span class="main">,</span> 13<span class="main">]</span> 13<span class="main">)</span>
  <span class="keyword1"><span class="command">syntax</span></span> <span class="quoted">"_do_let"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>pttrn<span class="main">,</span> <span class="tfree">'a</span><span class="main">]</span> <span class="main">⇒</span> do_bind"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(2</span><span class="keyword1">let</span> _ <span class="keyword1">=</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> 13<span class="main">)</span>

  <span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Image on Explicit Automata›</span></span>

  <span class="comment1">(* TODO: this should not be needed, only use nba_image *)</span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">nbae_image</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">nbae_image</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> nbae <span class="main">(</span>alphabete <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">`</span> initiale <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>
    <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">p</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> transitione <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">`</span> acceptinge <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="NBA_Translate-nbae_image_param"><span class="command">lemma</span></span> nbae_image_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nbae_image<span class="main">,</span> nbae_image<span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">S</span> <span class="main">→</span> <span class="free">T</span><span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nbae_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">T</span><span class="main">⟩</span> nbae_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> nbae_image_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>

  <span class="keyword1" id="NBA_Translate-nbae_image_id"><span class="command">lemma</span></span> nbae_image_id<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"nbae_image id <span class="main">=</span> id"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> nbae_image_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="NBA_Translate-nbae_image_nba_nbae"><span class="command">lemma</span></span> nbae_image_nba_nbae<span class="main">:</span> <span class="quoted"><span class="quoted">"nbae_image <span class="free">f</span> <span class="main">(</span>nba_nbae <span class="free">A</span><span class="main">)</span> <span class="main">=</span> nbae
    <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">`</span> initial <span class="free">A</span><span class="main">)</span>
    <span class="main">(</span><span class="main">⋃</span> <span class="bound">p</span> <span class="main">∈</span> nodes <span class="free">A</span><span class="main">.</span> <span class="main">⋃</span> <span class="bound">a</span> <span class="main">∈</span> alphabet <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="bound">p</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span> <span class="main">×</span> <span class="free">f</span> <span class="main">`</span> transition <span class="free">A</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">)</span>
    <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> nodes <span class="free">A</span><span class="main">.</span> accepting <span class="free">A</span> <span class="bound">p</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> nba_nbae_def nbae_image_def nbae.simps Set.filter_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Exploration and Translation›</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">trans_spec</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">trans_spec</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">⋃</span> <span class="bound">p</span> <span class="main">∈</span> nodes <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> <span class="main">⋃</span> <span class="bound">a</span> <span class="main">∈</span> alphabet <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">`</span> <span class="main">{</span><span class="bound">p</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span> <span class="main">×</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">`</span> transition <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">a</span> <span class="bound">p</span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">trans_algo</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">trans_algo</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span>
      FOREACH <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span> <span class="bound">T</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
        ASSERT <span class="main">(</span><span class="bound">p</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span><span class="main">;</span>
        FOREACH <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="bound">T</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
          ASSERT <span class="main">(</span><span class="bound">a</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">)</span><span class="main">;</span>
          FOREACH <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="bound">a</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">q</span> <span class="bound">T</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
            ASSERT <span class="main">(</span><span class="bound">q</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="bound">a</span> <span class="bound">p</span><span class="main">)</span><span class="main">;</span>
            ASSERT <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">p</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">q</span><span class="main">)</span> <span class="main">∉</span> <span class="bound">T</span><span class="main">)</span><span class="main">;</span>
            RETURN <span class="main">(</span>insert <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">p</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">q</span><span class="main">)</span> <span class="bound">T</span><span class="main">)</span> <span class="main">}</span>
          <span class="main">)</span> <span class="bound">T</span> <span class="main">}</span>
        <span class="main">)</span> <span class="bound">T</span> <span class="main">}</span>
      <span class="main">)</span> <span class="main">{}</span>"</span></span>

  <span class="keyword1" id="NBA_Translate-trans_algo_refine"><span class="command">lemma</span></span> trans_algo_refine<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">=</span> nodes <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">=</span> alphabet <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">=</span> transition <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>trans_algo <span class="free">N</span> <span class="free">L</span> <span class="free">S</span> <span class="free">f</span><span class="main">,</span> SPEC <span class="main">(</span>HOL.eq <span class="main">(</span>trans_spec <span class="free">A</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id<span class="main">⟩</span> nres_rel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> trans_algo_def trans_spec_def assms<span class="main">(</span>4-6<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">refine_vcg</span> FOREACH_rule_insert_eq<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span> <span class="bound">p</span> <span class="main">∈</span> nodes <span class="free">A</span><span class="main">.</span> <span class="main">⋃</span> <span class="bound">a</span> <span class="main">∈</span> alphabet <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="bound">p</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span> <span class="main">×</span> <span class="free">f</span> <span class="main">`</span> transition <span class="free">A</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="main">⋃</span> <span class="bound">p</span> <span class="main">∈</span> nodes <span class="free">A</span><span class="main">.</span> <span class="main">⋃</span> <span class="bound">a</span> <span class="main">∈</span> alphabet <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="bound">p</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span> <span class="main">×</span> <span class="free">f</span> <span class="main">`</span> transition <span class="free">A</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">{}</span><span class="main">.</span> <span class="main">⋃</span> <span class="bound">a</span> <span class="main">∈</span> alphabet <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="bound">p</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span> <span class="main">×</span> <span class="free">f</span> <span class="main">`</span> transition <span class="free">A</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">T</span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">⊆</span> nodes <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> nodes <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">T</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span> <span class="bound">a</span> <span class="main">∈</span> <span class="main">{}</span><span class="main">.</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span> <span class="main">×</span> <span class="free">f</span> <span class="main">`</span> transition <span class="free">A</span> <span class="bound">a</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∪</span>
      <span class="main">(</span><span class="main">⋃</span> <span class="bound">p</span> <span class="main">∈</span> <span class="skolem">T</span><span class="main">.</span> <span class="main">⋃</span> <span class="bound">a</span> <span class="main">∈</span> alphabet <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="bound">p</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span> <span class="main">×</span> <span class="free">f</span> <span class="main">`</span> transition <span class="free">A</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="main">⋃</span> <span class="bound">p</span> <span class="main">∈</span> <span class="skolem">T</span><span class="main">.</span> <span class="main">⋃</span> <span class="bound">a</span> <span class="main">∈</span> alphabet <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="bound">p</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span> <span class="main">×</span> <span class="free">f</span> <span class="main">`</span> transition <span class="free">A</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span> <span class="bound">a</span> <span class="main">∈</span> alphabet <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span> <span class="main">×</span> <span class="free">f</span> <span class="main">`</span> transition <span class="free">A</span> <span class="bound">a</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∪</span>
      <span class="main">(</span><span class="main">⋃</span> <span class="bound">p</span> <span class="main">∈</span> <span class="skolem">T</span><span class="main">.</span> <span class="main">⋃</span> <span class="bound">a</span> <span class="main">∈</span> alphabet <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="bound">p</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span> <span class="main">×</span> <span class="free">f</span> <span class="main">`</span> transition <span class="free">A</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="main">⋃</span> <span class="bound">p</span> <span class="main">∈</span> insert <span class="skolem">x</span> <span class="skolem">T</span><span class="main">.</span> <span class="main">⋃</span> <span class="bound">a</span> <span class="main">∈</span> alphabet <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="bound">p</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span> <span class="main">×</span> <span class="free">f</span> <span class="main">`</span> transition <span class="free">A</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Ta</span> <span class="skolem">xa</span>
    <span class="keyword3"><span class="command">assume</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Ta</span> <span class="main">⊆</span> alphabet <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">∈</span> alphabet <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">∉</span> <span class="skolem">Ta</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>transition <span class="free">A</span> <span class="skolem">xa</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> infinite_subset nba.nodes_transition subsetI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="skolem">xa</span><span class="main">}</span> <span class="main">×</span> <span class="free">f</span> <span class="main">`</span> transition <span class="free">A</span> <span class="skolem">xa</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∪</span>
      <span class="main">(</span><span class="main">⋃</span> <span class="bound">a</span> <span class="main">∈</span> <span class="skolem">Ta</span><span class="main">.</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span> <span class="main">×</span> <span class="free">f</span> <span class="main">`</span> transition <span class="free">A</span> <span class="bound">a</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∪</span>
      <span class="main">(</span><span class="main">⋃</span> <span class="bound">p</span> <span class="main">∈</span> <span class="skolem">T</span><span class="main">.</span> <span class="main">⋃</span> <span class="bound">a</span> <span class="main">∈</span> alphabet <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="bound">p</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span> <span class="main">×</span> <span class="free">f</span> <span class="main">`</span> transition <span class="free">A</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="main">⋃</span> <span class="bound">a</span> <span class="main">∈</span> insert <span class="skolem">xa</span> <span class="skolem">Ta</span><span class="main">.</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span> <span class="main">×</span> <span class="free">f</span> <span class="main">`</span> transition <span class="free">A</span> <span class="bound">a</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∪</span>
      <span class="main">(</span><span class="main">⋃</span> <span class="bound">p</span> <span class="main">∈</span> <span class="skolem">T</span><span class="main">.</span> <span class="main">⋃</span> <span class="bound">a</span> <span class="main">∈</span> alphabet <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="bound">p</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span> <span class="main">×</span> <span class="free">f</span> <span class="main">`</span> transition <span class="free">A</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="skolem">xa</span><span class="main">}</span> <span class="main">×</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∪</span>
      <span class="main">(</span><span class="main">⋃</span> <span class="bound">a</span> <span class="main">∈</span> <span class="skolem">Ta</span><span class="main">.</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span> <span class="main">×</span> <span class="free">f</span> <span class="main">`</span> transition <span class="free">A</span> <span class="bound">a</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∪</span>
      <span class="main">(</span><span class="main">⋃</span> <span class="bound">p</span> <span class="main">∈</span> <span class="skolem">T</span><span class="main">.</span> <span class="main">⋃</span> <span class="bound">a</span> <span class="main">∈</span> alphabet <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="bound">p</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span> <span class="main">×</span> <span class="free">f</span> <span class="main">`</span> transition <span class="free">A</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="main">⋃</span> <span class="bound">a</span> <span class="main">∈</span> <span class="skolem">Ta</span><span class="main">.</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span> <span class="main">×</span> <span class="free">f</span> <span class="main">`</span> transition <span class="free">A</span> <span class="bound">a</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∪</span>
      <span class="main">(</span><span class="main">⋃</span> <span class="bound">p</span> <span class="main">∈</span> <span class="skolem">T</span><span class="main">.</span> <span class="main">⋃</span> <span class="bound">a</span> <span class="main">∈</span> alphabet <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="bound">p</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span> <span class="main">×</span> <span class="free">f</span> <span class="main">`</span> transition <span class="free">A</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Tb</span> <span class="skolem">xb</span>
    <span class="keyword3"><span class="command">assume</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Tb</span> <span class="main">⊆</span> transition <span class="free">A</span> <span class="skolem">xa</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xb</span> <span class="main">∈</span> transition <span class="free">A</span> <span class="skolem">xa</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xb</span> <span class="main">∉</span> <span class="skolem">Tb</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">xa</span><span class="main">,</span> <span class="free">f</span> <span class="skolem">xb</span><span class="main">)</span> <span class="main">∉</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="skolem">xa</span><span class="main">}</span> <span class="main">×</span> <span class="free">f</span> <span class="main">`</span> <span class="skolem">Tb</span> <span class="main">∪</span>
      <span class="main">(</span><span class="main">⋃</span> <span class="bound">a</span> <span class="main">∈</span> <span class="skolem">Ta</span><span class="main">.</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span> <span class="main">×</span> <span class="free">f</span> <span class="main">`</span> transition <span class="free">A</span> <span class="bound">a</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∪</span>
      <span class="main">(</span><span class="main">⋃</span> <span class="bound">p</span> <span class="main">∈</span> <span class="skolem">T</span><span class="main">.</span> <span class="main">⋃</span> <span class="bound">a</span> <span class="main">∈</span> alphabet <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="bound">p</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span> <span class="main">×</span> <span class="free">f</span> <span class="main">`</span> transition <span class="free">A</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 2 3 assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> inj_onD<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="skolem">xa</span><span class="main">}</span> <span class="main">×</span> <span class="free">f</span> <span class="main">`</span> insert <span class="skolem">xb</span> <span class="skolem">Tb</span> <span class="main">∪</span>
      <span class="main">(</span><span class="main">⋃</span> <span class="bound">a</span> <span class="main">∈</span> <span class="skolem">Ta</span><span class="main">.</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span> <span class="main">×</span> <span class="free">f</span> <span class="main">`</span> transition <span class="free">A</span> <span class="bound">a</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∪</span>
      <span class="main">(</span><span class="main">⋃</span> <span class="bound">p</span> <span class="main">∈</span> <span class="skolem">T</span><span class="main">.</span> <span class="main">⋃</span> <span class="bound">a</span> <span class="main">∈</span> alphabet <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="bound">p</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span> <span class="main">×</span> <span class="free">f</span> <span class="main">`</span> transition <span class="free">A</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span>
      insert <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">xa</span><span class="main">,</span> <span class="free">f</span> <span class="skolem">xb</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="skolem">xa</span><span class="main">}</span> <span class="main">×</span> <span class="free">f</span> <span class="main">`</span> <span class="skolem">Tb</span> <span class="main">∪</span>
      <span class="main">(</span><span class="main">⋃</span> <span class="bound">a</span> <span class="main">∈</span> <span class="skolem">Ta</span><span class="main">.</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span> <span class="main">×</span> <span class="free">f</span> <span class="main">`</span> transition <span class="free">A</span> <span class="bound">a</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∪</span>
      <span class="main">(</span><span class="main">⋃</span> <span class="bound">p</span> <span class="main">∈</span> <span class="skolem">T</span><span class="main">.</span> <span class="main">⋃</span> <span class="bound">a</span> <span class="main">∈</span> alphabet <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="bound">p</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span> <span class="main">×</span> <span class="free">f</span> <span class="main">`</span> transition <span class="free">A</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="comment1">(* TODO: move this to nondeterministic automaton
    there, it will have to be treated more elementarily
    at least until we abstract from NBA_Refine to do that there aswell *)</span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">nba_image</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'state<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⇒</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> nba <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> nba"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">nba_image</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> nba
      <span class="main">(</span>alphabet <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>
      <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">`</span> initial <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>
      <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">`</span> transition <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">a</span> <span class="main">(</span>inv_into <span class="main">(</span>nodes <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> accepting <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>inv_into <span class="main">(</span>nodes <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="NBA_Translate-nba_image_rel"><span class="command">lemma</span></span> nba_image_rel<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span> nba_image <span class="free">f</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id_on <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span><span class="main">,</span> br <span class="free">f</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> nodes <span class="free">A</span><span class="main">)</span><span class="main">⟩</span> nba_rel"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> nba <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span> <span class="main">(</span>initial <span class="free">A</span><span class="main">)</span> <span class="main">(</span>transition <span class="free">A</span><span class="main">)</span> <span class="main">(</span>accepting <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">…</span><span class="main">,</span> nba_image <span class="free">f</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id_on <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span><span class="main">,</span> br <span class="free">f</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> nodes <span class="free">A</span><span class="main">)</span><span class="main">⟩</span> nba_rel"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> nba_image_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">parametricity</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> nba_rel_eq <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_br_conv br_set_rel_alt<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="NBA_Translate-nba_image_nodes"><span class="command">lemma</span></span> nba_image_nodes<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nodes <span class="main">(</span>nba_image <span class="free">f</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">`</span> nodes <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nodes <span class="free">A</span><span class="main">,</span> nodes <span class="main">(</span>nba_image <span class="free">f</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>br <span class="free">f</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> nodes <span class="free">A</span><span class="main">)</span><span class="main">⟩</span> set_rel"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> br_set_rel_alt <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="NBA_Translate-nba_image_language"><span class="command">lemma</span></span> nba_image_language<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"language <span class="main">(</span>nba_image <span class="free">f</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> language <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>language <span class="free">A</span><span class="main">,</span> language <span class="main">(</span>nba_image <span class="free">f</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="main">⟨</span>Id_on <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span><span class="main">⟩</span> stream_rel<span class="main">⟩</span> set_rel"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="NBA_Translate-nba_image_nbae"><span class="command">lemma</span></span> nba_image_nbae<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nbae_image <span class="free">f</span> <span class="main">(</span>nba_nbae <span class="free">A</span><span class="main">)</span> <span class="main">=</span> nba_nbae <span class="main">(</span>nba_image <span class="free">f</span> <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> nbae_image_nba_nbae
    <span class="keyword1"><span class="command">unfolding</span></span> nba_nbae_def
    <span class="keyword1"><span class="command">unfolding</span></span> nba_image_nodes<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> nbae.simps
    <span class="keyword1"><span class="command">unfolding</span></span> nba_image_def
    <span class="keyword1"><span class="command">unfolding</span></span> nba.sel
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="comment1">(* TODO: with this, maybe much of the nbae infrastructure is obsolete?
    since now there is very little happening in terms of relations, maybe we can even make do
    with just the abstraction function *)</span>
  <span class="comment1">(* TODO: maybe the specification for translation is just that the translated automaton
    is related in ⟨Id_on (alphabet A), ???⟩ nba_rel? *)</span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">op_translate</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> nba <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> nat<span class="main">)</span> nbae nres"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">op_translate</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> SPEC <span class="main">(</span><span class="main">λ</span> <span class="bound">B</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">f</span><span class="main">.</span> inj_on <span class="bound">f</span> <span class="main">(</span>nodes <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="bound">B</span> <span class="main">=</span> nba_nbae <span class="main">(</span>nba_image <span class="bound">f</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="NBA_Translate-op_translate_language"><span class="command">lemma</span></span> op_translate_language<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>RETURN <span class="free">Ai</span><span class="main">,</span> op_translate <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="main">⟨</span>Id<span class="main">,</span> nat_rel<span class="main">⟩</span> nbaei_nbae_rel<span class="main">⟩</span> nres_rel"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"language <span class="main">(</span>nbae_nba <span class="main">(</span>nbaei_nbae <span class="free">Ai</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> language <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="comment1">(* TODO: can we leave all this inside the nres without explicit obtain? *)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ai</span><span class="main">,</span> nba_nbae <span class="main">(</span>nba_image <span class="skolem">f</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id<span class="main">,</span> nat_rel<span class="main">⟩</span> nbaei_nbae_rel"</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="skolem">f</span> <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">[</span><span class="operator">unfolded</span> in_nres_rel_iff op_translate_def<span class="main">,</span> <span class="operator">THEN</span> RETURN_ref_SPECD<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"nba_image <span class="skolem">f</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nbae_nba <span class="main">(</span>nbaei_nbae <span class="free">Ai</span><span class="main">)</span><span class="main">,</span> nbae_nba <span class="main">(</span>id <span class="main">(</span>nba_nbae <span class="var">?C</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id<span class="main">,</span> nat_rel<span class="main">⟩</span> nba_rel"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nbae_nba <span class="main">(</span>id <span class="main">(</span>nba_nbae <span class="var">?C</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>nbae_nba <span class="main">∘</span> nba_nbae<span class="main">)</span> <span class="var">?C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">…</span><span class="main">,</span> id <span class="var">?C</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id_on <span class="main">(</span>alphabet <span class="var">?C</span><span class="main">)</span><span class="main">,</span> Id_on <span class="main">(</span>nodes <span class="var">?C</span><span class="main">)</span><span class="main">⟩</span> nba_rel"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nbae_nba <span class="main">(</span>nbaei_nbae <span class="free">Ai</span><span class="main">)</span><span class="main">,</span> <span class="var">?C</span><span class="main">)</span> <span class="main">∈</span>
      <span class="main">⟨</span>Id_on <span class="main">(</span>alphabet <span class="var">?C</span><span class="main">)</span><span class="main">,</span> Id_on <span class="main">(</span>nodes <span class="var">?C</span><span class="main">)</span><span class="main">⟩</span> nba_rel"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>language <span class="main">(</span>nbae_nba <span class="main">(</span>nbaei_nbae <span class="free">Ai</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> language <span class="var">?C</span><span class="main">)</span> <span class="main">∈</span>
      <span class="main">⟨</span><span class="main">⟨</span>Id_on <span class="main">(</span>alphabet <span class="var">?C</span><span class="main">)</span><span class="main">⟩</span> stream_rel<span class="main">⟩</span> set_rel"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"language <span class="var">?C</span> <span class="main">=</span> language <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="comment1">(* TODO: make separate implementations for "nba_nbae" and "op_set_enumerate ⤜ nbae_image"
    make sure to do regression tests along the way *)</span>
  <span class="comment1">(* TODO: since we have translate_impl, maybe just having a good nba_nbae implementation is enough? *)</span>
  <span class="keyword1"><span class="command">schematic_goal</span></span> to_nbaei_impl<span class="main">:</span>
    <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'statei</span> <span class="main">×</span> <span class="tfree">'state</span><span class="main">)</span> set"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_ga_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_bounded_hashcode <span class="free">S</span> <span class="free">seq</span> <span class="free">bhc</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_ga_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_valid_def_hm_size <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'statei</span><span class="main">)</span> <span class="free">hms</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">seq</span><span class="main">,</span> HOL.eq<span class="main">)</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> bool_rel"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ai</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nbai_nba_rel"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?f</span> <span class="main">::</span> <span class="tvar">?'a</span><span class="main">,</span> <span class="keyword1">do</span> <span class="main">{</span>
        <span class="keyword1">let</span> <span class="bound">N</span> <span class="main">=</span> nodes <span class="free">A</span><span class="main">;</span>
        <span class="bound">f</span> <span class="main">←</span> op_set_enumerate <span class="bound">N</span><span class="main">;</span>
        ASSERT <span class="main">(</span>dom <span class="bound">f</span> <span class="main">=</span> <span class="bound">N</span><span class="main">)</span><span class="main">;</span>
        ASSERT <span class="main">(</span><span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> initial <span class="free">A</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">p</span> <span class="main">≠</span> None<span class="main">)</span><span class="main">;</span>
        ASSERT <span class="main">(</span><span class="main">∀</span> <span class="bound">a</span> <span class="main">∈</span> alphabet <span class="free">A</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> dom <span class="bound">f</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">q</span> <span class="main">∈</span> transition <span class="free">A</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">q</span> <span class="main">≠</span> None<span class="main">)</span><span class="main">;</span>
        <span class="bound">T</span> <span class="main">←</span> trans_algo <span class="bound">N</span> <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span> <span class="main">(</span>transition <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> the <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
        RETURN <span class="main">(</span>nbae <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> the <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> initial <span class="free">A</span><span class="main">)</span> <span class="bound">T</span>
          <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> the <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> <span class="bound">N</span><span class="main">.</span> accepting <span class="free">A</span> <span class="bound">p</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>
      <span class="main">}</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> trans_algo_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">autoref_monadic</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">plain</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">to_nbaei_impl</span> <span class="keyword2"><span class="keyword">uses</span></span> to_nbaei_impl

  <span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1"><span class="command">interpretation</span></span> autoref_syn <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>

    <span class="keyword1" id="NBA_Translate-to_nbaei_impl_refine"><span class="command">lemma</span></span> to_nbaei_impl_refine<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'statei</span> <span class="main">×</span> <span class="tfree">'state</span><span class="main">)</span> set"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SIDE_PRECOND <span class="main">(</span>finite <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SIDE_GEN_ALGO <span class="main">(</span>is_bounded_hashcode <span class="free">S</span> <span class="free">seq</span> <span class="free">bhc</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SIDE_GEN_ALGO <span class="main">(</span>is_valid_def_hm_size <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'statei</span><span class="main">)</span> <span class="free">hms</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"GEN_OP <span class="free">seq</span> HOL.eq <span class="main">(</span><span class="free">S</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> bool_rel<span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ai</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nbai_nba_rel"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>RETURN <span class="main">(</span>to_nbaei_impl <span class="free">seq</span> <span class="free">bhc</span> <span class="free">hms</span> <span class="free">Ai</span><span class="main">)</span><span class="main">,</span>
        <span class="main">(</span><span class="keyword1">OP</span> op_translate <span class="main">:::</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nbai_nba_rel <span class="main">→</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">L</span><span class="main">,</span> nat_rel<span class="main">⟩</span> nbaei_nbae_rel<span class="main">⟩</span> nres_rel<span class="main">)</span> <span class="main">$</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span>
        <span class="main">⟨</span><span class="main">⟨</span><span class="free">L</span><span class="main">,</span> nat_rel<span class="main">⟩</span> nbaei_nbae_rel<span class="main">⟩</span> nres_rel"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> nbai_nba_param<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">param_fo</span><span class="main">,</span> <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span> list_set_rel_finite
        <span class="keyword1"><span class="command">unfolding</span></span> finite_set_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">note</span></span> to_nbaei_impl.refine<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> <span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic">autoref_tag_defs</span></span></span></span></span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">do</span> <span class="main">{</span>
          <span class="keyword1">let</span> <span class="bound">N</span> <span class="main">=</span> nodes <span class="free">A</span><span class="main">;</span>
          <span class="bound">f</span> <span class="main">←</span> op_set_enumerate <span class="bound">N</span><span class="main">;</span>
          ASSERT <span class="main">(</span>dom <span class="bound">f</span> <span class="main">=</span> <span class="bound">N</span><span class="main">)</span><span class="main">;</span>
          ASSERT <span class="main">(</span><span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> initial <span class="free">A</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">p</span> <span class="main">≠</span> None<span class="main">)</span><span class="main">;</span>
          ASSERT <span class="main">(</span><span class="main">∀</span> <span class="bound">a</span> <span class="main">∈</span> alphabet <span class="free">A</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">p</span> <span class="main">∈</span> dom <span class="bound">f</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">q</span> <span class="main">∈</span> transition <span class="free">A</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">q</span> <span class="main">≠</span> None<span class="main">)</span><span class="main">;</span>
          <span class="bound">T</span> <span class="main">←</span> trans_algo <span class="bound">N</span> <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span> <span class="main">(</span>transition <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> the <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
          RETURN <span class="main">(</span>nbae <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> the <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> initial <span class="free">A</span><span class="main">)</span> <span class="bound">T</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> the <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> <span class="bound">N</span><span class="main">.</span> accepting <span class="free">A</span> <span class="bound">p</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>
        <span class="main">}</span><span class="main">,</span> <span class="keyword1">do</span> <span class="main">{</span>
          <span class="bound">f</span> <span class="main">←</span> op_set_enumerate <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span><span class="main">;</span>
          <span class="bound">T</span> <span class="main">←</span> SPEC <span class="main">(</span>HOL.eq <span class="main">(</span>trans_spec <span class="free">A</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> the <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
          RETURN <span class="main">(</span>nbae <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> the <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> initial <span class="free">A</span><span class="main">)</span> <span class="bound">T</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> the <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> nodes <span class="free">A</span><span class="main">.</span> accepting <span class="free">A</span> <span class="bound">p</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>
        <span class="main">}</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id<span class="main">⟩</span> nres_rel"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> Let_def comp_apply op_set_enumerate_def <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> 1
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">refine_vcg</span> vcg0<span class="main"><span class="main">[</span></span><span class="operator">OF</span> trans_algo_refine<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> inj_on_map_the<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> comp_apply<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">do</span> <span class="main">{</span>
          <span class="bound">f</span> <span class="main">←</span> op_set_enumerate <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span><span class="main">;</span>
          <span class="bound">T</span> <span class="main">←</span> SPEC <span class="main">(</span>HOL.eq <span class="main">(</span>trans_spec <span class="free">A</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> the <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
          RETURN <span class="main">(</span>nbae <span class="main">(</span>alphabet <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> the <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> initial <span class="free">A</span><span class="main">)</span> <span class="bound">T</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> the <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> nodes <span class="free">A</span><span class="main">.</span> accepting <span class="free">A</span> <span class="bound">p</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>
        <span class="main">}</span><span class="main">,</span> <span class="keyword1">do</span> <span class="main">{</span>
          <span class="bound">f</span> <span class="main">←</span> op_set_enumerate <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span><span class="main">;</span>
          RETURN <span class="main">(</span>nbae_image <span class="main">(</span>the <span class="main">∘</span> <span class="bound">f</span><span class="main">)</span> <span class="main">(</span>nba_nbae <span class="free">A</span><span class="main">)</span><span class="main">)</span>
        <span class="main">}</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id<span class="main">⟩</span> nres_rel"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> trans_spec_def nbae_image_nba_nbae <span class="keyword1"><span class="command">by</span></span> <span class="operator">refine_vcg</span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">do</span> <span class="main">{</span>
          <span class="bound">f</span> <span class="main">←</span> op_set_enumerate <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span><span class="main">;</span>
          RETURN <span class="main">(</span>nbae_image <span class="main">(</span>the <span class="main">∘</span> <span class="bound">f</span><span class="main">)</span> <span class="main">(</span>nba_nbae <span class="free">A</span><span class="main">)</span><span class="main">)</span>
        <span class="main">}</span><span class="main">,</span> <span class="keyword1">do</span> <span class="main">{</span>
          <span class="bound">f</span> <span class="main">←</span> op_set_enumerate <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span><span class="main">;</span>
          RETURN <span class="main">(</span>nba_nbae <span class="main">(</span>nba_image <span class="main">(</span>the <span class="main">∘</span> <span class="bound">f</span><span class="main">)</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span>
        <span class="main">}</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id<span class="main">⟩</span> nres_rel"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> op_set_enumerate_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">refine_vcg</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_map_the nba_image_nbae<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">do</span> <span class="main">{</span>
          <span class="bound">f</span> <span class="main">←</span> op_set_enumerate <span class="main">(</span>nodes <span class="free">A</span><span class="main">)</span><span class="main">;</span>
          RETURN <span class="main">(</span>nba_nbae <span class="main">(</span>nba_image <span class="main">(</span>the <span class="main">∘</span> <span class="bound">f</span><span class="main">)</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span>
        <span class="main">}</span><span class="main">,</span> op_translate <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id<span class="main">⟩</span> nres_rel"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> op_set_enumerate_def op_translate_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">refine_vcg</span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> Collect_mem_eq inj_on_map_the subset_Collect_conv<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> nres_rel_comp <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="NGBA_Graphs">
<div class="head">
<h1>Theory NGBA_Graphs</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Connecting Nondeterministic Generalized Büchi Automata to CAVA Automata Structures›</span></span>

<span class="keyword1"><span class="command">theory</span></span> NGBA_Graphs
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="NGBA.html">NGBA</a>
  <a href="../CAVA_Automata/Automata_Impl.html">CAVA_Automata.Automata_Impl</a>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">no_notation</span></span> build <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">##</span>"</span> 65<span class="main">)</span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Regular Graphs›</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">ngba_g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> ngba <span class="main">⇒</span> <span class="tfree">'state</span> graph_rec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">ngba_g</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">⦇</span> g_V <span class="main">=</span> UNIV<span class="main">,</span> g_E <span class="main">=</span> E_of_succ <span class="main">(</span>successors <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">,</span> g_V0 <span class="main">=</span> initial <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⦈</span>"</span></span>

  <span class="keyword1" id="NGBA_Graphs-ngba_g_graph"><span class="command">lemma</span></span> ngba_g_graph<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"graph <span class="main">(</span>ngba_g <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ngba_g_def graph_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1" id="NGBA_Graphs-ngba_g_V0"><span class="command">lemma</span></span> ngba_g_V0<span class="main">:</span> <span class="quoted"><span class="quoted">"g_V0 <span class="main">(</span>ngba_g <span class="free">A</span><span class="main">)</span> <span class="main">=</span> initial <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ngba_g_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1" id="NGBA_Graphs-ngba_g_E_rtrancl"><span class="command">lemma</span></span> ngba_g_E_rtrancl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>g_E <span class="main">(</span>ngba_g <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> reachable <span class="free">A</span> <span class="bound">p</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ngba_g_def graph_rec.simps E_of_succ_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> successors <span class="free">A</span> <span class="bound">p</span><span class="main">}</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> reachable <span class="free">A</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span> <span class="skolem">q</span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rtrancl_into_rtrancl<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> reachable <span class="free">A</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> successors <span class="free">A</span> <span class="bound">p</span><span class="main">}</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span> <span class="skolem">q</span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="NGBA_Graphs-ngba_g_rtrancl_path"><span class="command">lemma</span></span> ngba_g_rtrancl_path<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>g_E <span class="main">(</span>ngba_g <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> target <span class="bound">r</span> <span class="bound">p</span><span class="main">)</span> <span class="main">|</span><span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> NGBA.path <span class="free">A</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ngba_g_E_rtrancl <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1" id="NGBA_Graphs-ngba_g_trancl_path"><span class="command">lemma</span></span> ngba_g_trancl_path<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>g_E <span class="main">(</span>ngba_g <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> target <span class="bound">r</span> <span class="bound">p</span><span class="main">)</span> <span class="main">|</span><span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> NGBA.path <span class="free">A</span> <span class="bound">r</span> <span class="bound">p</span> <span class="main">∧</span> <span class="bound">r</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ngba_g_def graph_rec.simps E_of_succ_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> target <span class="bound">r</span> <span class="bound">p</span><span class="main">)</span> <span class="main">∧</span> NGBA.path <span class="free">A</span> <span class="bound">r</span> <span class="bound">p</span> <span class="main">∧</span> <span class="bound">r</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> successors <span class="free">A</span> <span class="bound">p</span><span class="main">}</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>base <span class="skolem">y</span><span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> alphabet <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> transition <span class="free">A</span> <span class="skolem">a</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> base <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> target <span class="main">[</span><span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span><span class="main">]</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"NGBA.path <span class="free">A</span> <span class="main">[</span><span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span><span class="main">]</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span><span class="main">]</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> target <span class="skolem">r</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"NGBA.path <span class="free">A</span> <span class="skolem">r</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> alphabet <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> transition <span class="free">A</span> <span class="skolem">a</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> target <span class="main">(</span><span class="skolem">r</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"NGBA.path <span class="free">A</span> <span class="main">(</span><span class="skolem">r</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span><span class="main">]</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span><span class="main">,</span> target <span class="skolem">r</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> successors <span class="free">A</span> <span class="bound">u</span><span class="main">}</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"NGBA.path <span class="free">A</span> <span class="skolem">r</span> <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">r</span> <span class="skolem">p</span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trancl_into_trancl2<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="NGBA_Graphs-ngba_g_ipath_run"><span class="command">lemma</span></span> ngba_g_ipath_run<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ipath <span class="main">(</span>g_E <span class="main">(</span>ngba_g <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="free">r</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">w</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"run <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> smap <span class="main">(</span><span class="free">r</span> <span class="main">∘</span> Suc<span class="main">)</span> nats<span class="main">)</span> <span class="main">(</span><span class="free">r</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">a</span> <span class="main">∈</span> alphabet <span class="free">A</span><span class="main">.</span> <span class="free">r</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> transition <span class="free">A</span> <span class="bound">a</span> <span class="main">(</span><span class="free">r</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> ipath_def ngba_g_def E_of_succ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">wr</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"run <span class="free">A</span> <span class="skolem">wr</span> <span class="main">(</span><span class="free">r</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> target <span class="main">(</span>stake <span class="bound">i</span> <span class="skolem">wr</span><span class="main">)</span> <span class="main">(</span><span class="free">r</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="free">r</span> <span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ngba.invariant_run_index<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">aq</span><span class="main">.</span> <span class="main">(</span>fst <span class="bound">aq</span> <span class="main">∈</span> alphabet <span class="free">A</span> <span class="main">∧</span> snd <span class="bound">aq</span> <span class="main">∈</span> transition <span class="free">A</span> <span class="main">(</span>fst <span class="bound">aq</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∧</span> snd <span class="bound">aq</span> <span class="main">=</span> <span class="free">r</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">∧</span> True"</span></span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="free">r</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">p</span> <span class="keyword1"><span class="command">using</span></span> that 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">0</span> <span class="main">=</span> <span class="free">r</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"smap <span class="main">(</span><span class="free">r</span> <span class="main">∘</span> Suc<span class="main">)</span> nats <span class="main">=</span> smap snd <span class="skolem">wr</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> eqI_snth<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"smap <span class="main">(</span><span class="free">r</span> <span class="main">∘</span> Suc<span class="main">)</span> nats <span class="main">!!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">r</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> target <span class="main">(</span>stake <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">wr</span><span class="main">)</span> <span class="main">(</span><span class="free">r</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 2<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="free">r</span> <span class="main">0</span> <span class="main">##</span> trace <span class="skolem">wr</span> <span class="main">(</span><span class="free">r</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!!</span> Suc <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> smap snd <span class="skolem">wr</span> <span class="main">!!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ngba.trace_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"smap <span class="main">(</span><span class="free">r</span> <span class="main">∘</span> Suc<span class="main">)</span> nats <span class="main">!!</span> <span class="skolem">i</span> <span class="main">=</span> smap snd <span class="skolem">wr</span> <span class="main">!!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"run <span class="free">A</span> <span class="main">(</span>smap fst <span class="skolem">wr</span> <span class="main">|||</span> smap <span class="main">(</span><span class="free">r</span> <span class="main">∘</span> Suc<span class="main">)</span> nats<span class="main">)</span> <span class="main">(</span><span class="free">r</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="NGBA_Graphs-ngba_g_run_ipath"><span class="command">lemma</span></span> ngba_g_run_ipath<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"run <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> <span class="free">r</span><span class="main">)</span> <span class="free">p</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ipath <span class="main">(</span>g_E <span class="main">(</span>ngba_g <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snth <span class="main">(</span><span class="free">p</span> <span class="main">##</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">!!</span> <span class="skolem">i</span> <span class="main">∈</span> alphabet <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">!!</span> <span class="skolem">i</span> <span class="main">∈</span> transition <span class="free">A</span> <span class="main">(</span><span class="free">w</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>target <span class="main">(</span>stake <span class="skolem">i</span> <span class="main">(</span><span class="free">w</span> <span class="main">|||</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> ngba.run_snth<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">!!</span> <span class="skolem">i</span> <span class="main">∈</span> successors <span class="free">A</span> <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">##</span> <span class="free">r</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> sscan_scons_snth<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> ngba.trace_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">##</span> <span class="free">r</span><span class="main">)</span> <span class="main">!!</span> <span class="skolem">i</span><span class="main">,</span> <span class="main">(</span><span class="free">p</span> <span class="main">##</span> <span class="free">r</span><span class="main">)</span> <span class="main">!!</span> Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> g_E <span class="main">(</span>ngba_g <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">unfolding</span></span> ngba_g_def graph_rec.simps E_of_succ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Indexed Generalized Büchi Graphs›</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">ngba_acc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> pred gen <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> nat set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">ngba_acc</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> length <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">}</span>"</span></span>

  <span class="keyword1" id="NGBA_Graphs-ngba_acc_param"><span class="command">lemma</span></span> ngba_acc_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ngba_acc<span class="main">,</span> ngba_acc<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">S</span> <span class="main">→</span> bool_rel<span class="main">⟩</span> list_rel <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> <span class="main">⟨</span>nat_rel<span class="main">⟩</span> set_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ngba_acc_def list_rel_def list_all2_conv_all_nth fun_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">ngba_igbg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> ngba <span class="main">⇒</span> <span class="tfree">'state</span> igb_graph_rec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">ngba_igbg</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> graph_rec.extend <span class="main">(</span>ngba_g <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">⦇</span> igbg_num_acc <span class="main">=</span> length <span class="main">(</span>accepting <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">,</span> igbg_acc <span class="main">=</span> ngba_acc <span class="main">(</span>accepting <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">⦈</span>"</span></span>

  <span class="keyword1" id="NGBA_Graphs-acc_run_language"><span class="command">lemma</span></span> acc_run_language<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"igb_graph <span class="main">(</span>ngba_igbg <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Ex <span class="main">(</span>igb_graph.is_acc_run <span class="main">(</span>ngba_igbg <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> language <span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">interpret</span></span> igb_graph <span class="quoted"><span class="quoted">"ngba_igbg <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"V0 <span class="main">=</span> g_V0 <span class="main">(</span>ngba_g <span class="free">A</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"E <span class="main">=</span> g_E <span class="main">(</span>ngba_g <span class="free">A</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"num_acc <span class="main">=</span> length <span class="main">(</span>accepting <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> acc <span class="skolem">p</span> <span class="main">⟷</span> <span class="skolem">k</span> <span class="main">&lt;</span> length <span class="main">(</span>accepting <span class="free">A</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>accepting <span class="free">A</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span> <span class="skolem">k</span>
      <span class="keyword1"><span class="command">unfolding</span></span> ngba_igbg_def ngba_acc_def graph_rec.defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"language <span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"Ex is_acc_run"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"is_acc_run <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> run <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">0</span> <span class="main">∈</span> V0"</span></span> <span class="quoted"><span class="quoted">"ipath E <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"is_acc <span class="skolem">r</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> is_acc_run_def graph_defs.is_run_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"run <span class="free">A</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">|||</span> smap <span class="main">(</span><span class="skolem">r</span> <span class="main">∘</span> Suc<span class="main">)</span> nats<span class="main">)</span> <span class="main">(</span><span class="skolem">r</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ngba_g_ipath_run 2<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">0</span> <span class="main">##</span> smap <span class="main">(</span><span class="skolem">r</span> <span class="main">∘</span> Suc<span class="main">)</span> nats <span class="main">=</span> smap <span class="skolem">r</span> nats"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> stream.map_comp smap_siterate<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span>accepting <span class="free">A</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span><span class="skolem">r</span> <span class="main">0</span> <span class="main">##</span> smap <span class="main">(</span><span class="skolem">r</span> <span class="main">∘</span> Suc<span class="main">)</span> nats<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="main">(</span>accepting <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
        <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>3<span class="main">)</span> that <span class="keyword1"><span class="command">unfolding</span></span> infs_infm is_acc_def 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> language <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">0</span> <span class="main">∈</span> initial <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ngba_g_V0 2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"run <span class="free">A</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">|||</span> smap <span class="main">(</span><span class="skolem">r</span> <span class="main">∘</span> Suc<span class="main">)</span> nats<span class="main">)</span> <span class="main">(</span><span class="skolem">r</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"gen infs <span class="main">(</span>accepting <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="skolem">r</span> <span class="main">0</span> <span class="main">##</span> smap <span class="main">(</span><span class="skolem">r</span> <span class="main">∘</span> Suc<span class="main">)</span> nats<span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> gen_def all_set_conv_all_nth <span class="keyword1"><span class="command">using</span></span> 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Ex is_acc_run"</span></span> <span class="keyword2"><span class="keyword">if</span></span> language<span class="main">:</span> <span class="quoted"><span class="quoted">"language <span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> language <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> language <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> initial <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"run <span class="free">A</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"gen infs <span class="main">(</span>accepting <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">##</span> <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_acc_run <span class="main">(</span>snth <span class="main">(</span><span class="skolem">p</span> <span class="main">##</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> is_acc_run_def graph_defs.is_run_def
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span> <span class="main">##</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">!!</span> <span class="main">0</span> <span class="main">∈</span> V0"</span></span> <span class="keyword1"><span class="command">using</span></span> ngba_g_V0 2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ipath E <span class="main">(</span>snth <span class="main">(</span><span class="skolem">p</span> <span class="main">##</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ngba_g_run_ipath 2<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"is_acc <span class="main">(</span>snth <span class="main">(</span><span class="skolem">p</span> <span class="main">##</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> gen_def infs_infm is_acc_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="NGBA_Refine">
<div class="head">
<h1>Theory NGBA_Refine</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Relations on Nondeterministic Generalized Büchi Automata›</span></span>

<span class="keyword1"><span class="command">theory</span></span> NGBA_Refine
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="NGBA.html">NGBA</a>"</span>
  <span class="quoted">"<a href="Transition_System_Refine.html">../../Transition_Systems/Transition_System_Refine</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">ngba_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">×</span> <span class="tfree">'label<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'state<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">×</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> set <span class="main">⇒</span>
    <span class="main">(</span><span class="main">(</span><span class="tfree">'label<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> ngba <span class="main">×</span> <span class="main">(</span><span class="tfree">'label<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> ngba<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="main">[</span><span class="operator">to_relAPP</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ngba_rel</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">.</span>
      <span class="main">(</span>alphabet <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> alphabet <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">⟩</span> set_rel <span class="main">∧</span>
      <span class="main">(</span>initial <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> initial <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">⟩</span> set_rel <span class="main">∧</span>
      <span class="main">(</span>transition <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> transition <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">→</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">⟩</span> set_rel <span class="main">∧</span>
      <span class="main">(</span>accepting <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> accepting <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">→</span> bool_rel<span class="main">⟩</span> list_rel<span class="main">}</span>"</span></span>

  <span class="keyword1" id="NGBA_Refine-ngba_param"><span class="command">lemma</span></span> ngba_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>ngba<span class="main">,</span> ngba<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">⟩</span> set_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> set_rel <span class="main">→</span> <span class="main">(</span><span class="free">L</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> set_rel<span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span> <span class="main">→</span> bool_rel<span class="main">⟩</span> list_rel <span class="main">→</span>
      <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> ngba_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>alphabet<span class="main">,</span> alphabet<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> ngba_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">L</span><span class="main">⟩</span> set_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>initial<span class="main">,</span> initial<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> ngba_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> set_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>transition<span class="main">,</span> transition<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> ngba_rel <span class="main">→</span> <span class="free">L</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> set_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>accepting<span class="main">,</span> accepting<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> ngba_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span> <span class="main">→</span> bool_rel<span class="main">⟩</span> list_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ngba_rel_def fun_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="NGBA_Refine-ngba_rel_id"><span class="command">lemma</span></span> ngba_rel_id<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Id<span class="main">,</span> Id<span class="main">⟩</span> ngba_rel <span class="main">=</span> Id"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ngba_rel_def <span class="keyword1"><span class="command">using</span></span> ngba.expand <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="NGBA_Refine-enableds_param"><span class="command">lemma</span></span> enableds_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ngba.enableds<span class="main">,</span> ngba.enableds<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> ngba_rel <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">L</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">S</span><span class="main">⟩</span> set_rel"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ngba_param<span class="main">(</span>2<span class="main">,</span> 4<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> ngba.enableds_def fun_rel_def set_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1" id="NGBA_Refine-paths_param"><span class="command">lemma</span></span> paths_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ngba.paths<span class="main">,</span> ngba.paths<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> ngba_rel <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">L</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">S</span><span class="main">⟩</span> list_rel<span class="main">⟩</span> set_rel"</span></span>
    <span class="keyword1"><span class="command">using</span></span> enableds_param<span class="main">[</span><span class="operator">param_fo</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
  <span class="keyword1" id="NGBA_Refine-runs_param"><span class="command">lemma</span></span> runs_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ngba.runs<span class="main">,</span> ngba.runs<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> ngba_rel <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">L</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">S</span><span class="main">⟩</span> stream_rel<span class="main">⟩</span> set_rel"</span></span>
    <span class="keyword1"><span class="command">using</span></span> enableds_param<span class="main">[</span><span class="operator">param_fo</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>

  <span class="keyword1" id="NGBA_Refine-reachable_param"><span class="command">lemma</span></span> reachable_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>reachable<span class="main">,</span> reachable<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> ngba_rel <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> set_rel"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"reachable <span class="skolem">A</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">wr</span><span class="main">.</span> target <span class="bound">wr</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">`</span> ngba.paths <span class="skolem">A</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> ngba"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">p</span>
      <span class="keyword1"><span class="command">unfolding</span></span> ngba.reachable_alt_def ngba.paths_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> 1 <span class="keyword1"><span class="command">using</span></span> enableds_param<span class="main">[</span><span class="operator">param_fo</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1" id="NGBA_Refine-nodes_param"><span class="command">lemma</span></span> nodes_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nodes<span class="main">,</span> nodes<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> ngba_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> set_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ngba.nodes_alt_def Collect_mem_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>

  <span class="comment1">(* TODO: move *)</span>
  <span class="keyword1" id="NGBA_Refine-gen_param"><span class="command">lemma</span></span> gen_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>gen<span class="main">,</span> gen<span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">A</span> <span class="main">→</span> <span class="free">B</span> <span class="main">→</span> bool_rel<span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> list_rel <span class="main">→</span> <span class="free">B</span> <span class="main">→</span> bool_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> gen_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>

  <span class="keyword1" id="NGBA_Refine-language_param"><span class="command">lemma</span></span> language_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>language<span class="main">,</span> language<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> ngba_rel <span class="main">→</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">L</span><span class="main">⟩</span> stream_rel<span class="main">⟩</span> set_rel"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"language <span class="skolem">A</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="bound">p</span> <span class="main">∈</span> initial <span class="skolem">A</span><span class="main">.</span> <span class="main">⋃</span> <span class="bound">wr</span> <span class="main">∈</span> ngba.runs <span class="skolem">A</span> <span class="bound">p</span><span class="main">.</span>
      <span class="keyword1">if</span> gen infs <span class="main">(</span>accepting <span class="skolem">A</span><span class="main">)</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> smap snd <span class="bound">wr</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">{</span>smap fst <span class="bound">wr</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> ngba"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ngba.language_def ngba.runs_def image_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> split_szip_ex <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> alw_smap<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> 1 <span class="keyword1"><span class="command">using</span></span> enableds_param<span class="main">[</span><span class="operator">param_fo</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="NGBA_Implement">
<div class="head">
<h1>Theory NGBA_Implement</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Implementation of Nondeterministic Generalized Büchi Automata›</span></span>

<span class="keyword1"><span class="command">theory</span></span> NGBA_Implement
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="NGBA_Refine.html">NGBA_Refine</a>"</span>
  <span class="quoted">"<a href="Implement.html">../../Basic/Implement</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">consts</span></span> i_ngba_scheme <span class="main">::</span> <span class="quoted"><span class="quoted">"interface <span class="main">⇒</span> interface <span class="main">⇒</span> interface"</span></span>

  <span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1"><span class="command">interpretation</span></span> autoref_syn <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>

    <span class="keyword1" id="NGBA_Implement-ngba_scheme_itype"><span class="command">lemma</span></span> ngba_scheme_itype<span class="main">[</span><span class="operator">autoref_itype</span><span class="main">]</span><span class="main">:</span>
      <span class="quoted"><span class="quoted">"ngba <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">L</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_set <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">S</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_set <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">(</span><span class="free">L</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">S</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">S</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_set<span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">S</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_set<span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_list <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span>
        <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_ngba_scheme"</span></span>
      <span class="quoted"><span class="quoted">"alphabet <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_ngba_scheme <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">L</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_set"</span></span>
      <span class="quoted"><span class="quoted">"initial <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_ngba_scheme <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">S</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_set"</span></span>
      <span class="quoted"><span class="quoted">"transition <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_ngba_scheme <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">L</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">S</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">S</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_set"</span></span>
      <span class="quoted"><span class="quoted">"accepting <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_ngba_scheme <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">S</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_set<span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span> i_list"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> ngbai <span class="main">=</span> ngbai
    <span class="main">(</span><span class="free"><span class="entity">alphabeti</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> list"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">initiali</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> list"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">transitioni</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> list"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">acceptingi</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'state</span> <span class="main">⇒</span> bool<span class="main">)</span> list"</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">ngbai_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">×</span> <span class="tfree">'label<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'state<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">×</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> set <span class="main">⇒</span>
    <span class="main">(</span><span class="main">(</span><span class="tfree">'label<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> ngbai <span class="main">×</span> <span class="main">(</span><span class="tfree">'label<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> ngbai<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="main">[</span><span class="operator">to_relAPP</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ngbai_rel</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">.</span>
      <span class="main">(</span>alphabeti <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> alphabeti <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">⟩</span> list_rel <span class="main">∧</span>
      <span class="main">(</span>initiali <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> initiali <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">⟩</span> list_rel <span class="main">∧</span>
      <span class="main">(</span>transitioni <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> transitioni <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">→</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">⟩</span> list_rel <span class="main">∧</span>
      <span class="main">(</span>acceptingi <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> acceptingi <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">→</span> bool_rel<span class="main">⟩</span> list_rel<span class="main">}</span>"</span></span>

  <span class="keyword1" id="NGBA_Implement-ngbai_param"><span class="command">lemma</span></span> ngbai_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>ngbai<span class="main">,</span> ngbai<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">⟩</span> list_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> list_rel <span class="main">→</span> <span class="main">(</span><span class="free">L</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> list_rel<span class="main">)</span> <span class="main">→</span>
      <span class="main">⟨</span><span class="free">S</span> <span class="main">→</span> bool_rel<span class="main">⟩</span> list_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> ngbai_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>alphabeti<span class="main">,</span> alphabeti<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> ngbai_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">L</span><span class="main">⟩</span> list_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>initiali<span class="main">,</span> initiali<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> ngbai_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> list_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>transitioni<span class="main">,</span> transitioni<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> ngbai_rel <span class="main">→</span> <span class="free">L</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> list_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>acceptingi<span class="main">,</span> acceptingi<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> ngbai_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span> <span class="main">→</span> bool_rel<span class="main">⟩</span> list_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ngbai_rel_def fun_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">ngbai_ngba_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">×</span> <span class="tfree">'label<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'state<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">×</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> set <span class="main">⇒</span>
    <span class="main">(</span><span class="main">(</span><span class="tfree">'label<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> ngbai <span class="main">×</span> <span class="main">(</span><span class="tfree">'label<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="tfree">'state<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> ngba<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="main">[</span><span class="operator">to_relAPP</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ngbai_ngba_rel</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">.</span>
      <span class="main">(</span>alphabeti <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> alphabet <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">⟩</span> list_set_rel <span class="main">∧</span>
      <span class="main">(</span>initiali <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> initial <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">⟩</span> list_set_rel <span class="main">∧</span>
      <span class="main">(</span>transitioni <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> transition <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">→</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">⟩</span> list_set_rel <span class="main">∧</span>
      <span class="main">(</span>acceptingi <span class="bound">A<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> accepting <span class="bound">A<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">→</span> bool_rel<span class="main">⟩</span> list_rel<span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rel_intf</span><span class="main">]</span> <span class="main">=</span> REL_INTFI<span class="main">[</span><span class="operator">of</span> <span class="quoted">ngbai_ngba_rel</span> <span class="quoted">i_ngba_scheme</span><span class="main">]</span>

  <span class="keyword1" id="NGBA_Implement-ngbai_ngba_param"><span class="command">lemma</span></span> ngbai_ngba_param<span class="main">[</span><span class="operator">param</span><span class="main">,</span> <span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>ngbai<span class="main">,</span> ngba<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">⟩</span> list_set_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> list_set_rel <span class="main">→</span> <span class="main">(</span><span class="free">L</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> list_set_rel<span class="main">)</span> <span class="main">→</span>
      <span class="main">⟨</span><span class="free">S</span> <span class="main">→</span> bool_rel<span class="main">⟩</span> list_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> ngbai_ngba_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>alphabeti<span class="main">,</span> alphabet<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> ngbai_ngba_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">L</span><span class="main">⟩</span> list_set_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>initiali<span class="main">,</span> initial<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> ngbai_ngba_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> list_set_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>transitioni<span class="main">,</span> transition<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> ngbai_ngba_rel <span class="main">→</span> <span class="free">L</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> list_set_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>acceptingi<span class="main">,</span> accepting<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> ngbai_ngba_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span> <span class="main">→</span> bool_rel<span class="main">⟩</span> list_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ngbai_ngba_rel_def fun_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">ngbai_ngba</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> ngbai <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> ngba"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">ngbai_ngba</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> ngba <span class="main">(</span>set <span class="main">(</span>alphabeti <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>initiali <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">.</span> set <span class="main">(</span>transitioni <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">a</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>acceptingi <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">ngbai_invar</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> ngbai <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">ngbai_invar</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> distinct <span class="main">(</span>alphabeti <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">∧</span> distinct <span class="main">(</span>initiali <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">.</span> distinct <span class="main">(</span>transitioni <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">a</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="NGBA_Implement-ngbai_ngba_id_param"><span class="command">lemma</span></span> ngbai_ngba_id_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ngbai_ngba<span class="main">,</span> id<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> ngbai_ngba_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> ngba_rel"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Ai</span> <span class="skolem">A</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Ai</span><span class="main">,</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> ngbai_ngba_rel"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"ngbai_ngba <span class="skolem">Ai</span> <span class="main">=</span> ngba <span class="main">(</span>set <span class="main">(</span>alphabeti <span class="skolem">Ai</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>initiali <span class="skolem">Ai</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">.</span> set <span class="main">(</span>transitioni <span class="skolem">Ai</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>acceptingi <span class="skolem">Ai</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ngbai_ngba_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"id <span class="skolem">A</span> <span class="main">=</span> ngba <span class="main">(</span>id <span class="main">(</span>alphabet <span class="skolem">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>id <span class="main">(</span>initial <span class="skolem">A</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">.</span> id <span class="main">(</span>transition <span class="skolem">A</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>accepting <span class="skolem">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ngbai_ngba <span class="skolem">Ai</span><span class="main">,</span> id <span class="skolem">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> ngba_rel"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 2 3 <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="NGBA_Implement-ngbai_ngba_br"><span class="command">lemma</span></span> ngbai_ngba_br<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>Id<span class="main">,</span> Id<span class="main">⟩</span> ngbai_ngba_rel <span class="main">=</span> br ngbai_ngba ngbai_invar"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id<span class="main">,</span> Id<span class="main">⟩</span> ngbai_ngba_rel"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> br ngbai_ngba ngbai_invar"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">A</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> ngba"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> ngbai_ngba_rel_def ngbai_ngba_def ngbai_invar_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_br_conv list_set_rel_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> br ngbai_ngba ngbai_invar"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id<span class="main">,</span> Id<span class="main">⟩</span> ngbai_ngba_rel"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">A</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> ngba"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ngbai_ngba <span class="skolem">A</span><span class="main">,</span> id <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id<span class="main">,</span> Id<span class="main">⟩</span> ngba_rel"</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"ngbai_invar <span class="skolem">A</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ngbai_ngba_param<span class="main">(</span>2 - 5<span class="main">)</span><span class="main">[</span><span class="operator">param_fo</span><span class="main">,</span> <span class="operator">OF</span> that<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_br_conv list_set_rel_def ngbai_invar_def<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="keyword1"><span class="command">unfolding</span></span> in_br_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Degeneralization_Refine">
<div class="head">
<h1>Theory Degeneralization_Refine</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Degeneralization_Refine
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Degeneralization.html">Degeneralization</a> <a href="Refine.html">Refine</a>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1" id="Degeneralization_Refine-degen_param"><span class="command">lemma</span></span> degen_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>degen<span class="main">,</span> degen<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">S</span> <span class="main">→</span> bool_rel<span class="main">⟩</span> list_rel <span class="main">→</span> <span class="free">S</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> nat_rel <span class="main">→</span> bool_rel"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> fun_relI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">cs</span> <span class="skolem">ds</span> <span class="skolem">ak</span> <span class="skolem">bl</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">cs</span><span class="main">,</span> <span class="skolem">ds</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">S</span> <span class="main">→</span> bool_rel<span class="main">⟩</span> list_rel"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ak</span><span class="main">,</span> <span class="skolem">bl</span><span class="main">)</span> <span class="main">∈</span>  <span class="free">S</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> nat_rel"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>degen <span class="skolem">cs</span> <span class="skolem">ak</span><span class="main">,</span> degen <span class="skolem">ds</span> <span class="skolem">bl</span><span class="main">)</span> <span class="main">∈</span> bool_rel"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> degen_def list_rel_def fun_rel_def list_all2_conv_all_nth
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"snd <span class="skolem">ak</span> <span class="main">&lt;</span> length <span class="skolem">cs</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 0 3<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Degeneralization_Refine-count_param"><span class="command">lemma</span></span> count_param<span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Degeneralization.count<span class="main">,</span> Degeneralization.count<span class="main">)</span> <span class="main">∈</span>
    <span class="main">⟨</span><span class="free">A</span> <span class="main">→</span> bool_rel<span class="main">⟩</span> list_rel <span class="main">→</span> <span class="free">A</span> <span class="main">→</span> nat_rel <span class="main">→</span> nat_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> count_def null_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="NGBA_Algorithms">
<div class="head">
<h1>Theory NGBA_Algorithms</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Algorithms on Nondeterministic Generalized Büchi Automata›</span></span>

<span class="keyword1"><span class="command">theory</span></span> NGBA_Algorithms
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="NGBA_Graphs.html">NGBA_Graphs</a>
  <a href="NGBA_Implement.html">NGBA_Implement</a>
  <a href="NBA_Combine.html">NBA_Combine</a>
  <a href="NBA_Algorithms.html">NBA_Algorithms</a>
  <a href="Degeneralization_Refine.html">Degeneralization_Refine</a>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Operations›</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">op_language_empty</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">op_language_empty</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> NGBA.language <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>

  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_op_pat</span><span class="main">]</span> <span class="main">=</span> op_language_empty_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Implementations›</span></span>

  <span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1"><span class="command">interpretation</span></span> autoref_syn <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>

    <span class="keyword1" id="NGBA_Algorithms-ngba_g_ahs"><span class="command">lemma</span></span> ngba_g_ahs<span class="main">:</span> <span class="quoted"><span class="quoted">"ngba_g <span class="free">A</span> <span class="main">=</span> <span class="main">⦇</span> g_V <span class="main">=</span> UNIV<span class="main">,</span> g_E <span class="main">=</span> E_of_succ <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> CAST
      <span class="main">(</span><span class="main">(</span><span class="main">⋃</span> <span class="bound">a</span> <span class="main">∈</span> ngba.alphabet <span class="free">A</span><span class="main">.</span> ngba.transition <span class="free">A</span> <span class="bound">a</span> <span class="bound">p</span> <span class="main">:::</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> list_set_rel<span class="main">)</span> <span class="main">:::</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> ahs_rel <span class="free">bhc</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
      g_V0 <span class="main">=</span> ngba.initial <span class="free">A</span> <span class="main">⦈</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ngba_g_def ngba.successors_alt_def CAST_def id_apply <span class="dynamic"><span class="dynamic">autoref_tag_defs</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>

    <span class="keyword1"><span class="command">schematic_goal</span></span> ngbai_gi<span class="main">:</span>
      <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="operator">autoref_ga_rules</span><span class="main">]</span> <span class="main">=</span> map2set_to_list
      <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'statei</span> <span class="main">×</span> <span class="tfree">'state</span><span class="main">)</span> set"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_ga_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_bounded_hashcode <span class="free">S</span> <span class="free">seq</span> <span class="free">bhc</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_ga_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_valid_def_hm_size <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'statei</span><span class="main">)</span> <span class="free">hms</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">seq</span><span class="main">,</span> HOL.eq<span class="main">)</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> bool_rel"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ai</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> ngbai_ngba_rel"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?f</span> <span class="main">::</span> <span class="tvar">?'a</span><span class="main">,</span> RETURN <span class="main">(</span>ngba_g <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ngba_g_ahs<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> bhc <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">bhc</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">autoref_monadic</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">plain</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">ngbai_gi</span> <span class="keyword2"><span class="keyword">uses</span></span> ngbai_gi
    <span class="keyword1" id="NGBA_Algorithms-ngbai_gi_refine"><span class="command">lemma</span></span> ngbai_gi_refine<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'statei</span> <span class="main">×</span> <span class="tfree">'state</span><span class="main">)</span> set"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SIDE_GEN_ALGO <span class="main">(</span>is_bounded_hashcode <span class="free">S</span> <span class="free">seq</span> <span class="free">bhc</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SIDE_GEN_ALGO <span class="main">(</span>is_valid_def_hm_size <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'statei</span><span class="main">)</span> <span class="free">hms</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"GEN_OP <span class="free">seq</span> HOL.eq <span class="main">(</span><span class="free">S</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> bool_rel<span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>NGBA_Algorithms.ngbai_gi <span class="free">seq</span> <span class="free">bhc</span> <span class="free">hms</span><span class="main">,</span> ngba_g<span class="main">)</span> <span class="main">∈</span>
        <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> ngbai_ngba_rel <span class="main">→</span> <span class="main">⟨</span>unit_rel<span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> g_impl_rel_ext"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ngbai_gi.refine<span class="main">[</span><span class="operator">THEN</span> RETURN_nres_relD<span class="main">]</span> assms <span class="keyword1"><span class="command">unfolding</span></span> <span class="dynamic"><span class="dynamic">autoref_tag_defs</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">schematic_goal</span></span> ngba_nodes<span class="main">:</span>
      <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'statei</span> <span class="main">×</span> <span class="tfree">'state</span><span class="main">)</span> set"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span>g_E <span class="main">(</span>ngba_g <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> g_V0 <span class="main">(</span>ngba_g <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_ga_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_bounded_hashcode <span class="free">S</span> <span class="free">seq</span> <span class="free">bhc</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_ga_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_valid_def_hm_size <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'statei</span><span class="main">)</span> <span class="free">hms</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">seq</span><span class="main">,</span> HOL.eq<span class="main">)</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> bool_rel"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ai</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> ngbai_ngba_rel"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?f</span> <span class="main">::</span> <span class="tvar">?'a</span><span class="main">,</span> op_reachable <span class="main">(</span>ngba_g <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">autoref</span>
    <span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">ngba_nodes</span> <span class="keyword2"><span class="keyword">uses</span></span> ngba_nodes
    <span class="keyword1" id="NGBA_Algorithms-ngba_nodes_refine"><span class="command">lemma</span></span> ngba_nodes_refine<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'statei</span> <span class="main">×</span> <span class="tfree">'state</span><span class="main">)</span> set"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SIDE_PRECOND <span class="main">(</span>finite <span class="main">(</span>NGBA.nodes <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SIDE_GEN_ALGO <span class="main">(</span>is_bounded_hashcode <span class="free">S</span> <span class="free">seq</span> <span class="free">bhc</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SIDE_GEN_ALGO <span class="main">(</span>is_valid_def_hm_size <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'statei</span><span class="main">)</span> <span class="free">hms</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"GEN_OP <span class="free">seq</span> HOL.eq <span class="main">(</span><span class="free">S</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> bool_rel<span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ai</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> ngbai_ngba_rel"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>NGBA_Algorithms.ngba_nodes <span class="free">seq</span> <span class="free">bhc</span> <span class="free">hms</span> <span class="free">Ai</span><span class="main">,</span>
        <span class="main">(</span><span class="keyword1">OP</span> NGBA.nodes <span class="main">:::</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> ngbai_ngba_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> ahs_rel <span class="free">bhc</span><span class="main">)</span> <span class="main">$</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> ahs_rel <span class="free">bhc</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"NGBA.nodes <span class="free">A</span> <span class="main">=</span> op_reachable <span class="main">(</span>ngba_g <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ngba_g_V0 ngba_g_E_rtrancl<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span>g_E <span class="main">(</span>ngba_g <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> g_V0 <span class="main">(</span>ngba_g <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ngba_nodes.refine assms 2 <span class="keyword1"><span class="command">unfolding</span></span> <span class="dynamic"><span class="dynamic">autoref_tag_defs</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="NGBA_Algorithms-ngba_igbg_ahs"><span class="command">lemma</span></span> ngba_igbg_ahs<span class="main">:</span> <span class="quoted"><span class="quoted">"ngba_igbg <span class="free">A</span> <span class="main">=</span> <span class="main">⦇</span> g_V <span class="main">=</span> UNIV<span class="main">,</span> g_E <span class="main">=</span> E_of_succ <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> CAST
      <span class="main">(</span><span class="main">(</span><span class="main">⋃</span> <span class="bound">a</span> <span class="main">∈</span> NGBA.alphabet <span class="free">A</span><span class="main">.</span> NGBA.transition <span class="free">A</span> <span class="bound">a</span> <span class="bound">p</span> <span class="main">:::</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> list_set_rel<span class="main">)</span> <span class="main">:::</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> ahs_rel <span class="free">bhc</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> g_V0 <span class="main">=</span> NGBA.initial <span class="free">A</span><span class="main">,</span>
      igbg_num_acc <span class="main">=</span> length <span class="main">(</span>NGBA.accepting <span class="free">A</span><span class="main">)</span><span class="main">,</span> igbg_acc <span class="main">=</span> ngba_acc <span class="main">(</span>NGBA.accepting <span class="free">A</span><span class="main">)</span> <span class="main">⦈</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ngba_g_def ngba_igbg_def ngba.successors_alt_def CAST_def id_apply <span class="dynamic"><span class="dynamic">autoref_tag_defs</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> graph_rec.defs
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ngba_acc_bs</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> fold <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span> <span class="bound">bs</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">c</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">then</span> bs_insert <span class="bound">k</span> <span class="bound">bs</span> <span class="keyword1">else</span> <span class="bound">bs</span><span class="main">)</span> <span class="main">(</span>List.enumerate <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="main">(</span>bs_empty <span class="main">()</span><span class="main">)</span>"</span></span>

    <span class="keyword1" id="NGBA_Algorithms-ngba_acc_bs_empty"><span class="command">lemma</span></span> ngba_acc_bs_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ngba_acc_bs <span class="main">[]</span> <span class="free">p</span> <span class="main">=</span> bs_empty <span class="main">()</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ngba_acc_bs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1" id="NGBA_Algorithms-ngba_acc_bs_insert"><span class="command">lemma</span></span> ngba_acc_bs_insert<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="free">p</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ngba_acc_bs <span class="main">(</span><span class="free">cs</span> <span class="main">@</span> <span class="main">[</span><span class="free">c</span><span class="main">]</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> bs_insert <span class="main">(</span>length <span class="free">cs</span><span class="main">)</span> <span class="main">(</span>ngba_acc_bs <span class="free">cs</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> ngba_acc_bs_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> enumerate_append_eq<span class="main">)</span>
    <span class="keyword1" id="NGBA_Algorithms-ngba_acc_bs_skip"><span class="command">lemma</span></span> ngba_acc_bs_skip<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">c</span> <span class="free">p</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ngba_acc_bs <span class="main">(</span><span class="free">cs</span> <span class="main">@</span> <span class="main">[</span><span class="free">c</span><span class="main">]</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> ngba_acc_bs <span class="free">cs</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> ngba_acc_bs_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> enumerate_append_eq<span class="main">)</span>

    <span class="keyword1" id="NGBA_Algorithms-ngba_acc_bs_correct"><span class="command">lemma</span></span> ngba_acc_bs_correct<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bs_α <span class="main">(</span>ngba_acc_bs <span class="free">cs</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> ngba_acc <span class="free">cs</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">cs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> ngba_acc_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">c</span> <span class="skolem">cs</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> less_Suc_eq snoc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="free">p</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ngba_acc_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="NGBA_Algorithms-ngba_acc_impl_bs"><span class="command">lemma</span></span> ngba_acc_impl_bs<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ngba_acc_bs<span class="main">,</span> ngba_acc<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">S</span> <span class="main">→</span> bool_rel<span class="main">⟩</span> list_rel <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> <span class="main">⟨</span>nat_rel<span class="main">⟩</span> bs_set_rel"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ngba_acc_bs<span class="main">,</span> ngba_acc<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>Id <span class="main">→</span> bool_rel<span class="main">⟩</span> list_rel <span class="main">→</span> Id <span class="main">→</span> <span class="main">⟨</span>nat_rel<span class="main">⟩</span> bs_set_rel"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bs_set_rel_def in_br_conv<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ngba_acc<span class="main">,</span> ngba_acc<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">S</span> <span class="main">→</span> bool_rel<span class="main">⟩</span> list_rel <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> <span class="main">⟨</span>nat_rel<span class="main">⟩</span> set_rel"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">schematic_goal</span></span> ngbai_igbgi<span class="main">:</span>
      <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="operator">autoref_ga_rules</span><span class="main">]</span> <span class="main">=</span> map2set_to_list
      <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'statei</span> <span class="main">×</span> <span class="tfree">'state</span><span class="main">)</span> set"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_ga_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_bounded_hashcode <span class="free">S</span> <span class="free">seq</span> <span class="free">bhc</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_ga_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_valid_def_hm_size <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'statei</span><span class="main">)</span> <span class="free">hms</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">seq</span><span class="main">,</span> HOL.eq<span class="main">)</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> bool_rel"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ai</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> ngbai_ngba_rel"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?f</span> <span class="main">::</span> <span class="tvar">?'a</span><span class="main">,</span> RETURN <span class="main">(</span>ngba_igbg <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ngba_igbg_ahs<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">S</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> bhc <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">bhc</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">autoref_monadic</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">plain</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">ngbai_igbgi</span> <span class="keyword2"><span class="keyword">uses</span></span> ngbai_igbgi
    <span class="keyword1" id="NGBA_Algorithms-ngbai_igbgi_refine"><span class="command">lemma</span></span> ngbai_igbgi_refine<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'statei</span> <span class="main">×</span> <span class="tfree">'state</span><span class="main">)</span> set"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SIDE_GEN_ALGO <span class="main">(</span>is_bounded_hashcode <span class="free">S</span> <span class="free">seq</span> <span class="free">bhc</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SIDE_GEN_ALGO <span class="main">(</span>is_valid_def_hm_size <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'statei</span><span class="main">)</span> <span class="free">hms</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"GEN_OP <span class="free">seq</span> HOL.eq <span class="main">(</span><span class="free">S</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> bool_rel<span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>NGBA_Algorithms.ngbai_igbgi <span class="free">seq</span> <span class="free">bhc</span> <span class="free">hms</span><span class="main">,</span> ngba_igbg<span class="main">)</span> <span class="main">∈</span>
        <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> ngbai_ngba_rel <span class="main">→</span> igbg_impl_rel_ext unit_rel <span class="free">S</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ngbai_igbgi.refine<span class="main">[</span><span class="operator">THEN</span> RETURN_nres_relD<span class="main">]</span> assms <span class="keyword1"><span class="command">unfolding</span></span> <span class="dynamic"><span class="dynamic">autoref_tag_defs</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">schematic_goal</span></span> ngba_language_empty<span class="main">:</span>
      <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'statei</span> <span class="main">×</span> <span class="tfree">'state</span><span class="main">)</span> set"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"igb_fr_graph <span class="main">(</span>ngba_igbg <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_ga_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_bounded_hashcode <span class="free">S</span> <span class="free">seq</span> <span class="free">bhs</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_ga_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_valid_def_hm_size <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'statei</span><span class="main">)</span> <span class="free">hms</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">seq</span><span class="main">,</span> HOL.eq<span class="main">)</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> bool_rel"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ai</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> ngbai_ngba_rel"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?f</span> <span class="main">::</span> <span class="tvar">?'a</span><span class="main">,</span> <span class="keyword1">do</span> <span class="main">{</span> <span class="bound">r</span> <span class="main">←</span> op_find_lasso_spec <span class="main">(</span>ngba_igbg <span class="free">A</span><span class="main">)</span><span class="main">;</span> RETURN <span class="main">(</span><span class="bound">r</span> <span class="main">=</span> None<span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">autoref_monadic</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">plain</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">ngba_language_empty</span> <span class="keyword2"><span class="keyword">uses</span></span> ngba_language_empty
    <span class="keyword1" id="NGBA_Algorithms-nba_language_empty_refine"><span class="command">lemma</span></span> nba_language_empty_refine<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'statei</span> <span class="main">×</span> <span class="tfree">'state</span><span class="main">)</span> set"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SIDE_PRECOND <span class="main">(</span>finite <span class="main">(</span>NGBA.nodes <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SIDE_GEN_ALGO <span class="main">(</span>is_bounded_hashcode <span class="free">S</span> <span class="free">seq</span> <span class="free">bhc</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SIDE_GEN_ALGO <span class="main">(</span>is_valid_def_hm_size <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'statei</span><span class="main">)</span> <span class="free">hms</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"GEN_OP <span class="free">seq</span> HOL.eq <span class="main">(</span><span class="free">S</span> <span class="main">→</span> <span class="free">S</span> <span class="main">→</span> bool_rel<span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Ai</span><span class="main">,</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> ngbai_ngba_rel"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>NGBA_Algorithms.ngba_language_empty <span class="free">seq</span> <span class="free">bhc</span> <span class="free">hms</span> <span class="free">Ai</span><span class="main">,</span>
        <span class="main">(</span><span class="keyword1">OP</span> op_language_empty <span class="main">:::</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> ngbai_ngba_rel <span class="main">→</span> bool_rel<span class="main">)</span> <span class="main">$</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> bool_rel"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"NGBA.nodes <span class="free">A</span> <span class="main">=</span> op_reachable <span class="main">(</span>ngba_g <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ngba_g_V0 ngba_g_E_rtrancl<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span>g_E <span class="main">(</span>ngba_g <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> g_V0 <span class="main">(</span>ngba_g <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">interpret</span></span> igb_fr_graph <span class="quoted"><span class="quoted">"ngba_igbg <span class="free">A</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">unfolding</span></span> ngba_igbg_def ngba_g_def graph_rec.defs ngba_acc_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>RETURN <span class="main">(</span>NGBA_Algorithms.ngba_language_empty <span class="free">seq</span> <span class="free">bhc</span> <span class="free">hms</span> <span class="free">Ai</span><span class="main">)</span><span class="main">,</span>
        <span class="keyword1">do</span> <span class="main">{</span> <span class="bound">r</span> <span class="main">←</span> find_lasso_spec<span class="main">;</span> RETURN <span class="main">(</span><span class="bound">r</span> <span class="main">=</span> None<span class="main">)</span> <span class="main">}</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>bool_rel<span class="main">⟩</span> nres_rel"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ngba_language_empty.refine assms igb_fr_graph_axioms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">do</span> <span class="main">{</span> <span class="bound">r</span> <span class="main">←</span> find_lasso_spec<span class="main">;</span> RETURN <span class="main">(</span><span class="bound">r</span> <span class="main">=</span> None<span class="main">)</span> <span class="main">}</span><span class="main">,</span>
        RETURN <span class="main">(</span><span class="main">¬</span> Ex is_lasso_prpl<span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>bool_rel<span class="main">⟩</span> nres_rel"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> find_lasso_spec_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">refine_vcg</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"NGBA_Algorithms.ngba_language_empty <span class="free">seq</span> <span class="free">bhc</span> <span class="free">hms</span> <span class="free">Ai</span> <span class="main">⟷</span> <span class="main">¬</span> Ex is_lasso_prpl"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> nres_rel_comp <span class="keyword1"><span class="command">using</span></span> RETURN_nres_relD <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="main">¬</span> Ex is_acc_run"</span></span> <span class="keyword1"><span class="command">using</span></span> lasso_prpl_acc_run_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> NGBA.language <span class="free">A</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> NGBA_Graphs.acc_run_language is_igb_graph <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="NGBA_Algorithms-degeneralize_alt_def"><span class="command">lemma</span></span> degeneralize_alt_def<span class="main">:</span> <span class="quoted"><span class="quoted">"degeneralize <span class="free">A</span> <span class="main">=</span> nba
      <span class="main">(</span>ngba.alphabet <span class="free">A</span><span class="main">)</span>
      <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> ngba.initial <span class="free">A</span><span class="main">)</span>
      <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">k</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> Degeneralization.count <span class="main">(</span>ngba.accepting <span class="free">A</span><span class="main">)</span> <span class="bound">p</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> ngba.transition <span class="free">A</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">)</span>
      <span class="main">(</span>degen <span class="main">(</span>ngba.accepting <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> degeneralization.degeneralize_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">schematic_goal</span></span> ngba_degeneralize<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?f</span> <span class="main">::</span> <span class="tvar">?'a</span><span class="main">,</span> degeneralize<span class="main">)</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> degeneralize_alt_def
      <span class="keyword1"><span class="command">using</span></span> degen_param<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span> count_param<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">autoref</span>
    <span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">ngba_degeneralize</span> <span class="keyword2"><span class="keyword">uses</span></span> ngba_degeneralize
    <span class="keyword1"><span class="command">lemmas</span></span> ngba_degeneralize_refine<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span> <span class="main">=</span> ngba_degeneralize.refine

    <span class="keyword1"><span class="command">schematic_goal</span></span> nba_intersect'<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">seq</span><span class="main">,</span> HOL.eq<span class="main">)</span> <span class="main">∈</span> <span class="free">L</span> <span class="main">→</span> <span class="free">L</span> <span class="main">→</span> bool_rel"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?f</span><span class="main">,</span> intersect'<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nbai_nba_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">T</span><span class="main">⟩</span> nbai_nba_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">T</span><span class="main">⟩</span> ngbai_ngba_rel"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> intersection.product_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">autoref</span>
    <span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">nba_intersect'</span> <span class="keyword2"><span class="keyword">uses</span></span> nba_intersect'
    <span class="keyword1" id="NGBA_Algorithms-nba_intersect'_refine"><span class="command">lemma</span></span> nba_intersect'_refine<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"GEN_OP <span class="free">seq</span> HOL.eq <span class="main">(</span><span class="free">L</span> <span class="main">→</span> <span class="free">L</span> <span class="main">→</span> bool_rel<span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nba_intersect' <span class="free">seq</span><span class="main">,</span> intersect'<span class="main">)</span> <span class="main">∈</span>
        <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span><span class="main">⟩</span> nbai_nba_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">T</span><span class="main">⟩</span> nbai_nba_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">L</span><span class="main">,</span> <span class="free">S</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">T</span><span class="main">⟩</span> ngbai_ngba_rel"</span></span>
      <span class="keyword1"><span class="command">using</span></span> nba_intersect'.refine assms <span class="keyword1"><span class="command">unfolding</span></span> <span class="dynamic"><span class="dynamic">autoref_tag_defs</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>

  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="NBTA">
<div class="head">
<h1>Theory NBTA</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Nondeterministic Büchi Transition Automata›</span></span>

<span class="keyword1"><span class="command">theory</span></span> NBTA
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Nondeterministic.html">../Nondeterministic</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> nbta <span class="main">=</span> nbta
    <span class="main">(</span><span class="free"><span class="entity">alphabet</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> set"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">initial</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> set"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">transition</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> set"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">accepting</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'state</span> <span class="main">×</span> <span class="tfree">'label</span> <span class="main">×</span> <span class="tfree">'state</span><span class="main">)</span> pred"</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">global_interpretation</span></span> nbta<span class="main">:</span> automaton <span class="quoted">nbta</span> <span class="quoted">alphabet</span> <span class="quoted">initial</span> <span class="quoted">transition</span> <span class="quoted">accepting</span>
    <span class="keyword2"><span class="keyword">defines</span></span> path <span class="main">=</span> <span class="quoted">nbta.path</span> <span class="keyword2"><span class="keyword">and</span></span> run <span class="main">=</span> <span class="quoted">nbta.run</span> <span class="keyword2"><span class="keyword">and</span></span> reachable <span class="main">=</span> <span class="quoted">nbta.reachable</span> <span class="keyword2"><span class="keyword">and</span></span> nodes <span class="main">=</span> <span class="quoted">nbta.nodes</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">global_interpretation</span></span> nbta<span class="main">:</span> automaton_run <span class="quoted">nbta</span> <span class="quoted">alphabet</span> <span class="quoted">initial</span> <span class="quoted">transition</span> <span class="quoted">accepting</span>
    <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> infs <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span> <span class="main">|||</span> <span class="bound">w</span> <span class="main">|||</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">defines</span></span> language <span class="main">=</span> <span class="quoted">nbta.language</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span>

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">target</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">target</span> <span class="main">≡</span> nbta.target"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">states</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">states</span> <span class="main">≡</span> nbta.states"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">trace</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">trace</span> <span class="main">≡</span> nbta.trace"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">successors</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">successors</span> <span class="main">≡</span> nbta.successors <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'label</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="NGBTA">
<div class="head">
<h1>Theory NGBTA</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Nondeterministic Generalized Büchi Transition Automata›</span></span>

<span class="keyword1"><span class="command">theory</span></span> NGBTA
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="Nondeterministic.html">../Nondeterministic</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'label</span><span class="main">,</span> <span class="tfree">'state</span><span class="main">)</span> ngbta <span class="main">=</span> ngbta
    <span class="main">(</span><span class="free"><span class="entity">alphabet</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> set"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">initial</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'state</span> set"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">transition</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'label</span> <span class="main">⇒</span> <span class="tfree">'state</span> <span class="main">⇒</span> <span class="tfree">'state</span> set"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="free"><span class="entity">accepting</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'state</span> <span class="main">×</span> <span class="tfree">'label</span> <span class="main">×</span> <span class="tfree">'state</span><span class="main">)</span> pred gen"</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">global_interpretation</span></span> ngbta<span class="main">:</span> automaton <span class="quoted">ngbta</span> <span class="quoted">alphabet</span> <span class="quoted">initial</span> <span class="quoted">transition</span> <span class="quoted">accepting</span>
    <span class="keyword2"><span class="keyword">defines</span></span> path <span class="main">=</span> <span class="quoted">ngbta.path</span> <span class="keyword2"><span class="keyword">and</span></span> run <span class="main">=</span> <span class="quoted">ngbta.run</span> <span class="keyword2"><span class="keyword">and</span></span> reachable <span class="main">=</span> <span class="quoted">ngbta.reachable</span> <span class="keyword2"><span class="keyword">and</span></span> nodes <span class="main">=</span> <span class="quoted">ngbta.nodes</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">global_interpretation</span></span> ngbta<span class="main">:</span> automaton_run <span class="quoted">ngbta</span> <span class="quoted">alphabet</span> <span class="quoted">initial</span> <span class="quoted">transition</span> <span class="quoted">accepting</span>
    <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> gen infs <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span> <span class="main">|||</span> <span class="bound">w</span> <span class="main">|||</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">defines</span></span> language <span class="main">=</span> <span class="quoted">ngbta.language</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span>

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">target</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">target</span> <span class="main">≡</span> ngbta.target"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">states</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">states</span> <span class="main">≡</span> ngbta.states"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">trace</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">trace</span> <span class="main">≡</span> ngbta.trace"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">successors</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">successors</span> <span class="main">≡</span> ngbta.successors <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'label</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="NBTA_Combine">
<div class="head">
<h1>Theory NBTA_Combine</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Nondeterministic Büchi Transition Automata Combinations›</span></span>

<span class="keyword1"><span class="command">theory</span></span> NBTA_Combine
<span class="keyword2"><span class="keyword">imports</span></span> <a href="NBTA.html">NBTA</a> <a href="NGBTA.html">NGBTA</a>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">global_interpretation</span></span> degeneralization<span class="main">:</span> automaton_degeneralization_run
    <span class="quoted">ngbta</span> <span class="quoted">ngbta.alphabet</span> <span class="quoted">ngbta.initial</span> <span class="quoted">ngbta.transition</span> <span class="quoted">ngbta.accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> gen infs <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span> <span class="main">|||</span> <span class="bound">w</span> <span class="main">|||</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted">nbta</span> <span class="quoted">nbta.alphabet</span> <span class="quoted">nbta.initial</span> <span class="quoted">nbta.transition</span> <span class="quoted">nbta.accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> infs <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span> <span class="main">|||</span> <span class="bound">w</span> <span class="main">|||</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted">id</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="main">(</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">k</span><span class="main">)</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">,</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">defines</span></span> degeneralize <span class="main">=</span> <span class="quoted">degeneralization.degeneralize</span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> stream"</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> stream"</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">cs</span> <span class="skolem">p</span> <span class="skolem">k</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="main">(</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">k</span><span class="main">)</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">,</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sscan <span class="main">(</span>count <span class="skolem">cs</span> <span class="main">∘</span> id<span class="main">)</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">##</span> <span class="skolem">r</span> <span class="main">|||</span> <span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span>degen <span class="skolem">cs</span> <span class="main">∘</span> <span class="var">?f</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">##</span> <span class="main">(</span><span class="skolem">r</span> <span class="main">|||</span> <span class="var">?s</span><span class="main">)</span> <span class="main">|||</span> <span class="skolem">w</span> <span class="main">|||</span> <span class="main">(</span><span class="skolem">r</span> <span class="main">|||</span> <span class="var">?s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span>
      infs <span class="main">(</span>degen <span class="skolem">cs</span><span class="main">)</span> <span class="main">(</span>smap <span class="var">?f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">##</span> <span class="main">(</span><span class="skolem">r</span> <span class="main">|||</span> <span class="var">?s</span><span class="main">)</span> <span class="main">|||</span> <span class="skolem">w</span> <span class="main">|||</span> <span class="main">(</span><span class="skolem">r</span> <span class="main">|||</span> <span class="var">?s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"smap <span class="var">?f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">##</span> <span class="main">(</span><span class="skolem">r</span> <span class="main">|||</span> <span class="var">?s</span><span class="main">)</span> <span class="main">|||</span> <span class="skolem">w</span> <span class="main">|||</span> <span class="main">(</span><span class="skolem">r</span> <span class="main">|||</span> <span class="var">?s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">##</span> <span class="skolem">r</span> <span class="main">|||</span> <span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">|||</span> <span class="skolem">k</span> <span class="main">##</span> <span class="var">?s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="skolem">r</span></span> <span class="quoted"><span class="skolem">w</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eq_scons <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> szip_unfold sscan_scons<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">##</span> <span class="skolem">r</span> <span class="main">|||</span> <span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">|||</span> <span class="skolem">k</span> <span class="main">##</span> sscan <span class="main">(</span>count <span class="skolem">cs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">##</span> <span class="skolem">r</span> <span class="main">|||</span> <span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span>degen <span class="skolem">cs</span><span class="main">)</span> <span class="main">…</span> <span class="main">=</span> gen infs <span class="skolem">cs</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">##</span> <span class="skolem">r</span> <span class="main">|||</span> <span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> degen_infs <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"infs <span class="main">(</span>degen <span class="skolem">cs</span> <span class="main">∘</span> <span class="var">?f</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">##</span> <span class="main">(</span><span class="skolem">r</span> <span class="main">|||</span> <span class="var">?s</span><span class="main">)</span> <span class="main">|||</span> <span class="skolem">w</span> <span class="main">|||</span> <span class="main">(</span><span class="skolem">r</span> <span class="main">|||</span> <span class="var">?s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span>
      gen infs <span class="skolem">cs</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">##</span> <span class="skolem">r</span> <span class="main">|||</span> <span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemmas</span></span> degeneralize_language<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> degeneralization.degeneralize_language<span class="main">[</span><span class="operator">folded</span> NBTA.language_def<span class="main">]</span>
  <span class="keyword1"><span class="command">lemmas</span></span> degeneralize_nodes_finite<span class="main">[</span><span class="operator">iff</span><span class="main">]</span> <span class="main">=</span> degeneralization.degeneralize_nodes_finite<span class="main">[</span><span class="operator">folded</span> NBTA.nodes_def<span class="main">]</span>

  <span class="keyword1"><span class="command">global_interpretation</span></span> intersection<span class="main">:</span> automaton_intersection_run
    <span class="quoted">nbta</span> <span class="quoted">nbta.alphabet</span> <span class="quoted">nbta.initial</span> <span class="quoted">nbta.transition</span> <span class="quoted">nbta.accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> infs <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span> <span class="main">|||</span> <span class="bound">w</span> <span class="main">|||</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted">nbta</span> <span class="quoted">nbta.alphabet</span> <span class="quoted">nbta.initial</span> <span class="quoted">nbta.transition</span> <span class="quoted">nbta.accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> infs <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span> <span class="main">|||</span> <span class="bound">w</span> <span class="main">|||</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted">ngbta</span> <span class="quoted">ngbta.alphabet</span> <span class="quoted">ngbta.initial</span> <span class="quoted">ngbta.transition</span> <span class="quoted">ngbta.accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> gen infs <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span> <span class="main">|||</span> <span class="bound">w</span> <span class="main">|||</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="main">[</span><span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="main">(</span><span class="bound">q<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">q<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">q<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="main">(</span><span class="bound">q<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">q<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">q<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span><span class="main">]</span>"</span></span>
    <span class="keyword2"><span class="keyword">defines</span></span> intersect' <span class="main">=</span> <span class="quoted">intersection.product</span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> stream"</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> stream"</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span> stream"</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">p</span> <span class="skolem">q</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?tfst</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="main">(</span><span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="main">(</span><span class="bound">q<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">q<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">q<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?tsnd</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="main">(</span><span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="main">(</span><span class="bound">q<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">q<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">q<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gen infs <span class="main">[</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∘</span> <span class="var">?tfst</span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∘</span> <span class="var">?tsnd</span><span class="main">]</span> <span class="main">(</span><span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">##</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">|||</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">|||</span> <span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">u</span> <span class="main">|||</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">⟷</span>
      infs <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span>smap <span class="var">?tfst</span> <span class="main">(</span><span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">##</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">|||</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">|||</span> <span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">u</span> <span class="main">|||</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
      infs <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span>smap <span class="var">?tsnd</span> <span class="main">(</span><span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">##</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">|||</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">|||</span> <span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">u</span> <span class="main">|||</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> gen_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"smap <span class="var">?tfst</span> <span class="main">(</span><span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">##</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">|||</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">|||</span> <span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">u</span> <span class="main">|||</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">##</span> <span class="skolem">u</span> <span class="main">|||</span> <span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">q</span></span> <span class="quoted"><span class="skolem">u</span></span> <span class="quoted"><span class="skolem">v</span></span> <span class="quoted"><span class="skolem">w</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> szip_unfold<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> stream.collapse<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"smap <span class="var">?tsnd</span> <span class="main">(</span><span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">##</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">|||</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">|||</span> <span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">u</span> <span class="main">|||</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">q</span> <span class="main">##</span> <span class="skolem">v</span> <span class="main">|||</span> <span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">q</span></span> <span class="quoted"><span class="skolem">u</span></span> <span class="quoted"><span class="skolem">v</span></span> <span class="quoted"><span class="skolem">w</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> szip_unfold<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> stream.collapse<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"gen infs <span class="main">[</span><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∘</span> <span class="var">?tfst</span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∘</span> <span class="var">?tsnd</span><span class="main">]</span> <span class="main">(</span><span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">##</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">|||</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">|||</span> <span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">u</span> <span class="main">|||</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">⟷</span>
      infs <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="skolem">p</span> <span class="main">##</span> <span class="skolem">u</span> <span class="main">|||</span> <span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∧</span> infs <span class="skolem">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">q</span> <span class="main">##</span> <span class="skolem">v</span> <span class="main">|||</span> <span class="skolem">w</span> <span class="main">|||</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemmas</span></span> intersect'_language<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> intersection.product_language<span class="main">[</span><span class="operator">folded</span> NGBTA.language_def<span class="main">]</span>
  <span class="keyword1"><span class="command">lemmas</span></span> intersect'_nodes_finite<span class="main">[</span><span class="operator">intro</span><span class="main">]</span> <span class="main">=</span> intersection.product_nodes_finite<span class="main">[</span><span class="operator">folded</span> NGBTA.nodes_def<span class="main">]</span>

  <span class="keyword1"><span class="command">global_interpretation</span></span> union<span class="main">:</span> automaton_union_run
    <span class="quoted">nbta</span> <span class="quoted">nbta.alphabet</span> <span class="quoted">nbta.initial</span> <span class="quoted">nbta.transition</span> <span class="quoted">nbta.accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> infs <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span> <span class="main">|||</span> <span class="bound">w</span> <span class="main">|||</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted">nbta</span> <span class="quoted">nbta.alphabet</span> <span class="quoted">nbta.initial</span> <span class="quoted">nbta.transition</span> <span class="quoted">nbta.accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> infs <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span> <span class="main">|||</span> <span class="bound">w</span> <span class="main">|||</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted">nbta</span> <span class="quoted">nbta.alphabet</span> <span class="quoted">nbta.initial</span> <span class="quoted">nbta.transition</span> <span class="quoted">nbta.accepting</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">P</span> <span class="bound">w</span> <span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> infs <span class="bound">P</span> <span class="main">(</span><span class="bound">p</span> <span class="main">##</span> <span class="bound">r</span> <span class="main">|||</span> <span class="bound">w</span> <span class="main">|||</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">m</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">m</span> <span class="keyword1">of</span> <span class="main">(</span>Inl <span class="bound">p</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> Inl <span class="bound">q</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span> <span class="main">|</span> <span class="main">(</span>Inr <span class="bound">p</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> Inr <span class="bound">q</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">a</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">defines</span></span> union <span class="main">=</span> <span class="quoted">union.sum</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> szip_smap_fold comp_def case_prod_unfold <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> stream.map<span class="main">)</span>

  <span class="keyword1"><span class="command">lemmas</span></span> union_language <span class="main">=</span> union.sum_language
  <span class="keyword1"><span class="command">lemmas</span></span> union_nodes_finite <span class="main">=</span> union.sum_nodes_finite

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">intersect</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">intersect</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> degeneralize <span class="main">(</span>intersect' <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="NBTA_Combine-intersect_language"><span class="command">lemma</span></span> intersect_language<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"NBTA.language <span class="main">(</span>intersect <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> NBTA.language <span class="free">A</span> <span class="main">∩</span> NBTA.language <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1" id="NBTA_Combine-intersect_nodes_finite"><span class="command">lemma</span></span> intersect_nodes_finite<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>NBTA.nodes <span class="free">A</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>NBTA.nodes <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>NBTA.nodes <span class="main">(</span>intersect <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> intersect'_nodes_finite assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div>