<div id="Lucas_Theorem">
<div class="head">
<h1>Theory Lucas_Theorem</h1>
</div>
<pre class="source"><span class="comment1">(* 
  Title: Lucas_Theorem.thy
  Author: Chelsea Edmonds, University of Cambridge
*)</span>

<span class="keyword1"><span class="command">theory</span></span> Lucas_Theorem
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <span class="quoted">"<a href="../../HOL/HOL-Computational_Algebra/Computational_Algebra.html">HOL-Computational_Algebra.Computational_Algebra</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">notation</span></span> fps_nth <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">$</span>"</span> 75<span class="main">)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Extensions on Formal Power Series (FPS) Library›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This section presents a few extensions on the Formal Power Series (FPS) library, described in \cite{Chaieb2011} ›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹FPS Equivalence Relation ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ This proof requires reasoning around the equivalence of coefficients mod some prime number. 
This section defines an equivalence relation on FPS using the pattern described by Paulson 
in \cite{paulsonDefiningFunctionsEquivalence2006}, as well as some basic lemmas for reasoning around 
how the equivalence holds after common operations are applied ›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">fpsmodrel</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> <span class="main">{</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">g</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="bound">f</span> <span class="main">$</span> <span class="bound">n</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="bound">g</span> <span class="main">$</span> <span class="bound">n</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fpsrel_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">g</span><span class="main">)</span> <span class="main">∈</span> fpsmodrel <span class="free">p</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="main">$</span> <span class="bound">n</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="free">g</span> <span class="main">$</span> <span class="bound">n</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fpsmodrel_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fps_equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"equiv UNIV <span class="main">(</span>fpsmodrel <span class="free">p</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> equivI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"refl <span class="main">(</span>fpsmodrel <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> refl_on_def fpsmodrel_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sym <span class="main">(</span>fpsmodrel <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sym_def fpsmodrel_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"trans <span class="main">(</span>fpsmodrel <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> transI<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fpsmodrel_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Equivalence relation over multiplication ›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fps_mult_equiv_coeff<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>euclidean_ring_cancel<span class="main">}</span><span class="main">)</span> fps"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">g</span><span class="main">)</span> <span class="main">∈</span> fpsmodrel <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">*</span><span class="free">h</span><span class="main">)</span><span class="main">$</span><span class="free">n</span> <span class="keyword1">mod</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="free">g</span><span class="main">*</span><span class="free">h</span><span class="main">)</span><span class="main">$</span><span class="free">n</span> <span class="keyword1">mod</span> <span class="free">p</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">*</span><span class="free">h</span><span class="main">)</span> <span class="main">$</span> <span class="free">n</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">p</span> <span class="main">=</span><span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span><span class="main">$</span><span class="bound">i</span> <span class="keyword1">mod</span> <span class="free">p</span> <span class="main">*</span> <span class="free">h</span><span class="main">$</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mod_sum_eq mod_mult_left_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_mult_nth mod_sum_eq mod_mult_left_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="free">g</span><span class="main">$</span><span class="bound">i</span> <span class="keyword1">mod</span> <span class="free">p</span> <span class="main">*</span> <span class="free">h</span><span class="main">$</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">g</span><span class="main">*</span><span class="free">h</span><span class="main">)</span> <span class="main">$</span> <span class="free">n</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mod_mult_left_eq mod_sum_eq fps_mult_nth<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> calculation<span class="main">)</span>  
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fps_mult_equiv<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>euclidean_ring_cancel<span class="main">}</span><span class="main">)</span> fps"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">g</span><span class="main">)</span> <span class="main">∈</span> fpsmodrel <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">*</span><span class="free">h</span><span class="main">,</span> <span class="free">g</span><span class="main">*</span><span class="free">h</span><span class="main">)</span> <span class="main">∈</span> fpsmodrel <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fpsmodrel_def fps_mult_equiv_coeff assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Equivalence relation over power operator ›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> fps_power_equiv<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>euclidean_ring_cancel<span class="main">}</span><span class="main">)</span> fps"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">g</span><span class="main">)</span> <span class="main">∈</span> fpsmodrel <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">^</span><span class="free">x</span><span class="main">,</span> <span class="free">g</span><span class="main">^</span><span class="free">x</span><span class="main">)</span> <span class="main">∈</span> fpsmodrel <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fpsmodrel_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> hyp<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="free">f</span><span class="main">^</span><span class="skolem">x</span> <span class="main">$</span> <span class="bound">n</span> <span class="keyword1">mod</span> <span class="free">p</span> <span class="main">=</span> <span class="free">g</span> <span class="main">^</span><span class="skolem">x</span> <span class="main">$</span> <span class="bound">n</span> <span class="keyword1">mod</span> <span class="free">p</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> fpsrel_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> fact<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span> <span class="bound">h</span><span class="main">.</span> <span class="main">(</span><span class="free">g</span> <span class="main">*</span> <span class="bound">h</span><span class="main">)</span> <span class="main">$</span> <span class="bound">n</span> <span class="keyword1">mod</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="main">*</span> <span class="bound">h</span><span class="main">)</span> <span class="main">$</span> <span class="bound">n</span> <span class="keyword1">mod</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms fps_mult_equiv_coeff<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span> <span class="bound">h</span><span class="main">.</span> <span class="main">(</span><span class="free">g</span> <span class="main">^</span> <span class="skolem">x</span> <span class="main">*</span> <span class="bound">h</span><span class="main">)</span> <span class="main">$</span> <span class="bound">n</span> <span class="keyword1">mod</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="main">^</span> <span class="skolem">x</span> <span class="main">*</span> <span class="bound">h</span><span class="main">)</span> <span class="main">$</span> <span class="bound">n</span> <span class="keyword1">mod</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_mult_equiv_coeff hyp<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span> <span class="bound">h</span><span class="main">.</span> <span class="main">(</span><span class="bound">h</span> <span class="main">*</span> <span class="free">g</span> <span class="main">^</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">$</span> <span class="bound">n</span> <span class="keyword1">mod</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="bound">h</span> <span class="main">*</span> <span class="free">f</span> <span class="main">^</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">$</span> <span class="bound">n</span> <span class="keyword1">mod</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.commute<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> fact <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Binomial Coefficients ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"fps_binomial"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> definition in the formal power series uses the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">n</span></span> <span class="keyword1"><span class="keyword1">gchoose</span></span> <span class="free"><span class="free">k</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> operator. It's 
defined as being of type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'a</span></span> <span class="main"><span class="main">::</span></span> field_char_0 fps"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, however the equivalence relation requires a type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> 
that supports the modulo operator. 
The proof of the binomial theorem based on FPS coefficients below uses the choose operator and does
not put bounds on the type of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"fps_X"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> binomial_coeffs_induct<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="free">k</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">+</span> fps_X<span class="main">)</span><span class="main">^</span><span class="free">n</span> <span class="main">$</span> <span class="free">k</span> <span class="main">=</span> of_nat<span class="main">(</span><span class="free">n</span> <span class="keyword1">choose</span> <span class="free">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> binomial_eq_0_iff binomial_n_0 fps_nth_of_nat not_gr_zero of_nat_0 of_nat_1 power_0<span class="main">)</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> h<span class="main">:</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> 
  <span class="keyword1"><span class="command">have</span></span> start<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">+</span> fps_X<span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> fps_X<span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> fps_X<span class="main">)</span><span class="main">^</span><span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> One_nat_def Suc_eq_plus1 Suc_pred add.commute binomial_Suc_Suc binomial_n_0 
        fps_mult_fps_X_plus_1_nth h.hyps neq0_conv start <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> of_nat_add<span class="main">)</span>  
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Freshman's Dream Lemma on FPS ›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ The Freshman's dream lemma modulo a prime number $p$ is a well known proof that $(1 + x^p) \equiv (1 + x)^p \mod p$›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ First prove that $\binom{p^n}{k} \equiv 0 \mod p$ for $k \ge 1$ and $k &lt; p^n$. The eventual
proof only ended up requiring this with $n = 1$›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pn_choose_k_modp_0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="free">k</span><span class="main">::</span><span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≥</span> <span class="main">1</span> <span class="main">∧</span> <span class="free">k</span> <span class="main">≤</span> <span class="free">p</span><span class="main">^</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span><span class="main">^</span><span class="free">n</span> <span class="keyword1">choose</span> <span class="free">k</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> inequality<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">p</span><span class="main">^</span><span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">have</span></span> choose_take_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">p</span><span class="main">^</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="main">(</span> <span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">=</span> fact <span class="main">(</span><span class="free">p</span><span class="main">^</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="main">(</span>fact <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> fact <span class="main">(</span><span class="free">p</span><span class="main">^</span><span class="free">n</span> <span class="main">-</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> binomial_altdef_nat diff_le_mono inequality assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">*</span> <span class="main">(</span><span class="free">p</span><span class="main">^</span><span class="free">n</span> <span class="keyword1">choose</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">k</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>fact <span class="main">(</span><span class="free">p</span><span class="main">^</span><span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> <span class="main">(</span>fact <span class="free">k</span> <span class="main">*</span> fact<span class="main">(</span><span class="main">(</span><span class="free">p</span><span class="main">^</span><span class="free">n</span><span class="main">)</span> <span class="main">-</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms binomial_fact'<span class="main">[</span><span class="operator">OF</span> inequality<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">k</span> <span class="main">*</span> fact <span class="main">(</span><span class="free">p</span><span class="main">^</span><span class="free">n</span><span class="main">)</span> <span class="keyword1">div</span> <span class="main">(</span>fact <span class="free">k</span> <span class="main">*</span> fact<span class="main">(</span><span class="main">(</span><span class="free">p</span><span class="main">^</span><span class="free">n</span><span class="main">)</span> <span class="main">-</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> binomial_fact_lemma div_mult_self_is_m fact_gt_zero inequality mult.assoc mult.commute 
          nat_0_less_mult_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">smt</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">k</span> <span class="main">*</span> fact <span class="main">(</span><span class="free">p</span><span class="main">^</span><span class="free">n</span><span class="main">)</span> <span class="keyword1">div</span> <span class="main">(</span><span class="free">k</span> <span class="main">*</span> fact <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> fact<span class="main">(</span><span class="main">(</span><span class="free">p</span><span class="main">^</span><span class="free">n</span><span class="main">)</span> <span class="main">-</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> fact_nonzero fact_num_eq_if le0 le_antisym of_nat_id<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> fact <span class="main">(</span><span class="free">p</span><span class="main">^</span><span class="free">n</span><span class="main">)</span> <span class="keyword1">div</span> <span class="main">(</span>fact <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> fact<span class="main">(</span><span class="main">(</span><span class="free">p</span><span class="main">^</span><span class="free">n</span><span class="main">)</span> <span class="main">-</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">p</span><span class="main">^</span><span class="free">n</span><span class="main">)</span> <span class="main">*</span> fact <span class="main">(</span><span class="free">p</span><span class="main">^</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> <span class="main">(</span>fact <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> fact<span class="main">(</span><span class="main">(</span><span class="free">p</span><span class="main">^</span><span class="free">n</span><span class="main">)</span> <span class="main">-</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> fact_nonzero fact_num_eq_if inequality le0 le_antisym of_nat_id<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="free">p</span><span class="main">^</span><span class="free">n</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>fact <span class="main">(</span><span class="free">p</span><span class="main">^</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="main">(</span>fact <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> fact<span class="main">(</span><span class="main">(</span><span class="free">p</span><span class="main">^</span><span class="free">n</span><span class="main">)</span> <span class="main">-</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> calculation choose_take_1 neq0_conv not_one_le_zero times_binomial_minus1_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> equality<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">*</span> <span class="main">(</span><span class="free">p</span><span class="main">^</span><span class="free">n</span> <span class="keyword1">choose</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span><span class="main">^</span><span class="free">n</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">p</span><span class="main">^</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> times_binomial_minus1_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> dvd_result<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">^</span><span class="free">n</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="free">k</span> <span class="main">*</span> <span class="main">(</span><span class="free">p</span><span class="main">^</span><span class="free">n</span> <span class="keyword1">choose</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">p</span><span class="main">^</span><span class="free">n</span> <span class="keyword1">dvd</span> <span class="free">k</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms <span class="main">(</span>2<span class="main">)</span> binomial_n_0 diff_diff_cancel nat_dvd_not_less neq0_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="free">p</span><span class="main">^</span><span class="free">n</span> <span class="keyword1">choose</span> <span class="free">k</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> mult.commute prime_imp_prime_elem prime_power_dvd_multD assms dvd_result <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Applying the above lemma to the coefficients of $(1 + X)^p$, it is easy to show that all 
coefficients other than the $0$th and $p$th will be $0$ ›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fps_middle_coeffs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">n</span> <span class="main">≠</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">+</span> fps_X <span class="main">::</span> int fps<span class="main">)</span> <span class="main">^</span><span class="free">p</span><span class="main">)</span> <span class="main">$</span> <span class="free">n</span> <span class="keyword1">mod</span> <span class="free">p</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">mod</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">+</span> fps_X <span class="main">::</span> int fps<span class="main">)</span><span class="main">^</span><span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="free">p</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">p</span> <span class="keyword1">choose</span> <span class="bound">n</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pn_choose_k_modp_0
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> add_le_imp_le_diff assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> diff_diff_cancel diff_is_0_eq' 
        discrete le_add_diff_inverse le_numeral_extra<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> power_one_right zero_le_one zero_less_one<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> middle_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="free">p</span> <span class="main">⟶</span> <span class="main">(</span><span class="var">?f</span> <span class="main">$</span> <span class="bound">n</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> binomial_coeffs_induct <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> of_nat_0 zmod_int<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&gt;</span> <span class="free">p</span> <span class="main">⟶</span> <span class="var">?f</span> <span class="main">$</span> <span class="bound">n</span> <span class="keyword1">mod</span> <span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> binomial_eq_0_iff binomial_coeffs_induct mod_0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> of_nat_eq_0_iff<span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> middle_0 assms<span class="main">(</span>2<span class="main">)</span> nat_neq_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹It follows that $(1+ X)^p$ is equivalent to $(1 + X^p)$ under our equivalence relation, 
as required to prove the freshmans dream lemma. ›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fps_freshmans_dream<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">+</span> fps_X <span class="main">::</span> int fps <span class="main">)</span> <span class="main">^</span><span class="free">p</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">(</span>fps_X<span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> fpsmodrel <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">+</span> fps_X <span class="main">::</span> int fps<span class="main">)</span><span class="main">^</span><span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">(</span>fps_X <span class="main">::</span> int fps<span class="main">)</span><span class="main">^</span><span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> all_f_coeffs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">n</span> <span class="main">≠</span> <span class="free">p</span> <span class="main">⟶</span> <span class="var">?f</span> <span class="main">$</span> <span class="bound">n</span> <span class="keyword1">mod</span> <span class="free">p</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">mod</span> <span class="free">p</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> fps_middle_coeffs assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g</span> <span class="main">$</span> <span class="main">0</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g</span> <span class="main">$</span> <span class="main">0</span> <span class="keyword1">mod</span> <span class="free">p</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">mod</span> <span class="free">p</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> int_ops<span class="main">(</span>2<span class="main">)</span> zmod_int assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g</span> <span class="main">$</span> <span class="free">p</span> <span class="keyword1">mod</span> <span class="free">p</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">mod</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">n</span> <span class="main">.</span> <span class="var">?f</span> <span class="main">$</span> <span class="bound">n</span> <span class="keyword1">mod</span> <span class="free">p</span> <span class="main">=</span> <span class="var">?g</span> <span class="main">$</span> <span class="bound">n</span> <span class="keyword1">mod</span> <span class="free">p</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> all_f_coeffs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> binomial_coeffs_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> fpsrel_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Lucas's Theorem Proof›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A formalisation of Lucas's theorem based on a generating function proof using the existing formal power series (FPS) Isabelle library›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Reasoning about Coefficients Helpers›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A generating function proof of Lucas's theorem relies on direct comparison between coefficients of FPS which requires a number 
of helper lemmas to prove formally. In particular it compares the coefficients of 
$(1 + X)^n \mod p$ to $(1 + X^p)^N * (1 + X) ^rn \mod p$, where $N = n / p$, and $rn = n \mod p$.
This section proves that the $k$th coefficient of $(1 + X^p)^N * (1 + X) ^rn = (N choose K) * (rn choose rk)$›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Applying the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"fps_compose"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> operator enables reasoning about the coefficients of $(1 + X^p)^n$ 
using the existing binomial theorem proof with $X^p$ instead of $X$.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fps_binomial_p_compose<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">(</span>fps_X<span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>idom<span class="main">}</span> fps<span class="main">)</span><span class="main">)</span><span class="main">^</span><span class="free">p</span><span class="main">)</span><span class="main">^</span><span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">+</span> fps_X<span class="main">)</span><span class="main">^</span><span class="free">n</span><span class="main">)</span> <span class="keyword1">oo</span> <span class="main">(</span>fps_X<span class="main">^</span><span class="free">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span><span class="main">::</span><span class="tfree">'a</span> fps<span class="main">)</span> <span class="main">+</span> fps_X <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> fps_X <span class="keyword1">oo</span> fps_X <span class="main">^</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms fps_compose_add_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms fps_compose_power<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ Next the proof determines the value of the $k$th coefficient of $(1 + X^p)^N$. ›</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> fps_X_pow_binomial_coeffs<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">(</span>fps_X <span class="main">::</span>int fps<span class="main">)</span><span class="main">^</span><span class="free">p</span><span class="main">)</span><span class="main">^</span><span class="free">N</span> <span class="main">$</span><span class="free">k</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">p</span> <span class="keyword1">dvd</span> <span class="free">k</span> <span class="keyword1">then</span> <span class="main">(</span><span class="free">N</span> <span class="keyword1">choose</span> <span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?fx</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fps_X <span class="main">::</span> int fps<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="var">?fx</span><span class="main">^</span><span class="free">p</span><span class="main">)</span><span class="main">^</span><span class="free">N</span> <span class="main">$</span> <span class="free">k</span>  <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="var">?fx</span><span class="main">)</span><span class="main">^</span><span class="free">N</span><span class="main">)</span> <span class="keyword1">oo</span> <span class="main">(</span><span class="var">?fx</span><span class="main">^</span><span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span><span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms fps_binomial_p_compose not_prime_0<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">.</span><span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="var">?fx</span><span class="main">)</span><span class="main">^</span><span class="free">N</span><span class="main">)</span><span class="main">$</span><span class="bound">i</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="var">?fx</span><span class="main">^</span><span class="free">p</span><span class="main">)</span><span class="main">^</span><span class="bound">i</span><span class="main">$</span><span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_compose_nth<span class="main">)</span> 
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> coeffs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="var">?fx</span><span class="main">^</span><span class="free">p</span><span class="main">)</span><span class="main">^</span><span class="free">N</span> <span class="main">$</span> <span class="free">k</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">.</span> <span class="main">(</span><span class="free">N</span> <span class="keyword1">choose</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="var">?fx</span><span class="main">^</span><span class="main">(</span><span class="free">p</span><span class="main">*</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">$</span><span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> binomial_coeffs_induct sum.cong <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> power_mult<span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">dvd</span> <span class="free">k</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="comment1">― ‹$p$ does not divide $k$ implies the $k$th term has a coefficient of 0›</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="main">¬</span><span class="main">(</span><span class="free">p</span> <span class="keyword1">dvd</span> <span class="free">k</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="var">?fx</span><span class="main">^</span><span class="main">(</span><span class="free">p</span><span class="main">*</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="free">k</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> coeffs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> False<span class="main">)</span> 
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="comment1">― ‹$p$ divides $k$ implies the $k$th term has a non-zero coefficient›</span>
    <span class="keyword1"><span class="command">have</span></span> contained<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="keyword1">div</span> <span class="free">p</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span> <span class="free">k</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≠</span> <span class="free">k</span> <span class="keyword1">div</span> <span class="free">p</span> <span class="main">⟶</span> <span class="main">(</span><span class="var">?fx</span><span class="main">^</span><span class="main">(</span><span class="free">p</span><span class="main">*</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="free">k</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> notdivpis0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span> <span class="main">..</span> <span class="free">k</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="free">k</span> <span class="keyword1">div</span> <span class="free">p</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="var">?fx</span><span class="main">^</span><span class="main">(</span><span class="free">p</span><span class="main">*</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="free">k</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="var">?fx</span><span class="main">^</span><span class="free">p</span><span class="main">)</span><span class="main">^</span><span class="free">N</span> <span class="main">$</span> <span class="free">k</span> <span class="main">=</span> <span class="main">(</span><span class="free">N</span> <span class="keyword1">choose</span> <span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="var">?fx</span><span class="main">^</span><span class="main">(</span><span class="free">p</span> <span class="main">*</span> <span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="free">k</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">}</span> <span class="main">-</span><span class="main">{</span><span class="free">k</span> <span class="keyword1">div</span> <span class="free">p</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">N</span> <span class="keyword1">choose</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="var">?fx</span><span class="main">^</span><span class="main">(</span><span class="free">p</span><span class="main">*</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">$</span><span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> contained coeffs sum.remove <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> finite_atLeastAtMost<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> notdivpis0 True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ The final helper lemma proves the $k$th coefficient is equivalent to $\binom{?N}{?K}*\binom{?rn}{?rk}$ as required.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> fps_div_rep_coeffs<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">(</span>fps_X<span class="main">::</span>int fps<span class="main">)</span><span class="main">^</span><span class="free">p</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="free">p</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> fps_X<span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="free">n</span> <span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="free">k</span> <span class="main">=</span> 
          <span class="main">(</span><span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="free">p</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">n</span> <span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="main">(</span><span class="free">k</span> <span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">(</span>fps_X<span class="main">::</span>int fps<span class="main">)</span><span class="main">^</span><span class="free">p</span><span class="main">)</span><span class="main">^</span><span class="var">?N</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> fps_X<span class="main">)</span><span class="main">^</span><span class="var">?rn</span><span class="main">)</span> <span class="main">$</span> <span class="free">k</span> <span class="main">=</span> <span class="main">(</span><span class="var">?N</span> <span class="keyword1">choose</span> <span class="var">?K</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="var">?rn</span> <span class="keyword1">choose</span> <span class="var">?rk</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="comment1">― ‹Initial facts with results around representation and 0 valued terms›</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?fx</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fps_X <span class="main">::</span> int fps"</span></span>
  <span class="keyword1"><span class="command">have</span></span> krep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">-</span> <span class="var">?rk</span> <span class="main">=</span> <span class="var">?K</span><span class="main">*</span><span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> minus_mod_eq_mult_div<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> rk_in_range<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?rk</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">≥</span> <span class="free">p</span><span class="main">.</span> <span class="main">(</span><span class="var">?rn</span> <span class="keyword1">choose</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> binomial_eq_0_iff 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> leD le_less_trans linorder_cases mod_le_divisor mod_less_divisor prime_gt_0_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ptok0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="free">p</span><span class="main">..</span><span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="var">?rn</span> <span class="keyword1">choose</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="var">?fx</span><span class="main">^</span><span class="free">p</span><span class="main">)</span><span class="main">^</span><span class="var">?N</span> <span class="main">$</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> notrkis0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span> <span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≠</span> <span class="var">?rk</span> <span class="main">⟶</span> <span class="main">(</span><span class="var">?rn</span> <span class="keyword1">choose</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="var">?fx</span><span class="main">^</span><span class="free">p</span><span class="main">)</span><span class="main">^</span><span class="var">?N</span> <span class="main">$</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="comment1">― ‹When $k &lt; p$, it presents a side case with regards to range of reasoning›</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> k_value<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> <span class="var">?rk</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="free">p</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> 
       <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_diff_cancel diff_is_0_eq dvd_imp_mod_0 less_imp_diff_less less_irrefl_nat mod_less<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> fps_X_pow_binomial_coeffs assms<span class="main">(</span>1<span class="main">)</span> k_value <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free">p</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≠</span> <span class="var">?rk</span> <span class="main">⟶</span> <span class="main">¬</span><span class="main">(</span><span class="free">p</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mod_nat_eqI <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">p</span><span class="main">}</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≠</span> <span class="var">?rk</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="var">?fx</span><span class="main">^</span><span class="free">p</span><span class="main">)</span><span class="main">^</span><span class="var">?N</span> <span class="main">$</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms fps_X_pow_binomial_coeffs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ptok0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="comment1">― ‹Main body of the proof, using helper facts above›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">+</span> fps_X<span class="main">^</span><span class="free">p</span><span class="main">)</span><span class="main">^</span><span class="var">?N</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> fps_X<span class="main">)</span><span class="main">^</span><span class="var">?rn</span><span class="main">)</span> <span class="main">$</span> <span class="free">k</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">+</span> fps_X<span class="main">)</span><span class="main">^</span><span class="var">?rn</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> fps_X<span class="main">^</span><span class="free">p</span><span class="main">)</span><span class="main">^</span><span class="var">?N</span><span class="main">)</span> <span class="main">$</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> distrib_left distrib_right fps_mult_fps_X_commute fps_one_mult<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> 
        fps_one_mult<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> power_commuting_commutes<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">.</span><span class="main">(</span>of_nat<span class="main">(</span><span class="var">?rn</span> <span class="keyword1">choose</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">(</span>fps_X<span class="main">)</span><span class="main">^</span><span class="free">p</span><span class="main">)</span><span class="main">^</span><span class="var">?N</span> <span class="main">$</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_mult_nth binomial_coeffs_induct<span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>  <span class="main">(</span><span class="main">(</span><span class="var">?rn</span> <span class="keyword1">choose</span> <span class="var">?rk</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="var">?fx</span><span class="main">^</span><span class="free">p</span><span class="main">)</span><span class="main">^</span><span class="var">?N</span> <span class="main">$</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="var">?rk</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">k</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="var">?rk</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="var">?rn</span> <span class="keyword1">choose</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="var">?fx</span><span class="main">^</span><span class="free">p</span><span class="main">)</span><span class="main">^</span><span class="var">?N</span> <span class="main">$</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> rk_in_range sum.remove <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> finite_atLeastAtMost<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="var">?fx</span><span class="main">^</span><span class="free">p</span><span class="main">)</span><span class="main">^</span><span class="var">?N</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="var">?fx</span><span class="main">)</span><span class="main">^</span><span class="var">?rn</span><span class="main">)</span> <span class="main">$</span> <span class="free">k</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="var">?rn</span> <span class="keyword1">choose</span> <span class="var">?rk</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="var">?fx</span><span class="main">^</span><span class="free">p</span><span class="main">)</span><span class="main">^</span><span class="var">?N</span> <span class="main">$</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="var">?rk</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> notrkis0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> fps_X_pow_binomial_coeffs assms krep <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* Lucas theorem proof *)</span> 
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lucas Theorem Proof›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ The proof of Lucas's theorem combines a generating function approach, based off \cite{Fine} with induction.
For formalisation purposes, it was easier to first prove a well known corollary of the main theorem (also 
often presented as an alternative statement for Lucas's theorem), which can itself be used to backwards 
prove the the original statement by induction.
This approach was adapted from P. Cameron's lecture notes on combinatorics \cite{petercameronNotesCombinatorics2007} ›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Proof of the Corollary ›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ This step makes use of the coefficient equivalence arguments proved in the previous sections ›</span></span>
<span class="keyword1"><span class="command">corollary</span></span> lucas_corollary<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="free">k</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span> <span class="keyword1">choose</span> <span class="free">k</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="free">p</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="main">(</span><span class="free">k</span> <span class="keyword1">div</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">n</span> <span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="main">(</span><span class="free">k</span> <span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">p</span>"</span></span> 
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span> <span class="keyword1">choose</span> <span class="free">k</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="var">?N</span> <span class="keyword1">choose</span> <span class="var">?K</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="var">?rn</span> <span class="keyword1">choose</span> <span class="var">?rk</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">p</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?fx</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fps_X <span class="main">::</span> int fps"</span></span>
  <span class="keyword1"><span class="command">have</span></span> n_rep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="var">?N</span> <span class="main">*</span> <span class="free">p</span>  <span class="main">+</span> <span class="var">?rn</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> k_rep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span><span class="var">?K</span> <span class="main">*</span> <span class="free">p</span> <span class="main">+</span> <span class="var">?rk</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> rhs_coeffs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="var">?fx</span><span class="main">^</span><span class="free">p</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="var">?N</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="var">?fx</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="var">?rn</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="free">k</span> <span class="main">=</span> <span class="main">(</span><span class="var">?N</span> <span class="keyword1">choose</span> <span class="var">?K</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="var">?rn</span> <span class="keyword1">choose</span> <span class="var">?rk</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms fps_div_rep_coeffs k_rep n_rep <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> <span class="comment1">― ‹Application of coefficient reasoning›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="var">?fx</span><span class="main">)</span><span class="main">^</span><span class="free">p</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="var">?N</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="var">?fx</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="var">?rn</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> 
          <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="var">?fx</span><span class="main">^</span><span class="free">p</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="var">?N</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="var">?fx</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="var">?rn</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> fpsmodrel <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fps_freshmans_dream assms fps_mult_equiv fps_power_equiv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> <span class="comment1">― ‹Application of equivalence facts and freshmans dream lemma›</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> modrel2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="var">?fx</span><span class="main">)</span><span class="main">^</span><span class="free">n</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="var">?fx</span><span class="main">^</span><span class="free">p</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="var">?N</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="var">?fx</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="var">?rn</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
                          <span class="main">∈</span> fpsmodrel <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> mult_div_mod_eq power_add power_mult<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> fpsrel_iff binomial_coeffs_induct rhs_coeffs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> of_nat_eq_iff zmod_int<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹ Proof of the Theorem ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The theorem statement requires a formalised way of referring to the base $p$ representation of a number. 
We use a definition that specifies the $i$th digit of the base $p$ representation. This definition is originally 
from the Hilbert's 10th Problem Formalisation project \cite{bayerDPRMTheoremIsabelle2019} which this work contributes to.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nth_digit_general</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nth_digit_general</span> <span class="free"><span class="bound"><span class="entity">num</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">base</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">num</span></span></span> <span class="keyword1">div</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">base</span></span></span> <span class="main">^</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free"><span class="bound"><span class="entity">base</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Applying induction on $d$, where $d$ is the highest power required in either $n$ or $k$'s base $p$
representation, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> lucas_corollary<span class="antiquote"><span class="antiquote">}</span></span></span></span> can be used to prove the original theorem.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> lucas_theorem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="free">k</span> <span class="free">d</span><span class="main">::</span><span class="quoted">nat</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> <span class="free">p</span> <span class="main">^</span> <span class="main">(</span>Suc <span class="free">d</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> <span class="free">p</span> <span class="main">^</span> <span class="main">(</span>Suc <span class="free">d</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span> <span class="keyword1">choose</span> <span class="free">k</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">i</span><span class="main">≤</span><span class="free">d</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>nth_digit_general <span class="free">n</span> <span class="bound">i</span> <span class="free">p</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="main">(</span>nth_digit_general <span class="free">k</span> <span class="bound">i</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">d</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> nth_digit_general_def assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">d</span><span class="main">)</span>
  <span class="comment1">― ‹Representation Variables›</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?N</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="keyword1">div</span> <span class="free">p</span>"</span></span>   
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?K</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="keyword1">div</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?nr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="keyword1">mod</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?kr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="keyword1">mod</span> <span class="free">p</span>"</span></span>
  <span class="comment1">― ‹Required assumption facts›</span>
  <span class="keyword1"><span class="command">have</span></span> Mlessthan<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?N</span> <span class="main">&lt;</span> <span class="free">p</span> <span class="main">^</span> <span class="main">(</span>Suc <span class="skolem">d</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> less_mult_imp_div_less power_Suc2 assms<span class="main">(</span>3<span class="main">)</span> prime_ge_2_nat Suc.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span> 
  <span class="keyword1"><span class="command">have</span></span> Nlessthan<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?K</span> <span class="main">&lt;</span> <span class="free">p</span> <span class="main">^</span> <span class="main">(</span>Suc <span class="skolem">d</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> less_mult_imp_div_less power_Suc2 prime_ge_2_nat Suc.prems<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> shift_bounds_fact<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="bound">i</span><span class="main">=</span><span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">..</span><span class="main">(</span>Suc <span class="main">(</span><span class="skolem">d</span> <span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>nth_digit_general <span class="skolem">n</span> <span class="bound">i</span> <span class="free">p</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="main">(</span>nth_digit_general <span class="skolem">k</span> <span class="bound">i</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
                            <span class="main">(</span><span class="main">∏</span><span class="bound">i</span><span class="main">=</span><span class="main">0</span><span class="main">..</span><span class="main">(</span><span class="skolem">d</span><span class="main">)</span><span class="main">.</span>  <span class="main">(</span>nth_digit_general <span class="skolem">n</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="main">(</span>nth_digit_general <span class="skolem">k</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prod.shift_bounds_cl_Suc_ivl <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> <span class="comment1">― ‹Product manipulation helper fact›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="skolem">k</span> <span class="main">)</span> <span class="keyword1">mod</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="var">?N</span> <span class="keyword1">choose</span> <span class="var">?K</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="var">?nr</span> <span class="keyword1">choose</span> <span class="var">?kr</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">p</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> lucas_corollary assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> <span class="comment1">― ‹Application of corollary›</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span><span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">∏</span><span class="bound">i</span><span class="main">≤</span><span class="skolem">d</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>nth_digit_general <span class="var">?N</span> <span class="bound">i</span> <span class="free">p</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="main">(</span>nth_digit_general <span class="var">?K</span> <span class="bound">i</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="var">?nr</span> <span class="keyword1">choose</span> <span class="var">?kr</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Mlessthan Nlessthan Suc.hyps mod_mult_cong assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> <span class="comment1">― ‹Using Inductive Hypothesis›</span>
  <span class="comment1">― ‹Product manipulation steps›</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">∏</span><span class="bound">i</span><span class="main">=</span><span class="main">0</span><span class="main">..</span><span class="main">(</span><span class="skolem">d</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>nth_digit_general <span class="skolem">n</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="main">(</span>nth_digit_general <span class="skolem">k</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="var">?nr</span> <span class="keyword1">choose</span> <span class="var">?kr</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span>  atMost_atLeast0 nth_digit_general_def div_mult2_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">∏</span><span class="bound">i</span><span class="main">=</span><span class="main">1</span><span class="main">..</span><span class="main">(</span><span class="skolem">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>nth_digit_general <span class="skolem">n</span> <span class="bound">i</span> <span class="free">p</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="main">(</span>nth_digit_general <span class="skolem">k</span> <span class="bound">i</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> 
                            <span class="main">(</span><span class="main">(</span>nth_digit_general <span class="skolem">n</span> <span class="main">0</span> <span class="free">p</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="main">(</span>nth_digit_general <span class="skolem">k</span> <span class="main">0</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">p</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> nth_digit_general_def shift_bounds_fact <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">n</span> <span class="keyword1">choose</span> <span class="skolem">k</span> <span class="main">)</span> <span class="keyword1">mod</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">∏</span><span class="bound">i</span><span class="main">=</span><span class="main">0</span><span class="main">..</span><span class="main">(</span><span class="skolem">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>nth_digit_general <span class="skolem">n</span> <span class="bound">i</span> <span class="free">p</span><span class="main">)</span> <span class="keyword1">choose</span> <span class="main">(</span>nth_digit_general <span class="skolem">k</span> <span class="bound">i</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">p</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> One_nat_def atMost_atLeast0 mult.commute prod.atLeast1_atMost_eq prod.atMost_shift
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Suc_eq_plus1 shift_bounds_fact<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc_eq_plus1 atMost_atLeast0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div>