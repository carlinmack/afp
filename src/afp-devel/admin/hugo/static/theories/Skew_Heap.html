<div id="Skew_Heap">
<div class="head">
<h1>Theory Skew_Heap</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Skew Heap"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Skew_Heap
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Tree_Multiset.html">HOL-Library.Tree_Multiset</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Pattern_Aliases.html">HOL-Library.Pattern_Aliases</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Data_Structures/Heaps.html">HOL-Data_Structures.Heaps</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">unbundle</span></span> pattern_aliases

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Skew heaps~\cite{SleatorT-SIAM86} are possibly the simplest functional
priority queues that have logarithmic (albeit amortized) complexity.

The implementation below could be generalized to separate the elements from
their priorities.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Merge"</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">merge</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">merge</span> Leaf <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">merge</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> Leaf <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">merge</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="main">=:</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span> <span class="main">=:</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="keyword1">then</span> Node <span class="main">(</span><span class="free">merge</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">l1</span></span></span>
    <span class="keyword1">else</span> Node <span class="main">(</span><span class="free">merge</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> size <span class="bound">x</span> <span class="main">+</span> size <span class="bound">y</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> merge_code<span class="main">:</span> <span class="quoted"><span class="quoted">"merge <span class="free">t1</span> <span class="free">t2</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> <span class="free">t1</span> <span class="keyword1">of</span>
   Leaf <span class="main">⇒</span> <span class="free">t2</span> <span class="main">|</span>
   Node <span class="bound">l1</span> <span class="bound">a1</span> <span class="bound">r1</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">t2</span> <span class="keyword1">of</span>
     Leaf <span class="main">⇒</span> <span class="free">t1</span> <span class="main">|</span>
     Node <span class="bound">l2</span> <span class="bound">a2</span> <span class="bound">r2</span> <span class="main">⇒</span> 
       <span class="main">(</span><span class="keyword1">if</span> <span class="bound">a1</span> <span class="main">≤</span> <span class="bound">a2</span>
        <span class="keyword1">then</span> Node <span class="main">(</span>merge <span class="free">t2</span> <span class="bound">r1</span><span class="main">)</span> <span class="bound">a1</span> <span class="bound">l1</span>
        <span class="keyword1">else</span> Node <span class="main">(</span>merge <span class="free">t1</span> <span class="bound">r2</span><span class="main">)</span> <span class="bound">a2</span> <span class="bound">l2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.split<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹An alternative version that always walks to the Leaf of both heaps:›</span></span>
<span class="keyword1"><span class="command">function</span></span> <span class="entity">merge2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">merge2</span> Leaf Leaf <span class="main">=</span> Leaf"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">merge2</span> Leaf <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="main">=</span> Node <span class="main">(</span><span class="free">merge2</span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span> Leaf<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">merge2</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">)</span> Leaf <span class="main">=</span> Node <span class="main">(</span><span class="free">merge2</span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span> Leaf<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">l1</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">merge2</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">)</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span>
    <span class="keyword1">then</span> Node <span class="main">(</span><span class="free">merge2</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">l1</span></span></span>
    <span class="keyword1">else</span> Node <span class="main">(</span><span class="free">merge2</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> size <span class="bound">x</span> <span class="main">+</span> size <span class="bound">y</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> size_merge<span class="main">:</span> <span class="quoted"><span class="quoted">"size<span class="main">(</span>merge <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span> <span class="main">=</span> size <span class="free">t1</span> <span class="main">+</span> size <span class="free">t2</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t1</span></span> <span class="quoted"><span class="free">t2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> size_merge2<span class="main">:</span> <span class="quoted"><span class="quoted">"size<span class="main">(</span>merge2 <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span> <span class="main">=</span> size <span class="free">t1</span> <span class="main">+</span> size <span class="free">t2</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t1</span></span> <span class="quoted"><span class="free">t2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge2.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_merge<span class="main">:</span> <span class="quoted"><span class="quoted">"mset_tree <span class="main">(</span>merge <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span> <span class="main">=</span> mset_tree <span class="free">t1</span> <span class="main">+</span> mset_tree <span class="free">t2</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t1</span></span> <span class="quoted"><span class="free">t2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> set_merge<span class="main">:</span> <span class="quoted"><span class="quoted">"set_tree <span class="main">(</span>merge <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span> <span class="main">=</span> set_tree <span class="free">t1</span> <span class="main">∪</span> set_tree <span class="free">t2</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mset_merge set_mset_tree set_mset_union<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> heap_merge<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> heap <span class="free">t1</span><span class="main">;</span>  heap <span class="free">t2</span> <span class="main">⟧</span> <span class="main">⟹</span> heap <span class="main">(</span>merge <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t1</span></span> <span class="quoted"><span class="free">t2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge.induct<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ball_Un set_merge<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> skew_heap<span class="main">:</span> Heap_Merge
<span class="keyword2"><span class="keyword">where</span></span> merge <span class="main">=</span> <span class="quoted">merge</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset_merge<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> heap_merge<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>