<div id="Farkas">
<div class="head">
<h1>Theory Farkas</h1>
</div>
<pre class="source"><span class="comment1">(* Authors: R. Bottesch, M. W. Haslbeck, R. Thiemann *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Farkas Coefficients via the Simplex Algorithm of Duterte and de~Moura›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Let $c_1,\dots,c_n$ be a finite list of linear inequalities. 
  Let $C$ be a list of pairs $(r_i,c_i)$ where $r_i$ is a rational number.
  We say that $C$ is a list of \emph{Farkas coefficients} if
  the sum of all products $r_i \cdot c_i$ results in an inequality that is 
  trivially unsatisfiable.

  Farkas' Lemma  
  states that a finite set of non-strict linear inequalities is
  unsatisfiable if and only if Farkas coefficients exist. We will prove this lemma
  with the help of the simplex algorithm of Dutertre and de~Moura's.

  Note that the simplex implementation works on four layers, and we will formulate and prove 
  a variant of Farkas' Lemma for each of these layers.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Farkas
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../Simplex/Simplex.html">Simplex.Simplex</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Linear Inequalities›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Both Farkas' Lemma and Motzkin's Transposition Theorem require linear combinations 
  of inequalities. To this end we define one type that permits strict and non-strict 
  inequalities which are always of the form ``polynomial R constant'' where R is either 
  $\leq$ or $&lt;$. On this type we can then define a commutative monoid.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A type for the two relations: less-or-equal and less-than.›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> le_rel <span class="main">=</span> Leq_Rel <span class="main">|</span> Lt_Rel

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">rel_of</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"le_rel <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> lrv <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">rel_of</span> Leq_Rel <span class="main">=</span> <span class="main">(≤)</span>"</span></span> 
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rel_of</span> Lt_Rel <span class="main">=</span> <span class="main">(&lt;)</span>"</span></span> 

<span class="keyword1"><span class="command">instantiation</span></span> le_rel <span class="main">::</span> <span class="quoted">comm_monoid_add</span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="class_parameter">zero_le_rel</span></span> <span class="main">=</span> Leq_Rel"</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">plus_le_rel</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">plus_le_rel</span> Leq_Rel Leq_Rel <span class="main">=</span> Leq_Rel"</span></span> 
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">plus_le_rel</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> Lt_Rel"</span></span> 
<span class="keyword1"><span class="command">instance</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span> <span class="main">::</span> <span class="quoted">le_rel</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">+</span> <span class="skolem">c</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">b</span> <span class="main">+</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">c</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">=</span> <span class="skolem">b</span> <span class="main">+</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">+</span> <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> zero_le_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Farkas-Leq_Rel_0"><span class="command">lemma</span></span> Leq_Rel_0<span class="main">:</span> <span class="quoted"><span class="quoted">"Leq_Rel <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> zero_le_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> le_constraint <span class="main">=</span> Le_Constraint <span class="main">(</span><span class="free"><span class="entity">lec_rel</span></span><span class="main">:</span> <span class="quoted">le_rel</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">lec_poly</span></span><span class="main">:</span> <span class="quoted">linear_poly</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="entity">lec_const</span></span><span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span><span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">Leqc</span> <span class="main">≡</span> Le_Constraint Leq_Rel"</span></span> 

<span class="keyword1"><span class="command">instantiation</span></span> le_constraint <span class="main">::</span> <span class="main">(</span><span class="quoted">lrv</span><span class="main">)</span> <span class="quoted">comm_monoid_add</span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">plus_le_constraint</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> le_constraint <span class="main">⇒</span> <span class="tfree">'a</span> le_constraint <span class="main">⇒</span> <span class="tfree">'a</span> le_constraint"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">plus_le_constraint</span> <span class="main">(</span>Le_Constraint <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">)</span> <span class="main">(</span>Le_Constraint <span class="free"><span class="bound"><span class="entity">r2</span></span></span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span>Le_Constraint <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">zero_le_constraint</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> le_constraint"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">zero_le_constraint</span> <span class="main">=</span> Leqc <span class="main">0</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> le_constraint"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">+</span> <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zero_le_constraint_def Leq_Rel_0<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">=</span> <span class="skolem">b</span> <span class="main">+</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">+</span> <span class="skolem">c</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">b</span> <span class="main">+</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">c</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span> 

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">satisfiable_le_constraint</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>lrv valuation <span class="main">⇒</span> <span class="tfree">'a</span> le_constraint <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub></span>"</span> 100<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1"><span class="free">⊨<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub></span></span> <span class="main">(</span>Le_Constraint <span class="free"><span class="bound"><span class="entity">rel</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span>rel_of <span class="free"><span class="bound"><span class="entity">rel</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">⦄</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Farkas-satisfies_zero_le_constraint"><span class="command">lemma</span></span> satisfies_zero_le_constraint<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub></span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valuate_zero zero_le_constraint_def<span class="main">)</span>

<span class="keyword1" id="Farkas-satisfies_sum_le_constraints"><span class="command">lemma</span></span> satisfies_sum_le_constraints<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub></span> <span class="free">c</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub></span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub></span> <span class="main">(</span><span class="free">c</span> <span class="main">+</span> <span class="free">d</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">lc</span></span> <span class="skolem"><span class="skolem">rc</span></span> <span class="skolem"><span class="skolem">ld</span></span> <span class="skolem"><span class="skolem">rd</span></span> <span class="skolem"><span class="skolem">rel1</span></span> <span class="skolem"><span class="skolem">rel2</span></span> <span class="keyword2"><span class="keyword">where</span></span> cd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> Le_Constraint <span class="skolem">rel1</span> <span class="skolem">lc</span> <span class="skolem">rc</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">=</span> Le_Constraint <span class="skolem">rel2</span> <span class="skolem">ld</span> <span class="skolem">rd</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">d</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_of <span class="skolem">rel1</span> <span class="main">(</span><span class="skolem">lc</span><span class="main">⦃</span><span class="free">v</span><span class="main">⦄</span><span class="main">)</span> <span class="skolem">rc</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms cd <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_of <span class="skolem">rel2</span> <span class="main">(</span><span class="skolem">ld</span><span class="main">⦃</span><span class="free">v</span><span class="main">⦄</span><span class="main">)</span> <span class="skolem">rd</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms cd <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> le1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">lc</span><span class="main">⦃</span><span class="free">v</span><span class="main">⦄</span> <span class="main">≤</span> <span class="skolem">rc</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">rel1</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> le2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ld</span><span class="main">⦃</span><span class="free">v</span><span class="main">⦄</span> <span class="main">≤</span> <span class="skolem">rd</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">rel2</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 1 2 le1 le2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rel_of <span class="main">(</span><span class="skolem">rel1</span> <span class="main">+</span> <span class="skolem">rel2</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">lc</span><span class="main">⦃</span><span class="free">v</span><span class="main">⦄</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">ld</span><span class="main">⦃</span><span class="free">v</span><span class="main">⦄</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">rc</span> <span class="main">+</span> <span class="skolem">rd</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">rel1</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">rel2</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute le_less_trans order.strict_iff_order plus_less<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cd valuate_add<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Farkas-satisfies_sumlist_le_constraints"><span class="command">lemma</span></span> satisfies_sumlist_le_constraints<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">cs</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> lrv le_constraint list<span class="main">)</span> <span class="main">⟹</span> <span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub></span> <span class="bound">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub></span> sum_list <span class="free">cs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">cs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> satisfies_zero_le_constraint satisfies_sum_le_constraints<span class="main">)</span>

<span class="keyword1" id="Farkas-sum_list_lec"><span class="command">lemma</span></span> sum_list_lec<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sum_list <span class="free">ls</span> <span class="main">=</span> Le_Constraint 
    <span class="main">(</span>sum_list <span class="main">(</span>map lec_rel <span class="free">ls</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">(</span>sum_list <span class="main">(</span>map lec_poly <span class="free">ls</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">(</span>sum_list <span class="main">(</span>map lec_const <span class="free">ls</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ls</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zero_le_constraint_def Leq_Rel_0<span class="main">)</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">l</span> <span class="skolem">ls</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">l</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Cons<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Farkas-sum_list_Leq_Rel"><span class="command">lemma</span></span> sum_list_Leq_Rel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span><span class="free">C</span><span class="main">.</span> lec_rel <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Leq_Rel<span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">C</span><span class="main">.</span> lec_rel <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> Leq_Rel<span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">C</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">c</span> <span class="skolem">C</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"lec_rel <span class="main">(</span><span class="free">f</span> <span class="skolem">c</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Leq_Rel
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Leq_Rel Leq_Rel_0<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Leq_Rel_0<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Farkas' Lemma on Layer 4›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹On layer 4 the algorithm works on a state containing a tableau, atoms (or bounds), 
  an assignment and a satisfiability flag. Only non-strict inequalities appear at this level.
  In order to even state a variant of Farkas' Lemma on layer 4, we 
  need conversions from atoms to non-strict constraints and then further
  to linear inequalities of type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">type</span></span> le_constraint<span class="antiquote"><span class="antiquote">}</span></span></span></span>. 
  The latter conversion is a partial operation, since non-strict constraints
  of type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">type</span></span> ns_constraint<span class="antiquote"><span class="antiquote">}</span></span></span></span> permit greater-or-equal constraints, whereas <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">type</span></span> le_constraint<span class="antiquote"><span class="antiquote">}</span></span></span></span>
  allows only less-or-equal.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The advantage of first going via <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">type</span></span> ns_constraint<span class="antiquote"><span class="antiquote">}</span></span></span></span> is that this type permits a multiplication
  with arbitrary rational numbers (the direction of the inequality must be flipped when
  multiplying by a negative number, which is not possible with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">type</span></span> le_constraint<span class="antiquote"><span class="antiquote">}</span></span></span></span>).›</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> ns_constraint <span class="main">::</span> <span class="main">(</span><span class="quoted">scaleRat</span><span class="main">)</span> <span class="quoted">scaleRat</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">scaleRat_ns_constraint</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat <span class="main">⇒</span> <span class="tfree">'a</span> ns_constraint <span class="main">⇒</span> <span class="tfree">'a</span> ns_constraint"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">scaleRat_ns_constraint</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span>LEQ_ns <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">then</span> GEQ_ns <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">*R</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">*R</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="keyword1">else</span> LEQ_ns <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">*R</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">*R</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">scaleRat_ns_constraint</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span>GEQ_ns <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">then</span> GEQ_ns <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">*R</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">*R</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="keyword1">else</span> LEQ_ns <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">*R</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">*R</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Farkas-sat_scale_rat_ns"><span class="command">lemma</span></span> sat_scale_rat_ns<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">ns</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="main">(</span><span class="free">f</span> <span class="keyword1">*R</span> <span class="free">ns</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">|</span> <span class="free">f</span> <span class="main">=</span> <span class="main">0</span> <span class="main">|</span> <span class="free">f</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ns</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valuate_scaleRat scaleRat_leq1 scaleRat_leq2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Farkas-scaleRat_scaleRat_ns_constraint"><span class="command">lemma</span></span> scaleRat_scaleRat_ns_constraint<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">*R</span> <span class="main">(</span><span class="free">b</span> <span class="keyword1">*R</span> <span class="main">(</span><span class="free">c</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> lrv ns_constraint<span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">b</span><span class="main">)</span> <span class="keyword1">*R</span> <span class="free">c</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">b</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">b</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">a</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">a</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_le not_less
        mult_neg_pos mult_neg_neg mult_nonpos_nonneg mult_nonpos_nonpos mult_nonneg_nonpos mult_pos_neg<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">lec_of_nsc</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lec_of_nsc</span> <span class="main">(</span>LEQ_ns <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Leqc <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">is_leq_ns</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_leq_ns</span> <span class="main">(</span>LEQ_ns <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">is_leq_ns</span> <span class="main">(</span>GEQ_ns <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span>

<span class="keyword1" id="Farkas-lec_of_nsc"><span class="command">lemma</span></span> lec_of_nsc<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_leq_ns <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub></span> lec_of_nsc <span class="free">c</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">nsc_of_atom</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nsc_of_atom</span> <span class="main">(</span>Leq <span class="free"><span class="bound"><span class="entity">var</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> LEQ_ns <span class="main">(</span>lp_monom <span class="main">1</span> <span class="free"><span class="bound"><span class="entity">var</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nsc_of_atom</span> <span class="main">(</span>Geq <span class="free"><span class="bound"><span class="entity">var</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> GEQ_ns <span class="main">(</span>lp_monom <span class="main">1</span> <span class="free"><span class="bound"><span class="entity">var</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>

<span class="keyword1" id="Farkas-nsc_of_atom"><span class="command">lemma</span></span> nsc_of_atom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub></span> nsc_of_atom <span class="free">a</span> <span class="main">⟷</span> <span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub></span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We say that $C$ is a list of Farkas coefficients \emph{for a given tableau $t$ and atom set $as$}, if
  it is a list of pairs $(r,a)$ such that $a \in as$, $r$ is non-zero, $r \cdot a$ is a
  `less-than-or-equal'-constraint, and the linear combination
  of inequalities must result in an inequality of the form $p \leq c$, where $c &lt; 0$ and $t \models
  p = 0$.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">farkas_coefficients_atoms_tableau</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">farkas_coefficients_atoms_tableau</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> lrv atom set<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">p</span> <span class="bound">c</span><span class="main">.</span> 
    <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">∧</span> is_leq_ns <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> nsc_of_atom <span class="bound">a</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">r</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">.</span> lec_of_nsc <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> nsc_of_atom <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Leqc <span class="bound">p</span> <span class="bound">c</span> <span class="main">∧</span>
    <span class="bound">c</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span> <span class="bound">v</span> <span class="main">::</span> <span class="tfree">'a</span> valuation<span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟶</span><span class="main">(</span><span class="bound">p</span><span class="main">⦃</span><span class="bound">v</span><span class="main">⦄</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We first prove that if the check-function detects a conflict, then 
  Farkas coefficients do exist for the tableau and atom set for which the
  conflict is detected.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bound_atoms</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> <span class="tfree">'a</span> atom set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>A</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bound_atoms</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">v</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">.</span> Geq <span class="bound">v</span> <span class="bound">x</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>set_of_map <span class="main">(</span><span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> 
                   <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">v</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">.</span> Leq <span class="bound">v</span> <span class="bound">x</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>set_of_map <span class="main">(</span><span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> PivotUpdateMinVars
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Farkas-farkas_check"><span class="command">lemma</span></span> farkas_check<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> check<span class="main">:</span> <span class="quoted"><span class="quoted">"check <span class="free">s'</span> <span class="main">=</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> U<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒰 <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="free">s'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="free">s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">◇</span> <span class="free">s'</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> index<span class="main">:</span> <span class="quoted"><span class="quoted">"index_valid <span class="free">as</span> <span class="free">s'</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">C</span><span class="main">.</span> farkas_coefficients_atoms_tableau <span class="main">(</span>snd <span class="main">`</span> <span class="free">as</span><span class="main">)</span> <span class="main">(</span>𝒯 <span class="free">s'</span><span class="main">)</span> <span class="bound">C</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">s</span> <span class="bound">f</span> <span class="bound">p</span> <span class="bound">c</span> <span class="bound">C</span><span class="main">.</span> set <span class="bound">C</span> <span class="main">⊆</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>A</sub></span> <span class="bound">s</span> <span class="main">∧</span>
    distinct <span class="bound">C</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">a</span> <span class="main">∈</span> set <span class="bound">C</span><span class="main">.</span> is_leq_ns <span class="main">(</span><span class="bound">f</span> <span class="main">(</span>atom_var <span class="bound">a</span><span class="main">)</span> <span class="keyword1">*R</span> nsc_of_atom <span class="bound">a</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">f</span> <span class="main">(</span>atom_var <span class="bound">a</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∑</span><span class="bound">a</span> <span class="main">←</span> <span class="bound">C</span><span class="main">.</span> lec_of_nsc <span class="main">(</span><span class="bound">f</span> <span class="main">(</span>atom_var <span class="bound">a</span><span class="main">)</span> <span class="keyword1">*R</span> nsc_of_atom <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Leqc <span class="bound">p</span> <span class="bound">c</span> <span class="main">∧</span>
    <span class="bound">c</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span> <span class="bound">v</span> <span class="main">::</span> <span class="tfree">'a</span> valuation<span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="bound">s</span> <span class="main">⟶</span><span class="main">(</span><span class="bound">p</span><span class="main">⦃</span><span class="bound">v</span><span class="main">⦄</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">s</span><span class="main">.</span> 𝒰 <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">f</span> <span class="bound">p</span> <span class="bound">c</span> <span class="bound">C</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">s</span> <span class="bound">f</span> <span class="bound">p</span> <span class="bound">c</span> <span class="bound">C</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>check <span class="free">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> check_induct''<span class="main"><span class="main">[</span></span><span class="operator">OF</span> inv<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?P</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">dir</span> <span class="skolem">I</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> dir<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">dir</span> <span class="main">=</span> Positive <span class="main">∨</span> <span class="skolem">dir</span> <span class="main">=</span> Negative"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?eq</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>eq_for_lvar <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">X<span class="hidden">⇩</span><sub>j</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">=</span> rvars_eq <span class="var">?eq</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">XL<span class="hidden">⇩</span><sub>j</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">XL<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">=</span> Abstract_Linear_Poly.vars_list <span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">XL<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">=</span> <span class="skolem">X<span class="hidden">⇩</span><sub>j</sub></span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> XL<span class="hidden">⇩</span><sub>j</sub>_def X<span class="hidden">⇩</span><sub>j</sub>_def 
      <span class="keyword1"><span class="command">using</span></span> set_vars_list <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> XL<span class="hidden">⇩</span><sub>j</sub>_distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">XL<span class="hidden">⇩</span><sub>j</sub></span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> XL<span class="hidden">⇩</span><sub>j</sub>_def <span class="keyword1"><span class="command">using</span></span> distinct_vars_list <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> coeff <span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> bounds_id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>A</sub></span> <span class="main">(</span>set_unsat <span class="skolem">I</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>A</sub></span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="main">(</span>set_unsat <span class="skolem">I</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="main">(</span>set_unsat <span class="skolem">I</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> boundsl_def boundsu_def bound_atoms_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> t_id<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒯 <span class="main">(</span>set_unsat <span class="skolem">I</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> 𝒯 <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> u_id<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒰 <span class="main">(</span>set_unsat <span class="skolem">I</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rhs <span class="var">?eq</span> <span class="main">-</span> lp_monom <span class="main">1</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> p_eval_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">⦃</span> <span class="skolem">v</span> <span class="main">⦄</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">v</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> valuation"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> eqT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?eq</span> <span class="main">∈</span> set <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 3<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> eq_for_lvar local.min_lvar_not_in_bounds_lvars<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>e</sub></span> <span class="var">?eq</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that eqT satisfies_tableau_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?eq</span> <span class="main">=</span> <span class="main">(</span>lhs <span class="var">?eq</span><span class="main">,</span> rhs <span class="var">?eq</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?eq</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lhs <span class="var">?eq</span> <span class="main">=</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 3<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> eq_for_lvar local.min_lvar_not_in_bounds_lvars<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>e</sub></span> <span class="main">(</span><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">,</span> rhs <span class="var">?eq</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> satisfies_eq_iff valuate_minus<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> Xj_rvars<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X<span class="hidden">⇩</span><sub>j</sub></span> <span class="main">⊆</span> rvars <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> X<span class="hidden">⇩</span><sub>j</sub>_def
      <span class="keyword1"><span class="command">using</span></span> 3 min_lvar_not_in_bounds_lvars rvars_of_lvar_rvars <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">have</span></span> xi_lvars<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∈</span> lvars <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> 3 min_lvar_not_in_bounds_lvars rvars_of_lvar_rvars <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lvars <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span> <span class="main">∩</span> rvars <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 3 normalized_tableau_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> xi_lvars Xj_rvars <span class="keyword1"><span class="command">have</span></span> xi_Xj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∉</span> <span class="skolem">X<span class="hidden">⇩</span><sub>j</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> rhs_eval_xi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rhs <span class="main">(</span>eq_for_lvar <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">⦃</span><span class="main">⟨</span>𝒱 <span class="skolem">s</span><span class="main">⟩</span><span class="main">⦄</span> <span class="main">=</span> <span class="main">⟨</span>𝒱 <span class="skolem">s</span><span class="main">⟩</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rhs <span class="skolem">eq</span><span class="main">)</span> <span class="main">⦃</span> <span class="skolem">v</span> <span class="main">⦄</span> <span class="main">=</span> <span class="skolem">v</span> <span class="main">(</span>lhs <span class="skolem">eq</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>e</sub></span> <span class="skolem">eq</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">v</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> valuation"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">eq</span>
        <span class="keyword1"><span class="command">using</span></span> satisfies_eq_def that <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>𝒱 <span class="skolem">s</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>e</sub></span> eq_for_lvar <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 3 satisfies_tableau_def eq_for_lvar curr_val_satisfies_no_lhs_def xi_lvars
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> eq_for_lvar xi_lvars <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ℬ<span class="hidden">⇩</span><sub>l</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Direction.LB <span class="skolem">dir</span>"</span></span> 
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ℬ<span class="hidden">⇩</span><sub>u</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Direction.UB <span class="skolem">dir</span>"</span></span> 
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lt</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Direction.lt <span class="skolem">dir</span>"</span></span> 
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?le</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Simplex.le <span class="var">?lt</span>"</span></span> 
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Geq</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Direction.GE <span class="skolem">dir</span>"</span></span> 
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Leq</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Direction.LE <span class="skolem">dir</span>"</span></span> 

    <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> <span class="skolem">A</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="var">?ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="skolem">s</span><span class="main">⟩</span> <span class="skolem">x</span><span class="main">)</span> <span class="keyword1">else</span> <span class="var">?ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="skolem">s</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="skolem">s</span><span class="main">⟩</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">A</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X<span class="hidden">⇩</span><sub>j</sub></span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Some <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="skolem">s</span><span class="main">⟩</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="var">?ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> cmp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="keyword1">⊳<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="var">?lt</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="skolem">s</span><span class="main">⟩</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="var">?ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> x that dir min_rvar_incdec_eq_None<span class="main">[</span><span class="operator">OF</span> 3<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> X<span class="hidden">⇩</span><sub>j</sub>_def A_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">c</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s</span> <span class="skolem">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bound_compare_defs<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">⟨</span>𝒱 <span class="skolem">s</span><span class="main">⟩</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that x Xj_rvars <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">-</span> lvars <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">unfolding</span></span> normalized_tableau_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="main">(</span><span class="main">-</span> lvars <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> in_bounds <span class="bound">x</span> <span class="main">⟨</span>𝒱 <span class="skolem">s</span><span class="main">⟩</span> <span class="main">(</span><span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s</span><span class="main">,</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">unfolding</span></span> curr_val_satisfies_no_lhs_def 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> satisfies_bounds_set.simps<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"in_bounds <span class="skolem">x</span> <span class="main">⟨</span>𝒱 <span class="skolem">s</span><span class="main">⟩</span> <span class="main">(</span><span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s</span><span class="main">,</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?le</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="skolem">s</span><span class="main">⟩</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">c</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> cmp c dir <span class="keyword1"><span class="command">unfolding</span></span> bound_compare_defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> c dir <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> c <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Some <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="skolem">s</span><span class="main">⟩</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="var">?ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="skolem">s</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">A</span> <span class="skolem">x</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> cmp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="keyword1">⊲<span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="var">?lt</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="skolem">s</span><span class="main">⟩</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="var">?ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="skolem">s</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> x that min_rvar_incdec_eq_None<span class="main">[</span><span class="operator">OF</span> 3<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> X<span class="hidden">⇩</span><sub>j</sub>_def A_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="skolem">s</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">c</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="skolem">s</span> <span class="skolem">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bound_compare_defs<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">⟨</span>𝒱 <span class="skolem">s</span><span class="main">⟩</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> rvars <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that x Xj_rvars <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">-</span> lvars <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">unfolding</span></span> normalized_tableau_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="main">(</span><span class="main">-</span> lvars <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> in_bounds <span class="bound">x</span> <span class="main">⟨</span>𝒱 <span class="skolem">s</span><span class="main">⟩</span> <span class="main">(</span><span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s</span><span class="main">,</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">unfolding</span></span> curr_val_satisfies_no_lhs_def 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> satisfies_bounds_set.simps<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"in_bounds <span class="skolem">x</span> <span class="main">⟨</span>𝒱 <span class="skolem">s</span><span class="main">⟩</span> <span class="main">(</span><span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s</span><span class="main">,</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?le</span> <span class="skolem">c</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="skolem">s</span><span class="main">⟩</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> cmp c dir <span class="keyword1"><span class="command">unfolding</span></span> bound_compare_defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> c dir <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> c <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> that coeff_zero <span class="keyword1"><span class="command">unfolding</span></span> A_def X<span class="hidden">⇩</span><sub>j</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">have</span></span> l_Ba<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>A</sub></span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> <span class="main">{</span><span class="var">?Geq</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">(</span>the <span class="main">(</span><span class="var">?ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">l</span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> that <span class="keyword1"><span class="command">have</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> <span class="var">?Geq</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">(</span>the <span class="main">(</span><span class="var">?ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> 3<span class="main">(</span>8<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> bl'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> Some <span class="skolem">c</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bound_compare_defs<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> bl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">,</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">∈</span> set_of_map <span class="main">(</span><span class="var">?ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> set_of_map_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>A</sub></span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> l bound_atoms_def <span class="keyword1"><span class="command">using</span></span> bl bl' dir <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?negA</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="skolem">A</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">XL<span class="hidden">⇩</span><sub>j</sub></span>"</span></span> 
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?posA</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">¬</span> <span class="skolem">A</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">XL<span class="hidden">⇩</span><sub>j</sub></span>"</span></span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">neg</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">neg</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">dir</span> <span class="main">=</span> Positive <span class="keyword1">then</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span> <span class="main">::</span> rat<span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> uminus<span class="main">)</span>"</span></span> 
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">negP</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">negP</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">dir</span> <span class="main">=</span> Positive <span class="keyword1">then</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span> <span class="main">::</span> linear_poly<span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> uminus<span class="main">)</span>"</span></span> 
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">nega</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nega</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">dir</span> <span class="main">=</span> Positive <span class="keyword1">then</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> uminus<span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> dir <span class="keyword1"><span class="command">have</span></span> dirn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">dir</span> <span class="main">=</span> Positive <span class="main">∧</span> <span class="skolem">neg</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">negP</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">nega</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>
      <span class="main">∨</span> <span class="skolem">dir</span> <span class="main">=</span> Negative <span class="main">∧</span> <span class="skolem">neg</span> <span class="main">=</span> uminus <span class="main">∧</span> <span class="skolem">negP</span> <span class="main">=</span> uminus <span class="main">∧</span> <span class="skolem">nega</span> <span class="main">=</span> uminus"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> neg_def negP_def nega_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="var">?Geq</span> <span class="bound">x</span> <span class="main">(</span>the <span class="main">(</span><span class="var">?ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="var">?negA</span> 
                        <span class="main">@</span> map <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="var">?Leq</span> <span class="bound">x</span> <span class="main">(</span>the <span class="main">(</span><span class="var">?ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="skolem">s</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>  <span class="var">?posA</span>
                        <span class="main">@</span> <span class="main">[</span><span class="var">?Geq</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">(</span>the <span class="main">(</span><span class="var">?ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span><span class="main">)</span><span class="main">]</span>"</span></span>  
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="keyword1">then</span> <span class="skolem">neg</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">else</span> <span class="skolem">neg</span> <span class="main">(</span><span class="skolem">A</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span><span class="skolem">C</span><span class="main">.</span> lec_const <span class="main">(</span>lec_of_nsc <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>atom_var <span class="bound">x</span><span class="main">)</span> <span class="keyword1">*R</span> nsc_of_atom <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">negP</span> <span class="var">?p</span>"</span></span> 

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> bounds_id t_id u_id
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI impI conjI allI<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="skolem">s</span> <span class="main">⟹</span> <span class="var">?q</span> <span class="main">⦃</span> <span class="skolem">v</span> <span class="main">⦄</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">v</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> valuation"</span></span> <span class="keyword1"><span class="command">using</span></span> dirn p_eval_zero<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">v</span></span><span class="main">]</span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valuate_minus<span class="main">)</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">C</span> <span class="main">⊆</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>A</sub></span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> C_def set_append set_map set_filter list.simps <span class="keyword1"><span class="command">using</span></span> 0 l_Ba dir
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Un_least subsetI<span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bound_atoms_def set_of_map_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

      <span class="keyword3"><span class="command">show</span></span> is_leq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>set <span class="skolem">C</span><span class="main">.</span> is_leq_ns <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>atom_var <span class="bound">a</span><span class="main">)</span> <span class="keyword1">*R</span> nsc_of_atom <span class="bound">a</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">f</span> <span class="main">(</span>atom_var <span class="bound">a</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> dirn xi_Xj 0 <span class="keyword1"><span class="command">unfolding</span></span> C_def f_def 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">a</span> <span class="main">←</span> <span class="skolem">C</span><span class="main">.</span> lec_of_nsc <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>atom_var <span class="bound">a</span><span class="main">)</span> <span class="keyword1">*R</span> nsc_of_atom <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Leqc <span class="var">?q</span> <span class="skolem">c</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> sum_list_lec le_constraint.simps map_map o_def
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">scale_poly</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> atom <span class="main">⇒</span> linear_poly"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
          <span class="quoted"><span class="quoted">"<span class="skolem">scale_poly</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> lec_poly <span class="main">(</span>lec_of_nsc <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>atom_var <span class="bound">x</span><span class="main">)</span> <span class="keyword1">*R</span> nsc_of_atom <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span><span class="skolem">C</span><span class="main">.</span> <span class="skolem">scale_poly</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span>
            <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span><span class="var">?negA</span><span class="main">.</span> <span class="skolem">scale_poly</span> <span class="main">(</span><span class="var">?Geq</span> <span class="bound">x</span> <span class="main">(</span>the <span class="main">(</span><span class="var">?ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
          <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span><span class="var">?posA</span><span class="main">.</span> <span class="skolem">scale_poly</span> <span class="main">(</span><span class="var">?Leq</span> <span class="bound">x</span> <span class="main">(</span>the <span class="main">(</span><span class="var">?ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="skolem">s</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
          <span class="main">-</span> <span class="skolem">negP</span> <span class="main">(</span>lp_monom <span class="main">1</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> C_def <span class="keyword1"><span class="command">using</span></span> dirn <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_def scale_poly_def f_def<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span><span class="var">?negA</span><span class="main">.</span> <span class="skolem">scale_poly</span> <span class="main">(</span><span class="var">?Geq</span> <span class="bound">x</span> <span class="main">(</span>the <span class="main">(</span><span class="var">?ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
          <span class="main">=</span>  <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span> <span class="var">?negA</span><span class="main">.</span> <span class="skolem">negP</span> <span class="main">(</span><span class="skolem">A</span> <span class="bound">x</span> <span class="keyword1">*R</span> lp_monom <span class="main">1</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> scale_poly_def f_def <span class="keyword1"><span class="command">using</span></span> dirn xi_Xj <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> map_cong<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span><span class="var">?posA</span><span class="main">.</span> <span class="skolem">scale_poly</span> <span class="main">(</span><span class="var">?Leq</span> <span class="bound">x</span> <span class="main">(</span>the <span class="main">(</span><span class="var">?ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="skolem">s</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
          <span class="main">=</span>  <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span> <span class="var">?posA</span><span class="main">.</span> <span class="skolem">negP</span> <span class="main">(</span><span class="skolem">A</span> <span class="bound">x</span> <span class="keyword1">*R</span> lp_monom <span class="main">1</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> scale_poly_def f_def <span class="keyword1"><span class="command">using</span></span> dirn xi_Xj <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> map_cong<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span> <span class="var">?negA</span><span class="main">.</span> <span class="skolem">negP</span> <span class="main">(</span><span class="skolem">A</span> <span class="bound">x</span> <span class="keyword1">*R</span> lp_monom <span class="main">1</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span>
              <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span> <span class="var">?posA</span><span class="main">.</span> <span class="skolem">negP</span> <span class="main">(</span><span class="skolem">A</span> <span class="bound">x</span> <span class="keyword1">*R</span> lp_monom <span class="main">1</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>
             <span class="main">=</span> <span class="skolem">negP</span> <span class="main">(</span>rhs <span class="main">(</span>eq_for_lvar <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> dirn XL<span class="hidden">⇩</span><sub>j</sub>_distinct coeff_zero            
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main"><span class="keyword3">;</span></span> <span class="operator">intro</span> poly_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> poly_eqI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> coeff_sum_list A_def X<span class="hidden">⇩</span><sub>j</sub>_def 
              uminus_sum_list_map<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> o_def<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span><span class="skolem">C</span><span class="main">.</span> lec_poly <span class="main">(</span>lec_of_nsc <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>atom_var <span class="bound">x</span><span class="main">)</span> <span class="keyword1">*R</span> nsc_of_atom <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="var">?q</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> scale_poly_def <span class="keyword1"><span class="command">using</span></span> dirn <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span><span class="skolem">C</span><span class="main">.</span> lec_rel <span class="main">(</span>lec_of_nsc <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>atom_var <span class="bound">x</span><span class="main">)</span> <span class="keyword1">*R</span> nsc_of_atom <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Leq_Rel"</span></span>  
          <span class="keyword1"><span class="command">unfolding</span></span> sum_list_Leq_Rel 
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span>
          <span class="keyword3"><span class="command">assume</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> set <span class="skolem">C</span>"</span></span> 
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lec_rel <span class="main">(</span>lec_of_nsc <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>atom_var <span class="skolem">c</span><span class="main">)</span> <span class="keyword1">*R</span> nsc_of_atom <span class="skolem">c</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Leq_Rel"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> is_leq<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> c<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">(</span>atom_var <span class="skolem">c</span><span class="main">)</span> <span class="keyword1">*R</span> nsc_of_atom <span class="skolem">c</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_def<span class="main">)</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">scale_const_f</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> atom <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">scale_const_f</span> <span class="skolem">x</span> <span class="main">=</span> lec_const <span class="main">(</span>lec_of_nsc <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>atom_var <span class="skolem">x</span><span class="main">)</span> <span class="keyword1">*R</span> nsc_of_atom <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> bl'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> Some <span class="skolem">d</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bound_compare_defs<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="var">?Geq</span> <span class="bound">x</span> <span class="main">(</span>the <span class="main">(</span><span class="var">?ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="var">?negA</span><span class="main">.</span> <span class="skolem">scale_const_f</span> <span class="bound">x</span><span class="main">)</span>
                     <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="var">?Leq</span> <span class="bound">x</span> <span class="main">(</span>the <span class="main">(</span><span class="var">?ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="skolem">s</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="var">?posA</span><span class="main">.</span> <span class="skolem">scale_const_f</span> <span class="bound">x</span><span class="main">)</span> 
                   <span class="main">-</span> <span class="skolem">nega</span> <span class="skolem">d</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> c_def C_def f_def scale_const_f_def <span class="keyword1"><span class="command">using</span></span> dirn rhs_eval_xi bl' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="var">?Geq</span> <span class="bound">x</span> <span class="main">(</span>the <span class="main">(</span><span class="var">?ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="var">?negA</span><span class="main">.</span> <span class="skolem">scale_const_f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span>
              <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span> <span class="var">?negA</span><span class="main">.</span> <span class="skolem">nega</span> <span class="main">(</span><span class="skolem">A</span> <span class="bound">x</span> <span class="keyword1">*R</span> the <span class="main">(</span><span class="var">?ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="skolem">s</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> xi_Xj dirn <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> map_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_def scale_const_f_def<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span><span class="var">?negA</span><span class="main">.</span> <span class="skolem">nega</span> <span class="main">(</span><span class="skolem">A</span> <span class="bound">x</span> <span class="keyword1">*R</span> <span class="main">⟨</span>𝒱 <span class="skolem">s</span><span class="main">⟩</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> map_cong<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="var">?Leq</span> <span class="bound">x</span> <span class="main">(</span>the <span class="main">(</span><span class="var">?ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="skolem">s</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="var">?posA</span><span class="main">.</span> <span class="skolem">scale_const_f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span>
              <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span> <span class="var">?posA</span><span class="main">.</span> <span class="skolem">nega</span> <span class="main">(</span><span class="skolem">A</span> <span class="bound">x</span> <span class="keyword1">*R</span> the <span class="main">(</span><span class="var">?ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="skolem">s</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> xi_Xj dirn <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> map_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_def scale_const_f_def<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span> <span class="var">?posA</span><span class="main">.</span> <span class="skolem">nega</span> <span class="main">(</span><span class="skolem">A</span> <span class="bound">x</span> <span class="keyword1">*R</span> <span class="main">⟨</span>𝒱 <span class="skolem">s</span><span class="main">⟩</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> map_cong<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span><span class="var">?negA</span><span class="main">.</span> <span class="skolem">nega</span> <span class="main">(</span><span class="skolem">A</span> <span class="bound">x</span> <span class="keyword1">*R</span> <span class="main">⟨</span>𝒱 <span class="skolem">s</span><span class="main">⟩</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span><span class="var">?posA</span><span class="main">.</span> <span class="skolem">nega</span> <span class="main">(</span><span class="skolem">A</span> <span class="bound">x</span> <span class="keyword1">*R</span> <span class="main">⟨</span>𝒱 <span class="skolem">s</span><span class="main">⟩</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>
             <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span><span class="var">?negA</span> <span class="main">@</span> <span class="var">?posA</span><span class="main">.</span> <span class="skolem">nega</span> <span class="main">(</span><span class="skolem">A</span> <span class="bound">x</span> <span class="keyword1">*R</span> <span class="main">⟨</span>𝒱 <span class="skolem">s</span><span class="main">⟩</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span> <span class="skolem">X<span class="hidden">⇩</span><sub>j</sub></span><span class="main">.</span> <span class="skolem">nega</span> <span class="main">(</span><span class="skolem">A</span> <span class="bound">x</span> <span class="keyword1">*R</span> <span class="main">⟨</span>𝒱 <span class="skolem">s</span><span class="main">⟩</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> XL<span class="hidden">⇩</span><sub>j</sub>_distinct <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum_list_distinct_conv_sum_set<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.cong<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">nega</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span> <span class="skolem">X<span class="hidden">⇩</span><sub>j</sub></span><span class="main">.</span> <span class="main">(</span><span class="skolem">A</span> <span class="bound">x</span> <span class="keyword1">*R</span> <span class="main">⟨</span>𝒱 <span class="skolem">s</span><span class="main">⟩</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dirn <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sum_negf<span class="main">)</span> 
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span> <span class="skolem">X<span class="hidden">⇩</span><sub>j</sub></span><span class="main">.</span> <span class="main">(</span><span class="skolem">A</span> <span class="bound">x</span> <span class="keyword1">*R</span> <span class="main">⟨</span>𝒱 <span class="skolem">s</span><span class="main">⟩</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>rhs <span class="var">?eq</span><span class="main">)</span> <span class="main">⦃</span><span class="main">⟨</span>𝒱 <span class="skolem">s</span><span class="main">⟩</span><span class="main">⦄</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> A_def X<span class="hidden">⇩</span><sub>j</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> linear_poly_sum<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_negf<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">⟨</span>𝒱 <span class="skolem">s</span><span class="main">⟩</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> rhs_eval_xi <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nega</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="skolem">s</span><span class="main">⟩</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span> <span class="main">-</span> <span class="skolem">nega</span> <span class="skolem">d</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lt</span> <span class="main">(</span><span class="main">⟨</span>𝒱 <span class="skolem">s</span><span class="main">⟩</span> <span class="skolem">x<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span> <span class="skolem">d</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> dirn 3<span class="main">(</span>2-<span class="main">)</span> bl' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bound_compare_defs<span class="main">)</span>   
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> dirn <span class="keyword1"><span class="command">unfolding</span></span> minus_lt<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">C</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> C_def <span class="keyword1"><span class="command">using</span></span> XL<span class="hidden">⇩</span><sub>j</sub>_distinct xi_Xj dirn <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def distinct_map<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> U<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> Qs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="free">s</span> <span class="skolem">f</span> <span class="skolem">p</span> <span class="skolem">c</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> U <span class="keyword1"><span class="command">unfolding</span></span> check <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> index<span class="main">[</span><span class="operator">folded</span> check_tableau_index_valid<span class="main"><span class="main">[</span></span><span class="operator">OF</span> U<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span> inv<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">,</span></span></span>4<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">,</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> check 
  <span class="keyword1"><span class="command">have</span></span> index<span class="main">:</span> <span class="quoted"><span class="quoted">"index_valid <span class="free">as</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> check_tableau_equiv<span class="main">[</span><span class="operator">OF</span> U<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> inv<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">unfolded</span> check<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="free">s</span> <span class="main">=</span> <span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> 𝒯 <span class="free">s'</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">v</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> valuation"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>atom_var <span class="bound">a</span><span class="main">)</span><span class="main">,</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="skolem">C</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">C</span> <span class="main">⊆</span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>A</sub></span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Qs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> snd <span class="main">`</span> <span class="free">as</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> index 
    <span class="keyword1"><span class="command">unfolding</span></span> bound_atoms_def index_valid_def set_of_map_def boundsl_def boundsu_def o_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> sub<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">`</span> set <span class="var">?C</span> <span class="main">⊆</span> snd <span class="main">`</span> <span class="free">as</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> farkas_coefficients_atoms_tableau_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">p</span></span></span></span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">c</span></span></span></span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?C</span></span></span></span></span></span></span><span class="main"><span class="main">]</span></span> conjI<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">insert</span> Qs<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> id<span class="main"><span class="main">]</span></span> sub<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next, we show that a conflict found by the assert-bound function also gives rise to
  Farkas coefficients.›</span></span>

<span class="keyword1"><span class="command">context</span></span> Update
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Farkas-farkas_assert_bound"><span class="command">lemma</span></span> farkas_assert_bound<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">◇</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> index<span class="main">:</span> <span class="quoted"><span class="quoted">"index_valid <span class="free">as</span> <span class="free">s</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> U<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒰 <span class="main">(</span>assert_bound <span class="free">ia</span> <span class="free">s</span><span class="main">)</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">C</span><span class="main">.</span> farkas_coefficients_atoms_tableau <span class="main">(</span>snd <span class="main">`</span> <span class="main">(</span>insert <span class="free">ia</span> <span class="free">as</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>𝒯 <span class="free">s</span><span class="main">)</span> <span class="bound">C</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> ia<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ia</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">`</span> insert <span class="free">ia</span> <span class="free">as</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">x</span> <span class="bound">c</span> <span class="bound">d</span><span class="main">.</span> Leq <span class="bound">x</span> <span class="bound">c</span> <span class="main">∈</span> <span class="var">?A</span> <span class="main">∧</span> Geq <span class="bound">x</span> <span class="bound">d</span> <span class="main">∈</span> <span class="var">?A</span> <span class="main">∧</span> <span class="bound">c</span> <span class="main">&lt;</span> <span class="bound">d</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Geq <span class="skolem">x</span> <span class="skolem">d</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"updateℬℐ <span class="main">(</span>Direction.UBI_upd <span class="main">(</span>Direction <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">)</span> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>u</sub></span> <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>l</sub></span> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub>_update Geq Leq <span class="main">(≤)</span><span class="main">)</span><span class="main">)</span>
                        <span class="skolem">i</span> <span class="skolem">x</span> <span class="skolem">d</span> <span class="free">s</span>"</span></span> 
    <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒰 <span class="var">?s</span> <span class="main">=</span> 𝒰 <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> norm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="var">?s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> val<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="var">?s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> tableau_valuated_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> idd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> lvars <span class="main">(</span>𝒯 <span class="var">?s</span><span class="main">)</span> <span class="main">⟹</span> 𝒰 <span class="main">(</span><span class="free">update</span> <span class="skolem">x</span> <span class="skolem">d</span> <span class="var">?s</span><span class="main">)</span> <span class="main">=</span> 𝒰 <span class="var">?s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> update_unsat_id<span class="main"><span class="main">[</span></span><span class="operator">OF</span> norm val<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> U<span class="main">[</span><span class="operator">unfolded</span> ia Geq<span class="main">]</span> inv<span class="main">(</span>1<span class="main">)</span> id idd 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊲<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">)</span> <span class="skolem">d</span> <span class="main">(</span><span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="free">s</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> Bu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="free">s</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">&lt;</span> <span class="skolem">d</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="free">s</span> <span class="skolem">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bound_compare_defs<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Bu <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub> <span class="free">s</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">j</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>"</span></span>  
      <span class="keyword1"><span class="command">unfolding</span></span> boundsu_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> index<span class="main">[</span><span class="operator">unfolded</span> index_valid_def<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">j</span><span class="main">,</span> Leq <span class="skolem">x</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">∈</span> <span class="free">as</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> xc<span class="main">:</span> <span class="quoted"><span class="quoted">"Leq <span class="skolem">x</span> <span class="skolem">c</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">have</span></span> xd<span class="main">:</span> <span class="quoted"><span class="quoted">"Geq <span class="skolem">x</span> <span class="skolem">d</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ia Geq <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">from</span></span> xc xd lt <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Leq <span class="skolem">x</span> <span class="skolem">c</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"updateℬℐ <span class="main">(</span>Direction.UBI_upd <span class="main">(</span>Direction <span class="main">(&lt;)</span> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="keyword1">ℬ<span class="hidden">⇩</span><sub>u</sub></span> <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>l</sub></span> <span class="keyword1">ℐ<span class="hidden">⇩</span><sub>u</sub></span> ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>u</sub>_update Leq Geq <span class="main">(≥)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="free">s</span>"</span></span> 
    <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒰 <span class="var">?s</span> <span class="main">=</span> 𝒰 <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> norm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="main">(</span>𝒯 <span class="var">?s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> val<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="var">?s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inv<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> tableau_valuated_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> idd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> lvars <span class="main">(</span>𝒯 <span class="var">?s</span><span class="main">)</span> <span class="main">⟹</span> 𝒰 <span class="main">(</span><span class="free">update</span> <span class="skolem">x</span> <span class="skolem">c</span> <span class="var">?s</span><span class="main">)</span> <span class="main">=</span> 𝒰 <span class="var">?s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> update_unsat_id<span class="main"><span class="main">[</span></span><span class="operator">OF</span> norm val<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> U<span class="main">[</span><span class="operator">unfolded</span> ia Leq<span class="main">]</span> inv<span class="main">(</span>1<span class="main">)</span> id idd 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊲<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>b</sub></span> <span class="main">(&lt;)</span> <span class="skolem">c</span> <span class="main">(</span><span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free">s</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> Bl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free">s</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">&lt;</span> <span class="skolem">d</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℬ<span class="hidden">⇩</span><sub>l</sub></span> <span class="free">s</span> <span class="skolem">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bound_compare_defs<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Bl <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="main">(</span>ℬ<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>l</sub> <span class="free">s</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">j</span><span class="main">,</span><span class="skolem">d</span><span class="main">)</span>"</span></span>  
      <span class="keyword1"><span class="command">unfolding</span></span> boundsl_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> index<span class="main">[</span><span class="operator">unfolded</span> index_valid_def<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">j</span><span class="main">,</span> Geq <span class="skolem">x</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">∈</span> <span class="free">as</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> xd<span class="main">:</span> <span class="quoted"><span class="quoted">"Geq <span class="skolem">x</span> <span class="skolem">d</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">have</span></span> xc<span class="main">:</span> <span class="quoted"><span class="quoted">"Leq <span class="skolem">x</span> <span class="skolem">c</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ia Leq <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">from</span></span> xc xd lt <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"Leq <span class="skolem">x</span> <span class="skolem">c</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"Geq <span class="skolem">x</span> <span class="skolem">d</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> cd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">&lt;</span> <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> farkas_coefficients_atoms_tableau_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI allI<span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">,</span> Geq <span class="skolem">x</span> <span class="skolem">d</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span>Leq <span class="skolem">x</span> <span class="skolem">c</span><span class="main">)</span><span class="main">]</span>"</span></span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span><span class="main">∈</span>set <span class="var">?C</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="var">?A</span> <span class="main">∧</span> is_leq_ns <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> nsc_of_atom <span class="bound">a</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">r</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c d <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">-</span> <span class="skolem">d</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cd <span class="keyword1"><span class="command">using</span></span> minus_lt <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valuate_zero<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Moreover, we prove that all other steps of the simplex algorithm on layer~4, such as pivoting,
  asserting bounds without conflict, etc., preserve Farkas coefficients.›</span></span>

<span class="keyword1" id="Farkas-farkas_coefficients_atoms_tableau_mono"><span class="command">lemma</span></span> farkas_coefficients_atoms_tableau_mono<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">⊆</span> <span class="free">bs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"farkas_coefficients_atoms_tableau <span class="free">as</span> <span class="free">t</span> <span class="free">C</span> <span class="main">⟹</span> farkas_coefficients_atoms_tableau <span class="free">bs</span> <span class="free">t</span> <span class="free">C</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> farkas_coefficients_atoms_tableau_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">locale</span></span> AssertAllState''' <span class="main">=</span> AssertAllState'' <span class="quoted"><span class="free">init</span></span> <span class="quoted"><span class="free">ass_bnd</span></span> <span class="quoted"><span class="free">chk</span></span> <span class="main">+</span> Update <span class="quoted"><span class="free">update</span></span> <span class="main">+</span> 
  PivotUpdateMinVars <span class="quoted"><span class="free">eq_idx_for_lvar</span></span> <span class="quoted"><span class="free">min_lvar_not_in_bounds</span></span> <span class="quoted"><span class="free">min_rvar_incdec_eq</span></span> <span class="quoted"><span class="free">pivot_and_update</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">init</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ass_bnd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> <span class="main">×</span> <span class="tfree">'a</span> <span class="main">::</span> lrv atom <span class="main">⇒</span> <span class="main">_</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">chk</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> state"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">update</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> lrv <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> state"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">eq_idx_for_lvar</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tableau <span class="main">⇒</span> var <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">min_lvar_not_in_bounds</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">::</span>lrv<span class="main">)</span> state <span class="main">⇒</span> var option"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">min_rvar_incdec_eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> Direction <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> eq <span class="main">⇒</span> <span class="tfree">'i</span> list <span class="main">+</span> var"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">pivot_and_update</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"var <span class="main">⇒</span> var <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'i</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> state"</span></span>
    <span class="main">+</span> <span class="keyword2"><span class="keyword">assumes</span></span> ass_bnd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ass_bnd</span> <span class="main">=</span> Update.assert_bound <span class="free">update</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    chk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">chk</span> <span class="main">=</span> PivotUpdateMinVars.check <span class="free">eq_idx_for_lvar</span> <span class="free">min_lvar_not_in_bounds</span> <span class="free">min_rvar_incdec_eq</span> <span class="free">pivot_and_update</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> AssertAllState'''
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Farkas-farkas_assert_bound_loop"><span class="command">lemma</span></span> farkas_assert_bound_loop<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"𝒰 <span class="main">(</span>assert_bound_loop <span class="free">as</span> <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> norm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="free">t</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">C</span><span class="main">.</span> farkas_coefficients_atoms_tableau <span class="main">(</span>snd <span class="main">`</span> set <span class="free">as</span><span class="main">)</span> <span class="free">t</span> <span class="bound">C</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">as</span> <span class="bound">s</span><span class="main">.</span> 𝒰 <span class="bound">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">C</span><span class="main">.</span> farkas_coefficients_atoms_tableau <span class="main">(</span>snd <span class="main">`</span> <span class="bound">as</span><span class="main">)</span> <span class="main">(</span>𝒯 <span class="bound">s</span><span class="main">)</span> <span class="bound">C</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"assert_bound_loop <span class="free">as</span> <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> init_unsat_flag<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"𝒯 <span class="main">(</span>assert_bound_loop <span class="free">as</span> <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span> <span class="main">∧</span> 
    <span class="main">(</span>𝒰 <span class="main">(</span>assert_bound_loop <span class="free">as</span> <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">C</span><span class="main">.</span> farkas_coefficients_atoms_tableau <span class="main">(</span>snd <span class="main">`</span> set <span class="free">as</span><span class="main">)</span> <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="bound">C</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> AssertAllState''Induct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> norm<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> ass_bnd<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> 𝒰 <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> init_unsat_flag<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"𝒯 <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> init_tableau_id<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">as</span> <span class="skolem">bs</span> <span class="skolem">s</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">`</span> <span class="skolem">as</span> <span class="main">⊆</span> snd <span class="main">`</span> <span class="skolem">bs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> farkas_coefficients_atoms_tableau_mono<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> 2<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">s</span> <span class="skolem">a</span> <span class="skolem">ats</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"assert_bound <span class="skolem">a</span> <span class="skolem">s</span>"</span></span> 
    <span class="keyword1"><span class="command">have</span></span> tab<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒯 <span class="var">?s</span> <span class="main">=</span> 𝒯 <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ass_bnd <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> assert_bound_nolhs_tableau_id<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> 3<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> 𝒯 <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> t tab
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI impI refl<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"𝒰 <span class="var">?s</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> farkas_assert_bound<span class="main">[</span><span class="operator">OF</span> 3<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>3-6<span class="main"><span class="main">,</span></span>8<span class="main"><span class="main">)</span></span> this<span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">C</span><span class="main">.</span> farkas_coefficients_atoms_tableau <span class="main">(</span>snd <span class="main">`</span> insert <span class="skolem">a</span> <span class="main">(</span>set <span class="skolem">ats</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>𝒯 <span class="main">(</span><span class="free">init</span> <span class="main">(</span>𝒯 <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">C</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> t<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> init_tableau_id <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> init_tableau_id <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Now we get to the main result for layer~4: If the main algorithm returns unsat,
  then there are Farkas coefficients for the tableau and atom set that were given as
  input for this layer.›</span></span>

<span class="keyword1" id="Farkas-farkas_assert_all_state"><span class="command">lemma</span></span> farkas_assert_all_state<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> U<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒰 <span class="main">(</span>assert_all_state <span class="free">t</span> <span class="free">as</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> norm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="free">t</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">C</span><span class="main">.</span> farkas_coefficients_atoms_tableau <span class="main">(</span>snd <span class="main">`</span> set <span class="free">as</span><span class="main">)</span> <span class="free">t</span> <span class="bound">C</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"assert_bound_loop <span class="free">as</span> <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span>"</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"𝒰 <span class="main">(</span>assert_bound_loop <span class="free">as</span> <span class="main">(</span><span class="free">init</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">from</span></span> farkas_assert_bound_loop<span class="main">[</span><span class="operator">OF</span> this norm<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">from</span></span> AssertAllState''_tableau_id<span class="main">[</span><span class="operator">OF</span> norm<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> T<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒯 <span class="var">?s</span> <span class="main">=</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> init_tableau_id <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">from</span></span> U <span class="keyword1"><span class="command">have</span></span> U<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒰 <span class="main">(</span>check <span class="var">?s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> chk<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> farkas_check<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl U False<span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> T<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ norm<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> AssertAllState''_precond<span class="main">[</span><span class="operator">OF</span> norm<span class="main">,</span> <span class="operator">unfolded</span> Let_def<span class="main">]</span> False
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>o</sub><span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>h</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="var">?s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">◇</span> <span class="var">?s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∇</span> <span class="var">?s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">from</span></span> AssertAllState''_index_valid<span class="main">[</span><span class="operator">OF</span> norm<span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"index_valid <span class="main">(</span>set <span class="free">as</span><span class="main">)</span> <span class="var">?s</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Farkas' Lemma on Layer 3›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹There is only a small difference between layers 3 and 4, namely that there is no 
  simplex algorithm (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> assert_all_state<span class="antiquote"><span class="antiquote">}</span></span></span></span>) on layer 3, but just a tableau and atoms.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Hence, one task is to link the unsatisfiability flag 
  on layer 4 with unsatisfiability of the original tableau and atoms (layer 3). This can
  be done via the existing soundness results of the simplex algorithm.
  Moreover, we give an easy proof that the existence of Farkas coefficients for a tableau and 
  set of atoms implies unsatisfiability.›</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Farkas-farkas_coefficients_atoms_tableau_unsat"><span class="command">lemma</span></span> farkas_coefficients_atoms_tableau_unsat<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"farkas_coefficients_atoms_tableau <span class="free">as</span> <span class="free">t</span> <span class="free">C</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∄</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span> <span class="main">∧</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">as</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span> <span class="main">∧</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">as</span>"</span></span>  
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span> <span class="main">∧</span> <span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">as</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> isleq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">C</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">as</span> <span class="main">∧</span> is_leq_ns <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> nsc_of_atom <span class="bound">a</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">r</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> leq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span> <span class="main">←</span> <span class="free">C</span><span class="main">.</span> lec_of_nsc <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> nsc_of_atom <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Leqc <span class="skolem">p</span> <span class="skolem">c</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> cltz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> p0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span><span class="main">⦃</span><span class="skolem">v</span><span class="main">⦄</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms farkas_coefficients_atoms_tableau_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> fa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">C</span><span class="main">.</span> <span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub></span> <span class="bound">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * isleq leq
      satisfies_atom_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="skolem">a</span>
    <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">r</span><span class="main">,</span><span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">C</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> a fa <span class="keyword1"><span class="command">have</span></span> va<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub></span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> satisfies_atom_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">hence</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="main">(</span><span class="skolem">r</span> <span class="keyword1">*R</span> nsc_of_atom <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nsc_of_atom sat_scale_rat_ns<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> a isleq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_leq_ns <span class="main">(</span><span class="skolem">r</span> <span class="keyword1">*R</span> nsc_of_atom <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> lec_of_nsc<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> v <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub></span> lec_of_nsc <span class="main">(</span><span class="skolem">r</span> <span class="keyword1">*R</span> nsc_of_atom <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> v <span class="main">=</span> this
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub></span> Leqc <span class="skolem">p</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> leq<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> satisfies_sumlist_le_constraints<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> v<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> cltz <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next is the main result for layer~3: a tableau and a finite set of atoms are unsatisfiable
  if and only if there is a list of Farkas coefficients for the set of atoms and the tableau.›</span></span>

<span class="keyword1" id="Farkas-farkas_coefficients_atoms_tableau"><span class="command">lemma</span></span> farkas_coefficients_atoms_tableau<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> norm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">as</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span> <span class="bound">C</span><span class="main">.</span> farkas_coefficients_atoms_tableau <span class="free">as</span> <span class="free">t</span> <span class="bound">C</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∄</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span> <span class="main">∧</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">as</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword1"><span class="command">from</span></span> finite_list<span class="main">[</span><span class="operator">OF</span> fin<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> as<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">=</span> set <span class="skolem">bs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">assume</span></span> unsat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∄</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="free">t</span> <span class="main">∧</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">as</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?as</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">()</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">bs</span>"</span></span> 
  <span class="keyword1"><span class="command">interpret</span></span> AssertAllState''' <span class="quoted">init_state</span> <span class="quoted">assert_bound_code</span> <span class="quoted">check_code</span> <span class="quoted">update_code</span>
    <span class="quoted">eq_idx_for_lvar</span> <span class="quoted">min_lvar_not_in_bounds</span> <span class="quoted">min_rvar_incdec_eq</span> <span class="quoted">pivot_and_update_code</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assert_bound_code_def check_code_def<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?call</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"assert_all <span class="free">t</span> <span class="var">?as</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">`</span> set <span class="var">?as</span> <span class="main">=</span> <span class="free">as</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> as <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> assert_all_sat<span class="main">[</span><span class="operator">OF</span> norm<span class="main">,</span> <span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?as</span></span></span><span class="main">,</span> <span class="operator">unfolded</span> id<span class="main">]</span> unsat
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?call</span> <span class="main">=</span> Inl <span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?call</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> assert_all_def Let_def<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"𝒰 <span class="main">(</span>assert_all_state_code <span class="free">t</span> <span class="var">?as</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assert_all_state_code_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> farkas_assert_all_state<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> assert_all_state_code_def<span class="main"><span class="main">]</span></span> norm<span class="main">,</span> <span class="operator">unfolded</span> id<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">C</span><span class="main">.</span> farkas_coefficients_atoms_tableau <span class="free">as</span> <span class="free">t</span> <span class="bound">C</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> farkas_coefficients_atoms_tableau_unsat<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Farkas' Lemma on Layer 2›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The main difference between layers 2 and 3 is the introduction of slack-variables in layer 3
  via the preprocess-function. Our task here is to show that Farkas coefficients at layer 3 (where 
  slack-variables are used) can be converted into Farkas coefficients for layer 2 (before the
  preprocessing).›</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We also need to adapt the previos notion of Farkas coefficients, which was used in 
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> farkas_coefficients_atoms_tableau<span class="antiquote"><span class="antiquote">}</span></span></span></span>, for layer~2. At layer 3, Farkas coefficients
  are the coefficients in a linear combination of atoms that evaluates to an inequality of
  the form $p \leq c$, where $p$ is a linear polynomial, $c &lt; 0$, and $t \models p = 0$ holds.
  At layer 2, the atoms are replaced by non-strict constraints where the left-hand side is a
  polynomial in the original variables, but the corresponding linear combination (with Farkas
  coefficients) evaluates directly to the inequality $0 \leq c$, with $c &lt; 0$. The implication
  $t \models p = 0$ is no longer possible in this layer, since there is no tableau $t$, nor is it
  needed, since $p$ is $0$. Thus, the statement defining Farkas coefficients must be changed
  accordingly.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">farkas_coefficients_ns</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">farkas_coefficients_ns</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">c</span><span class="main">.</span>
    <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="main">∧</span> is_leq_ns <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">r</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">.</span> lec_of_nsc <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Leqc <span class="main">0</span> <span class="bound">c</span> <span class="main">∧</span>
    <span class="bound">c</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The easy part is to prove that Farkas coefficients imply unsatisfiability.›</span></span>

<span class="keyword1" id="Farkas-farkas_coefficients_ns_unsat"><span class="command">lemma</span></span> farkas_coefficients_ns_unsat<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"farkas_coefficients_ns <span class="free">ns</span> <span class="free">C</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∄</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">ns</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">ns</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">ns</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    isleq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">C</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> <span class="free">ns</span> <span class="main">∧</span> is_leq_ns <span class="main">(</span><span class="bound">a</span> <span class="keyword1">*R</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    leq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">←</span> <span class="free">C</span><span class="main">.</span> lec_of_nsc <span class="main">(</span><span class="bound">a</span> <span class="keyword1">*R</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Leqc <span class="main">0</span> <span class="skolem">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    cltz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms farkas_coefficients_ns_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">n</span>
    <span class="keyword3"><span class="command">assume</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">C</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> n * isleq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="main">(</span><span class="skolem">a</span> <span class="keyword1">*R</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sat_scale_rat_ns<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> n isleq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_leq_ns <span class="main">(</span><span class="skolem">a</span> <span class="keyword1">*R</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> lec_of_nsc<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> v 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub></span> lec_of_nsc <span class="main">(</span><span class="skolem">a</span> <span class="keyword1">*R</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> v <span class="main">=</span> this
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub></span> Leqc <span class="main">0</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> leq<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> satisfies_sumlist_le_constraints<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> v<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> cltz
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> leD satisfiable_le_constraint.simps valuate_zero rel_of.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In order to eliminate the need for a tableau, we require the notion of an arbitrary substitution
  on polynomials, where all variables can be replaced at once. The existing simplex formalization 
  provides only a function to replace one variable at a time.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">subst_poly</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>var <span class="main">⇒</span> linear_poly<span class="main">)</span> <span class="main">⇒</span> linear_poly <span class="main">⇒</span> linear_poly"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">subst_poly</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">x</span> <span class="main">∈</span> vars <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">.</span> coeff <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">x</span> <span class="keyword1">*R</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Farkas-subst_poly_0"><span class="command">lemma</span></span> subst_poly_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"subst_poly <span class="free">σ</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> subst_poly_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Farkas-valuate_subst_poly"><span class="command">lemma</span></span> valuate_subst_poly<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>subst_poly <span class="free">σ</span> <span class="free">p</span><span class="main">)</span> <span class="main">⦃</span> <span class="free">v</span> <span class="main">⦄</span> <span class="main">=</span> <span class="main">(</span><span class="free">p</span> <span class="main">⦃</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free">σ</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⦃</span> <span class="free">v</span> <span class="main">⦄</span><span class="main">)</span><span class="main">)</span> <span class="main">⦄</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> linear_poly_sum<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> subst_poly_def valuate_sum valuate_scaleRat<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Farkas-subst_poly_add"><span class="command">lemma</span></span> subst_poly_add<span class="main">:</span> <span class="quoted"><span class="quoted">"subst_poly <span class="free">σ</span> <span class="main">(</span><span class="free">p</span> <span class="main">+</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> subst_poly <span class="free">σ</span> <span class="free">p</span> <span class="main">+</span> subst_poly <span class="free">σ</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> linear_poly_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> valuate_add valuate_subst_poly<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">subst_poly_lec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>var <span class="main">⇒</span> linear_poly<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> le_constraint <span class="main">⇒</span> <span class="tfree">'a</span> le_constraint"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">subst_poly_lec</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>Le_Constraint <span class="free"><span class="bound"><span class="entity">rel</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> Le_Constraint <span class="free"><span class="bound"><span class="entity">rel</span></span></span> <span class="main">(</span>subst_poly <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span> 

<span class="keyword1" id="Farkas-subst_poly_lec_0"><span class="command">lemma</span></span> subst_poly_lec_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"subst_poly_lec <span class="free">σ</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> zero_le_constraint_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Farkas-subst_poly_lec_add"><span class="command">lemma</span></span> subst_poly_lec_add<span class="main">:</span> <span class="quoted"><span class="quoted">"subst_poly_lec <span class="free">σ</span> <span class="main">(</span><span class="free">c1</span> <span class="main">+</span> <span class="free">c2</span><span class="main">)</span> <span class="main">=</span> subst_poly_lec <span class="free">σ</span> <span class="free">c1</span> <span class="main">+</span> subst_poly_lec <span class="free">σ</span> <span class="free">c2</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c1</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">c2</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_poly_add<span class="main">)</span>

<span class="keyword1" id="Farkas-subst_poly_lec_sum_list"><span class="command">lemma</span></span> subst_poly_lec_sum_list<span class="main">:</span> <span class="quoted"><span class="quoted">"subst_poly_lec <span class="free">σ</span> <span class="main">(</span>sum_list <span class="free">ps</span><span class="main">)</span> <span class="main">=</span> sum_list <span class="main">(</span>map <span class="main">(</span>subst_poly_lec <span class="free">σ</span><span class="main">)</span> <span class="free">ps</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ps</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_poly_lec_add<span class="main">)</span>

<span class="keyword1" id="Farkas-subst_poly_lp_monom"><span class="command">lemma</span></span> subst_poly_lp_monom<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"subst_poly <span class="free">σ</span> <span class="main">(</span>lp_monom <span class="free">r</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">r</span> <span class="keyword1">*R</span> <span class="free">σ</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> subst_poly_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vars_lp_monom<span class="main">)</span>

<span class="keyword1" id="Farkas-subst_poly_scaleRat"><span class="command">lemma</span></span> subst_poly_scaleRat<span class="main">:</span> <span class="quoted"><span class="quoted">"subst_poly <span class="free">σ</span> <span class="main">(</span><span class="free">r</span> <span class="keyword1">*R</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">r</span> <span class="keyword1">*R</span> <span class="main">(</span>subst_poly <span class="free">σ</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> linear_poly_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> valuate_scaleRat valuate_subst_poly<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We need several auxiliary properties of the preprocess-function which are not present
  in the simplex formalization.›</span></span>

<span class="keyword1" id="Farkas-Tableau_is_monom_preprocess'"><span class="command">lemma</span></span> Tableau_is_monom_preprocess'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">p</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>Tableau <span class="main">(</span>preprocess' <span class="free">cs</span> <span class="free">start</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_monom <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms 
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">cs</span></span> <span class="quoted"><span class="free">start</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> preprocess'.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits<span class="main">)</span>

<span class="keyword1" id="Farkas-preprocess'_atoms_to_constraints'"><span class="command">lemma</span></span> preprocess'_atoms_to_constraints'<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"preprocess' <span class="free">cs</span> <span class="free">start</span> <span class="main">=</span> <span class="free">S</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>Atoms <span class="free">S</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span>qdelta_constraint_to_atom <span class="bound">c</span> <span class="bound">v</span><span class="main">)</span> <span class="main">|</span> <span class="bound">i</span> <span class="bound">c</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">cs</span> <span class="main">∧</span> 
     <span class="main">(</span><span class="main">¬</span> is_monom <span class="main">(</span>poly <span class="bound">c</span><span class="main">)</span> <span class="main">⟶</span> Poly_Mapping <span class="free">S</span> <span class="main">(</span>poly <span class="bound">c</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">v</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">cs</span></span> <span class="quoted"><span class="free">start</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> preprocess'.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span> 

<span class="keyword1" id="Farkas-monom_of_atom_coeff"><span class="command">lemma</span></span> monom_of_atom_coeff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_monom <span class="main">(</span>poly <span class="free">ns</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> qdelta_constraint_to_atom <span class="free">ns</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>monom_coeff <span class="main">(</span>poly <span class="free">ns</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*R</span> nsc_of_atom <span class="free">a</span> <span class="main">=</span> <span class="free">ns</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms is_monom_monom_coeff_not_zero 
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">ns</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> atom.split ns_constraint.split <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> monom_poly_assemble <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The next lemma provides the functionality that is required to convert an
  atom back to a non-strict constraint, i.e., it is a kind of inverse of the preprocess-function.›</span></span>

<span class="keyword1" id="Farkas-preprocess'_atoms_to_constraints"><span class="command">lemma</span></span> preprocess'_atoms_to_constraints<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"preprocess' <span class="free">cs</span> <span class="free">start</span> <span class="main">=</span> <span class="free">S</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> start<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">start</span> <span class="main">=</span> start_fresh_variable <span class="free">cs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> ns<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">a</span> <span class="keyword1">of</span> Leq <span class="bound">v</span> <span class="bound">c</span> <span class="main">⇒</span> LEQ_ns <span class="free">q</span> <span class="bound">c</span> <span class="main">|</span> Geq <span class="bound">v</span> <span class="bound">c</span> <span class="main">⇒</span> GEQ_ns <span class="free">q</span> <span class="bound">c</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="main">(</span>Atoms <span class="free">S</span><span class="main">)</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>atom_var <span class="free">a</span> <span class="main">∉</span> fst <span class="main">`</span> set <span class="main">(</span>Tableau <span class="free">S</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">r</span> <span class="keyword1">*R</span> nsc_of_atom <span class="free">a</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free">cs</span><span class="main">)</span><span class="main">)</span>
    <span class="main">∧</span>  <span class="main">(</span><span class="main">(</span>atom_var <span class="free">a</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>Tableau <span class="free">S</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">ns</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free">cs</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"preprocess' <span class="free">cs</span> <span class="free">start</span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> ia<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="free">a</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>Atoms <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> preprocess'_atoms_to_constraints'<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="skolem"><span class="skolem">v</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> qdelta_constraint_to_atom <span class="skolem">c</span> <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">cs</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> nmonom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_monom <span class="main">(</span>poly <span class="skolem">c</span><span class="main">)</span> <span class="main">⟹</span> Poly_Mapping <span class="free">S</span> <span class="main">(</span>poly <span class="skolem">c</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> c'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free">cs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"poly <span class="skolem">c</span>"</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"is_monom <span class="var">?p</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> av<span class="main">:</span> <span class="quoted"><span class="quoted">"atom_var <span class="free">a</span> <span class="main">=</span> monom_var <span class="var">?p</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">c</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Tableau_is_monom_preprocess'<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="quoted"><span class="free">cs</span></span> <span class="quoted"><span class="free">start</span></span><span class="main">]</span> True 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="var">?p</span><span class="main">)</span> <span class="main">∉</span> set <span class="main">(</span>Tableau <span class="var">?S</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>atom_var <span class="free">a</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>Tableau <span class="free">S</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>monom_var <span class="var">?p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>Tableau <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> av <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"monom_var <span class="var">?p</span> <span class="main">∈</span> lvars <span class="main">(</span>Tableau <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lvars_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">from</span></span> lvars_tableau_ge_start<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> this<span class="main"><span class="main">[</span></span><span class="operator">folded</span> S<span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"monom_var <span class="var">?p</span> <span class="main">≥</span> <span class="free">start</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> S <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"monom_var <span class="var">?p</span> <span class="main">∈</span> vars_constraints <span class="main">(</span>map snd <span class="free">cs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True c
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> monom_var_in_vars<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> start_fresh_variable_fresh<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">cs</span></span><span class="main">,</span> <span class="operator">folded</span> start<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">}</span></span> 
    <span class="keyword1"><span class="command">moreover</span></span> 
    <span class="keyword1"><span class="command">from</span></span> monom_of_atom_coeff<span class="main">[</span><span class="operator">OF</span> True a<span class="main">]</span> True
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">r</span> <span class="keyword1">*R</span> nsc_of_atom <span class="free">a</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"monom_coeff <span class="var"><span class="var"><span class="var">?p</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> c' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> av<span class="main">:</span> <span class="quoted"><span class="quoted">"atom_var <span class="free">a</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">c</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> nmonom<span class="main">[</span><span class="operator">OF</span> False<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Poly_Mapping <span class="free">S</span> <span class="var">?p</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">from</span></span> preprocess'_Tableau_Poly_Mapping_Some<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">[</span></span><span class="operator">folded</span> S<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> tab<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>atom_var <span class="free">a</span><span class="main">,</span> <span class="var">?p</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>Tableau <span class="main">(</span>preprocess' <span class="free">cs</span> <span class="free">start</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> av <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"atom_var <span class="free">a</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span>Tableau <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> S <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>atom_var <span class="free">a</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>Tableau <span class="free">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> tab this <span class="keyword1"><span class="command">have</span></span> qp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="var">?p</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> S <span class="keyword1"><span class="command">using</span></span> lvars_distinct<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">cs</span></span> <span class="quoted"><span class="free">start</span></span><span class="main">,</span> <span class="operator">unfolded</span> S lhs_def<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta' eq_key_imp_eq_value<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ns qp <span class="keyword1"><span class="command">using</span></span> av a False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">c</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free">cs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next follows the major technical lemma of this part, 
  namely that Farkas coefficients on layer~3 for preprocessed constraints can
  be converted into Farkas coefficients on layer~2.›</span></span>

<span class="keyword1" id="Farkas-farkas_coefficients_preprocess'"><span class="command">lemma</span></span> farkas_coefficients_preprocess'<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> pp<span class="main">:</span> <span class="quoted"><span class="quoted">"preprocess' <span class="free">cs</span> <span class="main">(</span>start_fresh_variable <span class="free">cs</span><span class="main">)</span> <span class="main">=</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    ft<span class="main">:</span> <span class="quoted"><span class="quoted">"farkas_coefficients_atoms_tableau <span class="main">(</span>snd <span class="main">`</span> set <span class="main">(</span>Atoms <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Tableau <span class="free">S</span><span class="main">)</span> <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">C</span><span class="main">.</span> farkas_coefficients_ns <span class="main">(</span>snd <span class="main">`</span> set <span class="free">cs</span><span class="main">)</span> <span class="bound">C</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> ft<span class="main">[</span><span class="operator">unfolded</span> farkas_coefficients_atoms_tableau_def<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">C</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="main">(</span>Atoms <span class="free">S</span><span class="main">)</span> <span class="main">∧</span> is_leq_ns <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> nsc_of_atom <span class="bound">a</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">r</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span><span class="main">←</span><span class="free">C</span><span class="main">.</span> lec_of_nsc <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> nsc_of_atom <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Leqc <span class="skolem">p</span> <span class="skolem">c</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span> <span class="main">::</span> QDelta valuation<span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> Tableau <span class="free">S</span> <span class="main">⟹</span> <span class="skolem">p</span> <span class="main">⦃</span> <span class="bound">v</span> <span class="main">⦄</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ft <span class="keyword1"><span class="command">unfolding</span></span> farkas_coefficients_atoms_tableau_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">note</span></span> 0 <span class="main">=</span> 0<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">a</span> <span class="skolem">b</span><span class="main">,</span> <span class="operator">unfolded</span> split<span class="main">]</span> 0<span class="main">(</span>2-<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?T</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Tableau <span class="free">S</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"var <span class="main">⇒</span> linear_poly"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> map_of <span class="var">?T</span> <span class="bound">x</span> <span class="keyword1">of</span> Some <span class="bound">p</span> <span class="main">⇒</span> <span class="bound">p</span> <span class="main">|</span> None <span class="main">⇒</span> lp_monom <span class="main">1</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">r</span> <span class="bound">a</span> <span class="bound">s</span> <span class="bound">ns</span><span class="main">.</span> <span class="bound">ns</span> <span class="main">∈</span> <span class="main">(</span>snd <span class="main">`</span> set <span class="free">cs</span><span class="main">)</span> <span class="main">∧</span> is_leq_ns <span class="main">(</span><span class="bound">s</span> <span class="keyword1">*R</span> <span class="bound">ns</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span>
      subst_poly_lec <span class="skolem">σ</span> <span class="main">(</span>lec_of_nsc <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> nsc_of_atom <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> lec_of_nsc <span class="main">(</span><span class="bound">s</span> <span class="keyword1">*R</span> <span class="bound">ns</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s</span> <span class="bound">ns</span><span class="main">.</span> <span class="var">?P</span> <span class="skolem">r</span> <span class="skolem">a</span> <span class="bound">s</span> <span class="bound">ns</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> ra<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">r</span><span class="main">,</span><span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">r</span> <span class="skolem">a</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="main">(</span>Atoms <span class="free">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ra 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">from</span></span> 0 ra <span class="keyword1"><span class="command">have</span></span> is_leq<span class="main">:</span> <span class="quoted"><span class="quoted">"is_leq_ns <span class="main">(</span><span class="skolem">r</span> <span class="keyword1">*R</span> nsc_of_atom <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> r0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"atom_var <span class="skolem">a</span>"</span></span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"map_of <span class="var">?T</span> <span class="var">?x</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">q</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> σ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="var">?x</span> <span class="main">=</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> σ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> Some <span class="keyword1"><span class="command">have</span></span> xqT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?x</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">∈</span> set <span class="var">?T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> map_of_SomeD<span class="main">)</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ns</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">a</span> <span class="keyword1">of</span> Leq <span class="bound">v</span> <span class="bound">c</span> <span class="main">⇒</span> LEQ_ns <span class="skolem">q</span> <span class="bound">c</span>
                                     <span class="main">|</span> Geq <span class="bound">v</span> <span class="bound">c</span> <span class="main">⇒</span> GEQ_ns <span class="skolem">q</span> <span class="bound">c</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> preprocess'_atoms_to_constraints<span class="main">[</span><span class="operator">OF</span> pp refl ns_def a<span class="main">]</span> xqT
      <span class="keyword1"><span class="command">have</span></span> ns_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free">cs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"subst_poly_lec <span class="skolem">σ</span> <span class="main">(</span>lec_of_nsc <span class="main">(</span><span class="skolem">r</span> <span class="keyword1">*R</span> nsc_of_atom <span class="skolem">a</span><span class="main">)</span><span class="main">)</span>
               <span class="main">=</span> lec_of_nsc <span class="main">(</span><span class="skolem">r</span> <span class="keyword1">*R</span> <span class="skolem">ns</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> is_leq σ
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ns_def subst_poly_scaleRat<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> id is_leq σ <span class="keyword1"><span class="command">have</span></span> is_leq<span class="main">:</span> <span class="quoted"><span class="quoted">"is_leq_ns <span class="main">(</span><span class="skolem">r</span> <span class="keyword1">*R</span> <span class="skolem">ns</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ns_def<span class="main">)</span>  
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">r</span></span></span></span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">ns</span></span></span></span></span></span><span class="main"><span class="main">]</span></span> conjI ns_mem id is_leq conjI r0<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> None
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">∉</span> fst <span class="main">`</span> set <span class="var">?T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> map_of_eq_None_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> preprocess'_atoms_to_constraints<span class="main">[</span><span class="operator">OF</span> pp refl refl a<span class="main">]</span> this
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rr</span></span> <span class="keyword2"><span class="keyword">where</span></span> rr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">rr</span> <span class="keyword1">*R</span> nsc_of_atom <span class="skolem">a</span> <span class="main">∈</span> <span class="main">(</span>snd <span class="main">`</span> set <span class="free">cs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> rr0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">rr</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> None <span class="keyword1"><span class="command">have</span></span> σ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="var">?x</span> <span class="main">=</span> lp_monom <span class="main">1</span> <span class="var">?x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> σ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ns</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">=</span> <span class="skolem">rr</span> <span class="keyword1">*R</span> nsc_of_atom <span class="skolem">a</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="skolem">r</span> <span class="main">/</span> <span class="skolem">rr</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> rr0 r0 <span class="keyword1"><span class="command">have</span></span> s0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> s_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> is_leq σ
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst_poly_lec <span class="skolem">σ</span> <span class="main">(</span>lec_of_nsc <span class="main">(</span><span class="skolem">r</span> <span class="keyword1">*R</span> nsc_of_atom <span class="skolem">a</span><span class="main">)</span><span class="main">)</span> 
        <span class="main">=</span> lec_of_nsc <span class="main">(</span><span class="skolem">r</span> <span class="keyword1">*R</span> nsc_of_atom <span class="skolem">a</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_poly_scaleRat<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="keyword1">*R</span> nsc_of_atom <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">s</span> <span class="keyword1">*R</span> <span class="skolem">ns</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ns_def s_def
          scaleRat_scaleRat_ns_constraint<span class="main">[</span><span class="operator">OF</span> rr0<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> rr0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst_poly_lec <span class="skolem">σ</span> <span class="main">(</span>lec_of_nsc <span class="main">(</span><span class="skolem">r</span> <span class="keyword1">*R</span> nsc_of_atom <span class="skolem">a</span><span class="main">)</span><span class="main">)</span>
            <span class="main">=</span> lec_of_nsc <span class="main">(</span><span class="skolem">s</span> <span class="keyword1">*R</span> <span class="skolem">ns</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"is_leq_ns <span class="main">(</span><span class="skolem">s</span> <span class="keyword1">*R</span> <span class="skolem">ns</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> is_leq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> ns_def <span class="keyword1"><span class="command">using</span></span> rr s0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">ra</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">s</span> <span class="bound">ns</span><span class="main">.</span> <span class="main">(</span>fst <span class="bound">ra</span><span class="main">,</span> snd <span class="bound">ra</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">C</span> <span class="main">⟶</span> <span class="var">?P</span> <span class="main">(</span>fst <span class="bound">ra</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">ra</span><span class="main">)</span> <span class="bound">s</span> <span class="bound">ns</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> choice<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">ra</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">ns</span><span class="main">.</span> <span class="main">(</span>fst <span class="bound">ra</span><span class="main">,</span> snd <span class="bound">ra</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">C</span> <span class="main">⟶</span> <span class="var">?P</span> <span class="main">(</span>fst <span class="bound">ra</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">ra</span><span class="main">)</span> <span class="main">(</span><span class="skolem">s</span> <span class="bound">ra</span><span class="main">)</span> <span class="bound">ns</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> choice<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ns</span></span> <span class="keyword2"><span class="keyword">where</span></span> ns<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">r</span> <span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">C</span> <span class="main">⟹</span> <span class="var">?P</span> <span class="bound">r</span> <span class="bound">a</span> <span class="main">(</span><span class="skolem">s</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ns</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">NC</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">NC</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="skolem">s</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ns</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">ns</span><span class="main">)</span><span class="main">←</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="skolem">s</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ns</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">C'</span><span class="main">.</span> lec_of_nsc <span class="main">(</span><span class="bound">s</span> <span class="keyword1">*R</span> <span class="bound">ns</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">a</span><span class="main">)</span><span class="main">←</span><span class="skolem">C'</span><span class="main">.</span> subst_poly_lec <span class="skolem">σ</span> <span class="main">(</span>lec_of_nsc <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> nsc_of_atom <span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">C'</span> <span class="main">⊆</span> set <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">C'</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">C'</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">C'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">C'</span><span class="main">.</span> lec_of_nsc <span class="main">(</span><span class="skolem">s</span> <span class="bound">x</span> <span class="keyword1">*R</span> <span class="skolem">ns</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
          lec_of_nsc <span class="main">(</span><span class="skolem">s</span> <span class="skolem">a</span> <span class="keyword1">*R</span> <span class="skolem">ns</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span><span class="skolem">C'</span><span class="main">.</span> lec_of_nsc <span class="main">(</span><span class="skolem">s</span> <span class="bound">x</span> <span class="keyword1">*R</span> <span class="skolem">ns</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span><span class="skolem">C'</span><span class="main">.</span> lec_of_nsc <span class="main">(</span><span class="skolem">s</span> <span class="bound">x</span> <span class="keyword1">*R</span> <span class="skolem">ns</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">a</span><span class="main">)</span><span class="main">←</span><span class="skolem">C'</span><span class="main">.</span> subst_poly_lec <span class="skolem">σ</span> <span class="main">(</span>lec_of_nsc <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> nsc_of_atom <span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta' comp_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lec_of_nsc <span class="main">(</span><span class="skolem">s</span> <span class="skolem">a</span> <span class="keyword1">*R</span> <span class="skolem">ns</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> subst_poly_lec <span class="skolem">σ</span> <span class="main">(</span>lec_of_nsc <span class="main">(</span>fst <span class="skolem">a</span> <span class="keyword1">*R</span> nsc_of_atom <span class="main">(</span>snd <span class="skolem">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> set <span class="free">C</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> ns <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta' comp_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">a</span><span class="main">)</span><span class="main">←</span><span class="free">C</span><span class="main">.</span> subst_poly_lec <span class="skolem">σ</span> <span class="main">(</span>lec_of_nsc <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> nsc_of_atom <span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
             <span class="main">=</span> subst_poly_lec <span class="skolem">σ</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">a</span><span class="main">)</span><span class="main">←</span><span class="free">C</span><span class="main">.</span> <span class="main">(</span>lec_of_nsc <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> nsc_of_atom <span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_poly_lec_sum_list case_prod_beta' comp_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">a</span><span class="main">)</span><span class="main">←</span><span class="free">C</span><span class="main">.</span> <span class="main">(</span>lec_of_nsc <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> nsc_of_atom <span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Leqc <span class="skolem">p</span> <span class="skolem">c</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst_poly_lec <span class="skolem">σ</span> <span class="main">(</span>Leqc <span class="skolem">p</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">=</span> Leqc <span class="main">(</span>subst_poly <span class="skolem">σ</span> <span class="skolem">p</span><span class="main">)</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst_poly <span class="skolem">σ</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> all_valuate_zero<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"QDelta valuation"</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>subst_poly <span class="skolem">σ</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">⦃</span> <span class="skolem">v</span> <span class="main">⦄</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">⦃</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="skolem">σ</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⦃</span> <span class="skolem">v</span> <span class="main">⦄</span><span class="main">)</span> <span class="main">⦄</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> valuate_subst_poly<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> 0<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">⦃</span> <span class="skolem">v</span> <span class="main">⦄</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">⦃</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="skolem">σ</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⦃</span> <span class="skolem">v</span> <span class="main">⦄</span><span class="main">)</span> <span class="main">⦄</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>Tableau <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">q</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="var">?T</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> normalized_tableau_preprocess' assms <span class="keyword1"><span class="command">unfolding</span></span> normalized_tableau_def lhs_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta'<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">q</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> σ_def <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">⦃</span> <span class="skolem">v</span> <span class="main">⦄</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">⦃</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="skolem">σ</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⦃</span> <span class="skolem">v</span> <span class="main">⦄</span><span class="main">)</span> <span class="main">⦄</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vars <span class="skolem">q</span> <span class="main">⊆</span> rvars <span class="var">?T</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> rvars_def <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">σ</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">⦃</span> <span class="skolem">v</span> <span class="main">⦄</span> <span class="main">=</span> <span class="skolem">v</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> rvars <span class="var">?T</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> lvars <span class="main">(</span>Tableau <span class="free">S</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> that normalized_tableau_preprocess' assms
              <span class="keyword1"><span class="command">unfolding</span></span> normalized_tableau_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> fst <span class="main">`</span> set <span class="main">(</span>Tableau <span class="free">S</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> lvars_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_of <span class="var">?T</span> <span class="skolem">x</span> <span class="main">=</span> None"</span></span>
              <span class="keyword1"><span class="command">using</span></span> map_of_eq_None_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="skolem">x</span> <span class="main">=</span> lp_monom <span class="main">1</span> <span class="skolem">x</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> σ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lp_monom <span class="main">1</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">⦃</span> <span class="skolem">v</span> <span class="main">⦄</span> <span class="main">=</span> <span class="skolem">v</span> <span class="skolem">x</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> valuate_depend<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="skolem">σ</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⦃</span> <span class="skolem">v</span> <span class="main">⦄</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="var">?T</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> satisfies_tableau_def satisfies_eq_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>subst_poly <span class="skolem">σ</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">⦃</span> <span class="skolem">v</span> <span class="main">⦄</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span><span class="main">←</span><span class="skolem">NC</span><span class="main">.</span> lec_of_nsc <span class="main">(</span><span class="bound">s</span> <span class="keyword1">*R</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Le_Constraint Leq_Rel <span class="main">0</span> <span class="skolem">c</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> NC_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">(</span><span class="skolem">r</span><span class="main">,</span><span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free">cs</span>"</span></span> <span class="quoted"><span class="quoted">"is_leq_ns <span class="main">(</span><span class="skolem">s</span> <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="keyword1">*R</span> <span class="skolem">ns</span> <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">r</span> <span class="skolem">a</span>
    <span class="keyword1"><span class="command">using</span></span> ns that <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"farkas_coefficients_ns <span class="main">(</span>snd <span class="main">`</span> set <span class="free">cs</span><span class="main">)</span> <span class="skolem">NC</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> farkas_coefficients_ns_def NC_def <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Farkas-preprocess'_unsat_indexD"><span class="command">lemma</span></span> preprocess'_unsat_indexD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> set <span class="main">(</span>UnsatIndices <span class="main">(</span>preprocess' <span class="free">ns</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> 
  <span class="main">∃</span> <span class="bound">c</span><span class="main">.</span> poly <span class="bound">c</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">¬</span> zero_satisfies <span class="bound">c</span> <span class="main">∧</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ns</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ns</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> preprocess'.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits<span class="main">)</span>

<span class="keyword1" id="Farkas-preprocess'_unsat_index_farkas_coefficients_ns"><span class="command">lemma</span></span> preprocess'_unsat_index_farkas_coefficients_ns<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> set <span class="main">(</span>UnsatIndices <span class="main">(</span>preprocess' <span class="free">ns</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">C</span><span class="main">.</span> farkas_coefficients_ns <span class="main">(</span>snd <span class="main">`</span> set <span class="free">ns</span><span class="main">)</span> <span class="bound">C</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> preprocess'_unsat_indexD<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> contr<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="skolem">c</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> zero_satisfies <span class="skolem">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ns</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> mem <span class="keyword1"><span class="command">have</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free">ns</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"ns_constraint_const <span class="skolem">c</span>"</span></span> 
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">c</span> <span class="keyword1">of</span> LEQ_ns <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span> <span class="main">::</span> rat<span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">c</span> <span class="keyword1">of</span> LEQ_ns <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="var">?c</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">-</span> <span class="var">?c</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">-</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">QDelta</span> <span class="keyword1"><span class="command">using</span></span> uminus_less_lrv<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> farkas_coefficients_ns_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[</span></span></span><span class="main"><span class="main"><span class="main">(</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">r</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">c</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">d</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> mem contr<span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span>"</span></span><span class="main"><span class="keyword3">,</span></span> 
        <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> r_def d_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The combination of the previous results easily provides the main result of this section:
  a finite set of non-strict constraints on layer~2 is unsatisfiable if and only if there are Farkas coefficients.
  Again, here we use results from the simplex formalization, namely soundness of the preprocess-function.›</span></span>

<span class="keyword1" id="Farkas-farkas_coefficients_ns"><span class="command">lemma</span></span> farkas_coefficients_ns<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">ns</span> <span class="main">::</span> QDelta ns_constraint set<span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span> <span class="bound">C</span><span class="main">.</span> farkas_coefficients_ns <span class="free">ns</span> <span class="bound">C</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∄</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">ns</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">C</span><span class="main">.</span> farkas_coefficients_ns <span class="free">ns</span> <span class="bound">C</span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> farkas_coefficients_ns_unsat this <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∄</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">ns</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> unsat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∄</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">ns</span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> finite_list<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">nsl</span></span> <span class="keyword2"><span class="keyword">where</span></span> ns<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="main">=</span> set <span class="skolem">nsl</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>Pair <span class="main">()</span><span class="main">)</span> <span class="skolem">nsl</span>"</span></span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">ias</span></span> <span class="keyword2"><span class="keyword">where</span></span> part1<span class="main">:</span> <span class="quoted"><span class="quoted">"preprocess_part_1 <span class="var">?cs</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">ias</span><span class="main">,</span><span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"preprocess_part_1 <span class="var">?cs</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?as</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">`</span> set <span class="skolem">ias</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"start_fresh_variable <span class="var">?cs</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="var">?as</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ias</span> <span class="main">=</span> Atoms <span class="main">(</span>preprocess' <span class="var">?cs</span> <span class="var">?s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> Tableau <span class="main">(</span>preprocess' <span class="var">?cs</span> <span class="var">?s</span><span class="main">)</span>"</span></span> 
    <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">=</span> UnsatIndices <span class="main">(</span>preprocess' <span class="var">?cs</span> <span class="var">?s</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> part1 <span class="keyword1"><span class="command">unfolding</span></span> preprocess_part_1_def Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> norm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">△</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> normalized_tableau_preprocess'<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?cs</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span>  id <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="var">?as</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>t</sub></span> <span class="skolem">t</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> preprocess'_sat<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> id<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">folded</span> id<span class="main">]</span> unsat<span class="main">[</span><span class="operator">unfolded</span> ns<span class="main">]</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">I</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> set <span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> all_not_in_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> preprocess'_unsat_index_farkas_coefficients_ns<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> id<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">C</span><span class="main">.</span> farkas_coefficients_ns <span class="main">(</span>snd <span class="main">`</span> set <span class="var">?cs</span><span class="main">)</span> <span class="bound">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>    
  <span class="keyword1"><span class="command">with</span></span> farkas_coefficients_atoms_tableau<span class="main">[</span><span class="operator">OF</span> norm fin<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"farkas_coefficients_atoms_tableau <span class="var">?as</span> <span class="skolem">t</span> <span class="skolem">C</span>
     <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">C</span><span class="main">.</span> farkas_coefficients_ns <span class="main">(</span>snd <span class="main">`</span> set <span class="var">?cs</span><span class="main">)</span> <span class="bound">C</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> farkas_coefficients_preprocess'<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?cs</span></span></span><span class="main">,</span> <span class="operator">OF</span> refl<span class="main">]</span> this
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">C</span><span class="main">.</span> farkas_coefficients_ns <span class="main">(</span>snd <span class="main">`</span> set <span class="var">?cs</span><span class="main">)</span> <span class="bound">C</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> part1 <span class="keyword1"><span class="command">unfolding</span></span> preprocess_part_1_def Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">`</span> set <span class="var">?cs</span> <span class="main">=</span> <span class="free">ns</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ns <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">C</span><span class="main">.</span> farkas_coefficients_ns <span class="free">ns</span> <span class="bound">C</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Farkas' Lemma on Layer 1›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The main difference of layers 1 and 2 is the restriction to non-strict constraints via delta-rationals.
  Since we now work with another constraint type, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">type</span></span> constraint<span class="antiquote"><span class="antiquote">}</span></span></span></span>, we again need translations into
  linear inequalities of type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">type</span></span> le_constraint<span class="antiquote"><span class="antiquote">}</span></span></span></span>. Moreover, we also need to define scaling of constraints
  where flipping the comparison sign may be required.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">is_le</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"constraint <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_le</span> <span class="main">(</span>LT <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span> 
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">is_le</span> <span class="main">(</span>LEQ <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span> 
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">is_le</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span> 

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">lec_of_constraint</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lec_of_constraint</span> <span class="main">(</span>LEQ <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Le_Constraint Leq_Rel <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lec_of_constraint</span> <span class="main">(</span>LT <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Le_Constraint Lt_Rel <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span> 

<span class="keyword1" id="Farkas-lec_of_constraint"><span class="command">lemma</span></span> lec_of_constraint<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_le <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub></span> <span class="main">(</span>lec_of_constraint <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">instantiation</span></span> constraint <span class="main">::</span> <span class="quoted">scaleRat</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">scaleRat_constraint</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat <span class="main">⇒</span> constraint <span class="main">⇒</span> constraint"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">scaleRat_constraint</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">cc</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> LEQ <span class="main">0</span> <span class="main">0</span> <span class="keyword1">else</span> 
  <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">cc</span></span></span> <span class="keyword1">of</span> 
    LEQ <span class="bound">p</span> <span class="bound">c</span> <span class="main">⇒</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">then</span> GEQ <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">*R</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">*R</span> <span class="bound">c</span><span class="main">)</span> <span class="keyword1">else</span> LEQ <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">*R</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">*R</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> LT <span class="bound">p</span> <span class="bound">c</span> <span class="main">⇒</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">then</span> GT <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">*R</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">*R</span> <span class="bound">c</span><span class="main">)</span> <span class="keyword1">else</span> LT <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">*R</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">*R</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> GEQ <span class="bound">p</span> <span class="bound">c</span> <span class="main">⇒</span> 
    <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">then</span> GEQ <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">*R</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">*R</span> <span class="bound">c</span><span class="main">)</span> <span class="keyword1">else</span> LEQ <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">*R</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">*R</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> GT <span class="bound">p</span> <span class="bound">c</span> <span class="main">⇒</span> 
    <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">then</span> GT <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">*R</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">*R</span> <span class="bound">c</span><span class="main">)</span> <span class="keyword1">else</span> LT <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">*R</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">*R</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> LTPP <span class="bound">p</span> <span class="bound">q</span> <span class="main">⇒</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">then</span> GT <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">*R</span> <span class="main">(</span><span class="bound">p</span> <span class="main">-</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span> <span class="keyword1">else</span> LT <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">*R</span> <span class="main">(</span><span class="bound">p</span> <span class="main">-</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span>
  <span class="main">|</span> LEQPP <span class="bound">p</span> <span class="bound">q</span> <span class="main">⇒</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">then</span> GEQ <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">*R</span> <span class="main">(</span><span class="bound">p</span> <span class="main">-</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span> <span class="keyword1">else</span> LEQ <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">*R</span> <span class="main">(</span><span class="bound">p</span> <span class="main">-</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span>
  <span class="main">|</span> GTPP <span class="bound">p</span> <span class="bound">q</span> <span class="main">⇒</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">then</span> GT <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">*R</span> <span class="main">(</span><span class="bound">p</span> <span class="main">-</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span> <span class="keyword1">else</span> LT <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">*R</span> <span class="main">(</span><span class="bound">p</span> <span class="main">-</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span>
  <span class="main">|</span> GEQPP <span class="bound">p</span> <span class="bound">q</span> <span class="main">⇒</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">then</span> GEQ <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">*R</span> <span class="main">(</span><span class="bound">p</span> <span class="main">-</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span> <span class="keyword1">else</span> LEQ <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">*R</span> <span class="main">(</span><span class="bound">p</span> <span class="main">-</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span>
  <span class="main">|</span> EQPP <span class="bound">p</span> <span class="bound">q</span> <span class="main">⇒</span> LEQ <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">*R</span> <span class="main">(</span><span class="bound">p</span> <span class="main">-</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span> <span class="comment1">― ‹We do not keep equality, since the aim is 
        to convert the scaled constraints into inequalities, which will then be summed up.›</span>
  <span class="main">|</span> EQ <span class="bound">p</span> <span class="bound">c</span> <span class="main">⇒</span> LEQ <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">*R</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">*R</span> <span class="bound">c</span><span class="main">)</span> 
<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Farkas-sat_scale_rat"><span class="command">lemma</span></span> sat_scale_rat<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span> <span class="main">::</span> rat valuation<span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">(</span><span class="free">r</span> <span class="keyword1">*R</span> <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">r</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">r</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> right_diff_distrib 
        valuate_minus valuate_scaleRat scaleRat_leq1 scaleRat_leq2 valuate_zero<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In the following definition of Farkas coefficients (for layer 1), the main difference to
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> farkas_coefficients_ns<span class="antiquote"><span class="antiquote">}</span></span></span></span> is that the linear combination evaluates either to
  a strict inequality where the constant must be non-positive, or to a non-strict inequality where
  the constant must be negative.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">farkas_coefficients</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">farkas_coefficients</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">d</span> <span class="bound">rel</span><span class="main">.</span> 
    <span class="main">(</span><span class="main">∀</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">∧</span> is_le <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> <span class="bound">c</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">r</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∑</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">.</span> lec_of_constraint <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Le_Constraint <span class="bound">rel</span> <span class="main">0</span> <span class="bound">d</span> <span class="main">∧</span> 
    <span class="main">(</span><span class="bound">rel</span> <span class="main">=</span> Leq_Rel <span class="main">∧</span> <span class="bound">d</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> <span class="bound">rel</span> <span class="main">=</span> Lt_Rel <span class="main">∧</span> <span class="bound">d</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Again, the existence Farkas coefficients immediately implies unsatisfiability.›</span></span>

<span class="keyword1" id="Farkas-farkas_coefficients_unsat"><span class="command">lemma</span></span> farkas_coefficients_unsat<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"farkas_coefficients <span class="free">cs</span> <span class="free">C</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∄</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">cs</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">cs</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">cs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="skolem"><span class="skolem">rel</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    isleq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">C</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> <span class="free">cs</span> <span class="main">∧</span> is_le <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> <span class="bound">c</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">r</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    leq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span> <span class="main">←</span> <span class="free">C</span><span class="main">.</span> lec_of_constraint <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Le_Constraint <span class="skolem">rel</span> <span class="main">0</span> <span class="skolem">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    choice<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">rel</span> <span class="main">=</span> Lt_Rel <span class="main">∧</span> <span class="skolem">d</span> <span class="main">≤</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">rel</span> <span class="main">=</span> Leq_Rel <span class="main">∧</span> <span class="skolem">d</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms farkas_coefficients_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="skolem">c</span>
    <span class="keyword3"><span class="command">assume</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">r</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">C</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> c * isleq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub></span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">(</span><span class="skolem">r</span> <span class="keyword1">*R</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sat_scale_rat<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> c isleq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_le <span class="main">(</span><span class="skolem">r</span> <span class="keyword1">*R</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> lec_of_constraint<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> v 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub></span> lec_of_constraint <span class="main">(</span><span class="skolem">r</span> <span class="keyword1">*R</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> v <span class="main">=</span> this
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub></span> Le_Constraint <span class="skolem">rel</span> <span class="main">0</span> <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> leq<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> satisfies_sumlist_le_constraints<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> v<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> choice
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">rel</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valuate_zero<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Now follows the difficult implication. 
  The major part is proving that the translation <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> constraint_to_qdelta_constraint<span class="antiquote"><span class="antiquote">}</span></span></span></span> 
  preserves the existence of Farkas coefficients via pointwise compatibility of the sum.
  Here, compatibility links a strict or non-strict inequality from the input constraint to
  a translated non-strict inequality over delta-rationals.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">compatible_cs</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">compatible_cs</span> <span class="main">(</span>Le_Constraint Leq_Rel <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">(</span>Le_Constraint Leq_Rel <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> QDelta <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">0</span><span class="main">)</span>"</span></span> 
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">compatible_cs</span> <span class="main">(</span>Le_Constraint Lt_Rel <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">(</span>Le_Constraint Leq_Rel <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∧</span> qdfst <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span> 
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">compatible_cs</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span> 

<span class="keyword1" id="Farkas-compatible_cs_0_0"><span class="command">lemma</span></span> compatible_cs_0_0<span class="main">:</span> <span class="quoted"><span class="quoted">"compatible_cs <span class="main">0</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">code_simp</span>

<span class="keyword1" id="Farkas-compatible_cs_plus"><span class="command">lemma</span></span> compatible_cs_plus<span class="main">:</span> <span class="quoted"><span class="quoted">"compatible_cs <span class="free">c1</span> <span class="free">d1</span> <span class="main">⟹</span> compatible_cs <span class="free">c2</span> <span class="free">d2</span> <span class="main">⟹</span> compatible_cs <span class="main">(</span><span class="free">c1</span> <span class="main">+</span> <span class="free">c2</span><span class="main">)</span> <span class="main">(</span><span class="free">d1</span> <span class="main">+</span> <span class="free">d2</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c1</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">d1</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">c2</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">d2</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"lec_rel <span class="free">c1</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"lec_rel <span class="free">d1</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"lec_rel <span class="free">c2</span>"</span></span><span class="main"><span class="keyword3">;</span></span> 
      <span class="operator">cases</span> <span class="quoted"><span class="quoted">"lec_rel <span class="free">d2</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> plus_QDelta_def<span class="main">)</span>

<span class="keyword1" id="Farkas-unsat_farkas_coefficients"><span class="command">lemma</span></span> unsat_farkas_coefficients<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∄</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">cs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">cs</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">C</span><span class="main">.</span> farkas_coefficients <span class="free">cs</span> <span class="bound">C</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> finite_list<span class="main">[</span><span class="operator">OF</span> fin<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">csl</span></span> <span class="keyword2"><span class="keyword">where</span></span> cs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cs</span> <span class="main">=</span> set <span class="skolem">csl</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?csl</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>Pair <span class="main">()</span><span class="main">)</span> <span class="skolem">csl</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ns</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>snd <span class="main">`</span> set <span class="main">(</span>to_ns <span class="var">?csl</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?nsl</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"concat <span class="main">(</span>map constraint_to_qdelta_constraint <span class="skolem">csl</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">`</span> set <span class="var">?csl</span> <span class="main">=</span> <span class="free">cs</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> cs <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> id2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ns</span> <span class="main">=</span> set <span class="var">?nsl</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> to_ns_def set_concat <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> SolveExec'Default.to_ns_sat<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?csl</span></span></span><span class="main">,</span> <span class="operator">unfolded</span> id<span class="main">]</span> assms
  <span class="keyword1"><span class="command">have</span></span> unsat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∄</span> <span class="bound">v</span><span class="main">.</span> <span class="main">⟨</span><span class="bound">v</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="var">?ns</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="var">?ns</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∄</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="var">?ns</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="var">?ns</span>"</span></span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> model<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="var">?ns</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?v</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Mapping.Mapping <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> Some <span class="main">(</span><span class="skolem">v</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="main">⟨</span><span class="var">?v</span><span class="main">⟩</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map2fun_def Mapping.lookup.abs_eq<span class="main">)</span> 
    <span class="keyword1"><span class="command">from</span></span> model this unsat <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>    
  <span class="keyword1"><span class="command">from</span></span> farkas_coefficients_ns<span class="main">[</span><span class="operator">OF</span> fin<span class="main">]</span> this id2 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">N</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    farkas<span class="main">:</span> <span class="quoted"><span class="quoted">"farkas_coefficients_ns <span class="main">(</span>set <span class="var">?nsl</span><span class="main">)</span> <span class="skolem">N</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> farkas_coefficients_ns_def<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    is_leq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">N</span> <span class="main">⟹</span> <span class="bound">n</span> <span class="main">∈</span> set <span class="var">?nsl</span> <span class="main">∧</span> is_leq_ns <span class="main">(</span><span class="bound">a</span> <span class="keyword1">*R</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
    sum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">←</span><span class="skolem">N</span><span class="main">.</span> lec_of_nsc <span class="main">(</span><span class="bound">a</span> <span class="keyword1">*R</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Le_Constraint Leq_Rel <span class="main">0</span> <span class="skolem">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    d0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?prop</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">NN</span> <span class="bound">C</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span> <span class="main">∈</span> set <span class="bound">C</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> <span class="free">cs</span> <span class="main">∧</span> is_le <span class="main">(</span><span class="bound">a</span> <span class="keyword1">*R</span> <span class="bound">c</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span>
      <span class="main">∧</span> compatible_cs <span class="main">(</span><span class="main">∑</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span> <span class="main">←</span> <span class="bound">C</span><span class="main">.</span> lec_of_constraint <span class="main">(</span><span class="bound">a</span> <span class="keyword1">*R</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span> 
          <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">←</span><span class="bound">NN</span><span class="main">.</span> lec_of_nsc <span class="main">(</span><span class="bound">a</span> <span class="keyword1">*R</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">NN</span> <span class="main">⊆</span> set <span class="skolem">N</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">C</span><span class="main">.</span> <span class="var">?prop</span> <span class="skolem">NN</span> <span class="bound">C</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">NN</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">NN</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?prop</span> Nil Nil"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> compatible_cs_0_0<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">an</span> <span class="skolem">NN</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> an<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">an</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">from</span></span> Cons an <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?prop</span> <span class="skolem">NN</span> <span class="skolem">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">N</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> compat_CN<span class="main">:</span> <span class="quoted"><span class="quoted">"compatible_cs <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">←</span><span class="skolem">C</span><span class="main">.</span> lec_of_constraint <span class="main">(</span><span class="bound">f</span> <span class="keyword1">*R</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">←</span><span class="skolem">NN</span><span class="main">.</span> lec_of_nsc <span class="main">(</span><span class="bound">a</span> <span class="keyword1">*R</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> n is_leq <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> <span class="free">cs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">∈</span> set <span class="main">(</span>constraint_to_qdelta_constraint <span class="skolem">c</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> cs <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">from</span></span> is_leq<span class="main">[</span><span class="operator">OF</span> n<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> is_leq<span class="main">:</span> <span class="quoted"><span class="quoted">"is_leq_ns <span class="main">(</span><span class="skolem">a</span> <span class="keyword1">*R</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">a</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> is_less<span class="main">:</span> <span class="quoted"><span class="quoted">"is_le <span class="main">(</span><span class="skolem">a</span> <span class="keyword1">*R</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
      a0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      compat_cn<span class="main">:</span> <span class="quoted"><span class="quoted">"compatible_cs <span class="main">(</span>lec_of_constraint <span class="main">(</span><span class="skolem">a</span> <span class="keyword1">*R</span> <span class="skolem">c</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>lec_of_nsc <span class="main">(</span><span class="skolem">a</span> <span class="keyword1">*R</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">atomize</span><span class="main"><span class="main">(</span></span><span class="quasi_keyword">full</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">c</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> is_leq nc<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> QDelta_0_0 scaleRat_QDelta_def qdsnd_0 qdfst_0<span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cons <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">c</span><span class="main">)</span> <span class="skolem">C</span>"</span></span> 
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?N</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cons <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">NN</span>"</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?prop</span> <span class="var">?N</span> <span class="var">?C</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> an
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span> <span class="main">∈</span> set <span class="var">?C</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> <span class="free">cs</span> <span class="main">∧</span> is_le <span class="main">(</span><span class="bound">a</span> <span class="keyword1">*R</span> <span class="bound">c</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IH is_less a0 c <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"compatible_cs <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">←</span><span class="var">?C</span><span class="main">.</span> lec_of_constraint <span class="main">(</span><span class="bound">a</span> <span class="keyword1">*R</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">←</span><span class="var">?N</span><span class="main">.</span> lec_of_nsc <span class="main">(</span><span class="bound">a</span> <span class="keyword1">*R</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> compatible_cs_plus<span class="main">[</span><span class="operator">OF</span> compat_cn compat_CN<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> an <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">OF</span> subset_refl<span class="main">,</span> <span class="operator">unfolded</span> sum<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    is_less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">∈</span>set <span class="skolem">C</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> <span class="free">cs</span> <span class="main">∧</span> is_le <span class="main">(</span><span class="bound">a</span> <span class="keyword1">*R</span> <span class="bound">c</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    compat<span class="main">:</span> <span class="quoted"><span class="quoted">"compatible_cs <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">←</span><span class="skolem">C</span><span class="main">.</span> lec_of_constraint <span class="main">(</span><span class="bound">f</span> <span class="keyword1">*R</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Le_Constraint Leq_Rel <span class="main">0</span> <span class="skolem">d</span><span class="main">)</span>"</span></span> 
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"compatible_cs <span class="var">?sum</span> <span class="main">_</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rel</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?sum</span> <span class="main">=</span> Le_Constraint <span class="skolem">rel</span> <span class="skolem">p</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?sum</span></span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> compat <span class="keyword1"><span class="command">have</span></span> sum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?sum</span> <span class="main">=</span> Le_Constraint <span class="skolem">rel</span> <span class="main">0</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">rel</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">rel</span> <span class="main">=</span> Leq_Rel <span class="main">∧</span> <span class="skolem">e</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">rel</span> <span class="main">=</span> Lt_Rel <span class="main">∧</span> <span class="skolem">e</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> compat<span class="main">[</span><span class="operator">unfolded</span> sum<span class="main">]</span> d0
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">rel</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_QDelta_def qdfst_0 qdsnd_0<span class="main">)</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> farkas_coefficients_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> is_less<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> sum<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> e<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Finally we can prove on layer 1 that a finite set of constraints is 
  unsatisfiable if and only if there are Farkas coefficients.›</span></span>

<span class="keyword1" id="Farkas-farkas_coefficients"><span class="command">lemma</span></span> farkas_coefficients<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">cs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span> <span class="bound">C</span><span class="main">.</span> farkas_coefficients <span class="free">cs</span> <span class="bound">C</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∄</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">cs</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> farkas_coefficients_unsat unsat_farkas_coefficients<span class="main">[</span><span class="operator">OF</span> _ assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Corollaries from the Literature›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In this section, we convert the previous variations of Farkas' Lemma into more 
  well-known forms of this result.
  Moreover, instead of referring to the various constraint types of the simplex formalization, we
  now speak solely about constraints of type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">type</span></span> le_constraint<span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Farkas' Lemma on Delta-Rationals›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We start with Lemma~2 of \cite{Bromberger2017}, a
  variant of Farkas' Lemma for delta-rationals. To be more precise, it states
  that a set of non-strict inequalities over delta-rationals is unsatisfiable
  if and only if there is a linear combination of the inequalities that results
  in a trivial unsatisfiable constraint $0 &lt; const$ for some negative constant $const$.
  We can easily prove this statement via the lemma <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] farkas_coefficients_ns<span class="antiquote"><span class="antiquote">}</span></span></span></span> 
  and some conversions between the 
  different constraint types.›</span></span>

<span class="keyword1" id="Farkas-Farkas'_Lemma_Delta_Rationals"><span class="command">lemma</span></span> Farkas'_Lemma_Delta_Rationals<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">cs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"QDelta le_constraint set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> only_non_strict<span class="main">:</span> <span class="quoted"><span class="quoted">"lec_rel <span class="main">`</span> <span class="free">cs</span> <span class="main">⊆</span> <span class="main">{</span>Leq_Rel<span class="main">}</span>"</span></span>  
    <span class="keyword2"><span class="keyword">and</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">cs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∄</span> <span class="bound">v</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> <span class="free">cs</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub></span> <span class="bound">c</span><span class="main">)</span> <span class="main">⟷</span> 
       <span class="main">(</span><span class="main">∃</span> <span class="bound">C</span> <span class="bound">const</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span> <span class="main">∈</span> set <span class="bound">C</span><span class="main">.</span> <span class="bound">r</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">c</span> <span class="main">∈</span> <span class="free">cs</span><span class="main">)</span>
         <span class="main">∧</span> <span class="main">(</span><span class="main">∑</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span> <span class="main">←</span> <span class="bound">C</span><span class="main">.</span> Leqc <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> lec_poly <span class="bound">c</span><span class="main">)</span> <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> lec_const <span class="bound">c</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Leqc <span class="main">0</span> <span class="bound">const</span>
         <span class="main">∧</span> <span class="bound">const</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> <span class="free">cs</span>"</span></span> 
    <span class="keyword1"><span class="command">with</span></span> only_non_strict <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lec_rel <span class="skolem">c</span> <span class="main">=</span> Leq_Rel"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">p</span> <span class="bound">const</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">=</span> Leqc <span class="bound">p</span> <span class="bound">const</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">c</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> leqc <span class="main">=</span> this
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?to_ns</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">c</span><span class="main">.</span> LEQ_ns <span class="main">(</span>lec_poly <span class="bound">c</span><span class="main">)</span> <span class="main">(</span>lec_const <span class="bound">c</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ns</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?to_ns</span> <span class="main">`</span> <span class="free">cs</span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> fin <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="var">?ns</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="var">?ns</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> <span class="free">cs</span><span class="main">.</span> <span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub></span> <span class="bound">c</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">v</span> <span class="keyword1"><span class="command">using</span></span> leqc <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="main">(</span><span class="main">∄</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="var">?ns</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">C</span><span class="main">.</span> farkas_coefficients_ns <span class="var">?ns</span> <span class="bound">C</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> farkas_coefficients_ns<span class="main">[</span><span class="operator">OF</span> fin<span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">C</span><span class="main">.</span> farkas_coefficients_ns <span class="var">?ns</span> <span class="bound">C</span>"</span></span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="skolem"><span class="skolem">const</span></span> <span class="keyword2"><span class="keyword">where</span></span> is_leq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">C</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> <span class="var">?ns</span> <span class="main">∧</span> is_leq_ns <span class="main">(</span><span class="bound">s</span> <span class="keyword1">*R</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> sum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span><span class="main">←</span><span class="skolem">C</span><span class="main">.</span> lec_of_nsc <span class="main">(</span><span class="bound">s</span> <span class="keyword1">*R</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Leqc <span class="main">0</span> <span class="skolem">const</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> c0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">const</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> farkas_coefficients_ns_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span>lec_of_nsc <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="skolem">C</span>"</span></span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?C</span></span></span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">const</span></span></span></span><span class="main"><span class="main">]</span></span> conjI c0<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> sum<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> map_map o_def set_map<span class="main"><span class="keyword3">,</span></span> 
        <span class="operator">intro</span> ballI<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main">)</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">n</span> 
        <span class="keyword3"><span class="command">assume</span></span> sn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">C</span>"</span></span> 
        <span class="keyword1"><span class="command">with</span></span> is_leq
        <span class="keyword1"><span class="command">have</span></span> n_ns<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">∈</span> <span class="var">?ns</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> is_leq<span class="main">:</span> <span class="quoted"><span class="quoted">"is_leq_ns <span class="main">(</span><span class="skolem">s</span> <span class="keyword1">*R</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">from</span></span> n_ns <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> <span class="free">cs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> LEQ_ns <span class="main">(</span>lec_poly <span class="skolem">c</span><span class="main">)</span> <span class="main">(</span>lec_const <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> leqc<span class="main">[</span><span class="operator">OF</span> c<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> cs<span class="main">:</span> <span class="quoted"><span class="quoted">"Leqc <span class="skolem">p</span> <span class="skolem">d</span> <span class="main">∈</span> <span class="free">cs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> LEQ_ns <span class="skolem">p</span> <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> is_leq<span class="main">[</span><span class="operator">unfolded</span> n<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> s0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span> 
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"lec_of_nsc <span class="skolem">n</span>"</span></span> 
        <span class="keyword1"><span class="command">from</span></span> cs n <span class="keyword1"><span class="command">have</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?n</span> <span class="main">∈</span> <span class="free">cs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">s</span> <span class="main">∧</span> <span class="var">?n</span> <span class="main">∈</span> <span class="free">cs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s0 mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>        
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Leqc <span class="main">(</span><span class="skolem">s</span> <span class="keyword1">*R</span> lec_poly <span class="var">?n</span><span class="main">)</span> <span class="main">(</span><span class="skolem">s</span> <span class="keyword1">*R</span> lec_const <span class="var">?n</span><span class="main">)</span> <span class="main">=</span> lec_of_nsc <span class="main">(</span><span class="skolem">s</span> <span class="keyword1">*R</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">unfolding</span></span> n <span class="keyword1"><span class="command">using</span></span> s0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> id <span class="main">=</span> this
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span><span class="skolem">C</span><span class="main">.</span> <span class="keyword1">case</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> lec_of_nsc <span class="bound">n</span><span class="main">)</span> <span class="keyword1">of</span>
             <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span> <span class="main">⇒</span> Leqc <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> lec_poly <span class="bound">c</span><span class="main">)</span> <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> lec_const <span class="bound">c</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
             <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span><span class="main">←</span><span class="skolem">C</span><span class="main">.</span> lec_of_nsc <span class="main">(</span><span class="bound">s</span> <span class="keyword1">*R</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map <span class="var">?f</span> <span class="skolem">C</span><span class="main">)</span> <span class="main">=</span> sum_list <span class="main">(</span>map <span class="var">?g</span> <span class="skolem">C</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">sum_list</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> map_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">pair</span>
        <span class="keyword3"><span class="command">assume</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pair</span> <span class="main">∈</span> set <span class="skolem">C</span>"</span></span> 
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> pair<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pair</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="skolem">pair</span> <span class="main">=</span> <span class="var">?g</span> <span class="skolem">pair</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> pair split <span class="keyword1"><span class="command">using</span></span> id<span class="main">[</span><span class="operator">OF</span> mem<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> pair<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="skolem"><span class="skolem">const</span></span> 
      <span class="keyword2"><span class="keyword">where</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">r</span> <span class="bound">c</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">C</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">r</span> <span class="main">∧</span> <span class="bound">c</span> <span class="main">∈</span> <span class="free">cs</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> sum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">←</span><span class="skolem">C</span><span class="main">.</span> Leqc <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> lec_poly <span class="bound">c</span><span class="main">)</span> <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> lec_const <span class="bound">c</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Leqc <span class="main">0</span> <span class="skolem">const</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> const<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">const</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="var">?to_ns</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span> <span class="skolem">C</span>"</span></span>  
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">C</span><span class="main">.</span> farkas_coefficients_ns <span class="var">?ns</span> <span class="bound">C</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> farkas_coefficients_ns_def
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?C</span></span></span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">const</span></span></span></span><span class="main"><span class="main">]</span></span> conjI const<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> sum<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span><span class="main">∈</span>set <span class="var">?C</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> <span class="var">?ns</span> <span class="main">∧</span> is_leq_ns <span class="main">(</span><span class="bound">s</span> <span class="keyword1">*R</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span><span class="main">←</span><span class="var">?C</span><span class="main">.</span> lec_of_nsc <span class="main">(</span><span class="bound">s</span> <span class="keyword1">*R</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> 
        <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">←</span><span class="skolem">C</span><span class="main">.</span> Leqc <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> lec_poly <span class="bound">c</span><span class="main">)</span> <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> lec_const <span class="bound">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> map_map o_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">sum_list</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> map_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> C<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Motzkin's Transposition Theorem or the Kuhn-Fourier Theorem›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next, we prove a generalization of Farkas' Lemma that permits arbitrary combinations
  of strict and non-strict inequalities: Motzkin's Transposition Theorem
  which is also known as the Kuhn--Fourier Theorem.

  The proof is mainly based on the lemma <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] farkas_coefficients<span class="antiquote"><span class="antiquote">}</span></span></span></span>, 
  again requiring conversions between constraint types.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> Motzkin's_transposition_theorem<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">cs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat le_constraint set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">cs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∄</span> <span class="bound">v</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> <span class="free">cs</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub></span> <span class="bound">c</span><span class="main">)</span> <span class="main">⟷</span> 
       <span class="main">(</span><span class="main">∃</span> <span class="bound">C</span> <span class="bound">const</span> <span class="bound">rel</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span> <span class="main">∈</span> set <span class="bound">C</span><span class="main">.</span> <span class="bound">r</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">c</span> <span class="main">∈</span> <span class="free">cs</span><span class="main">)</span>
         <span class="main">∧</span> <span class="main">(</span><span class="main">∑</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span> <span class="main">←</span> <span class="bound">C</span><span class="main">.</span> Le_Constraint <span class="main">(</span>lec_rel <span class="bound">c</span><span class="main">)</span> <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> lec_poly <span class="bound">c</span><span class="main">)</span> <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> lec_const <span class="bound">c</span><span class="main">)</span><span class="main">)</span> 
               <span class="main">=</span> Le_Constraint <span class="bound">rel</span> <span class="main">0</span> <span class="bound">const</span>
         <span class="main">∧</span> <span class="main">(</span><span class="bound">rel</span> <span class="main">=</span> Leq_Rel <span class="main">∧</span> <span class="bound">const</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> <span class="bound">rel</span> <span class="main">=</span> Lt_Rel <span class="main">∧</span> <span class="bound">const</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?to_cs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">c</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> lec_rel <span class="bound">c</span> <span class="keyword1">of</span> Leq_Rel <span class="main">⇒</span> LEQ <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> LT<span class="main">)</span> <span class="main">(</span>lec_poly <span class="bound">c</span><span class="main">)</span> <span class="main">(</span>lec_const <span class="bound">c</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> to_cs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub></span> <span class="var">?to_cs</span> <span class="skolem">c</span> <span class="main">⟷</span> <span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub></span> <span class="skolem">c</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">v</span> <span class="skolem">c</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">c</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"lec_rel <span class="skolem">c</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?to_cs</span> <span class="main">`</span> <span class="free">cs</span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> fin <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="var">?cs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="var">?cs</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> <span class="free">cs</span><span class="main">.</span> <span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub></span> <span class="bound">c</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">v</span> <span class="keyword1"><span class="command">using</span></span> to_cs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="main">(</span><span class="main">∄</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="var">?cs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">C</span><span class="main">.</span> farkas_coefficients <span class="var">?cs</span> <span class="bound">C</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> farkas_coefficients<span class="main">[</span><span class="operator">OF</span> fin<span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">C</span><span class="main">.</span> farkas_coefficients <span class="var">?cs</span> <span class="bound">C</span>"</span></span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="skolem"><span class="skolem">const</span></span> <span class="skolem"><span class="skolem">rel</span></span> <span class="keyword2"><span class="keyword">where</span></span> is_leq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">C</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> <span class="var">?cs</span> <span class="main">∧</span> is_le <span class="main">(</span><span class="bound">s</span> <span class="keyword1">*R</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> sum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span><span class="main">←</span><span class="skolem">C</span><span class="main">.</span> lec_of_constraint <span class="main">(</span><span class="bound">s</span> <span class="keyword1">*R</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Le_Constraint <span class="skolem">rel</span> <span class="main">0</span> <span class="skolem">const</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> c0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">rel</span> <span class="main">=</span> Leq_Rel <span class="main">∧</span> <span class="skolem">const</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">rel</span> <span class="main">=</span> Lt_Rel <span class="main">∧</span> <span class="skolem">const</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> farkas_coefficients_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span>lec_of_constraint <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="skolem">C</span>"</span></span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?C</span></span></span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">const</span></span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">rel</span></span></span></span><span class="main"><span class="main">]</span></span> conjI c0<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> map_map o_def set_map sum<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> 
        <span class="operator">intro</span> ballI<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main">)</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">n</span> 
        <span class="keyword3"><span class="command">assume</span></span> sn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">C</span>"</span></span> 
        <span class="keyword1"><span class="command">with</span></span> is_leq 
        <span class="keyword1"><span class="command">have</span></span> n_ns<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">∈</span> <span class="var">?cs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> is_leq<span class="main">:</span> <span class="quoted"><span class="quoted">"is_le <span class="main">(</span><span class="skolem">s</span> <span class="keyword1">*R</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> s0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">from</span></span> n_ns <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> <span class="free">cs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="var">?to_cs</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> is_leq<span class="main">[</span><span class="operator">unfolded</span> n<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"lec_rel <span class="skolem">c</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span> 
        <span class="keyword1"><span class="command">with</span></span> s0 <span class="keyword1"><span class="command">have</span></span> s0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"lec_of_constraint <span class="skolem">n</span>"</span></span> 
        <span class="keyword1"><span class="command">from</span></span> c n <span class="keyword1"><span class="command">have</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?c</span> <span class="main">∈</span> <span class="free">cs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">c</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"lec_rel <span class="skolem">c</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">s</span> <span class="main">∧</span> <span class="var">?c</span> <span class="main">∈</span> <span class="free">cs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s0 mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>        
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lec_of_constraint <span class="main">(</span><span class="skolem">s</span> <span class="keyword1">*R</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> Le_Constraint <span class="main">(</span>lec_rel <span class="var">?c</span><span class="main">)</span> <span class="main">(</span><span class="skolem">s</span> <span class="keyword1">*R</span> lec_poly <span class="var">?c</span><span class="main">)</span> <span class="main">(</span><span class="skolem">s</span> <span class="keyword1">*R</span> lec_const <span class="var">?c</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">unfolding</span></span> n <span class="keyword1"><span class="command">using</span></span> s0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">c</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"lec_rel <span class="skolem">c</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> id <span class="main">=</span> this
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span><span class="skolem">C</span><span class="main">.</span> <span class="keyword1">case</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> lec_of_constraint <span class="bound">n</span><span class="main">)</span> <span class="keyword1">of</span>
             <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span> <span class="main">⇒</span> Le_Constraint <span class="main">(</span>lec_rel <span class="bound">c</span><span class="main">)</span> <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> lec_poly <span class="bound">c</span><span class="main">)</span> <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> lec_const <span class="bound">c</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
            <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span><span class="main">←</span><span class="skolem">C</span><span class="main">.</span> lec_of_constraint <span class="main">(</span><span class="bound">s</span> <span class="keyword1">*R</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span> 
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map <span class="var">?f</span> <span class="skolem">C</span><span class="main">)</span> <span class="main">=</span> sum_list <span class="main">(</span>map <span class="var">?g</span> <span class="skolem">C</span><span class="main">)</span>"</span></span><span class="main">)</span>  
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">sum_list</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> map_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">pair</span>
        <span class="keyword3"><span class="command">assume</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pair</span> <span class="main">∈</span> set <span class="skolem">C</span>"</span></span> 
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> pair<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pair</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">r</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="skolem">pair</span> <span class="main">=</span> <span class="var">?g</span> <span class="skolem">pair</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> pair split id<span class="main">[</span><span class="operator">OF</span> mem<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> pair<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="skolem"><span class="skolem">const</span></span> <span class="skolem"><span class="skolem">rel</span></span> 
      <span class="keyword2"><span class="keyword">where</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">r</span> <span class="bound">c</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">C</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">r</span> <span class="main">∧</span> <span class="bound">c</span> <span class="main">∈</span> <span class="free">cs</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> sum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">←</span><span class="skolem">C</span><span class="main">.</span> Le_Constraint <span class="main">(</span>lec_rel <span class="bound">c</span><span class="main">)</span> <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> lec_poly <span class="bound">c</span><span class="main">)</span> <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> lec_const <span class="bound">c</span><span class="main">)</span><span class="main">)</span> 
           <span class="main">=</span> Le_Constraint <span class="skolem">rel</span> <span class="main">0</span> <span class="skolem">const</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> const<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">rel</span> <span class="main">=</span> Leq_Rel <span class="main">∧</span> <span class="skolem">const</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">rel</span> <span class="main">=</span> Lt_Rel <span class="main">∧</span> <span class="skolem">const</span> <span class="main">≤</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="var">?to_cs</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span> <span class="skolem">C</span>"</span></span>  
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">C</span><span class="main">.</span> farkas_coefficients <span class="var">?cs</span> <span class="bound">C</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> farkas_coefficients_def
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?C</span></span></span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">const</span></span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">rel</span></span></span></span><span class="main"><span class="main">]</span></span> conjI const<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> sum<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span><span class="main">∈</span>set <span class="var">?C</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> <span class="var">?cs</span> <span class="main">∧</span> is_le <span class="main">(</span><span class="bound">s</span> <span class="keyword1">*R</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> le_rel.splits<span class="main">)</span> 
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span><span class="main">←</span><span class="var">?C</span><span class="main">.</span> lec_of_constraint <span class="main">(</span><span class="bound">s</span> <span class="keyword1">*R</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> 
        <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">←</span><span class="skolem">C</span><span class="main">.</span> Le_Constraint <span class="main">(</span>lec_rel <span class="bound">c</span><span class="main">)</span> <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> lec_poly <span class="bound">c</span><span class="main">)</span> <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> lec_const <span class="bound">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> map_map o_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">sum_list</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> map_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> C<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> le_rel.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Farkas' Lemma›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Finally we derive the commonly used form of Farkas' Lemma,
  which easily follows from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] Motzkin's_transposition_theorem<span class="antiquote"><span class="antiquote">}</span></span></span></span>. 
  It only permits non-strict inequalities and, as a result, 
  the sum of inequalities will always be non-strict.›</span></span>

<span class="keyword1" id="Farkas-Farkas'_Lemma"><span class="command">lemma</span></span> Farkas'_Lemma<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">cs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat le_constraint set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> only_non_strict<span class="main">:</span> <span class="quoted"><span class="quoted">"lec_rel <span class="main">`</span> <span class="free">cs</span> <span class="main">⊆</span> <span class="main">{</span>Leq_Rel<span class="main">}</span>"</span></span>  
    <span class="keyword2"><span class="keyword">and</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">cs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∄</span> <span class="bound">v</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> <span class="free">cs</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub></span> <span class="bound">c</span><span class="main">)</span> <span class="main">⟷</span> 
       <span class="main">(</span><span class="main">∃</span> <span class="bound">C</span> <span class="bound">const</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span> <span class="main">∈</span> set <span class="bound">C</span><span class="main">.</span> <span class="bound">r</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">c</span> <span class="main">∈</span> <span class="free">cs</span><span class="main">)</span>
         <span class="main">∧</span> <span class="main">(</span><span class="main">∑</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span> <span class="main">←</span> <span class="bound">C</span><span class="main">.</span> Leqc <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> lec_poly <span class="bound">c</span><span class="main">)</span> <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> lec_const <span class="bound">c</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Leqc <span class="main">0</span> <span class="bound">const</span>
         <span class="main">∧</span> <span class="bound">const</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> <span class="free">cs</span>"</span></span> 
    <span class="keyword1"><span class="command">with</span></span> only_non_strict <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lec_rel <span class="skolem">c</span> <span class="main">=</span> Leq_Rel"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">p</span> <span class="bound">const</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">=</span> Leqc <span class="bound">p</span> <span class="bound">const</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">c</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> leqc <span class="main">=</span> this
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">C</span> <span class="bound">const</span> <span class="bound">rel</span><span class="main">.</span>
       <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">∈</span>set <span class="bound">C</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">r</span> <span class="main">∧</span> <span class="bound">c</span> <span class="main">∈</span> <span class="free">cs</span><span class="main">)</span> <span class="main">∧</span>
       <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">←</span><span class="bound">C</span><span class="main">.</span> Le_Constraint <span class="main">(</span>lec_rel <span class="bound">c</span><span class="main">)</span> <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> lec_poly <span class="bound">c</span><span class="main">)</span> <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> lec_const <span class="bound">c</span><span class="main">)</span><span class="main">)</span> 
           <span class="main">=</span> Le_Constraint <span class="bound">rel</span> <span class="main">0</span> <span class="bound">const</span> <span class="main">∧</span>
       <span class="main">(</span><span class="bound">rel</span> <span class="main">=</span> Leq_Rel <span class="main">∧</span> <span class="bound">const</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> <span class="bound">rel</span> <span class="main">=</span> Lt_Rel <span class="main">∧</span> <span class="bound">const</span> <span class="main">≤</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> Motzkin's_transposition_theorem<span class="main">[</span><span class="operator">OF</span> fin<span class="main">]</span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="skolem"><span class="skolem">const</span></span> <span class="keyword2"><span class="keyword">where</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">r</span> <span class="bound">c</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">∈</span>set <span class="skolem">C</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">r</span> <span class="main">∧</span> <span class="bound">c</span> <span class="main">∈</span> <span class="free">cs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      sum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">←</span><span class="skolem">C</span><span class="main">.</span> Leqc <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> lec_poly <span class="bound">c</span><span class="main">)</span> <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> lec_const <span class="bound">c</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Leqc <span class="main">0</span> <span class="skolem">const</span>"</span></span>  <span class="keyword2"><span class="keyword">and</span></span>
      const<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">const</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">C</span></span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">const</span></span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">Leq_Rel</span></span><span class="main"><span class="main">]</span></span> conjI<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">C</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">r</span> <span class="main">∧</span> <span class="bound">c</span> <span class="main">∈</span> <span class="free">cs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">←</span> <span class="skolem">C</span><span class="main">.</span> Le_Constraint <span class="main">(</span>lec_rel <span class="bound">c</span><span class="main">)</span> <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> lec_poly <span class="bound">c</span><span class="main">)</span> <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> lec_const <span class="bound">c</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        Leqc <span class="main">0</span> <span class="skolem">const</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sum<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">sum_list</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> map_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> C<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> leqc<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> const<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="skolem"><span class="skolem">const</span></span> <span class="skolem"><span class="skolem">rel</span></span> <span class="keyword2"><span class="keyword">where</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">r</span> <span class="bound">c</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">∈</span>set <span class="skolem">C</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">r</span> <span class="main">∧</span> <span class="bound">c</span> <span class="main">∈</span> <span class="free">cs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      sum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">←</span><span class="skolem">C</span><span class="main">.</span> Le_Constraint <span class="main">(</span>lec_rel <span class="bound">c</span><span class="main">)</span> <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> lec_poly <span class="bound">c</span><span class="main">)</span> <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> lec_const <span class="bound">c</span><span class="main">)</span><span class="main">)</span> 
        <span class="main">=</span> Le_Constraint <span class="skolem">rel</span> <span class="main">0</span> <span class="skolem">const</span>"</span></span>  <span class="keyword2"><span class="keyword">and</span></span>
      const<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">rel</span> <span class="main">=</span> Leq_Rel <span class="main">∧</span> <span class="skolem">const</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">rel</span> <span class="main">=</span> Lt_Rel <span class="main">∧</span> <span class="skolem">const</span> <span class="main">≤</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">←</span><span class="skolem">C</span><span class="main">.</span> Le_Constraint <span class="main">(</span>lec_rel <span class="bound">c</span><span class="main">)</span> <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> lec_poly <span class="bound">c</span><span class="main">)</span> <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> lec_const <span class="bound">c</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
          <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">←</span><span class="skolem">C</span><span class="main">.</span> Leqc <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> lec_poly <span class="bound">c</span><span class="main">)</span> <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> lec_const <span class="bound">c</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span>  <span class="main">=</span> <span class="var">?sum</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">sum_list</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> map_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> C leqc<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lec_rel <span class="var">?sum</span> <span class="main">=</span> Leq_Rel"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sum_list_lec <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_list_Leq_Rel o_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> sum<span class="main">[</span><span class="operator">unfolded</span> id<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> rel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">rel</span> <span class="main">=</span> Leq_Rel"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> const <span class="keyword1"><span class="command">have</span></span> const<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">const</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">C</span></span></span></span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">const</span></span></span></span></span></span><span class="main"><span class="main">]</span></span> conjI const<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> sum id C rel<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We also present slightly modified versions›</span></span>

<span class="keyword1" id="Farkas-sum_list_map_filter_sum"><span class="command">lemma</span></span> sum_list_map_filter_sum<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">::</span> comm_monoid_add"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map <span class="free">f</span> <span class="main">(</span>filter <span class="free">g</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> sum_list <span class="main">(</span>map <span class="free">f</span> <span class="main">(</span>filter <span class="main">(</span>Not <span class="keyword1">o</span> <span class="free">g</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> sum_list <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A version where every constraint obtains exactly one coefficient and where 0 coefficients are allowed.›</span></span>

<span class="keyword1" id="Farkas-Farkas'_Lemma_set_sum"><span class="command">lemma</span></span> Farkas'_Lemma_set_sum<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">cs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat le_constraint set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> only_non_strict<span class="main">:</span> <span class="quoted"><span class="quoted">"lec_rel <span class="main">`</span> <span class="free">cs</span> <span class="main">⊆</span> <span class="main">{</span>Leq_Rel<span class="main">}</span>"</span></span>  
    <span class="keyword2"><span class="keyword">and</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">cs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∄</span> <span class="bound">v</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> <span class="free">cs</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub></span> <span class="bound">c</span><span class="main">)</span> <span class="main">⟷</span> 
       <span class="main">(</span><span class="main">∃</span> <span class="bound">C</span> <span class="bound">const</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> <span class="free">cs</span><span class="main">.</span> <span class="bound">C</span> <span class="bound">c</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span>
         <span class="main">∧</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">c</span> <span class="main">∈</span> <span class="free">cs</span><span class="main">.</span> Leqc <span class="main">(</span><span class="main">(</span><span class="bound">C</span> <span class="bound">c</span><span class="main">)</span> <span class="keyword1">*R</span> lec_poly <span class="bound">c</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="bound">C</span> <span class="bound">c</span><span class="main">)</span> <span class="keyword1">*R</span> lec_const <span class="bound">c</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Leqc <span class="main">0</span> <span class="bound">const</span>
         <span class="main">∧</span> <span class="bound">const</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> Farkas'_Lemma<span class="main">[</span><span class="operator">OF</span> only_non_strict fin<span class="main">]</span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">elim</span> exE conjE<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">C</span> <span class="skolem">const</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> finite_distinct_list<span class="main">[</span><span class="operator">OF</span> fin<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">csl</span></span> <span class="keyword2"><span class="keyword">where</span></span> csl<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">csl</span> <span class="main">=</span> <span class="free">cs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dist<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">csl</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?list</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span> <span class="bound">c</span><span class="main">.</span> <span class="skolem">C</span> <span class="bound">c</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">csl</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="bound">c</span><span class="main">.</span> <span class="main">(</span><span class="skolem">C</span> <span class="bound">c</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span> <span class="var">?list</span>"</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?C</span></span></span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">const</span></span></span></span><span class="main"><span class="main">]</span></span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">←</span><span class="var">?C</span><span class="main">.</span> Le_Constraint Leq_Rel <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> lec_poly <span class="bound">c</span><span class="main">)</span> <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> lec_const <span class="bound">c</span><span class="main">)</span><span class="main">)</span>
      <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">←</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="main">(</span><span class="skolem">C</span> <span class="bound">c</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span> <span class="skolem">csl</span><span class="main">.</span> Le_Constraint Leq_Rel <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> lec_poly <span class="bound">c</span><span class="main">)</span> <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> lec_const <span class="bound">c</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> map_map
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_list_map_filter<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zero_le_constraint_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Le_Constraint Leq_Rel <span class="main">0</span> <span class="skolem">const</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 2<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> csl<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> sum.distinct_set_conv_list<span class="main">[</span><span class="operator">OF</span> dist<span class="main">]</span> map_map o_def split <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">finally</span></span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">←</span><span class="var">?C</span><span class="main">.</span> Le_Constraint Leq_Rel <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> lec_poly <span class="bound">c</span><span class="main">)</span> <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> lec_const <span class="bound">c</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Le_Constraint Leq_Rel <span class="main">0</span> <span class="skolem">const</span>"</span></span>  
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">const</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">∈</span>set <span class="var">?C</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">r</span> <span class="main">∧</span> <span class="bound">c</span> <span class="main">∈</span> <span class="free">cs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> set_map set_filter csl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">C</span> <span class="skolem">const</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">CC</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CC</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">c</span><span class="main">.</span> sum_list <span class="main">(</span>map fst <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="bound">rc</span><span class="main">.</span> snd <span class="bound">rc</span> <span class="main">=</span> <span class="bound">c</span><span class="main">)</span> <span class="skolem">C</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span> <span class="bound">C</span> <span class="bound">const</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> <span class="free">cs</span><span class="main">.</span> <span class="bound">C</span> <span class="bound">c</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span>
         <span class="main">∧</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">c</span> <span class="main">∈</span> <span class="free">cs</span><span class="main">.</span> Leqc <span class="main">(</span><span class="main">(</span><span class="bound">C</span> <span class="bound">c</span><span class="main">)</span> <span class="keyword1">*R</span> lec_poly <span class="bound">c</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="bound">C</span> <span class="bound">c</span><span class="main">)</span> <span class="keyword1">*R</span> lec_const <span class="bound">c</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Leqc <span class="main">0</span> <span class="bound">const</span>
         <span class="main">∧</span> <span class="bound">const</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">CC</span></span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">const</span></span></span></span><span class="main"><span class="main">]</span></span> conjI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">c</span><span class="main">∈</span><span class="free">cs</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="skolem">CC</span> <span class="bound">c</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> CC_def <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">)</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_list_nonneg<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">const</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> snd<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">`</span> set <span class="skolem">C</span> <span class="main">⊆</span> <span class="free">cs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">c</span><span class="main">∈</span><span class="free">cs</span><span class="main">.</span> Le_Constraint Leq_Rel <span class="main">(</span><span class="skolem">CC</span> <span class="bound">c</span> <span class="keyword1">*R</span> lec_poly <span class="bound">c</span><span class="main">)</span> <span class="main">(</span><span class="skolem">CC</span> <span class="bound">c</span> <span class="keyword1">*R</span> lec_const <span class="bound">c</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Le_Constraint Leq_Rel <span class="main">0</span> <span class="skolem">const</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> 1<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> fin snd <span class="keyword1"><span class="command">unfolding</span></span> CC_def
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">cs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">C</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> empty
      <span class="keyword1"><span class="command">hence</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> *<span class="main">:</span> <span class="main">(</span>insert <span class="skolem">c</span> <span class="skolem">cs</span> <span class="skolem">C</span><span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?D</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span>Not <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">rc</span><span class="main">.</span> snd <span class="bound">rc</span> <span class="main">=</span> <span class="skolem">c</span><span class="main">)</span><span class="main">)</span> <span class="skolem">C</span>"</span></span> 
      <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">`</span> set <span class="var">?D</span> <span class="main">⊆</span> <span class="skolem">cs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> *<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">←</span> <span class="var">?D</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">a</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span> <span class="main">⇒</span> Le_Constraint Leq_Rel <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> lec_poly <span class="bound">c</span><span class="main">)</span> <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> lec_const <span class="bound">c</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
        <span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">←</span><span class="var">?D</span><span class="main">.</span> Le_Constraint Leq_Rel <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> lec_poly <span class="bound">c</span><span class="main">)</span> <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> lec_const <span class="bound">c</span><span class="main">)</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">C</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> sum.insert<span class="main">[</span><span class="operator">OF</span> *<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> sum_list_map_filter_sum<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">rc</span><span class="main">.</span> snd <span class="bound">rc</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span> <span class="quoted"><span class="skolem">C</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(+)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> IH<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> *<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">xs</span><span class="main">.</span> sum_list <span class="main">(</span>map <span class="main">_</span> <span class="bound">xs</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">C</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="skolem">C</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">rc</span> <span class="skolem">C</span><span class="main">)</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">rc</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"snd <span class="skolem">rc</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> scaleRat_left_distrib<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zero_le_constraint_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A version with indexed constraints, i.e., in particular where constraints may occur several
  times.›</span></span>

<span class="keyword1" id="Farkas-Farkas'_Lemma_indexed"><span class="command">lemma</span></span> Farkas'_Lemma_indexed<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> rat le_constraint"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> only_non_strict<span class="main">:</span> <span class="quoted"><span class="quoted">"lec_rel <span class="main">`</span> <span class="free">c</span> <span class="main">`</span> <span class="free">Is</span> <span class="main">⊆</span> <span class="main">{</span>Leq_Rel<span class="main">}</span>"</span></span>  
  <span class="keyword2"><span class="keyword">and</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Is</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∄</span> <span class="bound">v</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">Is</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub></span> <span class="free">c</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟷</span> 
       <span class="main">(</span><span class="main">∃</span> <span class="bound">C</span> <span class="bound">const</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">Is</span><span class="main">.</span> <span class="bound">C</span> <span class="bound">i</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span>
         <span class="main">∧</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">Is</span><span class="main">.</span> Leqc <span class="main">(</span><span class="main">(</span><span class="bound">C</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">*R</span> lec_poly <span class="main">(</span><span class="free">c</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="bound">C</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">*R</span> lec_const <span class="main">(</span><span class="free">c</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Leqc <span class="main">0</span> <span class="bound">const</span>
         <span class="main">∧</span> <span class="bound">const</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">`</span> <span class="free">Is</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="var">?C</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fin <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∄</span> <span class="bound">v</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">Is</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub></span> <span class="free">c</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∄</span> <span class="bound">v</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">cc</span> <span class="main">∈</span> <span class="var">?C</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub></span> <span class="bound">cc</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">C</span> <span class="bound">const</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">Is</span><span class="main">.</span> <span class="bound">C</span> <span class="bound">i</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span>
         <span class="main">∧</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">Is</span><span class="main">.</span> Leqc <span class="main">(</span><span class="main">(</span><span class="bound">C</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">*R</span> lec_poly <span class="main">(</span><span class="free">c</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="bound">C</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">*R</span> lec_const <span class="main">(</span><span class="free">c</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Leqc <span class="main">0</span> <span class="bound">const</span>
         <span class="main">∧</span> <span class="bound">const</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="skolem"><span class="skolem">const</span></span> <span class="keyword2"><span class="keyword">where</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">Is</span><span class="main">.</span> <span class="skolem">C</span> <span class="bound">i</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
         <span class="keyword2"><span class="keyword">and</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">Is</span><span class="main">.</span> Leqc <span class="main">(</span><span class="main">(</span><span class="skolem">C</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">*R</span> lec_poly <span class="main">(</span><span class="free">c</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">C</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">*R</span> lec_const <span class="main">(</span><span class="free">c</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Leqc <span class="main">0</span> <span class="skolem">const</span>"</span></span> 
         <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">const</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> finite_distinct_list<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="free">Is</span>›</span></span><span class="main">]</span> 
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Isl</span></span> <span class="keyword2"><span class="keyword">where</span></span> isl<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">Isl</span> <span class="main">=</span> <span class="free">Is</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dist<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">Isl</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?CC</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span> <span class="bound">rc</span><span class="main">.</span> fst <span class="bound">rc</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="skolem">C</span> <span class="bound">i</span><span class="main">,</span> <span class="free">c</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">Isl</span><span class="main">)</span>"</span></span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> Farkas'_Lemma<span class="main">[</span><span class="operator">OF</span> only_non_strict fin<span class="main">]</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?CC</span></span></span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">const</span></span></span></span><span class="main"><span class="main">]</span></span> conjI<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">const</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">ca</span><span class="main">)</span> <span class="main">∈</span> set <span class="var">?CC</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">r</span> <span class="main">∧</span> <span class="bound">ca</span> <span class="main">∈</span> <span class="var">?C</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> r<span class="main">(</span>1<span class="main">)</span> isl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">←</span><span class="var">?CC</span><span class="main">.</span> Le_Constraint Leq_Rel <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> lec_poly <span class="bound">c</span><span class="main">)</span> <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> lec_const <span class="bound">c</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        Le_Constraint Leq_Rel <span class="main">0</span> <span class="skolem">const</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> eq<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum_list_map_filter<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zero_le_constraint_def<span class="main"><span class="keyword3">,</span></span>
          <span class="operator">unfold</span> map_map o_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> sum_list_distinct_conv_sum_set<span class="main"><span class="main">[</span></span><span class="operator">OF</span> dist<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> isl<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> Farkas'_Lemma_set_sum<span class="main"><span class="main">[</span></span><span class="operator">OF</span> only_non_strict fin<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="skolem"><span class="skolem">const</span></span> <span class="keyword2"><span class="keyword">where</span></span> nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">c</span><span class="main">∈</span> <span class="var">?C</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="skolem">C</span> <span class="bound">c</span><span class="main">)</span>"</span></span> 
     <span class="keyword2"><span class="keyword">and</span></span> sum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">c</span><span class="main">∈</span> <span class="var">?C</span><span class="main">.</span> Le_Constraint Leq_Rel <span class="main">(</span><span class="skolem">C</span> <span class="bound">c</span> <span class="keyword1">*R</span> lec_poly <span class="bound">c</span><span class="main">)</span> <span class="main">(</span><span class="skolem">C</span> <span class="bound">c</span> <span class="keyword1">*R</span> lec_const <span class="bound">c</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        Le_Constraint Leq_Rel <span class="main">0</span> <span class="skolem">const</span>"</span></span> 
     <span class="keyword2"><span class="keyword">and</span></span> const<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">const</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="skolem">C</span> <span class="main">(</span><span class="free">c</span> <span class="bound">i</span><span class="main">)</span> <span class="main">/</span> rat_of_nat <span class="main">(</span>card <span class="main">(</span><span class="free">Is</span> <span class="main">∩</span> <span class="main">{</span> <span class="bound">j</span><span class="main">.</span> <span class="free">c</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">c</span> <span class="bound">j</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">I</span></span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">const</span></span></span></span><span class="main"><span class="main">]</span></span> conjI const<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">Is</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="skolem">I</span> <span class="bound">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nonneg <span class="keyword1"><span class="command">unfolding</span></span> I_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">Is</span><span class="main">.</span> Le_Constraint Leq_Rel <span class="main">(</span><span class="skolem">I</span> <span class="bound">i</span> <span class="keyword1">*R</span> lec_poly <span class="main">(</span><span class="free">c</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">I</span> <span class="bound">i</span> <span class="keyword1">*R</span> lec_const <span class="main">(</span><span class="free">c</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        Le_Constraint Leq_Rel <span class="main">0</span> <span class="skolem">const</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sum<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> sum.image_gen<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="free">Is</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">c</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">cc</span><span class="main">)</span>
        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">II</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">II</span> <span class="main">=</span> <span class="main">(</span><span class="free">Is</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="skolem">cc</span> <span class="main">=</span> <span class="free">c</span> <span class="bound">j</span><span class="main">}</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">II</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> II_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> finII<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">II</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">Is</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> II_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> card<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="skolem">II</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">II</span><span class="main">.</span> rat_of_nat <span class="main">(</span>card <span class="bound">II</span><span class="main">)</span>"</span></span> 
        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ii</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ii</span> <span class="main">=</span> <span class="skolem">C</span> <span class="skolem">cc</span> <span class="main">/</span> rat_of_nat <span class="main">(</span>card <span class="skolem">II</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">Is</span><span class="main">.</span> <span class="free">c</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">cc</span><span class="main">}</span><span class="main">.</span> Le_Constraint Leq_Rel <span class="main">(</span><span class="skolem">I</span> <span class="bound">i</span> <span class="keyword1">*R</span> lec_poly <span class="main">(</span><span class="free">c</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">I</span> <span class="bound">i</span> <span class="keyword1">*R</span> lec_const <span class="main">(</span><span class="free">c</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
          <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">i</span><span class="main">∈</span> <span class="skolem">II</span><span class="main">.</span> Le_Constraint Leq_Rel <span class="main">(</span><span class="skolem">ii</span> <span class="keyword1">*R</span> lec_poly <span class="skolem">cc</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ii</span> <span class="keyword1">*R</span> lec_const <span class="skolem">cc</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> I_def ii_def II_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Le_Constraint Leq_Rel <span class="main">(</span><span class="main">(</span><span class="var">?C</span> <span class="skolem">II</span> <span class="main">*</span> <span class="skolem">ii</span><span class="main">)</span> <span class="keyword1">*R</span> lec_poly <span class="skolem">cc</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="var">?C</span> <span class="skolem">II</span> <span class="main">*</span> <span class="skolem">ii</span><span class="main">)</span> <span class="keyword1">*R</span> lec_const <span class="skolem">cc</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> finII <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">II</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zero_le_constraint_def <span class="dynamic"><span class="dynamic">field_simps</span></span>
            scaleRat_left_distrib<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?C</span> <span class="skolem">II</span> <span class="main">*</span> <span class="skolem">ii</span> <span class="main">=</span> <span class="skolem">C</span> <span class="skolem">cc</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ii_def <span class="keyword1"><span class="command">using</span></span> card <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Matrix_Farkas">
<div class="head">
<h1>Theory Matrix_Farkas</h1>
</div>
<pre class="source"><span class="comment1">(* Author: R. Thiemann *)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Farkas Lemma for Matrices›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In this part we convert the simplex-structures like linear polynomials, etc., into
  equivalent formulations using matrices and vectors. As a result we present Farkas' Lemma
  via matrices and vectors.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Matrix_Farkas
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Farkas.html">Farkas</a>
  <a href="../Jordan_Normal_Form/Matrix.html">Jordan_Normal_Form.Matrix</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> poly_of_vec <span class="main">::</span> <span class="quoted"><span class="quoted">"rat vec <span class="main">⇒</span> linear_poly"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">v</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">(</span><span class="bound">x</span> <span class="main">&lt;</span> dim_vec <span class="bound">v</span><span class="main">)</span> <span class="keyword1">then</span> <span class="bound">v</span> <span class="main">$</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="main">0</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">val_of_vec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat vec <span class="main">⇒</span> rat valuation"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">val_of_vec</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> 

<span class="keyword1" id="Matrix_Farkas-valuate_poly_of_vec"><span class="command">lemma</span></span> valuate_poly_of_vec<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span>  
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"valuate <span class="main">(</span>poly_of_vec <span class="free">v</span><span class="main">)</span> <span class="main">(</span>val_of_vec <span class="free">w</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span> <span class="main">∙</span> <span class="free">w</span>"</span></span>  
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> val_of_vec_def scalar_prod_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sum.mono_neutral_left<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">constraints_of_mat_vec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat mat <span class="main">⇒</span> rat vec <span class="main">⇒</span> rat le_constraint set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">constraints_of_mat_vec</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span> <span class="main">.</span> Leqc <span class="main">(</span>poly_of_vec <span class="main">(</span>row <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> dim_row <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">}</span>"</span></span> 

<span class="keyword1" id="Matrix_Farkas-constraints_of_mat_vec_solution_main"><span class="command">lemma</span></span> constraints_of_mat_vec_solution_main<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">nr</span> <span class="free">nc</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> carrier_vec <span class="free">nc</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> carrier_vec <span class="free">nr</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> sol<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">x</span> <span class="main">≤</span> <span class="free">b</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> constraints_of_mat_vec <span class="free">A</span> <span class="free">b</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"val_of_vec <span class="free">x</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub></span> <span class="free">c</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> c<span class="main">[</span><span class="operator">unfolded</span> constraints_of_mat_vec_def<span class="main">]</span> A <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">nr</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> Leqc <span class="main">(</span>poly_of_vec <span class="main">(</span>row <span class="free">A</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">b</span> <span class="main">$</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> i A <span class="keyword1"><span class="command">have</span></span> ri<span class="main">:</span> <span class="quoted"><span class="quoted">"row <span class="free">A</span> <span class="skolem">i</span> <span class="main">∈</span> carrier_vec <span class="free">nc</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> sol i A x b <span class="keyword1"><span class="command">have</span></span> sol<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">x</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">$</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> less_eq_vec_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"val_of_vec <span class="free">x</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub></span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> c satisfiable_le_constraint.simps rel_of.simps
      valuate_poly_of_vec<span class="main">[</span><span class="operator">OF</span> x ri<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> A x i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Matrix_Farkas-vars_poly_of_vec"><span class="command">lemma</span></span> vars_poly_of_vec<span class="main">:</span> <span class="quoted"><span class="quoted">"vars <span class="main">(</span>poly_of_vec <span class="free">v</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span> <span class="main">0</span> <span class="main">..&lt;</span> dim_vec <span class="free">v</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer'</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Matrix_Farkas-finite_constraints_of_mat_vec"><span class="command">lemma</span></span> finite_constraints_of_mat_vec<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>constraints_of_mat_vec <span class="free">A</span> <span class="free">b</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> constraints_of_mat_vec_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Matrix_Farkas-lec_rec_constraints_of_mat_vec"><span class="command">lemma</span></span> lec_rec_constraints_of_mat_vec<span class="main">:</span> <span class="quoted"><span class="quoted">"lec_rel <span class="main">`</span> constraints_of_mat_vec <span class="free">A</span> <span class="free">b</span> <span class="main">⊆</span> <span class="main">{</span>Leq_Rel<span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> constraints_of_mat_vec_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Matrix_Farkas-constraints_of_mat_vec_solution_1"><span class="command">lemma</span></span> constraints_of_mat_vec_solution_1<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">nr</span> <span class="free">nc</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> carrier_vec <span class="free">nr</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> sol<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">x</span> <span class="main">∈</span> carrier_vec <span class="free">nc</span><span class="main">.</span> <span class="free">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">b</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> constraints_of_mat_vec <span class="free">A</span> <span class="free">b</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub></span> <span class="bound">c</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> constraints_of_mat_vec_solution_main<span class="main">[</span><span class="operator">OF</span> A _ b _<span class="main">]</span> sol <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Matrix_Farkas-constraints_of_mat_vec_solution_2"><span class="command">lemma</span></span> constraints_of_mat_vec_solution_2<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">nr</span> <span class="free">nc</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> carrier_vec <span class="free">nr</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> sol<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> constraints_of_mat_vec <span class="free">A</span> <span class="free">b</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub></span> <span class="bound">c</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">x</span> <span class="main">∈</span> carrier_vec <span class="free">nc</span><span class="main">.</span> <span class="free">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">b</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> sol <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> sol<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub></span> <span class="skolem">c</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> constraints_of_mat_vec <span class="free">A</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">c</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> vec <span class="free">nc</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">v</span> <span class="bound">i</span><span class="main">)</span>"</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> carrier_vec <span class="free">nc</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> x_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"row <span class="free">A</span> <span class="skolem">i</span> <span class="main">∙</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">$</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">nr</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Leqc <span class="main">(</span>poly_of_vec <span class="main">(</span>row <span class="free">A</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">b</span> <span class="main">$</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> constraints_of_mat_vec <span class="free">A</span> <span class="free">b</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> constraints_of_mat_vec_def <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> sol<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valuate <span class="main">(</span>poly_of_vec <span class="main">(</span>row <span class="free">A</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">$</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valuate <span class="main">(</span>poly_of_vec <span class="main">(</span>row <span class="free">A</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">=</span> valuate <span class="main">(</span>poly_of_vec <span class="main">(</span>row <span class="free">A</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>val_of_vec <span class="skolem">x</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> valuate_depend<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> A that<span class="main"><span class="keyword3">,</span></span> 
          <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> x_def val_of_vec_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> set_mp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> vars_poly_of_vec<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> row <span class="free">A</span> <span class="skolem">i</span> <span class="main">∙</span> <span class="skolem">x</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> valuate_poly_of_vec<span class="main"><span class="main">[</span></span><span class="operator">OF</span> x<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> that A x<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">x</span> <span class="main">≤</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> less_eq_vec_def <span class="keyword1"><span class="command">using</span></span> x A b <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Matrix_Farkas-constraints_of_mat_vec_solution"><span class="command">lemma</span></span> constraints_of_mat_vec_solution<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">nr</span> <span class="free">nc</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> carrier_vec <span class="free">nr</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span> <span class="bound">x</span> <span class="main">∈</span> carrier_vec <span class="free">nc</span><span class="main">.</span> <span class="free">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> constraints_of_mat_vec <span class="free">A</span> <span class="free">b</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub></span> <span class="bound">c</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> constraints_of_mat_vec_solution_1<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> constraints_of_mat_vec_solution_2<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 

<span class="keyword1" id="Matrix_Farkas-farkas_lemma_matrix"><span class="command">lemma</span></span> farkas_lemma_matrix<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat mat"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">nr</span> <span class="free">nc</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> carrier_vec <span class="free">nr</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span> <span class="bound">x</span> <span class="main">∈</span> carrier_vec <span class="free">nc</span><span class="main">.</span> <span class="free">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">b</span><span class="main">)</span> <span class="main">⟷</span> 
  <span class="main">(</span><span class="main">∀</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≥</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">nr</span> <span class="main">⟶</span> mat_of_row <span class="bound">y</span> <span class="main">*</span> <span class="free">A</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">1</span> <span class="free">nc</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">∙</span> <span class="free">b</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">cs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cs</span> <span class="main">=</span> constraints_of_mat_vec <span class="free">A</span> <span class="free">b</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">nr</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> dim<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row <span class="free">A</span> <span class="main">=</span> <span class="free">nr</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> sum_id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">nr</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> sum_list <span class="main">(</span>map <span class="skolem">f</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">nr</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum_list_distinct_conv_sum_set<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span> <span class="bound">x</span> <span class="main">∈</span> carrier_vec <span class="free">nc</span><span class="main">.</span> <span class="free">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="main">¬</span> <span class="main">(</span><span class="main">∄</span> <span class="bound">v</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> <span class="skolem">cs</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub></span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> constraints_of_mat_vec_solution<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> cs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> <span class="main">(</span><span class="main">∄</span><span class="bound">v</span><span class="main">.</span> <span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">nr</span><span class="main">}</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub></span> Le_Constraint Leq_Rel <span class="main">(</span>poly_of_vec <span class="main">(</span>row <span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">b</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> cs_def constraints_of_mat_vec_def dim <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∄</span><span class="bound">C</span><span class="main">.</span>
        <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">nr</span><span class="main">}</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">C</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∧</span>
         <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">nr</span><span class="main">.</span> <span class="main">(</span><span class="bound">C</span> <span class="bound">i</span> <span class="keyword1">*R</span> poly_of_vec <span class="main">(</span>row <span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span>
         <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">nr</span><span class="main">.</span> <span class="main">(</span><span class="bound">C</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">b</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> Farkas'_Lemma_indexed<span class="main">[</span><span class="operator">OF</span> 
        lec_rec_constraints_of_mat_vec<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> constraints_of_mat_vec_def<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">,</span>
        <span class="operator">unfolded</span> dim<span class="main">,</span> <span class="operator">OF</span> fin<span class="main">]</span> sum_id sum_list_lec le_constraint.simps 
        sum_list_Leq_Rel map_map o_def <span class="keyword1"><span class="command">unfolding</span></span> sum_id<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">C</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">nr</span><span class="main">}</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">C</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟶</span> 
         <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">nr</span><span class="main">.</span> <span class="main">(</span><span class="bound">C</span> <span class="bound">i</span> <span class="keyword1">*R</span> poly_of_vec <span class="main">(</span>row <span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span>
         <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">nr</span><span class="main">.</span> <span class="main">(</span><span class="bound">C</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">b</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> not_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≥</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">nr</span> <span class="main">⟶</span> mat_of_row <span class="bound">y</span> <span class="main">*</span> <span class="free">A</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">1</span> <span class="free">nc</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">∙</span> <span class="free">b</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">intro</span> allI impI<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> *<span class="main">:</span> <span class="main">(</span>1 <span class="skolem">y</span><span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">y</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">note</span></span> main <span class="main">=</span> *<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">C</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">from</span></span> *<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> carrier_vec <span class="free">nr</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">nr</span><span class="main">}</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> <span class="skolem">C</span> <span class="bound">i</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> less_eq_vec_def C_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> sum_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">nr</span><span class="main">.</span> <span class="skolem">C</span> <span class="bound">i</span> <span class="keyword1">*R</span> poly_of_vec <span class="main">(</span>row <span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> C_def
      <span class="keyword1"><span class="command">unfolding</span></span> zero_coeff_zero coeff_sum 
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">nr</span><span class="main">.</span> coeff <span class="main">(</span><span class="skolem">y</span> <span class="main">$</span> <span class="bound">i</span> <span class="keyword1">*R</span> poly_of_vec <span class="main">(</span>row <span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> 
            <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">&lt;</span> <span class="free">nr</span><span class="main">.</span> <span class="skolem">y</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">*</span> coeff <span class="main">(</span>poly_of_vec <span class="main">(</span>row <span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">&lt;</span> <span class="free">nc</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">&lt;</span> <span class="free">nr</span><span class="main">.</span> <span class="skolem">y</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">*</span> coeff <span class="main">(</span>poly_of_vec <span class="main">(</span>row <span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> 
              <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">&lt;</span> <span class="free">nr</span><span class="main">.</span> <span class="skolem">y</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">*</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">*</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> A False<span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">nr</span><span class="main">.</span> <span class="skolem">y</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">*</span> coeff <span class="main">(</span>poly_of_vec <span class="main">(</span>row <span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span>
              <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">nr</span><span class="main">.</span> <span class="skolem">y</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">*</span> row <span class="free">A</span> <span class="bound">i</span> <span class="main">$</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">*</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> A True<span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>mat_of_row <span class="skolem">y</span> <span class="main">*</span> <span class="free">A</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="skolem">v</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">unfolding</span></span> times_mat_def scalar_prod_def
          <span class="keyword1"><span class="command">using</span></span> A y True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sum.cong<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> *<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">nr</span><span class="main">.</span> coeff <span class="main">(</span><span class="skolem">y</span> <span class="main">$</span> <span class="bound">i</span> <span class="keyword1">*R</span> poly_of_vec <span class="main">(</span>row <span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">from</span></span> main<span class="main">[</span><span class="operator">OF</span> nonneg sum_0<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">nr</span><span class="main">.</span> <span class="skolem">C</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">b</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> y b <span class="keyword1"><span class="command">unfolding</span></span> scalar_prod_def C_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> *<span class="main">:</span> <span class="main">(</span>2 <span class="skolem">C</span><span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> vec <span class="free">nr</span> <span class="skolem">C</span>"</span></span> 
    <span class="keyword1"><span class="command">have</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> carrier_vec <span class="free">nr</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> y_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> main <span class="main">=</span> *<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">from</span></span> *<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> y0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≥</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">nr</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> less_eq_vec_def y_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> prod0<span class="main">:</span> <span class="quoted"><span class="quoted">"mat_of_row <span class="skolem">y</span> <span class="main">*</span> <span class="free">A</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">1</span> <span class="free">nc</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
        <span class="keyword3"><span class="command">assume</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">nc</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> *<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> coeff <span class="bound">x</span> <span class="skolem">j</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> coeff_sum<span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">nr</span><span class="main">.</span> <span class="skolem">C</span> <span class="bound">i</span> <span class="main">*</span> coeff <span class="main">(</span>poly_of_vec <span class="main">(</span>row <span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">nr</span><span class="main">.</span> <span class="skolem">C</span> <span class="bound">i</span> <span class="main">*</span> row <span class="free">A</span> <span class="bound">i</span> <span class="main">$</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">*</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> A j<span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">∙</span> col <span class="free">A</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> scalar_prod_def y_def <span class="keyword1"><span class="command">using</span></span> A j 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∙</span> col <span class="free">A</span> <span class="skolem">j</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> eq_matI<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> A y<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">from</span></span> main<span class="main">[</span><span class="operator">OF</span> y0 prod0<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">y</span> <span class="main">∙</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> scalar_prod_def y_def <span class="keyword1"><span class="command">using</span></span> b <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Matrix_Farkas-farkas_lemma_matrix'"><span class="command">lemma</span></span> farkas_lemma_matrix'<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat mat"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">nr</span> <span class="free">nc</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> carrier_vec <span class="free">nr</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span> <span class="bound"><span class="bound">x</span></span> <span class="main">≥</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">nc</span><span class="main">.</span> <span class="free">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="free">b</span><span class="main">)</span> <span class="main">⟷</span> 
  <span class="main">(</span><span class="main">∀</span> <span class="bound">y</span> <span class="main">∈</span> carrier_vec <span class="free">nr</span><span class="main">.</span> mat_of_row <span class="bound">y</span> <span class="main">*</span> <span class="free">A</span> <span class="main">≥</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">1</span> <span class="free">nc</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">∙</span> <span class="free">b</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> <span class="main">(</span><span class="main">-</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">nc</span><span class="main">)</span> <span class="keyword1">@<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">@<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">-</span><span class="free">A</span><span class="main">)</span>"</span></span>   
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">b'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b'</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">nc</span> <span class="keyword1">@<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span><span class="free">b</span> <span class="keyword1">@<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">-</span><span class="free">b</span><span class="main">)</span>"</span></span> 
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="free">nc</span> <span class="main">+</span> <span class="main">(</span><span class="free">nr</span> <span class="main">+</span> <span class="free">nr</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> id0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span><span class="free">nc</span> <span class="main">+</span> <span class="main">(</span><span class="free">nr</span> <span class="main">+</span> <span class="free">nr</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">nc</span> <span class="keyword1">@<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span><span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">nr</span> <span class="keyword1">@<span class="hidden">⇩</span><sub>v</sub></span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">nr</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> eq_vecI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∈</span> carrier_mat <span class="skolem">n</span> <span class="free">nc</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> B_def n_def <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> b'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b'</span> <span class="main">∈</span> carrier_vec <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> b'_def n_def <span class="keyword1"><span class="command">using</span></span> b <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span> <span class="bound"><span class="bound">x</span></span> <span class="main">≥</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">nc</span><span class="main">.</span> <span class="free">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> carrier_vec <span class="free">nc</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">≥</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">nc</span> <span class="main">∧</span> <span class="free">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="free">b</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">Ex</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> A b<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_eq_vec_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">x</span> <span class="main">∈</span> carrier_vec <span class="free">nc</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≥</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">nc</span> <span class="main">∧</span> <span class="free">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">x</span> <span class="main">∈</span> carrier_vec <span class="free">nc</span><span class="main">.</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">nc</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">x</span> <span class="main">≥</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">nc</span> <span class="main">∧</span> <span class="free">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">∧</span> <span class="free">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">x</span> <span class="main">≥</span> <span class="free">b</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bex_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> A b<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">x</span> <span class="main">∈</span> carrier_vec <span class="free">nc</span><span class="main">.</span> <span class="main">(</span><span class="main">-</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">nc</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">x</span> <span class="main">≤</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">nc</span> <span class="main">∧</span> <span class="free">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">∧</span> <span class="main">(</span><span class="main">-</span> <span class="free">A</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">-</span><span class="free">b</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bex_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> A b<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_eq_vec_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">x</span> <span class="main">∈</span> carrier_vec <span class="free">nc</span><span class="main">.</span> <span class="skolem">B</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">x</span> <span class="main">≤</span> <span class="skolem">b'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bex_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> A b<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> B_def b'_def<span class="main"><span class="keyword3">,</span></span> 
      <span class="operator">subst</span> append_rows_le<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>4<span class="main"><span class="keyword3">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conj_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> append_rows_le<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">y</span></span><span class="main">≥</span><span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">n</span><span class="main">.</span> mat_of_row <span class="bound">y</span> <span class="main">*</span> <span class="skolem">B</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">1</span> <span class="free">nc</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">∙</span> <span class="skolem">b'</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span>"</span></span>   
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> farkas_lemma_matrix<span class="main"><span class="main">[</span></span><span class="operator">OF</span> B b'<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> carrier_vec <span class="skolem">n</span> <span class="main">⟶</span> <span class="bound">y</span><span class="main">≥</span><span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">n</span> <span class="main">⟶</span> mat_of_row <span class="bound">y</span> <span class="main">*</span> <span class="skolem">B</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">1</span> <span class="free">nc</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">∙</span> <span class="skolem">b'</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">All</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_eq_vec_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">y</span> <span class="main">∈</span> carrier_vec <span class="skolem">n</span><span class="main">.</span> <span class="bound">y</span><span class="main">≥</span><span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">n</span> <span class="main">⟶</span> mat_of_row <span class="bound">y</span> <span class="main">*</span> <span class="skolem">B</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">1</span> <span class="free">nc</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">∙</span> <span class="skolem">b'</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y1</span> <span class="main">∈</span>carrier_vec <span class="free">nc</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y2</span> <span class="main">∈</span>carrier_vec <span class="free">nr</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y3</span> <span class="main">∈</span>carrier_vec <span class="free">nr</span><span class="main">.</span>
              <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">nc</span> <span class="keyword1">@<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span><span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">nr</span> <span class="keyword1">@<span class="hidden">⇩</span><sub>v</sub></span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">nr</span><span class="main">)</span> <span class="main">≤</span> <span class="bound">y1</span> <span class="keyword1">@<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">y2</span> <span class="keyword1">@<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">y3</span>  <span class="main">⟶</span>
              mat_of_row <span class="main">(</span><span class="bound">y1</span> <span class="keyword1">@<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">y2</span> <span class="keyword1">@<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">y3</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="main">-</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">nc</span><span class="main">)</span> <span class="keyword1">@<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">@<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">-</span><span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">1</span> <span class="free">nc</span> 
              <span class="main">⟶</span> <span class="main">0</span> <span class="main">≤</span> <span class="main">(</span><span class="bound">y1</span> <span class="keyword1">@<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">y2</span> <span class="keyword1">@<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">y3</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span><span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">nc</span> <span class="keyword1">@<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span><span class="free">b</span> <span class="keyword1">@<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">-</span><span class="free">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> n_def all_vec_append id0 b'_def B_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y1</span> <span class="main">∈</span>carrier_vec <span class="free">nc</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y2</span> <span class="main">∈</span>carrier_vec <span class="free">nr</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y3</span> <span class="main">∈</span>carrier_vec <span class="free">nr</span><span class="main">.</span>
              <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">nc</span> <span class="main">≤</span> <span class="bound">y1</span> <span class="main">⟶</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">nr</span> <span class="main">≤</span> <span class="bound">y2</span> <span class="main">⟶</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">nr</span> <span class="main">≤</span> <span class="bound">y3</span> <span class="main">⟶</span>
              <span class="main">(</span><span class="main">-</span> mat_of_row <span class="bound">y1</span><span class="main">)</span> <span class="main">+</span> 
              <span class="main">(</span>mat_of_row <span class="bound">y2</span> <span class="main">*</span> <span class="free">A</span> <span class="main">-</span> <span class="main">(</span>mat_of_row <span class="bound">y3</span> <span class="main">*</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">1</span> <span class="free">nc</span> 
              <span class="main">⟶</span> <span class="bound">y2</span> <span class="main">∙</span> <span class="free">b</span> <span class="main">-</span> <span class="bound">y3</span> <span class="main">∙</span> <span class="free">b</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ball_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> append_vec_le<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> append_vec_le<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> A b<span class="main"><span class="keyword3">,</span></span>
      <span class="operator">subst</span> scalar_prod_append<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>4<span class="main"><span class="keyword3">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> scalar_prod_append<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>4<span class="main"><span class="keyword3">]</span></span><span class="main"><span class="keyword3">,</span></span> 
      <span class="operator">subst</span> mat_of_row_mult_append_rows<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>4<span class="main"><span class="keyword3">]</span></span><span class="main"><span class="keyword3">,</span></span>
      <span class="operator">subst</span> mat_of_row_mult_append_rows<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>4<span class="main"><span class="keyword3">]</span></span><span class="main"><span class="keyword3">,</span></span>
      <span class="operator">subst</span> add_uminus_minus_mat<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y1</span> <span class="main">∈</span>carrier_vec <span class="free">nc</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y2</span> <span class="main">∈</span>carrier_vec <span class="free">nr</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y3</span> <span class="main">∈</span>carrier_vec <span class="free">nr</span><span class="main">.</span>
              <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">nc</span> <span class="main">≤</span> <span class="bound">y1</span> <span class="main">⟶</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">nr</span> <span class="main">≤</span> <span class="bound">y2</span> <span class="main">⟶</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">nr</span> <span class="main">≤</span> <span class="bound">y3</span> <span class="main">⟶</span>
              mat_of_row <span class="bound">y1</span> <span class="main">=</span> mat_of_row <span class="bound">y2</span> <span class="main">*</span> <span class="free">A</span> <span class="main">-</span> mat_of_row <span class="bound">y3</span> <span class="main">*</span> <span class="free">A</span>
              <span class="main">⟶</span> <span class="bound">y2</span> <span class="main">∙</span> <span class="free">b</span> <span class="main">-</span> <span class="bound">y3</span> <span class="main">∙</span> <span class="free">b</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">intro</span> ball_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span> arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(⟶)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span> refl<span class="main"><span class="keyword3">,</span></span> <span class="operator">standard</span><span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">y1</span> <span class="skolem">y2</span> <span class="skolem">y3</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> 1<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> mat_of_row <span class="skolem">y1</span> <span class="main">+</span> <span class="bound">x</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1-3<span class="main">)</span> A
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> assoc_add_mat<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>3<span class="main"><span class="keyword3">]</span></span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> add_uminus_minus_mat<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> minus_r_inv_mat<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> right_add_zero_mat<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> left_add_zero_mat<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">y1</span> <span class="skolem">y2</span> <span class="skolem">y3</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> 2<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>1-3<span class="main">)</span> A
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> eq_matI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y1</span> <span class="main">∈</span>carrier_vec <span class="free">nc</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y2</span> <span class="main">∈</span>carrier_vec <span class="free">nr</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y3</span> <span class="main">∈</span>carrier_vec <span class="free">nr</span><span class="main">.</span>
              <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">nc</span> <span class="main">≤</span> <span class="bound">y1</span> <span class="main">⟶</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">nr</span> <span class="main">≤</span> <span class="bound">y2</span> <span class="main">⟶</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">nr</span> <span class="main">≤</span> <span class="bound">y3</span> <span class="main">⟶</span>
              mat_of_row <span class="bound">y1</span> <span class="main">=</span> mat_of_row <span class="main">(</span><span class="bound">y2</span> <span class="main">-</span> <span class="bound">y3</span><span class="main">)</span> <span class="main">*</span> <span class="free">A</span>
              <span class="main">⟶</span> <span class="main">(</span><span class="bound">y2</span> <span class="main">-</span> <span class="bound">y3</span><span class="main">)</span> <span class="main">∙</span> <span class="free">b</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ball_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span> imp_cong refl 
      arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">(≤)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">(=)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
      <span class="operator">subst</span> minus_mult_distrib_mat<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> A b<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span>
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> minus_scalar_prod_distrib mat_of_rows_def 
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">*</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y1</span> <span class="main">∈</span>carrier_vec <span class="free">nc</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y2</span> <span class="main">∈</span>carrier_vec <span class="free">nr</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y3</span> <span class="main">∈</span>carrier_vec <span class="free">nr</span><span class="main">.</span>
              <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">nc</span> <span class="main">≤</span> <span class="bound">y1</span> <span class="main">⟶</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">nr</span> <span class="main">≤</span> <span class="bound">y2</span> <span class="main">⟶</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">nr</span> <span class="main">≤</span> <span class="bound">y3</span> <span class="main">⟶</span>
              <span class="bound">y1</span> <span class="main">=</span> row <span class="main">(</span>mat_of_row <span class="main">(</span><span class="bound">y2</span> <span class="main">-</span> <span class="bound">y3</span><span class="main">)</span> <span class="main">*</span> <span class="free">A</span><span class="main">)</span> <span class="main">0</span>
              <span class="main">⟶</span> <span class="main">(</span><span class="bound">y2</span> <span class="main">-</span> <span class="bound">y3</span><span class="main">)</span> <span class="main">∙</span> <span class="free">b</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> ball_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span> arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(⟶)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span> refl<span class="main"><span class="keyword3">,</span></span> <span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">y1</span> <span class="skolem">y2</span> <span class="skolem">y3</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> 1<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> row <span class="bound">x</span> <span class="main">0</span>"</span></span><span class="main">]</span> 1<span class="main">(</span>1-3<span class="main">)</span> A
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> A<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y2</span> <span class="main">∈</span>carrier_vec <span class="free">nr</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y3</span> <span class="main">∈</span>carrier_vec <span class="free">nr</span><span class="main">.</span>
              <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">nc</span> <span class="main">≤</span> row <span class="main">(</span>mat_of_row <span class="main">(</span><span class="bound">y2</span> <span class="main">-</span> <span class="bound">y3</span><span class="main">)</span> <span class="main">*</span> <span class="free">A</span><span class="main">)</span> <span class="main">0</span> <span class="main">⟶</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">nr</span> <span class="main">≤</span> <span class="bound">y2</span> <span class="main">⟶</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">nr</span> <span class="main">≤</span> <span class="bound">y3</span> <span class="main">⟶</span>
              row <span class="main">(</span>mat_of_row <span class="main">(</span><span class="bound">y2</span> <span class="main">-</span> <span class="bound">y3</span><span class="main">)</span> <span class="main">*</span> <span class="free">A</span><span class="main">)</span> <span class="main">0</span> <span class="main">∈</span> carrier_vec <span class="free">nc</span>
              <span class="main">⟶</span> <span class="main">(</span><span class="bound">y2</span> <span class="main">-</span> <span class="bound">y3</span><span class="main">)</span> <span class="main">∙</span> <span class="free">b</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y2</span> <span class="main">∈</span>carrier_vec <span class="free">nr</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y3</span> <span class="main">∈</span>carrier_vec <span class="free">nr</span><span class="main">.</span>
              <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">nc</span> <span class="main">≤</span> row <span class="main">(</span>mat_of_row <span class="main">(</span><span class="bound">y2</span> <span class="main">-</span> <span class="bound">y3</span><span class="main">)</span> <span class="main">*</span> <span class="free">A</span><span class="main">)</span> <span class="main">0</span> <span class="main">⟶</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">nr</span> <span class="main">≤</span> <span class="bound">y2</span> <span class="main">⟶</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">nr</span> <span class="main">≤</span> <span class="bound">y3</span> 
              <span class="main">⟶</span> <span class="main">(</span><span class="bound">y2</span> <span class="main">-</span> <span class="bound">y3</span><span class="main">)</span> <span class="main">∙</span> <span class="free">b</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ball_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span> arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">(⟶)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> refl<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> A<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> row_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">y</span> <span class="main">∈</span> carrier_vec <span class="free">nr</span><span class="main">.</span> row <span class="main">(</span>mat_of_row <span class="bound">y</span> <span class="main">*</span> <span class="free">A</span><span class="main">)</span> <span class="main">0</span> <span class="main">≥</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">nc</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">∙</span> <span class="free">b</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">intro</span> ballI impI<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">y</span><span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">y2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y2</span> <span class="main">=</span> vec <span class="free">nr</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="skolem">y</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">≥</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="skolem">y</span> <span class="main">$</span> <span class="bound">i</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">y3</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y3</span> <span class="main">=</span> vec <span class="free">nr</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="skolem">y</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">≥</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">-</span> <span class="skolem">y</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">have</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">y2</span> <span class="main">-</span> <span class="skolem">y3</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> y2_def y3_def <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> eq_vecI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> 1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">y2</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">y3</span></span></span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">folded</span> y<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ _ 1<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
       <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> y2_def y3_def less_eq_vec_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">y</span> <span class="main">∈</span> carrier_vec <span class="free">nr</span><span class="main">.</span> mat_of_row <span class="bound">y</span> <span class="main">*</span> <span class="free">A</span> <span class="main">≥</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">1</span> <span class="free">nc</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">∙</span> <span class="free">b</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ball_cong arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">(⟶)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> refl<span class="main"><span class="keyword3">,</span></span>
      <span class="operator">insert</span> A<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_eq_vec_def less_eq_mat_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Simplex_for_Reals">
<div class="head">
<h1>Theory Simplex_for_Reals</h1>
</div>
<pre class="source"><span class="comment1">(* Author: R. Thiemann *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Unsatisfiability over the Reals›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹By using Farkas' Lemma we prove that a finite set of 
  linear rational inequalities is satisfiable over the rational numbers
  if and only if it is satisfiable over the real numbers.
  Hence, the simplex algorithm either gives a rational solution or
  shows unsatisfiability over the real numbers.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Simplex_for_Reals
  <span class="keyword2"><span class="keyword">imports</span></span> 
    <a href="Farkas.html">Farkas</a>
    <a href="../Simplex/Simplex_Incremental.html">Simplex.Simplex_Incremental</a>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">instantiation</span></span> real <span class="main">::</span> <span class="quoted">lrv</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">scaleRat_real</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat <span class="main">⇒</span> real <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">*R</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> real_of_rat <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>
<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> of_rat_mult of_rat_add<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">real_satisfies_constraints</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real valuation <span class="main">⇒</span> constraint set <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span>"</span> 100<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1"><span class="free">⊨<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">c</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub></span> <span class="bound">c</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">of_rat_val</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat valuation <span class="main">⇒</span> real valuation"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">of_rat_val</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> of_rat <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span> 

<span class="keyword1" id="Simplex_for_Reals-of_rat_val_eval"><span class="command">lemma</span></span> of_rat_val_eval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">⦃</span>of_rat_val <span class="free">v</span><span class="main">⦄</span> <span class="main">=</span> of_rat <span class="main">(</span><span class="free">p</span> <span class="main">⦃</span><span class="free">v</span><span class="main">⦄</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> of_rat_val_def linear_poly_sum of_rat_sum 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> of_rat_mult<span class="main">)</span>

<span class="keyword1" id="Simplex_for_Reals-of_rat_val_constraint"><span class="command">lemma</span></span> of_rat_val_constraint<span class="main">:</span> <span class="quoted"><span class="quoted">"of_rat_val <span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">c</span> <span class="main">⟷</span> <span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">c</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> of_rat_val_eval of_rat_less of_rat_less_eq<span class="main">)</span>

<span class="keyword1" id="Simplex_for_Reals-of_rat_val_constraints"><span class="command">lemma</span></span> of_rat_val_constraints<span class="main">:</span> <span class="quoted"><span class="quoted">"of_rat_val <span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">cs</span> <span class="main">⟷</span> <span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">cs</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> of_rat_val_constraint <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Simplex_for_Reals-sat_scale_rat_real"><span class="command">lemma</span></span> sat_scale_rat_real<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span> <span class="main">::</span> real valuation<span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">(</span><span class="free">r</span> <span class="keyword1">*R</span> <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">r</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">r</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> right_diff_distrib 
        valuate_minus valuate_scaleRat scaleRat_leq1 scaleRat_leq2 valuate_zero
        of_rat_less of_rat_mult<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">of_rat_lec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat le_constraint <span class="main">⇒</span> real le_constraint"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">of_rat_lec</span> <span class="main">(</span>Le_Constraint <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> Le_Constraint <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span>of_rat <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span> 

<span class="keyword1" id="Simplex_for_Reals-lec_of_constraint_real"><span class="command">lemma</span></span> lec_of_constraint_real<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_le <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub></span> of_rat_lec <span class="main">(</span>lec_of_constraint <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Simplex_for_Reals-of_rat_lec_add"><span class="command">lemma</span></span> of_rat_lec_add<span class="main">:</span> <span class="quoted"><span class="quoted">"of_rat_lec <span class="main">(</span><span class="free">c</span> <span class="main">+</span> <span class="free">d</span><span class="main">)</span> <span class="main">=</span> of_rat_lec <span class="free">c</span> <span class="main">+</span> of_rat_lec <span class="free">d</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">d</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> of_rat_add<span class="main">)</span>

<span class="keyword1" id="Simplex_for_Reals-of_rat_lec_zero"><span class="command">lemma</span></span> of_rat_lec_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"of_rat_lec <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> zero_le_constraint_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Simplex_for_Reals-of_rat_lec_sum"><span class="command">lemma</span></span> of_rat_lec_sum<span class="main">:</span> <span class="quoted"><span class="quoted">"of_rat_lec <span class="main">(</span>sum_list <span class="free">c</span><span class="main">)</span> <span class="main">=</span> sum_list <span class="main">(</span>map of_rat_lec <span class="free">c</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">c</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> of_rat_lec_zero of_rat_lec_add<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This is the main lemma: a finite set of linear constraints is 
  satisfiable over Q if and only if it is satisfiable over R.›</span></span>
<span class="keyword1" id="Simplex_for_Reals-rat_real_conversion"><span class="command">lemma</span></span> rat_real_conversion<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">cs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span> <span class="bound">v</span> <span class="main">::</span> rat valuation<span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">cs</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">v</span> <span class="main">::</span> real valuation<span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">cs</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">cs</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">cs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> of_rat_val_constraint <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">cs</span>"</span></span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">cs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">cs</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="free">cs</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> farkas_coefficients<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> this
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"farkas_coefficients <span class="free">cs</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> farkas_coefficients_def<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="skolem"><span class="skolem">rel</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      isleq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">C</span><span class="main">.</span> <span class="bound">c</span> <span class="main">∈</span> <span class="free">cs</span> <span class="main">∧</span> is_le <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> <span class="bound">c</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">r</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      leq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span> <span class="main">←</span> <span class="skolem">C</span><span class="main">.</span> lec_of_constraint <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Le_Constraint <span class="skolem">rel</span> <span class="main">0</span> <span class="skolem">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      choice<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">rel</span> <span class="main">=</span> Lt_Rel <span class="main">∧</span> <span class="skolem">d</span> <span class="main">≤</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">rel</span> <span class="main">=</span> Leq_Rel <span class="main">∧</span> <span class="skolem">d</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="skolem">c</span>
      <span class="keyword3"><span class="command">assume</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">r</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">C</span>"</span></span> 
      <span class="keyword1"><span class="command">from</span></span> c * isleq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub></span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">(</span><span class="skolem">r</span> <span class="keyword1">*R</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sat_scale_rat_real<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> c isleq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_le <span class="main">(</span><span class="skolem">r</span> <span class="keyword1">*R</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> lec_of_constraint_real<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> v 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub></span> of_rat_lec <span class="main">(</span>lec_of_constraint <span class="main">(</span><span class="skolem">r</span> <span class="keyword1">*R</span> <span class="skolem">c</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> v <span class="main">=</span> this
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Le_Constraint <span class="skolem">rel</span> <span class="main">0</span> <span class="main">(</span>of_rat <span class="skolem">d</span><span class="main">)</span> <span class="main">=</span> of_rat_lec <span class="main">(</span><span class="main">∑</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span> <span class="main">←</span> <span class="skolem">C</span><span class="main">.</span> lec_of_constraint <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> leq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span> <span class="main">←</span> <span class="skolem">C</span><span class="main">.</span> of_rat_lec <span class="main">(</span>lec_of_constraint <span class="main">(</span><span class="bound">r</span> <span class="keyword1">*R</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?sum</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> of_rat_lec_sum map_map o_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">sum_list</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> leq<span class="main">:</span> <span class="quoted"><span class="quoted">"Le_Constraint <span class="skolem">rel</span> <span class="main">0</span> <span class="main">(</span>of_rat <span class="skolem">d</span><span class="main">)</span> <span class="main">=</span> <span class="var">?sum</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>l</sub><span class="hidden">⇩</span><sub>e</sub></span> Le_Constraint <span class="skolem">rel</span> <span class="main">0</span> <span class="main">(</span>of_rat <span class="skolem">d</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> leq
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> satisfies_sumlist_le_constraints<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> v<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> choice <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> linear_poly_sum<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The main result of simplex, now using unsatisfiability over the reals.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">i_satisfies_cs_real</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span>"</span> 100<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊨<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> Simplex.restrict_to <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span>"</span></span>

<span class="keyword1" id="Simplex_for_Reals-simplex_index_real"><span class="command">lemma</span></span> simplex_index_real<span class="main">:</span>
  <span class="quoted"><span class="quoted">"simplex_index <span class="free">cs</span> <span class="main">=</span> Unsat <span class="free">I</span> <span class="main">⟹</span> set <span class="free">I</span> <span class="main">⊆</span> fst <span class="main">`</span> set <span class="free">cs</span> <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span>set <span class="free">I</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free">cs</span><span class="main">)</span> <span class="main">∧</span> 
     <span class="main">(</span>distinct_indices <span class="free">cs</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">J</span></span> <span class="main">⊂</span> set <span class="free">I</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="bound">J</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free">cs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="comment1">― ‹minimal unsat core over the reals›</span>
  <span class="quoted"><span class="quoted">"simplex_index <span class="free">cs</span> <span class="main">=</span> Sat <span class="free">v</span> <span class="main">⟹</span> <span class="main">⟨</span><span class="free">v</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="main">(</span>snd <span class="main">`</span> set <span class="free">cs</span><span class="main">)</span>"</span></span> <span class="comment1">― ‹satisfying assingment›</span>
  <span class="keyword1"><span class="command">using</span></span> simplex_index<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">cs</span></span> <span class="quoted"><span class="free">I</span></span><span class="main">]</span> simplex_index<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">cs</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">]</span> 
    rat_real_conversion<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Simplex.restrict_to <span class="main">(</span>set <span class="free">I</span><span class="main">)</span> <span class="main">(</span>set <span class="free">cs</span><span class="main">)</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1" id="Simplex_for_Reals-simplex_real"><span class="command">lemma</span></span> simplex_real<span class="main">:</span>
  <span class="quoted"><span class="quoted">"simplex <span class="free">cs</span> <span class="main">=</span> Unsat <span class="free">I</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free">cs</span><span class="main">)</span>"</span></span> <span class="comment1">― ‹unsat of original constraints over the reals›</span>
  <span class="quoted"><span class="quoted">"simplex <span class="free">cs</span> <span class="main">=</span> Unsat <span class="free">I</span> <span class="main">⟹</span> set <span class="free">I</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">cs</span><span class="main">}</span> <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="main">{</span><span class="free">cs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">|</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="free">I</span><span class="main">}</span><span class="main">)</span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">J</span></span><span class="main">⊂</span>set <span class="free">I</span><span class="main">.</span> <span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="main">{</span><span class="free">cs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="bound">J</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="comment1">― ‹minimal unsat core over reals›</span>
  <span class="quoted"><span class="quoted">"simplex <span class="free">cs</span> <span class="main">=</span> Sat <span class="free">v</span> <span class="main">⟹</span> <span class="main">⟨</span><span class="free">v</span><span class="main">⟩</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free">cs</span>"</span></span>  <span class="comment1">― ‹satisfying assignment over the rationals›</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> simplex<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> rat_real_conversion<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_set<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> unsat<span class="main">:</span> <span class="quoted"><span class="quoted">"simplex <span class="free">cs</span> <span class="main">=</span> Inl <span class="free">I</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="free">cs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="free">I</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> simplex<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> unsat<span class="main">,</span> <span class="operator">unfolded</span> rat_real_conversion<span class="main"><span class="main">[</span></span><span class="operator">OF</span> this<span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="free">I</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">cs</span><span class="main">}</span> <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="main">{</span><span class="free">cs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">|</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="free">I</span><span class="main">}</span><span class="main">)</span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">J</span></span><span class="main">⊂</span>set <span class="free">I</span><span class="main">.</span> <span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> <span class="main">{</span><span class="free">cs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="bound">J</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> simplex<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Define notion of minimal unsat core over the reals:
  the subset has to be unsat over the reals, and every proper subset has
  to be satisfiable over the rational numbers.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">minimal_unsat_core_real</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> set <span class="main">⇒</span> <span class="tfree">'i</span> i_constraint list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">minimal_unsat_core_real</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ics</span></span></span>  <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">⊆</span> fst <span class="main">`</span> set <span class="free"><span class="bound"><span class="entity">ics</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>r</sub><span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free"><span class="bound"><span class="entity">ics</span></span></span><span class="main">)</span><span class="main">)</span>
     <span class="main">∧</span> <span class="main">(</span>distinct_indices <span class="free"><span class="bound"><span class="entity">ics</span></span></span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">J</span><span class="main">.</span> <span class="bound">J</span> <span class="main">⊂</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="bound">J</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>s</sub></span> set <span class="free"><span class="bound"><span class="entity">ics</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Because of equi-satisfiability the two notions of minimal unsat cores coincide.›</span></span>
<span class="keyword1" id="Simplex_for_Reals-minimal_unsat_core_real_conv"><span class="command">lemma</span></span> minimal_unsat_core_real_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"minimal_unsat_core_real <span class="free">I</span> <span class="free">ics</span> <span class="main">=</span> minimal_unsat_core <span class="free">I</span> <span class="free">ics</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"minimal_unsat_core_real <span class="free">I</span> <span class="free">ics</span> <span class="main">⟹</span> minimal_unsat_core <span class="free">I</span> <span class="free">ics</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> minimal_unsat_core_real_def minimal_unsat_core_def
    <span class="keyword1"><span class="command">using</span></span> of_rat_val_constraint <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"minimal_unsat_core <span class="free">I</span> <span class="free">ics</span>"</span></span>     
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"minimal_unsat_core_real <span class="free">I</span> <span class="free">ics</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> minimal_unsat_core_real_def minimal_unsat_core_def
    <span class="keyword1"><span class="command">using</span></span> rat_real_conversion<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Simplex.restrict_to <span class="free">I</span> <span class="main">(</span>set <span class="free">ics</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Easy consequence: The incremental simplex algorithm is also sound wrt. 
  minimal-unsat-cores over the reals.›</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> incremental_simplex_real <span class="main">=</span> 
  init_simplex
  assert_simplex_ok
  assert_simplex_unsat<span class="main">[</span><span class="operator">folded</span> minimal_unsat_core_real_conv<span class="main">]</span>
  assert_all_simplex_ok
  assert_all_simplex_unsat<span class="main">[</span><span class="operator">folded</span> minimal_unsat_core_real_conv<span class="main">]</span>
  check_simplex_ok
  check_simplex_unsat<span class="main">[</span><span class="operator">folded</span> minimal_unsat_core_real_conv<span class="main">]</span>
  solution_simplex
  backtrack_simplex
  checked_invariant_simplex

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div>