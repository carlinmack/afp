<div id="Distributed_System">
<div class="head">
<h1>Theory Distributed_System</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Modelling distributed systems›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We assume familiarity with Chandy and Lamport's
paper \emph{Distributed Snapshots: Determining Global States of
Distributed Systems}~\cite{chandy}.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Distributed_System

<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> fifo <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> channel_id <span class="main">=</span> <span class="quoted">nat</span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'m</span> message <span class="main">=</span>
    Marker
  <span class="main">|</span> Msg <span class="tfree"><span class="quoted"><span class="tfree">'m</span></span></span>

<span class="keyword1"><span class="command">datatype</span></span> recording_state <span class="main">=</span>
    NotStarted
  <span class="main">|</span> Recording
  <span class="main">|</span> Done

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We characterize distributed systems by three underlying type variables:
Type variable 'p captures the processes of the underlying system.
Type variable 's describes the possible states of the processes.
Finally, type variable 'm describes all possible messages in said system.

Each process is in exactly one state at any point in time of the system.
Processes are interconnected by directed channels, which hold messages in-flight
between connected processes. There can be an arbitrary number of channels between
different processes. The entire state of the system including the (potentially unfinished)
snapshot state is called \emph{configuration}.›</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'m</span><span class="main">)</span> configuration <span class="main">=</span>
  states <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span>
  msgs <span class="main">::</span> <span class="quoted"><span class="quoted">"channel_id <span class="main">⇒</span> <span class="tfree">'m</span> message fifo"</span></span>

  process_snapshot <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'s</span> option"</span></span>
  channel_snapshot <span class="main">::</span> <span class="quoted"><span class="quoted">"channel_id <span class="main">⇒</span> <span class="tfree">'m</span> fifo <span class="main">*</span> recording_state"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹An event in Chandy and Lamport's formalization describes a
process' state transition, optionally producing or consuming
(but not both) a message on a channel. Additionally, a process may either initiate
a snapshot spontaneously, or is forced to do so by receiving a snapshot \emph{marker}
on one of it's incoming channels.›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'m</span><span class="main">)</span> event <span class="main">=</span>
    <span class="entity">isTrans</span><span class="main">:</span> Trans <span class="main">(</span><span class="free"><span class="entity">occurs_on</span></span><span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'p</span></span></span><span class="main">)</span> <span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span> <span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
  <span class="main">|</span> <span class="entity">isSend</span><span class="main">:</span>  Send  <span class="main">(</span><span class="free"><span class="entity">getId</span></span><span class="main">:</span> <span class="quoted">channel_id</span><span class="main">)</span>
                   <span class="main">(</span>occurs_on<span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'p</span></span></span><span class="main">)</span>
                   <span class="main">(</span><span class="free"><span class="entity">partner</span></span><span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'p</span></span></span><span class="main">)</span>
                   <span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span> <span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span> <span class="main">(</span><span class="free"><span class="entity">getMsg</span></span><span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'m</span></span></span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">isRecv</span><span class="main">:</span>  Recv  <span class="main">(</span>getId<span class="main">:</span> <span class="quoted">channel_id</span><span class="main">)</span>
                   <span class="main">(</span>occurs_on<span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'p</span></span></span><span class="main">)</span>
                   <span class="main">(</span>partner<span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'p</span></span></span><span class="main">)</span>
                   <span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span> <span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span> <span class="main">(</span>getMsg<span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'m</span></span></span><span class="main">)</span>

  <span class="main">|</span> <span class="entity">isSnapshot</span><span class="main">:</span>   Snapshot   <span class="main">(</span>occurs_on<span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'p</span></span></span><span class="main">)</span>
  <span class="main">|</span> <span class="entity">isRecvMarker</span><span class="main">:</span> RecvMarker <span class="main">(</span>getId<span class="main">:</span> <span class="quoted">channel_id</span><span class="main">)</span>
                             <span class="main">(</span>occurs_on<span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'p</span></span></span><span class="main">)</span>
                             <span class="main">(</span>partner<span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'p</span></span></span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We introduce abbreviations and type synoyms for commonly used terms.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'m</span><span class="main">)</span> trace <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'m</span><span class="main">)</span> event list"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ps</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">≡</span> process_snapshot"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">cs</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">cs</span> <span class="main">≡</span> channel_snapshot"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">no_snapshot_change</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">no_snapshot_change</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">p'</span><span class="main">.</span> ps <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p'</span> <span class="main">=</span> ps <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="bound">p'</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i'</span><span class="main">.</span> cs <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">i'</span> <span class="main">=</span> cs <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="bound">i'</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">has_snapshotted</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">has_snapshotted</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> process_snapshot <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≠</span> None"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A regular event is an event as described in Chandy and Lamport's
original paper: A state transition accompanied by the emission
or receiving of a message. Nonregular events are related to
snapshotting and receiving markers along communication channels.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> regular_event<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">regular_event</span> <span class="free"><span class="bound"><span class="entity">ev</span></span></span> <span class="main">≡</span> <span class="main">(</span>isTrans <span class="free"><span class="bound"><span class="entity">ev</span></span></span> <span class="main">∨</span> isSend <span class="free"><span class="bound"><span class="entity">ev</span></span></span> <span class="main">∨</span> isRecv <span class="free"><span class="bound"><span class="entity">ev</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nonregular_event<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">~</span> regular_event <span class="free">ev</span> <span class="main">=</span> <span class="main">(</span>isSnapshot <span class="free">ev</span> <span class="main">∨</span> isRecvMarker <span class="free">ev</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> event.distinct_disc event.exhaust_disc regular_event<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> event_occurs_on_unique<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="free">q</span>"</span></span>
    <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span> <span class="main">≠</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ev</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The distributed system locale›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In order to capture Chandy and Lamport's computation system
we introduce two locales. The distributed system locale describes
global truths, such as the mapping from channel IDs to sender and
receiver processes, the transition relations for the underlying
computation system and the core assumption that no process has
a channel to itself. While not explicitly mentioned in Chandy's
and Lamport's work, it makes sense to assume that a channel need
not communicate to itself via messages, since it shares memory with
itself.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> distributed_system <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">channel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"channel_id <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'p</span> <span class="main">*</span> <span class="tfree">'p</span><span class="main">)</span> option"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">send</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"channel_id <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'m</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">recv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"channel_id <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'p</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'m</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    no_self_channel<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">∄</span><span class="bound">p</span><span class="main">.</span> <span class="free">channel</span> <span class="bound">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹State transitions›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">can_occur</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'m</span><span class="main">)</span> event <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'m</span><span class="main">)</span> configuration <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">can_occur</span> <span class="free"><span class="bound"><span class="entity">ev</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">ev</span></span></span> <span class="keyword1">of</span>
    Trans <span class="bound">p</span> <span class="bound">s</span> <span class="bound">s'</span>        <span class="main">⇒</span> states <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p</span> <span class="main">=</span> <span class="bound">s</span>
                        <span class="main">∧</span> <span class="free">trans</span> <span class="bound">p</span> <span class="bound">s</span> <span class="bound">s'</span>
  <span class="main">|</span> Send <span class="bound">i</span> <span class="bound">p</span> <span class="bound">q</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">msg</span> <span class="main">⇒</span> states <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p</span> <span class="main">=</span> <span class="bound">s</span>
                        <span class="main">∧</span> <span class="free">channel</span> <span class="bound">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span>
                        <span class="main">∧</span> <span class="free">send</span> <span class="bound">i</span> <span class="bound">p</span> <span class="bound">q</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">msg</span>
  <span class="main">|</span> Recv <span class="bound">i</span> <span class="bound">p</span> <span class="bound">q</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">msg</span> <span class="main">⇒</span> states <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p</span> <span class="main">=</span> <span class="bound">s</span>
                        <span class="main">∧</span> <span class="free">channel</span> <span class="bound">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span>
                        <span class="main">∧</span> length <span class="main">(</span>msgs <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>
                        <span class="main">∧</span> hd <span class="main">(</span>msgs <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> Msg <span class="bound">msg</span>
                        <span class="main">∧</span> <span class="free">recv</span> <span class="bound">i</span> <span class="bound">p</span> <span class="bound">q</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">msg</span>
  <span class="main">|</span> Snapshot <span class="bound">p</span>          <span class="main">⇒</span> <span class="main">¬</span> has_snapshotted <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p</span>
  <span class="main">|</span> RecvMarker <span class="bound">i</span> <span class="bound">p</span> <span class="bound">q</span>    <span class="main">⇒</span> <span class="free">channel</span> <span class="bound">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span>
                        <span class="main">∧</span> length <span class="main">(</span>msgs <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>
                        <span class="main">∧</span> hd <span class="main">(</span>msgs <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> Marker<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">src</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">src</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="free">channel</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">dest</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dest</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span><span class="main">.</span> <span class="free">channel</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> can_occur_Recv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"can_occur <span class="main">(</span>Recv <span class="free">i</span> <span class="free">p</span> <span class="free">q</span> <span class="free">s</span> <span class="free">s'</span> <span class="free">m</span><span class="main">)</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"states <span class="free">c</span> <span class="free">p</span> <span class="main">=</span> <span class="free">s</span> <span class="main">∧</span> <span class="free">channel</span> <span class="free">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">q</span><span class="main">,</span> <span class="free">p</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">xs</span><span class="main">.</span> msgs <span class="free">c</span> <span class="free">i</span> <span class="main">=</span> Msg <span class="free">m</span> <span class="main">#</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">∧</span> <span class="free">recv</span> <span class="free">i</span> <span class="free">p</span> <span class="free">q</span> <span class="free">s</span> <span class="free">s'</span> <span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">xs</span><span class="main">.</span> msgs <span class="free">c</span> <span class="free">i</span> <span class="main">=</span> Msg <span class="free">m</span> <span class="main">#</span> <span class="bound">xs</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms can_occur_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> event.case<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> hd_Cons_tl length_greater_0_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms can_occur_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">check_snapshot_occur</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">check_snapshot_occur</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span>
    <span class="main">(</span>can_occur <span class="main">(</span>Snapshot <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">∧</span>
    <span class="main">(</span>ps <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> Some <span class="main">(</span>states <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span>
  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p'</span><span class="main">.</span> states <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p'</span> <span class="main">=</span> states <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="bound">p'</span><span class="main">)</span>
  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p'</span><span class="main">.</span> <span class="main">(</span><span class="bound">p'</span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">⟶</span> ps <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="bound">p'</span> <span class="main">=</span> ps <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p'</span><span class="main">)</span>
  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="free">channel</span> <span class="bound">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> msgs <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="bound">i</span> <span class="main">=</span> msgs <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">i</span> <span class="main">@</span> <span class="main">[</span>Marker<span class="main">]</span><span class="main">)</span>
  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="free">channel</span> <span class="bound">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> channel_snapshot <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="bound">i</span> <span class="main">=</span> <span class="main">(</span>fst <span class="main">(</span>channel_snapshot <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">i</span><span class="main">)</span><span class="main">,</span> Recording<span class="main">)</span><span class="main">)</span>
  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">∄</span><span class="bound">q</span><span class="main">.</span> <span class="free">channel</span> <span class="bound">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> msgs <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="bound">i</span> <span class="main">=</span> msgs <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">i</span><span class="main">)</span>
  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">∄</span><span class="bound">q</span><span class="main">.</span> <span class="free">channel</span> <span class="bound">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> channel_snapshot <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="bound">i</span> <span class="main">=</span> channel_snapshot <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">check_recv_marker_occur</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">check_recv_marker_occur</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">≡</span>
    <span class="main">(</span>can_occur <span class="main">(</span>RecvMarker <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>
  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">r</span><span class="main">.</span> states <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">r</span> <span class="main">=</span> states <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="bound">r</span><span class="main">)</span>
  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">⟶</span> process_snapshot <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">r</span> <span class="main">=</span> process_snapshot <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="bound">r</span><span class="main">)</span>
  <span class="main">∧</span> <span class="main">(</span>Marker <span class="main">#</span> msgs <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> msgs <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>
  <span class="main">∧</span> <span class="main">(</span>channel_snapshot <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">(</span>fst <span class="main">(</span>channel_snapshot <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">,</span> Done<span class="main">)</span><span class="main">)</span>
  <span class="main">∧</span> <span class="main">(</span><span class="keyword1">if</span> has_snapshotted <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>
        <span class="keyword1">then</span> <span class="main">(</span>process_snapshot <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> process_snapshot <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>
           <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i'</span><span class="main">.</span> <span class="main">(</span><span class="bound">i'</span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">⟶</span> msgs <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="bound">i'</span> <span class="main">=</span> msgs <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">i'</span><span class="main">)</span>
           <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i'</span><span class="main">.</span> <span class="main">(</span><span class="bound">i'</span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">⟶</span> channel_snapshot <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">i'</span> <span class="main">=</span> channel_snapshot <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="bound">i'</span><span class="main">)</span>
        <span class="keyword1">else</span> <span class="main">(</span>process_snapshot <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> Some <span class="main">(</span>states <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span>
           <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i'</span><span class="main">.</span> <span class="bound">i'</span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="free">channel</span> <span class="bound">i'</span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>
             <span class="main">⟶</span> msgs <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="bound">i'</span> <span class="main">=</span> msgs <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">i'</span> <span class="main">@</span> <span class="main">[</span>Marker<span class="main">]</span><span class="main">)</span>
           <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i'</span><span class="main">.</span> <span class="bound">i'</span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="free">channel</span> <span class="bound">i'</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span>
             <span class="main">⟶</span> channel_snapshot <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="bound">i'</span> <span class="main">=</span> <span class="main">(</span>fst <span class="main">(</span>channel_snapshot <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">i'</span><span class="main">)</span><span class="main">,</span> Recording<span class="main">)</span><span class="main">)</span>
           <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i'</span><span class="main">.</span> <span class="bound">i'</span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∄</span><span class="bound">r</span><span class="main">.</span> <span class="free">channel</span> <span class="bound">i'</span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>
             <span class="main">⟶</span> msgs <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="bound">i'</span> <span class="main">=</span> msgs <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">i'</span><span class="main">)</span>
           <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i'</span><span class="main">.</span> <span class="bound">i'</span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∄</span><span class="bound">r</span><span class="main">.</span> <span class="free">channel</span> <span class="bound">i'</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span>
             <span class="main">⟶</span> channel_snapshot <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="bound">i'</span> <span class="main">=</span> channel_snapshot <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">i'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">check_trans_occur</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">check_trans_occur</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">≡</span>
    <span class="main">(</span>can_occur <span class="main">(</span>Trans <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>
  <span class="main">∧</span> <span class="main">(</span>states <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span>
  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">⟶</span> states <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="bound">r</span> <span class="main">=</span> states <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">r</span><span class="main">)</span>
  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> msgs <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="bound">i</span> <span class="main">=</span> msgs <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">i</span><span class="main">)</span>
  <span class="main">∧</span> <span class="main">(</span>no_snapshot_change <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">check_send_occur</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">check_send_occur</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">msg</span></span></span> <span class="main">≡</span>
    <span class="main">(</span>can_occur <span class="main">(</span>Send <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">msg</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>
  <span class="main">∧</span> <span class="main">(</span>states <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span>
  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">⟶</span> states <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="bound">r</span> <span class="main">=</span> states <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">r</span><span class="main">)</span>
  <span class="main">∧</span> <span class="main">(</span>msgs <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> msgs <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">@</span> <span class="main">[</span>Msg <span class="free"><span class="bound"><span class="entity">msg</span></span></span><span class="main">]</span><span class="main">)</span>
  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i'</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≠</span> <span class="bound">i'</span> <span class="main">⟶</span> msgs <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="bound">i'</span> <span class="main">=</span> msgs <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">i'</span><span class="main">)</span>
  <span class="main">∧</span> <span class="main">(</span>no_snapshot_change <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">check_recv_occur</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">check_recv_occur</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">msg</span></span></span> <span class="main">≡</span>
    <span class="main">(</span>can_occur <span class="main">(</span>Recv <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">msg</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>
  <span class="main">∧</span> <span class="main">(</span>states <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> states <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span>
  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">⟶</span> states <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="bound">r</span> <span class="main">=</span> states <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">r</span><span class="main">)</span>
  <span class="main">∧</span> <span class="main">(</span>msgs <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> Msg <span class="free"><span class="bound"><span class="entity">msg</span></span></span> <span class="main">#</span> msgs <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>
  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i'</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≠</span> <span class="bound">i'</span> <span class="main">⟶</span> msgs <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="bound">i'</span> <span class="main">=</span> msgs <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">i'</span><span class="main">)</span>
  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">r</span><span class="main">.</span> process_snapshot <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">r</span> <span class="main">=</span> process_snapshot <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="bound">r</span><span class="main">)</span>
  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i'</span><span class="main">.</span> <span class="bound">i'</span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">⟶</span> channel_snapshot <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">i'</span> <span class="main">=</span> channel_snapshot <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="bound">i'</span><span class="main">)</span>
  <span class="main">∧</span> <span class="main">(</span><span class="keyword1">if</span> snd <span class="main">(</span>channel_snapshot <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> Recording
     <span class="keyword1">then</span> channel_snapshot <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">(</span>fst <span class="main">(</span>channel_snapshot <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">msg</span></span></span><span class="main">]</span><span class="main">,</span> Recording<span class="main">)</span>
     <span class="keyword1">else</span> channel_snapshot <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> channel_snapshot <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The \emph{next} predicate lets us express configuration transitions
using events. The predicate $next(s_1, e, s_2)$ denotes the transition
of the configuration $s_1$ to $s_2$ via the event $e$. It ensures that
$e$ can occur in state $s_1$ and the state $s_2$ is correctly constructed
from $s_1$.›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="quoted">"<span class="entity">next</span>"</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'m</span><span class="main">)</span> configuration
  <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'m</span><span class="main">)</span> event
  <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'m</span><span class="main">)</span> configuration
  <span class="main">⇒</span> bool"</span></span>
  <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊢</span> _ <span class="keyword1">↦</span> _"</span> <span class="main">[</span>70<span class="main">,</span> 70<span class="main">,</span> 70<span class="main">]</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
    next_snapshot<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main"><span class="free">⊢</span></span> Snapshot <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main"><span class="free">↦</span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="main">=</span>
      check_snapshot_occur <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>
  <span class="main">|</span> next_recv_marker<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main"><span class="free">⊢</span></span> RecvMarker <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main"><span class="free">↦</span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="main">=</span>
      check_recv_marker_occur <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span>"</span></span>
  <span class="main">|</span> next_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main"><span class="free">⊢</span></span> Trans <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main"><span class="free">↦</span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="main">=</span>
      check_trans_occur <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span>"</span></span>
  <span class="main">|</span> next_send<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main"><span class="free">⊢</span></span> Send <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">msg</span></span></span> <span class="main"><span class="free">↦</span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="main">=</span>
      check_send_occur <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">msg</span></span></span>"</span></span>
  <span class="main">|</span> next_recv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main"><span class="free">⊢</span></span> Recv <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">msg</span></span></span> <span class="main"><span class="free">↦</span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="main">=</span>
      check_recv_occur <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">msg</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Useful lemmas about state transitions›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> state_and_event_determine_next<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">c''</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c'</span> <span class="main">=</span> <span class="free">c''</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ev</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Snapshot <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"states <span class="free">c'</span> <span class="main">=</span> states <span class="free">c''</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">c'</span> <span class="main">=</span> msgs <span class="free">c''</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">c'</span> <span class="skolem">i</span> <span class="main">=</span> msgs <span class="free">c''</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="skolem">i</span> <span class="main">=</span> None"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Snapshot assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="skolem">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> assms Snapshot <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"process_snapshot <span class="free">c'</span> <span class="main">=</span> process_snapshot <span class="free">c''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Snapshot assms next_snapshot ext<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"channel_snapshot <span class="free">c'</span> <span class="main">=</span> channel_snapshot <span class="free">c''</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"channel_snapshot <span class="free">c'</span> <span class="skolem">i</span> <span class="main">=</span> channel_snapshot <span class="free">c''</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="skolem">i</span> <span class="main">=</span> None"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms Snapshot <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="skolem">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> assms Snapshot <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">c'</span> <span class="main">=</span> <span class="free">c''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>RecvMarker <span class="skolem">i</span> <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"states <span class="free">c'</span> <span class="main">=</span> states <span class="free">c''</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">c'</span> <span class="main">=</span> msgs <span class="free">c''</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i'</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">c'</span> <span class="skolem">i'</span> <span class="main">=</span> msgs <span class="free">c''</span> <span class="skolem">i'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">#</span> msgs <span class="free">c'</span> <span class="skolem">i'</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="skolem">i'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms RecvMarker <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Marker <span class="main">#</span> msgs <span class="free">c''</span> <span class="skolem">i'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms RecvMarker <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">=</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="free">c</span> <span class="skolem">p</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms RecvMarker <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≠</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> no_snap<span class="main">:</span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="skolem">i'</span> <span class="main">=</span> None"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms RecvMarker <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≠</span> <span class="skolem">i</span>›</span></span> no_snap <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="skolem">i'</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> assms RecvMarker no_snap <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≠</span> <span class="skolem">i</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp_all</span><span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"process_snapshot <span class="free">c'</span> <span class="main">=</span> process_snapshot <span class="free">c''</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ps <span class="free">c'</span> <span class="skolem">r</span> <span class="main">=</span> ps <span class="free">c''</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms RecvMarker <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> assms RecvMarker <span class="quoted"><span class="quoted">‹<span class="main">~</span> <span class="skolem">r</span> <span class="main">≠</span> <span class="skolem">p</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="free">c</span> <span class="skolem">r</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"channel_snapshot <span class="free">c'</span> <span class="main">=</span> channel_snapshot <span class="free">c''</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i'</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cs <span class="free">c'</span> <span class="skolem">i'</span> <span class="main">=</span> cs <span class="free">c''</span> <span class="skolem">i'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms RecvMarker <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="free">c</span> <span class="skolem">p</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms RecvMarker <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≠</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> no_snap<span class="main">:</span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="skolem">i'</span> <span class="main">=</span> None"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms RecvMarker <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≠</span> <span class="skolem">i</span>›</span></span> no_snap <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="skolem">i'</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> assms RecvMarker no_snap <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≠</span> <span class="skolem">i</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp_all</span><span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">c'</span> <span class="main">=</span> <span class="free">c''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Trans <span class="skolem">p</span> <span class="skolem">s</span> <span class="skolem">s'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"states <span class="free">c'</span> <span class="main">=</span> states <span class="free">c''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> assms next_trans ext<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">c'</span> <span class="main">=</span> msgs <span class="free">c''</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms Trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"process_snapshot <span class="free">c'</span> <span class="main">=</span> process_snapshot <span class="free">c''</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms Trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"channel_snapshot <span class="free">c'</span> <span class="main">=</span> channel_snapshot <span class="free">c''</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms Trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">c'</span> <span class="main">=</span> <span class="free">c''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Send <span class="skolem">i</span> <span class="skolem">p</span> <span class="skolem">s</span> <span class="skolem">s'</span> <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"states <span class="free">c'</span> <span class="main">=</span> states <span class="free">c''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> assms next_send ext<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">c'</span> <span class="main">=</span> msgs <span class="free">c''</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i'</span>
    <span class="keyword1"><span class="command">from</span></span> assms Send <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">c'</span> <span class="skolem">i'</span> <span class="main">=</span> msgs <span class="free">c''</span> <span class="skolem">i'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"process_snapshot <span class="free">c'</span> <span class="main">=</span> process_snapshot <span class="free">c''</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms Send <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"channel_snapshot <span class="free">c'</span> <span class="main">=</span> channel_snapshot <span class="free">c''</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms Send <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">c'</span> <span class="main">=</span> <span class="free">c''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Recv <span class="skolem">i</span> <span class="skolem">p</span> <span class="skolem">s</span> <span class="skolem">s'</span> <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"states <span class="free">c'</span> <span class="main">=</span> states <span class="free">c''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> assms next_recv ext<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">c'</span> <span class="main">=</span> msgs <span class="free">c''</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i'</span>
    <span class="keyword1"><span class="command">from</span></span> assms Recv <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">c'</span> <span class="skolem">i'</span> <span class="main">=</span> msgs <span class="free">c''</span> <span class="skolem">i'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"process_snapshot <span class="free">c'</span> <span class="main">=</span> process_snapshot <span class="free">c''</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms Recv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"channel_snapshot <span class="free">c'</span> <span class="main">=</span> channel_snapshot <span class="free">c''</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i'</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cs <span class="free">c'</span> <span class="skolem">i'</span> <span class="main">=</span> cs <span class="free">c''</span> <span class="skolem">i'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">≠</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms Recv <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> assms Recv <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="free">c</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">=</span> Recording"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">c'</span> <span class="main">=</span> <span class="free">c''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> exists_next_if_can_occur<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"can_occur <span class="free">ev</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c'</span><span class="main">.</span> <span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="bound">c'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ev</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Snapshot <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⦇</span> states <span class="main">=</span> states <span class="free">c</span><span class="main">,</span>
              msgs <span class="main">=</span> <span class="main">%</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="free">channel</span> <span class="bound">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span> msgs <span class="free">c</span> <span class="bound">i</span> <span class="main">@</span> <span class="main">[</span>Marker<span class="main">]</span> <span class="keyword1">else</span> msgs <span class="free">c</span> <span class="bound">i</span><span class="main">,</span>
              process_snapshot <span class="main">=</span> <span class="main">%</span><span class="bound">r</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">r</span> <span class="main">=</span> <span class="skolem">p</span> <span class="keyword1">then</span> Some <span class="main">(</span>states <span class="free">c</span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">else</span> ps <span class="free">c</span> <span class="bound">r</span><span class="main">,</span>
              channel_snapshot <span class="main">=</span> <span class="main">%</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="free">channel</span> <span class="bound">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span>fst <span class="main">(</span>cs <span class="free">c</span> <span class="bound">i</span><span class="main">)</span><span class="main">,</span> Recording<span class="main">)</span> <span class="keyword1">else</span> cs <span class="free">c</span> <span class="bound">i</span> <span class="main">⦈</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="var">?c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Snapshot assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>RecvMarker <span class="skolem">i</span> <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="free">c</span> <span class="skolem">p</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⦇</span> states <span class="main">=</span> states <span class="free">c</span><span class="main">,</span>
                msgs <span class="main">=</span> <span class="main">%</span><span class="bound">i'</span><span class="main">.</span> <span class="keyword1">if</span> <span class="skolem">i</span> <span class="main">=</span> <span class="bound">i'</span> <span class="keyword1">then</span> tl <span class="main">(</span>msgs <span class="free">c</span> <span class="bound">i'</span><span class="main">)</span> <span class="keyword1">else</span> msgs <span class="free">c</span> <span class="bound">i'</span><span class="main">,</span>
                process_snapshot <span class="main">=</span> ps <span class="free">c</span><span class="main">,</span>
                channel_snapshot <span class="main">=</span> <span class="main">%</span><span class="bound">i'</span><span class="main">.</span> <span class="keyword1">if</span> <span class="skolem">i</span> <span class="main">=</span> <span class="bound">i'</span> <span class="keyword1">then</span> <span class="main">(</span>fst <span class="main">(</span>cs <span class="free">c</span> <span class="bound">i'</span><span class="main">)</span><span class="main">,</span> Done<span class="main">)</span> <span class="keyword1">else</span> cs <span class="free">c</span> <span class="bound">i'</span> <span class="main">⦈</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">c</span> <span class="skolem">i</span> <span class="main">=</span> Marker <span class="main">#</span> msgs <span class="var">?c</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms can_occur_def RecvMarker hd_Cons_tl <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="var">?c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True RecvMarker assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⦇</span> states <span class="main">=</span> states <span class="free">c</span><span class="main">,</span>
                msgs <span class="main">=</span> <span class="main">%</span><span class="bound">i'</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i'</span> <span class="main">=</span> <span class="skolem">i</span>
                                  <span class="keyword1">then</span> tl <span class="main">(</span>msgs <span class="free">c</span> <span class="bound">i'</span><span class="main">)</span>
                                  <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="main">(</span><span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="free">channel</span> <span class="bound">i'</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>
                                         <span class="keyword1">then</span> msgs <span class="free">c</span> <span class="bound">i'</span> <span class="main">@</span> <span class="main">[</span>Marker<span class="main">]</span>
                                         <span class="keyword1">else</span> msgs <span class="free">c</span> <span class="bound">i'</span><span class="main">,</span>
                process_snapshot <span class="main">=</span> <span class="main">%</span><span class="bound">r</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">r</span> <span class="main">=</span> <span class="skolem">p</span> <span class="keyword1">then</span> Some <span class="main">(</span>states <span class="free">c</span> <span class="bound">r</span><span class="main">)</span> <span class="keyword1">else</span> ps <span class="free">c</span> <span class="bound">r</span><span class="main">,</span>
                channel_snapshot <span class="main">=</span> <span class="main">%</span><span class="bound">i'</span><span class="main">.</span> <span class="keyword1">if</span> <span class="skolem">i</span> <span class="main">=</span> <span class="bound">i'</span> <span class="keyword1">then</span> <span class="main">(</span>fst <span class="main">(</span>cs <span class="free">c</span> <span class="bound">i'</span><span class="main">)</span><span class="main">,</span> Done<span class="main">)</span>
                                              <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="main">(</span><span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="free">channel</span> <span class="bound">i'</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>
                                                     <span class="keyword1">then</span> <span class="main">(</span>fst <span class="main">(</span>cs <span class="free">c</span> <span class="bound">i'</span><span class="main">)</span><span class="main">,</span> Recording<span class="main">)</span>
                                                     <span class="keyword1">else</span> cs <span class="free">c</span> <span class="bound">i'</span> <span class="main">⦈</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">c</span> <span class="skolem">i</span> <span class="main">=</span> Marker <span class="main">#</span> msgs <span class="var">?c</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms can_occur_def RecvMarker hd_Cons_tl <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ps <span class="var">?c</span> <span class="skolem">p</span> <span class="main">=</span> Some <span class="main">(</span>states <span class="free">c</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="var">?c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> RecvMarker assms False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Trans <span class="skolem">p</span> <span class="skolem">s</span> <span class="skolem">s'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⦇</span> states <span class="main">=</span> <span class="main">%</span><span class="bound">r</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">r</span> <span class="main">=</span> <span class="skolem">p</span> <span class="keyword1">then</span> <span class="skolem">s'</span> <span class="keyword1">else</span> states <span class="free">c</span> <span class="bound">r</span><span class="main">,</span>
              msgs <span class="main">=</span> msgs <span class="free">c</span><span class="main">,</span>
              process_snapshot <span class="main">=</span> ps <span class="free">c</span><span class="main">,</span>
              channel_snapshot <span class="main">=</span> cs <span class="free">c</span> <span class="main">⦈</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="var">?c</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Trans assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Send <span class="skolem">i</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">s</span> <span class="skolem">s'</span> <span class="skolem">msg</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⦇</span> states <span class="main">=</span> <span class="main">%</span><span class="bound">r</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">r</span> <span class="main">=</span> <span class="skolem">p</span> <span class="keyword1">then</span> <span class="skolem">s'</span> <span class="keyword1">else</span> states <span class="free">c</span> <span class="bound">r</span><span class="main">,</span>
              msgs <span class="main">=</span> <span class="main">%</span><span class="bound">i'</span><span class="main">.</span> <span class="keyword1">if</span> <span class="skolem">i</span> <span class="main">=</span> <span class="bound">i'</span> <span class="keyword1">then</span> msgs <span class="free">c</span> <span class="bound">i'</span> <span class="main">@</span> <span class="main">[</span>Msg <span class="skolem">msg</span><span class="main">]</span> <span class="keyword1">else</span> msgs <span class="free">c</span> <span class="bound">i'</span><span class="main">,</span>
              process_snapshot <span class="main">=</span> ps <span class="free">c</span><span class="main">,</span>
              channel_snapshot <span class="main">=</span> cs <span class="free">c</span> <span class="main">⦈</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="var">?c</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Send assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Recv <span class="skolem">i</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">s</span> <span class="skolem">s'</span> <span class="skolem">msg</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="free">c</span> <span class="skolem">i</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Recording
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⦇</span> states <span class="main">=</span> <span class="main">%</span><span class="bound">r</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">r</span> <span class="main">=</span> <span class="skolem">p</span> <span class="keyword1">then</span> <span class="skolem">s'</span> <span class="keyword1">else</span> states <span class="free">c</span> <span class="bound">r</span><span class="main">,</span>
                msgs <span class="main">=</span> <span class="main">%</span><span class="bound">i'</span><span class="main">.</span> <span class="keyword1">if</span> <span class="skolem">i</span> <span class="main">=</span> <span class="bound">i'</span> <span class="keyword1">then</span> tl <span class="main">(</span>msgs <span class="free">c</span> <span class="bound">i'</span><span class="main">)</span> <span class="keyword1">else</span> msgs <span class="free">c</span> <span class="bound">i'</span><span class="main">,</span>
                process_snapshot <span class="main">=</span> ps <span class="free">c</span><span class="main">,</span>
                channel_snapshot <span class="main">=</span> <span class="main">%</span><span class="bound">i'</span><span class="main">.</span> <span class="keyword1">if</span> <span class="skolem">i</span> <span class="main">=</span> <span class="bound">i'</span>
                                              <span class="keyword1">then</span> <span class="main">(</span>fst <span class="main">(</span>cs <span class="free">c</span> <span class="bound">i'</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">msg</span><span class="main">]</span><span class="main">,</span> Recording<span class="main">)</span>
                                              <span class="keyword1">else</span> cs <span class="free">c</span> <span class="bound">i'</span><span class="main">⦈</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="var">?c</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Recv Recording assms can_occur_Recv <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Done
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⦇</span> states <span class="main">=</span> <span class="main">%</span><span class="bound">r</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">r</span> <span class="main">=</span> <span class="skolem">p</span> <span class="keyword1">then</span> <span class="skolem">s'</span> <span class="keyword1">else</span> states <span class="free">c</span> <span class="bound">r</span><span class="main">,</span>
                msgs <span class="main">=</span> <span class="main">%</span><span class="bound">i'</span><span class="main">.</span> <span class="keyword1">if</span> <span class="skolem">i</span> <span class="main">=</span> <span class="bound">i'</span> <span class="keyword1">then</span> tl <span class="main">(</span>msgs <span class="free">c</span> <span class="bound">i'</span><span class="main">)</span> <span class="keyword1">else</span> msgs <span class="free">c</span> <span class="bound">i'</span><span class="main">,</span>
                process_snapshot <span class="main">=</span> ps <span class="free">c</span><span class="main">,</span>
                channel_snapshot <span class="main">=</span> cs <span class="free">c</span> <span class="main">⦈</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="var">?c</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Done Recv assms can_occur_Recv <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> NotStarted
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⦇</span> states <span class="main">=</span> <span class="main">%</span><span class="bound">r</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">r</span> <span class="main">=</span> <span class="skolem">p</span> <span class="keyword1">then</span> <span class="skolem">s'</span> <span class="keyword1">else</span> states <span class="free">c</span> <span class="bound">r</span><span class="main">,</span>
                msgs <span class="main">=</span> <span class="main">%</span><span class="bound">i'</span><span class="main">.</span> <span class="keyword1">if</span> <span class="skolem">i</span> <span class="main">=</span> <span class="bound">i'</span> <span class="keyword1">then</span> tl <span class="main">(</span>msgs <span class="free">c</span> <span class="bound">i'</span><span class="main">)</span> <span class="keyword1">else</span> msgs <span class="free">c</span> <span class="bound">i'</span><span class="main">,</span>
                process_snapshot <span class="main">=</span> ps <span class="free">c</span><span class="main">,</span>
                channel_snapshot <span class="main">=</span> cs <span class="free">c</span> <span class="main">⦈</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="var">?c</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> NotStarted Recv assms can_occur_Recv <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> exists_exactly_one_following_state<span class="main">:</span>
  <span class="quoted"><span class="quoted">"can_occur <span class="free">ev</span> <span class="free">c</span> <span class="main">⟹</span> <span class="main">∃!</span><span class="bound">c'</span><span class="main">.</span> <span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="bound">c'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> exists_next_if_can_occur state_and_event_determine_next <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> no_state_change_if_no_event<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span> <span class="main">≠</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"states <span class="free">c</span> <span class="free">p</span> <span class="main">=</span> states <span class="free">c'</span> <span class="free">p</span> <span class="main">∧</span> process_snapshot <span class="free">c</span> <span class="free">p</span> <span class="main">=</span> process_snapshot <span class="free">c'</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ev</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> no_msgs_change_if_no_channel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">i</span> <span class="main">=</span> None"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"msgs <span class="free">c</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c'</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ev</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>RecvMarker <span class="skolem">cid</span> <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cid</span> <span class="main">≠</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms RecvMarker can_occur_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">with</span></span> assms RecvMarker <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="free">c</span> <span class="skolem">p</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Send <span class="skolem">cid</span> <span class="skolem">p</span> <span class="skolem">s</span> <span class="skolem">s'</span> <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cid</span> <span class="main">≠</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms Send can_occur_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms Send <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Recv <span class="skolem">cid</span> <span class="skolem">p</span> <span class="skolem">s</span> <span class="skolem">s'</span> <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cid</span> <span class="main">≠</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms Recv can_occur_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms Recv <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> no_cs_change_if_no_channel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">i</span> <span class="main">=</span> None"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"cs <span class="free">c</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">c'</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ev</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>RecvMarker <span class="skolem">cid</span> <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cid</span> <span class="main">≠</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms RecvMarker can_occur_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">with</span></span> assms RecvMarker <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="free">c</span> <span class="skolem">p</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Send <span class="skolem">cid</span> <span class="skolem">p</span> <span class="skolem">s</span> <span class="skolem">s'</span> <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cid</span> <span class="main">≠</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms Send can_occur_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms Send <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Recv <span class="skolem">cid</span> <span class="skolem">p</span> <span class="skolem">s</span> <span class="skolem">s'</span> <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cid</span> <span class="main">≠</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms Recv can_occur_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms Recv <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> no_msg_change_if_no_event<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isSend <span class="free">ev</span> <span class="main">⟶</span> getId <span class="free">ev</span> <span class="main">≠</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isRecv <span class="free">ev</span> <span class="main">⟶</span> getId <span class="free">ev</span> <span class="main">≠</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"regular_event <span class="free">ev</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"msgs <span class="free">c</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c'</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">i</span> <span class="main">=</span> None"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms no_msgs_change_if_no_channel <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"isTrans <span class="free">ev</span> <span class="main">∨</span> isSend <span class="free">ev</span> <span class="main">∨</span> isRecv <span class="free">ev</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"isTrans <span class="free">ev</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> event.collapse<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> next_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"isSend <span class="free">ev</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> Send<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> Send <span class="skolem">i'</span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> isSend_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Send assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"isRecv <span class="free">ev</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> Recv <span class="skolem">i'</span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> isRecv_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> no_cs_change_if_no_event<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isRecv <span class="free">ev</span> <span class="main">⟶</span> getId <span class="free">ev</span> <span class="main">≠</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"regular_event <span class="free">ev</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"cs <span class="free">c</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">c'</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"isTrans <span class="free">ev</span> <span class="main">∨</span> isSend <span class="free">ev</span> <span class="main">∨</span> isRecv <span class="free">ev</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"isTrans <span class="free">ev</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> event.collapse<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> next_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"isSend <span class="free">ev</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> Send <span class="skolem">i'</span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> isSend_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"isRecv <span class="free">ev</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> Recv <span class="skolem">i</span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> isRecv_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> happen_implies_can_occur<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">c'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"can_occur <span class="free">ev</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ev</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> snapshot_increases_message_length<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> Snapshot <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">q</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"length <span class="main">(</span>msgs <span class="free">c</span> <span class="free">i</span><span class="main">)</span> <span class="main">≤</span> length <span class="main">(</span>msgs <span class="free">c'</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="free">q</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> recv_marker_changes_head_only_at_i<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> RecvMarker <span class="free">i</span> <span class="free">p</span> <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">i'</span> <span class="main">≠</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"msgs <span class="free">c</span> <span class="free">i'</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> hd <span class="main">(</span>msgs <span class="free">c</span> <span class="free">i'</span><span class="main">)</span> <span class="main">=</span> hd <span class="main">(</span>msgs <span class="free">c'</span> <span class="free">i'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">i'</span> <span class="main">=</span> None"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms no_msgs_change_if_no_channel <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"msgs <span class="free">c</span> <span class="free">i'</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">m</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">i'</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="free">c</span> <span class="free">p</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="free">p</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> recv_marker_other_channels_not_shrinking<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> RecvMarker <span class="free">i</span> <span class="free">p</span> <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">c'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"length <span class="main">(</span>msgs <span class="free">c</span> <span class="free">i'</span><span class="main">)</span> <span class="main">≤</span> length <span class="main">(</span>msgs <span class="free">c'</span> <span class="free">i'</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">i</span> <span class="main">≠</span> <span class="free">i'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>msgs <span class="free">c</span> <span class="free">i'</span><span class="main">)</span> <span class="main">≤</span> length <span class="main">(</span>msgs <span class="free">c'</span> <span class="free">i'</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≠</span> <span class="free">i'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="free">i</span> <span class="main">≠</span> <span class="free">i'</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>msgs <span class="free">c</span> <span class="free">i'</span><span class="main">)</span> <span class="main">≤</span> length <span class="main">(</span>msgs <span class="free">c'</span> <span class="free">i'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">c</span> <span class="free">i</span> <span class="main">=</span> Marker <span class="main">#</span> msgs <span class="free">c'</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>msgs <span class="free">c</span> <span class="free">i</span><span class="main">)</span> <span class="main">&gt;</span> length <span class="main">(</span>msgs <span class="free">c'</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>msgs <span class="free">c</span> <span class="free">i'</span><span class="main">)</span> <span class="main">&gt;</span> length <span class="main">(</span>msgs <span class="free">c'</span> <span class="free">i'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> asm <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> asm <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="free">i'</span> <span class="main">⟹</span> length <span class="main">(</span>msgs <span class="free">c</span> <span class="free">i'</span><span class="main">)</span> <span class="main">≤</span> length <span class="main">(</span>msgs <span class="free">c'</span> <span class="free">i'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="free">i'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">i'</span> <span class="main">=</span> None"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms no_msgs_change_if_no_channel <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> chan<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">i'</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="free">c</span> <span class="free">p</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">with</span></span> assms <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≠</span> <span class="free">i'</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> no_snap<span class="main">:</span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="skolem">r</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">c'</span> <span class="free">i'</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i'</span> <span class="main">@</span> <span class="main">[</span>Marker<span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≠</span> <span class="free">i'</span>›</span></span> assms no_snap chan <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≠</span> <span class="free">i'</span>›</span></span> chan no_snap <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> regular_event_cannot_induce_snapshot<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="free">c</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">c'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"regular_event <span class="free">ev</span> <span class="main">⟶</span> <span class="main">~</span> has_snapshotted <span class="free">c'</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ev</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Trans <span class="skolem">q</span> <span class="skolem">s</span> <span class="skolem">s'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Send <span class="skolem">q</span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">s'</span> <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Recv <span class="skolem">q</span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">s'</span> <span class="skolem">m</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> regular_event_preserves_process_snapshots<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">c'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"regular_event <span class="free">ev</span> <span class="main">⟹</span> ps <span class="free">c</span> <span class="free">r</span> <span class="main">=</span> ps <span class="free">c'</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ev</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Trans <span class="skolem">p</span> <span class="skolem">s</span> <span class="skolem">s'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Send <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">s</span> <span class="skolem">s'</span> <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Recv <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">s</span> <span class="skolem">s'</span> <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> no_state_change_if_nonregular_event<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">~</span> regular_event <span class="free">ev</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">c'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"states <span class="free">c</span> <span class="free">p</span> <span class="main">=</span> states <span class="free">c'</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"isSnapshot <span class="free">ev</span> <span class="main">∨</span> isRecvMarker <span class="free">ev</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nonregular_event assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> Snapshot <span class="skolem">q</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> isSnapshot_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> RecvMarker <span class="skolem">i</span> <span class="skolem">q</span> <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> isRecvMarker_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nonregular_event_induces_snapshot<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="free">c</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span> <span class="main">=</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">~</span> regular_event <span class="free">ev</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">~</span> regular_event <span class="free">ev</span> <span class="main">⟶</span> has_snapshotted <span class="free">c'</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ev</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Snapshot <span class="skolem">q</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Snapshot assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>RecvMarker <span class="skolem">i</span> <span class="skolem">q</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> RecvMarker assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> snapshot_state_unchanged<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"has_snapshotted <span class="free">c</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"ps <span class="free">c</span> <span class="free">p</span> <span class="main">=</span> ps <span class="free">c'</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span> <span class="main">=</span> <span class="free">p</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> local.step no_state_change_if_no_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"regular_event <span class="free">ev</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> local.step regular_event_preserves_process_snapshots <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"isRecvMarker <span class="free">ev</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"isSnapshot <span class="free">ev</span> <span class="main">∨</span> isRecvMarker <span class="free">ev</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> False nonregular_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> isRecvMarker <span class="free">ev</span>"</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"isSnapshot <span class="free">ev</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> Snapshot <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> True event.collapse<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"can_occur <span class="free">ev</span> <span class="free">c</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> happen_implies_can_occur local.step <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="free">c</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> can_occur_def 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ev</span> <span class="main">=</span> Snapshot <span class="free">p</span>›</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="comment1">(* z3 sledgehammer fails for Isabelle2019 *)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span> <span class="bound">pa</span><span class="main">.</span> <span class="free">c</span> <span class="main">⊢</span> RecvMarker <span class="bound">n</span> <span class="free">p</span> <span class="bound">pa</span> <span class="main">↦</span> <span class="free">c'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> True <span class="quoted"><span class="quoted">‹isRecvMarker <span class="free">ev</span>›</span></span> event.collapse<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> local.step<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> message_must_be_delivered<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    valid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    delivered<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>msgs <span class="free">c</span> <span class="free">i</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> hd <span class="main">(</span>msgs <span class="free">c</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>msgs <span class="free">c'</span> <span class="free">i</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> hd <span class="main">(</span>msgs <span class="free">c'</span> <span class="free">i</span><span class="main">)</span> <span class="main">≠</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span>         <span class="free">ev</span> <span class="main">=</span> RecvMarker <span class="free">i</span> <span class="bound">p</span> <span class="bound">q</span>   <span class="main">∧</span> <span class="free">m</span> <span class="main">=</span> Marker<span class="main">)</span>
   <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">m'</span><span class="main">.</span> <span class="free">ev</span> <span class="main">=</span> Recv <span class="free">i</span> <span class="bound">p</span> <span class="bound">q</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">m'</span> <span class="main">∧</span> <span class="free">m</span> <span class="main">=</span> Msg <span class="bound">m'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ev</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Snapshot <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"msgs <span class="free">c</span> <span class="free">i</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> delivered <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">m</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> assms Snapshot <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">i</span> <span class="main">=</span> None"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms Snapshot <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> chan<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">c'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span> <span class="main">@</span> <span class="main">[</span>Marker<span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> Snapshot chan <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> delivered <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">c'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms Snapshot chan <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> delivered Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>RecvMarker <span class="skolem">i'</span> <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">=</span> <span class="free">i</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> delivered le_0_eq length_greater_0_conv list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> recv_marker_changes_head_only_at_i recv_marker_other_channels_not_shrinking<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">=</span> <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">=</span> <span class="free">i</span>›</span></span> RecvMarker assms<span class="main">(</span>1<span class="main">)</span> can_occur_def delivered <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">q</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> RecvMarker assms<span class="main">(</span>1<span class="main">)</span> calculation<span class="main">(</span>1<span class="main">)</span> can_occur_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> RecvMarker <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Trans <span class="skolem">p'</span> <span class="skolem">s</span> <span class="skolem">s'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> valid delivered <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Send <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="skolem">s</span> <span class="skolem">s'</span> <span class="skolem">m'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> delivered distributed_system.next.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> distributed_system_axioms hd_append2 snoc_eq_iff_butlast valid<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Recv <span class="skolem">i'</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">s</span> <span class="skolem">s'</span> <span class="skolem">m'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> delivered <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> Msg <span class="skolem">m'</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Recv delivered list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> next_recv valid<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Recv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> message_must_be_delivered_2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">c'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">:</span> set <span class="main">(</span>msgs <span class="free">c</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">∉</span> set <span class="main">(</span>msgs <span class="free">c'</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="free">ev</span> <span class="main">=</span> RecvMarker <span class="free">i</span> <span class="bound">p</span> <span class="bound">q</span> <span class="main">∧</span> <span class="free">m</span> <span class="main">=</span> Marker<span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">m'</span><span class="main">.</span> <span class="free">ev</span> <span class="main">=</span> Recv <span class="free">i</span> <span class="bound">p</span> <span class="bound">q</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">m'</span> <span class="main">∧</span> <span class="free">m</span> <span class="main">=</span> Msg <span class="bound">m'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> uneq_sets<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>msgs <span class="free">c</span> <span class="free">i</span><span class="main">)</span> <span class="main">≠</span> set <span class="main">(</span>msgs <span class="free">c'</span> <span class="free">i</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> chan<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms no_msgs_change_if_no_channel <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ev</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Snapshot <span class="skolem">p'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Snapshot assms chan <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>msgs <span class="free">c'</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>msgs <span class="free">c</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> uneq_sets <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Trans <span class="skolem">p'</span> <span class="skolem">s</span> <span class="skolem">s'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> uneq_sets assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Send <span class="skolem">i'</span> <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="skolem">s</span> <span class="skolem">s'</span> <span class="skolem">m</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> UnCI assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> local.next.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> set_append<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>RecvMarker <span class="skolem">i'</span> <span class="skolem">p'</span> <span class="skolem">q'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="skolem">i'</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms chan RecvMarker
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="free">c</span> <span class="skolem">p'</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms chan RecvMarker <span class="quoted"><span class="quoted">‹<span class="main">~</span> <span class="skolem">i'</span> <span class="main">=</span> <span class="free">i</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms chan RecvMarker <span class="quoted"><span class="quoted">‹<span class="main">~</span> <span class="skolem">i'</span> <span class="main">=</span> <span class="free">i</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> Marker"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">c</span> <span class="skolem">i'</span> <span class="main">=</span> Marker <span class="main">#</span> msgs <span class="free">c'</span> <span class="skolem">i'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms chan RecvMarker <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">=</span> <span class="free">i</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> RecvMarker <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Recv <span class="skolem">i'</span> <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="skolem">s</span> <span class="skolem">s'</span> <span class="skolem">m'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="skolem">i'</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> 
        <span class="keyword1"><span class="command">using</span></span> Recv assms<span class="main">(</span>1<span class="main">)</span> uneq_sets <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">=</span> <span class="free">i</span> <span class="main">∧</span> <span class="free">m</span> <span class="main">=</span> Msg <span class="skolem">m'</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Recv assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Recv <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> recv_marker_means_snapshotted_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> RecvMarker <span class="free">i</span> <span class="free">p</span> <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">c'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"has_snapshotted <span class="free">c'</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms snapshot_state_unchanged <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="free">c</span> <span class="free">p</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> recv_marker_means_snapshotted_2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">c</span> <span class="free">c'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'m</span><span class="main">)</span> configuration"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">ev</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'m</span><span class="main">)</span> event"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">i</span> <span class="main">::</span> <span class="quoted">channel_id</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"Marker <span class="main">:</span> set <span class="main">(</span>msgs <span class="free">c</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="free">c'</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">q</span><span class="main">,</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"has_snapshotted <span class="free">c'</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="free">ev</span> <span class="main">=</span> RecvMarker <span class="free">i</span> <span class="bound">p</span> <span class="bound">q</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms message_must_be_delivered_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> RecvMarker<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> RecvMarker <span class="free">i</span> <span class="skolem">r</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> can_occur_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> recv_marker_means_snapshotted_1 assms RecvMarker <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> event_stays_valid_if_no_occurrence<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span> <span class="main">≠</span> occurs_on <span class="free">ev'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"can_occur <span class="free">ev'</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"can_occur <span class="free">ev'</span> <span class="free">c'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ev'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Trans <span class="skolem">p</span> <span class="skolem">s</span> <span class="skolem">s'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"states <span class="free">c</span> <span class="skolem">p</span> <span class="main">=</span> states <span class="free">c'</span> <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Trans assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> no_state_change_if_no_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"states <span class="free">c</span> <span class="skolem">p</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> can_occur_def assms Trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"states <span class="free">c'</span> <span class="skolem">p</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">trans</span> <span class="skolem">p</span> <span class="skolem">s</span> <span class="skolem">s'</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Trans assms<span class="main">(</span>3<span class="main">)</span> can_occur_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Trans can_occur_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Recv <span class="skolem">i</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">s</span> <span class="skolem">s'</span> <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span>msgs <span class="free">c</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> Msg <span class="skolem">m</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> Recv <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>msgs <span class="free">c</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> can_occur_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> mcqp<span class="main">:</span> <span class="quoted"><span class="quoted">"msgs <span class="free">c</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">m'</span> <span class="main">#</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> nat_less_le neq_Nil_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Msg <span class="skolem">m</span> <span class="main">=</span> <span class="skolem">m'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">m'</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Marker
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">c</span> <span class="skolem">i</span> <span class="main">=</span> Marker <span class="main">#</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>mcqp<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> can_occur <span class="free">ev'</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Recv can_occur_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Msg <span class="skolem">msg</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">c</span> <span class="skolem">i</span> <span class="main">=</span> Msg <span class="skolem">msg</span> <span class="main">#</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mcqp<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> <span class="skolem">msg</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Recv can_occur_def assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mcqp<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> can_occur <span class="free">ev'</span> <span class="free">c'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">c'</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> hd <span class="main">(</span>msgs <span class="free">c'</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≠</span> Msg <span class="skolem">m</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Recv assms can_occur_def no_state_change_if_no_event distributed_system_axioms list.case_eq_if <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="skolem"><span class="skolem">p'</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="skolem"><span class="skolem">s''</span></span> <span class="skolem"><span class="skolem">s'''</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="keyword2"><span class="keyword">where</span></span> RMoR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> RecvMarker <span class="skolem">i'</span> <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="main">∨</span> <span class="free">ev</span> <span class="main">=</span> Recv <span class="skolem">i</span> <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="skolem">s''</span> <span class="skolem">s'''</span> <span class="skolem">m'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Recv <span class="quoted"><span class="quoted">‹hd <span class="main">(</span>msgs <span class="free">c</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> Msg <span class="skolem">m</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> can_occur_Recv list.discI message_must_be_delivered<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"states <span class="free">c</span> <span class="skolem">p</span> <span class="main">=</span> <span class="skolem">s</span> <span class="main">∧</span> <span class="free">channel</span> <span class="skolem">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">q</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">∧</span> <span class="free">recv</span> <span class="skolem">i</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">s</span> <span class="skolem">s'</span> <span class="skolem">m</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> length <span class="main">(</span>msgs <span class="free">c</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∧</span> hd <span class="main">(</span>msgs <span class="free">c</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> Msg <span class="skolem">m</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Recv assms<span class="main">(</span>3<span class="main">)</span> can_occur_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"RecvMarker <span class="skolem">i'</span> <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="main">=</span> <span class="free">ev</span> <span class="main">∨</span> states <span class="free">c</span> <span class="skolem">p'</span> <span class="main">=</span> <span class="skolem">s''</span> <span class="main">∧</span> <span class="free">channel</span> <span class="skolem">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">q'</span><span class="main">,</span> <span class="skolem">p'</span><span class="main">)</span> <span class="main">∧</span> <span class="free">recv</span> <span class="skolem">i</span> <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="skolem">s''</span> <span class="skolem">s'''</span> <span class="skolem">m'</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> length <span class="main">(</span>msgs <span class="free">c</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∧</span> hd <span class="main">(</span>msgs <span class="free">c</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> Msg <span class="skolem">m'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> RMoR assms<span class="main">(</span>1<span class="main">)</span> can_occur_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">e</span> <span class="bound">n</span> <span class="bound">c</span><span class="main">.</span> <span class="main">∃</span><span class="bound">p</span> <span class="bound">pa</span> <span class="bound">s</span> <span class="bound">sa</span> <span class="bound">m</span><span class="main">.</span> <span class="main">∀</span><span class="bound">ca</span> <span class="bound">cb</span><span class="main">.</span> <span class="main">(</span><span class="main">¬</span> <span class="bound">c</span> <span class="main">⊢</span> <span class="bound">e</span> <span class="main">↦</span> <span class="bound">ca</span> <span class="main">∨</span> msgs <span class="bound">ca</span> <span class="bound">n</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∨</span> hd <span class="main">(</span>msgs <span class="bound">c</span> <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> Marker <span class="main">∨</span> msgs <span class="bound">c</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> Recv <span class="bound">n</span> <span class="bound">p</span> <span class="bound">pa</span> <span class="bound">s</span> <span class="bound">sa</span> <span class="bound">m</span> <span class="main">=</span> <span class="bound">e</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">¬</span> <span class="bound">c</span> <span class="main">⊢</span> <span class="bound">e</span> <span class="main">↦</span> <span class="bound">cb</span> <span class="main">∨</span> hd <span class="main">(</span>msgs <span class="bound">c</span> <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> Marker <span class="main">∨</span> hd <span class="main">(</span>msgs <span class="bound">cb</span> <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> hd <span class="main">(</span>msgs <span class="bound">c</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∨</span> msgs <span class="bound">c</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> Recv <span class="bound">n</span> <span class="bound">p</span> <span class="bound">pa</span> <span class="bound">s</span> <span class="bound">sa</span> <span class="bound">m</span> <span class="main">=</span> <span class="bound">e</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> message_must_be_delivered<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> f2 f1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> RMoR <span class="quoted"><span class="quoted">‹msgs <span class="free">c'</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> hd <span class="main">(</span>msgs <span class="free">c'</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≠</span> Msg <span class="skolem">m</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> event.disc<span class="main"><span class="main">(</span></span>13<span class="main"><span class="main">,</span></span>15<span class="main"><span class="main">)</span></span> event.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>5<span class="main"><span class="main">)</span></span> length_greater_0_conv message.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> option.inject prod.inject<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms Recv <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Send <span class="skolem">i</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">s</span> <span class="skolem">s'</span> <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"states <span class="free">c</span> <span class="skolem">p</span> <span class="main">=</span> states <span class="free">c'</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms no_state_change_if_no_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"can_occur <span class="free">ev'</span> <span class="free">c'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms assms<span class="main">(</span>3<span class="main">)</span> can_occur_def Send <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>RecvMarker <span class="skolem">i</span> <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> msgs_ci<span class="main">:</span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span>msgs <span class="free">c</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> Marker <span class="main">∧</span> length <span class="main">(</span>msgs <span class="free">c</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> RecvMarker <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>msgs <span class="free">c</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> can_occur_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> mci<span class="main">:</span> <span class="quoted"><span class="quoted">"msgs <span class="free">c</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">m'</span> <span class="main">#</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> nat_less_le neq_Nil_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> m_mark<span class="main">:</span> <span class="quoted"><span class="quoted">"Marker <span class="main">=</span> <span class="skolem">m'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">m'</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Msg <span class="skolem">msg</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">c</span> <span class="skolem">i</span> <span class="main">=</span> Msg <span class="skolem">msg</span> <span class="main">#</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>mci<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> can_occur <span class="free">ev'</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> RecvMarker can_occur_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mci<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> can_occur <span class="free">ev'</span> <span class="free">c'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">c'</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> hd <span class="main">(</span>msgs <span class="free">c'</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≠</span> Marker"</span></span>
      <span class="keyword1"><span class="command">using</span></span> RecvMarker assms<span class="main">(</span>3<span class="main">)</span> can_occur_def list.case_eq_if <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="free">ev</span> <span class="main">=</span> RecvMarker <span class="skolem">i</span> <span class="bound">p</span> <span class="bound">q</span> <span class="main">∧</span> Marker <span class="main">=</span> Marker"</span></span> <span class="keyword1"><span class="command">using</span></span> message_must_be_delivered msgs_ci assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> RecvMarker_ev<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> RecvMarker <span class="skolem">i</span> <span class="skolem">r</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="skolem">r</span> <span class="main">∧</span> <span class="skolem">q</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> RecvMarker assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> can_occur_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms RecvMarker_ev <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">using</span></span> RecvMarker <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Snapshot <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="free">c</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms assms<span class="main">(</span>3<span class="main">)</span> can_occur_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> can_occur <span class="free">ev'</span> <span class="free">c'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="free">c'</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> can_occur_def Snapshot <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> has_snapshotted <span class="free">c</span> <span class="skolem">p</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> no_state_change_if_no_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> Snapshot <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> msgs_unchanged_for_other_is<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"regular_event <span class="free">ev</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"getId <span class="free">ev</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">i'</span> <span class="main">≠</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"msgs <span class="free">c</span> <span class="free">i'</span> <span class="main">=</span> msgs <span class="free">c'</span> <span class="free">i'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"isTrans <span class="free">ev</span> <span class="main">∨</span> isSend <span class="free">ev</span> <span class="main">∨</span> isRecv <span class="free">ev</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> Trans <span class="skolem">p</span> <span class="skolem">s</span> <span class="skolem">s'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> isTrans_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> Send <span class="skolem">i'</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">s</span> <span class="skolem">s'</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> isSend_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 3
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> Recv <span class="skolem">i'</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">s</span> <span class="skolem">s'</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> isRecv_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> msgs_unchanged_if_snapshotted_RecvMarker_for_other_is<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> RecvMarker <span class="free">i</span> <span class="free">p</span> <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"has_snapshotted <span class="free">c</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">i'</span> <span class="main">≠</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"msgs <span class="free">c</span> <span class="free">i'</span> <span class="main">=</span> msgs <span class="free">c'</span> <span class="free">i'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> event_can_go_back_if_no_sender<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span> <span class="main">≠</span> occurs_on <span class="free">ev'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"can_occur <span class="free">ev'</span> <span class="free">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">~</span> isRecvMarker <span class="free">ev'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">~</span> isSend <span class="free">ev</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"can_occur <span class="free">ev'</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ev'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Snapshot <span class="skolem">p</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="free">c'</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> can_occur_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="free">c</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> snapshot_state_unchanged <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> can_occur_def Snapshot <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>RecvMarker <span class="skolem">i</span> <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Trans <span class="skolem">p</span> <span class="skolem">s</span> <span class="skolem">s'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> can_occur_def no_state_change_if_no_event assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Send <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">s</span> <span class="skolem">s'</span> <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> can_occur_def no_state_change_if_no_event assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Recv <span class="skolem">i</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">s</span> <span class="skolem">s'</span> <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">c'</span> <span class="skolem">i</span> <span class="main">≠</span> Nil"</span></span> <span class="keyword1"><span class="command">using</span></span> Recv can_occur_def assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span>msgs <span class="free">c'</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> Msg <span class="skolem">m</span> <span class="main">∧</span> length <span class="main">(</span>msgs <span class="free">c'</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> Recv <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>msgs <span class="free">c'</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> can_occur_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> mcqp<span class="main">:</span> <span class="quoted"><span class="quoted">"msgs <span class="free">c'</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">m'</span> <span class="main">#</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> nat_less_le neq_Nil_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Msg <span class="skolem">m</span> <span class="main">=</span> <span class="skolem">m'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">m'</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Marker
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">c'</span> <span class="skolem">i</span> <span class="main">=</span> Marker <span class="main">#</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>mcqp<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> can_occur <span class="free">ev'</span> <span class="free">c'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Recv can_occur_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Msg <span class="skolem">msg</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">c'</span> <span class="skolem">i</span> <span class="main">=</span> Msg <span class="skolem">msg</span> <span class="main">#</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mcqp<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> <span class="skolem">msg</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Recv can_occur_def assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mcqp<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">c</span> <span class="skolem">i</span> <span class="main">≠</span> Nil <span class="main">∧</span> hd <span class="main">(</span>msgs <span class="free">c'</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> hd <span class="main">(</span>msgs <span class="free">c</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ev</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Snapshot <span class="skolem">p'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms Recv <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> chan<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="skolem">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">q</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Recv assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> distributed_system.can_occur_Recv distributed_system_axioms<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Snapshot assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>msgs <span class="free">c</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> hd <span class="main">(</span>msgs <span class="free">c</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> hd <span class="main">(</span>msgs <span class="free">c'</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> <span class="skolem">p'</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">c'</span> <span class="skolem">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="skolem">i</span> <span class="main">@</span> <span class="main">[</span>Marker<span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Snapshot chan assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_self_conv2 calculation<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> hd_append2 length_greater_0_conv list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> message.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">c'</span> <span class="skolem">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Snapshot chan assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> calculation <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>RecvMarker <span class="skolem">i'</span> <span class="skolem">p'</span> <span class="skolem">q'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">≠</span> <span class="skolem">i</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Recv assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> can_occur_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="free">c</span> <span class="skolem">p'</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">c</span> <span class="skolem">i</span> <span class="main">=</span> msgs <span class="free">c'</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≠</span> <span class="skolem">i</span>›</span></span> RecvMarker assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> calculation <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> no_snap<span class="main">:</span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> chan<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="skolem">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">q</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Recv assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> distributed_system.can_occur_Recv distributed_system_axioms<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> <span class="skolem">p'</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">c'</span> <span class="skolem">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="skolem">i</span> <span class="main">@</span> <span class="main">[</span>Marker<span class="main">]</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> no_snap RecvMarker <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≠</span> <span class="skolem">i</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> chan <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_self_conv2 calculation<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> hd_append2 list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> message.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">c'</span> <span class="skolem">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> RecvMarker no_snap False chan assms <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≠</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> calculation <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Trans <span class="skolem">p'</span> <span class="skolem">s''</span> <span class="skolem">s'''</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹msgs <span class="free">c'</span> <span class="skolem">i</span> <span class="main">≠</span> Nil›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Send <span class="skolem">i'</span> <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="skolem">s''</span> <span class="skolem">s'''</span> <span class="skolem">m''</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Recv Send assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> Recv Send assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>5<span class="main">)</span> calculation<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Recv <span class="skolem">i'</span> <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="skolem">s''</span> <span class="skolem">s'''</span> <span class="skolem">m''</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">≠</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹<span class="free">ev'</span> <span class="main">=</span> Recv <span class="skolem">i</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">s</span> <span class="skolem">s'</span> <span class="skolem">m</span>›</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> distributed_system.can_occur_Recv distributed_system_axioms event.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> next_recv option.inject prod.inject<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">c</span> <span class="skolem">i</span> <span class="main">=</span> msgs <span class="free">c'</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> msgs_unchanged_for_other_is Recv <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≠</span> <span class="skolem">i</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹msgs <span class="free">c'</span> <span class="skolem">i</span> <span class="main">≠</span> Nil›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"states <span class="free">c</span> <span class="skolem">p</span> <span class="main">=</span> states <span class="free">c'</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> no_state_change_if_no_event assms Recv <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Recv assms<span class="main">(</span>3<span class="main">)</span> can_occur_def list.case_eq_if <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nonregular_event_can_go_back_if_in_distinct_processes<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"regular_event <span class="free">ev</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">~</span> regular_event <span class="free">ev'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"can_occur <span class="free">ev'</span> <span class="free">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span> <span class="main">≠</span> occurs_on <span class="free">ev'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"can_occur <span class="free">ev'</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev'</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"isTrans <span class="free">ev</span> <span class="main">∨</span> isSend <span class="free">ev</span> <span class="main">∨</span> isRecv <span class="free">ev</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"isSnapshot <span class="free">ev'</span> <span class="main">∨</span> isRecvMarker <span class="free">ev'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms nonregular_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> assms<span class="main">(</span>5<span class="main">)</span> event_can_go_back_if_no_sender <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span> Trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> Trans <span class="var">?p</span> <span class="skolem">s</span> <span class="skolem">s'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> event.collapse<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> RecvMarker<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev'</span> <span class="main">=</span> RecvMarker <span class="skolem">i</span> <span class="var">?q</span> <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> event.collapse<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">c</span> <span class="skolem">i</span> <span class="main">=</span> msgs <span class="free">c'</span> <span class="skolem">i</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2"</span><span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> no_msg_change_if_no_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"can_occur <span class="free">ev'</span> <span class="free">c'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> can_occur_def RecvMarker 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted">"2"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> event.case_eq_if event.distinct_disc<span class="main"><span class="main">(</span></span>13<span class="main"><span class="main">)</span></span> event.distinct_disc<span class="main"><span class="main">(</span></span>17<span class="main"><span class="main">)</span></span> event.distinct_disc<span class="main"><span class="main">(</span></span>19<span class="main"><span class="main">)</span></span> event.distinct_disc<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> event.sel<span class="main"><span class="main">(</span></span>10<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 3
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ev'</span> <span class="main">=</span> Snapshot <span class="var">?q</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> event.collapse<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="free">c'</span> <span class="var">?q</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted">"3"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> can_occur_def event.case_eq_if event.distinct_disc<span class="main"><span class="main">(</span></span>11<span class="main"><span class="main">)</span></span> event.distinct_disc<span class="main"><span class="main">(</span></span>16<span class="main"><span class="main">)</span></span> event.distinct_disc<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="free">c</span> <span class="var">?q</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> regular_event_preserves_process_snapshots <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> can_occur_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ev'</span> <span class="main">=</span> Snapshot <span class="var">?q</span>›</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> event.simps<span class="main"><span class="main">(</span></span>29<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 4
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ev'</span> <span class="main">=</span> Snapshot <span class="var">?q</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> event.collapse<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="free">c'</span> <span class="var">?q</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ev'</span> <span class="main">=</span> Snapshot <span class="main">(</span>occurs_on <span class="free">ev'</span><span class="main">)</span>›</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> can_occur_def event.simps<span class="main"><span class="main">(</span></span>29<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="free">c</span> <span class="var">?q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> regular_event_preserves_process_snapshots <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> can_occur_def 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ev'</span> <span class="main">=</span> Snapshot <span class="main">(</span>occurs_on <span class="free">ev'</span><span class="main">)</span>›</span></span> event.simps<span class="main"><span class="main">(</span></span>29<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 5
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> Send <span class="skolem">i</span> <span class="var">?p</span> <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> event.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> 5 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ev'</span> <span class="main">=</span> RecvMarker <span class="skolem">i'</span> <span class="var">?q</span> <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> event.collapse<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> pre<span class="main">:</span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span>msgs <span class="free">c'</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">=</span> Marker <span class="main">∧</span> length <span class="main">(</span>msgs <span class="free">c'</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> can_occur_def event.simps<span class="main"><span class="main">(</span></span>30<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span>msgs <span class="free">c</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">=</span> Marker <span class="main">∧</span> length <span class="main">(</span>msgs <span class="free">c</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">c</span> <span class="skolem">i'</span> <span class="main">=</span> msgs <span class="free">c'</span> <span class="skolem">i'</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="free">ev</span> <span class="main">=</span> Send <span class="skolem">i</span> <span class="main">(</span>occurs_on <span class="free">ev</span><span class="main">)</span> <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> event.sel<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> msgs_unchanged_for_other_is<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> pre <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">c'</span> <span class="skolem">i'</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="skolem">i'</span> <span class="main">@</span> <span class="main">[</span>Msg <span class="skolem">m</span><span class="main">]</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="free">ev</span> <span class="main">=</span> Send <span class="skolem">i</span> <span class="main">(</span>occurs_on <span class="free">ev</span><span class="main">)</span> <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> next_send<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>msgs <span class="free">c'</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> pre <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>msgs <span class="free">c</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹msgs <span class="free">c'</span> <span class="skolem">i'</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="skolem">i'</span> <span class="main">@</span> <span class="main">[</span>Msg <span class="skolem">m</span><span class="main">]</span>›</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹msgs <span class="free">c'</span> <span class="skolem">i'</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="skolem">i'</span> <span class="main">@</span> <span class="main">[</span>Msg <span class="skolem">m</span><span class="main">]</span>›</span></span> pre <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> can_occur_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ev'</span> <span class="main">=</span> RecvMarker <span class="skolem">i'</span> <span class="var">?q</span> <span class="skolem">r</span>›</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> can_occur_def event.simps<span class="main"><span class="main">(</span></span>30<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 6
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> Recv <span class="skolem">i</span> <span class="var">?p</span> <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> event.collapse<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> 6 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ev'</span> <span class="main">=</span> RecvMarker <span class="skolem">i'</span> <span class="var">?q</span> <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> event.collapse<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">≠</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">≠</span> <span class="var">?q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="skolem">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="var">?p</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="free">ev</span> <span class="main">=</span> Recv <span class="skolem">i</span> <span class="main">(</span>occurs_on <span class="free">ev</span><span class="main">)</span> <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> distributed_system.can_occur_Recv distributed_system_axioms happen_implies_can_occur<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="skolem">i'</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="var">?q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ev'</span> <span class="main">=</span> RecvMarker <span class="skolem">i'</span> <span class="main">(</span>occurs_on <span class="free">ev'</span><span class="main">)</span> <span class="skolem">r</span>›</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> can_occur_def event.case_eq_if event.disc<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">,</span></span>10<span class="main"><span class="main">,</span></span>15<span class="main"><span class="main">,</span></span>20<span class="main"><span class="main">)</span></span> event.sel<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">,</span></span>10<span class="main"><span class="main">,</span></span>13<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted">"6"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ev</span> <span class="main">=</span> Recv <span class="skolem">i</span> <span class="main">(</span>occurs_on <span class="free">ev</span><span class="main">)</span> <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ev'</span> <span class="main">=</span> RecvMarker <span class="skolem">i'</span> <span class="main">(</span>occurs_on <span class="free">ev'</span><span class="main">)</span> <span class="skolem">r</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> can_occur_def event.case_eq_if event.distinct_disc<span class="main"><span class="main">(</span></span>13<span class="main"><span class="main">)</span></span> event.distinct_disc<span class="main"><span class="main">(</span></span>17<span class="main"><span class="main">)</span></span> event.distinct_disc<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> event.sel<span class="main"><span class="main">(</span></span>10<span class="main"><span class="main">)</span></span> next_recv<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> same_state_implies_same_result_state<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"states <span class="free">c</span> <span class="free">p</span> <span class="main">=</span> states <span class="free">d</span> <span class="free">p</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">d'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"states <span class="free">d'</span> <span class="free">p</span> <span class="main">=</span> states <span class="free">c'</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span> <span class="main">=</span> <span class="free">p</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1-3<span class="main"><span class="main">)</span></span> distributed_system.no_state_change_if_no_event distributed_system_axioms<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ev</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> same_snapshot_state_implies_same_result_snapshot_state<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"ps <span class="free">c</span> <span class="free">p</span> <span class="main">=</span> ps <span class="free">d</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"states <span class="free">c</span> <span class="free">p</span> <span class="main">=</span> states <span class="free">d</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">d'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"ps <span class="free">d'</span> <span class="free">p</span> <span class="main">=</span> ps <span class="free">c'</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span> <span class="main">=</span> <span class="free">p</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms no_state_change_if_no_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ev</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Snapshot <span class="skolem">q</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> Snapshot assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>RecvMarker <span class="skolem">i</span> <span class="skolem">q</span> <span class="skolem">r</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">c</span> <span class="bound">ca</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="bound">ca</span> <span class="main">∨</span> ps <span class="bound">c</span> <span class="free">p</span> <span class="main">=</span> None <span class="main">∨</span> ps <span class="bound">c</span> <span class="free">p</span> <span class="main">=</span> ps <span class="bound">ca</span> <span class="free">p</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> RecvMarker <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">=</span> <span class="skolem">q</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">c</span> <span class="bound">ca</span><span class="main">.</span> ps <span class="bound">c</span> <span class="free">p</span> <span class="main">≠</span> None <span class="main">∨</span> <span class="main">¬</span> <span class="bound">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="bound">ca</span> <span class="main">∨</span> ps <span class="bound">ca</span> <span class="free">p</span> <span class="main">=</span> Some <span class="main">(</span>states <span class="bound">c</span> <span class="free">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> RecvMarker <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">=</span> <span class="skolem">q</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> f1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Trans <span class="skolem">q</span> <span class="skolem">s</span> <span class="skolem">s'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="skolem">q</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> Trans assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Send <span class="skolem">i</span> <span class="skolem">q</span> <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> Send assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Recv <span class="skolem">i</span> <span class="skolem">q</span> <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> Recv assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> same_messages_imply_same_resulting_messages<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"msgs <span class="free">c</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d</span> <span class="free">i</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">d'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"regular_event <span class="free">ev</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"msgs <span class="free">c'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d'</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"isTrans <span class="free">ev</span> <span class="main">∨</span> isSend <span class="free">ev</span> <span class="main">∨</span> isRecv <span class="free">ev</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"isTrans <span class="free">ev</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> isTrans_def next_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"isSend <span class="free">ev</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> Send <span class="skolem">i'</span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> event.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"isRecv <span class="free">ev</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> Recv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> Recv <span class="skolem">i'</span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> event.collapse<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Trans_msg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isTrans <span class="free">ev</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"msgs <span class="free">c</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c'</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> no_msg_change_if_no_event regular_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> new_msg_in_set_implies_occurrence<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">∉</span> set <span class="main">(</span>msgs <span class="free">c</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">∈</span> set <span class="main">(</span>msgs <span class="free">c'</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span> <span class="main">=</span> <span class="free">p</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="var">?P</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>msgs <span class="free">c'</span> <span class="free">i</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>msgs <span class="free">c</span> <span class="free">i</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ev</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Snapshot <span class="skolem">r</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">c'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">~</span> <span class="var">?P</span>›</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>RecvMarker <span class="skolem">i'</span> <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="free">c</span> <span class="skolem">r</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">=</span> <span class="free">i</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">#</span> msgs <span class="free">c'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> RecvMarker True assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> set_subset_Cons<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> RecvMarker True assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> no_snap<span class="main">:</span> False
      <span class="keyword1"><span class="command">have</span></span> chan<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="skolem">i'</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> RecvMarker assms<span class="main">(</span>1<span class="main">)</span> can_occur_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">=</span> <span class="free">i</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">#</span> msgs <span class="free">c'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> RecvMarker assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> set_subset_Cons<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">c'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">~</span> <span class="var">?P</span>›</span></span> RecvMarker assms no_snap <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Trans <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">u'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹<span class="main">~</span> <span class="var">?P</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Send <span class="skolem">i'</span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">≠</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">~</span> <span class="var">?P</span>›</span></span> can_occur_def assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">c</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c'</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">~</span> <span class="var">?P</span>›</span></span> assms Send <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Recv <span class="skolem">i'</span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eq_iff local.next.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> set_subset_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> set <span class="main">(</span>msgs <span class="free">c'</span> <span class="free">i</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>msgs <span class="free">c</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> new_Marker_in_set_implies_nonregular_occurence<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="free">c</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"Marker <span class="main">∈</span> set <span class="main">(</span>msgs <span class="free">c'</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">~</span> regular_event <span class="free">ev</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span> <span class="main">=</span> <span class="free">p</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms new_msg_in_set_implies_occurrence <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="var">?P</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"isTrans <span class="free">ev</span> <span class="main">∨</span> isSend <span class="free">ev</span> <span class="main">∨</span> isRecv <span class="free">ev</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="free">c'</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> Trans <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">u'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> event.collapse<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> Send <span class="skolem">i'</span> <span class="skolem">r</span> <span class="skolem">q</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> event.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Un_iff assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> empty_iff empty_set insert_iff list.set<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> message.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> next_send set_append<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 3
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> Recv <span class="skolem">i'</span> <span class="skolem">r</span> <span class="skolem">q</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> event.collapse<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> list.set_intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> next_recv<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> RecvMarker_implies_Marker_in_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> RecvMarker <span class="free">cid</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"Marker <span class="main">∈</span> set <span class="main">(</span>msgs <span class="free">c</span> <span class="free">cid</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> can_occur_def distributed_system.happen_implies_can_occur distributed_system_axioms event.simps<span class="main"><span class="main">(</span></span>30<span class="main"><span class="main">)</span></span> list.set_sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> nat_less_le<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> RecvMarker_given_channel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"isRecvMarker <span class="free">ev</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"getId <span class="free">ev</span> <span class="main">=</span> <span class="free">cid</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"can_occur <span class="free">ev</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> RecvMarker <span class="free">cid</span> <span class="free">q</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> can_occur_def event.case_eq_if event.collapse<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> event.distinct_disc<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">,</span></span>14<span class="main"><span class="main">,</span></span>18<span class="main"><span class="main">,</span></span>20<span class="main"><span class="main">)</span></span> option.inject prod.inject<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Recv_given_channel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"isRecv <span class="free">ev</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"getId <span class="free">ev</span> <span class="main">=</span> <span class="free">cid</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"can_occur <span class="free">ev</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s</span> <span class="bound">s'</span> <span class="bound">m</span><span class="main">.</span> <span class="free">ev</span> <span class="main">=</span> Recv <span class="free">cid</span> <span class="free">q</span> <span class="free">p</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> distributed_system.can_occur_Recv distributed_system_axioms event.collapse<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> option.inject prod.inject<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> same_cs_if_not_recv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">~</span> isRecv <span class="free">ev</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
     <span class="quoted"><span class="quoted">"fst <span class="main">(</span>cs <span class="free">c</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>cs <span class="free">c'</span> <span class="free">cid</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> None"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> no_cs_change_if_no_channel <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> chan<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ev</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Snapshot <span class="skolem">r</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Snapshot assms chan <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="skolem">q</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>RecvMarker <span class="skolem">cid'</span> <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="free">c</span> <span class="skolem">r</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> assms RecvMarker chan <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">cid'</span> <span class="main">=</span> <span class="free">cid</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> no_snap<span class="main">:</span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">cid'</span> <span class="main">=</span> <span class="free">cid</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> RecvMarker assms chan <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">with</span></span> assms RecvMarker chan no_snap <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="skolem">q</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Trans <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">u'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Send <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">u'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> isRecv_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> done_only_from_recv_marker<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="free">c</span> <span class="free">cid</span><span class="main">)</span> <span class="main">≠</span> Done"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="free">c'</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> Done"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> RecvMarker <span class="free">cid</span> <span class="free">q</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="free">ev</span> <span class="main">=</span> RecvMarker <span class="free">cid</span> <span class="free">q</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"isRecvMarker <span class="free">ev</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cid'</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> RecvMarker<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> RecvMarker <span class="skolem">cid'</span> <span class="skolem">s</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> isRecvMarker_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="free">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ev</span> <span class="main">=</span> RecvMarker <span class="skolem">cid'</span> <span class="skolem">s</span> <span class="skolem">r</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ev</span> <span class="main">≠</span> RecvMarker <span class="free">cid</span> <span class="free">q</span> <span class="free">p</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> can_occur_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="free">c'</span> <span class="free">cid</span><span class="main">)</span> <span class="main">≠</span> Done"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="free">c</span> <span class="skolem">s</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> RecvMarker assms <span class="quoted"><span class="quoted">‹<span class="free">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> RecvMarker assms <span class="quoted"><span class="quoted">‹<span class="free">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="free">q</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"isSnapshot <span class="free">ev</span> <span class="main">∨</span> isTrans <span class="free">ev</span> <span class="main">∨</span> isSend <span class="free">ev</span> <span class="main">∨</span> isRecv <span class="free">ev</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> event.exhaust_disc <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="free">c'</span> <span class="free">cid</span><span class="main">)</span> <span class="main">≠</span> Done"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> Snapshot<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> Snapshot <span class="skolem">r</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> isSnapshot_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="skolem">r</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> Trans <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">u'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> isTrans_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 3
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cid'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> Send <span class="skolem">cid'</span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> isSend_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 4
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cid'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> Recv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> Recv <span class="skolem">cid'</span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> isRecv_def<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Recv assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">cid</span> <span class="main">=</span> <span class="skolem">cid'</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="free">c</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> NotStarted <span class="main">∨</span> snd <span class="main">(</span>cs <span class="free">c</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> Recording"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> recording_state.exhaust <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> 1
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="free">c'</span> <span class="skolem">cid'</span><span class="main">)</span> <span class="main">=</span> NotStarted"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> True Recv assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> 2
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="free">c'</span> <span class="skolem">cid'</span><span class="main">)</span> <span class="main">=</span> Recording"</span></span>
            <span class="keyword1"><span class="command">using</span></span> True Recv assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cs_not_not_started_stable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="free">c</span> <span class="free">cid</span><span class="main">)</span> <span class="main">≠</span> NotStarted"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="free">c'</span> <span class="free">cid</span><span class="main">)</span> <span class="main">≠</span> NotStarted"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ev</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Snapshot <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> next_snapshot recording_state.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> sndI<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>RecvMarker <span class="skolem">cid'</span> <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="free">c</span> <span class="skolem">r</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> RecvMarker assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">cid</span> <span class="main">=</span> <span class="skolem">cid'</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> no_snap<span class="main">:</span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">cid</span> <span class="main">=</span> <span class="skolem">cid'</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> RecvMarker assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> RecvMarker assms no_snap <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="free">p</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Recv <span class="skolem">cid'</span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="free">c</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> Recording <span class="main">∨</span> snd <span class="main">(</span>cs <span class="free">c</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> Done"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> recording_state.exhaust <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Recv assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eq_snd_iff next_recv recording_state.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">with</span></span> Recv assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">cid</span> <span class="main">=</span> <span class="skolem">cid'</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fst_cs_changed_by_recv_recording<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"fst <span class="main">(</span>cs <span class="free">c</span> <span class="free">cid</span><span class="main">)</span> <span class="main">≠</span> fst <span class="main">(</span>cs <span class="free">c'</span> <span class="free">cid</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="free">c</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> Recording <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">u</span> <span class="bound">u'</span> <span class="bound">m</span><span class="main">.</span> <span class="free">ev</span> <span class="main">=</span> Recv <span class="free">cid</span> <span class="bound">q</span> <span class="bound">p</span> <span class="bound">u</span> <span class="bound">u'</span> <span class="bound">m</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> oc_on<span class="main">:</span> <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span> <span class="main">=</span> <span class="free">q</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">nn</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'m</span><span class="main">)</span> event <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">aa</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'m</span><span class="main">)</span> event <span class="main">⇒</span> <span class="tfree">'p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">aaa</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'m</span><span class="main">)</span> event <span class="main">⇒</span> <span class="tfree">'p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">bb</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'m</span><span class="main">)</span> event <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">bba</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'m</span><span class="main">)</span> event <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">cc</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'m</span><span class="main">)</span> event <span class="main">⇒</span> <span class="tfree">'m</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">e</span><span class="main">.</span> <span class="main">(</span><span class="main">¬</span> isRecv <span class="bound">e</span> <span class="main">∨</span> <span class="bound">e</span> <span class="main">=</span> Recv <span class="main">(</span><span class="skolem">nn</span> <span class="bound">e</span><span class="main">)</span> <span class="main">(</span><span class="skolem">aa</span> <span class="bound">e</span><span class="main">)</span> <span class="main">(</span><span class="skolem">aaa</span> <span class="bound">e</span><span class="main">)</span> <span class="main">(</span><span class="skolem">bb</span> <span class="bound">e</span><span class="main">)</span> <span class="main">(</span><span class="skolem">bba</span> <span class="bound">e</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cc</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>isRecv <span class="bound">e</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∀</span><span class="bound">n</span> <span class="bound">a</span> <span class="bound">aa</span> <span class="bound">b</span> <span class="bound">ba</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">e</span> <span class="main">≠</span> Recv <span class="bound">n</span> <span class="bound">a</span> <span class="bound">aa</span> <span class="bound">b</span> <span class="bound">ba</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> isRecv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">moura</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> Recv <span class="main">(</span><span class="skolem">nn</span> <span class="free">ev</span><span class="main">)</span> <span class="main">(</span><span class="skolem">aa</span> <span class="free">ev</span><span class="main">)</span> <span class="main">(</span><span class="skolem">aaa</span> <span class="free">ev</span><span class="main">)</span> <span class="main">(</span><span class="skolem">bb</span> <span class="free">ev</span><span class="main">)</span> <span class="main">(</span><span class="skolem">bba</span> <span class="free">ev</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cc</span> <span class="free">ev</span><span class="main">)</span> <span class="main">↦</span> <span class="free">c'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> local.step same_cs_if_not_recv<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> f3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x0</span> <span class="bound">x1</span> <span class="bound">x7</span> <span class="bound">x8</span><span class="main">.</span> <span class="main">(</span><span class="bound">x0</span> <span class="main">≠</span> <span class="bound">x7</span> <span class="main">⟶</span> cs <span class="main">(</span><span class="bound">x8</span><span class="main">::</span><span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'m</span><span class="main">)</span> configuration<span class="main">)</span> <span class="bound">x0</span> <span class="main">=</span> cs <span class="main">(</span><span class="bound">x1</span><span class="main">::</span><span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> configuration<span class="main">)</span> <span class="bound">x0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">x0</span> <span class="main">=</span> <span class="bound">x7</span> <span class="main">∨</span> cs <span class="bound">x8</span> <span class="bound">x0</span> <span class="main">=</span> cs <span class="bound">x1</span> <span class="bound">x0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> f4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x0</span> <span class="bound">x1</span> <span class="bound">x7</span> <span class="bound">x8</span><span class="main">.</span> <span class="main">(</span><span class="bound">x7</span> <span class="main">≠</span> <span class="bound">x0</span> <span class="main">⟶</span> msgs <span class="main">(</span><span class="bound">x1</span><span class="main">::</span><span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'m</span><span class="main">)</span> configuration<span class="main">)</span> <span class="bound">x0</span> <span class="main">=</span> msgs <span class="main">(</span><span class="bound">x8</span><span class="main">::</span><span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> configuration<span class="main">)</span> <span class="bound">x0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">x7</span> <span class="main">=</span> <span class="bound">x0</span> <span class="main">∨</span> msgs <span class="bound">x1</span> <span class="bound">x0</span> <span class="main">=</span> msgs <span class="bound">x8</span> <span class="bound">x0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x0</span> <span class="bound">x1</span> <span class="bound">x6</span> <span class="bound">x8</span><span class="main">.</span> <span class="main">(</span><span class="bound">x0</span> <span class="main">≠</span> <span class="bound">x6</span> <span class="main">⟶</span> states <span class="main">(</span><span class="bound">x1</span><span class="main">::</span><span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'m</span><span class="main">)</span> configuration<span class="main">)</span> <span class="bound">x0</span> <span class="main">=</span> states <span class="main">(</span><span class="bound">x8</span><span class="main">::</span><span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="tfree">'m</span><span class="main">)</span> configuration<span class="main">)</span> <span class="bound">x0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">x0</span> <span class="main">=</span> <span class="bound">x6</span> <span class="main">∨</span> states <span class="bound">x1</span> <span class="bound">x0</span> <span class="main">=</span> states <span class="bound">x8</span> <span class="bound">x0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"can_occur <span class="main">(</span>Recv <span class="main">(</span><span class="skolem">nn</span> <span class="free">ev</span><span class="main">)</span> <span class="main">(</span><span class="skolem">aa</span> <span class="free">ev</span><span class="main">)</span> <span class="main">(</span><span class="skolem">aaa</span> <span class="free">ev</span><span class="main">)</span> <span class="main">(</span><span class="skolem">bb</span> <span class="free">ev</span><span class="main">)</span> <span class="main">(</span><span class="skolem">bba</span> <span class="free">ev</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cc</span> <span class="free">ev</span><span class="main">)</span><span class="main">)</span> <span class="free">c</span> <span class="main">∧</span> states <span class="free">c</span> <span class="main">(</span><span class="skolem">aa</span> <span class="free">ev</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">bb</span> <span class="free">ev</span> <span class="main">∧</span> states <span class="free">c'</span> <span class="main">(</span><span class="skolem">aa</span> <span class="free">ev</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">bba</span> <span class="free">ev</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">=</span> <span class="skolem">aa</span> <span class="free">ev</span> <span class="main">∨</span> states <span class="free">c'</span> <span class="bound">a</span> <span class="main">=</span> states <span class="free">c</span> <span class="bound">a</span><span class="main">)</span> <span class="main">∧</span> msgs <span class="free">c</span> <span class="main">(</span><span class="skolem">nn</span> <span class="free">ev</span><span class="main">)</span> <span class="main">=</span> Msg <span class="main">(</span><span class="skolem">cc</span> <span class="free">ev</span><span class="main">)</span> <span class="main">#</span> msgs <span class="free">c'</span> <span class="main">(</span><span class="skolem">nn</span> <span class="free">ev</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="skolem">nn</span> <span class="free">ev</span> <span class="main">=</span> <span class="bound">n</span> <span class="main">∨</span> msgs <span class="free">c'</span> <span class="bound">n</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">.</span> ps <span class="free">c</span> <span class="bound">a</span> <span class="main">=</span> ps <span class="free">c'</span> <span class="bound">a</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">=</span> <span class="skolem">nn</span> <span class="free">ev</span> <span class="main">∨</span> cs <span class="free">c</span> <span class="bound">n</span> <span class="main">=</span> cs <span class="free">c'</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">if</span> snd <span class="main">(</span>cs <span class="free">c</span> <span class="main">(</span><span class="skolem">nn</span> <span class="free">ev</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Recording <span class="keyword1">then</span> cs <span class="free">c'</span> <span class="main">(</span><span class="skolem">nn</span> <span class="free">ev</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fst <span class="main">(</span>cs <span class="free">c</span> <span class="main">(</span><span class="skolem">nn</span> <span class="free">ev</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">cc</span> <span class="free">ev</span><span class="main">]</span><span class="main">,</span> Recording<span class="main">)</span> <span class="keyword1">else</span> cs <span class="free">c</span> <span class="main">(</span><span class="skolem">nn</span> <span class="free">ev</span><span class="main">)</span> <span class="main">=</span> cs <span class="free">c'</span> <span class="main">(</span><span class="skolem">nn</span> <span class="free">ev</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> f4 f3 f2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> f1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Pair_inject assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> can_occur_Recv event.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> local.step option.sel same_cs_if_not_recv<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"isRecv <span class="free">ev</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="var">?P</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>cs <span class="free">c</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>cs <span class="free">c'</span> <span class="free">cid</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> local.step same_cs_if_not_recv<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cid'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> Recv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> Recv <span class="skolem">cid'</span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> isRecv_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">cid</span> <span class="main">=</span> <span class="skolem">cid'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="free">cid</span> <span class="main">=</span> <span class="skolem">cid'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>cs <span class="free">c</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>cs <span class="free">c'</span> <span class="free">cid</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Recv step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="free">c</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> Recording"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> snd <span class="main">(</span>cs <span class="free">c</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> Recording"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>cs <span class="free">c</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>cs <span class="free">c'</span> <span class="free">cid</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Recv step <span class="quoted"><span class="quoted">‹<span class="free">cid</span> <span class="main">=</span> <span class="skolem">cid'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Recv <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> no_marker_and_snapshotted_implies_no_more_markers<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"has_snapshotted <span class="free">c</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="free">c</span> <span class="free">cid</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="free">c'</span> <span class="free">cid</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ev</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Snapshot <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≠</span> <span class="free">p</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> can_occur_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">c</span> <span class="free">cid</span> <span class="main">=</span> msgs <span class="free">c'</span> <span class="free">cid</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms Snapshot <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>RecvMarker <span class="skolem">cid'</span> <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="free">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"can_occur <span class="free">ev</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> happen_implies_can_occur assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">:</span> set <span class="main">(</span>msgs <span class="free">c</span> <span class="free">cid</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> can_occur_def RecvMarker 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> event.simps<span class="main"><span class="main">(</span></span>30<span class="main"><span class="main">)</span></span> hd_in_set list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> recv_marker_other_channels_not_shrinking zero_order<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">c</span> <span class="free">cid</span> <span class="main">=</span> msgs <span class="free">c'</span> <span class="free">cid</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="free">p</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> RecvMarker <span class="quoted"><span class="quoted">‹<span class="free">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> msgs_unchanged_if_snapshotted_RecvMarker_for_other_is <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> RecvMarker <span class="quoted"><span class="quoted">‹<span class="free">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>›</span></span> step assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="free">c</span> <span class="skolem">r</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Trans <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">u'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Send <span class="skolem">cid'</span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms Send <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">cid</span> <span class="main">=</span> <span class="skolem">cid'</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Recv <span class="skolem">cid'</span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms Recv <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">cid</span> <span class="main">=</span> <span class="skolem">cid'</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> same_messages_if_no_occurrence<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">~</span> occurs_on <span class="free">ev</span> <span class="main">=</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">~</span> occurs_on <span class="free">ev</span> <span class="main">=</span> <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"msgs <span class="free">c</span> <span class="free">cid</span> <span class="main">=</span> msgs <span class="free">c'</span> <span class="free">cid</span> <span class="main">∧</span> cs <span class="free">c</span> <span class="free">cid</span> <span class="main">=</span> cs <span class="free">c'</span> <span class="free">cid</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ev</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Snapshot <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>RecvMarker <span class="skolem">cid'</span> <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> RecvMarker_given_channel assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> RecvMarker event.sel<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">,</span></span>10<span class="main"><span class="main">)</span></span> happen_implies_can_occur isRecvMarker_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">a</span><span class="main">.</span> <span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> RecvMarker <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> RecvMarker assms <span class="quoted"><span class="quoted">‹<span class="free">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="free">c</span> <span class="skolem">r</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Trans <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">u'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Send <span class="skolem">cid'</span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Pair_inject assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> can_occur_def event.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> event.simps<span class="main"><span class="main">(</span></span>27<span class="main"><span class="main">)</span></span> happen_implies_can_occur option.inject<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms Send <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Recv <span class="skolem">cid'</span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> distributed_system.can_occur_Recv distributed_system.happen_implies_can_occur distributed_system_axioms event.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> option.inject prod.inject<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms Recv <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* locale distributed_system *)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* theory Distributed_System *)</span>
</pre>
</div><div id="Trace">
<div class="head">
<h1>Theory Trace</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Traces›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Traces extend transitions to finitely many intermediate events.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Trace
  <span class="keyword2"><span class="keyword">imports</span></span>
    <span class="quoted">"<a href="../../HOL/HOL-Library/Sublist.html">HOL-Library.Sublist</a>"</span>
    <a href="Distributed_System.html">Distributed_System</a>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> distributed_system

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We can think of a trace as the transitive closure of the next
relation. A trace consists of initial and final configurations $c$ and
$c'$, with an ordered list of events $t$ occurring sequentially on $c$,
yielding $c'$.›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> distributed_system<span class="main">)</span> <span class="entity">trace</span> <span class="keyword2"><span class="keyword">where</span></span>
    tr_init<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">trace</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>
  <span class="main">|</span> tr_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">ev</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">;</span> <span class="free">trace</span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">c''</span></span></span> <span class="main">⟧</span>
              <span class="main">⟹</span> <span class="free">trace</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ev</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c''</span></span></span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Properties of traces›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> trace_trans<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> trace <span class="free">c</span> <span class="free">t</span> <span class="free">c'</span><span class="main">;</span>
       trace <span class="free">c'</span> <span class="free">t'</span> <span class="free">c''</span>
     <span class="main">⟧</span> <span class="main">⟹</span> trace <span class="free">c</span> <span class="main">(</span><span class="free">t</span> <span class="main">@</span> <span class="free">t'</span><span class="main">)</span> <span class="free">c''</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">c'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>trace.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> tr_init
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> tr_step
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> trace.tr_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> trace_decomp_head<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">c</span> <span class="main">(</span><span class="free">ev</span> <span class="main">#</span> <span class="free">t</span><span class="main">)</span> <span class="free">c'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c''</span><span class="main">.</span> <span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="bound">c''</span> <span class="main">∧</span> trace <span class="bound">c''</span> <span class="free">t</span> <span class="free">c'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms trace.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> trace_decomp_tail<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">c</span> <span class="main">(</span><span class="free">t</span> <span class="main">@</span> <span class="main">[</span><span class="free">ev</span><span class="main">]</span><span class="main">)</span> <span class="free">c'</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">c''</span><span class="main">.</span> trace <span class="free">c</span> <span class="free">t</span> <span class="bound">c''</span> <span class="main">∧</span> <span class="bound">c''</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">c'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> append_Nil distributed_system.trace.simps distributed_system_axioms list.discI list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">ev'</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">⊢</span> <span class="skolem">ev'</span> <span class="main">↦</span> <span class="skolem">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"trace <span class="skolem">d</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">@</span> <span class="main">[</span><span class="free">ev</span><span class="main">]</span><span class="main">)</span> <span class="free">c'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> trace_decomp_head <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d'</span></span> <span class="keyword2"><span class="keyword">where</span></span> tr<span class="main">:</span> <span class="quoted"><span class="quoted">"trace <span class="skolem">d</span> <span class="skolem">t</span> <span class="skolem">d'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d'</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">c'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons.hyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="skolem">c</span> <span class="main">(</span><span class="skolem">ev'</span> <span class="main">#</span> <span class="skolem">t</span><span class="main">)</span> <span class="skolem">d'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> step tr trace.tr_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> trace_snoc<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">c</span> <span class="free">t</span> <span class="free">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c'</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">c''</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">c</span> <span class="main">(</span><span class="free">t</span> <span class="main">@</span> <span class="main">[</span><span class="free">ev</span><span class="main">]</span><span class="main">)</span> <span class="free">c''</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> tr_init tr_step trace_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> trace_rev_induct <span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> tr_rev_init tr_rev_step<span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> trace <span class="free">c</span> <span class="free">t</span> <span class="free">c'</span><span class="main">;</span>
     <span class="main">(</span><span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c</span> <span class="main">[]</span> <span class="bound">c</span><span class="main">)</span><span class="main">;</span>
     <span class="main">(</span><span class="main">⋀</span><span class="bound">c</span> <span class="bound">t</span> <span class="bound">c'</span> <span class="bound">ev</span> <span class="bound">c''</span><span class="main">.</span> trace <span class="bound">c</span> <span class="bound">t</span> <span class="bound">c'</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">c</span> <span class="bound">t</span> <span class="bound">c'</span> <span class="main">⟹</span> <span class="bound">c'</span> <span class="main">⊢</span> <span class="bound">ev</span> <span class="main">↦</span> <span class="bound">c''</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">c</span> <span class="main">(</span><span class="bound">t</span> <span class="main">@</span> <span class="main">[</span><span class="bound">ev</span><span class="main">]</span><span class="main">)</span> <span class="bound">c''</span><span class="main">)</span>
   <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">c</span> <span class="free">t</span> <span class="free">c'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> distributed_system.trace.cases distributed_system_axioms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">ev</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"trace <span class="free">c</span> <span class="skolem">t</span> <span class="skolem">c''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c''</span> <span class="main">⊢</span> <span class="skolem">ev</span> <span class="main">↦</span> <span class="skolem">c'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> trace_decomp_tail <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> snoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> trace_and_start_determines_end<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">c</span> <span class="free">t</span> <span class="free">c'</span> <span class="main">⟹</span> trace <span class="free">c</span> <span class="free">t</span> <span class="free">d'</span> <span class="main">⟹</span> <span class="free">c'</span> <span class="main">=</span> <span class="free">d'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">c'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">d'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>trace_rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> tr_rev_init
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> trace.cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tr_rev_step <span class="skolem">c</span> <span class="skolem">t</span> <span class="skolem">c'</span> <span class="skolem">ev</span> <span class="skolem">c''</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"trace <span class="skolem">c</span> <span class="skolem">t</span> <span class="skolem">d''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d''</span> <span class="main">⊢</span> <span class="skolem">ev</span> <span class="main">↦</span> <span class="skolem">d'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> trace_decomp_tail <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> tr_rev_step state_and_event_determine_next <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> suffix_split_trace<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> trace <span class="free">c</span> <span class="free">t</span> <span class="free">c'</span><span class="main">;</span>
       suffix <span class="free">t'</span> <span class="free">t</span>
     <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">c''</span><span class="main">.</span> trace <span class="bound">c''</span> <span class="free">t'</span> <span class="free">c'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="free">c'</span> <span class="free">t'</span> <span class="free">c'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> tr_init <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">ev</span> <span class="skolem">t''</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Cons.prems <span class="keyword1"><span class="command">have</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"suffix <span class="free">t'</span> <span class="skolem">t''</span> <span class="main">∨</span> <span class="free">t'</span> <span class="main">=</span> <span class="skolem">ev</span> <span class="main">#</span> <span class="skolem">t''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> suffix_Cons<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"suffix <span class="free">t'</span> <span class="skolem">t''</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons.hyps Cons.prems<span class="main">(</span>1<span class="main">)</span> trace.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="main">=</span> <span class="skolem">ev</span> <span class="main">#</span> <span class="skolem">t''</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> q <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons.hyps Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prefix_split_trace<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'m</span><span class="main">)</span> configuration"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'m</span><span class="main">)</span> trace"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">∃</span><span class="bound">c'</span><span class="main">.</span> trace <span class="free">c</span> <span class="free">t</span> <span class="bound">c'</span><span class="main">;</span>
       prefix <span class="free">t'</span> <span class="free">t</span>
     <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">c''</span><span class="main">.</span> trace <span class="free">c</span> <span class="free">t'</span> <span class="bound">c''</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">ev</span> <span class="skolem">t''</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> snoc.prems <span class="keyword1"><span class="command">have</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"prefix <span class="free">t'</span> <span class="skolem">t''</span> <span class="main">∨</span> <span class="free">t'</span> <span class="main">=</span> <span class="skolem">t''</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">ev</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"prefix <span class="free">t'</span> <span class="skolem">t''</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> trace_decomp_tail <span class="keyword1"><span class="command">using</span></span> snoc.hyps snoc.prems<span class="main">(</span>1<span class="main">)</span> trace.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> q snoc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> split_trace<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> trace <span class="free">c</span> <span class="free">t</span> <span class="free">c'</span><span class="main">;</span>
       <span class="free">t</span> <span class="main">=</span> <span class="free">t'</span> <span class="main">@</span> <span class="free">t''</span>
     <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">c''</span><span class="main">.</span> trace <span class="free">c</span> <span class="free">t'</span> <span class="bound">c''</span> <span class="main">∧</span> trace <span class="bound">c''</span> <span class="free">t''</span> <span class="free">c'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t''</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> tr_init <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">ev</span> <span class="skolem">t''</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c''</span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"trace <span class="free">c</span> <span class="main">(</span><span class="skolem">t'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">ev</span><span class="main">]</span><span class="main">)</span> <span class="skolem">c''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons.prems prefix_split_trace rotate1.simps<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="skolem">c''</span> <span class="skolem">t''</span> <span class="free">c'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons.hyps Cons.prems trace_and_start_determines_end <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> distributed_system.tr_step distributed_system.trace_decomp_tail distributed_system_axioms p<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Describing intermediate configurations›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">construct_fun_from_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">*</span> <span class="tfree">'b</span><span class="main">)</span> set <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">construct_fun_from_rel</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">trace_rel</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">trace_rel</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">t'</span><span class="main">)</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> trace <span class="bound">x</span> <span class="bound">t'</span> <span class="bound">y</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fun_must_admit_trace<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"single_valued <span class="free">R</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> Domain <span class="free">R</span>
     <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> construct_fun_from_rel <span class="free">R</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> construct_fun_from_rel_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> theI'<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> single_valued_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> single_valued_trace_rel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"single_valued trace_rel"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> single_valuedI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">y'</span>
  <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> trace_rel"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y'</span><span class="main">)</span> <span class="main">∈</span> trace_rel"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x'</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> surj_pair<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="skolem">x'</span> <span class="skolem">t</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"trace <span class="skolem">x'</span> <span class="skolem">t</span> <span class="skolem">y'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> asm trace_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">y'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> trace_and_start_determines_end <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">run_trace</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">run_trace</span> <span class="main">≡</span> construct_fun_from_rel trace_rel"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In order to describe intermediate configurations
of a trace we introduce the $s$ function definition, which,
given an initial configuration $c$, a trace $t$ and an index $i \in \mathbb{N}$,
determines the unique state after the first $i$ events of $t$.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">s</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">c'</span><span class="main">.</span> trace <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>take <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="bound">c'</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> s_is_partial_execution<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"s <span class="free">c</span> <span class="free">t</span> <span class="free">i</span> <span class="main">=</span> run_trace <span class="main">(</span><span class="free">c</span><span class="main">,</span> take <span class="free">i</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> s_def run_trace_def
            construct_fun_from_rel_def trace_rel_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> exists_trace_for_any_i<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c'</span><span class="main">.</span> trace <span class="free">c</span> <span class="free">t</span> <span class="bound">c'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">c</span> <span class="main">(</span>take <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>s <span class="free">c</span> <span class="free">t</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prefix <span class="main">(</span>take <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> take_is_prefix <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c''</span></span> <span class="keyword2"><span class="keyword">where</span></span> tr<span class="main">:</span> <span class="quoted"><span class="quoted">"trace <span class="free">c</span> <span class="main">(</span>take <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="skolem">c''</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms prefix_split_trace <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">c</span><span class="main">,</span> take <span class="free">i</span> <span class="free">t</span><span class="main">)</span><span class="main">,</span> s <span class="free">c</span> <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> trace_rel"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> s_def trace_rel_def construct_fun_from_rel_def 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> case_prod_conv distributed_system.trace_and_start_determines_end distributed_system_axioms mem_Collect_eq the_equality tr<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trace_rel_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> exists_trace_for_any_i_j<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c'</span><span class="main">.</span> trace <span class="free">c</span> <span class="free">t</span> <span class="bound">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="main">(</span>s <span class="free">c</span> <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>drop <span class="free">i</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>s <span class="free">c</span> <span class="free">t</span> <span class="free">j</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="free">c</span> <span class="main">(</span>take <span class="free">j</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>s <span class="free">c</span> <span class="free">t</span> <span class="free">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> exists_trace_for_any_i assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">≥</span> <span class="free">i</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="free">j</span> <span class="free">t</span> <span class="main">=</span> take <span class="free">i</span> <span class="free">t</span> <span class="main">@</span> <span class="main">(</span>take <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>drop <span class="free">i</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_add_diff_inverse take_add<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="free">c</span> <span class="main">(</span>take <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>s <span class="free">c</span> <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="main">∧</span> trace <span class="main">(</span>s <span class="free">c</span> <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>drop <span class="free">i</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>s <span class="free">c</span> <span class="free">t</span> <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> exists_trace_for_any_i split_trace trace_and_start_determines_end<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> step_Suc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    valid<span class="main">:</span> <span class="quoted"><span class="quoted">"trace <span class="free">c</span> <span class="free">t</span> <span class="free">c'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>s <span class="free">c</span> <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span>s <span class="free">c</span> <span class="free">t</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> ex_trace<span class="main">:</span> <span class="quoted"><span class="quoted">"trace <span class="main">(</span>s <span class="free">c</span> <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span>Suc <span class="free">i</span> <span class="main">-</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>drop <span class="free">i</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>s <span class="free">c</span> <span class="free">t</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> exists_trace_for_any_i_j le_less valid <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">i</span> <span class="main">-</span> <span class="free">i</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="main">1</span> <span class="main">(</span>drop <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="free">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹Suc <span class="free">i</span> <span class="main">-</span> <span class="free">i</span> <span class="main">=</span> <span class="main">1</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> hd_drop_conv_nth le_add_diff_inverse lessI nat_less_le same_append_eq take_add take_hd_drop<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.discI trace.simps trace_decomp_head<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Trace-related lemmas›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> snapshot_state_unchanged_trace<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">c</span> <span class="free">t</span> <span class="free">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"ps <span class="free">c</span> <span class="free">p</span> <span class="main">=</span> Some <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"ps <span class="free">c'</span> <span class="free">p</span> <span class="main">=</span> Some <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms snapshot_state_unchanged <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">c'</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> no_state_change_if_only_nonregular_events<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> trace <span class="free">c</span> <span class="free">t</span> <span class="free">c'</span><span class="main">;</span>
       <span class="main">∄</span><span class="bound">ev</span><span class="main">.</span> <span class="bound">ev</span> <span class="main">∈</span> set <span class="free">t</span> <span class="main">∧</span> regular_event <span class="bound">ev</span> <span class="main">∧</span> occurs_on <span class="bound">ev</span> <span class="main">=</span> <span class="free">p</span><span class="main">;</span>
       states <span class="free">c</span> <span class="free">p</span> <span class="main">=</span> <span class="free">st</span>
     <span class="main">⟧</span> <span class="main">⟹</span> states <span class="free">c'</span> <span class="free">p</span> <span class="main">=</span> <span class="free">st</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">c'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>trace_rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tr_rev_init <span class="skolem">c</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tr_rev_step <span class="skolem">c</span> <span class="skolem">t</span> <span class="skolem">c'</span> <span class="skolem">ev</span> <span class="skolem">c''</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"states <span class="skolem">c'</span> <span class="free">p</span> <span class="main">=</span> <span class="free">st</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">ev</span><span class="main">.</span> <span class="bound">ev</span> <span class="main">:</span> set <span class="skolem">t</span> <span class="main">∧</span> regular_event <span class="bound">ev</span> <span class="main">∧</span> occurs_on <span class="bound">ev</span> <span class="main">=</span> <span class="free">p</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> tr_rev_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> tr_rev_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> tr_rev_step no_state_change_if_no_event no_state_change_if_nonregular_event
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> message_must_be_delivered_2_trace<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">c</span> <span class="free">t</span> <span class="free">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">:</span> set <span class="main">(</span>msgs <span class="free">c</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">∉</span> set <span class="main">(</span>msgs <span class="free">c'</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">q</span><span class="main">,</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ev</span> <span class="main">∈</span> set <span class="free">t</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="bound">ev</span> <span class="main">=</span> RecvMarker <span class="free">i</span> <span class="bound">p</span> <span class="bound">q</span> <span class="main">∧</span> <span class="free">m</span> <span class="main">=</span> Marker<span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">m'</span><span class="main">.</span> <span class="bound">ev</span> <span class="main">=</span> Recv <span class="free">i</span> <span class="bound">q</span> <span class="bound">p</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">m'</span> <span class="main">∧</span> <span class="free">m</span> <span class="main">=</span> Msg <span class="bound">m'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ev</span> <span class="main">∈</span> set <span class="free">t</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="bound">ev</span> <span class="main">=</span> RecvMarker <span class="free">i</span> <span class="bound">p</span> <span class="bound">q</span> <span class="main">∧</span> <span class="free">m</span> <span class="main">=</span> Marker<span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">m'</span><span class="main">.</span> <span class="bound">ev</span> <span class="main">=</span> Recv <span class="free">i</span> <span class="bound">q</span> <span class="bound">p</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">m'</span> <span class="main">∧</span> <span class="free">m</span> <span class="main">=</span> Msg <span class="bound">m'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> trace <span class="free">c</span> <span class="free">t</span> <span class="free">c'</span><span class="main">;</span> <span class="free">m</span> <span class="main">:</span> set <span class="main">(</span>msgs <span class="free">c</span> <span class="free">i</span><span class="main">)</span><span class="main">;</span> <span class="var">?P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">:</span> set <span class="main">(</span>msgs <span class="free">c'</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">c'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>trace_rev_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tr_rev_init <span class="skolem">c</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tr_rev_step <span class="skolem">c</span> <span class="skolem">t</span> <span class="skolem">d</span> <span class="skolem">ev</span> <span class="skolem">c'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> m_in_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">:</span> set <span class="main">(</span>msgs <span class="skolem">d</span> <span class="free">i</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> tr_rev_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ev</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Snapshot <span class="skolem">r</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">using</span></span> distributed_system.message_must_be_delivered_2 distributed_system_axioms m_in_set tr_rev_step.hyps<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>RecvMarker <span class="skolem">i'</span> <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> Marker"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">≠</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> tr_rev_step RecvMarker <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
          <span class="keyword1"><span class="command">using</span></span> RecvMarker m_in_set message_must_be_delivered_2 tr_rev_step.hyps<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
          <span class="keyword1"><span class="command">using</span></span> RecvMarker tr_rev_step.hyps<span class="main">(</span>3<span class="main">)</span> m_in_set message_must_be_delivered_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Trans <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">u'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">using</span></span> tr_rev_step.hyps<span class="main">(</span>3<span class="main">)</span> m_in_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Send <span class="skolem">i'</span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">using</span></span> distributed_system.message_must_be_delivered_2 distributed_system_axioms m_in_set tr_rev_step.hyps<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Recv <span class="skolem">i'</span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Msg <span class="skolem">m'</span> <span class="main">=</span> <span class="free">m</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">≠</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Recv tr_rev_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
          <span class="keyword1"><span class="command">using</span></span> Recv m_in_set tr_rev_step<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Recv event.distinct<span class="main"><span class="main">(</span></span>17<span class="main"><span class="main">)</span></span> event.inject<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> m_in_set message_must_be_delivered_2 tr_rev_step.hyps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">:</span> set <span class="main">(</span>msgs <span class="free">c'</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹<span class="var">?P</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> marker_must_be_delivered_2_trace<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">c</span> <span class="free">t</span> <span class="free">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"Marker <span class="main">:</span> set <span class="main">(</span>msgs <span class="free">c</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="free">c'</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ev</span> <span class="main">∈</span> set <span class="free">t</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="bound">ev</span> <span class="main">=</span> RecvMarker <span class="free">i</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ev</span> <span class="main">∈</span> set <span class="free">t</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="bound">ev</span> <span class="main">=</span> RecvMarker <span class="free">i</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms message_must_be_delivered_2_trace <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> snapshot_stable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> trace <span class="free">c</span> <span class="free">t</span> <span class="free">c'</span><span class="main">;</span>
       has_snapshotted <span class="free">c</span> <span class="free">p</span>
     <span class="main">⟧</span> <span class="main">⟹</span> has_snapshotted <span class="free">c'</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">c'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>trace_rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tr_rev_init <span class="skolem">c</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tr_rev_step <span class="skolem">c</span> <span class="skolem">t</span> <span class="skolem">c'</span> <span class="skolem">ev</span> <span class="skolem">c''</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ev</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Snapshot <span class="skolem">q</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> tr_rev_step next_snapshot can_occur_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Snapshot tr_rev_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>RecvMarker <span class="skolem">i</span> <span class="skolem">q</span> <span class="skolem">r</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> tr_rev_step <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="skolem">q</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> snapshot_stable_2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">c</span> <span class="free">t</span> <span class="free">c'</span> <span class="main">⟹</span> <span class="main">~</span> has_snapshotted <span class="free">c'</span> <span class="free">p</span> <span class="main">⟹</span> <span class="main">~</span> has_snapshotted <span class="free">c</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> snapshot_stable <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> no_markers_if_all_snapshotted<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> trace <span class="free">c</span> <span class="free">t</span> <span class="free">c'</span><span class="main">;</span>
      <span class="main">∀</span><span class="bound">p</span><span class="main">.</span> has_snapshotted <span class="free">c</span> <span class="bound">p</span><span class="main">;</span>
      Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="free">c</span> <span class="free">i</span><span class="main">)</span>
     <span class="main">⟧</span> <span class="main">⟹</span> Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="free">c'</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">c'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>trace_rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tr_rev_init <span class="skolem">c</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tr_rev_step <span class="skolem">c</span> <span class="skolem">t</span> <span class="skolem">c'</span> <span class="skolem">ev</span> <span class="skolem">c''</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> all_snapshotted<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> has_snapshotted <span class="skolem">c'</span> <span class="bound">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> snapshot_stable tr_rev_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> no_marker<span class="main">:</span> <span class="quoted"><span class="quoted">"Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="skolem">c'</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> tr_rev_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ev</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Snapshot <span class="skolem">r</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> can_occur_def tr_rev_step all_snapshotted <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>RecvMarker <span class="skolem">i'</span> <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">≠</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="skolem">i'</span> <span class="main">≠</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">:</span> set <span class="main">(</span>msgs <span class="skolem">c</span> <span class="free">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> can_occur_def RecvMarker tr_rev_step  RecvMarker_implies_Marker_in_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> tr_rev_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> tr_rev_step all_snapshotted no_marker RecvMarker <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Trans <span class="skolem">p</span> <span class="skolem">s</span> <span class="skolem">s'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> tr_rev_step no_marker <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
   <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Send <span class="skolem">i'</span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span><span class="main">)</span>
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
   <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">=</span> <span class="free">i</span>"</span></span><span class="main">)</span>
     <span class="keyword3"><span class="command">case</span></span> True
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="skolem">c''</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="skolem">c'</span> <span class="free">i</span> <span class="main">@</span> <span class="main">[</span>Msg <span class="skolem">m</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> tr_rev_step Send <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> no_marker <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">next</span></span>
     <span class="keyword3"><span class="command">case</span></span> False
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Send tr_rev_step no_marker <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Recv <span class="skolem">i'</span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="skolem">c''</span> <span class="free">i</span> <span class="main">=</span> tl <span class="main">(</span>msgs <span class="skolem">c'</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> tr_rev_step Recv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> no_marker <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> list.set_sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Recv tr_rev_step no_marker <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> event_stays_valid_if_no_occurrence_trace<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> trace <span class="free">c</span> <span class="free">t</span> <span class="free">c'</span><span class="main">;</span>
       list_all <span class="main">(</span><span class="main">λ</span><span class="bound">ev</span><span class="main">.</span> occurs_on <span class="bound">ev</span> <span class="main">≠</span> occurs_on <span class="free">ev'</span><span class="main">)</span> <span class="free">t</span><span class="main">;</span>
       can_occur <span class="free">ev'</span> <span class="free">c</span>
     <span class="main">⟧</span> <span class="main">⟹</span> can_occur <span class="free">ev'</span> <span class="free">c'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">c'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>trace_rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> tr_rev_init
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> tr_rev_step
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> event_stays_valid_if_no_occurrence <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> event_can_go_back_if_no_sender_trace<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> trace <span class="free">c</span> <span class="free">t</span> <span class="free">c'</span><span class="main">;</span>
       list_all <span class="main">(</span><span class="main">λ</span><span class="bound">ev</span><span class="main">.</span> occurs_on <span class="bound">ev</span> <span class="main">≠</span> occurs_on <span class="free">ev'</span><span class="main">)</span> <span class="free">t</span><span class="main">;</span>
       can_occur <span class="free">ev'</span> <span class="free">c'</span><span class="main">;</span>
       <span class="main">~</span> isRecvMarker <span class="free">ev'</span><span class="main">;</span>
       list_all <span class="main">(</span><span class="main">λ</span><span class="bound">ev</span><span class="main">.</span> <span class="main">~</span> isSend <span class="bound">ev</span><span class="main">)</span> <span class="free">t</span>
     <span class="main">⟧</span> <span class="main">⟹</span> can_occur <span class="free">ev'</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">c'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>trace_rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> tr_rev_init
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> tr_rev_step
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> event_can_go_back_if_no_sender <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> done_only_from_recv_marker_trace<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">c</span> <span class="free">t</span> <span class="free">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="free">c</span> <span class="free">cid</span><span class="main">)</span> <span class="main">≠</span> Done"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="free">c'</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> Done"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"RecvMarker <span class="free">cid</span> <span class="free">q</span> <span class="free">p</span> <span class="main">∈</span> set <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> RecvMarker <span class="free">cid</span> <span class="free">q</span> <span class="free">p</span> <span class="main">∈</span> set <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> trace <span class="free">c</span> <span class="free">t</span> <span class="free">c'</span><span class="main">;</span> <span class="main">~</span> RecvMarker <span class="free">cid</span> <span class="free">q</span> <span class="free">p</span> <span class="main">∈</span> set <span class="free">t</span><span class="main">;</span> snd <span class="main">(</span>cs <span class="free">c</span> <span class="free">cid</span><span class="main">)</span> <span class="main">≠</span> Done<span class="main">;</span> <span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span> <span class="main">⟧</span>
                 <span class="main">⟹</span> snd <span class="main">(</span>cs <span class="free">c'</span> <span class="free">cid</span><span class="main">)</span> <span class="main">≠</span> Done"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>rev_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.discI trace.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">ev</span> <span class="skolem">t</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> ind<span class="main">:</span> <span class="quoted"><span class="quoted">"trace <span class="free">c</span> <span class="skolem">t</span> <span class="skolem">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">⊢</span> <span class="skolem">ev</span> <span class="main">↦</span> <span class="skolem">c'</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> trace_decomp_tail <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="skolem">d</span> <span class="free">cid</span><span class="main">)</span> <span class="main">≠</span> Done"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> RecvMarker <span class="free">cid</span> <span class="free">q</span> <span class="free">p</span> <span class="main">∈</span> set <span class="skolem">t</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> snoc.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> snoc ind <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> done_only_from_recv_marker local.step snoc.prems<span class="main">(</span>2<span class="main">)</span> snoc.prems<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="free">c'</span> <span class="free">cid</span><span class="main">)</span> <span class="main">≠</span> Done"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cs_not_not_started_stable_trace<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> trace <span class="free">c</span> <span class="free">t</span> <span class="free">c'</span><span class="main">;</span> snd <span class="main">(</span>cs <span class="free">c</span> <span class="free">cid</span><span class="main">)</span> <span class="main">≠</span> NotStarted<span class="main">;</span> <span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> snd <span class="main">(</span>cs <span class="free">c'</span> <span class="free">cid</span><span class="main">)</span> <span class="main">≠</span> NotStarted"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">c'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.discI trace.simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">ev</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> tr<span class="main">:</span> <span class="quoted"><span class="quoted">"trace <span class="free">c</span> <span class="skolem">t</span> <span class="skolem">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">⊢</span> <span class="skolem">ev</span> <span class="main">↦</span> <span class="skolem">c'</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> trace_decomp_tail <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="skolem">d</span> <span class="free">cid</span><span class="main">)</span> <span class="main">≠</span> NotStarted"</span></span> <span class="keyword1"><span class="command">using</span></span> snoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> cs_not_not_started_stable snoc step <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> no_messages_introduced_if_no_channel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    trace<span class="main">:</span> <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    no_msgs_if_no_channel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">channel</span> <span class="bound">i</span> <span class="main">=</span> None <span class="main">⟶</span> msgs <span class="free">init</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> None <span class="main">⟹</span> msgs <span class="main">(</span>s <span class="free">init</span> <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms exists_trace_for_any_i no_msgs_if_no_channel take0 tr_init trace_and_start_determines_end<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"trace <span class="main">(</span>s <span class="free">init</span> <span class="free">t</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span><span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>drop <span class="skolem">n</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>s <span class="free">init</span> <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> exists_trace_for_any_i_j order_le_less trace assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"drop <span class="skolem">n</span> <span class="free">t</span> <span class="main">=</span> Nil"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc.hyps Suc.prems
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> f tr_init trace_and_start_determines_end take_Nil<span class="main">)</span> 
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> suc_n_minus_n<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span> <span class="main">-</span> <span class="skolem">n</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>take <span class="main">(</span><span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>drop <span class="skolem">n</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ev</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ev</span> <span class="main">#</span> Nil <span class="main">=</span> take <span class="main">(</span><span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>drop <span class="skolem">n</span> <span class="free">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> False One_nat_def suc_n_minus_n length_greater_0_conv self_append_conv2 take_eq_Nil take_hd_drop<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>s <span class="free">init</span> <span class="free">t</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">⊢</span> <span class="skolem">ev</span> <span class="main">↦</span> <span class="main">(</span>s <span class="free">init</span> <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> f tr_init trace_and_start_determines_end trace_decomp_head<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ev</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Snapshot <span class="skolem">r</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">using</span></span> Suc.hyps Suc.prems g <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>RecvMarker <span class="skolem">cid'</span> <span class="skolem">sr</span> <span class="skolem">r</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cid'</span> <span class="main">≠</span> <span class="free">cid</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> RecvMarker can_occur_def g Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> RecvMarker Suc g <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>s <span class="free">init</span> <span class="free">t</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">sr</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Trans <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">u'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc.hyps Suc.prems g next_trans<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Send <span class="skolem">cid'</span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cid'</span> <span class="main">≠</span> <span class="free">cid</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Send can_occur_def g Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc g Send <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Recv <span class="skolem">cid'</span> <span class="skolem">s</span> <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cid'</span> <span class="main">≠</span> <span class="free">cid</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Recv can_occur_def g Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc g Recv <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context distributed_system *)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* theory Trace *)</span>
</pre>
</div><div id="Util">
<div class="head">
<h1>Theory Util</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Utilties›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Util
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="../../HOL/HOL/Main.html">Main</a>
    <span class="quoted">"<a href="../../HOL/HOL-Library/Sublist.html">HOL-Library.Sublist</a>"</span>
    <span class="quoted">"<a href="../../HOL/HOL-Library/Permutation.html">HOL-Library.Permutation</a>"</span>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">swap_events</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">swap_events</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> take <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">]</span> <span class="main">@</span> take <span class="main">(</span><span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">-</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">@</span> drop <span class="main">(</span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> swap_neighbors_2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">+</span><span class="main">1</span> <span class="main">&lt;</span> length <span class="free">t</span> <span class="main">⟹</span> swap_events <span class="free">i</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="free">t</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="free">t</span> <span class="main">!</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">[</span><span class="free">i</span><span class="main">+</span><span class="main">1</span> <span class="main">:=</span> <span class="free">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_eq_plus1 add_lessD1 append.left_neutral append_Cons cancel_comm_monoid_add_class.diff_cancel drop_update_cancel length_list_update numeral_One take_0 take_Cons_numeral upd_conv_take_nth_drop zero_less_Suc<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"tl <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> hd <span class="skolem">t</span> <span class="main">#</span> <span class="var">?t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc.prems hd_Cons_tl list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> not_less_zero<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"swap_events <span class="skolem">n</span> <span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="var">?t</span> <span class="main">=</span> <span class="main">(</span><span class="var">?t</span><span class="main">[</span><span class="skolem">n</span> <span class="main">:=</span> <span class="var">?t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">[</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span> <span class="main">:=</span> <span class="var">?t</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">]</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc.hyps Suc.prems Suc_eq_plus1 length_tl less_diff_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 append_Cons diff_self_eq_0 drop_Suc_Cons list_update_code<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> nth_Cons_Suc take_Suc_Cons<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> swap_identical_length<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"length <span class="free">t</span> <span class="main">=</span> length <span class="main">(</span>swap_events <span class="free">i</span> <span class="free">j</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>take <span class="free">i</span> <span class="free">t</span> <span class="main">@</span> <span class="main">[</span><span class="free">t</span> <span class="main">!</span> <span class="free">j</span><span class="main">,</span> <span class="free">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span> <span class="main">@</span> take <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>
      <span class="main">=</span> length <span class="main">(</span>take <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="main">+</span> length <span class="main">[</span><span class="free">t</span> <span class="main">!</span> <span class="free">j</span><span class="main">,</span> <span class="free">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span> <span class="main">+</span> length <span class="main">(</span>take <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">j</span><span class="main">+</span><span class="main">1</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> swap_identical_heads<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"take <span class="free">i</span> <span class="free">t</span> <span class="main">=</span> take <span class="free">i</span> <span class="main">(</span>swap_events <span class="free">i</span> <span class="free">j</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> swap_identical_tails<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"drop <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> drop <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>swap_events <span class="free">i</span> <span class="free">j</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>take <span class="free">i</span> <span class="free">t</span> <span class="main">@</span> <span class="main">[</span><span class="free">t</span> <span class="main">!</span> <span class="free">j</span><span class="main">,</span> <span class="free">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span> <span class="main">@</span> take <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>
      <span class="main">=</span> length <span class="main">(</span>take <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="main">+</span> length <span class="main">[</span><span class="free">t</span> <span class="main">!</span> <span class="free">j</span><span class="main">,</span> <span class="free">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span> <span class="main">+</span> length <span class="main">(</span>take <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">j</span><span class="main">+</span><span class="main">1</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹length <span class="main">(</span>take <span class="free">i</span> <span class="free">t</span> <span class="main">@</span> <span class="main">[</span><span class="free">t</span> <span class="main">!</span> <span class="free">j</span><span class="main">,</span> <span class="free">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span> <span class="main">@</span> take <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>take <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="main">+</span> length <span class="main">[</span><span class="free">t</span> <span class="main">!</span> <span class="free">j</span><span class="main">,</span> <span class="free">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span> <span class="main">+</span> length <span class="main">(</span>take <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>›</span></span> append.assoc append_eq_conv_conj<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> swap_neighbors<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">+</span><span class="main">1</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">l</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">[</span><span class="free">i</span><span class="main">+</span><span class="main">1</span> <span class="main">:=</span> <span class="free">l</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span> <span class="main">=</span> take <span class="free">i</span> <span class="free">l</span> <span class="main">@</span> <span class="main">[</span><span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">,</span> <span class="free">l</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span> <span class="main">@</span> drop <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span> <span class="free">l</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def add.left_neutral add_lessD1 append_Cons append_Nil drop_update_cancel length_list_update one_add_one plus_1_eq_Suc take0 take_Suc_Cons upd_conv_take_nth_drop zero_less_two<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"tl <span class="skolem">l</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l</span><span class="main">[</span>Suc <span class="skolem">n</span> <span class="main">:=</span> <span class="skolem">l</span> <span class="main">!</span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">[</span>Suc <span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span> <span class="main">:=</span> <span class="skolem">l</span> <span class="main">!</span> Suc <span class="skolem">n</span><span class="main">]</span> <span class="main">=</span> hd <span class="skolem">l</span> <span class="main">#</span> <span class="main">(</span><span class="var">?l</span><span class="main">[</span><span class="skolem">n</span> <span class="main">:=</span> <span class="var">?l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">[</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span> <span class="main">:=</span> <span class="var">?l</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc.prems add.commute add_less_same_cancel2 list.collapse list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list_update_code<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> not_add_less2 nth_Cons_Suc plus_1_eq_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="var">?l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?l</span><span class="main">[</span><span class="skolem">n</span> <span class="main">:=</span> <span class="var">?l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">[</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span> <span class="main">:=</span> <span class="var">?l</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">]</span> <span class="main">=</span> take <span class="skolem">n</span> <span class="var">?l</span> <span class="main">@</span> <span class="main">[</span><span class="var">?l</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">,</span> <span class="var">?l</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">]</span> <span class="main">@</span> drop <span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span> <span class="var">?l</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc.hyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> swap_events_perm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"perm <span class="main">(</span>swap_events <span class="free">i</span> <span class="free">j</span> <span class="free">t</span><span class="main">)</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> swap<span class="main">:</span> <span class="quoted"><span class="quoted">"swap_events <span class="free">i</span> <span class="free">j</span> <span class="free">t</span>
      <span class="main">=</span> take <span class="free">i</span> <span class="free">t</span> <span class="main">@</span> <span class="main">[</span><span class="free">t</span> <span class="main">!</span> <span class="free">j</span><span class="main">,</span> <span class="free">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span> <span class="main">@</span> <span class="main">(</span>take <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>drop <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> reg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> take <span class="free">i</span> <span class="free">t</span> <span class="main">@</span> <span class="main">(</span>take <span class="main">(</span><span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>drop <span class="free">i</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> drop <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">t</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_diff_inverse_nat add_lessD1 append.assoc append_take_drop_id assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> less_imp_add_positive less_not_refl take_add<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"perm <span class="main">(</span>take <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>take <span class="free">i</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"perm <span class="main">(</span>drop <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"perm <span class="main">(</span><span class="main">[</span><span class="free">t</span> <span class="main">!</span> <span class="free">j</span><span class="main">,</span> <span class="free">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span> <span class="main">@</span> <span class="main">(</span>take <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span><span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>drop <span class="free">i</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span><span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>drop <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span> <span class="main">!</span> <span class="free">i</span> <span class="main">#</span> <span class="var">?l</span> <span class="main">@</span> <span class="main">[</span><span class="free">t</span> <span class="main">!</span> <span class="free">j</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="free">j</span> <span class="main">-</span> Suc <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">j</span> <span class="main">-</span> <span class="free">i</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Suc_diff_Suc assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">have</span></span> f3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">-</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="free">j</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> discrete le_add_diff_inverse2<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> drop <span class="free">j</span> <span class="free">t</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> drop_drop<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> f3 f2 f1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Cons_nth_drop_Suc Suc_diff_le Suc_eq_plus1 assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> hd_drop_conv_nth length_drop less_diff_conv nat_less_le take_Suc_Cons take_hd_drop<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> mset_eq_perm <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> swap reg 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append.assoc perm_append1 perm_append2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sum_eq_if_same_subterms<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">i</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">i</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟶</span> <span class="free">f</span> <span class="bound">k</span> <span class="main">=</span> <span class="free">f'</span> <span class="bound">k</span> <span class="main">⟹</span> sum <span class="free">f</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">}</span> <span class="main">=</span> sum <span class="free">f'</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> filter_neq_takeWhile<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">(≠)</span> <span class="free">a</span><span class="main">)</span> <span class="free">l</span> <span class="main">≠</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> <span class="free">a</span><span class="main">)</span> <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">j</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">a</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">≠</span> <span class="free">a</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="var">?P</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">j</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">⟶</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">≠</span> <span class="free">a</span> <span class="main">∨</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">a</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">(≠)</span> <span class="free">a</span><span class="main">)</span> <span class="free">l</span> <span class="main">=</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> <span class="free">a</span><span class="main">)</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">:</span> set <span class="free">l</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">⟶</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">≠</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> False filter_True takeWhile_eq_all_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ex_j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">a</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?j</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Min <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">a</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> fin_j<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">a</span><span class="main">}</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> finite_nat_set_iff_bounded <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">a</span><span class="main">}</span> <span class="main">≠</span> empty"</span></span> <span class="keyword1"><span class="command">using</span></span> ex_j <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?j</span> <span class="main">&lt;</span> length <span class="free">l</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Min_less_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> tail_all_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">≥</span> <span class="var">?j</span> <span class="main">⟶</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="skolem">j</span> <span class="main">≥</span> <span class="var">?j</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="var">?Q</span><span class="main">;</span> <span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="skolem">j</span> <span class="main">≥</span> <span class="var">?j</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≥</span> <span class="var">?j</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> <span class="skolem">j</span> <span class="main">⟶</span> <span class="free">l</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">-</span> <span class="var">?j</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> 0
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="var">?j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
          <span class="keyword1"><span class="command">using</span></span> Min_in <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">a</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span> fin_j <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≥</span> <span class="var">?j</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="skolem">j</span> <span class="main">⟶</span> <span class="free">l</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> <span class="free">a</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Min_in <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">a</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span> fin_j le_eq_less_or_eq mem_Collect_eq<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
          <span class="keyword1"><span class="command">using</span></span> Suc.hyps<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> asm <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> head_all_not_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="var">?j</span> <span class="main">⟶</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">≠</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> asm calculation 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Min_le <span class="quoted"><span class="quoted">‹Min <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">a</span><span class="main">}</span> <span class="main">&lt;</span> length <span class="free">l</span>›</span></span> fin_j leD less_trans mem_Collect_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"takeWhile <span class="main">(</span><span class="main">(≠)</span> <span class="free">a</span><span class="main">)</span> <span class="free">l</span> <span class="main">=</span> take <span class="var">?j</span> <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>takeWhile <span class="main">(</span><span class="main">(≠)</span> <span class="free">a</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> <span class="var">?j</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>takeWhile <span class="main">(</span><span class="main">(≠)</span> <span class="free">a</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?j</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?S</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">!</span> <span class="var">?j</span> <span class="main">≠</span> <span class="free">a</span>"</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> not_le_imp_less nth_mem set_takeWhileD takeWhile_nth<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> 
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Min <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">a</span><span class="main">}</span> <span class="main">&lt;</span> length <span class="free">l</span>›</span></span> tail_all_a <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>takeWhile <span class="main">(</span><span class="main">(≠)</span> <span class="free">a</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="main">≥</span> <span class="var">?j</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?T</span></span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?T</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="var">?j</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">a</span>"</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹Min <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">a</span><span class="main">}</span> <span class="main">&lt;</span> length <span class="free">l</span>›</span></span> calculation le_less_trans not_le_imp_less nth_length_takeWhile<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> 
            <span class="keyword1"><span class="command">using</span></span> head_all_not_a <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>take <span class="var">?j</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> <span class="var">?j</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> calculation takeWhile_eq_take<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> takeWhile_eq_take<span class="main">)</span>

    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">(≠)</span> <span class="free">a</span><span class="main">)</span> <span class="free">l</span> <span class="main">=</span> take <span class="var">?j</span> <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">(≠)</span> <span class="free">a</span><span class="main">)</span> <span class="free">l</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">(≠)</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span>take <span class="var">?j</span> <span class="free">l</span><span class="main">)</span> <span class="main">@</span> filter <span class="main">(</span><span class="main">(≠)</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span>drop <span class="var">?j</span> <span class="free">l</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_take_drop_id filter_append<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">(≠)</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span>take <span class="var">?j</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> take <span class="var">?j</span> <span class="free">l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> head_all_not_a 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹takeWhile <span class="main">(</span><span class="main">(≠)</span> <span class="free">a</span><span class="main">)</span> <span class="free">l</span> <span class="main">=</span> take <span class="main">(</span>Min <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">a</span><span class="main">}</span><span class="main">)</span> <span class="free">l</span>›</span></span> filter_id_conv set_takeWhileD<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">(≠)</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span>drop <span class="var">?j</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≥</span> <span class="var">?j</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">⟶</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> drop <span class="var">?j</span> <span class="free">l</span> <span class="main">!</span> <span class="main">(</span><span class="bound">j</span> <span class="main">-</span> <span class="var">?j</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">-</span> <span class="var">?j</span> <span class="main">⟶</span> drop <span class="var">?j</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> tail_all_a 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Groups.add_ac<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹Min <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">a</span><span class="main">}</span> <span class="main">&lt;</span> length <span class="free">l</span>›</span></span> less_diff_conv less_imp_le_nat not_add_less2 not_le nth_drop<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">aa</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
            <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x0</span> <span class="bound">x1</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v2</span><span class="main">.</span> <span class="bound">v2</span> <span class="main">∈</span> set <span class="bound">x1</span> <span class="main">∧</span> <span class="bound">x0</span> <span class="bound">v2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">aa</span> <span class="bound">x0</span> <span class="bound">x1</span> <span class="main">∈</span> set <span class="bound">x1</span> <span class="main">∧</span> <span class="bound">x0</span> <span class="main">(</span><span class="skolem">aa</span> <span class="bound">x0</span> <span class="bound">x1</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">moura</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">as</span> <span class="bound">p</span><span class="main">.</span> <span class="skolem">aa</span> <span class="bound">p</span> <span class="bound">as</span> <span class="main">∈</span> set <span class="bound">as</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">(</span><span class="skolem">aa</span> <span class="bound">p</span> <span class="bound">as</span><span class="main">)</span> <span class="main">∨</span> filter <span class="bound">p</span> <span class="bound">as</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> filter_False<span class="main">)</span>
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">nn</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
            f2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x0</span> <span class="bound">x1</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">v2</span></span><span class="main">&lt;</span>length <span class="bound">x0</span><span class="main">.</span> <span class="bound">x0</span> <span class="main">!</span> <span class="bound">v2</span> <span class="main">=</span> <span class="bound">x1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">nn</span> <span class="bound">x0</span> <span class="bound">x1</span> <span class="main">&lt;</span> length <span class="bound">x0</span> <span class="main">∧</span> <span class="bound">x0</span> <span class="main">!</span> <span class="skolem">nn</span> <span class="bound">x0</span> <span class="bound">x1</span> <span class="main">=</span> <span class="bound">x1</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">moura</span>
          <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span>Min <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">a</span><span class="main">}</span><span class="main">)</span> <span class="free">l</span> <span class="main">!</span> <span class="skolem">nn</span> <span class="main">(</span>drop <span class="main">(</span>Min <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">a</span><span class="main">}</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="main">(</span><span class="skolem">aa</span> <span class="main">(</span><span class="main">(≠)</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>Min <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">a</span><span class="main">}</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">(≠)</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>Min <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">a</span><span class="main">}</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> <span class="main">¬</span> <span class="skolem">nn</span> <span class="main">(</span>drop <span class="main">(</span>Min <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">a</span><span class="main">}</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="main">(</span><span class="skolem">aa</span> <span class="main">(</span><span class="main">(≠)</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>Min <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">a</span><span class="main">}</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="main">(</span>drop <span class="main">(</span>Min <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">a</span><span class="main">}</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="main">∨</span> drop <span class="main">(</span>Min <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">a</span><span class="main">}</span><span class="main">)</span> <span class="free">l</span> <span class="main">!</span> <span class="skolem">nn</span> <span class="main">(</span>drop <span class="main">(</span>Min <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">a</span><span class="main">}</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="main">(</span><span class="skolem">aa</span> <span class="main">(</span><span class="main">(≠)</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>Min <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">a</span><span class="main">}</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="skolem">aa</span> <span class="main">(</span><span class="main">(≠)</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>Min <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">a</span><span class="main">}</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> f1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">nn</span> <span class="main">(</span>drop <span class="main">(</span>Min <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">a</span><span class="main">}</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="main">(</span><span class="skolem">aa</span> <span class="main">(</span><span class="main">(≠)</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>Min <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">a</span><span class="main">}</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">-</span> Min <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">a</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">nn</span> <span class="main">(</span>drop <span class="main">(</span>Min <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">a</span><span class="main">}</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="main">(</span><span class="skolem">aa</span> <span class="main">(</span><span class="main">(≠)</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>Min <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">a</span><span class="main">}</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="main">(</span>drop <span class="main">(</span>Min <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">a</span><span class="main">}</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="main">∨</span> drop <span class="main">(</span>Min <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">a</span><span class="main">}</span><span class="main">)</span> <span class="free">l</span> <span class="main">!</span> <span class="skolem">nn</span> <span class="main">(</span>drop <span class="main">(</span>Min <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">a</span><span class="main">}</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="main">(</span><span class="skolem">aa</span> <span class="main">(</span><span class="main">(≠)</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>Min <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">a</span><span class="main">}</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="skolem">aa</span> <span class="main">(</span><span class="main">(≠)</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>Min <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">a</span><span class="main">}</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">(≠)</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>Min <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">a</span><span class="main">}</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> <span class="main">¬</span> <span class="skolem">nn</span> <span class="main">(</span>drop <span class="main">(</span>Min <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">a</span><span class="main">}</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="main">(</span><span class="skolem">aa</span> <span class="main">(</span><span class="main">(≠)</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>Min <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">a</span><span class="main">}</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="main">(</span>drop <span class="main">(</span>Min <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">a</span><span class="main">}</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="main">∨</span> drop <span class="main">(</span>Min <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">a</span><span class="main">}</span><span class="main">)</span> <span class="free">l</span> <span class="main">!</span> <span class="skolem">nn</span> <span class="main">(</span>drop <span class="main">(</span>Min <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">a</span><span class="main">}</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="main">(</span><span class="skolem">aa</span> <span class="main">(</span><span class="main">(≠)</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>Min <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">a</span><span class="main">}</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="skolem">aa</span> <span class="main">(</span><span class="main">(≠)</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>Min <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">a</span><span class="main">}</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span>length <span class="free">l</span> <span class="main">-</span> Min <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">a</span><span class="main">}</span><span class="main">.</span> drop <span class="main">(</span>Min <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">a</span><span class="main">}</span><span class="main">)</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">a</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> f2 f1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> in_set_conv_nth<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> util_exactly_one_element<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">∉</span> set <span class="free">l</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">l'</span> <span class="main">=</span> <span class="free">l</span> <span class="main">@</span> <span class="main">[</span><span class="free">m</span><span class="main">]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">l'</span> <span class="main">∧</span> <span class="free">l'</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">m</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">l'</span> <span class="main">-</span> <span class="main">1</span> <span class="main">⟶</span> <span class="free">l'</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">≠</span> <span class="free">m</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> butlast_snoc length_butlast nth_append nth_mem<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> one_j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">l'</span> <span class="main">∧</span> <span class="free">l'</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">m</span> <span class="main">⟶</span> <span class="bound">j</span> <span class="main">=</span> <span class="main">(</span>length <span class="free">l'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> diff_Suc_1 lessE<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="var">?P</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">l'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">l'</span>"</span></span>
                          <span class="quoted"><span class="quoted">"<span class="free">l'</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l'</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> one_j <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> exists_one_iff_filter_one<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃!</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">a</span><span class="main">)</span> <span class="main">⟷</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">(=)</span> <span class="free">a</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≠</span> <span class="skolem">j</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">⟶</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">≠</span> <span class="free">a</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃!</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">a</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">l</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> <span class="free">a</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">=</span> take <span class="skolem">j</span> <span class="free">l</span> <span class="main">@</span> <span class="main">[</span><span class="free">l</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span> <span class="main">@</span> drop <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">l</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons_eq_appendI Cons_nth_drop_Suc Suc_eq_plus1 append_self_conv2 append_take_drop_id calculation<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> calculation<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">(=)</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span>take <span class="skolem">j</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> length <span class="main">(</span>take <span class="skolem">j</span> <span class="free">l</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>take <span class="skolem">j</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">≠</span> <span class="free">a</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> calculation<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> filter_False in_set_conv_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">(=)</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> length <span class="main">(</span>drop <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>drop <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">≠</span> <span class="free">a</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> calculation<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> filter_False in_set_conv_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>filter <span class="main">(</span><span class="main">(=)</span> <span class="free">a</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> One_nat_def Suc_eq_plus1 append_Cons append_self_conv2 filter.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> filter_append list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list.size<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>filter <span class="main">(</span><span class="main">(=)</span> <span class="free">a</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">(=)</span> <span class="free">a</span><span class="main">)</span> <span class="free">l</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">(=)</span> <span class="free">a</span><span class="main">)</span> <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="var">?xs</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> asm <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> Cons_eq_filterD One_nat_def length_0_conv length_Suc_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">a</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> filter_False in_set_conv_nth list.discI<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≠</span> <span class="skolem">j</span> <span class="main">⟶</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">≠</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="skolem">k</span> <span class="main">≠</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">≠</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> lka<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">l</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">≠</span> <span class="free">a</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">l</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ys</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">l</span>"</span></span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>filter <span class="main">(</span><span class="main">(=)</span> <span class="free">a</span><span class="main">)</span> <span class="var">?xs</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> add.commute assm discrete filter_empty_conv length_greater_0_conv length_take less_add_one lka min.absorb2 nth_mem nth_take<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>filter <span class="main">(</span><span class="main">(=)</span> <span class="free">a</span><span class="main">)</span> <span class="var">?ys</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ys</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">l</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> True assm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="var">?ys</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> True <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">l</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> <span class="free">a</span>›</span></span> filter_empty_conv length_greater_0_conv nth_mem<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?xs</span> <span class="main">@</span> <span class="var">?ys</span> <span class="main">=</span> <span class="free">l</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> append_take_drop_id <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>filter <span class="main">(</span><span class="main">(=)</span> <span class="free">a</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> One_nat_def Suc_eq_plus1 asm filter_append length_append less_add_eq_less less_one nat_neq_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> asm <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">l</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ys</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">l</span>"</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>filter <span class="main">(</span><span class="main">(=)</span> <span class="free">a</span><span class="main">)</span> <span class="var">?xs</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> add.commute j discrete filter_empty_conv length_greater_0_conv length_take less_add_one min.absorb2 nth_mem nth_take<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>filter <span class="main">(</span><span class="main">(=)</span> <span class="free">a</span><span class="main">)</span> <span class="var">?ys</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ys</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">l</span> <span class="main">!</span> <span class="skolem">k</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> False assm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="var">?ys</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> False assm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> filter_empty_conv length_greater_0_conv lka nth_mem<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?xs</span> <span class="main">@</span> <span class="var">?ys</span> <span class="main">=</span> <span class="free">l</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> append_take_drop_id <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>filter <span class="main">(</span><span class="main">(=)</span> <span class="free">a</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> One_nat_def Suc_eq_plus1 asm filter_append length_append less_add_eq_less less_one nat_neq_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> asm <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">l</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Swap">
<div class="head">
<h1>Theory Swap</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Swap lemmas›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Swap
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="Distributed_System.html">Distributed_System</a>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> distributed_system

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> swap_msgs_Trans_Trans<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isTrans <span class="free">ev</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isTrans <span class="free">ev'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">d'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d'</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">e'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span> <span class="main">≠</span> occurs_on <span class="free">ev'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"msgs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">e'</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev'</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> Trans <span class="var">?p</span> <span class="skolem">u</span> <span class="skolem">u'</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> event.collapse<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u''</span></span> <span class="skolem"><span class="skolem">u'''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ev'</span> <span class="main">=</span> Trans <span class="var">?q</span> <span class="skolem">u''</span> <span class="skolem">u'''</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> event.collapse<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">d'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d</span> <span class="free">i</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Trans_msg assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">e'</span> <span class="free">i</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Trans_msg assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> assms<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> swap_msgs_Send_Send<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isSend <span class="free">ev</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isSend <span class="free">ev'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">d'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d'</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">e'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span> <span class="main">≠</span> occurs_on <span class="free">ev'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"msgs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">e'</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev'</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> Send_ev<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> Send <span class="skolem">i'</span> <span class="var">?p</span> <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> event.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i''</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">u''</span></span> <span class="skolem"><span class="skolem">u'''</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="keyword2"><span class="keyword">where</span></span> Send_ev'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev'</span> <span class="main">=</span> Send <span class="skolem">i''</span> <span class="var">?q</span> <span class="skolem">s</span> <span class="skolem">u''</span> <span class="skolem">u'''</span> <span class="skolem">m'</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> event.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">≠</span> <span class="skolem">i''</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ev</span> <span class="main">=</span> Send <span class="skolem">i'</span> <span class="main">(</span>occurs_on <span class="free">ev</span><span class="main">)</span> <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ev'</span> <span class="main">=</span> Send <span class="skolem">i''</span> <span class="main">(</span>occurs_on <span class="free">ev'</span><span class="main">)</span> <span class="skolem">s</span> <span class="skolem">u''</span> <span class="skolem">u'''</span> <span class="skolem">m'</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> can_occur_def event.simps<span class="main"><span class="main">(</span></span>27<span class="main"><span class="main">)</span></span> happen_implies_can_occur option.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> prod.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span> <span class="main">∨</span> <span class="free">i</span> <span class="main">=</span> <span class="skolem">i''</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span> <span class="main">@</span> <span class="main">[</span>Msg <span class="skolem">m</span><span class="main">]</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="free">ev</span> <span class="main">=</span> Send <span class="skolem">i'</span> <span class="main">(</span>occurs_on <span class="free">ev</span><span class="main">)</span> <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> next_send<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d</span> <span class="free">i</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="free">ev'</span> <span class="main">=</span> Send <span class="skolem">i''</span> <span class="main">(</span>occurs_on <span class="free">ev'</span><span class="main">)</span> <span class="skolem">s</span> <span class="skolem">u''</span> <span class="skolem">u'''</span> <span class="skolem">m'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≠</span> <span class="skolem">i''</span>›</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> event.sel<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> msgs_unchanged_for_other_is regular_event<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">d'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="free">ev'</span> <span class="main">=</span> Send <span class="skolem">i''</span> <span class="main">(</span>occurs_on <span class="free">ev'</span><span class="main">)</span> <span class="skolem">s</span> <span class="skolem">u''</span> <span class="skolem">u'''</span> <span class="skolem">m'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≠</span> <span class="skolem">i''</span>›</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> event.sel<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> msgs_unchanged_for_other_is regular_event<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">e'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d'</span> <span class="free">i</span> <span class="main">@</span> <span class="main">[</span>Msg <span class="skolem">m</span><span class="main">]</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="free">ev</span> <span class="main">=</span> Send <span class="skolem">i'</span> <span class="main">(</span>occurs_on <span class="free">ev</span><span class="main">)</span> <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>›</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> next_send<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">i''</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Send_ev <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≠</span> <span class="skolem">i''</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> event.sel<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> msgs_unchanged_for_other_is regular_event<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d</span> <span class="free">i</span> <span class="main">@</span> <span class="main">[</span>Msg <span class="skolem">m'</span><span class="main">]</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Send_ev' <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">=</span> <span class="skolem">i''</span>›</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> next_send<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">d'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span> <span class="main">@</span> <span class="main">[</span>Msg <span class="skolem">m'</span><span class="main">]</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Send_ev' <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">=</span> <span class="skolem">i''</span>›</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> next_send<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">e'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d'</span> <span class="free">i</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Send_ev <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">=</span> <span class="skolem">i''</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≠</span> <span class="skolem">i''</span>›</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> event.sel<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> msgs_unchanged_for_other_is regular_event<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Send_ev' assms 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> event.sel<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> msgs_unchanged_for_other_is regular_event<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> False Send_ev assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> event.sel<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> msgs_unchanged_for_other_is regular_event<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> msgs <span class="free">d'</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹msgs <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span>›</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> calculation regular_event same_messages_imply_same_resulting_messages<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> msgs <span class="free">e'</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹msgs <span class="free">c</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d'</span> <span class="free">i</span>›</span></span> <span class="quoted"><span class="quoted">‹msgs <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> regular_event same_messages_imply_same_resulting_messages<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> swap_msgs_Recv_Recv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isRecv <span class="free">ev</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isRecv <span class="free">ev'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">d'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d'</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">e'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span> <span class="main">≠</span> occurs_on <span class="free">ev'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"msgs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">e'</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev'</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> Recv_ev<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> Recv <span class="skolem">i'</span> <span class="var">?p</span> <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> event.collapse<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i''</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">u''</span></span> <span class="skolem"><span class="skolem">u'''</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="keyword2"><span class="keyword">where</span></span> Recv_ev'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev'</span> <span class="main">=</span> Recv <span class="skolem">i''</span> <span class="var">?q</span> <span class="skolem">s</span> <span class="skolem">u''</span> <span class="skolem">u'''</span> <span class="skolem">m'</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> event.collapse<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">≠</span> <span class="skolem">i''</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Recv_ev Recv_ev' assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> can_occur_Recv happen_implies_can_occur option.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> prod.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span> <span class="main">∨</span> <span class="free">i</span> <span class="main">=</span> <span class="skolem">i''</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Msg <span class="skolem">m</span> <span class="main">#</span> msgs <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Recv_ev assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> next_recv<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d</span> <span class="free">i</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Recv_ev' <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≠</span> <span class="skolem">i''</span>›</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> event.sel<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> msgs_unchanged_for_other_is regular_event<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">d'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Recv_ev' <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≠</span> <span class="skolem">i''</span>›</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> event.sel<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> msgs_unchanged_for_other_is regular_event<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Msg <span class="skolem">m</span> <span class="main">#</span> msgs <span class="free">e'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d'</span> <span class="free">i</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Recv_ev <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>›</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> next_recv<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.inject<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">i''</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Recv_ev <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≠</span> <span class="skolem">i''</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> event.sel<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> msgs_unchanged_for_other_is regular_event<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Msg <span class="skolem">m'</span> <span class="main">#</span> msgs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d</span> <span class="free">i</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Recv_ev' <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">=</span> <span class="skolem">i''</span>›</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> next_recv<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Msg <span class="skolem">m'</span> <span class="main">#</span> msgs <span class="free">d'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Recv_ev' <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">=</span> <span class="skolem">i''</span>›</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> next_recv<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">e'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d'</span> <span class="free">i</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Recv_ev <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">=</span> <span class="skolem">i''</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≠</span> <span class="skolem">i''</span>›</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> event.sel<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> msgs_unchanged_for_other_is regular_event<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.inject<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Recv_ev' assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> event.sel<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> msgs_unchanged_for_other_is regular_event<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> False Recv_ev assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> event.sel<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> msgs_unchanged_for_other_is regular_event<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> msgs <span class="free">d'</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹msgs <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span>›</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> calculation regular_event same_messages_imply_same_resulting_messages<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> msgs <span class="free">e'</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹msgs <span class="free">c</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d'</span> <span class="free">i</span>›</span></span> <span class="quoted"><span class="quoted">‹msgs <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> regular_event same_messages_imply_same_resulting_messages<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> swap_msgs_Send_Trans<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isSend <span class="free">ev</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isTrans <span class="free">ev'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">d'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d'</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">e'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span> <span class="main">≠</span> occurs_on <span class="free">ev'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"msgs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">e'</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev'</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> Send<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> Send <span class="skolem">i'</span> <span class="var">?p</span> <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> event.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u''</span></span> <span class="skolem"><span class="skolem">u'''</span></span> <span class="keyword2"><span class="keyword">where</span></span> Trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev'</span> <span class="main">=</span> Trans <span class="var">?q</span> <span class="skolem">u''</span> <span class="skolem">u'''</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> event.collapse<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span> <span class="main">@</span> <span class="main">[</span>Msg <span class="skolem">m</span><span class="main">]</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Send assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> next_send<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Trans_msg assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">d'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Trans_msg assms<span class="main">(</span>4<span class="main">)</span> assms<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">e'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d'</span> <span class="free">i</span> <span class="main">@</span> <span class="main">[</span>Msg <span class="skolem">m</span><span class="main">]</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Send True assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> next_send<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Trans_msg assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> False Send assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> event.sel<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> msgs_unchanged_for_other_is regular_event<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> msgs <span class="free">d'</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Trans_msg assms<span class="main">(</span>4<span class="main">)</span> assms<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> msgs <span class="free">e'</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹msgs <span class="free">c</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d'</span> <span class="free">i</span>›</span></span> <span class="quoted"><span class="quoted">‹msgs <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> regular_event same_messages_imply_same_resulting_messages<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> swap_msgs_Trans_Send<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isTrans <span class="free">ev</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isSend <span class="free">ev'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">d'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d'</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">e'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span> <span class="main">≠</span> occurs_on <span class="free">ev'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"msgs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">e'</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms swap_msgs_Send_Trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> swap_msgs_Recv_Trans<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isRecv <span class="free">ev</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isTrans <span class="free">ev'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">d'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d'</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">e'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span> <span class="main">≠</span> occurs_on <span class="free">ev'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"msgs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">e'</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev'</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> Recv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> Recv <span class="skolem">i'</span> <span class="var">?p</span> <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> event.collapse<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u''</span></span> <span class="skolem"><span class="skolem">u'''</span></span> <span class="keyword2"><span class="keyword">where</span></span> Trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev'</span> <span class="main">=</span> Trans <span class="var">?q</span> <span class="skolem">u''</span> <span class="skolem">u'''</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> event.collapse<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Msg <span class="skolem">m</span> <span class="main">#</span> msgs <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Recv assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> next_recv<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Trans_msg assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">d'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Trans_msg assms<span class="main">(</span>4<span class="main">)</span> assms<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Msg <span class="skolem">m</span> <span class="main">#</span> msgs <span class="free">e'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d'</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Recv True assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> next_recv<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.inject<span class="main">)</span> 
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Trans_msg assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> False Recv assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> event.sel<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> msgs_unchanged_for_other_is regular_event<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> msgs <span class="free">d'</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Trans_msg assms<span class="main">(</span>4<span class="main">)</span> assms<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> msgs <span class="free">e'</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> False Recv assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> next_recv<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> swap_msgs_Trans_Recv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isTrans <span class="free">ev</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isRecv <span class="free">ev'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">d'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d'</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">e'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span> <span class="main">≠</span> occurs_on <span class="free">ev'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"msgs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">e'</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms swap_msgs_Recv_Trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> swap_msgs_Send_Recv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isSend <span class="free">ev</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isRecv <span class="free">ev'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">d'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d'</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">e'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span> <span class="main">≠</span> occurs_on <span class="free">ev'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"msgs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">e'</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev'</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> Send<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> Send <span class="skolem">i'</span> <span class="var">?p</span> <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> event.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i''</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">u''</span></span> <span class="skolem"><span class="skolem">u'''</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="keyword2"><span class="keyword">where</span></span> Recv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev'</span> <span class="main">=</span> Recv <span class="skolem">i''</span> <span class="var">?q</span> <span class="skolem">s</span> <span class="skolem">u''</span> <span class="skolem">u'''</span> <span class="skolem">m'</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> event.collapse<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">i''</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">e'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d'</span> <span class="free">i</span> <span class="main">@</span> <span class="main">[</span>Msg <span class="skolem">m</span><span class="main">]</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Send assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> next_send<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Msg <span class="skolem">m'</span> <span class="main">#</span> msgs <span class="free">d'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"1"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Recv assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> next_recv<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span> <span class="main">@</span> <span class="main">[</span>Msg <span class="skolem">m</span><span class="main">]</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"1"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Send assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> next_send<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Msg <span class="skolem">m'</span> <span class="main">#</span> msgs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"1"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Recv assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> next_recv<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> list.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> not_Cons_self2 tl_append2<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span> <span class="main">@</span> <span class="main">[</span>Msg <span class="skolem">m</span><span class="main">]</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Send assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> next_send<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"2"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Recv assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> event.sel<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> msgs_unchanged_for_other_is regular_event<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">d'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"2"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Recv assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> event.sel<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> msgs_unchanged_for_other_is regular_event<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">e'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d'</span> <span class="free">i</span> <span class="main">@</span> <span class="main">[</span>Msg <span class="skolem">m</span><span class="main">]</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Send 2<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> next_send<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="skolem">i'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">i''</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Send assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> event.sel<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> msgs_unchanged_for_other_is regular_event<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Msg <span class="skolem">m'</span> <span class="main">#</span> msgs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 Recv assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> next_recv<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Msg <span class="skolem">m'</span> <span class="main">#</span> msgs <span class="free">d'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"3"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Recv assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> next_recv<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">e'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d'</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"3"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Send assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> next_send<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.inject<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="skolem">i'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="skolem">i''</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Recv assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> event.sel<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> msgs_unchanged_for_other_is regular_event<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"4"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Send assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> event.sel<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> msgs_unchanged_for_other_is regular_event<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> msgs <span class="free">d'</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"4"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Recv assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> next_recv<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> msgs <span class="free">e'</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"4"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Send assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> next_send<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> swap_msgs_Recv_Send<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isRecv <span class="free">ev</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isSend <span class="free">ev'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">d'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d'</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">e'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span> <span class="main">≠</span> occurs_on <span class="free">ev'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"msgs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">e'</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms swap_msgs_Send_Recv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> same_cs_implies_same_resulting_cs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"cs <span class="free">c</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">d</span> <span class="free">i</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">d'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"regular_event <span class="free">ev</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"cs <span class="free">c'</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">d'</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"isTrans <span class="free">ev</span> <span class="main">∨</span> isSend <span class="free">ev</span> <span class="main">∨</span> isRecv <span class="free">ev</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"isTrans <span class="free">ev</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> event.distinct_disc<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> no_cs_change_if_no_event<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"isSend <span class="free">ev</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> event.distinct_disc<span class="main"><span class="main">(</span></span>10<span class="main"><span class="main">)</span></span> no_cs_change_if_no_event<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"isRecv <span class="free">ev</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> Recv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> Recv <span class="skolem">i'</span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> isRecv_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">=</span> <span class="free">i</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> assms Recv <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="free">c</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> Recording"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms Recv <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> regular_event_implies_same_channel_snapshot_Recv_Recv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isRecv <span class="free">ev</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isRecv <span class="free">ev'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">d'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d'</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">e'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span> <span class="main">≠</span> occurs_on <span class="free">ev'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"cs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">e'</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev'</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> Recv_ev<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> Recv <span class="skolem">i'</span> <span class="var">?p</span> <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> event.collapse<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i''</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">u''</span></span> <span class="skolem"><span class="skolem">u'''</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="keyword2"><span class="keyword">where</span></span> Recv_ev'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev'</span> <span class="main">=</span> Recv <span class="skolem">i''</span> <span class="var">?q</span> <span class="skolem">s</span> <span class="skolem">u''</span> <span class="skolem">u'''</span> <span class="skolem">m'</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> event.collapse<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">≠</span> <span class="skolem">i''</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Recv_ev Recv_ev' assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> can_occur_Recv happen_implies_can_occur option.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> prod.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span> <span class="main">∨</span> <span class="free">i</span> <span class="main">=</span> <span class="skolem">i''</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="free">d'</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">c</span> <span class="free">i</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> assms<span class="main">(</span>5<span class="main">)</span> assms<span class="main">(</span>7<span class="main">)</span> no_cs_change_if_no_event
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Recv_ev' <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≠</span> <span class="skolem">i''</span>›</span></span> event.sel<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> regular_event<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="free">e'</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">d</span> <span class="free">i</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>6<span class="main">)</span> distributed_system.same_cs_implies_same_resulting_cs distributed_system_axioms regular_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">e</span> <span class="free">i</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Recv_ev' <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≠</span> <span class="skolem">i''</span>›</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> event.sel<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> no_cs_change_if_no_event regular_event<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹cs <span class="free">e'</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">d</span> <span class="free">i</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">i''</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">c</span> <span class="free">i</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Recv_ev <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≠</span> <span class="skolem">i''</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> event.sel<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> no_cs_change_if_no_event regular_event<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">d'</span> <span class="free">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> assms<span class="main">(</span>5<span class="main">)</span> regular_event same_cs_implies_same_resulting_cs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="free">d'</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">e'</span> <span class="free">i</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Recv_ev <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">=</span> <span class="skolem">i''</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≠</span> <span class="skolem">i''</span>›</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> event.sel<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> no_cs_change_if_no_event regular_event<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹cs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">d'</span> <span class="free">i</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Recv_ev Recv_ev' assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> next_recv<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> regular_event_implies_same_channel_snapshot_Recv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">~</span> isRecv <span class="free">ev</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"regular_event <span class="free">ev</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isRecv <span class="free">ev'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">d'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d'</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">e'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span> <span class="main">≠</span> occurs_on <span class="free">ev'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"cs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">e'</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev'</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">u''</span></span> <span class="skolem"><span class="skolem">u'''</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="keyword2"><span class="keyword">where</span></span> Recv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev'</span> <span class="main">=</span> Recv <span class="skolem">i'</span> <span class="var">?q</span> <span class="skolem">s</span> <span class="skolem">u''</span> <span class="skolem">u'''</span> <span class="skolem">m'</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> event.collapse<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">c</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>7<span class="main">)</span> no_cs_change_if_no_event <span class="quoted"><span class="quoted">‹regular_event <span class="free">ev</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">~</span> isRecv <span class="free">ev</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">d'</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>5<span class="main">)</span> assms<span class="main">(</span>6<span class="main">)</span> regular_event same_cs_implies_same_resulting_cs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="free">d'</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">e'</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> True assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>6<span class="main">)</span> assms<span class="main">(</span>7<span class="main">)</span> no_cs_change_if_no_event <span class="quoted"><span class="quoted">‹regular_event <span class="free">ev</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">~</span> isRecv <span class="free">ev</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹cs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">d'</span> <span class="free">i</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">c</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> no_cs_change_if_no_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="free">d'</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">e</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> regular_event same_cs_implies_same_resulting_cs<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">e'</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> assms<span class="main">(</span>7<span class="main">)</span> no_cs_change_if_no_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> same_messages_2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> has_snapshotted <span class="free">c</span> <span class="bound">p</span> <span class="main">=</span> has_snapshotted <span class="free">d</span> <span class="bound">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"msgs <span class="free">c</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">d'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">~</span> regular_event <span class="free">ev</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"msgs <span class="free">c'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d'</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">i</span> <span class="main">=</span> None"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> no_msgs_change_if_no_channel <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> chan<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"isSnapshot <span class="free">ev</span> <span class="main">∨</span> isRecvMarker <span class="free">ev</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span> event.exhaust_disc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"isSnapshot <span class="free">ev</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> Snapshot<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> Snapshot <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> isSnapshot_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">c'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span> <span class="main">@</span> <span class="main">[</span>Marker<span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> chan Snapshot assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">d'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d</span> <span class="free">i</span> <span class="main">@</span> <span class="main">[</span>Marker<span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> chan Snapshot assms True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">c'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> chan Snapshot assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">d'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> chan Snapshot assms False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"isRecvMarker <span class="free">ev</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> RecvMarker<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> RecvMarker <span class="skolem">i'</span> <span class="skolem">r</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> isRecvMarker_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="free">c</span> <span class="skolem">r</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> snap<span class="main">:</span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">#</span> msgs <span class="free">c'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> chan RecvMarker assms snap <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">#</span> msgs <span class="free">d'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> chan RecvMarker assms snap True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.inject<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">d'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d</span> <span class="free">i</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> RecvMarker assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> snap <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> msgs <span class="free">c'</span> <span class="free">i</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> False RecvMarker snap assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> snap <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> no_snap<span class="main">:</span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">#</span> msgs <span class="free">c'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> chan RecvMarker assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">#</span> msgs <span class="free">d'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> chan RecvMarker assms True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.inject<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> not_i<span class="main">:</span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">c'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span> <span class="main">@</span> <span class="main">[</span>Marker<span class="main">]</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> no_snap RecvMarker assms True chan not_i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">d'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d</span> <span class="free">i</span> <span class="main">@</span> <span class="main">[</span>Marker<span class="main">]</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="free">d</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms no_snap True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">using</span></span> no_snap RecvMarker assms True chan not_i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">c</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c'</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False RecvMarker no_snap chan assms not_i <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">d'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d</span> <span class="free">i</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="free">d</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms no_snap False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">using</span></span> False RecvMarker no_snap chan assms not_i <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> same_cs_2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> has_snapshotted <span class="free">c</span> <span class="bound">p</span> <span class="main">=</span> has_snapshotted <span class="free">d</span> <span class="bound">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"cs <span class="free">c</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">d</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">d'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"cs <span class="free">c'</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">d'</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">i</span> <span class="main">=</span> None"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> no_cs_change_if_no_channel <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> chan<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ev</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Snapshot <span class="skolem">r</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> assms chan <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="skolem">q</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>RecvMarker <span class="skolem">i'</span> <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="free">c</span> <span class="skolem">r</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> snap<span class="main">:</span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> sdr<span class="main">:</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="free">d</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="free">c'</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span>fst <span class="main">(</span>cs <span class="free">c</span> <span class="free">i</span><span class="main">)</span><span class="main">,</span> Done<span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> RecvMarker assms<span class="main">(</span>3<span class="main">)</span> next_recv_marker <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> cs <span class="free">d'</span> <span class="free">i</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> RecvMarker True assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="free">c'</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">c</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> RecvMarker assms snap <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> cs <span class="free">d'</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> RecvMarker assms snap sdr False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> no_snap<span class="main">:</span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> nsdr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="free">d</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="free">c'</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span>fst <span class="main">(</span>cs <span class="free">c</span> <span class="free">i</span><span class="main">)</span><span class="main">,</span> Done<span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> RecvMarker assms<span class="main">(</span>3<span class="main">)</span> next_recv_marker <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> cs <span class="free">d'</span> <span class="free">i</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> RecvMarker True assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> not_i<span class="main">:</span> False
        <span class="keyword1"><span class="command">with</span></span> assms RecvMarker chan no_snap <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="skolem">q</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Trans <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">u'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> event.disc<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> regular_event same_cs_implies_same_resulting_cs<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Send <span class="skolem">i'</span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> event.disc<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> regular_event same_cs_implies_same_resulting_cs<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Recv <span class="skolem">i'</span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> event.disc<span class="main"><span class="main">(</span></span>13<span class="main"><span class="main">)</span></span> regular_event same_cs_implies_same_resulting_cs<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> swap_Snapshot_Trans<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isSnapshot <span class="free">ev</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isTrans <span class="free">ev'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">d'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d'</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">e'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span> <span class="main">≠</span> occurs_on <span class="free">ev'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"msgs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">e'</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev'</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> Snapshot <span class="var">?p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> event.collapse<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u''</span></span> <span class="skolem"><span class="skolem">u'''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ev'</span> <span class="main">=</span> Trans <span class="var">?q</span> <span class="skolem">u''</span> <span class="skolem">u'''</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> event.collapse<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">c</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d'</span> <span class="free">i</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Trans_msg assms<span class="main">(</span>4<span class="main">)</span> assms<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">e'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> has_snapshotted <span class="free">c</span> <span class="bound">p</span> <span class="main">=</span> has_snapshotted <span class="free">d'</span> <span class="bound">p</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> assms<span class="main">(</span>5<span class="main">)</span> regular_event_preserves_process_snapshots <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">c</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d'</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹msgs <span class="free">c</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d'</span> <span class="free">i</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">d'</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">e'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> regular_event <span class="free">ev</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> same_messages_2<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">e</span> <span class="free">i</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Trans_msg assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹msgs <span class="free">e'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d</span> <span class="free">i</span>›</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> swap_msgs_Trans_RecvMarker<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isRecvMarker <span class="free">ev</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isTrans <span class="free">ev'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">d'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d'</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">e'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span> <span class="main">≠</span> occurs_on <span class="free">ev'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"msgs <span class="free">e'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">e</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> nr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> regular_event <span class="free">ev</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> nonregular_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev'</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> RecvMarker<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> RecvMarker <span class="skolem">i'</span> <span class="var">?p</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> event.collapse<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u''</span></span> <span class="skolem"><span class="skolem">u'''</span></span> <span class="keyword2"><span class="keyword">where</span></span> Trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev'</span> <span class="main">=</span> Trans <span class="var">?q</span> <span class="skolem">u''</span> <span class="skolem">u'''</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> event.collapse<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">c</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d'</span> <span class="free">i</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Trans_msg assms<span class="main">(</span>4<span class="main">)</span> assms<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">e'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> has_snapshotted <span class="free">d'</span> <span class="bound">p</span> <span class="main">=</span> has_snapshotted <span class="free">c</span> <span class="bound">p</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> assms<span class="main">(</span>5<span class="main">)</span> regular_event_preserves_process_snapshots <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> regular_event <span class="free">ev</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> msgs <span class="free">d'</span> <span class="bound">n</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="bound">n</span>"</span></span> <span class="comment1">(* why does he need this assumption? *)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Trans assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> local.next.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>6<span class="main">)</span> same_messages_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">thm</span></span> same_messages_2
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">e</span> <span class="free">i</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Trans_msg assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹msgs <span class="free">e'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d</span> <span class="free">i</span>›</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> swap_Trans_Snapshot<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isTrans <span class="free">ev</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isSnapshot <span class="free">ev'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">d'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d'</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">e'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span> <span class="main">≠</span> occurs_on <span class="free">ev'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"msgs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">e'</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms swap_Snapshot_Trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> swap_Send_Snapshot<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isSend <span class="free">ev</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isSnapshot <span class="free">ev'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">d'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d'</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">e'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span> <span class="main">≠</span> occurs_on <span class="free">ev'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"msgs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">e'</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">i</span> <span class="main">=</span> None"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> no_msgs_change_if_no_channel<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> chan<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev'</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> Send<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> Send <span class="skolem">i'</span> <span class="var">?p</span> <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> event.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> Snapshot<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev'</span> <span class="main">=</span> Snapshot <span class="var">?q</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> event.collapse<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="var">?q</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="var">?q</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="skolem">i'</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> chan asm <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms can_occur_def Send chan 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> event.simps<span class="main"><span class="main">(</span></span>27<span class="main"><span class="main">)</span></span> happen_implies_can_occur option.inject prod.inject<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms asm <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="var">?q</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span> <span class="main">@</span> <span class="main">[</span>Msg <span class="skolem">m</span><span class="main">]</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Send assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> next_send<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject Snapshot <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≠</span> occurs_on <span class="free">ev'</span>›</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> chan next_snapshot option.inject<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">d'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject Snapshot <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≠</span> occurs_on <span class="free">ev'</span>›</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> chan next_snapshot option.inject<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">e'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d'</span> <span class="free">i</span> <span class="main">@</span> <span class="main">[</span>Msg <span class="skolem">m</span><span class="main">]</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Send <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>›</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> next_send<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="skolem">i'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="var">?q</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Send assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> event.sel<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> msgs_unchanged_for_other_is regular_event<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span> <span class="main">@</span> <span class="main">[</span>Marker<span class="main">]</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> Snapshot asm<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> calculation chan next_snapshot<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">d'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span> <span class="main">@</span> <span class="main">[</span>Marker<span class="main">]</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> Snapshot asm<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> chan next_snapshot<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">e'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d'</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Send asm<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> next_send<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="skolem">i'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="var">?q</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">c</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Send assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> event.sel<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> msgs_unchanged_for_other_is regular_event<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d'</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject Snapshot <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≠</span> occurs_on <span class="free">ev'</span>›</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>5<span class="main"><span class="main">)</span></span> chan next_snapshot option.inject<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Send <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≠</span> <span class="skolem">i'</span>›</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> next_send<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> swap_Snapshot_Send<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isSnapshot <span class="free">ev</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isSend <span class="free">ev'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">d'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d'</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">e'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span> <span class="main">≠</span> occurs_on <span class="free">ev'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"msgs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">e'</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms swap_Send_Snapshot <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> swap_Recv_Snapshot<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isRecv <span class="free">ev</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isSnapshot <span class="free">ev'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">d'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d'</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">e'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span> <span class="main">≠</span> occurs_on <span class="free">ev'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"msgs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">e'</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">i</span> <span class="main">=</span> None"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> no_msgs_change_if_no_channel<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> chan<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev'</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> Recv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> Recv <span class="skolem">i'</span> <span class="var">?p</span> <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> event.collapse<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> Snapshot<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev'</span> <span class="main">=</span> Snapshot <span class="var">?q</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> event.collapse<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="var">?q</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="var">?q</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Msg <span class="skolem">m</span> <span class="main">#</span> msgs <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Recv assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> next_recv<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d</span> <span class="free">i</span> <span class="main">@</span> <span class="main">[</span>Marker<span class="main">]</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> Snapshot <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">=</span> occurs_on <span class="free">ev'</span>›</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> chan next_snapshot<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">d'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span> <span class="main">@</span> <span class="main">[</span>Marker<span class="main">]</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> Snapshot <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">=</span> occurs_on <span class="free">ev'</span>›</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> chan next_snapshot<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Msg <span class="skolem">m</span> <span class="main">#</span> msgs <span class="free">e'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d'</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Recv <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>›</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> next_recv<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> neq_Nil_conv tl_append2<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="var">?q</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Msg <span class="skolem">m</span> <span class="main">#</span> msgs <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Recv assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> next_recv<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject Snapshot <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≠</span> occurs_on <span class="free">ev'</span>›</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> chan next_snapshot option.inject<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">d'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject Snapshot <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≠</span> occurs_on <span class="free">ev'</span>›</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> chan next_snapshot option.inject<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Msg <span class="skolem">m</span> <span class="main">#</span> msgs <span class="free">e'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d'</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Recv <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>›</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> next_recv<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.inject<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="skolem">i'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="var">?q</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Recv assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> next_recv<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d</span> <span class="free">i</span> <span class="main">@</span> <span class="main">[</span>Marker<span class="main">]</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> Snapshot <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">=</span> occurs_on <span class="free">ev'</span>›</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> chan next_snapshot<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">d'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span> <span class="main">@</span> <span class="main">[</span>Marker<span class="main">]</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> Snapshot <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">=</span> occurs_on <span class="free">ev'</span>›</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> chan next_snapshot<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">e'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d'</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Recv <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">~=</span> <span class="skolem">i'</span>›</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> next_recv<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="skolem">i'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="var">?q</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Recv assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> next_recv<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject Snapshot <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≠</span> occurs_on <span class="free">ev'</span>›</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> chan next_snapshot option.inject<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">d'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject Snapshot <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≠</span> occurs_on <span class="free">ev'</span>›</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> chan next_snapshot option.inject<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">e'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d'</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Recv <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">~=</span> <span class="skolem">i'</span>›</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> next_recv<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> swap_Snapshot_Recv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isSnapshot <span class="free">ev</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isRecv <span class="free">ev'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">d'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d'</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">e'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span> <span class="main">≠</span> occurs_on <span class="free">ev'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"msgs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">e'</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms swap_Recv_Snapshot <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> swap_msgs_Recv_RecvMarker<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isRecv <span class="free">ev</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isRecvMarker <span class="free">ev'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">d'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d'</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">e'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span> <span class="main">≠</span> occurs_on <span class="free">ev'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"msgs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">e'</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">i</span> <span class="main">=</span> None"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> no_msgs_change_if_no_channel<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> chan<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="skolem"><span class="skolem">p'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> Recv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> Recv <span class="skolem">i'</span> <span class="skolem">p'</span> <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> event.collapse<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i''</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> RecvMarker<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev'</span> <span class="main">=</span> RecvMarker <span class="skolem">i''</span> <span class="skolem">q'</span> <span class="skolem">s</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> event.collapse<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">≠</span> <span class="skolem">i''</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="skolem">i'</span> <span class="main">≠</span> <span class="skolem">i''</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="skolem">i'</span> <span class="main">=</span> <span class="free">channel</span> <span class="skolem">i''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Some <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">p'</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">q'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms can_occur_def Recv RecvMarker <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Recv RecvMarker event.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>5<span class="main"><span class="main">)</span></span> option.inject prod.inject<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span> <span class="main">∨</span> <span class="free">i</span> <span class="main">=</span> <span class="skolem">i''</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> pqrp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">p'</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Recv assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> chan distributed_system.can_occur_Recv distributed_system_axioms next_recv option.inject<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="free">c</span> <span class="skolem">q'</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> snap<span class="main">:</span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Msg <span class="skolem">m</span> <span class="main">#</span> msgs <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Recv <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> next_recv<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">c</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d'</span> <span class="free">i</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> RecvMarker <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≠</span> <span class="skolem">i''</span>›</span></span> assms<span class="main">(</span>5<span class="main">)</span> msgs_unchanged_if_snapshotted_RecvMarker_for_other_is snap <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">e</span> <span class="free">i</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> RecvMarker <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≠</span> <span class="skolem">i''</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> snap snapshot_state_unchanged <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Msg <span class="skolem">m</span> <span class="main">#</span> msgs <span class="free">e'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d'</span> <span class="free">i</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Recv <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>›</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> next_recv<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.inject<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> no_snap<span class="main">:</span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> msgs_d<span class="main">:</span> <span class="quoted"><span class="quoted">"Msg <span class="skolem">m</span> <span class="main">#</span> msgs <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Recv <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> next_recv<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">=</span> <span class="skolem">r</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">d'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span> <span class="main">@</span> <span class="main">[</span>Marker<span class="main">]</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">q'</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> 
              <span class="keyword1"><span class="command">using</span></span> True chan pqrp <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> RecvMarker assms no_snap 
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> no_snap <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≠</span> <span class="skolem">i''</span>›</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Msg <span class="skolem">m</span> <span class="main">#</span> msgs <span class="free">e'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d'</span> <span class="free">i</span>"</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Recv <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>›</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> next_recv<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d</span> <span class="free">i</span> <span class="main">@</span> <span class="main">[</span>Marker<span class="main">]</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ps <span class="free">d</span> <span class="skolem">q'</span> <span class="main">=</span> ps <span class="free">c</span> <span class="skolem">q'</span>"</span></span> 
              <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>7<span class="main">)</span> no_state_change_if_no_event RecvMarker <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">using</span></span> RecvMarker <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≠</span> <span class="skolem">i''</span>›</span></span> assms True chan no_snap pqrp <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> msgs_d 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_self_conv2 list.inject list.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> message.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> tl_append2<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d</span> <span class="free">i</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="free">d</span> <span class="skolem">q'</span>"</span></span> 
              <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>7<span class="main">)</span> no_snap no_state_change_if_no_event RecvMarker <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">r</span><span class="main">.</span> <span class="free">channel</span> <span class="free">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">q'</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> chan False pqrp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="skolem">i''</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≠</span> <span class="skolem">i''</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> RecvMarker assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">d'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">r</span><span class="main">.</span> <span class="free">channel</span> <span class="free">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">q'</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span>"</span></span> 
              <span class="keyword1"><span class="command">using</span></span> False chan pqrp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="skolem">i''</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≠</span> <span class="skolem">i''</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> RecvMarker assms<span class="main">(</span>5<span class="main">)</span> no_snap <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Msg <span class="skolem">m</span> <span class="main">#</span> msgs <span class="free">e'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d'</span> <span class="free">i</span>"</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Recv <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>›</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> next_recv<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> msgs_d 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.inject<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">i''</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Recv <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≠</span> <span class="skolem">i''</span>›</span></span> next_recv<span class="main">)</span> 
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d'</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> has_snapshotted <span class="free">c</span> <span class="bound">p</span> <span class="main">=</span> has_snapshotted <span class="free">d</span> <span class="bound">p</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Recv assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> next_recv<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> calculation same_messages_2 same_messages_imply_same_resulting_messages<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">e'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d'</span> <span class="free">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Recv <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≠</span> <span class="skolem">i''</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">=</span> <span class="skolem">i''</span>›</span></span> next_recv<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="main">(</span><span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span> <span class="main">∨</span> <span class="free">i</span> <span class="main">=</span> <span class="skolem">i''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">c</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Recv assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> event.distinct_disc<span class="main"><span class="main">(</span></span>16<span class="main"><span class="main">,</span></span>18<span class="main"><span class="main">)</span></span> event.sel<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> msgs_unchanged_for_other_is nonregular_event<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">d'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">e</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> has_snapshotted <span class="free">c</span> <span class="bound">p</span> <span class="main">=</span> has_snapshotted <span class="free">d</span> <span class="bound">p</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> regular_event_preserves_process_snapshots <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted"><span class="quoted">‹msgs <span class="free">c</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d</span> <span class="free">i</span>›</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> same_messages_2 same_messages_imply_same_resulting_messages<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Recv asm assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> event.distinct_disc<span class="main"><span class="main">(</span></span>16<span class="main"><span class="main">,</span></span>18<span class="main"><span class="main">)</span></span> event.sel<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> msgs_unchanged_for_other_is nonregular_event<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> swap_RecvMarker_Recv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isRecvMarker <span class="free">ev</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isRecv <span class="free">ev'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">d'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d'</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">e'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span> <span class="main">≠</span> occurs_on <span class="free">ev'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"msgs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">e'</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms swap_msgs_Recv_RecvMarker <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> swap_msgs_Send_RecvMarker<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isSend <span class="free">ev</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isRecvMarker <span class="free">ev'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">d'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d'</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">e'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span> <span class="main">≠</span> occurs_on <span class="free">ev'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"msgs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">e'</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">i</span> <span class="main">=</span> None"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> no_msgs_change_if_no_channel<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> chan<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev'</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="skolem"><span class="skolem">p'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> Send<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> Send <span class="skolem">i'</span> <span class="skolem">p'</span> <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> event.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i''</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> RecvMarker<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev'</span> <span class="main">=</span> RecvMarker <span class="skolem">i''</span> <span class="skolem">q'</span> <span class="skolem">s</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> event.collapse<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">≠</span> <span class="skolem">q'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Send RecvMarker assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">i''</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">e'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d'</span> <span class="free">i</span> <span class="main">@</span> <span class="main">[</span>Msg <span class="skolem">m</span><span class="main">]</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Send assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> next_send<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">#</span> msgs <span class="free">d'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">=</span> <span class="skolem">i''</span>›</span></span> RecvMarker assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span> <span class="main">@</span> <span class="main">[</span>Msg <span class="skolem">m</span><span class="main">]</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"1"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Send assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> next_send<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">#</span> msgs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">=</span> <span class="skolem">i''</span>›</span></span> RecvMarker assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_self_conv2 list.inject list.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> message.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> tl_append2<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> pqpr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">p'</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> chan Send can_occur_def assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span> <span class="main">@</span> <span class="main">[</span>Msg <span class="skolem">m</span><span class="main">]</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> 2<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Send assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> next_send<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">e'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d'</span> <span class="free">i</span> <span class="main">@</span> <span class="main">[</span>Msg <span class="skolem">m</span><span class="main">]</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"2"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Send assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> next_send<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">d'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">r</span><span class="main">.</span> <span class="free">channel</span> <span class="free">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">q'</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p'</span> <span class="main">≠</span> <span class="skolem">q'</span>›</span></span> chan pqpr <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> RecvMarker <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≠</span> <span class="skolem">i''</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>›</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="free">c</span> <span class="skolem">q'</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">r</span><span class="main">.</span> <span class="free">channel</span> <span class="free">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">q'</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p'</span> <span class="main">≠</span> <span class="skolem">q'</span>›</span></span> chan pqpr <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> RecvMarker <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≠</span> <span class="skolem">i''</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>›</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="free">d</span> <span class="skolem">q'</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="skolem">i'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">i''</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> mcd<span class="main">:</span> <span class="quoted"><span class="quoted">"msgs <span class="free">c</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Send assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> next_send<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d'</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> has_snapshotted <span class="free">c</span> <span class="bound">p</span> <span class="main">=</span> has_snapshotted <span class="free">d</span> <span class="bound">p</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> regular_event_preserves_process_snapshots <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> regular_event <span class="free">ev'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> mcd assms<span class="main">(</span>2<span class="main">,</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> same_messages_2<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">e'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d'</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"3"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Send assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> next_send<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="skolem">i'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="skolem">i''</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> mcd<span class="main">:</span> <span class="quoted"><span class="quoted">"msgs <span class="free">c</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"4"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Send assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> event.distinct_disc<span class="main"><span class="main">(</span></span>12<span class="main"><span class="main">,</span></span>14<span class="main"><span class="main">)</span></span> event.sel<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> msgs_unchanged_for_other_is nonregular_event<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">d'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">e</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> has_snapshotted <span class="free">c</span> <span class="bound">p</span> <span class="main">=</span> has_snapshotted <span class="free">d</span> <span class="bound">p</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> regular_event_preserves_process_snapshots <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> regular_event <span class="free">ev'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> mcd assms<span class="main">(</span>2<span class="main">,</span>5<span class="main">)</span> same_messages_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">e'</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">d'</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"4"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Send assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> next_send<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> swap_RecvMarker_Send<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isRecvMarker <span class="free">ev</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isSend <span class="free">ev'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">d'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d'</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">e'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span> <span class="main">≠</span> occurs_on <span class="free">ev'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"msgs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> msgs <span class="free">e'</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms swap_msgs_Send_RecvMarker <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> swap_cs_Trans_Snapshot<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isTrans <span class="free">ev</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isSnapshot <span class="free">ev'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">d'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d'</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">e'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"cs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">e'</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">i</span> <span class="main">=</span> None"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> no_cs_change_if_no_channel<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> nr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> regular_event <span class="free">ev'</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> nonregular_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev'</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u''</span></span> <span class="skolem"><span class="skolem">u'''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> Trans <span class="var">?p</span> <span class="skolem">u''</span> <span class="skolem">u'''</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> event.collapse<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ev'</span> <span class="main">=</span> Snapshot <span class="var">?q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> event.collapse<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">c</span> <span class="free">i</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> event.distinct_disc<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> no_cs_change_if_no_event regular_event<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">d'</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> has_snapshotted <span class="free">d</span> <span class="bound">p</span> <span class="main">=</span> has_snapshotted <span class="free">c</span> <span class="bound">p</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> regular_event_preserves_process_snapshots <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹cs <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">c</span> <span class="free">i</span>›</span></span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>5<span class="main">)</span> same_cs_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> cs <span class="free">e'</span> <span class="free">i</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>6<span class="main">)</span> no_cs_change_if_no_event regular_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> swap_cs_Snapshot_Trans<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isSnapshot <span class="free">ev</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isTrans <span class="free">ev'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">d'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d'</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">e'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"cs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">e'</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> swap_cs_Trans_Snapshot assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> swap_cs_Send_Snapshot<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isSend <span class="free">ev</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isSnapshot <span class="free">ev'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">d'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d'</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">e'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"cs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">e'</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">i</span> <span class="main">=</span> None"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> no_cs_change_if_no_channel<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> nr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> regular_event <span class="free">ev'</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> nonregular_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev'</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> Send<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> Send <span class="skolem">i'</span> <span class="var">?p</span> <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> event.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> Snapshot<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev'</span> <span class="main">=</span> Snapshot <span class="var">?q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> event.collapse<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">c</span> <span class="free">i</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Send assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> next_send<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">d'</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> has_snapshotted <span class="free">d</span> <span class="bound">p</span> <span class="main">=</span> has_snapshotted <span class="free">c</span> <span class="bound">p</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> regular_event_preserves_process_snapshots <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹cs <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">c</span> <span class="free">i</span>›</span></span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>5<span class="main">)</span> same_cs_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> cs <span class="free">e'</span> <span class="free">i</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>6<span class="main">)</span> no_cs_change_if_no_event regular_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> swap_cs_Snapshot_Send<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isSnapshot <span class="free">ev</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isSend <span class="free">ev'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">d'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d'</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">e'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"cs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">e'</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> swap_cs_Send_Snapshot assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> swap_cs_Recv_Snapshot<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isRecv <span class="free">ev</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isSnapshot <span class="free">ev'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">d'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d'</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">e'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span> <span class="main">≠</span> occurs_on <span class="free">ev'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"cs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">e'</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">i</span> <span class="main">=</span> None"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> no_cs_change_if_no_channel<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> chan<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> nr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> regular_event <span class="free">ev'</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> nonregular_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev'</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> Recv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> Recv <span class="skolem">i'</span> <span class="var">?p</span> <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> event.collapse<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> Snapshot<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev'</span> <span class="main">=</span> Snapshot <span class="var">?q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> event.collapse<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="free">c</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> Recording"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span>fst <span class="main">(</span>cs <span class="free">c</span> <span class="free">i</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">m</span><span class="main">]</span><span class="main">,</span> Recording<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Recv assms True <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>›</span></span> chan 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> next_recv<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">d</span> <span class="free">i</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Snapshot assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> calculation fst_conv next_snapshot<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="free">c</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">d'</span> <span class="free">i</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Snapshot True assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> next_snapshot prod.collapse<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="free">e'</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span>fst <span class="main">(</span>cs <span class="free">d'</span> <span class="free">i</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">m</span><span class="main">]</span><span class="main">,</span> Recording<span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Recv assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> calculation<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> calculation<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> next_recv<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">c</span> <span class="free">i</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> False Recv assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> next_recv<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">d'</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> has_snapshotted <span class="free">d</span> <span class="bound">p</span> <span class="main">=</span> has_snapshotted <span class="free">c</span> <span class="bound">p</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> regular_event_preserves_process_snapshots <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹cs <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">c</span> <span class="free">i</span>›</span></span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>5<span class="main">)</span> same_cs_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="free">d'</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">e'</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="free">d'</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">c</span> <span class="free">i</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject Recv Snapshot True assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> can_occur_Recv distributed_system.happen_implies_can_occur distributed_system.next_snapshot distributed_system_axioms option.inject<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> chan <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>›</span></span> False Recv assms 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> next_recv<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">c</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> False Recv assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> next_recv<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">d'</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> has_snapshotted <span class="free">d</span> <span class="bound">p</span> <span class="main">=</span> has_snapshotted <span class="free">c</span> <span class="bound">p</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> regular_event_preserves_process_snapshots <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹cs <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">c</span> <span class="free">i</span>›</span></span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>5<span class="main">)</span> same_cs_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> cs <span class="free">e'</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> False Recv assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> next_recv<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> swap_cs_Snapshot_Recv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isSnapshot <span class="free">ev</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isRecv <span class="free">ev'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">d'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d'</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">e'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span> <span class="main">≠</span> occurs_on <span class="free">ev'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"cs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">e'</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> swap_cs_Recv_Snapshot assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> swap_cs_Trans_RecvMarker<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isTrans <span class="free">ev</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isRecvMarker <span class="free">ev'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">d'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d'</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">e'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"cs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">e'</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">i</span> <span class="main">=</span> None"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> no_cs_change_if_no_channel<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> chan<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> nr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> regular_event <span class="free">ev'</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> nonregular_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev'</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u''</span></span> <span class="skolem"><span class="skolem">u'''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> Trans <span class="var">?p</span> <span class="skolem">u''</span> <span class="skolem">u'''</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> event.collapse<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ev'</span> <span class="main">=</span> RecvMarker <span class="skolem">i'</span> <span class="var">?q</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> event.collapse<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">c</span> <span class="free">i</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> event.distinct_disc<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> no_cs_change_if_no_event regular_event<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">d'</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> has_snapshotted <span class="free">d</span> <span class="bound">p</span> <span class="main">=</span> has_snapshotted <span class="free">c</span> <span class="bound">p</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> regular_event_preserves_process_snapshots <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹cs <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">c</span> <span class="free">i</span>›</span></span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>5<span class="main">)</span> same_cs_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> cs <span class="free">e'</span> <span class="free">i</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>6<span class="main">)</span> no_cs_change_if_no_event regular_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> swap_cs_RecvMarker_Trans<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isRecvMarker <span class="free">ev</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isTrans <span class="free">ev'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">d'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d'</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">e'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"cs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">e'</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> swap_cs_Trans_RecvMarker assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> swap_cs_Send_RecvMarker<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isSend <span class="free">ev</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isRecvMarker <span class="free">ev'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">d'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d'</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">e'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"cs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">e'</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">i</span> <span class="main">=</span> None"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> no_cs_change_if_no_channel<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> chan<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> nr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> regular_event <span class="free">ev'</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> nonregular_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev'</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> Send<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> Send <span class="skolem">i'</span> <span class="var">?p</span> <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> event.collapse<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i''</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> RecvMarker<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev'</span> <span class="main">=</span> RecvMarker <span class="skolem">i''</span> <span class="var">?q</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> event.collapse<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">c</span> <span class="free">i</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> event.distinct_disc<span class="main"><span class="main">(</span></span>10<span class="main"><span class="main">,</span></span>12<span class="main"><span class="main">,</span></span>14<span class="main"><span class="main">)</span></span> no_cs_change_if_no_event nonregular_event<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">d'</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> has_snapshotted <span class="free">d</span> <span class="bound">p</span> <span class="main">=</span> has_snapshotted <span class="free">c</span> <span class="bound">p</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> regular_event_preserves_process_snapshots <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹cs <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">c</span> <span class="free">i</span>›</span></span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>5<span class="main">)</span> same_cs_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> cs <span class="free">e'</span> <span class="free">i</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>6<span class="main">)</span> no_cs_change_if_no_event regular_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> swap_cs_RecvMarker_Send<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isRecvMarker <span class="free">ev</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isSend <span class="free">ev'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">d'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d'</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">e'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"cs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">e'</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> swap_cs_Send_RecvMarker assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> swap_cs_Recv_RecvMarker<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isRecv <span class="free">ev</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"isRecvMarker <span class="free">ev'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev'</span> <span class="main">↦</span> <span class="free">d'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">d'</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">e'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span> <span class="main">≠</span> occurs_on <span class="free">ev'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"cs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">e'</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">i</span> <span class="main">=</span> None"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> no_cs_change_if_no_channel<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> chan<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> nr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> regular_event <span class="free">ev'</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> nonregular_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="skolem"><span class="skolem">p'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> Recv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> Recv <span class="skolem">i'</span> <span class="skolem">p'</span> <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> event.collapse<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i''</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> RecvMarker<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev'</span> <span class="main">=</span> RecvMarker <span class="skolem">i''</span> <span class="skolem">q'</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> event.collapse<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">≠</span> <span class="skolem">i''</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="skolem">i'</span> <span class="main">≠</span> <span class="skolem">i''</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="skolem">i'</span> <span class="main">=</span> <span class="free">channel</span> <span class="skolem">i''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">p'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">q'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Recv RecvMarker assms can_occur_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> Recv RecvMarker assms can_occur_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> pqrp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">p'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Recv assms can_occur_def chan <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="free">c</span> <span class="free">i</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> NotStarted
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">c</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms Recv <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="free">d'</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">e</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> has_snapshotted <span class="free">c</span> <span class="bound">p</span> <span class="main">=</span> has_snapshotted <span class="free">d</span> <span class="bound">p</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> regular_event_preserves_process_snapshots <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">,</span>5<span class="main">)</span> calculation <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> same_cs_2<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">thm</span></span> same_cs_2
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="free">d'</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">e'</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="free">d'</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">c</span> <span class="free">i</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">r</span><span class="main">.</span> <span class="free">channel</span> <span class="free">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="skolem">q'</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> Recv RecvMarker assms<span class="main">(</span>7<span class="main">)</span> chan pqrp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> RecvMarker assms chan <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≠</span> <span class="skolem">i''</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="free">c</span> <span class="skolem">q'</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms Recv <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>›</span></span> NotStarted <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Done
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">c</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms Recv <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="free">d'</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">e</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> has_snapshotted <span class="free">c</span> <span class="bound">p</span> <span class="main">=</span> has_snapshotted <span class="free">d</span> <span class="bound">p</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> regular_event_preserves_process_snapshots <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>5<span class="main">)</span> calculation <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> same_cs_2<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="free">d'</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">e'</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="free">d'</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">c</span> <span class="free">i</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">r</span><span class="main">.</span> <span class="free">channel</span> <span class="free">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="skolem">q'</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> Recv RecvMarker assms<span class="main">(</span>7<span class="main">)</span> chan pqrp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> RecvMarker assms chan <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≠</span> <span class="skolem">i''</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="free">c</span> <span class="skolem">q'</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms Recv <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>›</span></span> Done <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Recording
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span>fst <span class="main">(</span>cs <span class="free">c</span> <span class="free">i</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">m</span><span class="main">]</span><span class="main">,</span> Recording<span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> Recording Recv True assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">d</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">r</span><span class="main">.</span> <span class="free">channel</span> <span class="free">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="skolem">q'</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> Recv RecvMarker assms<span class="main">(</span>7<span class="main">)</span> chan pqrp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> RecvMarker assms chan <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≠</span> <span class="skolem">i''</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="free">d</span> <span class="skolem">q'</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="free">c</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">d'</span> <span class="free">i</span> "</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">r</span><span class="main">.</span> <span class="free">channel</span> <span class="free">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="skolem">q'</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> Recv RecvMarker assms<span class="main">(</span>7<span class="main">)</span> chan pqrp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> RecvMarker assms chan <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">≠</span> <span class="skolem">i''</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="free">c</span> <span class="skolem">q'</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="free">e'</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span>fst <span class="main">(</span>cs <span class="free">d'</span> <span class="free">i</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">m</span><span class="main">]</span><span class="main">,</span> Recording<span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> Recording Recv True assms<span class="main">(</span>6<span class="main">)</span> calculation<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">c</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> False Recv assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="free">e</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">d'</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> has_snapshotted <span class="free">d</span> <span class="bound">p</span> <span class="main">=</span> has_snapshotted <span class="free">c</span> <span class="bound">p</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> regular_event_preserves_process_snapshots <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹cs <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> cs <span class="free">c</span> <span class="free">i</span>›</span></span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>5<span class="main">)</span> same_cs_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> cs <span class="free">e'</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> False Recv assms<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context distributed_system *)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* theory Swap *)</span>
</pre>
</div><div id="Snapshot">
<div class="head">
<h1>Theory Snapshot</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The Chandy--Lamport algorithm›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Snapshot
  <span class="keyword2"><span class="keyword">imports</span></span>
    <span class="quoted">"<a href="../../HOL/HOL-Library/Sublist.html">HOL-Library.Sublist</a>"</span>
    <span class="quoted">"<a href="../../HOL/HOL-Library/Permutation.html">HOL-Library.Permutation</a>"</span>
    <a href="Distributed_System.html">Distributed_System</a>
    <a href="Trace.html">Trace</a>
    <a href="Util.html">Util</a>
    <a href="Swap.html">Swap</a>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The computation locale›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We extend the distributed system locale presented
earlier: Now we are given a trace t of the distributed system between
two configurations, the initial and final configuartions of t. Our objective
is to show that the Chandy--Lamport algorithm terminated successfully and
exhibits the same properties as claimed in~\cite{chandy}. In the initial state
no snapshotting must have taken place yet, however the computation itself may
have progressed arbitrarily far already.

We assume that there exists at least one process, that the
total number of processes in the system is finite, and that there
are only finitely many channels between the processes. The process graph
is strongly connected. Finally there are Chandy and Lamport's core assumptions:
every process snapshots at some time and no marker may remain in a channel forever.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> computation <span class="main">=</span> distributed_system <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">init</span> <span class="free">final</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> configuration"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    finite_channels<span class="main">:</span>
      <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∃</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="free">channel</span> <span class="bound">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    strongly_connected_raw<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span> <span class="main">≠</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟶</span>
         <span class="main">(</span>tranclp <span class="main">(</span><span class="main">λ</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="free">channel</span> <span class="bound">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">p</span> <span class="bound">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>

    at_least_two_processes<span class="main">:</span>
      <span class="quoted"><span class="quoted">"card <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    finite_processes<span class="main">:</span>
      <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>

    no_initial_Marker<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="free">channel</span> <span class="bound">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>
      <span class="main">⟶</span> Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="free">init</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    no_msgs_if_no_channel<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">channel</span> <span class="bound">i</span> <span class="main">=</span> None <span class="main">⟶</span> msgs <span class="free">init</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    no_initial_process_snapshot<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="main">~</span> has_snapshotted <span class="free">init</span> <span class="bound">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    no_initial_channel_snapshot<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> channel_snapshot <span class="free">init</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> NotStarted<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>

    valid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t</span><span class="main">.</span> trace <span class="free">init</span> <span class="bound">t</span> <span class="free">final</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    l1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span> <span class="bound">i</span> <span class="bound">cid</span><span class="main">.</span> trace <span class="free">init</span> <span class="bound">t</span> <span class="free">final</span>
                 <span class="main">∧</span> Marker <span class="main">∈</span> set <span class="main">(</span>msgs <span class="main">(</span>s <span class="free">init</span> <span class="bound">t</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">cid</span><span class="main">)</span>
      <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≥</span> <span class="bound">i</span> <span class="main">∧</span> Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>s <span class="free">init</span> <span class="bound">t</span> <span class="bound">j</span><span class="main">)</span> <span class="bound">cid</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    l2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span> <span class="bound">p</span><span class="main">.</span> trace <span class="free">init</span> <span class="bound">t</span> <span class="free">final</span>
      <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> has_snapshotted <span class="main">(</span>s <span class="free">init</span> <span class="bound">t</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">p</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">≤</span> length <span class="bound">t</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">has_channel</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">has_channel</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="free">channel</span> <span class="bound">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> strongly_connected <span class="main">=</span> strongly_connected_raw<span class="main">[</span><span class="operator">folded</span> has_channel_def<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> exists_some_channel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="free">channel</span> <span class="bound">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">:</span> <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">∧</span> <span class="skolem">q</span> <span class="main">:</span> <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">∧</span> <span class="skolem">p</span> <span class="main">≠</span> <span class="skolem">q</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> One_nat_def UNIV_eq_I all_not_in_conv at_least_two_processes card_Suc_Diff1 card.empty finite_processes insert_iff iso_tuple_UNIV_I less_numeral_extra<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> n_not_Suc_n<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>tranclp has_channel<span class="main">)</span> <span class="skolem">p</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> strongly_connected <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"has_channel <span class="skolem">r</span> <span class="skolem">s</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> tranclpD<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> has_channel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">S</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≡</span> s <span class="free">init</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> no_messages_if_no_channel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> None <span class="main">⟹</span> msgs <span class="main">(</span>s <span class="free">init</span> <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> no_messages_introduced_if_no_channel<span class="main">[</span><span class="operator">OF</span> assms no_msgs_if_no_channel<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> S_induct <span class="main">[</span><span class="operator">consumes</span> 3<span class="main">,</span> <span class="operator">case_names</span> S_init S_step<span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span><span class="main">;</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">j</span><span class="main">;</span> <span class="free">j</span> <span class="main">≤</span> length <span class="free">t</span><span class="main">;</span>
     <span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span> <span class="bound">i</span><span class="main">;</span>
     <span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">j</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">≤</span> length <span class="free">t</span> <span class="main">⟹</span> <span class="main">(</span>S <span class="free">t</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="bound">j</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">i</span> <span class="bound">j</span>
   <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">i</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">-</span> <span class="free">i</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc step_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> exists_index<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">∈</span> set <span class="main">(</span>take <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>drop <span class="free">i</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k</span><span class="main">.</span> <span class="free">i</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">∧</span> <span class="free">ev</span> <span class="main">=</span> <span class="free">t</span> <span class="main">!</span> <span class="bound">k</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>drop <span class="free">i</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>S <span class="free">t</span> <span class="free">j</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> diff_is_0_eq' exists_trace_for_any_i_j list.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.set_cases nat_le_linear take_eq_Nil<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> <span class="main">(</span>take <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>drop <span class="free">i</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">&lt;</span> length <span class="main">(</span>take <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>drop <span class="free">i</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> in_set_conv_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?k</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">+</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>take <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>drop <span class="free">i</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">l</span> <span class="main">=</span> drop <span class="free">i</span> <span class="free">t</span> <span class="main">!</span> <span class="skolem">l</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">&lt;</span> length <span class="main">(</span>take <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>drop <span class="free">i</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">t</span> <span class="main">!</span> <span class="var">?k</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> drop_all empty_iff list.set<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> nat_le_linear nth_drop take_Nil<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> <span class="free">t</span> <span class="main">!</span> <span class="var">?k</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ev</span> <span class="main">=</span> take <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>drop <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">l</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="var">?k</span> <span class="main">∧</span> <span class="var">?k</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">&lt;</span> length <span class="main">(</span>take <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>drop <span class="free">i</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> no_change_if_ge_length_t<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≥</span> length <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≥</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"S <span class="free">t</span> <span class="free">i</span> <span class="main">=</span> S <span class="free">t</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>drop <span class="free">i</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>S <span class="free">t</span> <span class="free">j</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> exists_trace_for_any_i_j <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>take <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>drop <span class="free">i</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Nil"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> tr_init trace_and_start_determines_end<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> no_marker_if_no_snapshot<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span><span class="main">;</span> <span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span><span class="main">;</span>
       <span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">p</span> <span class="main">⟧</span>
     <span class="main">⟹</span>  Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> exists_trace_for_any_i no_initial_Marker take_eq_Nil tr_init trace_and_start_determines_end<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">n</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> distributed_system.exists_trace_for_any_i_j distributed_system.snapshot_stable_2 distributed_system_axioms eq_iff le_Suc_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tr</span></span> <span class="keyword2"><span class="keyword">where</span></span> decomp<span class="main">:</span> <span class="quoted"><span class="quoted">"trace <span class="main">(</span>S <span class="free">t</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">tr</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tr</span> <span class="main">=</span> take <span class="main">(</span>Suc <span class="skolem">n</span> <span class="main">-</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>drop <span class="skolem">n</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc exists_trace_for_any_i_j le_Suc_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">tr</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IH decomp<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> tr_init trace_and_start_determines_end<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ev</span></span> <span class="keyword2"><span class="keyword">where</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tr</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">ev</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="free">t</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">⊢</span> <span class="skolem">ev</span> <span class="main">↦</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_eq_plus1 Suc_leI <span class="quoted"><span class="quoted">‹<span class="skolem">tr</span> <span class="main">=</span> take <span class="main">(</span>Suc <span class="skolem">n</span> <span class="main">-</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>drop <span class="skolem">n</span> <span class="free">t</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹trace <span class="main">(</span>S <span class="free">t</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">tr</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>›</span></span> add_diff_cancel_left' append.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> butlast_take cancel_comm_monoid_add_class.diff_cancel length_greater_0_conv list.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> snoc_eq_iff_butlast take0 take_Nil trace.cases<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ev</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Snapshot <span class="skolem">p'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IH Suc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> local.step<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> new_Marker_in_set_implies_nonregular_occurence new_msg_in_set_implies_occurrence nonregular_event_induces_snapshot snapshot_state_unchanged<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>RecvMarker <span class="skolem">cid'</span> <span class="skolem">p'</span> <span class="skolem">q'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">≠</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="skolem">p'</span> <span class="main">≠</span> <span class="free">p</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> regular_event <span class="skolem">ev</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> RecvMarker <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"occurs_on <span class="skolem">ev</span> <span class="main">=</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> asm RecvMarker <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>2<span class="main">)</span> Suc.hyps Suc.prems 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> nonregular_event_induces_snapshot snapshot_state_unchanged<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> Suc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="free">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">n</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> Marker <span class="main">∧</span> length <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">n</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> step RecvMarker can_occur_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">:</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">n</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> list.set_sel<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">n</span><span class="main">)</span> <span class="free">cid</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">r</span><span class="main">.</span> <span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">p'</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p'</span> <span class="main">≠</span> <span class="free">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>›</span></span> RecvMarker step <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">p'</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> IH<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Trans <span class="skolem">p'</span> <span class="skolem">s</span> <span class="skolem">s'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">using</span></span> IH local.step<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Send <span class="skolem">cid'</span> <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="skolem">s</span> <span class="skolem">s'</span> <span class="skolem">m</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> step IH <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">cid'</span> <span class="main">=</span> <span class="free">cid</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Recv <span class="skolem">cid'</span> <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="skolem">s</span> <span class="skolem">s'</span> <span class="skolem">m</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> step IH <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">cid'</span> <span class="main">=</span> <span class="free">cid</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Termination›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We prove that the snapshot algorithm terminates, as exhibited
by lemma \texttt{snapshot\_algorithm\_must\_terminate}. In the final configuration all
processes have snapshotted, and no markers remain in the channels.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> must_exist_snapshot<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span> <span class="bound">i</span><span class="main">.</span> Snapshot <span class="bound">p</span> <span class="main">=</span> <span class="free">t</span> <span class="main">!</span> <span class="bound">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">p</span> <span class="bound">i</span><span class="main">.</span> Snapshot <span class="bound">p</span> <span class="main">=</span> <span class="free">t</span> <span class="main">!</span> <span class="bound">i</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="bound">p</span><span class="main">.</span> <span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">p</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="bound">p</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms distributed_system.trace_and_start_determines_end distributed_system_axioms exists_trace_for_any_i computation.no_initial_process_snapshot computation_axioms take0 tr_init<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">n</span><span class="main">)</span> <span class="bound">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tr</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"trace <span class="main">(</span>S <span class="free">t</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">tr</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tr</span> <span class="main">=</span> take <span class="main">(</span>Suc <span class="skolem">n</span> <span class="main">-</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>drop <span class="skolem">n</span> <span class="free">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms exists_trace_for_any_i_j le_Suc_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="bound">p</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">tr</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IH <span class="quoted"><span class="quoted">‹trace <span class="main">(</span>S <span class="free">t</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">tr</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>›</span></span> tr_init trace_and_start_determines_end<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ev</span></span> <span class="keyword2"><span class="keyword">where</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tr</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">ev</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="free">t</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">⊢</span> <span class="skolem">ev</span> <span class="main">↦</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_eq_plus1 Suc_leI <span class="quoted"><span class="quoted">‹<span class="skolem">tr</span> <span class="main">=</span> take <span class="main">(</span>Suc <span class="skolem">n</span> <span class="main">-</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>drop <span class="skolem">n</span> <span class="free">t</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹trace <span class="main">(</span>S <span class="free">t</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">tr</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>›</span></span> add_diff_cancel_left' append.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> butlast_take cancel_comm_monoid_add_class.diff_cancel length_greater_0_conv list.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> snoc_eq_iff_butlast take0 take_Nil trace.cases<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> step Suc.hyps <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ev</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Snapshot <span class="skolem">q</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="main">∄</span><span class="bound">p</span> <span class="bound">i</span><span class="main">.</span> Snapshot <span class="bound">p</span> <span class="main">=</span> <span class="free">t</span> <span class="main">!</span> <span class="bound">i</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">tr</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">ev</span><span class="main">]</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">tr</span> <span class="main">=</span> take <span class="main">(</span>Suc <span class="skolem">n</span> <span class="main">-</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>drop <span class="skolem">n</span> <span class="free">t</span><span class="main">)</span>›</span></span> append_Cons append_take_drop_id nth_append_length<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>RecvMarker <span class="skolem">cid'</span> <span class="skolem">q</span> <span class="skolem">r</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"Marker <span class="main">∈</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">cid'</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> RecvMarker_implies_Marker_in_set step <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">cid'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="skolem">cid'</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> step can_occur_def RecvMarker <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
              <span class="keyword1"><span class="command">using</span></span> IH assms no_marker_if_no_snapshot <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> m <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l2 assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">i</span> <span class="bound">p</span><span class="main">.</span> <span class="main">¬</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> recv_marker_means_snapshotted<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> RecvMarker <span class="free">cid</span> <span class="free">p</span> <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">=</span> hd <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">∧</span> length <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">#</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> next_recv_marker <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_greater_0_conv list.discI list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">∈</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> hd_in_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">q</span><span class="main">,</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms can_occur_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Marker <span class="main">∈</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> no_marker_if_no_snapshot <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> recv_marker_means_cs_Done<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> RecvMarker <span class="free">cid</span> <span class="free">p</span> <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> Done"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> step_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> snapshot_produces_marker<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"Marker <span class="main">:</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">∨</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ev</span></span> <span class="keyword2"><span class="keyword">where</span></span> ex_ev<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="main">⊢</span> <span class="skolem">ev</span> <span class="main">↦</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Nil2 append_take_drop_id assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> distributed_system.step_Suc distributed_system_axioms drop_eq_Nil less_Suc_eq_le nat_le_linear not_less_eq s_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"occurs_on <span class="skolem">ev</span> <span class="main">=</span> <span class="free">p</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> no_state_change_if_no_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">using</span></span> assms ex_ev <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ev</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Snapshot <span class="skolem">r</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">∈</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> ex_ev assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>RecvMarker <span class="skolem">cid'</span> <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹occurs_on <span class="skolem">ev</span> <span class="main">=</span> <span class="free">p</span>›</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> RecvMarker<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">cid</span> <span class="main">=</span> <span class="skolem">cid'</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">q</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> RecvMarker RecvMarker_implies_Marker_in_set assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> ex_ev no_marker_if_no_snapshot <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> RecvMarker assms can_occur_def <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="free">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">@</span> <span class="main">[</span>Marker<span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> RecvMarker assms ex_ev <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="free">p</span>›</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> exists_snapshot_for_all_p<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="bound">i</span><span class="main">)</span> <span class="free">p</span> <span class="main">∧</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l2 assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?j</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">LEAST</span> <span class="bound">j</span><span class="main">.</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="bound">j</span><span class="main">)</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?j</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">0</span><span class="main">)</span> <span class="free">p</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> exists_trace_for_any_i list.discI no_initial_process_snapshot s_def take_eq_Nil trace.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">p</span>›</span></span> wellorder_Least_lemma<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?j</span> <span class="main">≤</span> <span class="skolem">i</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Least_le <span class="quoted"><span class="quoted">‹has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">p</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="var">?j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?P</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="var">?j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="var">?j</span> <span class="main">∧</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="bound">j</span><span class="main">)</span> <span class="free">p</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">j</span><span class="main">.</span> ps <span class="main">(</span>S <span class="free">t</span> <span class="bound">j</span><span class="main">)</span> <span class="free">p</span> <span class="main">≠</span> None<span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> diff_less lessI not_gr_zero<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> 
      <span class="keyword1"><span class="command">using</span></span> not_less_Least <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?Q</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">¬</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="bound">i</span><span class="main">)</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i'</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i'</span><span class="main">)</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">i'</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> 0
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">j</span><span class="main">.</span> ps <span class="main">(</span>S <span class="free">t</span> <span class="bound">j</span><span class="main">)</span> <span class="free">p</span> <span class="main">≠</span> None<span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i''</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∄</span><span class="bound">i</span><span class="main">.</span> <span class="main">¬</span> ps <span class="main">(</span>S <span class="free">t</span> <span class="bound">i</span><span class="main">)</span> <span class="free">p</span> <span class="main">≠</span> None <span class="main">∧</span> ps <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">≠</span> None›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹ps <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">p</span> <span class="main">≠</span> None›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> all_processes_snapshotted_in_final_state<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"has_snapshotted <span class="free">final</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">p</span> <span class="main">∧</span> <span class="skolem">i</span> <span class="main">≤</span> length <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms l2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">final</span> <span class="main">=</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>length <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> assms exists_trace_for_any_i le_Suc_eq length_Cons take_Nil take_all trace.simps trace_and_start_determines_end<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms exists_trace_for_any_i_j snapshot_stable <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">next_marker_free_state</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">next_marker_free_state</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">cid</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≥</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">j</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cid</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> exists_next_marker_free_state<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">j</span><span class="main">.</span> next_marker_free_state <span class="free">t</span> <span class="free">i</span> <span class="free">cid</span> <span class="main">=</span> <span class="bound">j</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">≥</span> <span class="free">i</span> <span class="main">∧</span> Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="bound">j</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Marker <span class="main">∈</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"next_marker_free_state <span class="free">t</span> <span class="free">i</span> <span class="free">cid</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> next_marker_free_state_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Least_equality order_refl<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> False assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≥</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l1 assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> LeastI_ex next_marker_free_state_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> snapshot_algorithm_must_terminate<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">phi</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="bound">phi</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span>
          <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">cid</span><span class="main">.</span> Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="bound">phi</span><span class="main">)</span> <span class="bound">cid</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> length <span class="free">t</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> fin_i<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="var">?i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?i</span> <span class="main">≠</span> empty"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>length <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="bound">p</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms exists_trace_for_any_i_j l2 snapshot_stable_2<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="bound">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≥</span> <span class="skolem">i</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="bound">j</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> snapshot_stable asm exists_trace_for_any_i_j valid assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">cid</span><span class="main">.</span> <span class="main">(</span>next_marker_free_state <span class="free">t</span> <span class="skolem">i</span> <span class="bound">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span> <span class="bound">cid</span><span class="main">.</span> <span class="free">channel</span> <span class="bound">cid</span> <span class="main">≠</span> None <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?s</span> <span class="main">≠</span> empty"</span></span> <span class="keyword1"><span class="command">using</span></span> exists_some_channel <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> fin_s<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="var">?s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> finite_channels <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?phi</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Max <span class="var">?s</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?phi</span> <span class="main">≥</span> <span class="skolem">i</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?phi</span> <span class="main">≥</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cid</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="skolem">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> exists_some_channel <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"next_marker_free_state <span class="free">t</span> <span class="skolem">i</span> <span class="skolem">cid</span> <span class="main">≥</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> exists_next_marker_free_state assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max <span class="var">?s</span> <span class="main">≥</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Max_ge_iff g fin_s <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> asm <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">cid</span><span class="main">.</span> Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="var">?phi</span><span class="main">)</span> <span class="bound">cid</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">cid</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="var">?phi</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Marker <span class="main">:</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">≤</span> Max <span class="var">?s</span>›</span></span> asm assms exists_trace_for_any_i_j no_markers_if_all_snapshotted <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> cpq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="skolem">cid</span> <span class="main">≠</span> None"</span></span> <span class="keyword1"><span class="command">using</span></span> no_messages_if_no_channel assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> chan<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="skolem">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> next_marker_free_state <span class="free">t</span> <span class="skolem">i</span> <span class="skolem">cid</span>"</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> exists_next_marker_free_state assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> <span class="var">?phi</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cpq fin_s i<span class="main">(</span>1<span class="main">)</span> pair_imageI <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="var">?phi</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span><span class="var">?phi</span> <span class="main">-</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span>drop <span class="skolem">j</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>S <span class="free">t</span> <span class="var">?phi</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">≤</span> <span class="var">?phi</span>›</span></span> assms exists_trace_for_any_i_j <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="bound">p</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms chan f computation.exists_next_marker_free_state computation_axioms i<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
          <span class="keyword1"><span class="command">using</span></span> i<span class="main">(</span>2<span class="main">)</span> no_markers_if_all_snapshotted <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> f <span class="quoted"><span class="quoted">‹<span class="var">?phi</span> <span class="main">≥</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Correctness›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The greatest part of this work is spent on the correctness
of the Chandy-Lamport algorithm. We prove that the snapshot is
consistent, i.e.\ there exists a permutation $t'$ of the trace $t$ and an intermediate
configuration $c'$ of $t'$ such that the configuration recorded in the snapshot
corresponds to the snapshot taken during execution of $t$, which is given as Theorem 1
in~\cite{chandy}.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> snapshot_stable_ver_2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span> <span class="main">⟹</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">p</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">≥</span> <span class="free">i</span> <span class="main">⟹</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">j</span><span class="main">)</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> exists_trace_for_any_i_j snapshot_stable <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> snapshot_stable_ver_3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span> <span class="main">⟹</span> <span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">p</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≥</span> <span class="free">j</span> <span class="main">⟹</span> <span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">j</span><span class="main">)</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> snapshot_stable_ver_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> marker_must_stay_if_no_snapshot<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"Marker <span class="main">:</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="free">p</span> <span class="main">∧</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> exists_snapshot_for_all_p assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="skolem">j</span> <span class="main">≤</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">p</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="free">p</span> <span class="main">∧</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> less_imp_le_nat snapshot_stable_ver_3 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> nat_le_linear<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> length <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="free">i</span> <span class="main">≤</span> length <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&gt;</span> length <span class="free">t</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> not_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i'</span><span class="main">)</span> <span class="bound">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms snapshot_algorithm_must_terminate <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">≥</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i'</span><span class="main">)</span> <span class="bound">p</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> nat_le_linear snapshot_stable_ver_3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="free">t</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">≠</span> <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms a <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> length <span class="free">t</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≤</span> <span class="skolem">i'</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> computation.no_change_if_ge_length_t computation_axioms nat_le_linear <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">~</span> <span class="free">i</span> <span class="main">≤</span> length <span class="free">t</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> marker_in_set<span class="main">:</span> <span class="quoted"><span class="quoted">"Marker <span class="main">:</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="free">p</span> <span class="main">∧</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">≤</span> <span class="free">i</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> snapshot_produces_marker snapshot_stable_ver_3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> range<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_lessI <span class="quoted"><span class="quoted">‹<span class="main">¬</span> ps <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="free">p</span> <span class="main">≠</span> None <span class="main">∧</span> ps <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">≠</span> None›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">≤</span> <span class="free">i</span>›</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> marker_in_set order.order_iff_strict<span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?k</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">LEAST</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≥</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">∧</span> Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="bound">k</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> range_k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">&lt;</span> <span class="var">?k</span> <span class="main">∧</span> <span class="var">?k</span> <span class="main">≤</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span> Suc <span class="skolem">j</span> <span class="main">≤</span> <span class="bound">n</span> <span class="main">∧</span> Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="bound">n</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> Suc_le_eq assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> exists_next_marker_free_state next_marker_free_state_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span> Suc <span class="skolem">j</span> <span class="main">≤</span> <span class="bound">n</span> <span class="main">∧</span> Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="bound">n</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> local.range <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span> <span class="comment1">(* 4 ms *)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Suc <span class="skolem">j</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">∧</span> Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span> Suc <span class="skolem">j</span> <span class="main">≤</span> <span class="bound">n</span> <span class="main">∧</span> Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="bound">n</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> Suc <span class="skolem">j</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> Suc_leI asm marker_in_set wellorder_Least_lemma<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="comment1">(* 64 ms *)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> a1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wellorder_Least_lemma<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="comment1">(* 16 ms *)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"Marker <span class="main">:</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="var">?k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">nn</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x0</span> <span class="bound">x1</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v2</span><span class="main">.</span> <span class="bound">x0</span> <span class="main">=</span> Suc <span class="main">(</span><span class="bound">x1</span> <span class="main">+</span> <span class="bound">v2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">x0</span> <span class="main">=</span> Suc <span class="main">(</span><span class="bound">x1</span> <span class="main">+</span> <span class="skolem">nn</span> <span class="bound">x0</span> <span class="bound">x1</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">moura</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span> Suc <span class="skolem">j</span> <span class="main">≤</span> <span class="bound">n</span> <span class="main">∧</span> Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="bound">n</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>Suc <span class="skolem">j</span> <span class="main">+</span> <span class="skolem">nn</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span> Suc <span class="skolem">j</span> <span class="main">≤</span> <span class="bound">n</span> <span class="main">∧</span> Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="bound">n</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">j</span> <span class="main">&lt;</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">k</span><span class="main">.</span> Suc <span class="skolem">j</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">∧</span> Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="bound">k</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">k</span><span class="main">.</span> Suc <span class="skolem">j</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">∧</span> Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="bound">k</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">i</span>›</span></span> less_iff_Suc_add <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">j</span> <span class="main">≤</span> Suc <span class="skolem">j</span> <span class="main">+</span> <span class="skolem">nn</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span> Suc <span class="skolem">j</span> <span class="main">≤</span> <span class="bound">n</span> <span class="main">∧</span> Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="bound">n</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> f3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="bound">n</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">p</span> <span class="main">(</span><span class="bound">n</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">∨</span> Least <span class="bound">p</span> <span class="main">≤</span> <span class="bound">n</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> wellorder_Least_lemma<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span> Suc <span class="skolem">j</span> <span class="main">≤</span> <span class="bound">n</span> <span class="main">∧</span> Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="bound">n</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> Suc <span class="skolem">j</span> <span class="main">+</span> <span class="skolem">nn</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span> Suc <span class="skolem">j</span> <span class="main">≤</span> <span class="bound">n</span> <span class="main">∧</span> Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="bound">n</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> f1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>Suc <span class="skolem">j</span> <span class="main">≤</span> Suc <span class="skolem">j</span> <span class="main">+</span> <span class="skolem">nn</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span> Suc <span class="skolem">j</span> <span class="main">≤</span> <span class="bound">n</span> <span class="main">∧</span> Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="bound">n</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">∧</span> Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">j</span> <span class="main">+</span> <span class="skolem">nn</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span> Suc <span class="skolem">j</span> <span class="main">≤</span> <span class="bound">n</span> <span class="main">∧</span> Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="bound">n</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> f3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">j</span> <span class="main">+</span> <span class="skolem">nn</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span> Suc <span class="skolem">j</span> <span class="main">≤</span> <span class="bound">n</span> <span class="main">∧</span> Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="bound">n</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span> Suc <span class="skolem">j</span> <span class="main">≤</span> <span class="bound">n</span> <span class="main">∧</span> Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="bound">n</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> f1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> f4 f2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="var">?k</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> exists_next_marker_free_state next_marker_free_state_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?k</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> range_k <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ev</span></span> <span class="keyword2"><span class="keyword">where</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="var">?k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">⊢</span> <span class="skolem">ev</span> <span class="main">↦</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="main">(</span><span class="var">?k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Suc_le_eq <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≤</span> length <span class="free">t</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> le_trans step_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> a assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> b computation.snapshot_stable_ver_3 computation_axioms less_iff_Suc_add range_k recv_marker_means_snapshotted_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Pre- and postrecording events›</span></span>

<span class="keyword1"><span class="command">definition</span></span> prerecording_event<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">prerecording_event</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span>
      <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> regular_event <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>
    <span class="main">∧</span> <span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">(</span>occurs_on <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> postrecording_event<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">postrecording_event</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span>
      <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> regular_event <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>
    <span class="main">∧</span> has_snapshotted <span class="main">(</span>S <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">(</span>occurs_on <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">neighboring</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">neighboring</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> regular_event <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">∧</span> regular_event <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span>
                     <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">⟶</span> <span class="main">~</span> regular_event <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pre_if_regular_and_not_post<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">~</span> postrecording_event <span class="free">t</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"prerecording_event <span class="free">t</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms computation.postrecording_event computation_axioms prerecording_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">lemma</span></span> post_if_regular_and_not_pre<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">~</span> prerecording_event <span class="free">t</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"postrecording_event <span class="free">t</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms computation.postrecording_event computation_axioms prerecording_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">lemma</span></span> post_before_pre_different_processes<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    neighboring<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="free">i</span> <span class="main">&lt;</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">~</span> regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    post_ei<span class="main">:</span> <span class="quoted"><span class="quoted">"postrecording_event <span class="free">t</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    pre_ej<span class="main">:</span> <span class="quoted"><span class="quoted">"prerecording_event <span class="free">t</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    valid<span class="main">:</span> <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">≠</span> occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> sp<span class="main">:</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="var">?p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms postrecording_event prerecording_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> nsq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">j</span><span class="main">)</span> <span class="var">?q</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms postrecording_event prerecording_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">≠</span> <span class="var">?q</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="var">?q</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> sq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="var">?q</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> less_imp_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tr</span></span> <span class="keyword2"><span class="keyword">where</span></span> ex_trace<span class="main">:</span> <span class="quoted"><span class="quoted">"trace <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">tr</span> <span class="main">(</span>S <span class="free">t</span> <span class="free">j</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> exists_trace_for_any_i_j valid <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">j</span><span class="main">)</span> <span class="var">?q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ex_trace snapshot_stable sq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> nsq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> sp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> post_before_pre_neighbors<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    neighboring<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="free">i</span> <span class="main">&lt;</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">~</span> regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    post_ei<span class="main">:</span> <span class="quoted"><span class="quoted">"postrecording_event <span class="free">t</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    pre_ej<span class="main">:</span> <span class="quoted"><span class="quoted">"prerecording_event <span class="free">t</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    valid<span class="main">:</span> <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"Ball <span class="main">(</span>set <span class="main">(</span>take <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">%</span><span class="bound">ev</span><span class="main">.</span> <span class="main">~</span> regular_event <span class="bound">ev</span> <span class="main">∧</span> <span class="main">~</span> occurs_on <span class="bound">ev</span> <span class="main">=</span> occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?between</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> Ball_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ev</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ev</span> <span class="main">:</span> set <span class="var">?between</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> len_nr<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="var">?between</span> <span class="main">=</span> <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?between</span> <span class="main">!</span> <span class="skolem">l</span> <span class="main">=</span> <span class="skolem">ev</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> range_l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">l</span> <span class="main">∧</span> <span class="skolem">l</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">ev</span> <span class="main">∈</span> set <span class="main">(</span>take <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>›</span></span> gr_zeroI in_set_conv_nth le_numeral_extra<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> less_le<span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?k</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">+</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?between</span> <span class="main">!</span> <span class="skolem">l</span> <span class="main">=</span> <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="var">?k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Suc_eq_plus1 Suc_leI add.commute assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> drop_take length_take less_diff_conv less_imp_le_nat min.absorb2 nth_drop nth_take range_l<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> regular_event <span class="skolem">ev</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> range_l One_nat_def Suc_eq_plus1 <span class="quoted"><span class="quoted">‹take <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">l</span> <span class="main">=</span> <span class="skolem">ev</span>›</span></span> <span class="quoted"><span class="quoted">‹take <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">l</span> <span class="main">=</span> <span class="free">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">l</span> <span class="main">+</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>›</span></span> add.left_commute add_lessD1 lessI less_add_same_cancel2 less_diff_conv order_le_less<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> step_ev<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="free">t</span> <span class="var">?k</span><span class="main">)</span> <span class="main">⊢</span> <span class="skolem">ev</span> <span class="main">↦</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="var">?k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> length <span class="free">t</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> less_or_eq_imp_le<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">+</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> less_diff_conv less_le_trans range_l<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Suc_eq_plus1 <span class="quoted"><span class="quoted">‹take <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">l</span> <span class="main">=</span> <span class="skolem">ev</span>›</span></span> <span class="quoted"><span class="quoted">‹take <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">l</span> <span class="main">=</span> <span class="free">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">l</span> <span class="main">+</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>›</span></span> distributed_system.step_Suc distributed_system_axioms valid<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cid</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ev</span> <span class="main">=</span> RecvMarker <span class="skolem">cid</span> <span class="skolem">s</span> <span class="skolem">r</span> <span class="main">∨</span> <span class="skolem">ev</span> <span class="main">=</span> Snapshot <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">~</span> regular_event <span class="skolem">ev</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> isRecvMarker_def isSnapshot_def nonregular_event<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> f <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"occurs_on <span class="skolem">ev</span> <span class="main">≠</span> <span class="var">?q</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> snapshot<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ev</span> <span class="main">=</span> Snapshot <span class="skolem">r</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> occurs_on_q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> occurs_on <span class="skolem">ev</span> <span class="main">≠</span> <span class="var">?q</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?q</span> <span class="main">=</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> snapshot <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> q_snapshotted<span class="main">:</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="var">?k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="var">?q</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> snapshot step_ev <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> 
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">+</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> less_diff_conv range_l<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Suc_eq_plus1 Suc_le_eq computation.snapshot_stable_ver_2 computation_axioms pre_ej prerecording_event q_snapshotted valid<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> RecvMarker<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ev</span> <span class="main">=</span> RecvMarker <span class="skolem">cid</span> <span class="skolem">s</span> <span class="skolem">r</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> occurs_on_q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> occurs_on <span class="skolem">ev</span> <span class="main">≠</span> <span class="var">?q</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="var">?q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> RecvMarker <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> q_snapshotted<span class="main">:</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="var">?k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="var">?q</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="var">?k</span><span class="main">)</span> <span class="var">?q</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> snapshot_stable_ver_2 step_Suc step_ev valid <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="var">?k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="var">?q</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">=</span> <span class="var">?q</span>›</span></span> next_recv_marker RecvMarker step_ev <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> 
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">+</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> less_diff_conv range_l <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Suc_eq_plus1 Suc_le_eq computation.snapshot_stable_ver_2 computation_axioms pre_ej prerecording_event q_snapshotted valid<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> regular_event <span class="skolem">ev</span> <span class="main">∧</span> occurs_on <span class="skolem">ev</span> <span class="main">≠</span> <span class="var">?q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">~</span> regular_event <span class="skolem">ev</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> can_swap_neighboring_pre_and_postrecording_events<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    neighboring<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="free">i</span> <span class="main">&lt;</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span><span class="main">)</span>
                   <span class="main">⟶</span> <span class="main">~</span> regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    post_ei<span class="main">:</span> <span class="quoted"><span class="quoted">"postrecording_event <span class="free">t</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    pre_ej<span class="main">:</span> <span class="quoted"><span class="quoted">"prerecording_event <span class="free">t</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    valid<span class="main">:</span> <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"can_occur <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> post_before_pre_different_processes assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> sp<span class="main">:</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">p</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> post_ei postrecording_event prerecording_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> nsq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">j</span><span class="main">)</span> <span class="free">q</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> pre_ej prerecording_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?nr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> valid_subtrace<span class="main">:</span> <span class="quoted"><span class="quoted">"trace <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="var">?nr</span> <span class="main">(</span>S <span class="free">t</span> <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> exists_trace_for_any_i_j valid <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Ball <span class="main">(</span>set <span class="var">?nr</span><span class="main">)</span> <span class="main">(</span><span class="main">%</span><span class="bound">ev</span><span class="main">.</span> <span class="main">~</span> occurs_on <span class="bound">ev</span> <span class="main">=</span> <span class="free">q</span> <span class="main">∧</span> <span class="main">~</span> regular_event <span class="bound">ev</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?nr</span> <span class="main">=</span> take <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> neighboring post_ei pre_ej valid post_before_pre_neighbors<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> la<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">%</span><span class="bound">ev</span><span class="main">.</span> <span class="main">~</span> occurs_on <span class="bound">ev</span> <span class="main">=</span> <span class="free">q</span><span class="main">)</span> <span class="var">?nr</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> list_all_length nth_mem<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> tj_to_tSi<span class="main">:</span> <span class="quoted"><span class="quoted">"can_occur <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">%</span><span class="bound">ev</span><span class="main">.</span> <span class="main">~</span> isSend <span class="bound">ev</span><span class="main">)</span> <span class="var">?nr</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">%</span><span class="bound">ev</span><span class="main">.</span> <span class="main">~</span> regular_event <span class="bound">ev</span><span class="main">)</span> <span class="var">?nr</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">ev</span><span class="main">∈</span>set <span class="main">(</span>take <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> occurs_on <span class="bound">ev</span> <span class="main">≠</span> <span class="free">q</span> <span class="main">∧</span> <span class="main">¬</span> regular_event <span class="bound">ev</span>›</span></span> <span class="quoted"><span class="quoted">‹list_all <span class="main">(</span><span class="main">λ</span><span class="bound">ev</span><span class="main">.</span> occurs_on <span class="bound">ev</span> <span class="main">≠</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>›</span></span> list.pred_mono_strong <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list.pred_mono_strong<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> isRecvMarker <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prerecording_event assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"can_occur <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>S <span class="free">t</span> <span class="free">j</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="free">t</span> <span class="free">j</span><span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> step_Suc valid <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">using</span></span> happen_implies_can_occur <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"can_occur <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> event_can_go_back_if_no_sender_trace valid_subtrace la <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"can_occur <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"isSend <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> isRecvMarker <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms prerecording_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> isSend <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">≠</span> <span class="free">q</span>›</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> event_can_go_back_if_no_sender post_ei postrecording_event step_Suc tj_to_tSi valid<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cid</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> Send<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> Send <span class="skolem">cid</span> <span class="free">p</span> <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> True isSend_def assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> event.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> chan<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="skolem">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"can_occur <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> computation.postrecording_event computation_axioms happen_implies_can_occur post_ei step_Suc valid<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> can_occur_def Send <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> step_Suc valid True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"states <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">q</span> <span class="main">=</span> states <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="free">q</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Send <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">≠</span> <span class="free">q</span>›</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"isTrans <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span> <span class="main">∨</span> isSend <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span> <span class="main">∨</span> isRecv <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>7<span class="main">)</span> computation.prerecording_event computation_axioms regular_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"isTrans <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> tj_to_tSi st can_occur_def assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> event.case<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> event.collapse<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"isSend <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cid'</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="skolem"><span class="skolem">u''</span></span> <span class="skolem"><span class="skolem">u'''</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="keyword2"><span class="keyword">where</span></span> Send<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">!</span> <span class="free">j</span> <span class="main">=</span> Send <span class="skolem">cid'</span> <span class="free">q</span> <span class="skolem">s'</span> <span class="skolem">u''</span> <span class="skolem">u'''</span> <span class="skolem">m'</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> event.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> isSend_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> co_tSi<span class="main">:</span> <span class="quoted"><span class="quoted">"can_occur <span class="main">(</span>Send <span class="skolem">cid'</span> <span class="free">q</span> <span class="skolem">s'</span> <span class="skolem">u''</span> <span class="skolem">u'''</span> <span class="skolem">m'</span><span class="main">)</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> Send tj_to_tSi <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="skolem">cid'</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">q</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span> <span class="main">∧</span> <span class="free">send</span> <span class="skolem">cid'</span> <span class="free">q</span> <span class="skolem">s'</span> <span class="skolem">u''</span> <span class="skolem">u'''</span> <span class="skolem">m'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Send can_occur_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> can_occur_def st Send assms co_tSi <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"isRecv <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cid'</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="skolem"><span class="skolem">u''</span></span> <span class="skolem"><span class="skolem">u'''</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="keyword2"><span class="keyword">where</span></span> Recv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">!</span> <span class="free">j</span> <span class="main">=</span> Recv <span class="skolem">cid'</span> <span class="free">q</span> <span class="skolem">s'</span> <span class="skolem">u''</span> <span class="skolem">u'''</span> <span class="skolem">m'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> event.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> isRecv_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> co_tSi<span class="main">:</span> <span class="quoted"><span class="quoted">"can_occur <span class="main">(</span>Recv <span class="skolem">cid'</span> <span class="free">q</span> <span class="skolem">s'</span> <span class="skolem">u''</span> <span class="skolem">u'''</span> <span class="skolem">m'</span><span class="main">)</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> Recv tj_to_tSi <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="skolem">cid'</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span> <span class="main">∧</span> length <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid'</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>
                  <span class="main">∧</span> hd <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid'</span><span class="main">)</span> <span class="main">=</span> Msg <span class="skolem">m'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> can_occur_def co_tSi <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"can_occur <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">cid</span> <span class="main">=</span> <span class="skolem">cid'</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">with</span></span> Send n <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid'</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">cid'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">cid'</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> hd <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">cid'</span><span class="main">)</span> <span class="main">=</span> Msg <span class="skolem">m'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">with</span></span> can_occur_Recv co_tSi st a Recv <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> can_occur_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> True <span class="comment1">(* This is the interesting case *)</span>
        <span class="keyword1"><span class="command">have</span></span> stu<span class="main">:</span> <span class="quoted"><span class="quoted">"states <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">q</span> <span class="main">=</span> <span class="skolem">u''</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> can_occur_Recv co_tSi st <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> marker_in_set<span class="main">:</span> <span class="quoted"><span class="quoted">"Marker <span class="main">∈</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span>"</span></span> 
              <span class="keyword1"><span class="command">using</span></span> True a chan <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> True <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">≠</span> <span class="free">q</span>›</span></span> a assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> marker_must_stay_if_no_snapshot n no_state_change_if_no_event nsq snapshot_stable_2 sp valid valid_subtrace<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> can_occur <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> can_occur_def<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> marker_in_set True Recv stu<span class="main">)</span><span class="main">)</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">cid'</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> marker_in_set 
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> True<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">cid'</span><span class="main">)</span> <span class="main">≠</span> Msg <span class="skolem">m'</span>"</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">cid</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> marker_in_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">cid</span> <span class="main">@</span> <span class="main">[</span>Msg <span class="skolem">m</span><span class="main">]</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> Send True n chan <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span> <span class="main">≠</span> Msg <span class="skolem">m'</span>"</span></span> 
              <span class="keyword1"><span class="command">using</span></span> True <span class="quoted"><span class="quoted">‹hd <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">cid'</span><span class="main">)</span> <span class="main">≠</span> Msg <span class="skolem">m'</span>›</span></span> <span class="quoted"><span class="quoted">‹msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">cid</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> can_occur <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span> 
              <span class="keyword1"><span class="command">using</span></span> True a <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> 
              <span class="keyword1"><span class="command">using</span></span> tj_to_tSi <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="free">recv</span> <span class="skolem">cid'</span> <span class="free">q</span> <span class="skolem">s'</span> <span class="skolem">u''</span> <span class="skolem">u'''</span> <span class="skolem">m'</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> 
              <span class="keyword1"><span class="command">using</span></span> can_occur_Recv co_tSi <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="skolem">cid'</span> <span class="main">≠</span> Some <span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> can_occur_def tj_to_tSi Recv <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Event swapping›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> swap_events<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span><span class="main">;</span> <span class="free">j</span> <span class="main">&lt;</span> length <span class="free">t</span><span class="main">;</span>
          <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="free">i</span> <span class="main">&lt;</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">~</span> regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">;</span>
          postrecording_event <span class="free">t</span> <span class="free">i</span><span class="main">;</span> prerecording_event <span class="free">t</span> <span class="free">j</span><span class="main">;</span>
          trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span> <span class="main">⟧</span>
        <span class="main">⟹</span> trace <span class="free">init</span> <span class="main">(</span>swap_events <span class="free">i</span> <span class="free">j</span> <span class="free">t</span><span class="main">)</span> <span class="free">final</span>
          <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≥</span> <span class="free">j</span> <span class="main">+</span> <span class="main">1</span> <span class="main">⟶</span> S <span class="main">(</span>swap_events <span class="free">i</span> <span class="free">j</span> <span class="free">t</span><span class="main">)</span> <span class="bound">k</span> <span class="main">=</span> S <span class="free">t</span> <span class="bound">k</span><span class="main">)</span>
          <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">⟶</span> S <span class="main">(</span>swap_events <span class="free">i</span> <span class="free">j</span> <span class="free">t</span><span class="main">)</span> <span class="bound">k</span> <span class="main">=</span> S <span class="free">t</span> <span class="bound">k</span><span class="main">)</span>
          <span class="main">∧</span> prerecording_event <span class="main">(</span>swap_events <span class="free">i</span> <span class="free">j</span> <span class="free">t</span><span class="main">)</span> <span class="free">i</span>
          <span class="main">∧</span> postrecording_event <span class="main">(</span>swap_events <span class="free">i</span> <span class="free">j</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>
          <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&gt;</span> <span class="free">i</span><span class="main">+</span><span class="main">1</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span><span class="main">+</span><span class="main">1</span>
               <span class="main">⟶</span> <span class="main">~</span> regular_event <span class="main">(</span><span class="main">(</span>swap_events <span class="free">i</span> <span class="free">j</span> <span class="free">t</span><span class="main">)</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">-</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"occurs_on <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"occurs_on <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.prems"</span> <span class="quoted">"0.hyps"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?subt</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> take <span class="free">i</span> <span class="skolem">t</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span> <span class="main">@</span> <span class="var">?subt</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span> <span class="main">@</span> drop <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">t</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">=</span> take <span class="free">i</span> <span class="skolem">t</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.prems"</span><span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">=</span> <span class="free">i</span> <span class="main">+</span> <span class="main">1</span>›</span></span> add_lessD1 take_Suc_conv_app_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> <span class="quoted">"0.hyps"</span> <span class="quoted">"0.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Suc_eq_plus1 <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">=</span> <span class="free">i</span> <span class="main">+</span> <span class="main">1</span>›</span></span> append_assoc append_take_drop_id self_append_conv2 take_Suc_conv_app_nth take_eq_Nil<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> sp<span class="main">:</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="skolem">t</span> <span class="free">i</span><span class="main">)</span> <span class="var">?p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.prems"</span> postrecording_event prerecording_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> nsq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="skolem">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="var">?q</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.prems"</span> postrecording_event prerecording_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">≠</span> <span class="var">?q</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.prems"</span> computation.post_before_pre_different_processes computation_axioms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?subt</span> <span class="main">=</span> Nil"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">=</span> <span class="free">i</span> <span class="main">+</span> <span class="main">1</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> reg_step_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="skolem">t</span> <span class="free">i</span><span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span>S <span class="skolem">t</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"0.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quoted">"0.prems"</span><span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> Suc_eq_plus1 <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">=</span> <span class="free">i</span> <span class="main">+</span> <span class="main">1</span>›</span></span> add_lessD1 step_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> reg_step_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="skolem">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.prems"</span><span class="main">(</span>2<span class="main">)</span> <span class="quoted">"0.prems"</span><span class="main">(</span>6<span class="main">)</span> step_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"can_occur <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span>S <span class="skolem">t</span> <span class="free">i</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.prems"</span> can_swap_neighboring_pre_and_postrecording_events <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d'</span></span> <span class="keyword2"><span class="keyword">where</span></span> new_step1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="skolem">t</span> <span class="free">i</span><span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">↦</span> <span class="skolem">d'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> exists_next_if_can_occur <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"states <span class="skolem">d'</span> <span class="var">?p</span> <span class="main">=</span> states <span class="main">(</span>S <span class="skolem">t</span> <span class="free">i</span><span class="main">)</span> <span class="var">?p</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>S <span class="skolem">t</span> <span class="free">i</span><span class="main">)</span> <span class="main">⊢</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">↦</span> <span class="skolem">d'</span>›</span></span> <span class="quoted"><span class="quoted">‹occurs_on <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">≠</span> occurs_on <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>›</span></span> no_state_change_if_no_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"can_occur <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">d'</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹occurs_on <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">≠</span> occurs_on <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>›</span></span> event_stays_valid_if_no_occurrence happen_implies_can_occur new_step1 reg_step_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> new_step2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d'</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">↦</span> <span class="skolem">e</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> exists_next_if_can_occur <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"states <span class="skolem">e</span> <span class="main">=</span> states <span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"states <span class="skolem">e</span> <span class="skolem">p</span> <span class="main">=</span> states <span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="var">?p</span> <span class="main">∨</span> <span class="skolem">p</span> <span class="main">=</span> <span class="var">?q</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="var">?p</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"states <span class="skolem">d'</span> <span class="skolem">p</span> <span class="main">=</span> states <span class="main">(</span>S <span class="skolem">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> st<span class="main">)</span>
        <span class="keyword1"><span class="command">thm</span></span> same_state_implies_same_result_state
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"states <span class="skolem">e</span> <span class="skolem">p</span> <span class="main">=</span> states <span class="main">(</span>S <span class="skolem">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">p</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.prems"</span><span class="main">(</span>2<span class="main">)</span> <span class="quoted">"0.prems"</span><span class="main">(</span>6<span class="main">)</span> new_step2 reg_step_1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>same_state_implies_same_result_state<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"states <span class="main">(</span>S <span class="skolem">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> states <span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹occurs_on <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">≠</span> occurs_on <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">=</span> occurs_on <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>›</span></span> no_state_change_if_no_event reg_step_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="var">?q</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"states <span class="main">(</span>S <span class="skolem">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> states <span class="main">(</span>S <span class="skolem">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> reg_step_1 <span class="quoted"><span class="quoted">‹occurs_on <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">≠</span> occurs_on <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>›</span></span> no_state_change_if_no_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"states <span class="skolem">d'</span> <span class="skolem">p</span> <span class="main">=</span> states <span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.prems"</span><span class="main">(</span>5<span class="main">)</span> prerecording_event computation_axioms new_step1 reg_step_2 same_state_implies_same_result_state <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"states <span class="skolem">e</span> <span class="skolem">p</span> <span class="main">=</span> states <span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹occurs_on <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">≠</span> occurs_on <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">=</span> occurs_on <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>›</span></span> calculation new_step2 no_state_change_if_no_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"states <span class="main">(</span>S <span class="skolem">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> states <span class="main">(</span>S <span class="skolem">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> no_state_change_if_no_event reg_step_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> states <span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> False no_state_change_if_no_event reg_step_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> states <span class="skolem">d'</span> <span class="skolem">p</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> False calculation new_step1 no_state_change_if_no_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> states <span class="skolem">e</span> <span class="skolem">p</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> False new_step2 no_state_change_if_no_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="skolem">e</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">cid</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"isTrans <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">∨</span> isSend <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">∨</span> isRecv <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.prems"</span><span class="main">(</span>4<span class="main">)</span> computation.postrecording_event computation_axioms regular_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"isTrans <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∨</span> isSend <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∨</span> isRecv <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.prems"</span><span class="main">(</span>5<span class="main">)</span> computation.prerecording_event computation_axioms regular_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"msgs <span class="skolem">e</span> <span class="skolem">cid</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="skolem">d'</span> <span class="skolem">cid</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="skolem">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">cid</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Trans_msg new_step1 reg_step_1<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">using</span></span> Trans_msg <span class="quoted"><span class="quoted">‹isTrans <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹isTrans <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>›</span></span> new_step2 reg_step_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹occurs_on <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">≠</span> occurs_on <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>›</span></span> new_step1 new_step2 reg_step_1 reg_step_2 swap_msgs_Trans_Send <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 3
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹occurs_on <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">≠</span> occurs_on <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>›</span></span> new_step1 new_step2 reg_step_1 reg_step_2 swap_msgs_Trans_Recv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 4
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹occurs_on <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">≠</span> occurs_on <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>›</span></span> new_step1 new_step2 reg_step_1 reg_step_2 swap_msgs_Send_Trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 5
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹occurs_on <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">≠</span> occurs_on <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>›</span></span> new_step1 new_step2 reg_step_1 reg_step_2 swap_msgs_Recv_Trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 6
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹occurs_on <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">≠</span> occurs_on <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>›</span></span> new_step1 new_step2 reg_step_1 reg_step_2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>swap_msgs_Send_Send<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 7
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹occurs_on <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">≠</span> occurs_on <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>›</span></span> new_step1 new_step2 reg_step_1 reg_step_2 swap_msgs_Send_Recv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 8
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹occurs_on <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">≠</span> occurs_on <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>›</span></span> new_step1 new_step2 reg_step_1 reg_step_2 swap_msgs_Send_Recv <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 9
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹occurs_on <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">≠</span> occurs_on <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>›</span></span> new_step1 new_step2 reg_step_1 reg_step_2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>swap_msgs_Recv_Recv<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"process_snapshot <span class="skolem">e</span> <span class="main">=</span> process_snapshot <span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"process_snapshot <span class="skolem">d'</span> <span class="skolem">p</span> <span class="main">=</span> process_snapshot <span class="main">(</span>S <span class="skolem">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"0.prems"</span><span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> <span class="quoted">"0.prems"</span><span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> computation.postrecording_event computation.prerecording_event computation_axioms new_step1 reg_step_1 regular_event_preserves_process_snapshots<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"process_snapshot <span class="skolem">e</span> <span class="skolem">p</span> <span class="main">=</span> process_snapshot <span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"0.prems"</span><span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> <span class="quoted">"0.prems"</span><span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> computation.postrecording_event computation.prerecording_event computation_axioms new_step2 reg_step_2 regular_event_preserves_process_snapshots<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"channel_snapshot <span class="skolem">e</span> <span class="main">=</span> channel_snapshot <span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">cid</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cs <span class="skolem">e</span> <span class="skolem">cid</span> <span class="main">=</span> cs <span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"isRecv <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"isRecv <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?p</span> <span class="main">≠</span> <span class="var">?q</span>›</span></span> new_step1 new_step2 reg_step_1 reg_step_2
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>regular_event_implies_same_channel_snapshot_Recv_Recv<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"regular_event <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prerecording_event 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?p</span> <span class="main">≠</span> <span class="var">?q</span>›</span></span> new_step1 new_step2 reg_step_1 reg_step_2 regular_event_implies_same_channel_snapshot_Recv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> isRecv <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"isRecv <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"regular_event <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> postrecording_event 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?p</span> <span class="main">≠</span> <span class="var">?q</span>›</span></span> new_step1 new_step2 reg_step_1 reg_step_2 regular_event_implies_same_channel_snapshot_Recv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> isRecv <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> isRecv <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"regular_event <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prerecording_event 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"regular_event <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> postrecording_event 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?p</span> <span class="main">≠</span> <span class="var">?q</span>›</span></span> new_step1 new_step2 reg_step_1 reg_step_2 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> no_cs_change_if_no_event<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="skolem">t</span> <span class="free">i</span><span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">↦</span> <span class="skolem">d'</span> <span class="main">∧</span> <span class="skolem">d'</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> new_step1 new_step2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> swap<span class="main">:</span> <span class="quoted"><span class="quoted">"trace <span class="main">(</span>S <span class="skolem">t</span> <span class="free">i</span><span class="main">)</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span> <span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> trace.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>take <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span><span class="main">[</span><span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">=</span> <span class="free">i</span> <span class="main">+</span> <span class="main">1</span>›</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2 3<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">=</span> <span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span>›</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> drop <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">t</span><span class="main">[</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">=</span> <span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">=</span> <span class="free">i</span> <span class="main">+</span> <span class="main">1</span>›</span></span> add_Suc_right arith_special<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> swap_neighbors<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span>take <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span><span class="main">[</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> drop <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">t</span> <span class="main">[</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span><span class="main">[</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> take <span class="skolem">j</span> <span class="main">(</span><span class="skolem">t</span><span class="main">[</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">#</span> drop <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span><span class="main">[</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> <span class="quoted">"0.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> length_list_update upd_conv_take_nth_drop<span class="main">)</span> <span class="comment1">(* 32 ms *)</span>
        <span class="keyword1"><span class="command">have</span></span> f3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span> <span class="bound">na</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="bound">na</span> <span class="main">∨</span> Suc <span class="bound">n</span> <span class="main">≤</span> <span class="bound">na</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Suc_leI <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> <span class="comment1">(* 0.0 ms *)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min <span class="main">(</span>length <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> <span class="quoted">"0.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Suc_eq_plus1 min.absorb2<span class="main">)</span> <span class="comment1">(* 16 ms *)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f4<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="main">(</span>take <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span><span class="main">[</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="comment1">(* 4 ms *)</span>
        <span class="keyword1"><span class="command">have</span></span> f5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> length <span class="main">(</span><span class="skolem">t</span><span class="main">[</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> f3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> <span class="quoted">"0.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Suc_eq_plus1 length_list_update<span class="main">)</span> <span class="comment1">(* 8 ms *)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">j</span> <span class="main">≤</span> <span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span> <span class="comment1">(* 0.0 ms *)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>take <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span><span class="main">[</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">[</span><span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> take <span class="skolem">j</span> <span class="main">(</span><span class="skolem">t</span><span class="main">[</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">#</span> <span class="main">[]</span> <span class="main">@</span> <span class="main">[]</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> f5 f4 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Suc_eq_plus1 add_diff_cancel_right' butlast_conv_take butlast_take drop_eq_Nil lessI self_append_conv2 take_update_swap upd_conv_take_nth_drop<span class="main">)</span> <span class="comment1">(* 180 ms *)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> f2 a1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_update_swap<span class="main">)</span> <span class="comment1">(* 120 ms *)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="main">(</span>take <span class="free">i</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>S <span class="skolem">t</span> <span class="free">i</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.prems"</span><span class="main">(</span>6<span class="main">)</span> exists_trace_for_any_i <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"trace <span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span>length <span class="skolem">t</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="free">final</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="main">(</span>take <span class="main">(</span>length <span class="skolem">t</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span> <span class="free">final</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted">"0.prems"</span><span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"0.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Suc_eq_plus1 Suc_leI exists_trace_for_any_i exists_trace_for_any_i_j nat_le_linear take_all trace_and_start_determines_end<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="main">(</span>take <span class="free">i</span> <span class="skolem">t</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span> <span class="main">@</span> drop <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span> <span class="free">final</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> s swap <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="main">(</span>take <span class="free">i</span> <span class="skolem">t</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span><span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> trace_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="main">(</span>take <span class="free">i</span> <span class="skolem">t</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span> <span class="main">@</span> <span class="main">(</span>take <span class="main">(</span>length <span class="skolem">t</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">final</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> e trace_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="skolem">t</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> drop <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="free">i</span> <span class="skolem">t</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span> <span class="main">@</span> drop <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span><span class="main">[</span><span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>take <span class="free">i</span> <span class="skolem">t</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span> <span class="main">@</span> drop <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span><span class="main">(</span><span class="skolem">t</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span><span class="main">[</span><span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> take <span class="free">i</span> <span class="skolem">t</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span> <span class="main">@</span> take <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span> <span class="main">@</span> drop <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">t</span>›</span></span> <span class="quoted"><span class="quoted">‹take <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>›</span></span> length_append length_list_update list.size<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> self_append_conv2<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="main">(</span><span class="skolem">t</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span><span class="main">[</span><span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span>take <span class="free">i</span> <span class="skolem">t</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span> <span class="main">@</span> drop <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">t</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span><span class="main">[</span><span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="bound">k</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="main">(</span><span class="skolem">t</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span><span class="main">[</span><span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>take <span class="free">i</span> <span class="skolem">t</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span> <span class="main">@</span> drop <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">t</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span><span class="main">[</span><span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="free">i</span> <span class="main">∨</span> <span class="skolem">k</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">t</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span><span class="main">)</span>›</span></span> append_Cons le_eq_less_or_eq length_list_update length_take min.absorb2 nth_append_length nth_list_update_eq nth_list_update_neq<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted">"0.prems"</span><span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> Suc_eq_plus1 <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">=</span> <span class="free">i</span> <span class="main">+</span> <span class="main">1</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">t</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span><span class="main">)</span>›</span></span> append.assoc append_Cons le_eq_less_or_eq length_append_singleton length_list_update length_take min.absorb2 nth_append_length nth_list_update postrecording_event<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> knij<span class="main">:</span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted">"0.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">=</span> <span class="free">i</span> <span class="main">+</span> <span class="main">1</span>›</span></span> add_lessD1 length_take less_imp_le_nat min.absorb2 not_less nth_append nth_list_update_neq nth_take<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&gt;</span> <span class="skolem">j</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">=</span> <span class="free">i</span> <span class="main">+</span> <span class="main">1</span>›</span></span> knij <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>take <span class="free">i</span> <span class="skolem">t</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span> <span class="main">@</span> drop <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> drop <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">k</span><span class="main">-</span><span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">k</span>"</span></span>
            <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span> <span class="bound">na</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">n</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">&lt;</span> <span class="bound">na</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">n</span> <span class="main">≤</span> <span class="bound">na</span> <span class="main">∧</span> <span class="bound">n</span> <span class="main">≠</span> <span class="bound">na</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> nat_less_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> <span class="comment1">(* 0.0 ms *)</span>
            <span class="keyword1"><span class="command">have</span></span> f3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">+</span> <span class="main">0</span> <span class="main">=</span> min <span class="main">(</span>length <span class="skolem">t</span><span class="main">)</span> <span class="free">i</span> <span class="main">+</span> <span class="main">(</span><span class="main">0</span> <span class="main">+</span> <span class="main">0</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.prems"</span><span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">=</span> <span class="free">i</span> <span class="main">+</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span> <span class="comment1">(* 8 ms *)</span>
            <span class="keyword1"><span class="command">have</span></span> f4<span class="main">:</span> <span class="quoted"><span class="quoted">"min <span class="main">(</span>length <span class="skolem">t</span><span class="main">)</span> <span class="free">i</span> <span class="main">+</span> Suc <span class="main">(</span><span class="main">0</span> <span class="main">+</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>take <span class="free">i</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">+</span> length <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> <span class="comment1">(* 4 ms *)</span>
            <span class="keyword1"><span class="command">have</span></span> f5<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="free">i</span> <span class="skolem">t</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span> <span class="main">@</span> <span class="main">[]</span> <span class="main">=</span> take <span class="free">i</span> <span class="skolem">t</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="comment1">(* 0.0 ms *)</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> length <span class="main">(</span>take <span class="free">i</span> <span class="skolem">t</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span> <span class="main">@</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> f3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">=</span> <span class="free">i</span> <span class="main">+</span> <span class="main">1</span>›</span></span><span class="main">)</span> <span class="comment1">(* 4 ms *)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> length <span class="main">(</span>take <span class="free">i</span> <span class="skolem">t</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> <span class="comment1">(* 4 ms *)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">using</span></span> f5 f4 f3 f2 a1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> One_nat_def <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">=</span> <span class="free">i</span> <span class="main">+</span> <span class="main">1</span>›</span></span> add_Suc_right append.assoc length_append less_antisym list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> not_less nth_append<span class="main">)</span> <span class="comment1">(* 284 ms *)</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span><span class="main">[</span><span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> drop <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">t</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span><span class="main">[</span><span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">k</span><span class="main">-</span><span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.prems"</span><span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">t</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span><span class="main">[</span><span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> drop <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">t</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.prems"</span><span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_eq_iff_nth_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≥</span> <span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span> <span class="main">⟶</span> S <span class="skolem">t</span> <span class="bound">k</span> <span class="main">=</span> S <span class="main">(</span><span class="main">(</span><span class="skolem">t</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span><span class="main">[</span><span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span><span class="main">)</span> <span class="bound">k</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≥</span> <span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?newt</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">t</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span><span class="main">[</span><span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="main">(</span>take <span class="skolem">k</span> <span class="var">?newt</span><span class="main">)</span> <span class="main">(</span>S <span class="var">?newt</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> calculation<span class="main">(</span>1<span class="main">)</span> calculation<span class="main">(</span>2<span class="main">)</span> exists_trace_for_any_i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="skolem">k</span> <span class="var">?newt</span> <span class="main">=</span> take <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="var">?newt</span> <span class="main">@</span> take <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="var">?newt</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> <span class="skolem">k</span>›</span></span> le_add_diff_inverse take_add<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> same_traces<span class="main">:</span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">=</span> drop <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="var">?newt</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"0.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Suc_eq_plus1 <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">=</span> <span class="free">i</span> <span class="main">+</span> <span class="main">1</span>›</span></span> drop_update_cancel less_SucI less_add_same_cancel1<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="main">(</span>take <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">t</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span><span class="main">[</span><span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">=</span> <span class="free">i</span> <span class="main">+</span> <span class="main">1</span>›</span></span> <span class="quoted"><span class="quoted">‹take <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span>take <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span>›</span></span> add_diff_cancel_right' local.swap s take_update_swap trace_trans<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="main">(</span>take <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="var">?newt</span><span class="main">)</span> <span class="main">(</span>S <span class="var">?newt</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>  
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹take <span class="free">i</span> <span class="skolem">t</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span> <span class="main">@</span> drop <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">t</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span>›</span></span> <span class="quoted"><span class="quoted">‹trace <span class="free">init</span> <span class="main">(</span>take <span class="free">i</span> <span class="skolem">t</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span> <span class="main">@</span> drop <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span> <span class="free">final</span>›</span></span> exists_trace_for_any_i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"S <span class="var">?newt</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> trace_and_start_determines_end <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>S <span class="skolem">t</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.prems"</span><span class="main">(</span>6<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> <span class="skolem">k</span>›</span></span> exists_trace_for_any_i_j <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="main">(</span>S <span class="var">?newt</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="var">?newt</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>S <span class="var">?newt</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> <span class="skolem">k</span>›</span></span> <span class="quoted"><span class="quoted">‹take <span class="free">i</span> <span class="skolem">t</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span> <span class="main">@</span> drop <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">t</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span>›</span></span> <span class="quoted"><span class="quoted">‹trace <span class="free">init</span> <span class="main">(</span>take <span class="free">i</span> <span class="skolem">t</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span> <span class="main">@</span> drop <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span> <span class="free">final</span>›</span></span> exists_trace_for_any_i_j <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"S <span class="skolem">t</span> <span class="skolem">k</span> <span class="main">=</span> S <span class="var">?newt</span> <span class="skolem">k</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹S <span class="main">(</span><span class="skolem">t</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>›</span></span> same_traces trace_and_start_determines_end <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">⟶</span> S <span class="skolem">t</span> <span class="bound">k</span> <span class="main">=</span> S <span class="main">(</span><span class="main">(</span><span class="skolem">t</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span><span class="main">[</span><span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span><span class="main">)</span> <span class="bound">k</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?newt</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">t</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span><span class="main">[</span><span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="main">(</span>take <span class="skolem">k</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>S <span class="skolem">t</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.prems"</span><span class="main">(</span>6<span class="main">)</span> exists_trace_for_any_i <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="main">(</span>take <span class="skolem">k</span> <span class="var">?newt</span><span class="main">)</span> <span class="main">(</span>S <span class="var">?newt</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹take <span class="free">i</span> <span class="skolem">t</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span> <span class="main">@</span> drop <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">t</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span>›</span></span> <span class="quoted"><span class="quoted">‹trace <span class="free">init</span> <span class="main">(</span>take <span class="free">i</span> <span class="skolem">t</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span> <span class="main">@</span> drop <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span> <span class="free">final</span>›</span></span> exists_trace_for_any_i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="skolem">k</span> <span class="skolem">t</span> <span class="main">=</span> take <span class="skolem">k</span> <span class="var">?newt</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.prems"</span><span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">≤</span> <span class="free">i</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"S <span class="skolem">t</span> <span class="skolem">k</span> <span class="main">=</span> S <span class="var">?newt</span> <span class="skolem">k</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trace_and_start_determines_end<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prerecording_event <span class="main">(</span>swap_events <span class="free">i</span> <span class="skolem">j</span> <span class="skolem">t</span><span class="main">)</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="main">(</span><span class="main">(</span><span class="skolem">t</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span><span class="main">[</span><span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span><span class="main">)</span> <span class="free">i</span><span class="main">)</span> <span class="var">?q</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"0.prems"</span><span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">=</span> <span class="free">i</span> <span class="main">+</span> <span class="main">1</span>›</span></span> add.right_neutral calculation<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> le_add1 nsq snapshot_stable_ver_3<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"regular_event <span class="main">(</span><span class="main">(</span><span class="skolem">t</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span><span class="main">[</span><span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"0.prems"</span><span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> <span class="quoted">"0.prems"</span><span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹occurs_on <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">≠</span> occurs_on <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>›</span></span> nth_list_update_eq nth_list_update_neq postrecording_event prerecording_event<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="main">(</span><span class="skolem">t</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span><span class="main">[</span><span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.prems"</span><span class="main">(</span>1<span class="main">)</span> <span class="quoted">"0.prems"</span><span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> prerecording_event 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> <span class="quoted">"0.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹take <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>›</span></span> <span class="quoted"><span class="quoted">‹take <span class="free">i</span> <span class="skolem">t</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span> <span class="main">@</span> drop <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">t</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span>›</span></span> append_Cons length_list_update nat_less_le nth_list_update_eq nth_list_update_neq self_append_conv2<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"postrecording_event <span class="main">(</span>swap_events <span class="free">i</span> <span class="skolem">j</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="main">(</span><span class="main">(</span><span class="skolem">t</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span><span class="main">[</span><span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="var">?p</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"0.prems"</span><span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> add.right_neutral calculation<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> calculation<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> calculation<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> le_add1 postrecording_event snapshot_stable_ver_3<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"regular_event <span class="main">(</span><span class="main">(</span><span class="skolem">t</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span><span class="main">[</span><span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.prems"</span><span class="main">(</span>2<span class="main">)</span> <span class="quoted">"0.prems"</span><span class="main">(</span>4<span class="main">)</span> length_list_update postrecording_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> postrecording_event 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">=</span> <span class="free">i</span> <span class="main">+</span> <span class="main">1</span>›</span></span> length_list_update nth_list_update_eq swap_neighbors_2<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&gt;</span> <span class="free">i</span><span class="main">+</span><span class="main">1</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="skolem">j</span><span class="main">+</span><span class="main">1</span> <span class="main">⟶</span> <span class="main">~</span> regular_event <span class="main">(</span><span class="main">(</span>swap_events <span class="free">i</span> <span class="skolem">j</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">=</span> <span class="free">i</span> <span class="main">+</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"occurs_on <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"occurs_on <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span><span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>drop <span class="free">i</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?subt</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?subt'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span><span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> sp<span class="main">:</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="skolem">t</span> <span class="free">i</span><span class="main">)</span> <span class="var">?p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc.prems postrecording_event prerecording_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> nsq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="skolem">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="var">?q</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc.prems postrecording_event prerecording_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">≠</span> <span class="var">?q</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc.prems computation.post_before_pre_different_processes computation_axioms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?subt</span> <span class="main">≠</span> Nil"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Suc.hyps<span class="main">(</span>2<span class="main">)</span> Suc.prems<span class="main">(</span>1<span class="main">)</span> Suc.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?subt'</span> <span class="main">=</span> butlast <span class="var">?subt</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Suc_eq_plus1 butlast_drop butlast_take drop_take less_imp_le_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="main">=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span> <span class="main">#</span> <span class="var">?subt</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">j</span> <span class="main">-</span> <span class="free">i</span> <span class="main">=</span> Suc <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="free">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>1<span class="main">)</span> Suc_diff_le le_simps<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
    <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span> <span class="main">#</span> drop <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">=</span> drop <span class="free">i</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Cons_nth_drop_Suc Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> less_trans<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> f3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">#</span> drop <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">=</span> drop <span class="skolem">j</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons_nth_drop_Suc Suc.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> f4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">-</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">-</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> Suc <span class="main">0</span> <span class="main">=</span> <span class="skolem">j</span> <span class="main">-</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>1<span class="main">)</span> Suc_diff_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> f4 f3 f2 f1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Suc_eq_plus1 drop_drop take_Suc_Cons take_add take_eq_Nil<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="main">(</span>S <span class="skolem">t</span> <span class="free">i</span><span class="main">)</span> <span class="var">?t</span> <span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> Suc_eq_plus1 exists_trace_for_any_i_j less_SucI nat_less_le<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> reg_tr_1<span class="main">:</span>  <span class="quoted"><span class="quoted">"trace <span class="main">(</span>S <span class="skolem">t</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span> <span class="main">#</span> <span class="var">?subt</span><span class="main">)</span> <span class="main">(</span>S <span class="skolem">t</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> Suc.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> Suc_eq_plus1 discrete exists_trace_for_any_i_j postrecording_event step_Suc tr_step<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> reg_st_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="skolem">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>2<span class="main">)</span> Suc.prems<span class="main">(</span>6<span class="main">)</span> step_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?subt</span> <span class="main">=</span> <span class="var">?subt'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span> <span class="bound">es</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="bound">es</span> <span class="main">∨</span> take <span class="bound">n</span> <span class="bound">es</span> <span class="main">@</span> <span class="main">[</span>hd <span class="main">(</span>drop <span class="bound">n</span> <span class="bound">es</span><span class="main">)</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> event<span class="main">]</span> <span class="main">=</span> take <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span> <span class="bound">es</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> take_hd_drop<span class="main">)</span> <span class="comment1">(* 0.0 ms *)</span>
    <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Suc.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Suc_eq_plus1 diff_Suc_1 diff_diff_left plus_1_eq_Suc<span class="main">)</span> <span class="comment1">(* 28 ms *)</span>
    <span class="keyword1"><span class="command">have</span></span> f3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span> <span class="bound">na</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="bound">na</span> <span class="main">∨</span> Suc <span class="bound">n</span> <span class="main">≤</span> <span class="bound">na</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc_leI <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> <span class="comment1">(* 0.0 ms *)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f4<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="free">i</span> <span class="main">≤</span> <span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Suc.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Suc_eq_plus1 diff_diff_left plus_1_eq_Suc zero_less_Suc zero_less_diff<span class="main">)</span> <span class="comment1">(* 12 ms *)</span>
    <span class="keyword1"><span class="command">have</span></span> f5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> zero_less_Suc zero_less_diff<span class="main">)</span> <span class="comment1">(* 4 ms *)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f6<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> hd <span class="main">(</span>drop <span class="skolem">n</span> <span class="main">(</span>drop <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> f4 f3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Suc.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Suc_eq_plus1 Suc_lessD add_Suc_right diff_Suc_1 drop_drop hd_drop_conv_nth le_add_diff_inverse2 plus_1_eq_Suc<span class="main">)</span> <span class="comment1">(* 140 ms *)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="main">(</span>drop <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> f5 f3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Suc.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Suc_eq_plus1 Suc_lessD drop_drop le_add_diff_inverse2 length_drop zero_less_diff<span class="main">)</span> <span class="comment1">(* 144 ms *)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> f6 f2 f1 Suc.hyps<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span> <span class="comment1">(* 4 ms *)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> reg_tr<span class="main">:</span> <span class="quoted"><span class="quoted">"trace <span class="main">(</span>S <span class="skolem">t</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span> <span class="main">#</span> <span class="var">?subt'</span><span class="main">)</span> <span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">-</span> Suc <span class="free">i</span> <span class="main">=</span> Suc <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc.hyps<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
    <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>take <span class="skolem">j</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> length_take min.absorb2 nat_le_linear not_less<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> f3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span> <span class="main">#</span> drop <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="main">(</span>take <span class="skolem">j</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span> <span class="main">=</span> drop <span class="free">i</span> <span class="main">(</span>take <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Suc_eq_plus1 <span class="quoted"><span class="quoted">‹take <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>drop <span class="free">i</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span> <span class="main">#</span> take <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span>›</span></span> append_Cons drop_take<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> f4<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> f1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Suc_diff_Suc add_Suc_right diff_Suc_1 le_add_diff_inverse nat_le_linear not_less<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> f1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f5<span class="main">:</span> <span class="quoted"><span class="quoted">"butlast <span class="main">(</span>take <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> take <span class="skolem">j</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> f4 f3 f2 f1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Groups.add_ac<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> One_nat_def append_eq_conv_conj append_take_drop_id butlast_take diff_Suc_1 drop_drop length_append length_drop list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list.size<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> order_refl plus_1_eq_Suc plus_nat.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> take_add take_all<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> f6<span class="main">:</span> <span class="quoted"><span class="quoted">"butlast <span class="main">(</span>take <span class="skolem">j</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> take <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Suc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> butlast_take nat_le_linear not_less<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="main">(</span>take <span class="skolem">j</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Nil_is_append_conv Suc_eq_plus1 <span class="quoted"><span class="quoted">‹take <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> take <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span>›</span></span> drop_take list.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> f6 f5 f4 f3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> Suc_eq_plus1 butlast.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> butlast_drop butlast_snoc drop_take exists_trace_for_any_i_j less_add_Suc1 nat_le_linear not_less<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> reg_st_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span>S <span class="skolem">t</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> Suc_lessD diff_Suc_1 less_imp_Suc_add step_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> regular_event <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹take <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> less_diff_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"regular_event <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>5<span class="main">)</span> computation.prerecording_event computation_axioms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"can_occur <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span>S <span class="skolem">t</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> happen_implies_can_occur reg_tr_1 reg_st_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> njmiq<span class="main">:</span> <span class="quoted"><span class="quoted">"occurs_on <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="var">?q</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> occurs_on <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="var">?q</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"occurs_on <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="var">?q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="skolem">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="var">?q</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>6<span class="main">)</span> calculation<span class="main">(</span>1<span class="main">)</span> diff_le_self nonregular_event_induces_snapshot reg_st_1 snapshot_stable_ver_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> nsq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"can_occur <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reg_tr reg_st_1 event_can_go_back_if_no_sender <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> new_st_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">↦</span> <span class="skolem">d</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> exists_next_if_can_occur <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="main">(</span>S <span class="skolem">t</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span> <span class="main">#</span> <span class="var">?subt'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span> <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reg_tr trace_snoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"can_occur <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">d</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">⊢</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">↦</span> <span class="skolem">d</span>›</span></span> <span class="quoted"><span class="quoted">‹occurs_on <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> occurs_on <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>›</span></span> event_stays_valid_if_no_occurrence happen_implies_can_occur reg_st_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> new_st_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">↦</span> <span class="skolem">e</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> calculation<span class="main">(</span>2<span class="main">)</span> exists_next_if_can_occur <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> pre_swap<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> <span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"states <span class="skolem">e</span> <span class="main">=</span> states <span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"states <span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> states <span class="main">(</span>S <span class="skolem">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> no_state_change_if_nonregular_event<span class="quoted"><span class="quoted">‹<span class="main">~</span> regular_event <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>›</span></span> reg_st_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"states <span class="skolem">d</span> <span class="skolem">p</span> <span class="main">=</span> states <span class="skolem">e</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> no_state_change_if_nonregular_event<span class="quoted"><span class="quoted">‹<span class="main">~</span> regular_event <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>›</span></span> new_st_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"states <span class="skolem">d</span> <span class="skolem">p</span> <span class="main">=</span> states <span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">.</span> states <span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="bound">a</span> <span class="main">=</span> states <span class="skolem">d</span> <span class="bound">a</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> regular_event <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>›</span></span> new_st_1 no_state_change_if_nonregular_event reg_st_1 reg_st_2 same_state_implies_same_result_state<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"states <span class="skolem">e</span> <span class="skolem">p</span> <span class="main">=</span> states <span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="skolem">e</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">cid</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"isTrans <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∨</span> isSend <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∨</span> isRecv <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹regular_event <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"isSnapshot <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> isRecvMarker <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> nonregular_event <span class="quoted"><span class="quoted">‹<span class="main">~</span> regular_event <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"msgs <span class="skolem">e</span> <span class="skolem">cid</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
          <span class="keyword1"><span class="command">using</span></span> new_st_1 new_st_2 njmiq reg_st_1 reg_st_2 swap_Trans_Snapshot <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
          <span class="keyword1"><span class="command">using</span></span> new_st_1 new_st_2 njmiq reg_st_1 reg_st_2 swap_msgs_Trans_RecvMarker <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 3
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
          <span class="keyword1"><span class="command">using</span></span> new_st_1 new_st_2 njmiq reg_st_1 reg_st_2 swap_Send_Snapshot <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 4
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
          <span class="keyword1"><span class="command">using</span></span> new_st_1 new_st_2 njmiq reg_st_1 reg_st_2 swap_Recv_Snapshot <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 5
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
          <span class="keyword1"><span class="command">using</span></span> new_st_1 new_st_2 njmiq reg_st_1 reg_st_2 swap_msgs_Send_RecvMarker <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 6
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
          <span class="keyword1"><span class="command">using</span></span> new_st_1 new_st_2 njmiq reg_st_1 reg_st_2 swap_msgs_Recv_RecvMarker <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"process_snapshot <span class="skolem">e</span> <span class="main">=</span> process_snapshot <span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"process_snapshot <span class="main">(</span>S <span class="skolem">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> process_snapshot <span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹regular_event <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>›</span></span> reg_st_2 regular_event_preserves_process_snapshots <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"process_snapshot <span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> process_snapshot <span class="skolem">d</span> <span class="skolem">p</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹regular_event <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>›</span></span> new_st_1 regular_event_preserves_process_snapshots <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"process_snapshot <span class="skolem">e</span> <span class="skolem">p</span> <span class="main">=</span> process_snapshot <span class="main">(</span>S <span class="skolem">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"occurs_on <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">⟶</span> ps <span class="skolem">e</span> <span class="skolem">p</span> <span class="main">=</span> ps <span class="main">(</span>S <span class="skolem">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">p</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> calculation<span class="main">(</span>2<span class="main">)</span> new_st_2 njmiq no_state_change_if_no_event reg_st_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> new_st_1 new_st_2 no_state_change_if_no_event reg_st_1 same_snapshot_state_implies_same_result_snapshot_state<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"process_snapshot <span class="skolem">e</span> <span class="skolem">p</span> <span class="main">=</span> process_snapshot <span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="skolem">e</span> <span class="main">=</span> cs <span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">cid</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"isTrans <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∨</span> isSend <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∨</span> isRecv <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹regular_event <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"isSnapshot <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> isRecvMarker <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> nonregular_event <span class="quoted"><span class="quoted">‹<span class="main">~</span> regular_event <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cs <span class="skolem">e</span> <span class="skolem">cid</span> <span class="main">=</span> cs <span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
          <span class="keyword1"><span class="command">using</span></span> new_st_1 new_st_2 reg_st_1 reg_st_2 swap_cs_Trans_Snapshot <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> new_st_1 new_st_2 reg_st_1 reg_st_2 swap_cs_Trans_RecvMarker <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 3
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> new_st_1 new_st_2 reg_st_1 reg_st_2 swap_cs_Send_Snapshot <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 4
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> new_st_1 new_st_2 reg_st_1 reg_st_2 swap_cs_Recv_Snapshot njmiq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 5
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> new_st_1 new_st_2 reg_st_1 reg_st_2 swap_cs_Send_RecvMarker <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 6
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> new_st_1 new_st_2 reg_st_1 reg_st_2 swap_cs_Recv_RecvMarker njmiq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?it</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">[</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span><span class="main">[</span><span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> same_prefix<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="var">?it</span> <span class="main">=</span> take <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> same_suffix<span class="main">:</span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="var">?it</span> <span class="main">=</span> drop <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> trace_prefix<span class="main">:</span> <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="main">(</span>take <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="var">?it</span><span class="main">)</span> <span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>6<span class="main">)</span> exists_trace_for_any_i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?it</span> <span class="main">=</span> take <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> drop <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">t</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Suc.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Suc_eq_plus1 add_lessD1 plus_1_eq_Suc zero_less_Suc zero_less_diff<span class="main">)</span> <span class="comment1">(* 12 ms *)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> le_add_diff_inverse2 nat_less_le<span class="main">)</span> <span class="comment1">(* 4 ms *)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Suc_eq_plus1 add_Suc_right one_add_one swap_neighbors<span class="main">)</span> <span class="comment1">(* 76 ms *)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> new_st_1 new_st_2 pre_swap trace.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="main">(</span>take <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">@</span> drop <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span> <span class="free">final</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc.prems<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="main">(</span>take <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> trace <span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span> <span class="free">final</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>6<span class="main">)</span> exists_trace_for_any_i split_trace trace_and_start_determines_end <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> trace_suffix<span class="main">:</span> <span class="quoted"><span class="quoted">"trace <span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="var">?it</span><span class="main">)</span> <span class="free">final</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> same_suffix <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="var">?it</span> <span class="free">final</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span><span class="main">[</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> take <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> drop <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">t</span>›</span></span> <span class="quoted"><span class="quoted">‹trace <span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span><span class="main">[</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="free">final</span>›</span></span> <span class="quoted"><span class="quoted">‹trace <span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹trace <span class="free">init</span> <span class="main">(</span>take <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span><span class="main">[</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>›</span></span> same_prefix same_suffix trace_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> suffix_same_states<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&gt;</span> <span class="skolem">j</span> <span class="main">⟶</span> S <span class="skolem">t</span> <span class="bound">k</span> <span class="main">=</span> S <span class="var">?it</span> <span class="bound">k</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&gt;</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> eq_trace<span class="main">:</span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">=</span> drop <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="var">?it</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="main">(</span>take <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="var">?it</span><span class="main">)</span> <span class="main">(</span>S <span class="var">?it</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹trace <span class="free">init</span> <span class="main">(</span><span class="skolem">t</span><span class="main">[</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">final</span>›</span></span> exists_trace_for_any_i <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="main">(</span>take <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="var">?it</span><span class="main">)</span> <span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">es</span> <span class="bound">esa</span> <span class="bound">esb</span> <span class="bound">esc</span><span class="main">.</span> <span class="main">(</span><span class="bound">esb</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> event list<span class="main">)</span> <span class="main">@</span> <span class="bound">es</span> <span class="main">≠</span> <span class="bound">esa</span> <span class="main">@</span> <span class="bound">esc</span> <span class="main">@</span> <span class="bound">es</span> <span class="main">∨</span> <span class="bound">esa</span> <span class="main">@</span> <span class="bound">esc</span> <span class="main">=</span> <span class="bound">esb</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span><span class="main">[</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> drop <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">t</span> <span class="main">[</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_take_drop_id same_suffix<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="main">(</span>take <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹trace <span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>›</span></span> same_prefix trace_prefix trace_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> f2 f1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span><span class="main">[</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> take <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> drop <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">t</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> eq_start<span class="main">:</span> <span class="quoted"><span class="quoted">"S <span class="var">?it</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> trace_and_start_determines_end <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="skolem">k</span> <span class="var">?it</span> <span class="main">=</span> take <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="var">?it</span> <span class="main">@</span> take <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="var">?it</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 Suc_leI <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span> le_add_diff_inverse take_add<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="main">(</span>S <span class="var">?it</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="var">?it</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>S <span class="var">?it</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 Suc_leI <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span> <span class="quoted"><span class="quoted">‹trace <span class="free">init</span> <span class="main">(</span><span class="skolem">t</span><span class="main">[</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">final</span>›</span></span> exists_trace_for_any_i_j<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="main">(</span>S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>S <span class="skolem">t</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>6<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span> exists_trace_for_any_i_j <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"S <span class="skolem">t</span> <span class="skolem">k</span> <span class="main">=</span> S <span class="var">?it</span> <span class="skolem">k</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> eq_start trace_and_start_determines_end <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> prefix_same_states<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="skolem">j</span> <span class="main">⟶</span> S <span class="skolem">t</span> <span class="bound">k</span> <span class="main">=</span> S <span class="var">?it</span> <span class="bound">k</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="main">(</span>take <span class="skolem">k</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>S <span class="skolem">t</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>6<span class="main">)</span> exists_trace_for_any_i <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="main">(</span>take <span class="skolem">k</span> <span class="var">?it</span><span class="main">)</span> <span class="main">(</span>S <span class="var">?it</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted"><span class="quoted">‹trace <span class="free">init</span> <span class="main">(</span><span class="skolem">t</span><span class="main">[</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">final</span>›</span></span> exists_trace_for_any_i<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"S <span class="skolem">t</span> <span class="skolem">k</span> <span class="main">=</span> S <span class="var">?it</span> <span class="skolem">k</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> s_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="var">?it</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prerecording_event <span class="var">?it</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span><span class="main">[</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t</span><span class="main">[</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">]</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> njmiq nth_list_update_neq<span class="main">)</span> <span class="comment1">(* 28 ms *)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> not_less_zero<span class="main">)</span> <span class="comment1">(* 0.0 ms *)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">j</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> <span class="comment1">(* 0.0 ms *)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"S <span class="skolem">t</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> S <span class="main">(</span><span class="skolem">t</span><span class="main">[</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prefix_same_states<span class="main">)</span> <span class="comment1">(* 8 ms *)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> f1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹regular_event <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>›</span></span> calculation<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> computation.prerecording_event computation_axioms length_list_update njmiq no_state_change_if_no_event nsq nth_list_update_eq reg_st_1<span class="main">)</span> <span class="comment1">(* 456 ms *)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"postrecording_event <span class="var">?it</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="var">?it</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>4<span class="main">)</span> postrecording_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">t</span><span class="main">[</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Suc.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> cancel_ab_semigroup_add_class.diff_right_commute diff_diff_left zero_less_Suc zero_less_diff<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>1<span class="main">)</span> Suc.prems<span class="main">(</span>4<span class="main">)</span> postrecording_event prefix_same_states <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc.hyps<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">~</span> regular_event <span class="main">(</span><span class="var">?it</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="skolem">k</span> <span class="main">∧</span> <span class="skolem">k</span> <span class="main">&lt;</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> regular_event <span class="main">(</span><span class="var">?it</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> <span class="skolem">k</span> <span class="main">∧</span> <span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc.prems Suc.hyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> ind<span class="main">:</span> <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="main">(</span>swap_events <span class="free">i</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="var">?it</span><span class="main">)</span> <span class="free">final</span>
                        <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≥</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">+</span><span class="main">1</span> <span class="main">⟶</span> S <span class="main">(</span>swap_events <span class="free">i</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="var">?it</span><span class="main">)</span> <span class="bound">k</span> <span class="main">=</span> S <span class="var">?it</span> <span class="bound">k</span><span class="main">)</span>
                        <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">⟶</span> S <span class="main">(</span>swap_events <span class="free">i</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="var">?it</span><span class="main">)</span> <span class="bound">k</span> <span class="main">=</span> S <span class="var">?it</span> <span class="bound">k</span><span class="main">)</span>
                        <span class="main">∧</span> prerecording_event <span class="main">(</span>swap_events <span class="free">i</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="var">?it</span><span class="main">)</span> <span class="free">i</span>
                        <span class="main">∧</span> postrecording_event <span class="main">(</span>swap_events <span class="free">i</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="var">?it</span><span class="main">)</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>
                        <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&gt;</span> <span class="free">i</span><span class="main">+</span><span class="main">1</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">+</span><span class="main">1</span> <span class="main">⟶</span> <span class="main">~</span> regular_event <span class="main">(</span><span class="main">(</span>swap_events <span class="free">i</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="var">?it</span><span class="main">)</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc.hyps <span class="quoted"><span class="quoted">‹trace <span class="free">init</span> <span class="var">?it</span> <span class="free">final</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> new_trace<span class="main">:</span> <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="main">(</span>swap_events <span class="free">i</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="var">?it</span><span class="main">)</span> <span class="free">final</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> equal_suffix_states<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≥</span> <span class="skolem">j</span> <span class="main">⟶</span> S <span class="main">(</span>swap_events <span class="free">i</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="var">?it</span><span class="main">)</span> <span class="bound">k</span> <span class="main">=</span> S <span class="var">?it</span> <span class="bound">k</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>1<span class="main">)</span> ind <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> equal_prefix_states<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">⟶</span> S <span class="main">(</span>swap_events <span class="free">i</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="var">?it</span><span class="main">)</span> <span class="bound">k</span> <span class="main">=</span> S <span class="var">?it</span> <span class="bound">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ind <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> neighboring_events_shifted<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&gt;</span> <span class="free">i</span><span class="main">+</span><span class="main">1</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="skolem">j</span> <span class="main">⟶</span> <span class="main">~</span> regular_event <span class="main">(</span><span class="main">(</span>swap_events <span class="free">i</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="var">?it</span><span class="main">)</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ind <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?itn</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"swap_events <span class="free">i</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="var">?it</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?itn</span> <span class="main">=</span> swap_events <span class="free">i</span> <span class="skolem">j</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> <span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span>›</span></span> less_imp_le_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">#</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> drop <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">=</span> drop <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> drop <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span><span class="main">[</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> take <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> drop <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">t</span>›</span></span> same_prefix <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span><span class="main">[</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∧</span> drop <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span><span class="main">[</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">#</span> <span class="main">[]</span> <span class="main">@</span> drop <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Cons_nth_drop_Suc Suc_eq_plus1 <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">t</span><span class="main">[</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span><span class="main">[</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> take <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> drop <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">t</span>›</span></span> append_Cons list.inject<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="skolem">t</span><span class="main">[</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> <span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span>›</span></span> nat_neq_iff nth_list_update_neq<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> f2 f1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹take <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> take <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span>›</span></span> append.assoc append_Cons drop_take less_imp_le_nat same_prefix take_update_cancel<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">⟶</span> S <span class="skolem">t</span> <span class="bound">k</span> <span class="main">=</span> S <span class="var">?itn</span> <span class="bound">k</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>1<span class="main">)</span> equal_prefix_states prefix_same_states <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≥</span> <span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span> <span class="main">⟶</span> S <span class="skolem">t</span> <span class="bound">k</span> <span class="main">=</span> S <span class="var">?itn</span> <span class="bound">k</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Suc_eq_plus1 add_lessD1 equal_suffix_states lessI nat_less_le suffix_same_states<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&gt;</span> <span class="free">i</span><span class="main">+</span><span class="main">1</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="skolem">j</span><span class="main">+</span><span class="main">1</span> <span class="main">⟶</span> <span class="main">~</span> regular_event <span class="main">(</span><span class="var">?itn</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> regular_event <span class="main">(</span><span class="var">?itn</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">t</span><span class="main">[</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">j</span> <span class="main">:=</span> <span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span> <span class="bound">na</span> <span class="bound">es</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="bound">na</span> <span class="main">∨</span> <span class="main">¬</span> <span class="bound">na</span> <span class="main">&lt;</span> length <span class="bound">es</span> <span class="main">∨</span> drop <span class="main">(</span>Suc <span class="bound">na</span><span class="main">)</span> <span class="main">(</span>take <span class="bound">n</span> <span class="bound">es</span> <span class="main">@</span> <span class="main">[</span>hd <span class="main">(</span>drop <span class="bound">na</span> <span class="bound">es</span><span class="main">)</span><span class="main">,</span> <span class="bound">es</span> <span class="main">!</span> <span class="bound">n</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> event<span class="main">]</span> <span class="main">@</span> take <span class="main">(</span><span class="bound">na</span> <span class="main">-</span> Suc <span class="bound">n</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span> <span class="bound">es</span><span class="main">)</span> <span class="main">@</span> drop <span class="main">(</span>Suc <span class="bound">na</span><span class="main">)</span> <span class="bound">es</span><span class="main">)</span> <span class="main">=</span> drop <span class="main">(</span>Suc <span class="bound">na</span><span class="main">)</span> <span class="bound">es</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 hd_drop_conv_nth swap_identical_tails<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> f3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> hd <span class="main">(</span>drop <span class="skolem">j</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> hd_drop_conv_nth<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">j</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> regular_event <span class="main">(</span>hd <span class="main">(</span>drop <span class="skolem">j</span> <span class="main">(</span>take <span class="free">i</span> <span class="main">(</span><span class="skolem">t</span><span class="main">[</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> hd <span class="main">(</span>drop <span class="skolem">j</span> <span class="skolem">t</span><span class="main">)</span><span class="main">,</span> <span class="skolem">j</span> <span class="main">:=</span> hd <span class="main">(</span>drop <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>hd <span class="main">(</span>drop <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span><span class="main">[</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> hd <span class="main">(</span>drop <span class="skolem">j</span> <span class="skolem">t</span><span class="main">)</span><span class="main">,</span> <span class="skolem">j</span> <span class="main">:=</span> hd <span class="main">(</span>drop <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="skolem">t</span><span class="main">[</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> hd <span class="main">(</span>drop <span class="skolem">j</span> <span class="skolem">t</span><span class="main">)</span><span class="main">,</span> <span class="skolem">j</span> <span class="main">:=</span> hd <span class="main">(</span>drop <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span><span class="main">]</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span> <span class="main">@</span> take <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">-</span> Suc <span class="free">i</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span><span class="main">[</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> hd <span class="main">(</span>drop <span class="skolem">j</span> <span class="skolem">t</span><span class="main">)</span><span class="main">,</span> <span class="skolem">j</span> <span class="main">:=</span> hd <span class="main">(</span>drop <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> drop <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span><span class="main">[</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">:=</span> hd <span class="main">(</span>drop <span class="skolem">j</span> <span class="skolem">t</span><span class="main">)</span><span class="main">,</span> <span class="skolem">j</span> <span class="main">:=</span> hd <span class="main">(</span>drop <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> f2 f1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> regular_event <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> <span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span>›</span></span> add_diff_inverse_nat hd_drop_conv_nth length_list_update nth_list_update_eq plus_1_eq_Suc<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> f3 f1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Suc_eq_plus1 <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> <span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span>›</span></span> hd_drop_conv_nth length_list_update swap_identical_length<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 less_Suc_eq neighboring_events_shifted<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> ind <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Relating configurations and the computed snapshot›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ps_equal_to_snapshot</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ps_equal_to_snapshot</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="main">≡</span>
     <span class="main">∀</span><span class="bound">p</span><span class="main">.</span> Some <span class="main">(</span>states <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> process_snapshot <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="bound">p</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cs_equal_to_snapshot</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cs_equal_to_snapshot</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="main">≡</span>
     <span class="main">∀</span><span class="bound">cid</span><span class="main">.</span> <span class="free">channel</span> <span class="bound">cid</span> <span class="main">≠</span> None
       <span class="main">⟶</span> filter <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">cid</span><span class="main">)</span>
           <span class="main">=</span> map Msg <span class="main">(</span>fst <span class="main">(</span>channel_snapshot <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="bound">cid</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">state_equal_to_snapshot</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">state_equal_to_snapshot</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="main">≡</span>
     ps_equal_to_snapshot <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="main">∧</span> cs_equal_to_snapshot <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> init_is_s_t_0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">=</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms exists_trace_for_any_i take_eq_Nil tr_init trace_and_start_determines_end<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> final_is_s_t_len_t<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">final</span> <span class="main">=</span> S <span class="free">t</span> <span class="main">(</span>length <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms exists_trace_for_any_i order_refl take_all trace_and_start_determines_end<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> snapshot_event<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"isSnapshot <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">∨</span> isRecvMarker <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> distributed_system.step_Suc computation_axioms computation_def nat_less_le not_less not_less_eq s_def take_all<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> nonregular_event regular_event_cannot_induce_snapshot <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> snapshot_state<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"states <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> <span class="free">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"ps <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> Some <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> le_SucI le_eq_less_or_eq le_refl nat_neq_iff no_change_if_ge_length_t plus_1_eq_Suc step_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> qp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?q</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?q</span> <span class="main">≠</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">p</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> local.step no_state_change_if_no_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"isSnapshot <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">∨</span> isRecvMarker <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms snapshot_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> Snapshot <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> event.collapse<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> qp<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> local.step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cid'</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> RecvMarker <span class="skolem">cid'</span> <span class="free">p</span> <span class="skolem">q</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> event.collapse<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> qp<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> snapshot_state_unchanged_trace_2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span><span class="main">;</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">j</span><span class="main">;</span> <span class="free">j</span> <span class="main">≤</span> length <span class="free">t</span><span class="main">;</span>
       ps <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> Some <span class="free">u</span>
     <span class="main">⟧</span> <span class="main">⟹</span> ps <span class="main">(</span>S <span class="free">t</span> <span class="free">j</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> Some <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>S_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> S_init
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> S_step
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> snapshot_state_unchanged <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> no_recording_cs_if_not_snapshotted<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span><span class="main">;</span> <span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">p</span><span class="main">;</span>
       <span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">q</span><span class="main">,</span> <span class="free">p</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> cs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> cs <span class="free">init</span> <span class="free">cid</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> exists_trace_for_any_i list.discI take_eq_Nil trace.simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="free">final</span> <span class="free">p</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> all_processes_snapshotted_in_final_state valid <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> Suc <span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">≥</span> length <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹ps <span class="free">final</span> <span class="free">p</span> <span class="main">≠</span> None›</span></span> final_is_s_t_len_t snapshot_stable_ver_3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> t_dec<span class="main">:</span> <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="main">(</span>take <span class="skolem">i</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>1<span class="main">)</span> exists_trace_for_any_i step_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> calculation <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"cs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> cs <span class="free">init</span> <span class="free">cid</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Suc.hyps Suc.prems<span class="main">(</span>1<span class="main">)</span> Suc.prems<span class="main">(</span>2<span class="main">)</span> Suc.prems<span class="main">(</span>3<span class="main">)</span> snapshot_state_unchanged <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Snapshot <span class="skolem">r</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≠</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="skolem">r</span> <span class="main">≠</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> Snapshot step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Snapshot Suc.prems<span class="main">(</span>3<span class="main">)</span> local.step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>RecvMarker <span class="skolem">cid'</span> <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≠</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="skolem">r</span> <span class="main">≠</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> RecvMarker t_dec recv_marker_means_snapshotted_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cid'</span> <span class="main">≠</span> <span class="free">cid</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="skolem">cid'</span> <span class="main">≠</span> <span class="free">cid</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="skolem">cid'</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> t_dec can_occur_def RecvMarker <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> 
        <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">cid'</span> <span class="main">≠</span> <span class="free">cid</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">≠</span> <span class="free">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">s</span><span class="main">.</span> <span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">≠</span> <span class="free">p</span>›</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> RecvMarker t_dec <span class="quoted"><span class="quoted">‹<span class="skolem">cid'</span> <span class="main">≠</span> <span class="free">cid</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">≠</span> <span class="free">p</span>›</span></span> Suc.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">r</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Trans <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">u'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> IH t_dec <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Send <span class="skolem">cid'</span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> IH local.step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Recv <span class="skolem">cid'</span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> NotStarted"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> IH no_initial_channel_snapshot<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Recv step Suc <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">cid'</span> <span class="main">=</span> <span class="free">cid</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cs_done_implies_has_snapshotted<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> Done"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms no_initial_channel_snapshot no_recording_cs_if_not_snapshotted <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> exactly_one_snapshot<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">i</span><span class="main">.</span> <span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="bound">i</span><span class="main">)</span> <span class="free">p</span> <span class="main">∧</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="bound">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="free">init</span> <span class="free">p</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> no_initial_process_snapshot <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="free">final</span> <span class="free">p</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> all_processes_snapshotted_in_final_state valid <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="main">(</span>S <span class="free">t</span> <span class="main">0</span><span class="main">)</span> <span class="free">t</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>length <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms final_is_s_t_len_t init_is_s_t_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> ex_snap<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="bound">i</span><span class="main">)</span> <span class="free">p</span> <span class="main">∧</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="bound">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms exists_snapshot_for_all_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="var">?P</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="bound">i</span> <span class="main">≠</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∧</span> <span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="bound">i</span><span class="main">)</span> <span class="free">p</span> <span class="main">∧</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="bound">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">∧</span>
                                <span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="bound">j</span><span class="main">)</span> <span class="free">p</span> <span class="main">∧</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="bound">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ex_snap <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∧</span> <span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="bound">i</span><span class="main">)</span> <span class="free">p</span> <span class="main">∧</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="bound">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">∧</span>
                                <span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="bound">j</span><span class="main">)</span> <span class="free">p</span> <span class="main">∧</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="bound">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> linorder_neqE_nat<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span>"</span></span>
                                  <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> assms exists_trace_for_any_i_j <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="free">p</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹ps <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">≠</span> None›</span></span> snapshot_stable <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="free">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> initial_cs_changes_implies_nonregular_event<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> NotStarted"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">≠</span> NotStarted"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">~</span> regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"S <span class="free">t</span> <span class="free">i</span> <span class="main">=</span> S <span class="free">t</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> no_change_if_ge_length_t <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> step_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="main">~</span> regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"isRecv <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>›</span></span> local.step no_cs_change_if_no_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cid'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> Recv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> Recv <span class="skolem">cid'</span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> isRecv_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> assms step <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">cid</span> <span class="main">=</span> <span class="skolem">cid'</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms step Recv <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms step Recv <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cs_in_initial_state_implies_not_snapshotted<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> NotStarted"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">q</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> exists_snapshot_for_all_p computation.snapshot_stable_ver_3 computation_axioms nat_le_linear order_le_less<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> step_j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">¬</span> ps <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">q</span> <span class="main">≠</span> None›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> ps <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="free">q</span> <span class="main">≠</span> None›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">i</span>›</span></span> add.commute assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> linorder_neqE_nat no_change_if_ge_length_t order_le_less order_refl plus_1_eq_Suc step_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> tr_j_i<span class="main">:</span> <span class="quoted"><span class="quoted">"trace <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">i</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> exists_trace_for_any_i_j <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> step_j <span class="quoted"><span class="quoted">‹<span class="main">¬</span> ps <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="free">q</span> <span class="main">≠</span> None›</span></span> <span class="quoted"><span class="quoted">‹ps <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">q</span> <span class="main">≠</span> None›</span></span> regular_event_cannot_induce_snapshot <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"isSnapshot <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∨</span> isRecvMarker <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> nonregular_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">≠</span> NotStarted"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">q</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> ps <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="free">q</span> <span class="main">≠</span> None›</span></span> <span class="quoted"><span class="quoted">‹ps <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">q</span> <span class="main">≠</span> None›</span></span> distributed_system.no_state_change_if_no_event distributed_system_axioms step_j <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> Snapshot <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> isSnapshot_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> step_j assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">q</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> ps <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="free">q</span> <span class="main">≠</span> None›</span></span> <span class="quoted"><span class="quoted">‹ps <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">q</span> <span class="main">≠</span> None›</span></span> distributed_system.no_state_change_if_no_event distributed_system_axioms step_j <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">with</span></span> 2 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cid'</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> RecvMarker<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> RecvMarker <span class="skolem">cid'</span> <span class="free">q</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> event.collapse<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">cid'</span> <span class="main">=</span> <span class="free">cid</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> RecvMarker step_j assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="free">q</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> ps <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="free">q</span> <span class="main">≠</span> None›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> RecvMarker step_j assms False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">≠</span> NotStarted"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tr_j_i cs_not_not_started_stable_trace assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nonregular_event_in_initial_state_implies_cs_changed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> NotStarted"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">~</span> regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">≠</span> NotStarted"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> step_Suc assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"isSnapshot <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">∨</span> isRecvMarker <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> nonregular_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms cs_in_initial_state_implies_not_snapshotted local.step nonregular_event_induces_snapshot <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> cs_in_initial_state_implies_not_snapshotted local.step nonregular_event_induces_snapshot<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cs_recording_implies_snapshot<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> Recording"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span><span class="main">;</span> <span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">p</span><span class="main">;</span> <span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span> <span class="main">⟧</span>
        <span class="main">⟹</span> snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> NotStarted"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> init_is_s_t_0 no_initial_channel_snapshot <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="free">t</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Suc_eq_plus1 all_processes_snapshotted_in_final_state assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> distributed_system.step_Suc distributed_system_axioms final_is_s_t_len_t le_add1 not_less snapshot_stable_ver_3<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">n</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> NotStarted"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Suc.hyps Suc.prems<span class="main">(</span>2<span class="main">)</span> assms snapshot_state_unchanged computation_axioms local.step <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> ps <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">q</span> <span class="main">≠</span> None›</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> cs_not_not_started_stable_trace exists_trace_for_any_i no_recording_cs_if_not_snapshotted recording_state.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> ps <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">q</span> <span class="main">≠</span> None›</span></span> assms computation.no_initial_channel_snapshot computation_axioms no_recording_cs_if_not_snapshotted <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cs_done_implies_both_snapshotted<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> Done"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">p</span>"</span></span>
    <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="main">(</span>take <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> exists_trace_for_any_i <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"RecvMarker <span class="free">cid</span> <span class="free">q</span> <span class="free">p</span> <span class="main">:</span> set <span class="main">(</span>take <span class="free">i</span> <span class="free">t</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span> cs_done_implies_has_snapshotted done_only_from_recv_marker_trace computation.no_initial_process_snapshot computation_axioms init_is_s_t_0 list.discI trace.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> RecvMarker <span class="free">cid</span> <span class="free">q</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.right_neutral add_diff_cancel_right' append_Nil append_take_drop_id assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> exists_index take0<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">q</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Suc_eq_plus1 Suc_leI assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span> computation.cs_done_implies_has_snapshotted computation.no_change_if_ge_length_t computation_axioms less_le not_less_eq recv_marker_means_cs_Done<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">q</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms cs_done_implies_has_snapshotted <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> step_k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="free">t</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">i</span>›</span></span> add_lessD1 assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> distributed_system.step_Suc distributed_system_axioms less_imp_add_positive<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">:</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">k</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"can_occur <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span>S <span class="free">t</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> happen_implies_can_occur step_k <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> can_occur_def <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> RecvMarker <span class="free">cid</span> <span class="free">q</span> <span class="free">p</span>›</span></span> 
      <span class="keyword1"><span class="command">using</span></span> hd_in_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">k</span><span class="main">)</span> <span class="free">p</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>4<span class="main">)</span> no_marker_if_no_snapshot <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">p</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">i</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> less_imp_le_nat snapshot_stable_ver_3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cs_done_implies_same_snapshots<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> length <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> Done <span class="main">⟹</span> <span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span> <span class="main">⟹</span> cs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> cs <span class="main">(</span>S <span class="free">t</span> <span class="free">j</span><span class="main">)</span> <span class="free">cid</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> S_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>S_init <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>S_step <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> snap_p<span class="main">:</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">p</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> S_step.hyps<span class="main">(</span>1<span class="main">)</span> S_step.hyps<span class="main">(</span>2<span class="main">)</span> S_step.prems<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> assms<span class="main">(</span>1<span class="main">)</span> cs_done_implies_both_snapshotted<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> snap_q<span class="main">:</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">q</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> S_step.prems<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> assms<span class="main">(</span>1<span class="main">)</span> cs_done_implies_has_snapshotted <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> S_step <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Snapshot <span class="skolem">r</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Snapshot S_step.hyps<span class="main">(</span>3<span class="main">)</span> snap_p <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> can_occur_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> Snapshot S_step.hyps<span class="main">(</span>3<span class="main">)</span> snap_q <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> can_occur_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Snapshot S_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>RecvMarker <span class="skolem">cid'</span> <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">r</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> RecvMarker S_step <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">cid</span> <span class="main">=</span> <span class="skolem">cid'</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> <span class="main">(</span>fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span><span class="main">,</span> Done<span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> RecvMarker S_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> S_step.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> prod.collapse<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> no_snap<span class="main">:</span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">cid</span> <span class="main">=</span> <span class="skolem">cid'</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> <span class="main">(</span>fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span><span class="main">,</span> Done<span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> RecvMarker S_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> S_step.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> prod.collapse<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≠</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> no_snap snap_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">s</span><span class="main">.</span> <span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> S_step<span class="main">(</span>5<span class="main">)</span> assms<span class="main">(</span>1<span class="main">)</span> cs_done_implies_has_snapshotted no_snap <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> RecvMarker S_step False no_snap <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Recv <span class="skolem">cid'</span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> S_step <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">cid</span> <span class="main">=</span> <span class="skolem">cid'</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> S_step <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> snapshotted_and_not_done_implies_marker_in_channel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">≠</span> Done"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> length <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"Marker <span class="main">:</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> jj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> exists_snapshot_for_all_p computation.snapshot_stable_ver_2 computation_axioms le_eq_less_or_eq nat_neq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> ps <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="free">p</span> <span class="main">≠</span> None›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">i</span>›</span></span> add.commute assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> linorder_neqE_nat no_change_if_ge_length_t order_le_less order_refl plus_1_eq_Suc step_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">:</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> ps <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="free">p</span> <span class="main">≠</span> None›</span></span> <span class="quoted"><span class="quoted">‹ps <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">≠</span> None›</span></span> distributed_system.regular_event_cannot_induce_snapshot distributed_system_axioms local.step<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"isSnapshot <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∨</span> isRecvMarker <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nonregular_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> Snapshot<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> Snapshot <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> isSnapshot_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="free">p</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> jj<span class="main">(</span>2<span class="main">)</span> jj<span class="main">(</span>3<span class="main">)</span> local.step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Snapshot assms step <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cid'</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> RecvMarker<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> RecvMarker <span class="skolem">cid'</span> <span class="free">p</span> <span class="skolem">s</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> jj<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> distributed_system.no_state_change_if_no_event distributed_system_axioms event.sel<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> isRecvMarker_def local.step<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="free">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> Done"</span></span> <span class="keyword1"><span class="command">using</span></span> RecvMarker step <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> Done"</span></span> 
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> Done"</span></span>
          <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"ps <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> None"</span></span>
            <span class="keyword1"><span class="command">using</span></span> jj<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> jj<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> RecvMarker <span class="free">cid</span> <span class="free">q</span> <span class="free">p</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> f2 a1 assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>5<span class="main">)</span> cs_done_implies_both_snapshotted<span class="main">(</span>1<span class="main">)</span> done_only_from_recv_marker local.step <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> f2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Suc_eq_plus1 assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> local.step recv_marker_means_snapshotted<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> jj assms step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> tr_j<span class="main">:</span> <span class="quoted"><span class="quoted">"trace <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="var">?t</span> <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">i</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> discrete exists_trace_for_any_i_j<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> Marker <span class="main">:</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ev</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ev</span> <span class="main">∈</span> set <span class="var">?t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="skolem">ev</span> <span class="main">=</span> RecvMarker <span class="free">cid</span> <span class="bound">p</span> <span class="bound">q</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Marker <span class="main">∈</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>›</span></span> marker_must_be_delivered_2_trace tr_j assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> <span class="skolem">ev</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ev</span> <span class="main">∈</span> set <span class="main">(</span>take <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> exists_index <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> step_k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="free">t</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">i</span>›</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> step_Suc assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ev</span> <span class="main">=</span> RecvMarker <span class="free">cid</span> <span class="free">q</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms step_k can_occur_def 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="skolem">ev</span> <span class="main">=</span> RecvMarker <span class="free">cid</span> <span class="bound">p</span> <span class="bound">q</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> <span class="skolem">ev</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> Done"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">i</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> <span class="skolem">ev</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> recv_marker_means_cs_Done <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">i</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> discrete exists_trace_for_any_i_j<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> Done"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">i</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> cs_done_implies_same_snapshots discrete<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> no_marker_left_in_final_state<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="free">final</span> <span class="free">cid</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="var">?P</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&gt;</span> length <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms l1 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> final_is_s_t_len_t le_neq_implies_less<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"S <span class="free">t</span> <span class="main">(</span>length <span class="free">t</span><span class="main">)</span> <span class="main">≠</span> S <span class="free">t</span> <span class="skolem">i</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">≠</span> msgs <span class="free">final</span> <span class="free">cid</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">~</span> <span class="var">?P</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> final_is_s_t_len_t assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"S <span class="free">t</span> <span class="main">(</span>length <span class="free">t</span><span class="main">)</span> <span class="main">=</span> S <span class="free">t</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&gt;</span> length <span class="free">t</span>›</span></span> less_imp_le no_change_if_ge_length_t <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> all_channels_done_in_final_state<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="free">final</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> Done"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> cs_not_done<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> snd <span class="main">(</span>cs <span class="free">final</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> Done"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> snap_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> exists_snapshot_for_all_p<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"S <span class="free">t</span> <span class="skolem">i</span> <span class="main">≠</span> S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> snap_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> computation.no_change_if_ge_length_t computation_axioms le_add1 not_less<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="free">t</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> tr<span class="main">:</span> <span class="quoted"><span class="quoted">"trace <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="var">?t</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>length <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">t</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> discrete exists_trace_for_any_i_j<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">∈</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> n_done<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">≠</span> Done"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">≠</span> Done"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="free">final</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> Done"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 Suc_leI <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">t</span>›</span></span> assms final_is_s_t_len_t computation.cs_done_implies_same_snapshots computation_axioms order_refl<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> cs_not_done <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> snapshotted_and_not_done_implies_marker_in_channel snap_p assms
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">+</span><span class="main">1</span> <span class="main">≤</span> length <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">t</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> snapshotted_and_not_done_implies_marker_in_channel snap_p assms n_done <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>length <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> final_is_s_t_len_t no_marker_left_in_final_state assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> rm_prov<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ev</span> <span class="main">∈</span> set <span class="var">?t</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">ev</span> <span class="main">=</span> RecvMarker <span class="free">cid</span> <span class="bound">q</span> <span class="bound">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> tr message_must_be_delivered_2_trace assms 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> marker_must_be_delivered_2_trace<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">q</span> <span class="bound">p</span><span class="main">.</span> <span class="free">t</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> RecvMarker <span class="free">cid</span> <span class="bound">q</span> <span class="bound">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">+</span><span class="main">1</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> exists_index<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="free">t</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1_left add.commute assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> step_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> RecvMarker<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> RecvMarker <span class="free">cid</span> <span class="free">q</span> <span class="free">p</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> RecvMarker_given_channel <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">q</span> <span class="bound">p</span><span class="main">.</span> <span class="free">t</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> RecvMarker <span class="free">cid</span> <span class="bound">q</span> <span class="bound">p</span>›</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> event.disc<span class="main"><span class="main">(</span></span>25<span class="main"><span class="main">)</span></span> event.sel<span class="main"><span class="main">(</span></span>10<span class="main"><span class="main">)</span></span> happen_implies_can_occur<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> Done"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> step <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="free">t</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> recv_marker_means_cs_Done <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="free">final</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> Done"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>length <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>›</span></span> all_processes_snapshotted_in_final_state assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> final_is_s_t_len_t snapshotted_and_not_done_implies_marker_in_channel <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> cs_not_done <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cs_NotStarted_implies_empty_cs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span><span class="main">;</span> <span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span><span class="main">;</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">t</span><span class="main">;</span> <span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">q</span> <span class="main">⟧</span>
     <span class="main">⟹</span> cs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> NotStarted<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> no_initial_channel_snapshot no_recording_cs_if_not_snapshotted<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fst_changed_by_recv_recording_trace<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> length <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">≠</span> fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="free">j</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k</span><span class="main">.</span> <span class="free">i</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">u</span> <span class="bound">u'</span> <span class="bound">m</span><span class="main">.</span> <span class="free">t</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">=</span> Recv <span class="free">cid</span> <span class="bound">q</span> <span class="bound">p</span> <span class="bound">u</span> <span class="bound">u'</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="bound">k</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> Recording<span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="var">?P</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span><span class="main">;</span> <span class="free">j</span> <span class="main">≤</span> length <span class="free">t</span><span class="main">;</span> <span class="main">~</span> <span class="var">?P</span><span class="main">;</span> trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span><span class="main">;</span> <span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="free">j</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">-</span> <span class="free">i</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">↦</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> step_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> fst_cs_changed_by_recv_recording le_eq_less_or_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="free">j</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">-</span> Suc <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">u</span> <span class="bound">u'</span> <span class="bound">m</span><span class="main">.</span> <span class="free">t</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">=</span> Recv <span class="free">cid</span> <span class="bound">q</span> <span class="bound">p</span> <span class="bound">u</span> <span class="bound">u'</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="bound">k</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> Recording<span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">~</span> <span class="var">?P</span>›</span></span> Suc.prems<span class="main">(</span>3<span class="main">)</span> Suc_leD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_lessI<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹<span class="main">~</span> <span class="var">?P</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cs_not_nil_implies_postrecording_event<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> length <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">∧</span> postrecording_event <span class="free">t</span> <span class="bound">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>cs <span class="free">init</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> no_initial_channel_snapshot <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> diff_cs<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="main">0</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">≠</span> fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> init_is_s_t_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="main">0</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> diff_cs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Recv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">u</span> <span class="bound">u'</span> <span class="bound">m</span><span class="main">.</span> <span class="free">t</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> Recv <span class="free">cid</span> <span class="bound">q</span> <span class="bound">p</span> <span class="bound">u</span> <span class="bound">u'</span> <span class="bound">m</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> Recording"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> fst_changed_by_recv_recording_trace <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="free">q</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> cs_recording_implies_snapshot <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Recv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"can_occur <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Suc_le_eq <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">i</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> happen_implies_can_occur le_trans step_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Recv Recv_given_channel assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"postrecording_event <span class="free">t</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> postrecording_event <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">i</span>›</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">i</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Relating process states›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> snapshot_state_must_have_been_reached<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"ps <span class="free">final</span> <span class="free">p</span> <span class="main">=</span> Some <span class="free">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"states <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"states <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">p</span> <span class="main">≠</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ps <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">≠</span> Some <span class="free">u</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> snapshot_state <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ps <span class="free">final</span> <span class="free">p</span> <span class="main">≠</span> Some <span class="free">u</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_leI add.right_neutral add_Suc_right assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> final_is_s_t_len_t order_refl snapshot_state snapshot_state_unchanged_trace_2<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ps_after_all_prerecording_events<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i'</span><span class="main">.</span> <span class="bound">i'</span> <span class="main">≥</span> <span class="free">i</span> <span class="main">⟶</span> <span class="main">~</span> prerecording_event <span class="free">t</span> <span class="bound">i'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j'</span><span class="main">.</span> <span class="bound">j'</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">⟶</span> <span class="main">~</span> postrecording_event <span class="free">t</span> <span class="bound">j'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"ps_equal_to_snapshot <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">final</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> ps_equal_to_snapshot_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> allI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Some <span class="main">(</span>states <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> ps <span class="free">final</span> <span class="skolem">p</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"ps <span class="free">final</span> <span class="skolem">p</span> <span class="main">=</span> Some <span class="skolem">s</span> <span class="main">∨</span> ps <span class="free">final</span> <span class="skolem">p</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Some <span class="main">(</span>states <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">≠</span> ps <span class="free">final</span> <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ps <span class="free">final</span> <span class="skolem">p</span> <span class="main">=</span> None <span class="main">∨</span> states <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">≠</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"ps <span class="free">final</span> <span class="skolem">p</span> <span class="main">=</span> None"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> 
        <span class="keyword1"><span class="command">using</span></span> assms all_processes_snapshotted_in_final_state <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"states <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">≠</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">∧</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> Suc_eq_plus1 assms<span class="main">(</span>1<span class="main">)</span> exists_snapshot_for_all_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">p</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≥</span> <span class="free">i</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 <span class="quoted"><span class="quoted">‹<span class="main">¬</span> ps <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">≠</span> None <span class="main">∧</span> ps <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">≠</span> None›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> not_less_eq_eq snapshot_stable_ver_3<span class="main">)</span>

        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="free">i</span><span class="main">)</span> <span class="main">(</span>drop <span class="free">i</span> <span class="free">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ev</span><span class="main">.</span> <span class="bound">ev</span> <span class="main">∈</span> set <span class="var">?t</span> <span class="main">∧</span> regular_event <span class="bound">ev</span> <span class="main">∧</span> occurs_on <span class="bound">ev</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ev</span><span class="main">.</span> <span class="bound">ev</span> <span class="main">∈</span> set <span class="var">?t</span> <span class="main">∧</span> regular_event <span class="bound">ev</span> <span class="main">∧</span> occurs_on <span class="bound">ev</span> <span class="main">=</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="var">?t</span> <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≤</span> <span class="skolem">j</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> exists_trace_for_any_i_j <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"states <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> states <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">p</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> no_state_change_if_only_nonregular_events st <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> ps <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">≠</span> None <span class="main">∧</span> ps <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">≠</span> None›</span></span> <span class="quoted"><span class="quoted">‹ps <span class="free">final</span> <span class="skolem">p</span> <span class="main">=</span> Some <span class="skolem">s</span> <span class="main">∨</span> ps <span class="free">final</span> <span class="skolem">p</span> <span class="main">=</span> None›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> final_is_s_t_len_t computation.all_processes_snapshotted_in_final_state computation.snapshot_stable_ver_3 computation_axioms linorder_not_le snapshot_state_must_have_been_reached st<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>

        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ev</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ev</span> <span class="main">∈</span> set <span class="var">?t</span> <span class="main">∧</span> regular_event <span class="skolem">ev</span> <span class="main">∧</span> occurs_on <span class="skolem">ev</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> t_ind<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">k</span> <span class="main">∧</span> <span class="skolem">k</span> <span class="main">&lt;</span> length <span class="var">?t</span> <span class="main">∧</span> <span class="skolem">ev</span> <span class="main">=</span> <span class="var">?t</span> <span class="main">!</span> <span class="skolem">k</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_set_conv_nth not_le not_less_zero<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="var">?t</span> <span class="main">≤</span> <span class="skolem">j</span> <span class="main">-</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> <span class="main">(</span>drop <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">k</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> less_le_trans nth_take <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="free">i</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">ev</span> <span class="main">∈</span> set <span class="main">(</span>take <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>drop <span class="free">i</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> regular_event <span class="skolem">ev</span> <span class="main">∧</span> occurs_on <span class="skolem">ev</span> <span class="main">=</span> <span class="skolem">p</span>›</span></span> add.commute drop_eq_Nil length_greater_0_conv length_pos_if_in_set nat_le_linear nth_drop take_eq_Nil<span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> <span class="free">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prerecording_event <span class="free">t</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="free">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"regular_event <span class="main">(</span><span class="var">?t</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ev</span> <span class="main">∈</span> set <span class="main">(</span>take <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>drop <span class="free">i</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> regular_event <span class="skolem">ev</span> <span class="main">∧</span> occurs_on <span class="skolem">ev</span> <span class="main">=</span> <span class="skolem">p</span>›</span></span> t_ind <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"occurs_on <span class="main">(</span><span class="var">?t</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ev</span> <span class="main">∈</span> set <span class="main">(</span>take <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>drop <span class="free">i</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> regular_event <span class="skolem">ev</span> <span class="main">∧</span> occurs_on <span class="skolem">ev</span> <span class="main">=</span> <span class="skolem">p</span>›</span></span> t_ind <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span><span class="main">+</span><span class="free">i</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹length <span class="main">(</span>take <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>drop <span class="free">i</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">j</span> <span class="main">-</span> <span class="free">i</span>›</span></span> t_ind <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> ps <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">≠</span> None <span class="main">∧</span> ps <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">≠</span> None›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span><span class="main">+</span><span class="free">i</span> <span class="main">≤</span> <span class="skolem">j</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> snapshot_stable_ver_3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹take <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>drop <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> <span class="free">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="free">i</span><span class="main">)</span>›</span></span> prerecording_event t_ind <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>

        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> True

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≥</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> ps <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">≠</span> None <span class="main">∧</span> ps <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">≠</span> None›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>take <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>drop <span class="free">i</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> calculation<span class="main">(</span>1<span class="main">)</span> exists_trace_for_any_i_j <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> snapshot_stable <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>

        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span><span class="free">i</span><span class="main">-</span><span class="skolem">j</span><span class="main">)</span> <span class="main">(</span>drop <span class="skolem">j</span> <span class="free">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ev</span><span class="main">.</span> <span class="bound">ev</span> <span class="main">∈</span> set <span class="var">?t</span> <span class="main">∧</span> regular_event <span class="bound">ev</span> <span class="main">∧</span> occurs_on <span class="bound">ev</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ev</span><span class="main">.</span> <span class="bound">ev</span> <span class="main">∈</span> set <span class="var">?t</span> <span class="main">∧</span> regular_event <span class="bound">ev</span> <span class="main">∧</span> occurs_on <span class="bound">ev</span> <span class="main">=</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="var">?t</span> <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">i</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> exists_trace_for_any_i_j less_imp_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"states <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> states <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> no_state_change_if_only_nonregular_events <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"states <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> ps <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">≠</span> None <span class="main">∧</span> ps <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">≠</span> None›</span></span> <span class="quoted"><span class="quoted">‹ps <span class="free">final</span> <span class="skolem">p</span> <span class="main">=</span> Some <span class="skolem">s</span> <span class="main">∨</span> ps <span class="free">final</span> <span class="skolem">p</span> <span class="main">=</span> None›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> final_is_s_t_len_t computation.all_processes_snapshotted_in_final_state computation.snapshot_stable_ver_3 computation_axioms linorder_not_le snapshot_state_must_have_been_reached<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹states <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">≠</span> <span class="skolem">s</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>

        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ev</span></span> <span class="keyword2"><span class="keyword">where</span></span> ev<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ev</span> <span class="main">∈</span> set <span class="var">?t</span> <span class="main">∧</span> regular_event <span class="skolem">ev</span> <span class="main">∧</span> occurs_on <span class="skolem">ev</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> t_ind<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">k</span> <span class="main">∧</span> <span class="skolem">k</span> <span class="main">&lt;</span> length <span class="var">?t</span> <span class="main">∧</span> <span class="skolem">ev</span> <span class="main">=</span> <span class="var">?t</span> <span class="main">!</span> <span class="skolem">k</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_set_conv_nth le0<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="var">?t</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">-</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> <span class="main">(</span>drop <span class="skolem">j</span> <span class="free">t</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">k</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> t_ind <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">ev</span> <span class="main">∈</span> set <span class="main">(</span>take <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span>drop <span class="skolem">j</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> regular_event <span class="skolem">ev</span> <span class="main">∧</span> occurs_on <span class="skolem">ev</span> <span class="main">=</span> <span class="skolem">p</span>›</span></span> add.commute drop_eq_Nil length_greater_0_conv length_pos_if_in_set nat_le_linear nth_drop take_eq_Nil<span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> <span class="free">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"postrecording_event <span class="free">t</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="skolem">j</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span>take <span class="skolem">k</span> <span class="main">(</span>drop <span class="skolem">j</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_diff_cancel_right' assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> exists_trace_for_any_i_j le_add_same_cancel2 t_ind<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 Suc_leI <span class="quoted"><span class="quoted">‹<span class="main">¬</span> ps <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">≠</span> None <span class="main">∧</span> ps <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">≠</span> None›</span></span> <span class="quoted"><span class="quoted">‹take <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span>drop <span class="skolem">j</span> <span class="free">t</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> <span class="free">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="skolem">j</span><span class="main">)</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> drop_eq_Nil ev computation.snapshot_stable_ver_3 computation_axioms le_add_same_cancel2 length_greater_0_conv length_pos_if_in_set linorder_not_le order_le_less regular_event_preserves_process_snapshots step_Suc t_ind take_eq_Nil<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹take <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span>drop <span class="skolem">j</span> <span class="free">t</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> <span class="free">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="skolem">j</span><span class="main">)</span>›</span></span> ev postrecording_event t_ind <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">+</span> <span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹length <span class="main">(</span>take <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span>drop <span class="skolem">j</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">-</span> <span class="skolem">j</span>›</span></span> t_ind <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Relating channel states›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cs_when_recording<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span><span class="main">;</span> <span class="free">j</span> <span class="main">≤</span> length <span class="free">t</span><span class="main">;</span> trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span><span class="main">;</span>
       has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">p</span><span class="main">;</span>
       snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> Recording<span class="main">;</span>
       snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="free">j</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> Done<span class="main">;</span>
       <span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span> <span class="main">⟧</span>
     <span class="main">⟹</span> map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="free">j</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span><span class="main">)</span>
         <span class="main">=</span> map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">-</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">=</span> <span class="skolem">i</span><span class="main">+</span><span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span>S <span class="free">t</span> <span class="free">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.prems"</span> step_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> rm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">q</span> <span class="bound">p</span><span class="main">.</span> <span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> RecvMarker <span class="free">cid</span> <span class="bound">q</span> <span class="bound">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> done_only_from_recv_marker <span class="quoted">"0.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> RecvMarker<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> RecvMarker <span class="free">cid</span> <span class="free">q</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"0.prems"</span><span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> RecvMarker_given_channel event.collapse<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> event.disc<span class="main"><span class="main">(</span></span>25<span class="main"><span class="main">)</span></span> event.inject<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> happen_implies_can_occur local.step<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"can_occur <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> happen_implies_can_occur step <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">ms</span><span class="main">.</span> takeWhile <span class="bound">p</span> <span class="bound">ms</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> <span class="bound">p</span> <span class="main">(</span>hd <span class="bound">ms</span><span class="main">::</span><span class="tfree">'c</span> message<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> hd_append2 hd_in_set set_takeWhileD takeWhile_dropWhile_id<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹can_occur <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span>›</span></span> can_occur_def rm <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> local.step rm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 less_SucI nat_induct_at_least step_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ib<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">+</span><span class="main">1</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">∧</span> <span class="free">j</span> <span class="main">≤</span> length <span class="free">t</span> <span class="main">∧</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">∧</span> snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="free">j</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> Done"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc.hyps<span class="main">(</span>2<span class="main">)</span> Suc.prems<span class="main">(</span>2<span class="main">)</span> Suc.prems<span class="main">(</span>4<span class="main">)</span> Suc.prems<span class="main">(</span>6<span class="main">)</span> local.step snapshot_state_unchanged <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> snap_q<span class="main">:</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">q</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>7<span class="main">)</span> Suc.prems<span class="main">(</span>3<span class="main">)</span> Suc cs_recording_implies_snapshot <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Snapshot <span class="skolem">r</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≠</span> <span class="free">p</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>4<span class="main">)</span> can_occur_def local.step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Snapshot local.step Suc.prems<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> cs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≠</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Snapshot can_occur_def snap_q step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Snapshot local.step Suc.prems<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc ib <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>RecvMarker <span class="skolem">cid'</span> <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">cid</span> <span class="main">=</span> <span class="skolem">cid'</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"can_occur <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> happen_implies_can_occur step <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">ms</span><span class="main">.</span> takeWhile <span class="bound">p</span> <span class="bound">ms</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> <span class="bound">p</span> <span class="main">(</span>hd <span class="bound">ms</span><span class="main">::</span><span class="tfree">'c</span> message<span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> hd_append2 hd_in_set set_takeWhileD takeWhile_dropWhile_id<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> RecvMarker True <span class="quoted"><span class="quoted">‹can_occur <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span>›</span></span> can_occur_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> Done"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> RecvMarker Suc.prems<span class="main">(</span>1<span class="main">)</span> Suc.prems<span class="main">(</span>2<span class="main">)</span> Suc.prems<span class="main">(</span>3<span class="main">)</span> True recv_marker_means_cs_Done <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> RecvMarker True local.step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> Suc_eq_plus1 Suc_leI append_Nil2 cs_done_implies_same_snapshots<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">r</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> RecvMarker step Suc False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">with</span></span> RecvMarker step Suc <span class="quoted"><span class="quoted">‹<span class="free">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="free">p</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">r</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> RecvMarker step Suc False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> no_snap<span class="main">:</span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="free">q</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> snap_q no_snap <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="free">q</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> RecvMarker step Suc no_snap False <span class="quoted"><span class="quoted">‹<span class="free">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc ib <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Trans <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">u'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> step Trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc ib <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Send <span class="skolem">cid'</span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">cid</span> <span class="main">=</span> <span class="skolem">cid'</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">have</span></span> marker_in_msgs<span class="main">:</span> <span class="quoted"><span class="quoted">"Marker <span class="main">∈</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>1<span class="main">)</span> Suc.prems<span class="main">(</span>2<span class="main">)</span> less_le_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">≠</span> Done"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> snapshotted_and_not_done_implies_marker_in_channel less_imp_le <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"butlast <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> step True Send <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">@</span> <span class="main">[</span>last <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> marker_in_msgs <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹butlast <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span>›</span></span> append_butlast_last_id in_set_butlastD length_greater_0_conv length_pos_if_in_set marker_in_msgs<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> step Send <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ib Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> step Send <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> step Send <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc ib <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Recv <span class="skolem">cid'</span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">cid</span> <span class="main">=</span> <span class="skolem">cid'</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> msgs_ip1<span class="main">:</span> <span class="quoted"><span class="quoted">"Msg <span class="skolem">m</span> <span class="main">#</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Suc Recv step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> cs_ip1<span class="main">:</span> <span class="quoted"><span class="quoted">"cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> <span class="main">(</span>fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">m</span><span class="main">]</span><span class="main">,</span> Recording<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> True Suc Recv step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="free">j</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span><span class="main">)</span>
            <span class="main">=</span> map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Suc ib cs_ip1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>
                     <span class="main">=</span> map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>Msg <span class="skolem">m</span> <span class="main">#</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> Msg <span class="skolem">m</span> <span class="main">#</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> Msg <span class="skolem">m</span> <span class="main">#</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> msgs_ip1<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> cs_ip1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> step Recv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> step Recv False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc ib <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cs_when_recording_2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">j</span><span class="main">;</span> trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span><span class="main">;</span>
       <span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">p</span><span class="main">;</span>
       <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">i</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟶</span> <span class="main">~</span> occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span><span class="main">;</span>
       snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> Recording<span class="main">;</span>
       <span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span> <span class="main">⟧</span>
     <span class="main">⟹</span> map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="free">j</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">j</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>
         <span class="main">=</span> map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>
         <span class="main">∧</span> snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="free">j</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> Recording"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">-</span> <span class="free">i</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 all_processes_snapshotted_in_final_state distributed_system.step_Suc distributed_system_axioms computation.final_is_s_t_len_t computation_axioms linorder_not_le snapshot_stable_ver_3<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ib<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">+</span><span class="main">1</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">∧</span> <span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span>
         <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟶</span> <span class="main">~</span> occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span><span class="main">)</span> <span class="main">∧</span> <span class="free">j</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> diff_Suc_1 diff_diff_left Suc_eq_plus1 Suc_leD Suc_le_eq Suc_neq_Zero cancel_comm_monoid_add_class.diff_cancel le_neq_implies_less le_refl local.step no_state_change_if_no_event<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> snap_q<span class="main">:</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">q</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>5<span class="main">,</span>6<span class="main">)</span> Suc.prems<span class="main">(</span>2<span class="main">)</span> cs_recording_implies_snapshot <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Snapshot <span class="skolem">r</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≠</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Snapshot local.step Suc.prems<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> cs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≠</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> step can_occur_def Snapshot snap_q <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Snapshot step Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc ib <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>RecvMarker <span class="skolem">cid'</span> <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">cid</span> <span class="main">=</span> <span class="skolem">cid'</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">∈</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> RecvMarker RecvMarker_implies_Marker_in_set local.step <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">p</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>2<span class="main">)</span> no_marker_if_no_snapshot Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">r</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> RecvMarker step Suc False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">with</span></span> RecvMarker step Suc <span class="quoted"><span class="quoted">‹<span class="free">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="free">p</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">r</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> RecvMarker step Suc False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> no_snap<span class="main">:</span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="free">q</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> snap_q no_snap <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">=</span> <span class="free">q</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> RecvMarker step Suc no_snap False <span class="quoted"><span class="quoted">‹<span class="free">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc ib <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Trans <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">u'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> step Trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc ib <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Send <span class="skolem">cid'</span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≠</span> <span class="free">p</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Suc.hyps<span class="main">(</span>2<span class="main">)</span> Suc.prems<span class="main">(</span>4<span class="main">)</span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="free">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> <span class="free">channel</span> <span class="skolem">cid'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> can_occur_def step Send Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">≠</span> <span class="free">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> step Send <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> step Send <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc ib <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Recv <span class="skolem">cid'</span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">cid</span> <span class="main">=</span> <span class="skolem">cid'</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> msgs_ip1<span class="main">:</span> <span class="quoted"><span class="quoted">"Msg <span class="skolem">m</span> <span class="main">#</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Suc Recv step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> cs_ip1<span class="main">:</span> <span class="quoted"><span class="quoted">"cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> <span class="main">(</span>fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">m</span><span class="main">]</span><span class="main">,</span> Recording<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> True Suc Recv step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="free">j</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">j</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>
            <span class="main">=</span> map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>
            <span class="main">∧</span> snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="free">j</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> Recording"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Suc ib cs_ip1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>
                     <span class="main">=</span> map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>Msg <span class="skolem">m</span> <span class="main">#</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> Msg <span class="skolem">m</span> <span class="main">#</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> Msg <span class="skolem">m</span> <span class="main">#</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> msgs_ip1<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> cs_ip1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> cs_ip1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> step Recv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> step Recv False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc ib <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cs_when_recording_3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">j</span><span class="main">;</span> trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span><span class="main">;</span>
       <span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">q</span><span class="main">;</span>
       <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">i</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟶</span> <span class="main">~</span> occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">q</span><span class="main">;</span>
       snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> NotStarted<span class="main">;</span>
       has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">p</span><span class="main">;</span>
       Marker <span class="main">:</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span><span class="main">;</span>
       <span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span> <span class="main">⟧</span>
     <span class="main">⟹</span> map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="free">j</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">j</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>
         <span class="main">=</span> map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>
         <span class="main">∧</span> snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="free">j</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> NotStarted"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">-</span> <span class="free">i</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 all_processes_snapshotted_in_final_state distributed_system.step_Suc distributed_system_axioms computation.final_is_s_t_len_t computation_axioms linorder_not_le snapshot_stable_ver_3<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ib<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">+</span><span class="main">1</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">∧</span> <span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">q</span> <span class="main">∧</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span>
         <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟶</span> <span class="main">~</span> occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">q</span><span class="main">)</span> <span class="main">∧</span> <span class="free">j</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">n</span>
         <span class="main">∧</span> Marker <span class="main">:</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">∧</span> cs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">+</span><span class="main">1</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">∧</span> <span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">q</span>
         <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟶</span> <span class="main">~</span> occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">q</span><span class="main">)</span> <span class="main">∧</span> <span class="free">j</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> diff_Suc_1 diff_diff_left Suc_eq_plus1 Suc_leD Suc_le_eq Suc_neq_Zero cancel_comm_monoid_add_class.diff_cancel le_neq_implies_less le_refl local.step no_state_change_if_no_event<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>6<span class="main">)</span> local.step snapshot_state_unchanged <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">:</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Suc calculation<span class="main">(</span>1<span class="main">)</span> local.step recv_marker_means_snapshotted_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Suc calculation<span class="main">(</span>1<span class="main">)</span> no_recording_cs_if_not_snapshotted <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Snapshot <span class="skolem">r</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≠</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Snapshot Suc.prems<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> distributed_system.can_occur_def event.sel<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> event.simps<span class="main"><span class="main">(</span></span>29<span class="main"><span class="main">)</span></span> computation_axioms computation_def happen_implies_can_occur local.step<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> Snapshot local.step Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc ib <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>RecvMarker <span class="skolem">cid'</span> <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">cid</span> <span class="main">=</span> <span class="skolem">cid'</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> Done"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> RecvMarker Suc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Suc_eq_plus1 Suc_le_eq exactly_one_snapshot computation.no_change_if_ge_length_t computation.recv_marker_means_cs_Done computation.snapshot_stable_ver_2 computation_axioms ib nat_le_linear<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">r</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">with</span></span> RecvMarker False step <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> no_snap<span class="main">:</span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≠</span> <span class="free">p</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> no_snap RecvMarker step Suc.prems False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc ib <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Trans <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">u'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc ib <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Send <span class="skolem">cid'</span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≠</span> <span class="free">q</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Suc.hyps<span class="main">(</span>2<span class="main">)</span> Suc.prems<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> marker<span class="main">:</span> <span class="quoted"><span class="quoted">"Marker <span class="main">∈</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> step Send marker <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">cid</span> <span class="main">=</span> <span class="skolem">cid'</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc ib <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Recv <span class="skolem">cid'</span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cid'</span> <span class="main">≠</span> <span class="free">cid</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> distributed_system.can_occur_Recv distributed_system_axioms event.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> happen_implies_can_occur local.step option.inject order_refl prod.inject zero_less_Suc zero_less_diff<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> step Recv Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc ib <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> at_most_one_marker<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span><span class="main">;</span> <span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span> <span class="main">⟧</span>
     <span class="main">⟹</span> Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>
       <span class="main">∨</span> <span class="main">(</span><span class="main">∃!</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">∧</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> Marker<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> no_initial_Marker init_is_s_t_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> final_is_s_t_len_t computation.no_change_if_ge_length_t computation_axioms le_refl less_imp_le_nat no_marker_left_in_final_state not_less_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> step_Suc Suc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>
                <span class="main">∨</span> <span class="main">(</span><span class="main">∃!</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">∧</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> Marker<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc.hyps Suc.prems<span class="main">(</span>1<span class="main">)</span> Suc.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>
                <span class="main">∨</span> <span class="main">(</span><span class="main">∃!</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">∧</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> Marker<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> no_marker<span class="main">:</span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Snapshot <span class="skolem">r</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="free">p</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> new_msgs<span class="main">:</span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">@</span> <span class="main">[</span>Marker<span class="main">]</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> step Snapshot Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> util_exactly_one_element no_marker <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
            <span class="keyword1"><span class="command">using</span></span> Snapshot local.step no_marker Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>RecvMarker <span class="skolem">cid'</span> <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">cid</span> <span class="main">=</span> <span class="skolem">cid'</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
            <span class="keyword1"><span class="command">using</span></span> RecvMarker RecvMarker_implies_Marker_in_set local.step no_marker <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">r</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> RecvMarker step Suc False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> no_snap<span class="main">:</span> False
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="free">p</span>"</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> True
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">@</span> <span class="main">[</span>Marker<span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> RecvMarker step Suc.prems no_snap <span class="quoted"><span class="quoted">‹<span class="free">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">@</span> <span class="main">[</span>Marker<span class="main">]</span>"</span></span>
                <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">nn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat"</span></span>
                  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ms</span> <span class="bound">m</span><span class="main">.</span> <span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="main">∀</span><span class="bound">na</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">m</span><span class="main">::</span><span class="tfree">'c</span> message<span class="main">)</span> <span class="main">∈</span> set <span class="bound">ms</span> <span class="main">∨</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="bound">ms</span> <span class="main">@</span> <span class="main">[</span><span class="bound">m</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">m</span> <span class="main">∈</span> set <span class="bound">ms</span> <span class="main">∨</span> <span class="main">(</span><span class="bound">ms</span> <span class="main">@</span> <span class="main">[</span><span class="bound">m</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="bound">n</span> <span class="main">=</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">¬</span> <span class="bound">na</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="bound">ms</span> <span class="main">@</span> <span class="main">[</span><span class="bound">m</span><span class="main">]</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="bound">ms</span> <span class="main">@</span> <span class="main">[</span><span class="bound">m</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="bound">na</span> <span class="main">≠</span> <span class="bound">m</span> <span class="main">∨</span> <span class="bound">m</span> <span class="main">∈</span> set <span class="bound">ms</span> <span class="main">∨</span> <span class="bound">na</span> <span class="main">=</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
                    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> util_exactly_one_element<span class="main">)</span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">nn</span> <span class="bound">n</span> <span class="main">=</span> <span class="bound">n</span> <span class="main">∧</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span> <span class="main">!</span> <span class="bound">n</span> <span class="main">=</span> Marker <span class="main">∨</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">∧</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span> <span class="main">!</span> <span class="bound">n</span> <span class="main">=</span> Marker <span class="main">∧</span> <span class="main">¬</span> <span class="skolem">nn</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">∨</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">∧</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span> <span class="main">!</span> <span class="bound">n</span> <span class="main">=</span> Marker <span class="main">∧</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span> <span class="main">!</span> <span class="skolem">nn</span> <span class="bound">n</span> <span class="main">≠</span> Marker"</span></span>
                    <span class="keyword1"><span class="command">using</span></span> a1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 no_marker<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> False
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> RecvMarker step Suc.prems <span class="quoted"><span class="quoted">‹<span class="free">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>›</span></span> no_snap <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Trans <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">u'</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> no_marker step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Send <span class="skolem">cid'</span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">cid</span> <span class="main">=</span> <span class="skolem">cid'</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> step no_marker Send <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> step no_marker Send <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Recv <span class="skolem">cid'</span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> step no_marker Recv <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">cid</span> <span class="main">=</span> <span class="skolem">cid'</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">∧</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> Marker"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> len_filter<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>filter <span class="main">(</span><span class="main">(=)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> False <span class="quoted"><span class="quoted">‹Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃!</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">∧</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> Marker<span class="main">)</span>›</span></span> exists_one_iff_filter_one<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> snap_p<span class="main">:</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">p</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> False Suc.prems no_marker_if_no_snapshot <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Snapshot <span class="skolem">r</span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≠</span> <span class="free">p</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="skolem">r</span> <span class="main">≠</span> <span class="free">p</span>"</span></span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"can_occur <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> happen_implies_can_occur step <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> snap_p can_occur_def Snapshot <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> step Snapshot Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> asm <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>RecvMarker <span class="skolem">cid'</span> <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">cid</span> <span class="main">=</span> <span class="skolem">cid'</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">#</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> RecvMarker step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">⟶</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">≠</span> Marker"</span></span> 
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> False <span class="quoted"><span class="quoted">‹Marker <span class="main">#</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span>›</span></span> asm length_pos_if_in_set nth_Cons_0<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
              <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">⟶</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">≠</span> Marker"</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ms</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">ms</span> <span class="main">≠</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">∨</span> length <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">≠</span> <span class="bound">n</span> <span class="main">∨</span> length <span class="bound">ms</span> <span class="main">=</span> Suc <span class="bound">n</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹Marker <span class="main">#</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span>›</span></span> length_Suc_conv<span class="main">)</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">using</span></span> a1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Suc_mono Zero_not_Suc <span class="quoted"><span class="quoted">‹Marker <span class="main">#</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span>›</span></span> in_set_conv_nth nth_Cons_Suc<span class="main">)</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> cid_neq_cid'<span class="main">:</span> False
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">r</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span>"</span></span> 
              <span class="keyword1"><span class="command">using</span></span> cid_neq_cid' RecvMarker local.step snap_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> asm <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> False
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≠</span> <span class="free">p</span>"</span></span> 
              <span class="keyword1"><span class="command">using</span></span> snap_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cid_neq_cid' RecvMarker step False Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> asm <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Trans <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">u'</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> step asm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Send <span class="skolem">cid'</span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">cid</span> <span class="main">=</span> <span class="skolem">cid'</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> new_messages<span class="main">:</span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">@</span> <span class="main">[</span>Msg <span class="skolem">m</span><span class="main">]</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> step Send <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">∧</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> Marker"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>filter <span class="main">(</span><span class="main">(=)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span><span class="main">)</span>
                <span class="main">=</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">(=)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span><span class="main">)</span>
                <span class="main">+</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">(=)</span> Marker<span class="main">)</span> <span class="main">[</span>Msg <span class="skolem">m</span><span class="main">]</span><span class="main">)</span>"</span></span> 
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> new_messages<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>filter <span class="main">(</span><span class="main">(=)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> len_filter <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> exists_one_iff_filter_one <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> step Send asm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Recv <span class="skolem">cid'</span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span><span class="main">)</span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">cid</span> <span class="main">=</span> <span class="skolem">cid'</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> new_msgs<span class="main">:</span> <span class="quoted"><span class="quoted">"Msg <span class="skolem">m</span> <span class="main">#</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> step Recv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>filter <span class="main">(</span><span class="main">(=)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span><span class="main">)</span>
                <span class="main">=</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">(=)</span> Marker<span class="main">)</span> <span class="main">[</span>Msg <span class="skolem">m</span><span class="main">]</span><span class="main">)</span>
                <span class="main">+</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">(=)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span><span class="main">)</span>"</span></span> 
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Cons append_Nil filter_append len_filter length_append new_msgs<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>filter <span class="main">(</span><span class="main">(=)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> len_filter <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> exists_one_iff_filter_one <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> step Recv asm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> last_changes_implies_send_when_msgs_nonempty<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"last <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> Marker"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"last <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">≠</span> Marker"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">u</span> <span class="bound">u'</span> <span class="bound">m</span><span class="main">.</span> <span class="free">t</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> Send <span class="free">cid</span> <span class="free">p</span> <span class="free">q</span> <span class="bound">u</span> <span class="bound">u'</span> <span class="bound">m</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1_left add.commute assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> le_Suc_eq nat_le_linear nat_less_le no_change_if_ge_length_t step_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">!</span> <span class="free">i</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Snapshot <span class="skolem">r</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> last_snoc local.step next_snapshot<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>RecvMarker <span class="skolem">cid'</span> <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">cid</span> <span class="main">=</span> <span class="skolem">cid'</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"last <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> last <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">#</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> RecvMarker local.step True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> last_ConsR<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> no_snap<span class="main">:</span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"last <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> last <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">r</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> RecvMarker step no_snap <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">with</span></span> RecvMarker step no_snap <span class="quoted"><span class="quoted">‹<span class="free">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>›</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="skolem">r</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Trans <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">u'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> assms<span class="main">(</span>5<span class="main">)</span> local.step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Send <span class="skolem">cid'</span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">cid</span> <span class="main">=</span> <span class="skolem">cid'</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> local.step next_send<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> <span class="free">channel</span> <span class="skolem">cid'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">cid</span> <span class="main">=</span> <span class="skolem">cid'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="skolem">cid'</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Send step can_occur_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Send <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Recv <span class="skolem">cid'</span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">cid</span> <span class="main">=</span> <span class="skolem">cid'</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"last <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> last <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Recv assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> last_ConsR local.step next_recv<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Recv step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> no_marker_after_RecvMarker<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="main">⊢</span> RecvMarker <span class="free">cid</span> <span class="free">p</span> <span class="free">q</span> <span class="main">↦</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">q</span><span class="main">,</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> new_msgs<span class="main">:</span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> Marker <span class="main">#</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> one_marker<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">∧</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">=</span> Marker"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> at_most_one_marker list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> new_msgs<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> Marker"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> one_marker new_msgs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">⟶</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">≠</span> Marker"</span></span>
    <span class="keyword1"><span class="command">using</span></span> one_marker 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> Marker›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">⟶</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">≠</span> Marker"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_eq_plus1 Suc_le_eq Suc_mono le_zero_eq list.size<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> new_msgs not_less0 nth_Cons_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> no_marker_and_snapshotted_implies_no_more_markers_trace<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span><span class="main">;</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">j</span><span class="main">;</span> <span class="free">j</span> <span class="main">≤</span> length <span class="free">t</span><span class="main">;</span>
       has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">p</span><span class="main">;</span>
       Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span><span class="main">;</span>
       <span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span> <span class="main">⟧</span>
     <span class="main">⟹</span> Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">j</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">-</span> <span class="free">i</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> Suc_eq_plus1 cancel_comm_monoid_add_class.diff_cancel distributed_system.step_Suc distributed_system_axioms less_le_trans linorder_not_less old.nat.distinct<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> order_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> no_marker_and_snapshotted_implies_no_more_markers Suc step <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>4<span class="main">)</span> local.step snapshot_state_unchanged <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"ps <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">≠</span> None"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> f3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≠</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc.hyps<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">-</span> Suc <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Suc.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> add.commute add_Suc_right add_diff_cancel_left' le_add_diff_inverse<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> f3 a2 a1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> Suc_eq_plus1_left add.commute less_Suc_eq linorder_not_less<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> marker_not_vanishing_means_always_present<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span><span class="main">;</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">j</span><span class="main">;</span> <span class="free">j</span> <span class="main">≤</span> length <span class="free">t</span><span class="main">;</span>
       Marker <span class="main">:</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span><span class="main">;</span>
       Marker <span class="main">:</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">j</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span><span class="main">;</span>
       <span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span>
     <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">i</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟶</span> Marker <span class="main">:</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="bound">k</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">-</span> <span class="free">i</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Suc_eq_plus1 add_lessD1 distributed_system.step_Suc distributed_system_axioms le_add_diff_inverse order_le_less zero_less_Suc zero_less_diff<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">:</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> Marker <span class="main">:</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> snap_p<span class="main">:</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">p</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>1<span class="main">)</span> Suc.prems<span class="main">(</span>4<span class="main">,</span>6<span class="main">)</span> no_marker_if_no_snapshot <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> local.step snapshot_state_unchanged <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">j</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> asm discrete no_marker_and_snapshotted_implies_no_more_markers_trace zero_less_Suc zero_less_diff<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> Suc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> computation.snapshot_stable_ver_3 computation_axioms no_marker_and_snapshotted_implies_no_more_markers_trace no_marker_if_no_snapshot<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> last_stays_if_no_recv_marker_and_no_send<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span><span class="main">;</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span><span class="main">;</span> <span class="free">j</span> <span class="main">≤</span> length <span class="free">t</span><span class="main">;</span>
           last <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> Marker<span class="main">;</span>
           Marker <span class="main">:</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span><span class="main">;</span>
           Marker <span class="main">:</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">j</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span><span class="main">;</span>
           <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">i</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟶</span> <span class="main">~</span> <span class="main">(</span><span class="main">∃</span><span class="bound">u</span> <span class="bound">u'</span> <span class="bound">m</span><span class="main">.</span> <span class="free">t</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">=</span> Send <span class="free">cid</span> <span class="free">p</span> <span class="free">q</span> <span class="bound">u</span> <span class="bound">u'</span> <span class="bound">m</span><span class="main">)</span><span class="main">;</span>
           <span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span> <span class="main">⟧</span>
         <span class="main">⟹</span> last <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">j</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> Marker"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">-</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">=</span> <span class="skolem">i</span><span class="main">+</span><span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"0"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quoted">"0.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quoted">"0.prems"</span><span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> Suc_eq_plus1 distributed_system.step_Suc distributed_system_axioms less_le_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">=</span> last <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> Marker <span class="main">=</span> last <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span> <span class="bound">u'</span> <span class="bound">m</span><span class="main">.</span> <span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> Send <span class="free">cid</span> <span class="free">p</span> <span class="free">q</span> <span class="bound">u</span> <span class="bound">u'</span> <span class="bound">m</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0"</span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">=</span> <span class="skolem">i</span><span class="main">+</span><span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.prems"</span><span class="main">(</span>1<span class="main">)</span> <span class="quoted">"0.prems"</span><span class="main">(</span>4<span class="main">)</span> <span class="quoted">"0.prems"</span><span class="main">(</span>8<span class="main">)</span> <span class="quoted"><span class="quoted">‹Marker <span class="main">≠</span> last <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>›</span></span> last_changes_implies_send_when_msgs_nonempty <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">=</span> <span class="skolem">i</span><span class="main">+</span><span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> Suc_eq_plus1 distributed_system.step_Suc distributed_system_axioms less_le_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> marker_present<span class="main">:</span> <span class="quoted"><span class="quoted">"Marker <span class="main">:</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> discrete le_add1 less_imp_le_nat marker_not_vanishing_means_always_present<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">=</span> last <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> Marker <span class="main">=</span> last <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span> <span class="bound">u'</span> <span class="bound">m</span><span class="main">.</span> <span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> Send <span class="free">cid</span> <span class="free">p</span> <span class="free">q</span> <span class="bound">u</span> <span class="bound">u'</span> <span class="bound">m</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> marker_present <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>1<span class="main">)</span> Suc.prems<span class="main">(</span>4<span class="main">)</span> Suc.prems<span class="main">(</span>8<span class="main">)</span> asm last_changes_implies_send_when_msgs_nonempty <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="skolem">i</span><span class="main">+</span><span class="main">1</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟶</span> <span class="main">~</span> <span class="main">(</span><span class="main">∃</span><span class="bound">u</span> <span class="bound">u'</span> <span class="bound">m</span><span class="main">.</span> <span class="free">t</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">=</span> Send <span class="free">cid</span> <span class="free">p</span> <span class="free">q</span> <span class="bound">u</span> <span class="bound">u'</span> <span class="bound">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">+</span><span class="main">1</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> length <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">:</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">j</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_Suc_1 diff_diff_left<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> last_changes_implies_send_when_msgs_nonempty_trace<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> length <span class="free">t</span>"</span></span>
    <span class="quoted"><span class="quoted">"Marker <span class="main">:</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"Marker <span class="main">:</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">j</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"last <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> Marker"</span></span>
    <span class="quoted"><span class="quoted">"last <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">j</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">≠</span> Marker"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k</span> <span class="bound">u</span> <span class="bound">u'</span> <span class="bound">m</span><span class="main">.</span> <span class="free">i</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">∧</span> <span class="free">t</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">=</span> Send <span class="free">cid</span> <span class="free">p</span> <span class="free">q</span> <span class="bound">u</span> <span class="bound">u'</span> <span class="bound">m</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span> <span class="bound">u</span> <span class="bound">u'</span> <span class="bound">m</span><span class="main">.</span> <span class="free">i</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">∧</span> <span class="free">t</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">=</span> Send <span class="free">cid</span> <span class="free">p</span> <span class="free">q</span> <span class="bound">u</span> <span class="bound">u'</span> <span class="bound">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">i</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟶</span> <span class="main">~</span> <span class="main">(</span><span class="main">∃</span><span class="bound">u</span> <span class="bound">u'</span> <span class="bound">m</span><span class="main">.</span> <span class="free">t</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">=</span> Send <span class="free">cid</span> <span class="free">p</span> <span class="free">q</span> <span class="bound">u</span> <span class="bound">u'</span> <span class="bound">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"last <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">j</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> Marker"</span></span> <span class="keyword1"><span class="command">using</span></span> assms last_stays_if_no_recv_marker_and_no_send <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> msg_after_marker_and_nonempty_implies_postrecording_event<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"Marker <span class="main">:</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"Marker <span class="main">≠</span> last <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> length <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">∧</span> postrecording_event <span class="free">t</span> <span class="bound">j</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?len</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?len</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> snap_p_i<span class="main">:</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">p</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms no_marker_if_no_snapshot <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> snap_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> exists_snapshot_for_all_p<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> computation.snapshot_stable_ver_2 computation_axioms not_less snap_p<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> snap_p_i<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> step_snap<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> l2 nat_le_linear nat_less_le snap_p<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> snapshot_stable_ver_2 step_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> re<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> distributed_system.regular_event_cannot_induce_snapshot distributed_system_axioms snap_p<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> snap_p<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> step_snap<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> op<span class="main">:</span> <span class="quoted"><span class="quoted">"occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> no_state_change_if_no_event snap_p<span class="main">(</span>1<span class="main">)</span> snap_p<span class="main">(</span>2<span class="main">)</span> step_snap <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> marker_last<span class="main">:</span> <span class="quoted"><span class="quoted">"Marker <span class="main">=</span> last <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">∧</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"isSnapshot <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∨</span> isRecvMarker <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> re nonregular_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> Snapshot <span class="free">p</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> op <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> step_snap assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cid'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> RecvMarker<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> RecvMarker <span class="skolem">cid'</span> <span class="free">p</span> <span class="skolem">r</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> event.collapse<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> op<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> RecvMarker_implies_Marker_in_set assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>5<span class="main">)</span> no_marker_if_no_snapshot snap_p<span class="main">(</span>1<span class="main">)</span> step_snap <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">using</span></span> assms snap_p<span class="main">(</span>1<span class="main">)</span> step_snap RecvMarker <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k</span> <span class="bound">u</span> <span class="bound">u'</span> <span class="bound">m</span><span class="main">.</span> <span class="skolem">j</span><span class="main">+</span><span class="main">1</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">∧</span> <span class="free">t</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">=</span> Send <span class="free">cid</span> <span class="free">p</span> <span class="free">q</span> <span class="bound">u</span> <span class="bound">u'</span> <span class="bound">m</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">+</span><span class="main">1</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> marker_last <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">+</span><span class="main">1</span> <span class="main">≠</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">+</span><span class="main">1</span> <span class="main">≤</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">i</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">=</span> last <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> marker_last <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">:</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> marker_last <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> marker_last<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms last_changes_implies_send_when_msgs_nonempty_trace <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> Send<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span> <span class="bound">u'</span> <span class="bound">m</span><span class="main">.</span> <span class="skolem">j</span><span class="main">+</span><span class="main">1</span> <span class="main">≤</span> <span class="skolem">k</span> <span class="main">∧</span> <span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">∧</span> <span class="free">t</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> Send <span class="free">cid</span> <span class="free">p</span> <span class="free">q</span> <span class="bound">u</span> <span class="bound">u'</span> <span class="bound">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"postrecording_event <span class="free">t</span> <span class="skolem">k</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Send assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"isSend <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Send <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">k</span><span class="main">)</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Send snap_p 
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> snapshot_stable_ver_3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Send <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> postrecording_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Send <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> same_messages_if_no_occurrence_trace<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span><span class="main">;</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">j</span><span class="main">;</span> <span class="free">j</span> <span class="main">≤</span> length <span class="free">t</span><span class="main">;</span>
       <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">i</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟶</span> occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">≠</span> <span class="free">p</span> <span class="main">∧</span> occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">≠</span> <span class="free">q</span><span class="main">)</span><span class="main">;</span>
       <span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span> <span class="main">⟧</span>
     <span class="main">⟹</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">j</span><span class="main">)</span> <span class="free">cid</span> <span class="main">∧</span> cs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> cs <span class="main">(</span>S <span class="free">t</span> <span class="free">j</span><span class="main">)</span> <span class="free">cid</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">-</span> <span class="free">i</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> Suc_eq_plus1 Suc_n_not_le_n diff_self_eq_0 distributed_system.step_Suc distributed_system_axioms le0 le_eq_less_or_eq less_le_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span> <span class="main">∧</span> cs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> step Suc same_messages_if_no_occurrence <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">j</span><span class="main">)</span> <span class="free">cid</span> <span class="main">∧</span> cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> cs <span class="main">(</span>S <span class="free">t</span> <span class="free">j</span><span class="main">)</span> <span class="free">cid</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">+</span><span class="main">1</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="skolem">i</span><span class="main">+</span><span class="main">1</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟶</span> occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">≠</span> <span class="free">p</span> <span class="main">∧</span> occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">≠</span> <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> snapshot_step_cs_preservation_p<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">~</span> regular_event <span class="free">ev</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span> <span class="main">=</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="free">c</span> <span class="free">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="free">c</span> <span class="free">cid</span><span class="main">)</span>
   <span class="main">=</span> map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="free">c'</span> <span class="free">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="free">c'</span> <span class="free">cid</span><span class="main">)</span>
   <span class="main">∧</span> snd <span class="main">(</span>cs <span class="free">c</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span>cs <span class="free">c'</span> <span class="free">cid</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"isSnapshot <span class="free">ev</span> <span class="main">∨</span> isRecvMarker <span class="free">ev</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms nonregular_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> Snap<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> Snapshot <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> event.collapse<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>cs <span class="free">c</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>cs <span class="free">c'</span> <span class="free">cid</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> regular_event same_cs_if_not_recv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="free">c</span> <span class="free">cid</span><span class="main">)</span>
                 <span class="main">=</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="free">c'</span> <span class="free">cid</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">c'</span> <span class="free">cid</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">cid</span> <span class="main">@</span> <span class="main">[</span>Marker<span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms Snap <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> takeWhile_tail<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="free">c</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span>cs <span class="free">c'</span> <span class="free">cid</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Snap assms no_self_channel <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cid'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> RecvMarker<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> RecvMarker <span class="skolem">cid'</span> <span class="free">p</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> event.collapse<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"2"</span> RecvMarker assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> distributed_system.RecvMarker_given_channel distributed_system.happen_implies_can_occur distributed_system_axioms event.sel<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">,</span></span>10<span class="main"><span class="main">)</span></span> no_self_channel<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>cs <span class="free">c</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>cs <span class="free">c'</span> <span class="free">cid</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> RecvMarker assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> regular_event same_cs_if_not_recv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="free">c</span> <span class="free">cid</span><span class="main">)</span>
                 <span class="main">=</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="free">c'</span> <span class="free">cid</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="free">c</span> <span class="free">p</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">c</span> <span class="free">cid</span> <span class="main">=</span> msgs <span class="free">c'</span> <span class="free">cid</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> RecvMarker <span class="quoted"><span class="quoted">‹<span class="free">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>›</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">c'</span> <span class="free">cid</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">cid</span> <span class="main">@</span> <span class="main">[</span>Marker<span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> RecvMarker <span class="quoted"><span class="quoted">‹<span class="free">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>›</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> takeWhile_tail<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="free">c</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span>cs <span class="free">c'</span> <span class="free">cid</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="free">c</span> <span class="free">p</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="free">c</span> <span class="free">cid</span> <span class="main">=</span> cs <span class="free">c'</span> <span class="free">cid</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> RecvMarker <span class="quoted"><span class="quoted">‹<span class="free">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>›</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> RecvMarker <span class="quoted"><span class="quoted">‹<span class="free">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> no_self_channel <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> snapshot_step_cs_preservation_q<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">c'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">~</span> regular_event <span class="free">ev</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"occurs_on <span class="free">ev</span> <span class="main">=</span> <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="free">c</span> <span class="free">cid</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="free">c</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="free">c</span> <span class="free">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="free">c</span> <span class="free">cid</span><span class="main">)</span>
   <span class="main">=</span> map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="free">c'</span> <span class="free">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="free">c'</span> <span class="free">cid</span><span class="main">)</span>
   <span class="main">∧</span> snd <span class="main">(</span>cs <span class="free">c'</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> Recording"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"isSnapshot <span class="free">ev</span> <span class="main">∨</span> isRecvMarker <span class="free">ev</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms nonregular_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> Snapshot<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> Snapshot <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> event.collapse<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>cs <span class="free">c</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>cs <span class="free">c'</span> <span class="free">cid</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> regular_event same_cs_if_not_recv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="free">c</span> <span class="free">cid</span><span class="main">)</span>
                 <span class="main">=</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="free">c'</span> <span class="free">cid</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">c'</span> <span class="free">cid</span> <span class="main">=</span> msgs <span class="free">c</span> <span class="free">cid</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms Snapshot 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> distributed_system.next_snapshot distributed_system_axioms eq_fst_iff no_self_channel option.inject<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="free">c'</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> Recording"</span></span> <span class="keyword1"><span class="command">using</span></span> assms Snapshot <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cid'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> RecvMarker<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ev</span> <span class="main">=</span> RecvMarker <span class="skolem">cid'</span> <span class="free">q</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> event.collapse<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> RecvMarker RecvMarker_implies_Marker_in_set assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>cs <span class="free">c</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>cs <span class="free">c'</span> <span class="free">cid</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> regular_event same_cs_if_not_recv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="free">c</span> <span class="free">cid</span><span class="main">)</span>
                 <span class="main">=</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="free">c'</span> <span class="free">cid</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">r</span><span class="main">.</span> <span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">q</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> no_self_channel <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> RecvMarker assms <span class="quoted"><span class="quoted">‹<span class="free">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="free">c</span> <span class="free">cid</span> <span class="main">=</span> msgs <span class="free">c'</span> <span class="free">cid</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="free">c</span> <span class="skolem">r</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="free">c'</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> Recording"</span></span> <span class="keyword1"><span class="command">using</span></span> assms RecvMarker <span class="quoted"><span class="quoted">‹<span class="free">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Marker_in_channel_implies_not_done<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"Marker <span class="main">:</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> length <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">≠</span> Done"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> is_done<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">≠</span> Done"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"take <span class="free">i</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> tr<span class="main">:</span> <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="var">?t</span> <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> exists_trace_for_any_i <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">q</span> <span class="bound">p</span><span class="main">.</span> RecvMarker <span class="free">cid</span> <span class="bound">q</span> <span class="bound">p</span> <span class="main">∈</span> set <span class="var">?t</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> distributed_system.trace.simps distributed_system_axioms done_only_from_recv_marker_trace computation.no_initial_channel_snapshot computation_axioms is_done list.discI recording_state.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> snd_conv tr<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> RecvMarker<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">q</span> <span class="bound">p</span><span class="main">.</span> <span class="free">t</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> RecvMarker <span class="free">cid</span> <span class="bound">q</span> <span class="bound">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> in_set_conv_nth length_take min.absorb2 nth_take<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step_j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> distributed_system.step_Suc distributed_system_axioms assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> less_le_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> RecvMarker <span class="free">cid</span> <span class="free">q</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> RecvMarker<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> RecvMarker_given_channel assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> event.disc<span class="main"><span class="main">(</span></span>25<span class="main"><span class="main">)</span></span> event.sel<span class="main"><span class="main">(</span></span>10<span class="main"><span class="main">)</span></span> happen_implies_can_occur<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> no_marker_after_RecvMarker step_j <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Suc_eq_plus1 <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> RecvMarker <span class="free">cid</span> <span class="free">q</span> <span class="free">p</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> recv_marker_means_snapshotted snapshot_state_unchanged step_j <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> RecvMarker<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Suc_eq_plus1 Suc_leI assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> no_marker_and_snapshotted_implies_no_more_markers_trace<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> keep_empty_if_no_events<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span><span class="main">;</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">j</span><span class="main">;</span> <span class="free">j</span> <span class="main">≤</span> length <span class="free">t</span><span class="main">;</span>
       msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> <span class="main">[]</span><span class="main">;</span>
       has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">p</span><span class="main">;</span>
       <span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span><span class="main">;</span>
       <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">i</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">∧</span> regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">~</span> occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span> <span class="main">⟧</span>
     <span class="main">⟹</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">j</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">-</span> <span class="free">i</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc.hyps<span class="main">(</span>2<span class="main">)</span> Suc.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Suc_eq_plus1 step_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Snapshot <span class="skolem">r</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≠</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="skolem">r</span> <span class="main">≠</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"can_occur <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> happen_implies_can_occur local.step <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> can_occur_def Snapshot Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Snapshot local.step Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>RecvMarker <span class="skolem">cid'</span> <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="free">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> RecvMarker length_greater_0_conv linorder_not_less list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> local.step nat_less_le recv_marker_other_channels_not_shrinking<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">r</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> RecvMarker Suc step <span class="quoted"><span class="quoted">‹<span class="free">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≠</span> <span class="free">p</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> False Suc.prems<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> RecvMarker Suc step <span class="quoted"><span class="quoted">‹<span class="free">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>›</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Trans <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">u'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc step <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Send <span class="skolem">cid'</span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≠</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="skolem">r</span> <span class="main">≠</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∧</span> regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Send <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">i</span> <span class="main">∧</span> <span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> Suc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="free">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> <span class="free">channel</span> <span class="skolem">cid'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="skolem">cid'</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Send step can_occur_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">≠</span> <span class="free">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">~</span> <span class="free">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> step Send Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Recv <span class="skolem">cid'</span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="free">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> Recv local.step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Recv step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="skolem">i</span><span class="main">+</span><span class="main">1</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">∧</span> regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">~</span> occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> discrete less_not_refl nat_le_linear snapshot_stable_ver_3<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">+</span><span class="main">1</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> length <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> last_unchanged_or_empty_if_no_events<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span><span class="main">;</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">j</span><span class="main">;</span> <span class="free">j</span> <span class="main">≤</span> length <span class="free">t</span><span class="main">;</span>
       msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">;</span>
       last <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> Marker<span class="main">;</span>
       has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">p</span><span class="main">;</span>
       <span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">q</span><span class="main">)</span><span class="main">;</span>
       <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">i</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">∧</span> regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">~</span> occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span> <span class="main">⟧</span>
     <span class="main">⟹</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">j</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">j</span><span class="main">)</span> <span class="free">cid</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> last <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">j</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> Marker<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">-</span> <span class="free">i</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc.hyps<span class="main">(</span>2<span class="main">)</span> Suc.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Suc_eq_plus1 step_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> msgs_s_ip1<span class="main">:</span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> last <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> Marker<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Snapshot <span class="skolem">r</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≠</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="skolem">r</span> <span class="main">≠</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"can_occur <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> happen_implies_can_occur local.step <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> can_occur_def Snapshot Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Snapshot local.step Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>RecvMarker <span class="skolem">cid'</span> <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">cid</span> <span class="main">=</span> <span class="skolem">cid'</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">#</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> RecvMarker True local.step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"Marker <span class="main">#</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Suc.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Suc_neq_Zero diff_is_0_eq le_neq_implies_less<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>3<span class="main">)</span> less_le_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> a1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Marker_in_channel_implies_not_done RecvMarker Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> Suc_eq_plus1 Suc_le_eq True last_ConsR last_in_set recv_marker_means_cs_Done<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">r</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
          <span class="keyword1"><span class="command">using</span></span> False RecvMarker Suc.prems<span class="main">(</span>5<span class="main">)</span> local.step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≠</span> <span class="free">p</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">with</span></span> RecvMarker False Suc.prems step <span class="quoted"><span class="quoted">‹<span class="free">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Trans <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">u'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc step <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Send <span class="skolem">cid'</span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≠</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="skolem">r</span> <span class="main">≠</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∧</span> regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Send <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">i</span> <span class="main">∧</span> <span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> Suc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="free">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> <span class="free">channel</span> <span class="skolem">cid'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="skolem">cid'</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Send step can_occur_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">≠</span> <span class="free">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">~</span> <span class="free">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> step Send <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Recv <span class="skolem">cid'</span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">u'</span> <span class="skolem">m</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">cid</span> <span class="main">=</span> <span class="skolem">cid'</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> Msg <span class="skolem">m</span> <span class="main">#</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> Recv local.step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"last <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span><span class="main">)</span> <span class="main">=</span> Marker"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc.prems<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> last.simps message.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cid</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Recv step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">+</span><span class="main">1</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> length <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>6<span class="main">)</span> local.step snapshot_state_unchanged <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="skolem">i</span><span class="main">+</span><span class="main">1</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">∧</span> regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">~</span> occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">j</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> keep_empty_if_no_events Suc.prems<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">+</span><span class="main">1</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> length <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>6<span class="main">)</span> local.step snapshot_state_unchanged <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="skolem">i</span><span class="main">+</span><span class="main">1</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">∧</span> regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">~</span> occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>7<span class="main">)</span> Suc.hyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cs_after_all_prerecording_events<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i'</span><span class="main">.</span> <span class="bound">i'</span> <span class="main">≥</span> <span class="free">i</span> <span class="main">⟶</span> <span class="main">~</span> prerecording_event <span class="free">t</span> <span class="bound">i'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j'</span><span class="main">.</span> <span class="bound">j'</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">⟶</span> <span class="main">~</span> postrecording_event <span class="free">t</span> <span class="bound">j'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> length <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"cs_equal_to_snapshot <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">final</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> cs_equal_to_snapshot_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">cid</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="skolem">cid</span> <span class="main">≠</span> None"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> chan<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="skolem">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> cs_done<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>length <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span> <span class="main">=</span> Done"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> chan all_channels_done_in_final_state assms<span class="main">(</span>1<span class="main">)</span> final_is_s_t_len_t <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span> <span class="main">=</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">cid</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="var">?B</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> range<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="var">?m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?m</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> Marker"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?m</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">≠</span> Marker"</span></span>
      <span class="keyword1"><span class="command">using</span></span> filter_neq_takeWhile <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">∈</span> set <span class="var">?m</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_trans nth_mem<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"last <span class="var">?m</span> <span class="main">≠</span> Marker"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="main">&lt;</span> length <span class="var">?m</span> <span class="main">∧</span> <span class="bound">l</span> <span class="main">≠</span> <span class="skolem">j</span> <span class="main">⟶</span> <span class="var">?m</span> <span class="main">!</span> <span class="bound">l</span> <span class="main">≠</span> Marker"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> chan <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">cid</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> Marker›</span></span> assms<span class="main">(</span>1<span class="main">)</span> at_most_one_marker calculation less_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"last <span class="var">?m</span> <span class="main">=</span> <span class="var">?m</span> <span class="main">!</span> <span class="main">(</span>length <span class="var">?m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹Marker <span class="main">∈</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span>›</span></span> empty_iff last_conv_nth list.set<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="var">?m</span> <span class="main">-</span> <span class="main">1</span> <span class="main">≠</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> range <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> range <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> length <span class="free">t</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> chan assms<span class="main">(</span>1<span class="main">)</span> calculation<span class="main">(</span>1<span class="main">)</span> computation.exists_next_marker_free_state computation.no_change_if_ge_length_t computation_axioms nat_le_linear <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">∧</span> postrecording_event <span class="free">t</span> <span class="bound">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> chan assms<span class="main">(</span>1<span class="main">)</span> msg_after_marker_and_nonempty_implies_postrecording_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span> <span class="main">=</span> map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="free">final</span> <span class="skolem">cid</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> NotStarted
    <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹show that q and p have to snapshot, and then reduce it to the case below depending on
          the order they snapshotted in›</span></span>
    <span class="keyword1"><span class="command">have</span></span> nsq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">q</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> NotStarted chan assms<span class="main">(</span>1<span class="main">)</span> cs_in_initial_state_implies_not_snapshotted <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> snap_q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">q</span>"</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">q</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> exists_snapshot_for_all_p<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> step_q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> ps <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">q</span> <span class="main">≠</span> None›</span></span> add.commute assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> le_SucI le_eq_less_or_eq le_refl linorder_neqE_nat no_change_if_ge_length_t plus_1_eq_Suc snap_q step_Suc<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> snap_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> exists_snapshot_for_all_p<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="free">i</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≥</span> <span class="skolem">j</span><span class="main">+</span><span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">q</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> computation.snapshot_stable_ver_3 computation_axioms snap_q<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> nsq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> step_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="free">t</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> ps <span class="main">(</span>S <span class="free">t</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">≠</span> None›</span></span> add.commute assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> le_SucI le_eq_less_or_eq le_refl linorder_neqE_nat no_change_if_ge_length_t plus_1_eq_Suc snap_p step_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> oq<span class="main">:</span> <span class="quoted"><span class="quoted">"occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">q</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">q</span> <span class="main">=</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">q</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> no_state_change_if_no_event step_q <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> snap_q <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> op<span class="main">:</span> <span class="quoted"><span class="quoted">"occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> no_state_change_if_no_event step_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> snap_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> chan no_self_channel <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≠</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> oq op event_occurs_on_unique <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">k</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">cid</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">cid</span> <span class="main">∧</span> cs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">cid</span> <span class="main">=</span> cs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">cid</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">i</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="skolem">j</span> <span class="main">⟶</span> occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">≠</span> <span class="skolem">p</span> <span class="main">∧</span> occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">≠</span> <span class="skolem">q</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="var">?Q</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> range<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">∨</span> occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> 1
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">l</span><span class="main">)</span>"</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> True
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">&lt;</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> range <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">l</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> snap_p<span class="main">(</span>1<span class="main">)</span> range <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span> snapshot_stable_ver_3 assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prerecording_event <span class="free">t</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="quoted">"1"</span> prerecording_event 
                <span class="keyword1"><span class="command">using</span></span> s_def snap_q<span class="main">(</span>1<span class="main">)</span> snap_q<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms range <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> False
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step_l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="free">t</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">!</span> <span class="skolem">l</span> <span class="main">↦</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">l</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Suc_eq_plus1 Suc_lessD True assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> distributed_system.step_Suc distributed_system_axioms less_trans_Suc linorder_not_le local.range<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> s_def snap_p<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> snap_p<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> take_all<span class="main">)</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">l</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False nonregular_event_induces_snapshot 
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"1"</span><span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> snapshot_state_unchanged<span class="main">)</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> 
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 Suc_leI True assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> less_imp_le_nat local.range<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> snap_p<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> snapshot_stable_ver_3<span class="main">)</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> 2
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">l</span><span class="main">)</span>"</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> True
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">l</span><span class="main">)</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> snap_q<span class="main">(</span>1<span class="main">)</span> range <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span> snapshot_stable_ver_3 assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prerecording_event <span class="free">t</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="quoted">"2"</span> prerecording_event 
                <span class="keyword1"><span class="command">using</span></span> s_def snap_q<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms range <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> False
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step_l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="free">t</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">!</span> <span class="skolem">l</span> <span class="main">↦</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">l</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Suc_eq_plus1 Suc_lessD True assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> distributed_system.step_Suc distributed_system_axioms less_trans_Suc linorder_not_le local.range<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> s_def snap_p<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> snap_p<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> take_all<span class="main">)</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">l</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False nonregular_event_induces_snapshot 
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"2"</span><span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> snapshot_state_unchanged<span class="main">)</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> 
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 Suc_leI assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> range<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> snap_q<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> snapshot_stable_ver_3<span class="main">)</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> length <span class="free">t</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="skolem">j</span> <span class="main">≤</span> length <span class="free">t</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"S <span class="free">t</span> <span class="skolem">j</span> <span class="main">=</span> S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> no_change_if_ge_length_t assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> snap_q <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> chan same_messages_if_no_occurrence_trace assms less_imp_le bound <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span>
                   <span class="main">=</span> map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span>
                   <span class="main">∧</span> snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span> <span class="main">=</span> Recording"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> snap_q 
          <span class="keyword1"><span class="command">using</span></span> regular_event_cannot_induce_snapshot step_q <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> chan True assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> computation.no_marker_if_no_snapshot computation.snapshot_stable_ver_2 computation_axioms less_imp_le_nat snap_p<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> oq snapshot_step_cs_preservation_q step_q chan snap_q<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span>
                 <span class="main">=</span> map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span> <span class="main">=</span> Recording"</span></span> <span class="keyword1"><span class="command">using</span></span> calculation <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">j</span><span class="main">+</span><span class="main">1</span> <span class="main">≤</span> <span class="bound">a</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">&lt;</span> <span class="skolem">k</span> <span class="main">⟶</span> <span class="main">~</span> occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="var">?R</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">+</span><span class="main">1</span> <span class="main">≤</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">&lt;</span> <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ocp<span class="main">:</span> <span class="quoted"><span class="quoted">"occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="skolem">k</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"S <span class="free">t</span> <span class="skolem">k</span> <span class="main">=</span> S <span class="free">t</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span> 
                <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> no_change_if_ge_length_t <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> snap_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">a</span><span class="main">)</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">a</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> 
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> computation.snapshot_stable_ver_2 computation_axioms less_imp_le_nat snap_p<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prerecording_event <span class="free">t</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">&lt;</span> length <span class="free">t</span>›</span></span> ocp True prerecording_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span><span class="main">+</span><span class="main">1</span> <span class="main">≤</span> <span class="skolem">a</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">≥</span> <span class="free">i</span>›</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> False
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="free">t</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">a</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">&lt;</span> length <span class="free">t</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> step_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">a</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> 
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> False ocp nonregular_event_induces_snapshot snapshot_state_unchanged<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> 
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 Suc_leI <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> snap_p<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> snapshot_stable_ver_3<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 Suc_le_eq True assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> computation.snapshot_stable_ver_2 computation_axioms snap_p<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> chan cs_when_recording_2 True assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span>
                 <span class="main">=</span> map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> regular_event_preserves_process_snapshots snap_p<span class="main">(</span>1<span class="main">)</span> snap_p<span class="main">(</span>2<span class="main">)</span> step_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> chan computation.snapshot_step_cs_preservation_p computation_axioms op step_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span>
                 <span class="main">=</span> map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="free">final</span> <span class="skolem">cid</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span> <span class="bound">p</span> <span class="bound">pa</span> <span class="bound">pb</span> <span class="bound">c</span> <span class="bound">ca</span> <span class="bound">es</span> <span class="bound">n</span> <span class="bound">a</span> <span class="bound">na</span><span class="main">.</span> <span class="main">¬</span> computation <span class="bound">f</span> <span class="bound">p</span> <span class="bound">pa</span> <span class="bound">pb</span> <span class="main">(</span><span class="bound">c</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> configuration<span class="main">)</span> <span class="bound">ca</span> <span class="main">∨</span> <span class="main">¬</span> distributed_system.trace <span class="bound">f</span> <span class="bound">p</span> <span class="bound">pa</span> <span class="bound">pb</span> <span class="bound">c</span> <span class="bound">es</span> <span class="bound">ca</span> <span class="main">∨</span> ps <span class="main">(</span>distributed_system.s <span class="bound">f</span> <span class="bound">p</span> <span class="bound">pa</span> <span class="bound">pb</span> <span class="bound">c</span> <span class="bound">es</span> <span class="bound">n</span><span class="main">)</span> <span class="bound">a</span> <span class="main">=</span> None <span class="main">∨</span> <span class="main">¬</span> <span class="bound">n</span> <span class="main">≤</span> <span class="bound">na</span> <span class="main">∨</span> ps <span class="main">(</span>distributed_system.s <span class="bound">f</span> <span class="bound">p</span> <span class="bound">pa</span> <span class="bound">pb</span> <span class="bound">c</span> <span class="bound">es</span> <span class="bound">na</span><span class="main">)</span> <span class="bound">a</span> <span class="main">≠</span> None"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> computation.snapshot_stable_ver_2<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"computation <span class="free">channel</span> <span class="free">trans</span> <span class="free">send</span> <span class="free">recv</span> <span class="free">init</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>length <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> final_is_s_t_len_t computation_axioms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> f3<span class="main">:</span> <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>length <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> final_is_s_t_len_t <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> f4<span class="main">:</span> <span class="quoted"><span class="quoted">"ps <span class="main">(</span>S <span class="free">t</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> None"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> snap_p<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> f3 f2 f1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_eq_less_or_eq not_le s_def snap_p<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> take_all<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> f4 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> distributed_system.regular_event_cannot_induce_snapshot distributed_system_axioms snap_p<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> step_p<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f6<span class="main">:</span> <span class="quoted"><span class="quoted">"map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span> <span class="main">=</span> map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span> <span class="main">∧</span> snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> chan computation.snapshot_step_cs_preservation_p computation_axioms op step_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f7<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span> <span class="main">≠</span> Done"</span></span>
          <span class="keyword1"><span class="command">using</span></span> f5 f4 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> chan cs_done_implies_both_snapshotted<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> <span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span> <span class="main">=</span> Recording"</span></span>
          <span class="keyword1"><span class="command">using</span></span> f7 f3 f2 f1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> chan computation.cs_in_initial_state_implies_not_snapshotted recording_state.exhaust snap_q<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
         <span class="keyword1"><span class="command">using</span></span> f6 f5 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Suc_eq_plus1 Suc_leI assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> chan cs_done cs_done_implies_both_snapshotted<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> cs_when_recording final_is_s_t_len_t le_eq_less_or_eq snap_p<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> chan Nil_is_map_conv assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> computation.no_initial_channel_snapshot computation_axioms fst_conv no_recording_cs_if_not_snapshotted self_append_conv2 snap_q<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">≠</span> <span class="skolem">k</span>›</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span>
               <span class="main">=</span> map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">cid</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">cid</span> <span class="main">∧</span> cs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">cid</span> <span class="main">=</span> cs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">cid</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span><span class="main">.</span> <span class="free">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="skolem">k</span> <span class="main">⟶</span> occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">≠</span> <span class="skolem">p</span> <span class="main">∧</span> occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">≠</span> <span class="skolem">q</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="var">?Q</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> range<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">&lt;</span> <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">∨</span> occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> 1
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">l</span><span class="main">)</span>"</span></span><span class="main">)</span>
                <span class="keyword3"><span class="command">case</span></span> True
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">&lt;</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> range <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">l</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> snap_p<span class="main">(</span>1<span class="main">)</span> range <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> snapshot_stable_ver_3 assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prerecording_event <span class="free">t</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="quoted">"1"</span> prerecording_event 
                  <span class="keyword1"><span class="command">using</span></span> s_def snap_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms range <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">next</span></span>
                <span class="keyword3"><span class="command">case</span></span> False
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step_l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="free">t</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">!</span> <span class="skolem">l</span> <span class="main">↦</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">l</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Suc_eq_plus1 Suc_lessD assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> distributed_system.step_Suc distributed_system_axioms less_trans_Suc linorder_not_le local.range<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> s_def snap_p<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> snap_p<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> take_all<span class="main">)</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">l</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False nonregular_event_induces_snapshot 
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"1"</span><span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> snapshot_state_unchanged<span class="main">)</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> 
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 Suc_leI assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> local.range<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> snap_p<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> snapshot_stable_ver_3<span class="main">)</span>
              <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> 2
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">l</span><span class="main">)</span>"</span></span><span class="main">)</span>
                <span class="keyword3"><span class="command">case</span></span> True
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">l</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> snap_p<span class="main">(</span>1<span class="main">)</span> range <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> snapshot_stable_ver_3 assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span> 
                  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> local.range<span class="main">(</span>2<span class="main">)</span> s_def snap_q<span class="main">(</span>1<span class="main">)</span> snap_q<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
                <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prerecording_event <span class="free">t</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="quoted">"2"</span> prerecording_event 
                <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span>
                    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> False <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span> less_trans not_less<span class="main">)</span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> True <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">&lt;</span> length <span class="free">t</span>›</span></span> <span class="quoted"><span class="quoted">‹occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">q</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> computation.prerecording_event computation.snapshot_stable_ver_2 computation_axioms snap_q<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
                <span class="keyword1"><span class="command">qed</span></span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms range <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">next</span></span>
                <span class="keyword3"><span class="command">case</span></span> False
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step_l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="free">t</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">!</span> <span class="skolem">l</span> <span class="main">↦</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">l</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Suc_eq_plus1 Suc_lessD assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> distributed_system.step_Suc distributed_system_axioms less_trans_Suc linorder_not_le local.range<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> s_def snap_p<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> snap_p<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> take_all<span class="main">)</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">l</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False nonregular_event_induces_snapshot 
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"2"</span><span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> snapshot_state_unchanged<span class="main">)</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> 
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 Suc_leI <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> less_imp_le_nat local.range<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> snap_q<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> snapshot_stable_ver_3<span class="main">)</span>
              <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> length <span class="free">t</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="skolem">k</span> <span class="main">≤</span> length <span class="free">t</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"S <span class="free">t</span> <span class="skolem">k</span> <span class="main">=</span> S <span class="free">t</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> no_change_if_ge_length_t assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> snap_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> chan same_messages_if_no_occurrence_trace assms True less_imp_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span>
                   <span class="main">=</span> map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span>
                   <span class="main">∧</span> snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span> <span class="main">=</span> NotStarted"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> snap_p 
            <span class="keyword1"><span class="command">using</span></span> regular_event_cannot_induce_snapshot step_p <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> calculation op snapshot_step_cs_preservation_p step_p chan NotStarted <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span>
                   <span class="main">=</span> map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">k</span><span class="main">+</span><span class="main">1</span> <span class="main">≤</span> <span class="bound">a</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">&lt;</span> <span class="skolem">j</span> <span class="main">⟶</span> <span class="main">~</span> occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">q</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="var">?R</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span><span class="main">+</span><span class="main">1</span> <span class="main">≤</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ocp<span class="main">:</span> <span class="quoted"><span class="quoted">"occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
                <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"S <span class="free">t</span> <span class="skolem">j</span> <span class="main">=</span> S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span> 
                  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> no_change_if_ge_length_t <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> snap_q <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">a</span><span class="main">)</span>"</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> True
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">a</span><span class="main">)</span> <span class="skolem">q</span>"</span></span> 
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> computation.snapshot_stable_ver_2 computation_axioms less_imp_le_nat snap_q<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prerecording_event <span class="free">t</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">&lt;</span> length <span class="free">t</span>›</span></span> ocp True prerecording_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span><span class="main">+</span><span class="main">1</span> <span class="main">≤</span> <span class="skolem">a</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">≥</span> <span class="free">i</span>›</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> False
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="free">t</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">a</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">&lt;</span> length <span class="free">t</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> step_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">a</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">q</span>"</span></span> 
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> False ocp nonregular_event_induces_snapshot snapshot_state_unchanged<span class="main">)</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> 
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 Suc_leI <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> snap_q<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> snapshot_stable_ver_3<span class="main">)</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">:</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> chan <span class="quoted"><span class="quoted">‹map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span> <span class="main">=</span> map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span> <span class="main">∧</span> snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span> <span class="main">=</span> NotStarted›</span></span> assms<span class="main">(</span>1<span class="main">)</span> cs_in_initial_state_implies_not_snapshotted marker_must_stay_if_no_snapshot snap_p<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> snap_p<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">q</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> chan <span class="quoted"><span class="quoted">‹map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span> <span class="main">=</span> map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span> <span class="main">∧</span> snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span> <span class="main">=</span> NotStarted›</span></span> assms<span class="main">(</span>1<span class="main">)</span> cs_in_initial_state_implies_not_snapshotted <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span><span class="main">+</span><span class="main">1</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span> <span class="main">=</span> NotStarted"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span> <span class="main">=</span> map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span> <span class="main">∧</span> snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span> <span class="main">=</span> NotStarted›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> cs_when_recording_3 chan <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> False Suc_eq_plus1 assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> not_less_eq_eq snap_p<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> snapshot_stable_ver_3<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">q</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> nsq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">:</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> chan assms<span class="main">(</span>1<span class="main">)</span> calculation<span class="main">(</span>1<span class="main">)</span> marker_must_stay_if_no_snapshot nsq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">i</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="skolem">j</span> <span class="main">⟶</span> <span class="main">~</span> occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">q</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="var">?R</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ocp<span class="main">:</span> <span class="quoted"><span class="quoted">"occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
                <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"S <span class="free">t</span> <span class="skolem">j</span> <span class="main">=</span> S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span> 
                  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> no_change_if_ge_length_t <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> snap_q <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span>"</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> True
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">q</span>"</span></span> 
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> computation.snapshot_stable_ver_2 computation_axioms less_imp_le_nat snap_q<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prerecording_event <span class="free">t</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="free">t</span>›</span></span> ocp True prerecording_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≤</span> <span class="skolem">j</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">≥</span> <span class="free">i</span>›</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> False
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="free">t</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="free">t</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> step_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">q</span>"</span></span> 
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> False ocp nonregular_event_induces_snapshot snapshot_state_unchanged<span class="main">)</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> 
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 Suc_leI <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> snap_q<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> snapshot_stable_ver_3<span class="main">)</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> cs_when_recording_3 
            <span class="keyword1"><span class="command">using</span></span> NotStarted assms<span class="main">(</span>1<span class="main">)</span> bound chan <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span>
                   <span class="main">=</span> map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="free">final</span> <span class="skolem">cid</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">q</span> <span class="bound">p</span><span class="main">.</span> <span class="free">t</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> RecvMarker <span class="skolem">cid</span> <span class="bound">q</span> <span class="bound">p</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> step_q <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> RecvMarker<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> RecvMarker <span class="skolem">cid</span> <span class="skolem">q</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"can_occur <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> happen_implies_can_occur step_q <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
            <span class="keyword1"><span class="command">using</span></span> RecvMarker_given_channel True chan <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"can_occur <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> happen_implies_can_occur step_q <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> hd <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span> <span class="main">=</span> Marker"</span></span>
            <span class="keyword1"><span class="command">using</span></span> RecvMarker can_occur_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> hd_conv_nth length_greater_0_conv nth_mem set_takeWhileD takeWhile_nth<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span> <span class="main">=</span> Done"</span></span> <span class="keyword1"><span class="command">using</span></span> step_q True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span> <span class="main">=</span> cs <span class="free">final</span> <span class="skolem">cid</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> chan calculation cs_done_implies_same_snapshots assms<span class="main">(</span>1<span class="main">)</span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> final_is_s_t_len_t nat_le_linear no_change_if_ge_length_t<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> regular_event_preserves_process_snapshots snap_q<span class="main">(</span>1<span class="main">)</span> snap_q<span class="main">(</span>2<span class="main">)</span> step_q <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"isSnapshot <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∨</span> isRecvMarker <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nonregular_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span>
                 <span class="main">=</span> map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span>
                 <span class="main">∧</span> snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span> <span class="main">=</span> Recording"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> 1
          <span class="keyword1"><span class="command">have</span></span> Snapshot<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> Snapshot <span class="skolem">q</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1"</span> oq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">cid</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≠</span> <span class="skolem">q</span>›</span></span> step_q chan <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span> <span class="main">=</span> <span class="main">(</span>fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span><span class="main">,</span> Recording<span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> step_q Snapshot chan <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> 2
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cid'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> RecvMarker<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> RecvMarker <span class="skolem">cid'</span> <span class="skolem">q</span> <span class="skolem">r</span>"</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"2"</span> event.collapse<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> oq<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="skolem">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="skolem">cid</span> <span class="main">=</span> <span class="free">channel</span> <span class="skolem">cid'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="skolem">cid'</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> 
              <span class="keyword1"><span class="command">using</span></span> False RecvMarker <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> 
              <span class="keyword1"><span class="command">using</span></span> False RecvMarker <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="skolem">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">cid</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>›</span></span> step_q snap_q RecvMarker chan <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≠</span> <span class="skolem">q</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span> <span class="main">=</span> <span class="main">(</span>fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span><span class="main">,</span> Recording<span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≠</span> <span class="skolem">q</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>›</span></span>step_q snap_q RecvMarker chan <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span>
                     <span class="main">=</span> map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="free">final</span> <span class="skolem">cid</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span> <span class="main">=</span> Recording"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> calculation <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 Suc_leI <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> le_add1 snap_p<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> snapshot_stable_ver_3<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> snap_q <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> chan Suc_eq_plus1 assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> cs_done cs_done_implies_both_snapshotted<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> computation.no_change_if_ge_length_t computation.snapshot_stable_ver_3 computation_axioms leI le_Suc_eq snap_q<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> snap_q<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> cs_when_recording assms<span class="main">(</span>1<span class="main">)</span> cs_done final_is_s_t_len_t
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span>
            <span class="keyword3"><span class="command">assume</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span>
            <span class="keyword3"><span class="command">assume</span></span> a3<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>length <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span> <span class="main">=</span> Done"</span></span>
            <span class="keyword3"><span class="command">assume</span></span> a4<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span> <span class="main">=</span> Recording"</span></span>
            <span class="keyword3"><span class="command">assume</span></span> a5<span class="main">:</span> <span class="quoted"><span class="quoted">"ps <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">≠</span> None"</span></span>
            <span class="keyword3"><span class="command">assume</span></span> a6<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> trace <span class="free">init</span> <span class="bound">t</span> <span class="free">final</span> <span class="main">⟹</span> <span class="free">final</span> <span class="main">=</span> S <span class="bound">t</span> <span class="main">(</span>length <span class="bound">t</span><span class="main">)</span>"</span></span>
            <span class="keyword3"><span class="command">assume</span></span> a7<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span> <span class="bound">t</span> <span class="bound">p</span> <span class="bound">cid</span> <span class="bound">q</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">j</span><span class="main">;</span> <span class="bound">j</span> <span class="main">≤</span> length <span class="bound">t</span><span class="main">;</span> trace <span class="free">init</span> <span class="bound">t</span> <span class="free">final</span><span class="main">;</span> ps <span class="main">(</span>S <span class="bound">t</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">p</span> <span class="main">≠</span> None<span class="main">;</span> snd <span class="main">(</span>cs <span class="main">(</span>S <span class="bound">t</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">cid</span><span class="main">)</span> <span class="main">=</span> Recording<span class="main">;</span> snd <span class="main">(</span>cs <span class="main">(</span>S <span class="bound">t</span> <span class="bound">j</span><span class="main">)</span> <span class="bound">cid</span><span class="main">)</span> <span class="main">=</span> Done<span class="main">;</span> <span class="free">channel</span> <span class="bound">cid</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="main">(</span>S <span class="bound">t</span> <span class="bound">j</span><span class="main">)</span> <span class="bound">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="main">(</span>S <span class="bound">t</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="bound">t</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">cid</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> a3 a2 a1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> False Suc_eq_plus1 Suc_lessI chan cs_done_implies_has_snapshotted done_only_from_recv_marker snap_q<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> step_q<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">using</span></span> a7 a6 a5 a4 a3 a2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Suc_eq_plus1 chan nat_le_linear<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Nil_is_map_conv assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> chan cs_done cs_done_implies_has_snapshotted cs_not_nil_implies_postrecording_event nat_le_linear nsq self_append_conv2 snapshot_stable_ver_3<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Recording
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> snap_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> exists_snapshot_for_all_p<span class="main">)</span> 
    <span class="keyword1"><span class="command">have</span></span> snap_q<span class="main">:</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">q</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Recording assms<span class="main">(</span>1<span class="main">)</span> chan cs_recording_implies_snapshot <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> fst_cs_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"cs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">cid</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> Recording<span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="var">?P</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span> <span class="main">=</span> Recording"</span></span> <span class="keyword1"><span class="command">using</span></span> Recording <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">~</span> <span class="var">?P</span>›</span></span> prod.collapse calculation <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">∧</span> postrecording_event <span class="free">t</span> <span class="bound">j</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> chan cs_not_nil_implies_postrecording_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> i_less_len_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span> <span class="main">=</span> Done"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> cs_done le_eq_less_or_eq nat_le_linear no_change_if_ge_length_t<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> Recording <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="free">final</span> <span class="skolem">cid</span><span class="main">)</span><span class="main">)</span>
          <span class="main">=</span> map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 Suc_leI assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> snap_p<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> snapshot_stable_ver_3<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">t</span> <span class="main">≤</span> length <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
          <span class="keyword1"><span class="command">using</span></span> Recording chan assms<span class="main">(</span>1<span class="main">)</span> cs_done cs_when_recording final_is_s_t_len_t i_less_len_t <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹need to show that next message that comes into the channel must be marker›</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">i</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="skolem">j</span> <span class="main">⟶</span> <span class="main">~</span> occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="var">?P</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prerecording_event <span class="free">t</span> <span class="skolem">k</span>"</span></span> 
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> <span class="quoted"><span class="quoted">‹occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">p</span>›</span></span> all_processes_snapshotted_in_final_state assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> final_is_s_t_len_t computation.prerecording_event computation_axioms less_trans nat_le_linear not_less snap_p<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> snapshot_stable_ver_2<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≤</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> False
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step_k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="free">t</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span> 
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Suc_leI <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> all_processes_snapshotted_in_final_state assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> final_is_s_t_len_t le_Suc_eq less_imp_Suc_add linorder_not_less no_change_if_ge_length_t snap_p<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> step_Suc<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> 
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> False <span class="quoted"><span class="quoted">‹occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">p</span>›</span></span> nonregular_event_induces_snapshot snapshot_state_unchanged<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≥</span> <span class="skolem">j</span>"</span></span> 
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_leI <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> snap_p<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> snapshot_stable_ver_3<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> False assms<span class="main">(</span>1<span class="main">)</span> snap_p<span class="main">(</span>1<span class="main">)</span> snapshot_stable_ver_3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> to_snapshot<span class="main">:</span> <span class="quoted"><span class="quoted">"map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span>
                       <span class="main">=</span> map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> False chan Recording assms<span class="main">(</span>1<span class="main">)</span> cs_when_recording_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> step_j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 Suc_le_eq assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> distributed_system.step_Suc distributed_system_axioms computation.no_change_if_ge_length_t computation_axioms le_add1 not_less_eq_eq snap_p<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> snap_p<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span>
                 <span class="main">=</span> map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> o<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∧</span> occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> distributed_system.no_state_change_if_no_event distributed_system.regular_event_cannot_induce_snapshot distributed_system_axioms snap_p<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> snap_p<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> step_j<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> chan snapshot_step_cs_preservation_p step_j <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="free">final</span> <span class="skolem">cid</span><span class="main">)</span><span class="main">)</span>
           <span class="main">=</span> map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span> <span class="main">=</span> Recording"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"ps <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> None"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> snap_p<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> all_processes_snapshotted_in_final_state assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> final_is_s_t_len_t linorder_not_le snapshot_stable_ver_3<span class="main">)</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">≠</span> RecvMarker <span class="skolem">cid</span> <span class="skolem">q</span> <span class="skolem">p</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> f1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Suc_eq_plus1 assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> recv_marker_means_snapshotted step_j<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">using</span></span> f2 f1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> False assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> chan cs_done_implies_both_snapshotted<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> cs_in_initial_state_implies_not_snapshotted cs_not_not_started_stable done_only_from_recv_marker linorder_not_le recording_state.exhaust snap_q snapshot_stable_ver_3 step_j<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">+</span><span class="main">1</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="skolem">j</span><span class="main">+</span><span class="main">1</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span> <span class="main">=</span> Done"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> cs_done le_Suc_eq less_imp_Suc_add linorder_not_le no_change_if_ge_length_t<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> calculation <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> chan snap_p<span class="main">(</span>2<span class="main">)</span> assms final_is_s_t_len_t cs_when_recording cs_done <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> to_snapshot <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> fst_cs_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Done
    <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹msgs must be empty, and cs must also be empty›</span></span>
    <span class="keyword1"><span class="command">have</span></span> fst_cs_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span> <span class="main">≠</span> fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> chan assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> cs_not_nil_implies_postrecording_event gr_implies_not0 le0<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">∧</span> postrecording_event <span class="free">t</span> <span class="bound">j</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> chan <span class="quoted"><span class="quoted">‹fst <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> cs_not_nil_implies_postrecording_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">cid</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> no_marker<span class="main">:</span> <span class="quoted"><span class="quoted">"Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="var">?P</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">:</span> set <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>cs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span> <span class="main">≠</span> Done"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Marker_in_channel_implies_not_done chan assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> nat_le_linear s_def take_all<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> Done <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> snap_both<span class="main">:</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">∧</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">q</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> chan Done assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> cs_done_implies_both_snapshotted<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> cs_done_implies_has_snapshotted final_is_s_t_len_t computation.all_processes_snapshotted_in_final_state computation_axioms le_refl not_less s_def take_all<span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> snap_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> exists_snapshot_for_all_p<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> not_le_imp_less snap_both snap_p<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> snapshot_stable_ver_2<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> step_j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">↦</span> <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> distributed_system.step_Suc distributed_system_axioms computation.no_change_if_ge_length_t computation_axioms le_add1 linorder_not_less snap_p<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> snap_p<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> nonreg_j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> distributed_system.regular_event_cannot_induce_snapshot distributed_system_axioms snap_p<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> snap_p<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> step_j<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> oc_j<span class="main">:</span> <span class="quoted"><span class="quoted">"occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> no_state_change_if_no_event snap_p<span class="main">(</span>1<span class="main">)</span> snap_p<span class="main">(</span>2<span class="main">)</span> step_j <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">cid</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">cid</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> last <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span> <span class="main">=</span> Marker<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> last <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span> <span class="main">=</span> Marker"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"msgs <span class="main">(</span>S <span class="free">t</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span> <span class="main">=</span> msgs <span class="main">(</span>S <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">cid</span> <span class="main">@</span> <span class="main">[</span>Marker<span class="main">]</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"isSnapshot <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∨</span> isRecvMarker <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nonregular_event nonreg_j <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> 1
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> Snapshot <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> oc_j <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> step_j chan <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> 2
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cid'</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> RecvMarker<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> RecvMarker <span class="skolem">cid'</span> <span class="skolem">p</span> <span class="skolem">r</span>"</span></span> 
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> event.collapse<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> oc_j<span class="main">)</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>"</span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
                <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="skolem">cid</span> <span class="main">≠</span> <span class="skolem">cid'</span>"</span></span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="skolem">cid</span> <span class="main">=</span> <span class="free">channel</span> <span class="skolem">cid'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Some <span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> 
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> RecvMarker RecvMarker_implies_Marker_in_set assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> chan computation.no_marker_if_no_snapshot computation_axioms snap_p<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> step_j<span class="main">)</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> no_self_channel chan <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> oc_j snap_p step_j chan RecvMarker <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> length <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">+</span><span class="main">1</span> <span class="main">≤</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">i</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="skolem">j</span><span class="main">+</span><span class="main">1</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">∧</span> regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">~</span> occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="var">?R</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> range<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">+</span><span class="main">1</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"postrecording_event <span class="free">t</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> snap_p 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> calculation<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> le_trans linorder_not_less pre_if_regular_and_not_post prerecording_event snapshot_stable_ver_2<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms range <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
          <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> chan last_unchanged_or_empty_if_no_events snap_p<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> no_marker last_in_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> chan Done assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> final_is_s_t_len_t computation.cs_done_implies_same_snapshots computation_axioms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">(≠)</span> Marker<span class="main">)</span> <span class="main">(</span>msgs <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span> <span class="main">=</span> map Msg <span class="main">(</span>fst <span class="main">(</span>cs <span class="free">final</span> <span class="skolem">cid</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> snapshot_after_all_prerecording_events<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i'</span><span class="main">.</span> <span class="bound">i'</span> <span class="main">≥</span> <span class="free">i</span> <span class="main">⟶</span> <span class="main">~</span> prerecording_event <span class="free">t</span> <span class="bound">i'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j'</span><span class="main">.</span> <span class="bound">j'</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">⟶</span> <span class="main">~</span> postrecording_event <span class="free">t</span> <span class="bound">j'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> length <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"state_equal_to_snapshot <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">final</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> state_equal_to_snapshot_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ps_equal_to_snapshot <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">final</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms ps_after_all_prerecording_events <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cs_equal_to_snapshot <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">final</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms cs_after_all_prerecording_events <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Obtaining the desired traces›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">all_prerecording_before_postrecording</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">all_prerecording_before_postrecording</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="bound">i</span> <span class="main">⟶</span> <span class="main">~</span> postrecording_event <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">j</span><span class="main">)</span>
                                               <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≥</span> <span class="bound">i</span> <span class="main">⟶</span> <span class="main">~</span> prerecording_event <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">j</span><span class="main">)</span>
                                               <span class="main">∧</span> <span class="bound">i</span> <span class="main">≤</span> length <span class="free"><span class="bound"><span class="entity">t</span></span></span>
                                               <span class="main">∧</span> trace <span class="free">init</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free">final</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">count_violations</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> trace <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">count_violations</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> sum <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> postrecording_event <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">i</span>
                                 <span class="keyword1">then</span> card <span class="main">{</span><span class="bound"><span class="bound">j</span></span> <span class="main">∈</span> <span class="main">{</span><span class="bound">i</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">j</span><span class="main">}</span>
                                 <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>
                        <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> violations_ge_0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> postrecording_event <span class="free">t</span> <span class="free">i</span>
     <span class="keyword1">then</span> card <span class="main">{</span><span class="bound"><span class="bound">j</span></span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="free">t</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="free">t</span> <span class="bound">j</span><span class="main">}</span>
     <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> count_violations_ge_0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"count_violations <span class="free">t</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> violations_0_implies_all_subterms_0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"count_violations <span class="free">t</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">t</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> postrecording_event <span class="free">t</span> <span class="bound">i</span>
                                 <span class="keyword1">then</span> card <span class="main">{</span><span class="bound"><span class="bound">j</span></span> <span class="main">∈</span> <span class="main">{</span><span class="bound">i</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="free">t</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="free">t</span> <span class="bound">j</span><span class="main">}</span>
                                 <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> postrecording_event <span class="free">t</span> <span class="bound">i</span>
                                 <span class="keyword1">then</span> card <span class="main">{</span><span class="bound"><span class="bound">j</span></span> <span class="main">∈</span> <span class="main">{</span><span class="bound">i</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="free">t</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="free">t</span> <span class="bound">j</span><span class="main">}</span>
                                 <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>
        <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">t</span><span class="main">}</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> count_violations_def assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">t</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> postrecording_event <span class="free">t</span> <span class="bound">i</span>
                                 <span class="keyword1">then</span> card <span class="main">{</span><span class="bound"><span class="bound">j</span></span> <span class="main">∈</span> <span class="main">{</span><span class="bound">i</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="free">t</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="free">t</span> <span class="bound">j</span><span class="main">}</span>
                                 <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> exists_postrecording_violation_if_count_greater_0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"count_violations <span class="free">t</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> postrecording_event <span class="free">t</span> <span class="bound">i</span> <span class="main">∧</span> card <span class="main">{</span><span class="bound"><span class="bound">j</span></span> <span class="main">∈</span> <span class="main">{</span><span class="bound">i</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="free">t</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="free">t</span> <span class="bound">j</span><span class="main">}</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="var">?P</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">~</span> postrecording_event <span class="free">t</span> <span class="bound">i</span> <span class="main">∨</span> card <span class="main">{</span><span class="bound"><span class="bound">j</span></span> <span class="main">∈</span> <span class="main">{</span><span class="bound">i</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="free">t</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="free">t</span> <span class="bound">j</span><span class="main">}</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count_violations <span class="free">t</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> count_violations_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> postrecording_event <span class="free">t</span> <span class="bound">i</span>
             <span class="keyword1">then</span> card <span class="main">{</span><span class="bound"><span class="bound">j</span></span> <span class="main">∈</span> <span class="main">{</span><span class="bound">i</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="free">t</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="free">t</span> <span class="bound">j</span><span class="main">}</span>
             <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">¬</span> postrecording_event <span class="free">t</span> <span class="bound">i</span> <span class="main">∨</span> card <span class="main">{</span><span class="bound"><span class="bound">j</span></span> <span class="main">∈</span> <span class="main">{</span><span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">..&lt;</span>length <span class="free">t</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="free">t</span> <span class="bound">j</span><span class="main">}</span> <span class="main">=</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> postrecording_event <span class="free">t</span> <span class="bound">i</span>
                          <span class="keyword1">then</span> card <span class="main">{</span><span class="bound"><span class="bound">j</span></span> <span class="main">∈</span> <span class="main">{</span><span class="bound">i</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="free">t</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="free">t</span> <span class="bound">j</span><span class="main">}</span>
                          <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">t</span><span class="main">}</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> exists_prerecording_violation_when_card_greater_0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">j</span></span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="free">t</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="free">t</span> <span class="bound">j</span><span class="main">}</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="free">t</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="free">t</span> <span class="bound">j</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Collect_empty_eq assms card_0_eq empty_subsetI finite_atLeastLessThan not_gr_zero subset_card_intvl_is_intvl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> card_greater_0_if_post_after_pre<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"postrecording_event <span class="free">t</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"prerecording_event <span class="free">t</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">j</span></span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="free">t</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="free">t</span> <span class="bound">j</span><span class="main">}</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prerecording_event assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">j</span></span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="free">t</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="free">t</span> <span class="bound">j</span><span class="main">}</span> <span class="main">≠</span> empty"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Suc_eq_plus1 <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">t</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> less_imp_triv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> exists_neighboring_violation_pair<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"count_violations <span class="free">t</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">j</span> <span class="main">∧</span> postrecording_event <span class="free">t</span> <span class="bound">i</span> <span class="main">∧</span> prerecording_event <span class="free">t</span> <span class="bound">j</span>
         <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="bound">j</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">~</span> regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?I</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> postrecording_event <span class="free">t</span> <span class="bound">i</span> <span class="main">∧</span> card <span class="main">{</span><span class="bound"><span class="bound">j</span></span> <span class="main">∈</span> <span class="main">{</span><span class="bound">i</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="free">t</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="free">t</span> <span class="bound">j</span><span class="main">}</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> nonempty_I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?I</span> <span class="main">≠</span> empty"</span></span> <span class="keyword1"><span class="command">using</span></span> assms exists_postrecording_violation_if_count_greater_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> fin_I<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="var">?I</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> finite <span class="var">?I</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&gt;</span> length <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"postrecording_event <span class="free">t</span> <span class="skolem">i</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> postrecording_event<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> postrecording_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Max <span class="var">?I</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> no_greater_postrec_violation<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&gt;</span> <span class="var">?i</span> <span class="main">⟶</span> <span class="main">~</span> <span class="main">(</span>postrecording_event <span class="free">t</span> <span class="bound">i</span> <span class="main">∧</span> card <span class="main">{</span><span class="bound"><span class="bound">j</span></span> <span class="main">∈</span> <span class="main">{</span><span class="bound">i</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="free">t</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="free">t</span> <span class="bound">j</span><span class="main">}</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Max_gr_iff fin_I <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> post_i<span class="main">:</span> <span class="quoted"><span class="quoted">"postrecording_event <span class="free">t</span> <span class="var">?i</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Max_in fin_I nonempty_I <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">j</span></span> <span class="main">∈</span> <span class="main">{</span><span class="var">?i</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="free">t</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="free">t</span> <span class="bound">j</span><span class="main">}</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?i</span> <span class="main">∈</span> <span class="var">?I</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Max_in fin_I nonempty_I <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?J</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">j</span></span> <span class="main">∈</span> <span class="main">{</span><span class="var">?i</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="free">t</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="free">t</span> <span class="bound">j</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> nonempty_J<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?J</span> <span class="main">≠</span> empty"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹card <span class="main">{</span><span class="bound"><span class="bound">j</span></span> <span class="main">∈</span> <span class="main">{</span><span class="var">?i</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="free">t</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="free">t</span> <span class="bound">j</span><span class="main">}</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> exists_prerecording_violation_when_card_greater_0
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> fin_J<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="var">?J</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?j</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Min <span class="var">?J</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> pre_j<span class="main">:</span> <span class="quoted"><span class="quoted">"prerecording_event <span class="free">t</span> <span class="var">?j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Min_in fin_J nonempty_J <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> no_smaller_prerec_violation<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="var">?i</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="free">t</span><span class="main">}</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="var">?j</span> <span class="main">⟶</span> <span class="main">~</span> prerecording_event <span class="free">t</span> <span class="bound">j</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Min_less_iff fin_J <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> j_less_len_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?j</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pre_j prerecording_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="var">?i</span> <span class="main">&lt;</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="var">?j</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">~</span> regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?i</span> <span class="main">&lt;</span> <span class="skolem">k</span> <span class="main">∧</span> <span class="skolem">k</span> <span class="main">&lt;</span> <span class="var">?j</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted">"0_le_k"</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> k_less_len_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j_less_len_t asm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> reg_event<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="main">~</span> regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>S <span class="free">t</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span>occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> post_k<span class="main">:</span> <span class="quoted"><span class="quoted">"postrecording_event <span class="free">t</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reg_event k_less_len_t postrecording_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">j</span></span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="free">t</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="free">t</span> <span class="bound">j</span><span class="main">}</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> post_k pre_j card_greater_0_if_post_after_pre asm pre_j <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> no_greater_postrec_violation asm <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> pre_k<span class="main">:</span> <span class="quoted"><span class="quoted">"prerecording_event <span class="free">t</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reg_event k_less_len_t prerecording_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="main">{</span><span class="var">?i</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="free">t</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> asm k_less_len_t <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> no_smaller_prerec_violation asm <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?i</span> <span class="main">&lt;</span> <span class="var">?j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nonempty_J <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> pre_j post_i j_less_len_t <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> same_cardinality_post_swap_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"prerecording_event <span class="free">t</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"postrecording_event <span class="free">t</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"count_violations <span class="free">t</span> <span class="main">=</span> Suc <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="free">i</span> <span class="main">&lt;</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">~</span> regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="free">t</span> <span class="bound">k</span><span class="main">}</span>
   <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="main">(</span>swap_events <span class="free">i</span> <span class="free">j</span> <span class="free">t</span><span class="main">)</span> <span class="bound">k</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"swap_events <span class="free">i</span> <span class="free">j</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> same_begin<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="free">i</span> <span class="free">t</span> <span class="main">=</span> take <span class="free">i</span> <span class="var">?t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> swap_identical_heads assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> same_length<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">t</span> <span class="main">=</span> length <span class="main">(</span>swap_events <span class="free">i</span> <span class="free">j</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> swap_identical_length assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">⟶</span> <span class="free">t</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">=</span> <span class="var">?t</span> <span class="main">!</span> <span class="bound">k</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> nth_take same_begin<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">⟶</span> prerecording_event <span class="free">t</span> <span class="bound">k</span> <span class="main">=</span> prerecording_event <span class="var">?t</span> <span class="bound">k</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">⟶</span> S <span class="free">t</span> <span class="bound">k</span> <span class="main">=</span> S <span class="var">?t</span> <span class="bound">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms swap_events <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> prerecording_event <span class="keyword1"><span class="command">using</span></span> a same_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> same_cardinality_post_swap_2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"prerecording_event <span class="free">t</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"postrecording_event <span class="free">t</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"count_violations <span class="free">t</span> <span class="main">=</span> Suc <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="free">i</span> <span class="main">&lt;</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">~</span> regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="free">t</span> <span class="bound">k</span><span class="main">}</span>
   <span class="main">=</span> card <span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="main">(</span>swap_events <span class="free">i</span> <span class="free">j</span> <span class="free">t</span><span class="main">)</span> <span class="bound">k</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"swap_events <span class="free">i</span> <span class="free">j</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="free">t</span> <span class="bound">k</span><span class="main">}</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">i</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟶</span> <span class="main">~</span> prerecording_event <span class="free">t</span> <span class="bound">k</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
      <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="skolem">k</span> <span class="main">∧</span> <span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> prerecording_event <span class="free">t</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="free">i</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"postrecording_event <span class="free">t</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> computation.postrecording_event computation.prerecording_event computation_axioms<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="skolem">k</span> <span class="main">∧</span> <span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> asm <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> prerecording_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="free">t</span> <span class="bound">k</span><span class="main">}</span> <span class="main">=</span> empty"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="main">{</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="free">t</span> <span class="bound">k</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">j</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">j</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prerecording_event <span class="free">t</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="free">t</span> <span class="bound">k</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">j</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3-4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="var">?t</span> <span class="bound">k</span><span class="main">}</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> swap_ind<span class="main">:</span> <span class="quoted"><span class="quoted">"prerecording_event <span class="var">?t</span> <span class="free">i</span>
          <span class="main">∧</span> postrecording_event <span class="var">?t</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>
          <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&gt;</span> <span class="free">i</span><span class="main">+</span><span class="main">1</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span><span class="main">+</span><span class="main">1</span> <span class="main">⟶</span> <span class="main">~</span> regular_event <span class="main">(</span><span class="var">?t</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms swap_events <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">i</span><span class="main">+</span><span class="main">1</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span><span class="main">+</span><span class="main">1</span> <span class="main">⟶</span> <span class="main">~</span> prerecording_event <span class="var">?t</span> <span class="bound">k</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
      <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">+</span><span class="main">1</span> <span class="main">≤</span> <span class="skolem">k</span> <span class="main">∧</span> <span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">j</span><span class="main">+</span><span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> prerecording_event <span class="var">?t</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="free">i</span><span class="main">+</span><span class="main">1</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"postrecording_event <span class="var">?t</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> swap_ind <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> computation.postrecording_event computation.prerecording_event computation_axioms<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">+</span><span class="main">1</span> <span class="main">&lt;</span> <span class="skolem">k</span> <span class="main">∧</span> <span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">j</span><span class="main">+</span><span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> asm <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> regular_event <span class="main">(</span><span class="var">?t</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> asm assms swap_ind <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> prerecording_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="var">?t</span> <span class="bound">k</span><span class="main">}</span> <span class="main">=</span> empty"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="var">?t</span> <span class="bound">k</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prerecording_event <span class="var">?t</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> swap_ind <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="var">?t</span> <span class="bound">k</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3-4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> same_cardinality_post_swap_3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"prerecording_event <span class="free">t</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"postrecording_event <span class="free">t</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"count_violations <span class="free">t</span> <span class="main">=</span> Suc <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="free">i</span> <span class="main">&lt;</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">~</span> regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="main">{</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="free">t</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="free">t</span> <span class="bound">k</span><span class="main">}</span>
   <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="main">{</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="main">(</span>swap_events <span class="free">i</span> <span class="free">j</span> <span class="free">t</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="main">(</span>swap_events <span class="free">i</span> <span class="free">j</span> <span class="free">t</span><span class="main">)</span> <span class="bound">k</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"swap_events <span class="free">i</span> <span class="free">j</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> drop <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="var">?t</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> swap_identical_tails <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> same_length<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">t</span> <span class="main">=</span> length <span class="var">?t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> swap_identical_length assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">j</span><span class="main">+</span><span class="main">1</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> length <span class="free">t</span> <span class="main">⟶</span> <span class="var">?t</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">=</span> <span class="free">t</span> <span class="main">!</span> <span class="bound">k</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
   <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span><span class="main">+</span><span class="main">1</span> <span class="main">≤</span> <span class="skolem">k</span> <span class="main">∧</span> <span class="skolem">k</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> drop <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>swap_events <span class="free">i</span> <span class="free">j</span> <span class="free">t</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">k</span><span class="main">-</span><span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Suc_eq_plus1 Suc_leI assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> le_add_diff_inverse nth_drop same_length<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> drop <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">k</span><span class="main">-</span><span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> <span class="skolem">k</span> <span class="main">∧</span> <span class="skolem">k</span> <span class="main">&lt;</span> length <span class="free">t</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="var">?t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">k</span><span class="main">-</span><span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> drop <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">k</span><span class="main">-</span><span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms swap_identical_tails <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> <span class="free">t</span> <span class="main">!</span> <span class="skolem">k</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?t</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> drop <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="var">?t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> drop <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">t</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">j</span><span class="main">+</span><span class="main">1</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> length <span class="free">t</span> <span class="main">⟶</span> prerecording_event <span class="free">t</span> <span class="bound">k</span> <span class="main">=</span> prerecording_event <span class="var">?t</span> <span class="bound">k</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≥</span> <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">⟶</span> S <span class="free">t</span> <span class="bound">k</span> <span class="main">=</span> S <span class="var">?t</span> <span class="bound">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms swap_events <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> prerecording_event <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="main">{</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="free">t</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="free">t</span> <span class="bound">k</span><span class="main">}</span>
           <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="main">{</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="free">t</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="var">?t</span> <span class="bound">k</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> same_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> card_ip1_to_j_is_1_in_normal_events<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"prerecording_event <span class="free">t</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"postrecording_event <span class="free">t</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"count_violations <span class="free">t</span> <span class="main">=</span> Suc <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="free">i</span> <span class="main">&lt;</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">~</span> regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"count_violations <span class="free">t</span> <span class="main">=</span> Suc <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="free">t</span> <span class="bound">k</span><span class="main">}</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟶</span> <span class="main">~</span> prerecording_event <span class="free">t</span> <span class="bound">k</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="skolem">k</span> <span class="main">∧</span> <span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> prerecording_event <span class="free">t</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> asm assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> prerecording_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="free">t</span> <span class="bound">k</span><span class="main">}</span> <span class="main">=</span> empty"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="main">{</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="free">t</span> <span class="bound">k</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">j</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">j</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prerecording_event <span class="free">t</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="free">t</span> <span class="bound">k</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">j</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> card_ip1_to_j_is_0_in_swapped_events<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"prerecording_event <span class="free">t</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"postrecording_event <span class="free">t</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"count_violations <span class="free">t</span> <span class="main">=</span> Suc <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="free">i</span> <span class="main">&lt;</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">~</span> regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"count_violations <span class="free">t</span> <span class="main">=</span> Suc <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="main">(</span>swap_events <span class="free">i</span> <span class="free">j</span> <span class="free">t</span><span class="main">)</span> <span class="bound">k</span><span class="main">}</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"swap_events <span class="free">i</span> <span class="free">j</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> postrec_ip1<span class="main">:</span> <span class="quoted"><span class="quoted">"postrecording_event <span class="var">?t</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms swap_events <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> neigh_shift<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">i</span><span class="main">+</span><span class="main">1</span> <span class="main">&lt;</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span><span class="main">+</span><span class="main">1</span> <span class="main">⟶</span> <span class="main">~</span> regular_event <span class="main">(</span><span class="var">?t</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms swap_events <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">i</span><span class="main">+</span><span class="main">1</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span><span class="main">+</span><span class="main">1</span> <span class="main">⟶</span> <span class="main">~</span> prerecording_event <span class="var">?t</span> <span class="bound">k</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">+</span><span class="main">1</span> <span class="main">≤</span> <span class="skolem">k</span> <span class="main">∧</span> <span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">j</span><span class="main">+</span><span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> prerecording_event <span class="var">?t</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="free">i</span><span class="main">+</span><span class="main">1</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> postrec_ip1 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> computation.postrecording_event computation.prerecording_event computation_axioms<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">+</span><span class="main">1</span> <span class="main">&lt;</span> <span class="skolem">k</span> <span class="main">∧</span> <span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">j</span><span class="main">+</span><span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> asm <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> regular_event <span class="main">(</span><span class="var">?t</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> neigh_shift <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> prerecording_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="var">?t</span> <span class="bound">k</span><span class="main">}</span> <span class="main">=</span> empty"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> count_violations_swap<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"prerecording_event <span class="free">t</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"postrecording_event <span class="free">t</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"count_violations <span class="free">t</span> <span class="main">=</span> Suc <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="free">i</span> <span class="main">&lt;</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">~</span> regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"count_violations <span class="free">t</span> <span class="main">=</span> Suc <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"count_violations <span class="main">(</span>swap_events <span class="free">i</span> <span class="free">j</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"swap_events <span class="free">i</span> <span class="free">j</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> postrecording_event <span class="free">t</span> <span class="bound">i</span> <span class="keyword1">then</span> card <span class="main">{</span><span class="bound"><span class="bound">j</span></span> <span class="main">∈</span> <span class="main">{</span><span class="bound">i</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="free">t</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="free">t</span> <span class="bound">j</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> postrecording_event <span class="var">?t</span> <span class="bound">i</span> <span class="keyword1">then</span> card <span class="main">{</span><span class="bound"><span class="bound">j</span></span> <span class="main">∈</span> <span class="main">{</span><span class="bound">i</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="var">?t</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="var">?t</span> <span class="bound">j</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> same_postrec_prefix<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">⟶</span> postrecording_event <span class="free">t</span> <span class="bound">k</span> <span class="main">=</span> postrecording_event <span class="var">?t</span> <span class="bound">k</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">⟶</span> S <span class="free">t</span> <span class="bound">k</span> <span class="main">=</span> S <span class="var">?t</span> <span class="bound">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms swap_events <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> postrecording_event
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="free">i</span><span class="main">.</span> S <span class="free">t</span> <span class="bound">k</span> <span class="main">=</span> S <span class="main">(</span>swap_events <span class="free">i</span> <span class="free">j</span> <span class="free">t</span><span class="main">)</span> <span class="bound">k</span>"</span></span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">nn</span> <span class="main">::</span> <span class="quoted">nat</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span> <span class="bound">na</span> <span class="bound">es</span> <span class="bound">nb</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="bound">na</span> <span class="main">∨</span> <span class="main">¬</span> <span class="bound">na</span> <span class="main">&lt;</span> length <span class="bound">es</span> <span class="main">∨</span> <span class="main">¬</span> <span class="bound">nb</span> <span class="main">&lt;</span> <span class="bound">n</span> <span class="main">∨</span> swap_events <span class="bound">n</span> <span class="bound">na</span> <span class="bound">es</span> <span class="main">!</span> <span class="bound">nb</span> <span class="main">=</span> <span class="main">(</span><span class="bound">es</span> <span class="main">!</span> <span class="bound">nb</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> event<span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> nth_take swap_identical_heads<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">nn</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">∨</span> <span class="main">¬</span> <span class="skolem">nn</span> <span class="main">&lt;</span> length <span class="free">t</span> <span class="main">∧</span> <span class="main">¬</span> <span class="skolem">nn</span> <span class="main">&lt;</span> length <span class="main">(</span>swap_events <span class="free">i</span> <span class="free">j</span> <span class="free">t</span><span class="main">)</span> <span class="main">∨</span> <span class="main">¬</span> regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">nn</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span> regular_event <span class="main">(</span>swap_events <span class="free">i</span> <span class="free">j</span> <span class="free">t</span> <span class="main">!</span> <span class="skolem">nn</span><span class="main">)</span> <span class="main">∨</span> ps <span class="main">(</span>S <span class="free">t</span> <span class="skolem">nn</span><span class="main">)</span> <span class="main">(</span>occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">nn</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> None <span class="main">∧</span> ps <span class="main">(</span>S <span class="main">(</span>swap_events <span class="free">i</span> <span class="free">j</span> <span class="free">t</span><span class="main">)</span> <span class="skolem">nn</span><span class="main">)</span> <span class="main">(</span>occurs_on <span class="main">(</span>swap_events <span class="free">i</span> <span class="free">j</span> <span class="free">t</span> <span class="main">!</span> <span class="skolem">nn</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> None <span class="main">∨</span> regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">nn</span><span class="main">)</span> <span class="main">∧</span> regular_event <span class="main">(</span>swap_events <span class="free">i</span> <span class="free">j</span> <span class="free">t</span> <span class="main">!</span> <span class="skolem">nn</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">nn</span> <span class="main">&lt;</span> length <span class="free">t</span> <span class="main">∧</span> <span class="skolem">nn</span> <span class="main">&lt;</span> length <span class="main">(</span>swap_events <span class="free">i</span> <span class="free">j</span> <span class="free">t</span><span class="main">)</span> <span class="main">∧</span> ps <span class="main">(</span>S <span class="free">t</span> <span class="skolem">nn</span><span class="main">)</span> <span class="main">(</span>occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">nn</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> None <span class="main">∧</span> ps <span class="main">(</span>S <span class="main">(</span>swap_events <span class="free">i</span> <span class="free">j</span> <span class="free">t</span><span class="main">)</span> <span class="skolem">nn</span><span class="main">)</span> <span class="main">(</span>occurs_on <span class="main">(</span>swap_events <span class="free">i</span> <span class="free">j</span> <span class="free">t</span> <span class="main">!</span> <span class="skolem">nn</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> None"</span></span>
          <span class="keyword1"><span class="command">using</span></span> a1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> swap_identical_length<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="free">i</span><span class="main">.</span> <span class="main">(</span><span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">t</span> <span class="main">∧</span> regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> ps <span class="main">(</span>S <span class="free">t</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span>occurs_on <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> None<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">n</span> <span class="main">&lt;</span> length <span class="main">(</span>swap_events <span class="free">i</span> <span class="free">j</span> <span class="free">t</span><span class="main">)</span> <span class="main">∧</span> regular_event <span class="main">(</span>swap_events <span class="free">i</span> <span class="free">j</span> <span class="free">t</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> ps <span class="main">(</span>S <span class="main">(</span>swap_events <span class="free">i</span> <span class="free">j</span> <span class="free">t</span><span class="main">)</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span>occurs_on <span class="main">(</span>swap_events <span class="free">i</span> <span class="free">j</span> <span class="free">t</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> None<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> same_postrec_suffix<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≥</span> <span class="free">j</span><span class="main">+</span><span class="main">1</span> <span class="main">⟶</span> postrecording_event <span class="free">t</span> <span class="bound">k</span> <span class="main">=</span> postrecording_event <span class="var">?t</span> <span class="bound">k</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> post_equal_states<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≥</span> <span class="free">j</span><span class="main">+</span><span class="main">1</span> <span class="main">⟶</span> S <span class="free">t</span> <span class="bound">k</span> <span class="main">=</span> S <span class="var">?t</span> <span class="bound">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms swap_events <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span><span class="main">+</span><span class="main">1</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"postrecording_event <span class="free">t</span> <span class="skolem">k</span> <span class="main">=</span> postrecording_event <span class="var">?t</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> postrecording_event <span class="free">t</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> postrecording_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> postrecording_event <span class="var">?t</span> <span class="skolem">k</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> postrecording_event swap_identical_length False assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"postrecording_event <span class="free">t</span> <span class="skolem">k</span> <span class="main">=</span> postrecording_event <span class="var">?t</span> <span class="skolem">k</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> post_equal_states
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">≥</span><span class="free">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">.</span> S <span class="free">t</span> <span class="bound">k</span> <span class="main">=</span> S <span class="main">(</span>swap_events <span class="free">i</span> <span class="free">j</span> <span class="free">t</span><span class="main">)</span> <span class="bound">k</span>"</span></span>
          <span class="keyword3"><span class="command">assume</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> f3<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">t</span> <span class="main">=</span> length <span class="main">(</span>swap_events <span class="free">i</span> <span class="free">j</span> <span class="free">t</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> swap_identical_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">have</span></span> f4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">-</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">k</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> <span class="skolem">k</span>›</span></span> le_add_diff_inverse2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> drop <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>swap_events <span class="free">i</span> <span class="free">j</span> <span class="free">t</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> swap_identical_tails <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"swap_events <span class="free">i</span> <span class="free">j</span> <span class="free">t</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> <span class="free">t</span> <span class="main">!</span> <span class="skolem">k</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> f4 f3 a2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> drop_drop hd_drop_conv_nth<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> f3 a1 <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> <span class="skolem">k</span>›</span></span> postrecording_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> sum_decomp_f<span class="main">:</span> <span class="quoted"><span class="quoted">"sum <span class="var">?f</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">t</span><span class="main">}</span> <span class="main">=</span> sum <span class="var">?f</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span> <span class="main">+</span> sum <span class="var">?f</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">}</span> <span class="main">+</span> sum <span class="var">?f</span> <span class="main">{</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="free">t</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> One_nat_def add.right_neutral add_Suc_right assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> discrete le_add2 less_SucI less_or_eq_imp_le sum.atLeastLessThan_concat<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> sum_decomp_f'<span class="main">:</span> <span class="quoted"><span class="quoted">"sum <span class="var">?f'</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">t</span><span class="main">}</span> <span class="main">=</span> sum <span class="var">?f'</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span> <span class="main">+</span> sum <span class="var">?f'</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">}</span> <span class="main">+</span> sum <span class="var">?f'</span> <span class="main">{</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="free">t</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> One_nat_def add.right_neutral add_Suc_right assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> discrete le_add2 less_SucI less_or_eq_imp_le sum.atLeastLessThan_concat<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> prefix_sum<span class="main">:</span> <span class="quoted"><span class="quoted">"sum <span class="var">?f</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span> <span class="main">=</span> sum <span class="var">?f'</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">l</span> <span class="main">∧</span> <span class="bound">l</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">⟶</span> <span class="var">?f</span> <span class="bound">l</span> <span class="main">=</span> <span class="var">?f'</span> <span class="bound">l</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">l</span> <span class="main">∧</span> <span class="skolem">l</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="skolem">l</span> <span class="main">=</span> <span class="var">?f'</span> <span class="skolem">l</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"postrecording_event <span class="free">t</span> <span class="skolem">l</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?G</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">l</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="free">t</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="free">t</span> <span class="bound">k</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?G'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">l</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="free">t</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="var">?t</span> <span class="bound">k</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">l</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="free">t</span> <span class="bound">k</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="free">t</span> <span class="bound">k</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="main">{</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="free">t</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="free">t</span> <span class="bound">k</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">l</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="var">?t</span> <span class="bound">k</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="var">?t</span> <span class="bound">k</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="main">{</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="free">t</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="var">?t</span> <span class="bound">k</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> card_G<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="var">?G</span> <span class="main">=</span> card <span class="var">?A</span> <span class="main">+</span> card <span class="var">?B</span> <span class="main">+</span> card <span class="var">?C</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?G</span> <span class="main">=</span> <span class="var">?A</span> <span class="main">∪</span> <span class="main">(</span><span class="var">?B</span> <span class="main">∪</span> <span class="var">?C</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">&lt;</span> <span class="free">i</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?G</span> <span class="main">=</span> card <span class="main">(</span><span class="var">?A</span> <span class="main">∪</span> <span class="main">(</span><span class="var">?B</span> <span class="main">∪</span> <span class="var">?C</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="var">?A</span> <span class="main">∪</span> <span class="main">(</span><span class="var">?B</span> <span class="main">∪</span> <span class="var">?C</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> card <span class="var">?A</span> <span class="main">+</span> card <span class="main">(</span><span class="var">?B</span> <span class="main">∪</span> <span class="var">?C</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">∩</span> <span class="main">(</span><span class="var">?B</span> <span class="main">∪</span> <span class="var">?C</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">&lt;</span> <span class="free">i</span>›</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_Un_disjoint disjoint_iff_not_equal<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?A</span> <span class="main">+</span> card <span class="main">(</span><span class="var">?B</span> <span class="main">∪</span> <span class="var">?C</span><span class="main">)</span> <span class="main">=</span> card <span class="var">?A</span> <span class="main">+</span> card <span class="var">?B</span> <span class="main">+</span> card <span class="var">?C</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="main">∩</span> <span class="var">?C</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_Un_disjoint disjoint_iff_not_equal<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">have</span></span> card_G'<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="var">?G'</span> <span class="main">=</span> card <span class="var">?A'</span> <span class="main">+</span> card <span class="var">?B'</span> <span class="main">+</span> card <span class="var">?C'</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?G'</span> <span class="main">=</span> <span class="var">?A'</span> <span class="main">∪</span> <span class="main">(</span><span class="var">?B'</span> <span class="main">∪</span> <span class="var">?C'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">&lt;</span> <span class="free">i</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?G'</span> <span class="main">=</span> card <span class="main">(</span><span class="var">?A'</span> <span class="main">∪</span> <span class="main">(</span><span class="var">?B'</span> <span class="main">∪</span> <span class="var">?C'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="var">?A'</span> <span class="main">∪</span> <span class="main">(</span><span class="var">?B'</span> <span class="main">∪</span> <span class="var">?C'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> card <span class="var">?A'</span> <span class="main">+</span> card <span class="main">(</span><span class="var">?B'</span> <span class="main">∪</span> <span class="var">?C'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A'</span> <span class="main">∩</span> <span class="main">(</span><span class="var">?B'</span> <span class="main">∪</span> <span class="var">?C'</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">&lt;</span> <span class="free">i</span>›</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_Un_disjoint disjoint_iff_not_equal<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?A'</span> <span class="main">+</span> card <span class="main">(</span><span class="var">?B'</span> <span class="main">∪</span> <span class="var">?C'</span><span class="main">)</span> <span class="main">=</span> card <span class="var">?A'</span> <span class="main">+</span> card <span class="var">?B'</span> <span class="main">+</span> card <span class="var">?C'</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B'</span> <span class="main">∩</span> <span class="var">?C'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_Un_disjoint disjoint_iff_not_equal<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?G</span> <span class="main">=</span> card <span class="var">?G'</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?A</span> <span class="main">=</span> card <span class="var">?A'</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="free">t</span> <span class="bound">k</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="var">?t</span> <span class="bound">k</span><span class="main">}</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> assms same_cardinality_post_swap_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">=</span> <span class="var">?A'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?B</span> <span class="main">=</span> card <span class="var">?B'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms same_cardinality_post_swap_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?C</span> <span class="main">=</span> card <span class="var">?C'</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?C</span> <span class="main">=</span> <span class="var">?C'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms same_cardinality_post_swap_3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> card_G card_G' <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"postrecording_event <span class="var">?t</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True same_postrec_prefix <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">&lt;</span> <span class="free">i</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="var">?t</span> <span class="main">=</span> length <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> postrecording_event <span class="var">?t</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> same_postrec_prefix <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">&lt;</span> <span class="free">i</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> sum_eq_if_same_subterms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> infix_sum<span class="main">:</span> <span class="quoted"><span class="quoted">"sum <span class="var">?f</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">}</span> <span class="main">=</span> sum <span class="var">?f'</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">}</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> sum_decomp_f<span class="main">:</span> <span class="quoted"><span class="quoted">"sum <span class="var">?f</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">}</span> <span class="main">=</span> sum <span class="var">?f</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">+</span><span class="numeral">2</span><span class="main">}</span> <span class="main">+</span> sum <span class="var">?f</span> <span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="numeral">2</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">}</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Suc_eq_plus1 Suc_leI add_2_eq_Suc' assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> less_Suc_eq linorder_not_le sum.atLeastLessThan_concat<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> sum_decomp_f'<span class="main">:</span> <span class="quoted"><span class="quoted">"sum <span class="var">?f'</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">}</span> <span class="main">=</span> sum <span class="var">?f'</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">+</span><span class="numeral">2</span><span class="main">}</span> <span class="main">+</span> sum <span class="var">?f'</span> <span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="numeral">2</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">}</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Suc_eq_plus1 Suc_mono add.assoc assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> discrete le_add1 one_add_one sum.atLeastLessThan_concat<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="var">?f</span> <span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="numeral">2</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">}</span> <span class="main">=</span> sum <span class="var">?f'</span> <span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="numeral">2</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">.</span> <span class="free">i</span><span class="main">+</span><span class="numeral">2</span> <span class="main">≤</span> <span class="bound">l</span> <span class="main">∧</span> <span class="bound">l</span> <span class="main">&lt;</span> <span class="free">j</span><span class="main">+</span><span class="main">1</span> <span class="main">⟶</span> <span class="var">?f</span> <span class="bound">l</span> <span class="main">=</span> <span class="var">?f'</span> <span class="bound">l</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span>
        <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">+</span><span class="numeral">2</span> <span class="main">≤</span> <span class="skolem">l</span> <span class="main">∧</span> <span class="skolem">l</span> <span class="main">&lt;</span> <span class="free">j</span><span class="main">+</span><span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="skolem">l</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> <span class="free">j</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> postrecording_event <span class="free">t</span> <span class="skolem">l</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> postrecording_event prerecording_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="skolem">l</span> <span class="main">∧</span> <span class="skolem">l</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms asm <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> postrecording_event <span class="free">t</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> postrecording_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f'</span> <span class="skolem">l</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">i</span><span class="main">+</span><span class="main">1</span> <span class="main">&lt;</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span><span class="main">+</span><span class="main">1</span> <span class="main">⟶</span> <span class="main">~</span> regular_event <span class="main">(</span><span class="var">?t</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms swap_events <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> regular_event <span class="main">(</span><span class="var">?t</span> <span class="main">!</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> asm <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> postrecording_event <span class="var">?t</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> postrecording_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="skolem">l</span> <span class="main">=</span> <span class="var">?f'</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> sum_eq_if_same_subterms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="var">?f</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">+</span><span class="numeral">2</span><span class="main">}</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> sum <span class="var">?f'</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">+</span><span class="numeral">2</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> int_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">+</span><span class="numeral">2</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">i</span><span class="main">,</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="var">?f</span> <span class="main">{</span><span class="free">i</span><span class="main">,</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">}</span> <span class="main">=</span> <span class="var">?f</span> <span class="free">i</span> <span class="main">+</span> <span class="var">?f</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="var">?f'</span> <span class="main">{</span><span class="free">i</span><span class="main">,</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">}</span> <span class="main">=</span> <span class="var">?f'</span> <span class="free">i</span> <span class="main">+</span> <span class="var">?f'</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> int_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">=</span> <span class="free">i</span><span class="main">+</span><span class="main">1</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prerecording_event <span class="free">t</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> postrecording_event <span class="free">t</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> postrecording_event <span class="keyword1"><span class="command">using</span></span> prerecording_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> regular_event <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> postrecording_event <span class="free">t</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> postrecording_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f'</span> <span class="free">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prerecording_event <span class="var">?t</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms swap_events <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> postrecording_event <span class="var">?t</span> <span class="free">i</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> postrecording_event <span class="keyword1"><span class="command">using</span></span> prerecording_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="free">i</span> <span class="main">=</span> <span class="var">?f'</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> pi<span class="main">:</span> <span class="quoted"><span class="quoted">"postrecording_event <span class="free">t</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> pip1<span class="main">:</span> <span class="quoted"><span class="quoted">"postrecording_event <span class="var">?t</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms swap_events <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?G</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="free">t</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="free">t</span> <span class="bound">k</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?G'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="numeral">2</span><span class="main">..&lt;</span>length <span class="var">?t</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="var">?t</span> <span class="bound">k</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="free">t</span> <span class="bound">k</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="main">{</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="free">t</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="free">t</span> <span class="bound">k</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">+</span><span class="numeral">2</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="var">?t</span> <span class="bound">k</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="main">{</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="var">?t</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="var">?t</span> <span class="bound">k</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> card_G<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="var">?G</span> <span class="main">=</span> card <span class="var">?A</span> <span class="main">+</span> card <span class="var">?B</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?G</span> <span class="main">=</span> <span class="var">?A</span> <span class="main">∪</span> <span class="var">?B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">∩</span> <span class="var">?B</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_Un_disjoint disjoint_iff_not_equal<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">have</span></span> card_G'<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="var">?G'</span> <span class="main">=</span> card <span class="var">?A'</span> <span class="main">+</span> card <span class="var">?B'</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?G'</span> <span class="main">=</span> <span class="var">?A'</span> <span class="main">∪</span> <span class="var">?B'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A'</span> <span class="main">∩</span> <span class="var">?B'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_Un_disjoint disjoint_iff_not_equal<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?G</span> <span class="main">=</span> card <span class="var">?G'</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?A</span> <span class="main">=</span> card <span class="var">?A'</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?A</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms card_ip1_to_j_is_1_in_normal_events <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?A'</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms card_ip1_to_j_is_0_in_swapped_events <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">algebra</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?B</span> <span class="main">=</span> card <span class="var">?B'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms same_cardinality_post_swap_3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> card_G card_G' <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?G</span> <span class="main">=</span> <span class="var">?f</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pi <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?G'</span> <span class="main">=</span> <span class="var">?f'</span> <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pip1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> sum_decomp_f sum_decomp_f' <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> suffix_sum<span class="main">:</span> <span class="quoted"><span class="quoted">"sum <span class="var">?f</span> <span class="main">{</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="free">t</span><span class="main">}</span> <span class="main">=</span> sum <span class="var">?f'</span> <span class="main">{</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="free">t</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="main">&gt;</span> <span class="free">j</span> <span class="main">⟶</span> <span class="var">?f</span> <span class="bound">l</span> <span class="main">=</span> <span class="var">?f'</span> <span class="bound">l</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">&gt;</span> <span class="free">j</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="skolem">l</span> <span class="main">=</span> <span class="var">?f'</span> <span class="skolem">l</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"postrecording_event <span class="free">t</span> <span class="skolem">l</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?G</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">l</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="free">t</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="free">t</span> <span class="bound">k</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?G'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">l</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="free">t</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="var">?t</span> <span class="bound">k</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="main">{</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="free">t</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="free">t</span> <span class="bound">k</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">k</span></span> <span class="main">∈</span> <span class="main">{</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="free">t</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="var">?t</span> <span class="bound">k</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?G</span> <span class="main">=</span> card <span class="var">?G'</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?C</span> <span class="main">=</span> <span class="var">?C'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms same_cardinality_post_swap_3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?G</span> <span class="main">=</span> <span class="var">?G'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">&gt;</span> <span class="free">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"postrecording_event <span class="var">?t</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True same_postrec_suffix <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">&gt;</span> <span class="free">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="var">?t</span> <span class="main">=</span> length <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> postrecording_event <span class="var">?t</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> same_postrec_suffix <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">&gt;</span> <span class="free">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="free">j</span><span class="main">+</span><span class="main">1</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> length <span class="free">t</span> <span class="main">⟶</span> <span class="var">?f</span> <span class="bound">k</span> <span class="main">=</span> <span class="var">?f'</span> <span class="bound">k</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> discrete <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">t</span> <span class="main">=</span> length <span class="var">?t</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> swap_identical_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>sum_eq_if_same_subterms<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="var">?f</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">t</span><span class="main">}</span> <span class="main">=</span> sum <span class="var">?f'</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">t</span><span class="main">}</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="var">?f</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span> <span class="main">=</span> sum <span class="var">?f'</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prefix_sum <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="var">?f</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">}</span> <span class="main">=</span> sum <span class="var">?f'</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">}</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> infix_sum <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="var">?f</span> <span class="main">{</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="free">t</span><span class="main">}</span> <span class="main">=</span> sum <span class="var">?f'</span> <span class="main">{</span><span class="free">j</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="free">t</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> suffix_sum <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> sum_decomp_f sum_decomp_f' <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="var">?t</span> <span class="main">=</span> length <span class="free">t</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="var">?f</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">t</span><span class="main">}</span> <span class="main">=</span> <span class="free">n</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms count_violations_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="var">?f'</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="var">?t</span><span class="main">}</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> count_violations_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> desired_trace_always_exists<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> perm <span class="bound">t'</span> <span class="free">t</span>
        <span class="main">∧</span> all_prerecording_before_postrecording <span class="bound">t'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"count_violations <span class="free">t</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> prerecording_event <span class="skolem">t</span> <span class="bound">i</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span><span class="main">.</span> <span class="main">~</span> prerecording_event <span class="skolem">t</span> <span class="bound">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≤</span> <span class="main">0</span> <span class="main">⟶</span> <span class="main">~</span> postrecording_event <span class="skolem">t</span> <span class="bound">j</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.prems"</span> init_is_s_t_0 no_initial_process_snapshot postrecording_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟶</span> <span class="main">~</span> prerecording_event <span class="skolem">t</span> <span class="bound">j</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">t</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"0.prems"</span> all_processes_snapshotted_in_final_state length_greater_0_conv no_initial_process_snapshot tr_init trace_and_start_determines_end<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.prems"</span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Is</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> prerecording_event <span class="skolem">t</span> <span class="bound">i</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Is</span> <span class="main">≠</span> empty"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> True<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> fin_Is<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="var">?Is</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> finite <span class="var">?Is</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&gt;</span> length <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"prerecording_event <span class="skolem">t</span> <span class="skolem">i</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prerecording_event<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> prerecording_event <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Max <span class="var">?Is</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> pi<span class="main">:</span> <span class="quoted"><span class="quoted">"prerecording_event <span class="skolem">t</span> <span class="var">?i</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Max_in calculation fin_Is <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?i</span> <span class="main">&lt;</span> length <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="var">?i</span> <span class="main">&lt;</span> length <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> 
        <span class="keyword1"><span class="command">using</span></span> calculation fin_Is computation.prerecording_event computation_axioms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≥</span> <span class="var">?i</span><span class="main">+</span><span class="main">1</span> <span class="main">⟶</span> <span class="main">~</span> prerecording_event <span class="skolem">t</span> <span class="bound">j</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&gt;</span> <span class="var">?i</span> <span class="main">⟶</span> <span class="main">~</span> prerecording_event <span class="skolem">t</span> <span class="bound">j</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Max_less_iff fin_Is <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="var">?i</span><span class="main">+</span><span class="main">1</span> <span class="main">⟶</span> <span class="main">~</span> postrecording_event <span class="skolem">t</span> <span class="bound">j</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≤</span> <span class="var">?i</span> <span class="main">⟶</span> <span class="main">~</span> postrecording_event <span class="skolem">t</span> <span class="bound">j</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ccontr<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> <span class="var">?i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="main">~</span> postrecording_event <span class="skolem">t</span> <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="var">?i</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_diff_inverse_nat dual_order.antisym le_add1 pi postrecording_event prerecording_event<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count_violations <span class="skolem">t</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> postrecording_event <span class="skolem">t</span> <span class="skolem">j</span>
                   <span class="keyword1">then</span> card <span class="main">{</span><span class="bound"><span class="bound">l</span></span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="skolem">t</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="skolem">t</span> <span class="bound">l</span><span class="main">}</span>
                   <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> card <span class="main">{</span><span class="bound"><span class="bound">l</span></span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="skolem">t</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="skolem">t</span> <span class="bound">l</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">~</span> <span class="main">~</span> postrecording_event <span class="skolem">t</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">l</span></span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="skolem">t</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="skolem">t</span> <span class="bound">l</span><span class="main">}</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> <span class="var">?i</span> <span class="main">∧</span> <span class="var">?i</span> <span class="main">&lt;</span> length <span class="skolem">t</span>"</span></span> 
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Max <span class="main">{</span><span class="bound">i</span><span class="main">.</span> prerecording_event <span class="skolem">t</span> <span class="bound">i</span><span class="main">}</span> <span class="main">&lt;</span> length <span class="skolem">t</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> Max <span class="main">{</span><span class="bound">i</span><span class="main">.</span> prerecording_event <span class="skolem">t</span> <span class="bound">i</span><span class="main">}</span>›</span></span> discrete <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prerecording_event <span class="skolem">t</span> <span class="var">?i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pi <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">l</span></span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="skolem">t</span><span class="main">}</span><span class="main">.</span> prerecording_event <span class="skolem">t</span> <span class="bound">l</span><span class="main">}</span> <span class="main">≠</span> empty"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> violations_0_implies_all_subterms_0 <span class="quoted"><span class="quoted">‹Max <span class="main">{</span><span class="bound">i</span><span class="main">.</span> prerecording_event <span class="skolem">t</span> <span class="bound">i</span><span class="main">}</span> <span class="main">&lt;</span> length <span class="skolem">t</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> Max <span class="main">{</span><span class="bound">i</span><span class="main">.</span> prerecording_event <span class="skolem">t</span> <span class="bound">i</span><span class="main">}</span>›</span></span> atLeastLessThan_iff less_trans linorder_not_le neq0_conv<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?i</span><span class="main">+</span><span class="main">1</span> <span class="main">≤</span> length <span class="skolem">t</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> calculation<span class="main">(</span>2<span class="main">)</span> discrete <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> ind<span class="main">:</span> <span class="quoted"><span class="quoted">"postrecording_event <span class="skolem">t</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"prerecording_event <span class="skolem">t</span> <span class="skolem">j</span>"</span></span>
                             <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">&lt;</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">~</span> regular_event <span class="main">(</span><span class="skolem">t</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
                             <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> exists_neighboring_violation_pair Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="main">(</span>swap_events <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">t</span><span class="main">)</span> <span class="free">final</span>
          <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≥</span> <span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span> <span class="main">⟶</span> S <span class="main">(</span>swap_events <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">t</span><span class="main">)</span> <span class="bound">k</span> <span class="main">=</span> S <span class="skolem">t</span> <span class="bound">k</span><span class="main">)</span>
          <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≤</span> <span class="skolem">i</span> <span class="main">⟶</span> S <span class="main">(</span>swap_events <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">t</span><span class="main">)</span> <span class="bound">k</span> <span class="main">=</span> S <span class="skolem">t</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc swap_events <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"perm <span class="main">(</span>swap_events <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">t</span><span class="main">)</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> swap_events_perm ind <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count_violations <span class="main">(</span>swap_events <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> count_violations_swap Suc ind <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc.hyps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> snapshot_algorithm_is_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t'</span> <span class="bound">i</span><span class="main">.</span> trace <span class="free">init</span> <span class="bound">t'</span> <span class="free">final</span> <span class="main">∧</span> perm <span class="bound">t'</span> <span class="free">t</span>
          <span class="main">∧</span> state_equal_to_snapshot <span class="main">(</span>S <span class="bound">t'</span> <span class="bound">i</span><span class="main">)</span> <span class="free">final</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">≤</span> length <span class="bound">t'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"perm <span class="skolem">t'</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
                  <span class="quoted"><span class="quoted">"all_prerecording_before_postrecording <span class="skolem">t'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms desired_trace_always_exists <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> snapshot_after_all_prerecording_events
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Stable property detection›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Finally, we show that the computed snapshot is indeed
suitable for stable property detection, as claimed in~\cite{chandy}.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">stable</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">stable</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound">c</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">c</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span> <span class="bound">c'</span><span class="main">.</span> trace <span class="bound">c</span> <span class="bound">t</span> <span class="bound">c'</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">c'</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> has_snapshot_stable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"stable <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> has_snapshotted <span class="bound">c</span> <span class="free">p</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> snapshot_stable stable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">some_snapshot_state</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">some_snapshot_state</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span>
     <span class="keyword1">SOME</span> <span class="main">(</span><span class="bound">t'</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">.</span> trace <span class="free">init</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free">final</span>
                 <span class="main">∧</span> trace <span class="free">init</span> <span class="bound">t'</span> <span class="free">final</span> <span class="main">∧</span> perm <span class="bound">t'</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>
                 <span class="main">∧</span> state_equal_to_snapshot <span class="main">(</span>S <span class="bound">t'</span> <span class="bound">i</span><span class="main">)</span> <span class="free">final</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> split_S<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="main">(</span>S <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>drop <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="free">final</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> take <span class="free">i</span> <span class="free">t</span> <span class="main">@</span> drop <span class="free">i</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> split_trace assms exists_trace_for_any_i
              trace_and_start_determines_end<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> Stable_Property_Detection<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"stable <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">t'</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> some_snapshot_state <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">(</span>S <span class="free">t'</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="free">final</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t'</span> <span class="bound">i</span><span class="main">.</span> trace <span class="free">init</span> <span class="free">t</span> <span class="free">final</span>
             <span class="main">∧</span> trace <span class="free">init</span> <span class="bound">t'</span> <span class="free">final</span> <span class="main">∧</span> perm <span class="bound">t'</span> <span class="free">t</span>
             <span class="main">∧</span> state_equal_to_snapshot <span class="main">(</span>S <span class="bound">t'</span> <span class="bound">i</span><span class="main">)</span> <span class="free">final</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> snapshot_algorithm_is_correct assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="free">t'</span> <span class="free">final</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">unfolding</span></span> some_snapshot_state_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> case_prodD case_prodI someI_ex<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms stable_def split_S <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* locale computation *)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* theory Snapshot *)</span>
</pre>
</div><div id="Co_Snapshot">
<div class="head">
<h1>Theory Co_Snapshot</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Co_Snapshot
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="Snapshot.html">Snapshot</a>
    <a href="../Ordered_Resolution_Prover/Lazy_List_Chain.html">Ordered_Resolution_Prover.Lazy_List_Chain</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Extension to infinite traces›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The computation locale assumes that there already exists a known
final configuration $c'$ to the given initial $c$ and trace $t$. However,
we can show that the snapshot algorithm must terminate correctly even if
the underlying computation itself does not terminate. We relax
the trace relation to allow for a potentially infinite number of ``intermediate'' events, and
show that the algorithm's correctness still holds when imposing the same constraints
as in the computation locale.

We use a preexisting theory of lazy list chains by Schlichtkrull, Blanchette,
Traytel and Waldmann~\cite{Ordered_Resolution_Prover-AFP} to construct infinite traces.›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">ltake</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ltake</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ltake</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span> LNil <span class="main">⇒</span> <span class="main">[]</span> <span class="main">|</span> LCons <span class="bound">x</span> <span class="bound">t'</span> <span class="main">⇒</span> <span class="bound">x</span> <span class="main">#</span> <span class="free">ltake</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">t'</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">ldrop</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ldrop</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ldrop</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span> LNil <span class="main">⇒</span> LNil <span class="main">|</span> LCons <span class="bound">x</span> <span class="bound">t'</span> <span class="main">⇒</span> <span class="free">ldrop</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">t'</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ltake_LNil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ltake <span class="free">i</span> LNil <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ltake_LCons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">⟹</span> ltake <span class="free">i</span> <span class="main">(</span>LCons <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span> <span class="main">#</span> ltake <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> take_ltake<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> take <span class="free">i</span> <span class="main">(</span>ltake <span class="free">j</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> ltake <span class="free">i</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">j</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_Suc_eq take_Cons' ltake_LCons <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> llist.splits if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nth_ltake <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> min <span class="free">n</span> <span class="main">(</span>llength <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span>ltake <span class="free">n</span> <span class="free">xs</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> lnth <span class="free">xs</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_Cons' gr0_conv_Suc eSuc_enat<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> llist.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> length_ltake<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>ltake <span class="free">i</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> llength <span class="free">xs</span> <span class="keyword1">of</span> <span class="main">∞</span> <span class="main">⇒</span> <span class="free">i</span> <span class="main">|</span> enat <span class="bound">m</span> <span class="main">⇒</span> min <span class="free">i</span> <span class="bound">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zero_enat_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> eSuc_enat <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> llist.splits enat.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ltake_prepend<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ltake <span class="free">i</span> <span class="main">(</span>prepend <span class="free">xs</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">i</span> <span class="main">≤</span> length <span class="free">xs</span> <span class="keyword1">then</span> take <span class="free">i</span> <span class="free">xs</span> <span class="keyword1">else</span> <span class="free">xs</span> <span class="main">@</span> ltake <span class="main">(</span><span class="free">i</span> <span class="main">-</span> length <span class="free">xs</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prepend_ltake_ldrop_id<span class="main">:</span> <span class="quoted"><span class="quoted">"prepend <span class="main">(</span>ltake <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>ldrop <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> llist.splits<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> distributed_system
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">coinductive</span></span> <span class="entity">cotrace</span> <span class="keyword2"><span class="keyword">where</span></span>
    cotr_init<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cotrace</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> LNil"</span></span>
  <span class="main">|</span> cotr_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">ev</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">;</span> <span class="free">cotrace</span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">cotrace</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>LCons <span class="free"><span class="bound"><span class="entity">ev</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cotrace_trace<span class="main">:</span> <span class="quoted"><span class="quoted">"cotrace <span class="free">c</span> <span class="free">t</span> <span class="main">⟹</span> <span class="main">∃!</span><span class="bound">c'</span><span class="main">.</span> trace <span class="free">c</span> <span class="main">(</span>ltake <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="bound">c'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>LCons <span class="skolem">ev</span> <span class="skolem">t'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Suc<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">⊢</span> <span class="skolem">ev</span> <span class="main">↦</span> <span class="skolem">c'</span>"</span></span> <span class="quoted"><span class="quoted">"cotrace <span class="skolem">c'</span> <span class="skolem">t'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> cotrace.cases<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Suc<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹cotrace <span class="skolem">c'</span> <span class="skolem">t'</span>›</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> LCons <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> trace.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> trace.cases trace_and_start_determines_end<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trace.intros <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> trace.cases<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zero_enat_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trace.intros <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> trace.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> cotrace_trace'<span class="main">:</span> <span class="quoted"><span class="quoted">"cotrace <span class="free">c</span> <span class="free">t</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">c'</span><span class="main">.</span> trace <span class="free">c</span> <span class="main">(</span>ltake <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="bound">c'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cotrace_trace<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cos</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">cos</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> s <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>ltake <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cotrace_trace_cos<span class="main">:</span> <span class="quoted"><span class="quoted">"cotrace <span class="free">c</span> <span class="free">t</span> <span class="main">⟹</span> trace <span class="free">c</span> <span class="main">(</span>ltake <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>cos <span class="free">c</span> <span class="free">t</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> cos_def s_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> take_ltake<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cotrace_trace<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> theI'<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> s_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"s <span class="free">c</span> <span class="free">t</span> <span class="main">0</span> <span class="main">=</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> s_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> the_equality<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"trace <span class="free">c</span> <span class="main">[]</span>"</span></span><span class="main"><span class="main">]</span></span> trace.intros <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> trace.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> s_chop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> length <span class="free">t</span> <span class="main">⟹</span> s <span class="free">c</span> <span class="free">t</span> <span class="free">i</span> <span class="main">=</span> s <span class="free">c</span> <span class="main">(</span>take <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> s_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> cotrace_prepend<span class="main">:</span> <span class="quoted"><span class="quoted">"trace <span class="free">c</span> <span class="free">t</span> <span class="free">c'</span> <span class="main">⟹</span> cotrace <span class="free">c'</span> <span class="free">u</span> <span class="main">⟹</span> cotrace <span class="free">c</span> <span class="main">(</span>prepend <span class="free">t</span> <span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">c'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trace.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> cotrace.intros<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> s_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c''</span><span class="main">.</span> trace <span class="free">c'</span> <span class="free">xs</span> <span class="bound">c''</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">⊢</span> <span class="free">ev</span> <span class="main">↦</span> <span class="free">c'</span> <span class="main">⟹</span> s <span class="free">c</span> <span class="main">(</span><span class="free">ev</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="main">=</span> s <span class="free">c'</span> <span class="free">xs</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> exists_trace_for_any_i take_Suc_Cons tr_step trace_and_start_determines_end<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> cotrace_ldrop<span class="main">:</span> <span class="quoted"><span class="quoted">"cotrace <span class="free">c</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≤</span> llength <span class="free">t</span> <span class="main">⟹</span> cotrace <span class="main">(</span>cos <span class="free">c</span> <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>ldrop <span class="free">i</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>LCons <span class="skolem">ev</span> <span class="skolem">t'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Suc<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">⊢</span> <span class="skolem">ev</span> <span class="main">↦</span> <span class="skolem">c'</span>"</span></span> <span class="quoted"><span class="quoted">"cotrace <span class="skolem">c'</span> <span class="skolem">t'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> cotrace.cases<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Suc<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹cotrace <span class="skolem">c'</span> <span class="skolem">t'</span>›</span></span><span class="main">]</span> Suc<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> LCons cos_def eSuc_enat<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> s_chop<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> s_Cons<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cotrace_trace'<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> cotrace.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zero_enat_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> cos_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> cotrace.intros<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> cocomputation <span class="main">=</span> distributed_system <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> configuration"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    finite_channels<span class="main">:</span>
      <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∃</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="free">channel</span> <span class="bound">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    strongly_connected_raw<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span> <span class="main">≠</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟶</span>
         <span class="main">(</span>tranclp <span class="main">(</span><span class="main">λ</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="free">channel</span> <span class="bound">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">p</span> <span class="bound">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>

    at_least_two_processes<span class="main">:</span>
      <span class="quoted"><span class="quoted">"card <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    finite_processes<span class="main">:</span>
      <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>

    no_initial_Marker<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="free">channel</span> <span class="bound">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>
      <span class="main">⟶</span> Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="free">init</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    no_msgs_if_no_channel<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">channel</span> <span class="bound">i</span> <span class="main">=</span> None <span class="main">⟶</span> msgs <span class="free">init</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    no_initial_process_snapshot<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="main">¬</span> has_snapshotted <span class="free">init</span> <span class="bound">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    no_initial_channel_snapshot<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> channel_snapshot <span class="free">init</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> NotStarted<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>

    valid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t</span><span class="main">.</span> cotrace <span class="free">init</span> <span class="bound">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    l1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span> <span class="bound">i</span> <span class="bound">cid</span><span class="main">.</span> cotrace <span class="free">init</span> <span class="bound">t</span>
                 <span class="main">∧</span> Marker <span class="main">∈</span> set <span class="main">(</span>msgs <span class="main">(</span>cos <span class="free">init</span> <span class="bound">t</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">cid</span><span class="main">)</span>
      <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span> <span class="main">≤</span> llength <span class="bound">t</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≥</span> <span class="bound">i</span> <span class="main">∧</span> Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>cos <span class="free">init</span> <span class="bound">t</span> <span class="bound">j</span><span class="main">)</span> <span class="bound">cid</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    l2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span> <span class="bound">p</span><span class="main">.</span> cotrace <span class="free">init</span> <span class="bound">t</span>
      <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">i</span></span> <span class="main">≤</span> llength <span class="bound">t</span><span class="main">.</span> has_snapshotted <span class="main">(</span>cos <span class="free">init</span> <span class="bound">t</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">coS</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">coS</span> <span class="main">≡</span> cos <span class="free">init</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">some_snapshot</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">i</span><span class="main">.</span> has_snapshotted <span class="main">(</span>coS <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">≤</span> llength <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> has_snapshotted<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"cotrace <span class="free">init</span> <span class="free">t</span> <span class="main">⟹</span> has_snapshotted <span class="main">(</span>coS <span class="free">t</span> <span class="main">(</span>some_snapshot <span class="free">t</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="free">p</span> <span class="main">∧</span> some_snapshot <span class="free">t</span> <span class="free">p</span> <span class="main">≤</span> llength <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> some_snapshot_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> someI_ex<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> l2<span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> cotrace_cos<span class="main">:</span> <span class="quoted"><span class="quoted">"cotrace <span class="free">init</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">&lt;</span> llength <span class="free">t</span> <span class="main">⟹</span> 
  <span class="main">(</span>coS <span class="free">t</span> <span class="free">j</span><span class="main">)</span> <span class="main">⊢</span> lnth <span class="free">t</span> <span class="free">j</span> <span class="main">↦</span> <span class="main">(</span>coS <span class="free">t</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> cotrace_trace_cos<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="free"><span class="free">j</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> step_Suc<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">j</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> enat.splits llist.splits<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> s_chop<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">#</span> ltake <span class="free">j</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> cos_def nth_Cons' ltake_LCons lnth_LCons'
    take_Cons' take_ltake
    <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> llist.splits enat.splits if_splits <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> order.strict_trans2<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> nth_ltake<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> order.strict_trans2<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> s_chop<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">j</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">_</span></span> <span class="main"><span class="main">#</span></span> ltake <span class="free"><span class="free">j</span></span> <span class="main"><span class="main">_</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_Cons' take_ltake <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> enat.splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> snapshot_stable<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cotrace <span class="free">init</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> has_snapshotted <span class="main">(</span>coS <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">p</span> <span class="main">⟹</span> has_snapshotted <span class="main">(</span>coS <span class="free">t</span> <span class="free">j</span><span class="main">)</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> cotrace_trace_cos<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">j</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> cos_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> exists_trace_for_any_i_j order_refl s_def snapshot_stable take_ltake<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> no_markers_if_all_snapshotted<span class="main">:</span>
  <span class="quoted"><span class="quoted">"cotrace <span class="free">init</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">p</span><span class="main">.</span> has_snapshotted <span class="main">(</span>coS <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="bound">p</span> <span class="main">⟹</span>
      Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>coS <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">c</span><span class="main">)</span> <span class="main">⟹</span> Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>coS <span class="free">t</span> <span class="free">j</span><span class="main">)</span> <span class="free">c</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> cotrace_trace_cos<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">j</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> cos_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> exists_trace_for_any_i_j no_markers_if_all_snapshotted order_refl s_def take_ltake<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> cotrace_all_have_snapshotted<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cotrace <span class="free">init</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">i</span></span> <span class="main">≤</span> llength <span class="free">t</span><span class="main">.</span> <span class="main">∀</span><span class="bound">p</span><span class="main">.</span> has_snapshotted <span class="main">(</span>coS <span class="free">t</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span>range <span class="main">(</span>some_snapshot <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> has_snapshotted<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> snapshot_stable<span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"some_snapshot <span class="free">t</span> <span class="main">_</span>"</span></span> <span class="var"><span class="quoted"><span class="var">?i</span></span></span> <span class="main">_</span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?i</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> finite_processes<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"llength <span class="free">t</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Max_le_iff<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> finite_processes<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> no_messages_if_no_channel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cotrace <span class="free">init</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">channel</span> <span class="free">cid</span> <span class="main">=</span> None <span class="main">⟹</span> msgs <span class="main">(</span>coS <span class="free">t</span> <span class="free">i</span><span class="main">)</span> <span class="free">cid</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> no_messages_introduced_if_no_channel<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> cotrace_trace_cos<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="main">]</span></span> no_msgs_if_no_channel<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">cid</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cos_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> cotrace_all_have_snapshotted_and_no_markers<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cotrace <span class="free">init</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">i</span></span> <span class="main">≤</span> llength <span class="free">t</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> has_snapshotted <span class="main">(</span>coS <span class="free">t</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">∧</span> 
                         <span class="main">(</span><span class="main">∀</span><span class="bound">c</span><span class="main">.</span> Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>coS <span class="free">t</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> cotrace_all_have_snapshotted<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span>
    j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> llength <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> has_snapshotted <span class="main">(</span>coS <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="bound">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> j<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"has_snapshotted <span class="main">(</span>coS <span class="free">t</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≥</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span> <span class="skolem">p</span>
      <span class="keyword1"><span class="command">using</span></span> snapshot_stable<span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">=</span> <span class="main">{</span><span class="bound">c</span><span class="main">.</span> Marker <span class="main">∈</span> set <span class="main">(</span>msgs <span class="main">(</span>coS <span class="free">t</span> <span class="skolem">j</span><span class="main">)</span> <span class="bound">c</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> no_messages_if_no_channel<span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> C_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ finite_channels<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">pick</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pick</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="keyword1">SOME</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≤</span> llength <span class="free">t</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≥</span> <span class="skolem">j</span> <span class="main">∧</span> Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>coS <span class="free">t</span> <span class="bound">k</span><span class="main">)</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> <span class="skolem">C</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">k</span></span> <span class="main">≤</span> llength <span class="free">t</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≥</span> <span class="skolem">j</span> <span class="main">∧</span> Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>coS <span class="free">t</span> <span class="bound">k</span><span class="main">)</span> <span class="skolem">c</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> l1<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="skolem">j</span></span> <span class="quoted"><span class="skolem">c</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">unfolding</span></span> C_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pick</span> <span class="skolem">c</span> <span class="main">≤</span> llength <span class="free">t</span> <span class="main">∧</span> <span class="skolem">pick</span> <span class="skolem">c</span> <span class="main">≥</span> <span class="skolem">j</span> <span class="main">∧</span> Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>coS <span class="free">t</span> <span class="main">(</span><span class="skolem">pick</span> <span class="skolem">c</span><span class="main">)</span><span class="main">)</span> <span class="skolem">c</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> pick_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> someI_ex<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> pick <span class="main">=</span> conjunct1<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> conjunct1<span class="main">[</span><span class="operator">OF</span> conjunct2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> this<span class="main"><span class="main">]</span></span><span class="main">]</span> conjunct2<span class="main">[</span><span class="operator">OF</span> conjunct2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> this<span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> j <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> C_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> Max <span class="main">(</span><span class="skolem">pick</span> <span class="main">`</span> <span class="skolem">C</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">C</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">∈</span> <span class="skolem">pick</span> <span class="main">`</span> <span class="skolem">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="skolem">pick</span> <span class="main">`</span> <span class="skolem">C</span><span class="main">.</span> <span class="skolem">m</span> <span class="main">≥</span> <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> m_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pick<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> *<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">≤</span> <span class="skolem">m</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>coS <span class="free">t</span> <span class="skolem">m</span><span class="main">)</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">c</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> <span class="skolem">C</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> no_markers_if_all_snapshotted<span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">pick</span> <span class="skolem">c</span>"</span></span> <span class="quoted"><span class="skolem">m</span></span> <span class="quoted"><span class="skolem">c</span></span><span class="main">]</span> pick<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">c</span></span></span></span></span></span><span class="main">]</span> m *
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> no_markers_if_all_snapshotted<span class="main">[</span><span class="operator">OF</span> assms <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">≤</span> <span class="skolem">m</span>›</span></span> j<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">c</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> C_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> *<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">≤</span> <span class="skolem">m</span>›</span></span><span class="main">]</span> m pick <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cotrace<span class="main">:</span> <span class="quoted"><span class="quoted">"cotrace <span class="free">init</span> <span class="free">t</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">final_i</span> <span class="main">≡</span>
  <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> llength <span class="free">t</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> has_snapshotted <span class="main">(</span>coS <span class="free">t</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">p</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">c</span><span class="main">.</span> Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>coS <span class="free">t</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">final</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">final</span> <span class="main">=</span> coS <span class="free">t</span> final_i"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> final_i<span class="main">:</span> <span class="quoted"><span class="quoted">"final_i <span class="main">≤</span> llength <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> has_snapshotted <span class="main">(</span>coS <span class="free">t</span> final_i<span class="main">)</span> <span class="bound">p</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">c</span><span class="main">.</span> Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>coS <span class="free">t</span> final_i<span class="main">)</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> final_i_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> someI2_ex<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cotrace_all_have_snapshotted_and_no_markers<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cotrace<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> cotrace_trace_cos<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cotrace<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> final<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t</span><span class="main">.</span> trace <span class="free">init</span> <span class="bound">t</span> final"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> has_snapshotted final <span class="bound">p</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">c</span><span class="main">.</span> Marker <span class="main">∉</span> set <span class="main">(</span>msgs final <span class="bound">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> final_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cotrace_trace_cos<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cotrace<span class="main"><span class="main">]</span></span> final_i exI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> computation <span class="quoted"><span class="free">channel</span></span> <span class="quoted"><span class="free">trans</span></span> <span class="quoted"><span class="free">send</span></span> <span class="quoted"><span class="free">recv</span></span> <span class="quoted"><span class="free">init</span></span> <span class="quoted">final</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> finite_channels<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> strongly_connected_raw<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> at_least_two_processes<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> finite_processes<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> no_initial_Marker<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> no_msgs_if_no_channel<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> no_initial_process_snapshot<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> no_initial_channel_snapshot<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> final<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t i cid
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"length <span class="skolem"><span class="skolem">t</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> exists_trace_for_any_i final<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> le_cases take_all trace_and_start_determines_end<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t p
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"length <span class="skolem"><span class="skolem">t</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> exists_trace_for_any_i final<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> order_refl take_all trace_and_start_determines_end<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">coperm</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">coperm</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">xs</span> <span class="bound">ys</span> <span class="bound">z</span><span class="main">.</span> perm <span class="bound">xs</span> <span class="bound">ys</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> prepend <span class="bound">xs</span> <span class="bound">z</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> prepend <span class="bound">ys</span> <span class="bound">z</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> copermIL<span class="main">:</span> <span class="quoted"><span class="quoted">"perm <span class="free">ys</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">=</span> prepend <span class="free">xs</span> <span class="free">z</span> <span class="main">⟹</span> coperm <span class="main">(</span>prepend <span class="free">ys</span> <span class="free">z</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> coperm_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> snapshot_algorithm_is_cocorrect<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t'</span> <span class="bound">i</span><span class="main">.</span> cotrace <span class="free">init</span> <span class="bound">t'</span> <span class="main">∧</span> coperm <span class="bound">t'</span> <span class="free">t</span> <span class="main">∧</span> state_equal_to_snapshot <span class="main">(</span>coS <span class="bound">t'</span> <span class="bound">i</span><span class="main">)</span> final <span class="main">∧</span> <span class="bound">i</span> <span class="main">≤</span> final_i"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">prefix</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">prefix</span> <span class="main">=</span> ltake final_i <span class="free">t</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">suffix</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">suffix</span> <span class="main">=</span> ldrop final_i <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prepend <span class="skolem">prefix</span> <span class="skolem">suffix</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> prefix_def suffix_def prepend_ltake_ldrop_id <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"cotrace final <span class="skolem">suffix</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> suffix_def final_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cotrace final_i<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cotrace_ldrop<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> cotrace_trace_cos<span class="main">[</span><span class="operator">OF</span> cotrace<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="skolem">prefix</span> final"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> final_def prefix_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> snapshot_algorithm_is_correct <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">prefix'</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"trace <span class="free">init</span> <span class="skolem">prefix'</span> final"</span></span> <span class="quoted"><span class="quoted">"perm <span class="skolem">prefix'</span> <span class="skolem">prefix</span>"</span></span> <span class="quoted"><span class="quoted">"state_equal_to_snapshot <span class="main">(</span>S <span class="skolem">prefix'</span> <span class="skolem">i</span><span class="main">)</span> final"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> length <span class="skolem">prefix'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹perm <span class="skolem">prefix'</span> <span class="skolem">prefix</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">≤</span> length <span class="skolem">prefix'</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> final_i"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> perm_length <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prefix_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> enat.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"prepend <span class="skolem"><span class="skolem"><span class="skolem">prefix'</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">suffix</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">i</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cos_def ltake_prepend s_chop<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cotrace_prepend <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> copermIL<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">print_statement</span></span> snapshot_algorithm_is_cocorrect

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Example">
<div class="head">
<h1>Theory Example</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Example›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We provide an example in order to prove that our locale is non-vacuous.
This example corresponds to the computation and associated snapshot described
in Section 4 of~\cite{chandy}.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Example
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="Snapshot.html">Snapshot</a>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">datatype</span></span> PType <span class="main">=</span> P <span class="main">|</span> Q
<span class="keyword1"><span class="command">datatype</span></span> MType <span class="main">=</span> M <span class="main">|</span> M'
<span class="keyword1"><span class="command">datatype</span></span> SType <span class="main">=</span> S_Wait <span class="main">|</span> S_Send <span class="main">|</span> T_Wait <span class="main">|</span> T_Send

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"PType <span class="main">⇒</span> SType <span class="main">⇒</span> SType <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">trans</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> False"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">send</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"channel_id <span class="main">⇒</span> PType <span class="main">⇒</span> PType <span class="main">⇒</span> SType
             <span class="main">⇒</span> SType <span class="main">⇒</span> MType <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">send</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> P <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> Q
                          <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> S_Send <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> S_Wait <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> M<span class="main">)</span>
                     <span class="main">∨</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> Q <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> P
                          <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> T_Send <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> T_Wait <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> M'<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">recv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"channel_id <span class="main">⇒</span> PType <span class="main">⇒</span> PType <span class="main">⇒</span> SType
             <span class="main">⇒</span> SType <span class="main">⇒</span> MType <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">recv</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> P <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> Q
                          <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> S_Wait <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> S_Send <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> M'<span class="main">)</span>
                     <span class="main">∨</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> Q <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> P
                          <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> T_Wait <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">=</span> T_Send <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> M<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">chan</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span>PType <span class="main">*</span> PType<span class="main">)</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">chan</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> Some <span class="main">(</span>P<span class="main">,</span> Q<span class="main">)</span>
            <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> Some <span class="main">(</span>Q<span class="main">,</span> P<span class="main">)</span>
            <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>PType<span class="main">,</span> SType<span class="main">,</span> MType<span class="main">)</span> configuration"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">≡</span> <span class="main">⦇</span>
       states <span class="main">=</span> <span class="main">(</span><span class="main">%</span><span class="bound">p</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">p</span> <span class="main">=</span> P <span class="keyword1">then</span> S_Send <span class="keyword1">else</span> T_Send<span class="main">)</span><span class="main">,</span>
       msgs <span class="main">=</span> <span class="main">(</span><span class="main">%</span><span class="bound">d</span><span class="main">.</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span>
       process_snapshot <span class="main">=</span> <span class="main">(</span><span class="main">%</span><span class="bound">p</span><span class="main">.</span> None<span class="main">)</span><span class="main">,</span>
       channel_snapshot <span class="main">=</span> <span class="main">(</span><span class="main">%</span><span class="bound">d</span><span class="main">.</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> NotStarted<span class="main">)</span><span class="main">)</span>
    <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">t0</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">t0</span> <span class="main">≡</span> Snapshot P"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">s1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>PType<span class="main">,</span> SType<span class="main">,</span> MType<span class="main">)</span> configuration"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">s1</span> <span class="main">≡</span> <span class="main">⦇</span>
       states <span class="main">=</span> <span class="main">(</span><span class="main">%</span><span class="bound">p</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">p</span> <span class="main">=</span> P <span class="keyword1">then</span> S_Send <span class="keyword1">else</span> T_Send<span class="main">)</span><span class="main">,</span>
       msgs <span class="main">=</span> <span class="main">(</span><span class="main">%</span><span class="bound">d</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">d</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">[</span>Marker<span class="main">]</span> <span class="keyword1">else</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span>
       process_snapshot <span class="main">=</span> <span class="main">(</span><span class="main">%</span><span class="bound">p</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">p</span> <span class="main">=</span> P <span class="keyword1">then</span> Some S_Send <span class="keyword1">else</span> None<span class="main">)</span><span class="main">,</span>
       channel_snapshot <span class="main">=</span> <span class="main">(</span><span class="main">%</span><span class="bound">d</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">d</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> Recording<span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> NotStarted<span class="main">)</span><span class="main">)</span>
    <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">t1</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">t1</span> <span class="main">≡</span> Send <span class="main">0</span> P Q S_Send S_Wait M"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">s2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>PType<span class="main">,</span> SType<span class="main">,</span> MType<span class="main">)</span> configuration"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">s2</span> <span class="main">≡</span> <span class="main">⦇</span>
       states <span class="main">=</span> <span class="main">(</span><span class="main">%</span><span class="bound">p</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">p</span> <span class="main">=</span> P <span class="keyword1">then</span> S_Wait <span class="keyword1">else</span> T_Send<span class="main">)</span><span class="main">,</span>
       msgs <span class="main">=</span> <span class="main">(</span><span class="main">%</span><span class="bound">d</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">d</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">[</span>Marker<span class="main">,</span> Msg M<span class="main">]</span> <span class="keyword1">else</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span>
       process_snapshot <span class="main">=</span> <span class="main">(</span><span class="main">%</span><span class="bound">p</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">p</span> <span class="main">=</span> P <span class="keyword1">then</span> Some S_Send <span class="keyword1">else</span> None<span class="main">)</span><span class="main">,</span>
       channel_snapshot <span class="main">=</span> <span class="main">(</span><span class="main">%</span><span class="bound">d</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">d</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> Recording<span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> NotStarted<span class="main">)</span><span class="main">)</span>
    <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">t2</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">t2</span> <span class="main">≡</span> Send <span class="main">1</span> Q P T_Send T_Wait M'"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">s3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>PType<span class="main">,</span> SType<span class="main">,</span> MType<span class="main">)</span> configuration"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">s3</span> <span class="main">≡</span> <span class="main">⦇</span>
       states <span class="main">=</span> <span class="main">(</span><span class="main">%</span><span class="bound">p</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">p</span> <span class="main">=</span> P <span class="keyword1">then</span> S_Wait <span class="keyword1">else</span> T_Wait<span class="main">)</span><span class="main">,</span>
       msgs <span class="main">=</span> <span class="main">(</span><span class="main">%</span><span class="bound">d</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">d</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">[</span>Marker<span class="main">,</span> Msg M<span class="main">]</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">d</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">[</span>Msg M'<span class="main">]</span> <span class="keyword1">else</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span>
       process_snapshot <span class="main">=</span> <span class="main">(</span><span class="main">%</span><span class="bound">p</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">p</span> <span class="main">=</span> P <span class="keyword1">then</span> Some S_Send <span class="keyword1">else</span> None<span class="main">)</span><span class="main">,</span>
       channel_snapshot <span class="main">=</span> <span class="main">(</span><span class="main">%</span><span class="bound">d</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">d</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> Recording<span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> NotStarted<span class="main">)</span><span class="main">)</span>
    <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">t3</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">t3</span> <span class="main">≡</span> Snapshot Q"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">s4</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>PType<span class="main">,</span> SType<span class="main">,</span> MType<span class="main">)</span> configuration"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">s4</span> <span class="main">≡</span> <span class="main">⦇</span>
       states <span class="main">=</span> <span class="main">(</span><span class="main">%</span><span class="bound">p</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">p</span> <span class="main">=</span> P <span class="keyword1">then</span> S_Wait <span class="keyword1">else</span> T_Wait<span class="main">)</span><span class="main">,</span>
       msgs <span class="main">=</span> <span class="main">(</span><span class="main">%</span><span class="bound">d</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">d</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">[</span>Marker<span class="main">,</span> Msg M<span class="main">]</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">d</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">[</span>Msg M'<span class="main">,</span> Marker<span class="main">]</span> <span class="keyword1">else</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span>
       process_snapshot <span class="main">=</span> <span class="main">(</span><span class="main">%</span><span class="bound">p</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">p</span> <span class="main">=</span> P <span class="keyword1">then</span> Some S_Send <span class="keyword1">else</span> Some T_Wait<span class="main">)</span><span class="main">,</span>
       channel_snapshot <span class="main">=</span> <span class="main">(</span><span class="main">%</span><span class="bound">d</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">d</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> Recording<span class="main">)</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">d</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> Recording<span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> NotStarted<span class="main">)</span><span class="main">)</span>
    <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">t4</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">t4</span> <span class="main">≡</span> RecvMarker <span class="main">0</span> Q P"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">s5</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>PType<span class="main">,</span> SType<span class="main">,</span> MType<span class="main">)</span> configuration"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">s5</span> <span class="main">≡</span> <span class="main">⦇</span>
       states <span class="main">=</span> <span class="main">(</span><span class="main">%</span><span class="bound">p</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">p</span> <span class="main">=</span> P <span class="keyword1">then</span> S_Wait <span class="keyword1">else</span> T_Wait<span class="main">)</span><span class="main">,</span>
       msgs <span class="main">=</span> <span class="main">(</span><span class="main">%</span><span class="bound">d</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">d</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">[</span>Msg M<span class="main">]</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">d</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">[</span>Msg M'<span class="main">,</span> Marker<span class="main">]</span> <span class="keyword1">else</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span>
       process_snapshot <span class="main">=</span> <span class="main">(</span><span class="main">%</span><span class="bound">p</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">p</span> <span class="main">=</span> P <span class="keyword1">then</span> Some S_Send <span class="keyword1">else</span> Some T_Wait<span class="main">)</span><span class="main">,</span>
       channel_snapshot <span class="main">=</span> <span class="main">(</span><span class="main">%</span><span class="bound">d</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">d</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> Done<span class="main">)</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">d</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> Recording<span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> NotStarted<span class="main">)</span><span class="main">)</span>
    <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">t5</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">t5</span> <span class="main">≡</span> Recv <span class="main">1</span> P Q S_Wait S_Send M'"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">s6</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>PType<span class="main">,</span> SType<span class="main">,</span> MType<span class="main">)</span> configuration"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">s6</span> <span class="main">≡</span> <span class="main">⦇</span>
       states <span class="main">=</span> <span class="main">(</span><span class="main">%</span><span class="bound">p</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">p</span> <span class="main">=</span> P <span class="keyword1">then</span> S_Send <span class="keyword1">else</span> T_Wait<span class="main">)</span><span class="main">,</span>
       msgs <span class="main">=</span> <span class="main">(</span><span class="main">%</span><span class="bound">d</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">d</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">[</span>Msg M<span class="main">]</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">d</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">[</span>Marker<span class="main">]</span> <span class="keyword1">else</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span>
       process_snapshot <span class="main">=</span> <span class="main">(</span><span class="main">%</span><span class="bound">p</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">p</span> <span class="main">=</span> P <span class="keyword1">then</span> Some S_Send <span class="keyword1">else</span> Some T_Wait<span class="main">)</span><span class="main">,</span>
       channel_snapshot <span class="main">=</span> <span class="main">(</span><span class="main">%</span><span class="bound">d</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">d</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> Done<span class="main">)</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">d</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">[</span>M'<span class="main">]</span><span class="main">,</span> Recording<span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> NotStarted<span class="main">)</span><span class="main">)</span>
    <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">t6</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">t6</span> <span class="main">≡</span> RecvMarker <span class="main">1</span> P Q"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">s7</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>PType<span class="main">,</span> SType<span class="main">,</span> MType<span class="main">)</span> configuration"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">s7</span> <span class="main">≡</span> <span class="main">⦇</span>
       states <span class="main">=</span> <span class="main">(</span><span class="main">%</span><span class="bound">p</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">p</span> <span class="main">=</span> P <span class="keyword1">then</span> S_Send <span class="keyword1">else</span> T_Wait<span class="main">)</span><span class="main">,</span>
       msgs <span class="main">=</span> <span class="main">(</span><span class="main">%</span><span class="bound">d</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">d</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">[</span>Msg M<span class="main">]</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">d</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">[]</span> <span class="keyword1">else</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span>
       process_snapshot <span class="main">=</span> <span class="main">(</span><span class="main">%</span><span class="bound">p</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">p</span> <span class="main">=</span> P <span class="keyword1">then</span> Some S_Send <span class="keyword1">else</span> Some T_Wait<span class="main">)</span><span class="main">,</span>
       channel_snapshot <span class="main">=</span> <span class="main">(</span><span class="main">%</span><span class="bound">d</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">d</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> Done<span class="main">)</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">d</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">[</span>M'<span class="main">]</span><span class="main">,</span> Done<span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> NotStarted<span class="main">)</span><span class="main">)</span>
    <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> s7_no_marker<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">cid</span><span class="main">.</span> Marker <span class="main">∉</span> set <span class="main">(</span>msgs s7 <span class="bound">cid</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">interpretation</span></span> computation <span class="quoted">chan</span> <span class="quoted">trans</span> <span class="quoted">send</span> <span class="quoted">recv</span> <span class="quoted">init</span> <span class="quoted">s7</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distributed_system chan"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">∄</span><span class="bound">p</span><span class="main">.</span> chan <span class="bound">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="bound">q</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> chan <span class="bound">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">p</span> <span class="bound">q</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">::</span> <span class="quoted">PType</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span> <span class="main">=</span> P <span class="main">∧</span> <span class="skolem">q</span> <span class="main">=</span> Q<span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">=</span> Q <span class="main">∧</span> <span class="skolem">q</span> <span class="main">=</span> P<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> PType.exhaust <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> chan <span class="bound">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> chan <span class="bound">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="skolem">p</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∃</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> chan <span class="bound">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∃</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> chan <span class="bound">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span><span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> card <span class="main">(</span>UNIV <span class="main">::</span> PType set<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>UNIV <span class="main">::</span> PType set<span class="main">)</span> <span class="main">=</span> <span class="main">{</span>P<span class="main">,</span> Q<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> PType.exhaust <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>UNIV <span class="main">::</span> PType set<span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def PType.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Suc_1 card.insert card.empty finite.emptyI finite.insertI insert_absorb insert_not_empty singletonD<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">::</span> PType set<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>UNIV <span class="main">::</span> PType set<span class="main">)</span> <span class="main">=</span> <span class="main">{</span>P<span class="main">,</span> Q<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> PType.exhaust <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite.emptyI finite.insertI<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">∄</span><span class="bound">p</span><span class="main">.</span> chan <span class="bound">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> chan <span class="bound">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> Marker <span class="main">∉</span> set <span class="main">(</span>msgs init <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> chan <span class="bound">i</span> <span class="main">=</span> None <span class="main">⟶</span> msgs init <span class="bound">i</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="main">¬</span> ps init <span class="bound">p</span> <span class="main">≠</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> cs init <span class="bound">i</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> NotStarted<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t</span><span class="main">.</span> distributed_system.trace chan Example.trans send recv init <span class="bound">t</span> s7"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>t0<span class="main">,</span> t1<span class="main">,</span> t2<span class="main">,</span> t3<span class="main">,</span> t4<span class="main">,</span> t5<span class="main">,</span> t6<span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distributed_system.next chan trans send recv init t0 s1"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distributed_system.can_occur chan trans send recv t0 init"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹distributed_system chan›</span></span> distributed_system.can_occur_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹distributed_system chan›</span></span> distributed_system.next_snapshot<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distributed_system.next chan trans send recv s1 t1 s2"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distributed_system.can_occur chan trans send recv t1 s1"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹distributed_system chan›</span></span> distributed_system.can_occur_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹distributed_system chan›</span></span> distributed_system.next_send<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distributed_system.next chan trans send recv s2 t2 s3"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distributed_system.can_occur chan trans send recv t2 s2"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹distributed_system chan›</span></span> distributed_system.can_occur_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">≠</span> P <span class="main">⟶</span> <span class="bound">r</span> <span class="main">=</span> Q"</span></span> <span class="keyword1"><span class="command">using</span></span> PType.exhaust <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹distributed_system chan›</span></span> distributed_system.next_send<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distributed_system.next chan trans send recv s3 t3 s4"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distributed_system.can_occur chan trans send recv t3 s3"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹distributed_system chan›</span></span> distributed_system.can_occur_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p'</span><span class="main">.</span> <span class="bound">p'</span> <span class="main">≠</span> P <span class="main">⟶</span> <span class="bound">p'</span> <span class="main">=</span> Q"</span></span> <span class="keyword1"><span class="command">using</span></span> PType.exhaust <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹distributed_system chan›</span></span> distributed_system.next_snapshot<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distributed_system.next chan trans send recv s4 t4 s5"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distributed_system.can_occur chan trans send recv t4 s4"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹distributed_system chan›</span></span> distributed_system.can_occur_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹distributed_system chan›</span></span> distributed_system.next_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distributed_system.next chan trans send recv s5 t5 s6"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distributed_system.can_occur chan trans send recv t5 s5"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹distributed_system chan›</span></span> distributed_system.can_occur_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹distributed_system chan›</span></span> distributed_system.next_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distributed_system.next chan trans send recv s6 t6 s7"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distributed_system.can_occur chan trans send recv t6 s6"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹distributed_system chan›</span></span> distributed_system.can_occur_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹distributed_system chan›</span></span> distributed_system.next_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distributed_system.trace chan trans send recv init <span class="var">?t</span> s7"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted"><span class="quoted">‹distributed_system chan›</span></span> distributed_system.trace.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span> <span class="bound">i</span> <span class="bound">cid</span><span class="main">.</span> distributed_system.trace chan Example.trans send recv init <span class="bound">t</span> s7 <span class="main">∧</span>
       Marker <span class="main">∈</span> set <span class="main">(</span>msgs <span class="main">(</span>distributed_system.s chan Example.trans send recv init <span class="bound">t</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">cid</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="bound">i</span><span class="main">.</span> Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>distributed_system.s chan Example.trans send recv init <span class="bound">t</span> <span class="bound">j</span><span class="main">)</span> <span class="bound">cid</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="skolem">i</span> <span class="skolem">cid</span>
    <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"distributed_system.trace chan Example.trans send recv init <span class="skolem">t</span> s7 <span class="main">∧</span>
                 Marker <span class="main">∈</span> set <span class="main">(</span>msgs <span class="main">(</span>distributed_system.s chan Example.trans send recv init <span class="skolem">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> tr_exists<span class="main">:</span> <span class="quoted"><span class="quoted">"distributed_system.trace chan Example.trans send recv init <span class="skolem">t</span> s7"</span></span> <span class="keyword1"><span class="command">using</span></span> asm <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> marker_in_channel<span class="main">:</span> <span class="quoted"><span class="quoted">"Marker <span class="main">∈</span> set <span class="main">(</span>msgs <span class="main">(</span>distributed_system.s chan Example.trans send recv init <span class="skolem">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> asm <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> s7_is_fin<span class="main">:</span> <span class="quoted"><span class="quoted">"s7 <span class="main">=</span> <span class="main">(</span>distributed_system.s chan Example.trans send recv init <span class="skolem">t</span> <span class="main">(</span>length <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹distributed_system chan›</span></span> <span class="quoted"><span class="quoted">‹distributed_system.trace chan Example.trans send recv init <span class="skolem">t</span> s7›</span></span> distributed_system.exists_trace_for_any_i distributed_system.trace_and_start_determines_end order_refl take_all<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distributed_system.trace chan Example.trans send recv
                <span class="main">(</span>distributed_system.s chan Example.trans send recv init <span class="skolem">t</span> <span class="main">(</span>length <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>
                <span class="main">[]</span>
                <span class="main">(</span>distributed_system.s chan Example.trans send recv init <span class="skolem">t</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹distributed_system chan›</span></span> distributed_system.exists_trace_for_any_i distributed_system.trace.simps distributed_system.trace_and_start_determines_end not_less s7_is_fin take_all tr_exists<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>distributed_system.s chan Example.trans send recv init <span class="skolem">t</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distributed_system.s chan Example.trans send recv init <span class="skolem">t</span> <span class="skolem">i</span> <span class="main">=</span> s7"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹distributed_system chan›</span></span> <span class="quoted"><span class="quoted">‹distributed_system.trace chan Example.trans send recv <span class="main">(</span>distributed_system.s chan Example.trans send recv init <span class="skolem">t</span> <span class="main">(</span>length <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">[]</span> <span class="main">(</span>distributed_system.s chan Example.trans send recv init <span class="skolem">t</span> <span class="skolem">i</span><span class="main">)</span>›</span></span> distributed_system.trace.simps s7_is_fin <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> s7_no_marker <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> marker_in_channel <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="skolem">i</span><span class="main">.</span> Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>distributed_system.s chan Example.trans send recv init <span class="skolem">t</span> <span class="bound">j</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distributed_system.trace chan Example.trans send recv
            <span class="main">(</span>distributed_system.s chan Example.trans send recv init <span class="skolem">t</span> <span class="skolem">i</span><span class="main">)</span>
            <span class="main">(</span>take <span class="main">(</span><span class="main">(</span>length <span class="skolem">t</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>drop <span class="skolem">i</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>
            <span class="main">(</span>distributed_system.s chan Example.trans send recv init <span class="skolem">t</span> <span class="main">(</span>length <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹distributed_system chan›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">t</span>›</span></span> distributed_system.exists_trace_for_any_i_j less_imp_le_nat tr_exists <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Marker <span class="main">∉</span> set <span class="main">(</span>msgs <span class="main">(</span>distributed_system.s chan Example.trans send recv init <span class="skolem">t</span> <span class="main">(</span>length <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">cid</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distributed_system.s chan Example.trans send recv init <span class="skolem">t</span> <span class="main">(</span>length <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> s7"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s7_is_fin<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> s7_no_marker <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">t</span>›</span></span> less_imp_le_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span> <span class="bound">p</span><span class="main">.</span> distributed_system.trace chan Example.trans send recv init <span class="bound">t</span> s7 <span class="main">⟶</span>
              <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> ps <span class="main">(</span>distributed_system.s chan Example.trans send recv init <span class="bound">t</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">p</span> <span class="main">≠</span> None <span class="main">∧</span> <span class="bound">i</span> <span class="main">≤</span> length <span class="bound">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="skolem">p</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"distributed_system.trace chan Example.trans send recv init <span class="skolem">t</span> s7"</span></span>
    <span class="keyword1"><span class="command">have</span></span> s7_is_fin<span class="main">:</span> <span class="quoted"><span class="quoted">"s7 <span class="main">=</span> <span class="main">(</span>distributed_system.s chan Example.trans send recv init <span class="skolem">t</span> <span class="main">(</span>length <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹distributed_system chan›</span></span> <span class="quoted"><span class="quoted">‹distributed_system.trace chan Example.trans send recv init <span class="skolem">t</span> s7›</span></span> distributed_system.exists_trace_for_any_i distributed_system.trace_and_start_determines_end order_refl take_all<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"has_snapshotted s7 <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> ps <span class="main">(</span>distributed_system.s chan Example.trans send recv init <span class="skolem">t</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">≠</span> None <span class="main">∧</span> <span class="bound">i</span> <span class="main">≤</span> length <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>